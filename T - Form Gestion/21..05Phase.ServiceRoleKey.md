
# Fonctions Edge – Gestion Réseau correction poen ia initiale

## 1. gestion-reseau-admin (lecture)

```ts
// supabase/functions/gestion-reseau-admin/index.ts
import { serve } from "https://deno.land/std/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);

serve(async (req) => {
  try {
    const { reseauId, organisationId } = await req.json();

    if (!reseauId || !organisationId) {
      return new Response(JSON.stringify({ error: "reseauId et organisationId requis" }), { status: 400 });
    }

    // Vérif existence et appartenance
    const { data: reseauRow, error } = await supabaseAdmin
      .from("reseau")
      .select("reseau_id, organisation_id, *, brevo_connexion(*), zoho_connexion(*), openai_connexion(*)")
      .eq("reseau_id", reseauId)
      .maybeSingle();

    if (error) throw error;
    if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { status: 404 });

    if (organisationId !== "admin_presenca" && reseauRow.organisation_id !== organisationId) {
      return new Response(JSON.stringify({ error: "Accès interdit" }), { status: 403 });
    }

    return new Response(JSON.stringify(reseauRow), { status: 200 });
  } catch (e) {
    return new Response(JSON.stringify({ error: e.message }), { status: 500 });
  }
});
```

## 2. gestion-reseau-admin-update (update)

```ts
// supabase/functions/gestion-reseau-admin-update/index.ts
import { serve } from "https://deno.land/std/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);

serve(async (req) => {
  try {
    const { reseauId, organisationId, generalData, integrationType, integrationData } = await req.json();

    if (!reseauId || !organisationId) {
      return new Response(JSON.stringify({ error: "reseauId et organisationId requis" }), { status: 400 });
    }

    // Vérif existence
    const { data: reseauRow, error } = await supabaseAdmin
      .from("reseau")
      .select("reseau_id, organisation_id, reseau_brevo_connexion_id, reseau_zoho_connexion_id, reseau_openai_connexion_id")
      .eq("reseau_id", reseauId)
      .maybeSingle();

    if (error) throw error;
    if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { status: 404 });

    if (organisationId !== "admin_presenca" && reseauRow.organisation_id !== organisationId) {
      return new Response(JSON.stringify({ error: "Accès interdit" }), { status: 403 });
    }

    // Mise à jour des infos générales
    if (generalData) {
      const { error: updateError } = await supabaseAdmin
        .from("reseau")
        .update(generalData)
        .eq("reseau_id", reseauId);
      if (updateError) throw updateError;
    }

    // Mise à jour des intégrations
    if (integrationType && integrationData) {
      const table = `${integrationType}_connexion`;
      const fkField = `reseau_${integrationType}_connexion_id`;
      const existingId = reseauRow[fkField];

      let integrationId = existingId;

      if (existingId) {
        // Update
        const { error: intError } = await supabaseAdmin
          .from(table)
          .update(integrationData)
          .eq(`${integrationType}_connexion_id`, existingId);
        if (intError) throw intError;
      } else {
        // Insert
        const { data: inserted, error: intError } = await supabaseAdmin
          .from(table)
          .insert(integrationData)
          .select("id")
          .single();
        if (intError) throw intError;
        integrationId = inserted?.id;

        // Update FK in reseau
        await supabaseAdmin
          .from("reseau")
          .update({ [fkField]: integrationId })
          .eq("reseau_id", reseauId);
      }
    }

    return new Response(JSON.stringify({ success: true }), { status: 200 });
  } catch (e) {
    return new Response(JSON.stringify({ error: e.message }), { status: 500 });
  }
});
```

## 3. gestion-reseau-admin-fichiers (upload / delete fichiers)

```ts
// supabase/functions/gestion-reseau-admin-fichiers/index.ts
import { serve } from "https://deno.land/std/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);

const BUCKET = "bucket-table-reseau";

serve(async (req) => {
  try {
    if (req.method === "POST") {
      const formData = await req.formData();
      const file = formData.get("file") as File;
      const type = formData.get("type") as string;
      const reseauId = formData.get("reseauId") as string;
      const organisationId = formData.get("organisationId") as string;

      if (!reseauId || !organisationId) {
        return new Response(JSON.stringify({ error: "reseauId et organisationId requis" }), { status: 400 });
      }

      const { data: reseauRow, error } = await supabaseAdmin
        .from("reseau")
        .select("reseau_id, organisation_id")
        .eq("reseau_id", reseauId)
        .maybeSingle();

      if (error) throw error;
      if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { status: 404 });
      if (organisationId !== "admin_presenca" && reseauRow.organisation_id !== organisationId) {
        return new Response(JSON.stringify({ error: "Accès interdit" }), { status: 403 });
      }

      const folder = type === "logo" ? "1-logos" : "2-documents-institutionnels";
      const filePath = `reseau-${reseauId}/${folder}/${file.name}`;

      const { error: uploadError } = await supabaseAdmin.storage
        .from(BUCKET)
        .upload(filePath, file, { upsert: true });

      if (uploadError) throw uploadError;

      return new Response(JSON.stringify({ filePath }), { status: 200 });
    }

    if (req.method === "DELETE") {
      const { filePath, reseauId, organisationId } = await req.json();

      if (!reseauId || !organisationId) {
        return new Response(JSON.stringify({ error: "reseauId et organisationId requis" }), { status: 400 });
      }

      const { data: reseauRow, error } = await supabaseAdmin
        .from("reseau")
        .select("reseau_id, organisation_id")
        .eq("reseau_id", reseauId)
        .maybeSingle();

      if (error) throw error;
      if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { status: 404 });
      if (organisationId !== "admin_presenca" && reseauRow.organisation_id !== organisationId) {
        return new Response(JSON.stringify({ error: "Accès interdit" }), { status: 403 });
      }

      const { error: delError } = await supabaseAdmin.storage.from(BUCKET).remove([filePath]);
      if (delError) throw del
```

---
---
---

# Fonctions Edge – Gestion Réseau version corrigée

## 1. gestion-reseau-admin (lecture)

```ts
// supabase/functions/gestion-reseau-admin/index.ts
import { serve } from "https://deno.land/std/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface RequestBody {
  reseauId?: string;
  organisationId?: string;
}

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // SI aucun body = liste tous les réseaux (pour le sélecteur)
    let body: RequestBody = {};
    try {
      body = await req.json();
    } catch {
      // Pas de body = requête pour la liste
    }

    const { reseauId, organisationId } = body;

    if (!reseauId) {
      // LISTE tous les réseaux pour le sélecteur
      const { data: reseaux, error } = await supabaseAdmin
        .from("reseau")
        .select("reseau_id, reseau_nom, organisation_id, reseau_statut")
        .eq("reseau_statut", "actif")
        .order("reseau_nom");

      if (error) throw error;
      return new Response(JSON.stringify(reseaux || []), { 
        status: 200, 
        headers: corsHeaders 
      });
    } else {
      // UN réseau spécifique (pour le formulaire)
      if (!organisationId) {
        return new Response(JSON.stringify({ error: "organisationId requis" }), { 
          status: 400, 
          headers: corsHeaders 
        });
      }

      const { data: reseauRow, error } = await supabaseAdmin
        .from("reseau")
        .select("reseau_id, organisation_id, *, brevo_connexion(*), zoho_connexion(*), openai_connexion(*)")
        .eq("reseau_id", reseauId)
        .maybeSingle();

      if (error) throw error;
      if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { 
        status: 404, 
        headers: corsHeaders 
      });

      if (organisationId !== "admin_presenca" && reseauRow.organisation_id !== organisationId) {
        return new Response(JSON.stringify({ error: "Accès interdit" }), { 
          status: 403, 
          headers: corsHeaders 
        });
      }

      return new Response(JSON.stringify(reseauRow), { 
        status: 200, 
        headers: corsHeaders 
      });
    }
  } catch (e) {
    console.error('Erreur gestion-reseau-admin:', e);
    const errorMessage = e instanceof Error ? e.message : 'Erreur inconnue';
    return new Response(JSON.stringify({ error: errorMessage }), { 
      status: 500, 
      headers: corsHeaders 
    });
  }
});
```

## 2. gestion-reseau-admin-update (update)

```ts
// supabase/functions/gestion-reseau-admin-update/index.ts
import { serve } from "https://deno.land/std/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface RequestBody {
  reseauId: string;
  organisationId?: string;
  generalData?: Record<string, any>;
  integrationType?: string;
  integrationData?: Record<string, any>;
}

interface ReseauRow {
  reseau_id: string;
  organisation_id: string;
  reseau_brevo_connexion_id?: string;
  reseau_zoho_connexion_id?: string;
  reseau_openai_connexion_id?: string;
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { reseauId, organisationId, generalData, integrationType, integrationData }: RequestBody = await req.json();

    if (!reseauId) {
      return new Response(JSON.stringify({ error: "reseauId requis" }), { 
        status: 400, 
        headers: corsHeaders 
      });
    }

    // Vérif existence
    const { data: reseauRow, error } = await supabaseAdmin
      .from("reseau")
      .select("reseau_id, organisation_id, reseau_brevo_connexion_id, reseau_zoho_connexion_id, reseau_openai_connexion_id")
      .eq("reseau_id", reseauId)
      .maybeSingle();

    if (error) throw error;
    if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { 
      status: 404, 
      headers: corsHeaders 
    });

    const typedReseauRow = reseauRow as ReseauRow;

    if (organisationId && organisationId !== "admin_presenca" && typedReseauRow.organisation_id !== organisationId) {
      return new Response(JSON.stringify({ error: "Accès interdit" }), { 
        status: 403, 
        headers: corsHeaders 
      });
    }

    // Mise à jour des infos générales
    if (generalData) {
      const { error: updateError } = await supabaseAdmin
        .from("reseau")
        .update(generalData)
        .eq("reseau_id", reseauId);
      if (updateError) throw updateError;
    }

    // Mise à jour des intégrations
    if (integrationType && integrationData) {
      const table = `${integrationType}_connexion`;
      const fkField = `reseau_${integrationType}_connexion_id` as keyof ReseauRow;
      const existingId = typedReseauRow[fkField];

      let integrationId = existingId;

      if (existingId) {
        // Update
        const { error: intError } = await supabaseAdmin
          .from(table)
          .update(integrationData)
          .eq(`${integrationType}_connexion_id`, existingId);
        if (intError) throw intError;
      } else {
        // Insert
        const { data: inserted, error: intError } = await supabaseAdmin
          .from(table)
          .insert(integrationData)
          .select(`${integrationType}_connexion_id`)
          .single();
        if (intError) throw intError;
        
        const connectionIdField = `${integrationType}_connexion_id`;
        integrationId = inserted?.[connectionIdField];

        // Update FK in reseau
        await supabaseAdmin
          .from("reseau")
          .update({ [fkField]: integrationId })
          .eq("reseau_id", reseauId);
      }
    }

    return new Response(JSON.stringify({ success: true }), { 
      status: 200, 
      headers: corsHeaders 
    });
  } catch (e) {
    console.error('Erreur gestion-reseau-admin-update:', e);
    const errorMessage = e instanceof Error ? e.message : 'Erreur inconnue';
    return new Response(JSON.stringify({ error: errorMessage }), { 
      status: 500, 
      headers: corsHeaders 
    });
  }
});
```

## 3. gestion-reseau-admin-fichiers (upload / delete fichiers)

```ts
// supabase/functions/gestion-reseau-admin-fichiers/index.ts
import { serve } from "https://deno.land/std/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);

const BUCKET = "bucket-table-reseau";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface DeleteRequestBody {
  filePath: string;
  reseauId: string;
  organisationId?: string;
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    if (req.method === "POST") {
      const formData = await req.formData();
      const file = formData.get("file") as File;
      const type = formData.get("type") as string;
      const reseauId = formData.get("reseauId") as string;
      const organisationId = formData.get("organisationId") as string;

      if (!reseauId || !file) {
        return new Response(JSON.stringify({ error: "reseauId et file requis" }), { 
          status: 400, 
          headers: corsHeaders 
        });
      }

      const { data: reseauRow, error } = await supabaseAdmin
        .from("reseau")
        .select("reseau_id, organisation_id")
        .eq("reseau_id", reseauId)
        .maybeSingle();

      if (error) throw error;
      if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { 
        status: 404, 
        headers: corsHeaders 
      });

      if (organisationId && organisationId !== "admin_presenca" && reseauRow.organisation_id !== organisationId) {
        return new Response(JSON.stringify({ error: "Accès interdit" }), { 
          status: 403, 
          headers: corsHeaders 
        });
      }

      const folder = type === "logo" ? "1-logos" : "2-documents-institutionnels";
      const filePath = `reseau-${reseauId}/${folder}/${file.name}`;

      const { error: uploadError } = await supabaseAdmin.storage
        .from(BUCKET)
        .upload(filePath, file, { upsert: true });

      if (uploadError) throw uploadError;

      return new Response(JSON.stringify({ filePath }), { 
        status: 200, 
        headers: corsHeaders 
      });
    }

    if (req.method === "DELETE") {
      const { filePath, reseauId, organisationId }: DeleteRequestBody = await req.json();

      if (!reseauId || !filePath) {
        return new Response(JSON.stringify({ error: "reseauId et filePath requis" }), { 
          status: 400, 
          headers: corsHeaders 
        });
      }

      const { data: reseauRow, error } = await supabaseAdmin
        .from("reseau")
        .select("reseau_id, organisation_id")
        .eq("reseau_id", reseauId)
        .maybeSingle();

      if (error) throw error;
      if (!reseauRow) return new Response(JSON.stringify({ error: "Réseau introuvable" }), { 
        status: 404, 
        headers: corsHeaders 
      });

      if (organisationId && organisationId !== "admin_presenca" && reseauRow.organisation_id !== organisationId) {
        return new Response(JSON.stringify({ error: "Accès interdit" }), { 
          status: 403, 
          headers: corsHeaders 
        });
      }

      const { error: delError } = await supabaseAdmin.storage.from(BUCKET).remove([filePath]);
      if (delError) throw delError;

      return new Response(JSON.stringify({ success: true }), { 
        status: 200, 
        headers: corsHeaders 
      });
    }

    return new Response(JSON.stringify({ error: "Méthode non supportée" }), { 
      status: 405, 
      headers: corsHeaders 
    });
  } catch (e) {
    console.error('Erreur gestion-reseau-admin-fichiers:', e);
    const errorMessage = e instanceof Error ? e.message : 'Erreur inconnue';
    return new Response(JSON.stringify({ error: errorMessage }), { 
      status: 500, 
      headers: corsHeaders 
    });
  }
});
```


## Voici le code SQL exact qui a été utilisé pour créer le bucket actuel :

- Migration 20250928201634_7cd039bf-cbf6-47ef-91b9-42ae842b2ee3.sql
```typescript
-- =========================================
-- 1. Création du bucket unique multi-tenant
-- =========================================
INSERT INTO storage.buckets (id, name, public)
VALUES ('bucket-table-reseau', 'bucket-table-reseau', false)
ON CONFLICT (id) DO NOTHING;

-- =========================================
-- 2. Suppression des anciennes policies (sécurité idempotente)
-- =========================================
DO $$
BEGIN
  IF EXISTS (
    SELECT 1
    FROM pg_policies
    WHERE policyname = 'RLS reseau files access'
      AND tablename = 'objects'
      AND schemaname = 'storage'
  ) THEN
    EXECUTE 'DROP POLICY "RLS reseau files access" ON storage.objects';
  END IF;
END $$;

-- =========================================
-- 3. Policy multi-tenant stricte selon votre design
-- =========================================
CREATE POLICY "RLS reseau files access"
ON storage.objects
FOR ALL
TO authenticated
USING (
  bucket_id = 'bucket-table-reseau'
  AND (
    -- ✅ Admin Presenca : accès total
    is_admin_presenca(auth.uid())

    OR

    -- ✅ Utilisateur organisation : accès uniquement à son dossier organisation-{organisation_id}/...
    name LIKE ('organisation-' || get_user_organisation_id(auth.uid())::text || '/%')
  )
)
WITH CHECK (
  bucket_id = 'bucket-table-reseau'
  AND (
    is_admin_presenca(auth.uid())
    OR
    name LIKE ('organisation-' || get_user_organisation_id(auth.uid())::text || '/%')
  )
);

-- =========================================
-- Architecture du bucket :
-- bucket-table-reseau/
-- └── organisation-{uuid}/              ← UUID = organisation_id (pivot multi-tenant)
--     ├── 1-logos/                      ← Dossier logos
--     ├── 2-documents-institutionnels/  ← Dossier documents
--     └── 3-charte-graphique/           ← Extensible futur
```

- C'est ce code précis qui est actuellement actif dans Supabase et qui impose la structure organisation-{uuid}/...

## Ce qu'il y a ACTUELLEMENT dans Supabase

1️⃣ Bucket
- id: bucket-table-reseau
- name: bucket-table-reseau
- public: false (privé)
- créé le: 2025-09-28 20:16:32

2️⃣ Policy RLS sur le bucket
- Nom: "RLS reseau files access"
- Type: ALL (SELECT, INSERT, UPDATE, DELETE)
```typescript
USING + WITH CHECK:
  bucket_id = 'bucket-table-reseau'
  AND (
    is_admin_presenca(auth.uid())
    OR
    name LIKE 'organisation-' || get_user_organisation_id(auth.uid()) || '/%'
  )
```

3️⃣ Fichiers dans le bucket
- Aucun fichier (vide)
- Architecture imposée par la policy : organisation-{uuid}/...

# PLAN DE CORRECTION - Formulaire Gestion R√©seau

## üîé Vue d‚Äôensemble
- **Cause racine principale** : incoh√©rence entre **Service Role Key** et la **v√©rification JWT** dans `gestion-reseau-admin`.  
- **Cons√©quences** : le s√©lecteur de r√©seaux √©choue (`Token invalide`), les int√©grations et fichiers deviennent inaccessibles.  
- **Autres probl√®mes** : incoh√©rences de param√®tres (`type` vs `fileType`), conventions de stockage (`organisation-{uuid}` vs `reseau-{uuid}`), absence de logs structur√©s.  

---

## 1. `supabase/functions/gestion-reseau-admin/index.ts`

### 1/ Probl√®me
- V√©rification manuelle du JWT utilisateur avec `supabaseAdmin.auth.getUser(token)` alors que l‚Äôappel passe via **Service Role Key**.  
- Conflit : `verify_jwt=false` (config) mais code qui exige un JWT ‚Üí erreur `Token invalide`.  

### 2/ V√©rifications pr√©alables
- Confirmer que la table `users` contient bien l‚Äôadmin avec `users_role_systeme = 'admin_presenca'`.  
- V√©rifier que les r√©seaux existent en base (d√©j√† valid√©).  

### 3/ Solution
- Supprimer l‚Äôappel `auth.getUser(token)` si Service Role Key est utilis√©.  
- V√©rifier directement dans la table `users` que le r√¥le = `admin_presenca`.  
- Ajouter logs structur√©s : `request_id`, `caller_role`, `reseau_count`.

---

## 2. `supabase/functions/gestion-reseau-admin-donnees/index.ts`

### 1/ Probl√®me
- M√™me incoh√©rence JWT que ci-dessus.  
- Absence de logs pr√©cis.  

### 2/ V√©rifications pr√©alables
- Confirmer que les FK vers `brevo_connexion`, `zoho_connexion`, `openai_connexion` sont coh√©rents.  

### 3/ Solution
- Appliquer la m√™me correction d‚Äôauth (pas de check JWT avec Service Role Key).  
- Ajouter logs : `reseauId demand√©`, `int√©grations trouv√©es`.  

---

## 3. `supabase/functions/gestion-reseau-admin-update/index.ts`

### 1/ Probl√®me
- V√©rification JWT inutile.  
- Logs insuffisants.  
- Risque d‚Äôincoh√©rence dans synchro email/t√©l√©phone `reseau ‚Üí reseau_direction`.  

### 2/ V√©rifications pr√©alables
- V√©rifier que la synchro est bien en place c√¥t√© DB (triggers ou fonction SQL).  

### 3/ Solution
- Corriger auth comme ci-dessus.  
- Ajouter log de type : `update reseau_id=xxx by user_id=xxx`.  
- Assurer synchro automatique (au besoin via une fonction SQL).  

---

## 4. `supabase/functions/gestion-reseau-admin-fichiers/index.ts`

### 1/ Probl√®me
- Conflit entre `organisation-{uuid}` (code EF) et `reseau-{uuid}` (strat√©gie valid√©e).  
- Param√®tre d‚Äôupload incoh√©rent : front envoie `type`, EF attend `fileType`.  
- V√©rification JWT encore pr√©sente.  

### 2/ V√©rifications pr√©alables
- Inspecter les fichiers existants dans `bucket-table-reseau` pour identifier ceux rang√©s sous `organisation-{uuid}`.  

### 3/ Solution
- Uniformiser chemin ‚Üí `reseau-{uuid}`.  
- Corriger param√®tre ‚Üí **utiliser `fileType`** partout.  
- Corriger auth.  
- Logs : `action=upload/delete, reseauId, fileType, path`.  

---

## 5. Hooks ‚Äì `useReseauFormData.ts`

### 1/ Probl√®me
- D√©pendance totale aux EF ‚Üí si erreur, l‚ÄôUI reste vide sans diagnostic clair.  

### 2/ V√©rifications pr√©alables
- Tester manuellement l‚Äôappel `supabase.functions.invoke('gestion-reseau-admin')` en CLI.  

### 3/ Solution
- Ajouter gestion d‚Äôerreur plus explicite (toast : ‚ÄúV√©rifiez vos droits admin_presenca‚Äù).  
- Logguer c√¥t√© front les r√©ponses brutes pour debug.  

---

## 6. Hooks ‚Äì `useReseauIntegrations.ts`

### 1/ Probl√®me
- D√©pendance aux EF sans contr√¥le si l‚ÄôID d‚Äôint√©gration est absent.  
- Logs limit√©s.  

### 2/ V√©rifications pr√©alables
- V√©rifier coh√©rence entre `reseau.reseau_brevo_connexion_id` et la table `brevo_connexion`.  

### 3/ Solution
- Ajouter logs front en cas d‚Äôint√©gration absente.  
- Utiliser la donn√©e retourn√©e par l‚ÄôEF au lieu de recharger syst√©matiquement (optimisation d√©j√† amorc√©e).  

---

## 7. Composant ‚Äì `ReseauSelector.tsx`

### 1/ Probl√®me
- Si la liste des r√©seaux est vide, aucun message explicite.
- Besoin de deux informations dans le s√©lecteur pour permettre √† admin_presenca de s√©lectionner son r√©seau
  - reseau_nom
  - reseau_id

### 2/ V√©rifications pr√©alables
- Valider que `reseaux` contient bien des donn√©es c√¥t√© front apr√®s appel EF.  

### 3/ Solution
- Ajouter message clair : ‚ÄúAucun r√©seau trouv√© ou droits insuffisants‚Äù.  

---

## 8. Composant ‚Äì `3.FormReseauGestion.tsx`

### 1/ Probl√®me
- Upload envoie `type` au lieu de `fileType`.  
- Risque de mismatch avec EF.  

### 2/ V√©rifications pr√©alables
- V√©rifier ligne 280+ (`uploadFile`) ‚Üí `fd.append('type', type)` doit devenir `fileType`.  

### 3/ Solution
- Corriger param√®tre ‚Üí `fd.append('fileType', type)`.  
- Ajouter gestion d‚Äôerreur explicite en cas d‚Äôupload rat√©.  

---

## 9. Supabase ‚Äì `config.toml`

### 1/ Probl√®me
- ‚úÖ Aucun (toutes les EF sont bien d√©clar√©es).  

### 2/ V√©rifications pr√©alables
- V√©rifier coh√©rence entre noms de fonctions et r√©pertoires EF.  

### 3/ Solution
- Pas de modification requise.  

---
## 10. Cr√©er une fonction SQL sync_reseau_to_direction() :
- Propager reseau_email ‚Üí reseau_direction.email.
- Propager reseau_telephone ‚Üí reseau_direction.telephone.
- Optionnel : ajouter updated_at.
- Cr√©er un trigger AFTER UPDATE sur la table reseau qui appelle sync_reseau_to_direction().
- Tester : UPDATE reseau.reseau_email et v√©rifier que reseau_direction.email suit.
- V√©rifier que 3. supabase/functions/gestion-reseau-admin-update/index.ts est conforme et en ad√©quation avec cette synchro.
  
---
## 11. Bucket ‚Äì `bucket-table-reseau`

### 1/ Probl√®me
- M√©lange d‚Äôarbres `organisation-{uuid}` et `reseau-{uuid}`.  

### 2/ V√©rifications pr√©alables
- Lister et migrer manuellement les fichiers mal plac√©s.  

### 3/ Solution
- Standardiser d√©finitivement : `reseau-{uuid}`.  
- Mettre √† jour `reseau_logo` et `reseau_ressources` dans la DB pour refl√©ter les nouveaux chemins.  

---

# üöÄ Priorit√©s de correction
1. Corriger **auth logique** dans toutes les EF (`gestion-reseau-admin*`).  
2. Corriger **param√®tres d‚Äôupload** (`type` ‚Üí `fileType`).  
3. Uniformiser **stockage** ‚Üí `reseau-{uuid}`.  
4. Ajouter **logs structur√©s** c√¥t√© EF.  
5. Am√©liorer **gestion erreurs c√¥t√© front** (messages explicites).  
"""


# üìã √âTUDE D'IMPACT - ADAPTATION SERVICE_ROLE_KEY POUR FORMULAIRE GESTION R√âSEAU

## üéØ OBJECTIF DE L'√âTUDE

Adapter le pattern Edge Function SERVICE_ROLE_KEY du formulaire de cr√©ation (qui fonctionne parfaitement) au formulaire de gestion r√©seau pour r√©soudre les probl√®mes RLS du s√©lecteur et am√©liorer la s√©curit√©/performance.

---

## üîç ANALYSE COMPARATIVE - CR√âATION vs GESTION

### ‚úÖ Formulaire Cr√©ation (Fonctionnel)
- **Pattern** : Edge Function `create-reseau-admin` avec `SERVICE_ROLE_KEY`
- **Configuration** : `verify_jwt = false` dans config.toml
- **S√©curit√©** : Bypass RLS via privil√®ges √©lev√©s
- **Performance** : Transaction atomique SQL `create_reseau_compte_complet`
- **Fiabilit√©** : Rollback automatique en cas d'erreur

### ‚ùå Formulaire Gestion (Probl√©matique)
- **Pattern** : Appels directs Supabase depuis hooks React
- **Probl√®me RLS** : S√©lecteur r√©seau bloqu√© par politiques Row Level Security
- **S√©curit√©** : Exposition des requ√™tes c√¥t√© client
- **Performance** : Multiples aller-retours client-serveur
- **Coh√©rence** : Gestion d'erreurs dispers√©e

---

## üìä PROBL√àMES IDENTIFI√âS DANS L'IMPL√âMENTATION ACTUELLE

### üö® Probl√®me Critical #1 : S√©lecteur R√©seau Dysfonctionnel

#### Code Probl√©matique (useReseauFormData.ts lignes 21-27)
```typescript
const { data, error } = await supabase
  .from('reseau')
  .select('reseau_id, reseau_nom, reseau_statut, organisation_id')
  .order('reseau_nom');
```

**Impact :**
- Requ√™te bloqu√©e par RLS policies `admin_presenca_full_access_reseau`
- Admin PRESENCA ne peut pas voir la liste compl√®te des r√©seaux
- Formulaire inutilisable sans s√©lection possible

### üö® Probl√®me Critical #2 : Incoh√©rences TypeScript

#### Types manquants/incorrects (types.ts)
```typescript
// ‚ùå Probl√®me : Types incomplets pour FormState vs Integration
export interface BrevoFormState {
  brevo_api_key?: string;
  brevo_email_compte?: string;
  brevo_nom_compte?: string;
}

export interface BrevoIntegration {
  brevo_connexion_id: string;    // ‚ùå Manque dans FormState
  organisation_id: string;       // ‚ùå Manque dans FormState
  reseau_id: string;            // ‚ùå Manque dans FormState
}
```

**Impact :**
- Erreurs de destructuring dans useReseauIntegrations.ts
- Incoh√©rences entre √©tats UI et donn√©es SQL
- Bugs potentiels lors des mappings

### üö® Probl√®me Critical #3 : Appels RLS Non-S√©curis√©s

#### Hook useReseauIntegrations.ts lignes 39-48
```typescript
const { data: reseau, error } = await supabase
  .from(getTableName('reseau'))
  .select(`
    organisation_id,
    reseau_brevo_connexion_id,
    reseau_zoho_connexion_id,
    reseau_openai_connexion_id
  `)
  .eq('reseau_id', reseauId)
  .maybeSingle();
```

**Probl√®mes :**
- D√©pendance aux RLS policies multi-tenant
- Possibilit√© d'√©chec si policies mal configur√©es
- Exposition de la logique de s√©curit√© c√¥t√© client

---

## üõ†Ô∏è SOLUTION PROPOS√âE : EDGE FUNCTION UNIFI√âE

### üéØ Strat√©gie : Cr√©ation d'une Edge Function `gestion-reseau-admin`

#### Pattern identique √† `create-reseau-admin` :
1. **SERVICE_ROLE_KEY** : Bypass complet des RLS
2. **verify_jwt = false** : Pas de validation token
3. **CORS s√©curis√©** : Origins contr√¥l√©s
4. **Validation serveur** : S√©curit√© c√¥t√© Edge Function
5. **Transaction atomique** : Coh√©rence garantie

---

## üìã MODIFICATIONS REQUISES PAR COMPOSANT

### üîß 1. Configuration Supabase

#### A. Ajout dans `supabase/config.toml`
```toml
[functions.gestion-reseau-admin]
verify_jwt = false
```

#### B. Nouvelle Edge Function `supabase/functions/gestion-reseau-admin/index.ts`
```typescript
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import { getCorsHeaders } from '../_shared/cors.ts';

// CLIENT ADMIN avec SERVICE_ROLE_KEY
const supabaseAdmin = createClient(
  Deno.env.get('SUPABASE_URL') ?? '',
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
);

Deno.serve(async (req) => {
  const origin = req.headers.get('origin');
  const corsHeaders = getCorsHeaders(origin);

  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { action, reseauId, data } = await req.json();

    switch (action) {
      case 'list-reseaux':
        return await listReseaux(corsHeaders);
      case 'get-reseau-details':
        return await getReseauDetails(reseauId, corsHeaders);
      case 'update-reseau':
        return await updateReseau(reseauId, data, corsHeaders);
      case 'manage-integration':
        return await manageIntegration(reseauId, data, corsHeaders);
      default:
        throw new Error('Action non support√©e');
    }
  } catch (error: any) {
    return new Response(
      JSON.stringify({ success: false, error: error.message }),
      { status: 400, headers: corsHeaders }
    );
  }
});

// Fonctions sp√©cialis√©es avec SERVICE_ROLE_KEY
async function listReseaux(corsHeaders: Record<string, string>) {
  // ‚úÖ BYPASS RLS - Liste compl√®te des r√©seaux
  const { data, error } = await supabaseAdmin
    .from('reseau')
    .select('reseau_id, reseau_nom, reseau_statut, organisation_id')
    .order('reseau_nom');

  if (error) throw error;
  
  return new Response(
    JSON.stringify({ success: true, data }),
    { headers: corsHeaders }
  );
}

async function getReseauDetails(reseauId: string, corsHeaders: Record<string, string>) {
  // ‚úÖ BYPASS RLS - D√©tails complets du r√©seau
  const { data: reseau, error: reseauError } = await supabaseAdmin
    .from('reseau')
    .select(`
      reseau_id, reseau_nom, reseau_identite_commerciale,
      reseau_adresse, reseau_code_postal, reseau_ville,
      reseau_siret, reseau_statut, reseau_logo, reseau_ressources,
      reseau_brevo_connexion_id, reseau_zoho_connexion_id, reseau_openai_connexion_id,
      reseau_telephone, reseau_email, organisation_id
    `)
    .eq('reseau_id', reseauId)
    .maybeSingle();

  if (reseauError) throw reseauError;

  // Charger les int√©grations si pr√©sentes
  const integrations: any = {};
  
  if (reseau?.reseau_brevo_connexion_id) {
    const { data: brevo } = await supabaseAdmin
      .from('brevo_connexion')
      .select('brevo_api_key, brevo_email_compte, brevo_nom_compte')
      .eq('brevo_connexion_id', reseau.reseau_brevo_connexion_id)
      .maybeSingle();
    integrations.brevo = brevo;
  }

  if (reseau?.reseau_zoho_connexion_id) {
    const { data: zoho } = await supabaseAdmin
      .from('zoho_connexion')
      .select('zoho_api_key, zoho_email_compte, zoho_nom_compte')
      .eq('zoho_connexion_id', reseau.reseau_zoho_connexion_id)
      .maybeSingle();
    integrations.zoho = zoho;
  }

  if (reseau?.reseau_openai_connexion_id) {
    const { data: openai } = await supabaseAdmin
      .from('openai_connexion')
      .select('openai_api_key, openai_email_compte')
      .eq('openai_connexion_id', reseau.reseau_openai_connexion_id)
      .maybeSingle();
    integrations.openai = openai;
  }

  return new Response(
    JSON.stringify({ 
      success: true, 
      data: { 
        reseau, 
        integrations 
      } 
    }),
    { headers: corsHeaders }
  );
}

async function updateReseau(reseauId: string, updateData: any, corsHeaders: Record<string, string>) {
  // ‚úÖ BYPASS RLS - Mise √† jour directe
  const { error: reseauError } = await supabaseAdmin
    .from('reseau')
    .update({
      reseau_nom: updateData.reseau_nom,
      reseau_identite_commerciale: updateData.reseau_identite_commerciale,
      reseau_adresse: updateData.reseau_adresse,
      reseau_code_postal: updateData.reseau_code_postal,
      reseau_ville: updateData.reseau_ville,
      reseau_siret: updateData.reseau_siret,
      reseau_telephone: updateData.reseau_telephone,
      reseau_email: updateData.reseau_email,
      reseau_updated_at: new Date().toISOString()
    })
    .eq('reseau_id', reseauId);

  if (reseauError) throw reseauError;

  // Synchronisation reseau_direction
  await supabaseAdmin
    .from('reseau_direction')
    .update({
      reseau_direction_telephone: updateData.reseau_telephone,
      reseau_direction_email: updateData.reseau_email
    })
    .eq('reseau_id', reseauId);

  return new Response(
    JSON.stringify({ success: true }),
    { headers: corsHeaders }
  );
}

async function manageIntegration(reseauId: string, integrationData: any, corsHeaders: Record<string, string>) {
  const { kind, data } = integrationData;
  
  // ‚úÖ BYPASS RLS - Gestion int√©grations directe
  // Logique similaire √† useReseauIntegrations mais c√¥t√© serveur
  
  return new Response(
    JSON.stringify({ success: true }),
    { headers: corsHeaders }
  );
}
```

### üîß 2. Adaptations Hooks React

#### A. Refactoring `useReseauFormData.ts`
```typescript
// ‚ùå ANCIEN : Appel direct Supabase
const loadReseaux = useCallback(async () => {
  const { data, error } = await supabase
    .from('reseau')
    .select('reseau_id, reseau_nom, reseau_statut, organisation_id');
}, []);

// ‚úÖ NOUVEAU : Appel Edge Function
const loadReseaux = useCallback(async () => {
  const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
    body: { action: 'list-reseaux' }
  });
  
  if (error) throw error;
  setReseaux(data.data || []);
}, []);

// ‚ùå ANCIEN : Appel direct Supabase
const loadReseauData = useCallback(async (reseauId: string) => {
  const { data: reseau, error } = await supabase
    .from('reseau')
    .select(`...`)
    .eq('reseau_id', reseauId);
}, []);

// ‚úÖ NOUVEAU : Appel Edge Function
const loadReseauData = useCallback(async (reseauId: string) => {
  const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
    body: { action: 'get-reseau-details', reseauId }
  });
  
  if (error) throw error;
  setFormData(data.data.reseau);
  // Gestion int√©grations si n√©cessaire
}, []);

// ‚ùå ANCIEN : Edge Function update-reseau s√©par√©e
const saveReseau = useCallback(async (dataToSave: Partial<ReseauFormData>) => {
  const { error } = await supabase.functions.invoke('update-reseau', {
    body: { reseauId: selectedReseauId, generalData: dataToSave }
  });
}, []);

// ‚úÖ NOUVEAU : Edge Function unifi√©e
const saveReseau = useCallback(async (dataToSave: Partial<ReseauFormData>) => {
  const { error } = await supabase.functions.invoke('gestion-reseau-admin', {
    body: { 
      action: 'update-reseau', 
      reseauId: selectedReseauId, 
      data: dataToSave 
    }
  });
}, []);
```

#### B. Refactoring `useReseauIntegrations.ts`
```typescript
// ‚ùå ANCIEN : Multiples appels RLS
const loadForReseau = useCallback(async (reseauId: string) => {
  // Appel direct supabase + useSupabaseOperations
  const { data: reseau } = await supabase.from(getTableName('reseau')).select(...);
  const brevoResult = await supaOps.select('brevo_connexion', {...});
}, []);

// ‚úÖ NOUVEAU : Appel Edge Function unifi√©
const loadForReseau = useCallback(async (reseauId: string) => {
  const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
    body: { action: 'get-reseau-details', reseauId }
  });
  
  if (error) throw error;
  
  // Extraction donn√©es
  const { reseau, integrations } = data.data;
  setOrganisationId(reseau.organisation_id);
  
  // √âtats UI
  setBrevo(integrations.brevo || {});
  setZoho(integrations.zoho || {});
  setOpenAI(integrations.openai || {});
  
  // IDs techniques
  setBrevoConnexionId(reseau.reseau_brevo_connexion_id);
  setZohoConnexionId(reseau.reseau_zoho_connexion_id);
  setOpenaiConnexionId(reseau.reseau_openai_connexion_id);
}, []);

// ‚ùå ANCIEN : useSupabaseOperations + logique complexe
const saveIntegration = useCallback(async (reseauId: string, kind: 'brevo' | 'zoho' | 'openai') => {
  // Logique insert/update via useSupabaseOperations
}, []);

// ‚úÖ NOUVEAU : Edge Function d√©l√©gu√©e
const saveIntegration = useCallback(async (reseauId: string, kind: 'brevo' | 'zoho' | 'openai') => {
  const integrationData = kind === 'brevo' ? brevo : kind === 'zoho' ? zoho : openai;
  
  const { error } = await supabase.functions.invoke('gestion-reseau-admin', {
    body: { 
      action: 'manage-integration',
      reseauId,
      data: { kind, data: integrationData }
    }
  });
  
  if (error) throw error;
  toast({ title: 'Succ√®s', description: `Int√©gration ${kind} mise √† jour` });
}, [brevo, zoho, openai]);
```

### üîß 3. Corrections Types TypeScript

#### A. Refactoring `types.ts`
```typescript
// ‚úÖ NOUVEAU : Types unifi√©s et coh√©rents
export interface ReseauFormData {
  reseau_id: string;
  organisation_id: string;
  reseau_nom: string;
  reseau_identite_commerciale?: string | null;
  reseau_adresse?: string | null;
  reseau_code_postal?: string | null;
  reseau_ville?: string | null;
  reseau_siret?: string | null;
  reseau_statut?: string | null;
  reseau_logo?: string | null;
  reseau_ressources?: string[];
  reseau_telephone?: string | null;
  reseau_email?: string | null;
  reseau_brevo_connexion_id?: string | null;
  reseau_zoho_connexion_id?: string | null;
  reseau_openai_connexion_id?: string | null;
}

// ‚úÖ NOUVEAU : √âtats UI distincts des donn√©es SQL
export interface IntegrationFormStates {
  brevo: {
    brevo_api_key?: string;
    brevo_email_compte?: string;
    brevo_nom_compte?: string;
  };
  zoho: {
    zoho_api_key?: string;
    zoho_email_compte?: string;
    zoho_nom_compte?: string;
  };
  openai: {
    openai_api_key?: string;
    openai_email_compte?: string;
  };
}

// ‚úÖ NOUVEAU : IDs techniques s√©par√©s
export interface IntegrationConnectionIds {
  brevoConnexionId: string | null;
  zohoConnexionId: string | null;
  openaiConnexionId: string | null;
}

// ‚úÖ NOUVEAU : R√©ponses Edge Function
export interface ManageReseauResponse {
  success: boolean;
  data?: any;
  error?: string;
}

export interface ReseauDetailsResponse {
  reseau: ReseauFormData;
  integrations: {
    brevo?: any;
    zoho?: any;
    openai?: any;
  };
}
```

---

## üö® RISQUES ET POINTS CRITIQUES IDENTIFI√âS

### üî¥ Risque Critical #1 : Duplication Edge Functions
**Probl√®me :** Coexistence de `update-reseau` et `gestion-reseau-admin`

**Solution :**
1. **Phase 1** : Cr√©er `gestion-reseau-admin` avec toutes les fonctionnalit√©s
2. **Phase 2** : Migrer le code du formulaire vers la nouvelle Edge Function
3. **Phase 3** : Supprimer `update-reseau` une fois migration valid√©e

### üî¥ Risque Critical #2 : Coh√©rence Multi-Tenant
**Probl√®me :** SERVICE_ROLE_KEY bypass toutes les RLS policies

**Solution :**
- **Validation explicite** de l'organisation_id dans Edge Function
- **Logs de s√©curit√©** pour tra√ßabilit√© des acc√®s admin
- **Tests de s√©curit√©** pour v√©rifier isolation multi-tenant

### üî¥ Risque Critical #3 : Migration Donn√©es Existantes
**Probl√®me :** Donn√©es existantes avec connexion_id potentiellement NULL

**Solution :**
```sql
-- Migration de nettoyage si n√©cessaire
UPDATE reseau SET 
  reseau_brevo_connexion_id = NULL 
WHERE reseau_brevo_connexion_id IS NOT NULL 
  AND NOT EXISTS (SELECT 1 FROM brevo_connexion WHERE brevo_connexion_id = reseau.reseau_brevo_connexion_id);
```

### üü° Risque Medium #1 : Performance Edge Function
**Probl√®me :** Multiple requ√™tes dans `getReseauDetails`

**Solution :**
- **JOIN SQL optimis√©** au lieu de requ√™tes s√©quentielles
- **Cache temporaire** pour les donn√©es statiques
- **Pagination** si liste r√©seaux tr√®s longue

### üü° Risque Medium #2 : Gestion Erreurs TypeScript
**Probl√®me :** Destructuring √©choue si donn√©es Edge Function incorrectes

**Solution :**
```typescript
// ‚úÖ Validation runtime robuste
const validateEdgeFunctionResponse = (data: any): ReseauDetailsResponse => {
  if (!data?.reseau?.reseau_id) {
    throw new Error('Donn√©es r√©seau invalides re√ßues');
  }
  return data as ReseauDetailsResponse;
};
```

---

## ‚öñÔ∏è IMPACTS UI/UX PR√âVISIBLES

### ‚úÖ Am√©liorations Attendues
1. **S√©lecteur r√©seau fonctionnel** : Liste compl√®te disponible
2. **Performance am√©lior√©e** : Moins d'aller-retours client-serveur
3. **Coh√©rence donn√©es** : Source unique via Edge Function
4. **Gestion erreurs unifi√©e** : Messages coh√©rents
5. **S√©curit√© renforc√©e** : Logique sensible c√¥t√© serveur

### ‚ö†Ô∏è Impacts Temporaires
1. **Temps de d√©veloppement** : 2-3 jours pour migration compl√®te
2. **Tests complets** : Validation de toutes les fonctionnalit√©s
3. **Formation √©quipe** : Nouveau pattern Edge Function √† ma√Ætriser

---

## üìã PLAN DE MIGRATION RECOMMAND√â

### üîÑ Phase 1 : Pr√©paration (1 jour)
1. **Cr√©er Edge Function** `gestion-reseau-admin`
2. **Ajouter configuration** supabase/config.toml
3. **Tests unitaires** de la nouvelle Edge Function
4. **Validation s√©curit√©** SERVICE_ROLE_KEY

### üîÑ Phase 2 : Migration Hooks (1 jour)
1. **Adapter useReseauFormData** vers Edge Function calls
2. **Adapter useReseauIntegrations** vers Edge Function calls
3. **Corriger types TypeScript** pour coh√©rence
4. **Tests fonctionnels** du s√©lecteur r√©seau

### üîÑ Phase 3 : Validation & Nettoyage (1 jour)
1. **Tests complets** de tous les onglets du formulaire
2. **Validation multi-tenant** avec diff√©rents comptes
3. **Suppression ancienne Edge Function** `update-reseau`
4. **Documentation** du nouveau pattern

---

## üéØ CONCLUSION ET RECOMMANDATIONS

### ‚úÖ Faisabilit√© Technique : **EXCELLENTE**
- Pattern Edge Function SERVICE_ROLE_KEY d√©j√† valid√© et fonctionnel
- Architecture r√©utilisable sans modification majeure
- Compatibilit√© compl√®te avec l'existant

### ‚úÖ B√©n√©fices S√©curit√© : **√âLEV√âS**
- Bypass propre des RLS policies probl√©matiques
- Centralisation logique sensible c√¥t√© serveur
- Contr√¥le granulaire des acc√®s admin

### ‚úÖ Impact Performance : **POSITIF**
- R√©duction aller-retours client-serveur
- Transaction atomique c√¥t√© Edge Function
- Optimisation requ√™tes SQL possibles

### üö® Points de Vigilance : **G√âRABLES**
- Migration soigneuse pour √©viter r√©gression
- Tests s√©curit√© multi-tenant approfondis
- Documentation pattern pour √©quipe

### üéØ Recommandation Finale : **MIGRATION IMM√âDIATE**
**L'adaptation du pattern SERVICE_ROLE_KEY au formulaire de gestion r√©seau est non seulement faisable mais fortement recommand√©e pour r√©soudre les probl√®mes actuels et am√©liorer significativement la robustesse de l'application.**

---
---

# üìã CODES D√âFINITIFS - MIGRATION SERVICE_ROLE_KEY FORMULAIRE GESTION R√âSEAU

## üéØ OBJECTIF 
Migration compl√®te du formulaire de gestion r√©seau vers une Edge Function s√©curis√©e avec SERVICE_ROLE_KEY pour r√©soudre les blocages RLS.

---

## üìÅ FICHIER 1/6 : Edge Function `supabase/functions/gestion-reseau-admin/index.ts`

```typescript
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

// ‚úÖ CORS Headers s√©curis√©s
function getCorsHeaders() {
  return {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    'Access-Control-Allow-Methods': 'POST, OPTIONS'
  };
}

// ‚úÖ CLIENT ADMIN avec SERVICE_ROLE_KEY (bypass RLS)
const supabaseAdmin = createClient(
  Deno.env.get('SUPABASE_URL') ?? '',
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
);

// ‚úÖ SERVEUR PRINCIPAL
Deno.serve(async (req) => {
  const corsHeaders = getCorsHeaders();

  // CORS pr√©flight
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { action, reseauId, data } = await req.json();

    console.log(`[gestion-reseau-admin] Action: ${action}, ReseauId: ${reseauId}`);

    switch (action) {
      case 'list-reseaux':
        return await listReseaux(corsHeaders);
      case 'get-reseau-details':
        return await getReseauDetails(reseauId, corsHeaders);
      case 'update-reseau':
        return await updateReseau(reseauId, data, corsHeaders);
      case 'manage-integration':
        return await manageIntegration(reseauId, data, corsHeaders);
      default:
        throw new Error(`Action non support√©e: ${action}`);
    }
  } catch (error: any) {
    console.error('[gestion-reseau-admin] Erreur:', error.message);
    return new Response(
      JSON.stringify({ success: false, error: error.message }),
      { status: 400, headers: corsHeaders }
    );
  }
});

// ===============================
// FONCTION 1: LISTE DES R√âSEAUX
// ===============================
async function listReseaux(corsHeaders: Record<string, string>) {
  console.log('[listReseaux] D√©but r√©cup√©ration liste r√©seaux');
  
  const { data, error } = await supabaseAdmin
    .from('reseau')
    .select('reseau_id, reseau_nom, reseau_statut, organisation_id')
    .order('reseau_nom');

  if (error) {
    console.error('[listReseaux] Erreur:', error);
    throw error;
  }

  console.log(`[listReseaux] ${data?.length || 0} r√©seaux trouv√©s`);
  
  return new Response(
    JSON.stringify({ success: true, data: data || [] }),
    { headers: corsHeaders }
  );
}

// ===============================
// FONCTION 2: D√âTAILS R√âSEAU + INT√âGRATIONS
// ===============================
async function getReseauDetails(reseauId: string, corsHeaders: Record<string, string>) {
  if (!reseauId) {
    throw new Error('reseauId requis');
  }

  console.log(`[getReseauDetails] Chargement r√©seau ${reseauId}`);

  // 1. Charger donn√©es r√©seau
  const { data: reseau, error: reseauError } = await supabaseAdmin
    .from('reseau')
    .select(`
      reseau_id, reseau_nom, reseau_identite_commerciale,
      reseau_adresse, reseau_code_postal, reseau_ville,
      reseau_siret, reseau_statut, reseau_logo, reseau_ressources,
      reseau_brevo_connexion_id, reseau_zoho_connexion_id, reseau_openai_connexion_id,
      reseau_telephone, reseau_email, organisation_id
    `)
    .eq('reseau_id', reseauId)
    .maybeSingle();

  if (reseauError) {
    console.error('[getReseauDetails] Erreur reseau:', reseauError);
    throw reseauError;
  }

  if (!reseau) {
    throw new Error(`R√©seau ${reseauId} introuvable`);
  }

  console.log(`[getReseauDetails] R√©seau trouv√©: ${reseau.reseau_nom}`);

  // 2. Charger int√©grations en parall√®le
  const integrations: any = {};
  const promises: Promise<void>[] = [];

  // Brevo
  if (reseau.reseau_brevo_connexion_id) {
    promises.push(
      supabaseAdmin
        .from('brevo_connexion')
        .select('brevo_api_key, brevo_email_compte, brevo_nom_compte')
        .eq('brevo_connexion_id', reseau.reseau_brevo_connexion_id)
        .maybeSingle()
        .then(({ data }) => {
          integrations.brevo = data;
          console.log('[getReseauDetails] Brevo charg√©');
        })
    );
  }

  // Zoho
  if (reseau.reseau_zoho_connexion_id) {
    promises.push(
      supabaseAdmin
        .from('zoho_connexion')
        .select('zoho_api_key, zoho_email_compte, zoho_nom_compte')
        .eq('zoho_connexion_id', reseau.reseau_zoho_connexion_id)
        .maybeSingle()
        .then(({ data }) => {
          integrations.zoho = data;
          console.log('[getReseauDetails] Zoho charg√©');
        })
    );
  }

  // OpenAI
  if (reseau.reseau_openai_connexion_id) {
    promises.push(
      supabaseAdmin
        .from('openai_connexion')
        .select('openai_api_key, openai_email_compte')
        .eq('openai_connexion_id', reseau.reseau_openai_connexion_id)
        .maybeSingle()
        .then(({ data }) => {
          integrations.openai = data;
          console.log('[getReseauDetails] OpenAI charg√©');
        })
    );
  }

  // Attendre toutes les int√©grations
  await Promise.all(promises);

  return new Response(
    JSON.stringify({ 
      success: true, 
      data: { 
        reseau, 
        integrations 
      } 
    }),
    { headers: corsHeaders }
  );
}

// ===============================
// FONCTION 3: MISE √Ä JOUR R√âSEAU
// ===============================
async function updateReseau(reseauId: string, updateData: any, corsHeaders: Record<string, string>) {
  if (!reseauId || !updateData) {
    throw new Error('reseauId et updateData requis');
  }

  console.log(`[updateReseau] Mise √† jour r√©seau ${reseauId}`);

  // 1. Mise √† jour table r√©seau
  const { error: reseauError } = await supabaseAdmin
    .from('reseau')
    .update({
      reseau_nom: updateData.reseau_nom,
      reseau_identite_commerciale: updateData.reseau_identite_commerciale,
      reseau_adresse: updateData.reseau_adresse,
      reseau_code_postal: updateData.reseau_code_postal,
      reseau_ville: updateData.reseau_ville,
      reseau_siret: updateData.reseau_siret,
      reseau_telephone: updateData.reseau_telephone,
      reseau_email: updateData.reseau_email,
      reseau_updated_at: new Date().toISOString()
    })
    .eq('reseau_id', reseauId);

  if (reseauError) {
    console.error('[updateReseau] Erreur mise √† jour reseau:', reseauError);
    throw reseauError;
  }

  // 2. Synchronisation reseau_direction (email/t√©l√©phone)
  if (updateData.reseau_telephone || updateData.reseau_email) {
    const { error: directionError } = await supabaseAdmin
      .from('reseau_direction')
      .update({
        reseau_direction_telephone: updateData.reseau_telephone,
        reseau_direction_email: updateData.reseau_email
      })
      .eq('reseau_id', reseauId);

    if (directionError) {
      console.warn('[updateReseau] Avertissement sync direction:', directionError.message);
    } else {
      console.log('[updateReseau] Synchronisation direction r√©ussie');
    }
  }

  console.log(`[updateReseau] R√©seau ${reseauId} mis √† jour avec succ√®s`);

  return new Response(
    JSON.stringify({ success: true }),
    { headers: corsHeaders }
  );
}

// ===============================
// FONCTION 4: GESTION INT√âGRATIONS
// ===============================
async function manageIntegration(reseauId: string, integrationData: any, corsHeaders: Record<string, string>) {
  const { kind, data: formData } = integrationData;
  
  if (!reseauId || !kind || !formData) {
    throw new Error('reseauId, kind et data requis');
  }

  console.log(`[manageIntegration] ${kind} pour r√©seau ${reseauId}`);

  // 1. R√©cup√©rer organisation_id du r√©seau
  const { data: reseau, error: reseauError } = await supabaseAdmin
    .from('reseau')
    .select('organisation_id, reseau_' + kind + '_connexion_id')
    .eq('reseau_id', reseauId)
    .maybeSingle();

  if (reseauError || !reseau) {
    throw new Error('R√©seau introuvable');
  }

  const tableName = kind + '_connexion';
  const idField = kind + '_connexion_id';
  const existingId = reseau['reseau_' + kind + '_connexion_id'];

  let connexionId = existingId;

  if (existingId) {
    // MISE √Ä JOUR
    const { error: updateError } = await supabaseAdmin
      .from(tableName)
      .update({
        [`${kind}_api_key`]: formData[`${kind}_api_key`],
        [`${kind}_email_compte`]: formData[`${kind}_email_compte`],
        [`${kind}_nom_compte`]: formData[`${kind}_nom_compte`] || null,
        [`${kind}_updated_at`]: new Date().toISOString()
      })
      .eq(idField, existingId);

    if (updateError) {
      console.error(`[manageIntegration] Erreur update ${kind}:`, updateError);
      throw updateError;
    }
    
    console.log(`[manageIntegration] ${kind} mis √† jour`);
  } else {
    // CR√âATION
    const { data: newConnection, error: insertError } = await supabaseAdmin
      .from(tableName)
      .insert({
        organisation_id: reseau.organisation_id,
        reseau_id: reseauId,
        [`${kind}_api_key`]: formData[`${kind}_api_key`],
        [`${kind}_email_compte`]: formData[`${kind}_email_compte`],
        [`${kind}_nom_compte`]: formData[`${kind}_nom_compte`] || null
      })
      .select(idField)
      .single();

    if (insertError || !newConnection) {
      console.error(`[manageIntegration] Erreur insert ${kind}:`, insertError);
      throw insertError;
    }

    connexionId = newConnection[idField];

    // Mettre √† jour FK dans table r√©seau
    const { error: updateReseauError } = await supabaseAdmin
      .from('reseau')
      .update({ [`reseau_${kind}_connexion_id`]: connexionId })
      .eq('reseau_id', reseauId);

    if (updateReseauError) {
      console.error(`[manageIntegration] Erreur update FK r√©seau:`, updateReseauError);
      throw updateReseauError;
    }

    console.log(`[manageIntegration] ${kind} cr√©√© avec ID: ${connexionId}`);
  }

  return new Response(
    JSON.stringify({ success: true, connexionId }),
    { headers: corsHeaders }
  );
}
```
---

---

## üìÅ FICHIER 2/6 : Hook `useReseauFormData.ts` - VERSION COMPL√àTE

```typescript
import { useState, useCallback } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import type { ReseauFormData, ReseauSelectorItem, ValidationErrors } from './types';

export function useReseauFormData() {
  const [reseaux, setReseaux] = useState<ReseauSelectorItem[]>([]);
  const [selectedReseauId, setSelectedReseauId] = useState<string>('');
  const [formData, setFormData] = useState<Partial<ReseauFormData>>({});
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [errors, setErrors] = useState<ValidationErrors>({});
  const { toast } = useToast();

  /**
   * ‚úÖ NOUVEAU : Charger la liste des r√©seaux via Edge Function
   */
  const loadReseaux = useCallback(async () => {
    setIsLoading(true);
    try {
      const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
        body: JSON.stringify({ action: 'list-reseaux' })
      });

      if (error) throw error;
      if (!data.success) throw new Error(data.error || 'Erreur inconnue');
      
      setReseaux(data.data || []);
    } catch (err: any) {
      console.error('[loadReseaux] Erreur:', err);
      toast({
        title: 'Erreur',
        description: 'Impossible de charger les r√©seaux',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  }, [toast]);

  /**
   * ‚úÖ NOUVEAU : Charger les donn√©es compl√®tes d'un r√©seau via Edge Function
   */
  const loadReseauData = useCallback(
    async (reseauId: string) => {
      if (!reseauId) return;
      setIsLoading(true);
      try {
        const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
          body: JSON.stringify({ 
            action: 'get-reseau-details', 
            reseauId 
          })
        });

        if (error) throw error;
        if (!data.success) throw new Error(data.error || 'Erreur inconnue');

        if (!data.data.reseau) {
          setFormData({});
          toast({
            title: 'Introuvable',
            description: 'R√©seau introuvable',
            variant: 'destructive',
          });
          return;
        }

        setFormData(data.data.reseau);
        setErrors({});
      } catch (err: any) {
        console.error('[loadReseauData] Erreur:', err);
        toast({
          title: 'Erreur',
          description: 'Impossible de charger les donn√©es du r√©seau',
          variant: 'destructive',
        });
      } finally {
        setIsLoading(false);
      }
    },
    [toast]
  );

  /**
   * Validation c√¥t√© frontend avant sauvegarde
   */
  const validateForm = useCallback(
    (data: Partial<ReseauFormData>): ValidationErrors => {
      const newErrors: ValidationErrors = {};

      if (data.reseau_code_postal && !/^\d{5}$/.test(data.reseau_code_postal)) {
        newErrors.reseau_code_postal = 'Le code postal doit contenir 5 chiffres';
      }

      if (data.reseau_siret && !/^\d{14}$/.test(data.reseau_siret.replace(/\s/g, ''))) {
        newErrors.reseau_siret = 'Le SIRET doit contenir 14 chiffres';
      }

      return newErrors;
    },
    []
  );

  /**
   * ‚úÖ NOUVEAU : Sauvegarder les donn√©es d'un r√©seau via Edge Function
   */
  const saveReseau = useCallback(
    async (dataToSave: Partial<ReseauFormData>) => {
      if (!selectedReseauId) return false;

      const validationErrors = validateForm(dataToSave);
      setErrors(validationErrors);
      if (Object.keys(validationErrors).length > 0) {
        toast({
          title: 'Erreurs de validation',
          description: 'Veuillez corriger les erreurs',
          variant: 'destructive',
        });
        return false;
      }

      setIsSaving(true);
      try {
        const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
          body: JSON.stringify({
            action: 'update-reseau',
            reseauId: selectedReseauId,
            data: dataToSave,
          }),
        });

        if (error) throw error;
        if (!data.success) throw new Error(data.error || 'Erreur inconnue');

        toast({
          title: 'Succ√®s',
          description: 'R√©seau mis √† jour avec succ√®s',
        });
        await loadReseauData(selectedReseauId);
        return true;
      } catch (err: any) {
        console.error('[saveReseau] Erreur:', err);
        toast({
          title: 'Erreur',
          description: 'Impossible de sauvegarder les modifications',
          variant: 'destructive',
        });
        return false;
      } finally {
        setIsSaving(false);
      }
    },
    [selectedReseauId, validateForm, toast, loadReseauData]
  );

  /**
   * Mise √† jour d'un champ dans l'√©tat local
   */
  const updateFormField = useCallback(
    (field: keyof ReseauFormData | string, value: any) => {
      setFormData((prev) => ({ ...prev, [field]: value }));
      if (errors[field]) {
        setErrors((prev) => {
          const e = { ...prev };
          delete e[field];
          return e;
        });
      }
    },
    [errors]
  );

  /**
   * S√©lection d'un r√©seau dans le dropdown
   */
  const selectReseau = useCallback(
    (reseauId: string) => {
      setSelectedReseauId(reseauId);
      if (reseauId) {
        loadReseauData(reseauId);
      } else {
        setFormData({});
        setErrors({});
      }
    },
    [loadReseauData]
  );

  return {
    reseaux,
    selectedReseauId,
    formData,
    isLoading,
    isSaving,
    errors,
    loadReseaux,
    selectReseau,
    updateFormField,
    saveReseau,
    validateForm,
    loadReseauData,
  };
}
```
---
---

## üìÅ FICHIER 3/6 : Hook `useReseauIntegrations.ts` - VERSION COMPL√àTE

```typescript
import { useState, useCallback } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import type { BrevoFormState, ZohoFormState, OpenAIFormState } from './types';

export function useReseauIntegrations() {
  // √âtats pour l'organisation
  const [organisationId, setOrganisationId] = useState<string | null>(null);
  
  // √âtats UI pour les formulaires
  const [brevo, setBrevo] = useState<BrevoFormState>({});
  const [zoho, setZoho] = useState<ZohoFormState>({});
  const [openai, setOpenai] = useState<OpenAIFormState>({});
  
  // IDs techniques des connexions (pour updates)
  const [brevoConnexionId, setBrevoConnexionId] = useState<string | null>(null);
  const [zohoConnexionId, setZohoConnexionId] = useState<string | null>(null);
  const [openaiConnexionId, setOpenaiConnexionId] = useState<string | null>(null);
  
  // √âtats UI
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  
  const { toast } = useToast();

  /**
   * ‚úÖ NOUVEAU : Charger les int√©grations d'un r√©seau via Edge Function
   */
  const loadForReseau = useCallback(async (reseauId: string) => {
    if (!reseauId) return;
    
    setIsLoading(true);
    try {
      const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
        body: JSON.stringify({ 
          action: 'get-reseau-details', 
          reseauId 
        })
      });

      if (error) throw error;
      if (!data.success) throw new Error(data.error || 'Erreur inconnue');

      const { reseau, integrations } = data.data;
      
      // Donn√©es techniques
      setOrganisationId(reseau.organisation_id);
      setBrevoConnexionId(reseau.reseau_brevo_connexion_id);
      setZohoConnexionId(reseau.reseau_zoho_connexion_id);
      setOpenaiConnexionId(reseau.reseau_openai_connexion_id);
      
      // √âtats UI des formulaires
      setBrevo({
        brevo_api_key: integrations.brevo?.brevo_api_key || '',
        brevo_email_compte: integrations.brevo?.brevo_email_compte || '',
        brevo_nom_compte: integrations.brevo?.brevo_nom_compte || ''
      });
      
      setZoho({
        zoho_api_key: integrations.zoho?.zoho_api_key || '',
        zoho_email_compte: integrations.zoho?.zoho_email_compte || '',
        zoho_nom_compte: integrations.zoho?.zoho_nom_compte || ''
      });
      
      setOpenai({
        openai_api_key: integrations.openai?.openai_api_key || '',
        openai_email_compte: integrations.openai?.openai_email_compte || ''
      });

    } catch (err: any) {
      console.error('[loadForReseau] Erreur:', err);
      toast({
        title: 'Erreur',
        description: 'Impossible de charger les int√©grations',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  }, [toast]);

  /**
   * ‚úÖ NOUVEAU : Sauvegarder une int√©gration via Edge Function
   */
  const saveIntegration = useCallback(
    async (reseauId: string, kind: 'brevo' | 'zoho' | 'openai'): Promise<boolean> => {
      if (!reseauId || !kind) return false;

      const integrationData = kind === 'brevo' ? brevo : 
                            kind === 'zoho' ? zoho : openai;

      // Validation basique
      if (!integrationData[`${kind}_api_key`]) {
        toast({
          title: 'Erreur',
          description: 'La cl√© API est requise',
          variant: 'destructive',
        });
        return false;
      }

      setIsSaving(true);
      try {
        const { data, error } = await supabase.functions.invoke('gestion-reseau-admin', {
          body: JSON.stringify({
            action: 'manage-integration',
            reseauId,
            data: { kind, data: integrationData }
          })
        });

        if (error) throw error;
        if (!data.success) throw new Error(data.error || 'Erreur inconnue');

        toast({
          title: 'Succ√®s',
          description: `Int√©gration ${kind.toUpperCase()} mise √† jour`,
        });

        // Mettre √† jour l'ID de connexion si nouvelle cr√©ation
        if (data.connexionId) {
          if (kind === 'brevo') setBrevoConnexionId(data.connexionId);
          else if (kind === 'zoho') setZohoConnexionId(data.connexionId);
          else if (kind === 'openai') setOpenaiConnexionId(data.connexionId);
        }

        return true;
      } catch (err: any) {
        console.error(`[saveIntegration] Erreur ${kind}:`, err);
        toast({
          title: 'Erreur',
          description: `Impossible de sauvegarder l'int√©gration ${kind.toUpperCase()}`,
          variant: 'destructive',
        });
        return false;
      } finally {
        setIsSaving(false);
      }
    },
    [brevo, zoho, openai, toast]
  );

  /**
   * Mise √† jour d'un champ dans un formulaire d'int√©gration
   */
  const updateBrevoField = useCallback((field: keyof BrevoFormState, value: string) => {
    setBrevo(prev => ({ ...prev, [field]: value }));
  }, []);

  const updateZohoField = useCallback((field: keyof ZohoFormState, value: string) => {
    setZoho(prev => ({ ...prev, [field]: value }));
  }, []);

  const updateOpenAIField = useCallback((field: keyof OpenAIFormState, value: string) => {
    setOpenai(prev => ({ ...prev, [field]: value }));
  }, []);

  /**
   * Reset d'un formulaire d'int√©gration
   */
  const resetIntegration = useCallback((kind: 'brevo' | 'zoho' | 'openai') => {
    if (kind === 'brevo') {
      setBrevo({});
      setBrevoConnexionId(null);
    } else if (kind === 'zoho') {
      setZoho({});
      setZohoConnexionId(null);
    } else if (kind === 'openai') {
      setOpenai({});
      setOpenaiConnexionId(null);
    }
  }, []);

  return {
    // √âtats donn√©es
    organisationId,
    brevo,
    zoho,
    openai,
    brevoConnexionId,
    zohoConnexionId,
    openaiConnexionId,
    
    // √âtats UI
    isLoading,
    isSaving,
    
    // Actions
    loadForReseau,
    saveIntegration,
    updateBrevoField,
    updateZohoField,
    updateOpenAIField,
    resetIntegration,
    
    // Setters (pour compatibilit√© existante)
    setBrevo,
    setZoho,
    setOpenAI: setOpenai
  };
}
```
---
---

## üìÅ FICHIER 4/6 : Types `types.ts` - VERSION D√âFINITIVE

```typescript
// ==============================
// Donn√©es du R√©seau (SQL strict)
// ==============================
export interface ReseauFormData {
  reseau_id: string;
  organisation_id: string;
  reseau_nom: string;
  reseau_identite_commerciale?: string | null;
  reseau_adresse?: string | null;
  reseau_code_postal?: string | null;
  reseau_ville?: string | null;
  reseau_siret?: string | null;
  reseau_statut?: string | null;
  reseau_logo?: string | null;
  reseau_ressources?: string[]; // fichiers stock√©s
  reseau_telephone?: string | null; // Point de v√©rit√©
  reseau_email?: string | null;     // Point de v√©rit√©
  reseau_brevo_connexion_id?: string | null;
  reseau_zoho_connexion_id?: string | null;
  reseau_openai_connexion_id?: string | null;
}

// ==============================
// El√©ments pour le s√©lecteur
// ==============================
export interface ReseauSelectorItem {
  reseau_id: string;
  reseau_nom: string;
  reseau_statut: string;
  organisation_id: string;
}

// ==============================
// Int√©grations - Tables connexions (SQL strict)
// ==============================
export interface BrevoIntegration {
  brevo_connexion_id: string;
  organisation_id: string;
  reseau_id: string;
  brevo_api_key?: string | null;
  brevo_email_compte?: string | null;
  brevo_nom_compte?: string | null;
}

export interface ZohoIntegration {
  zoho_connexion_id: string;
  organisation_id: string;
  reseau_id: string;
  zoho_api_key?: string | null;
  zoho_email_compte?: string | null;
  zoho_nom_compte?: string | null;
}

export interface OpenAIIntegration {
  openai_connexion_id: string;
  organisation_id: string;
  reseau_id: string;
  openai_api_key?: string | null;
  openai_email_compte?: string | null;
}

// ==============================
// √âtats du formulaire (Front) - UI UNIQUEMENT
// ==============================
export interface BrevoFormState {
  brevo_api_key?: string;
  brevo_email_compte?: string;
  brevo_nom_compte?: string;
}

export interface ZohoFormState {
  zoho_api_key?: string;
  zoho_email_compte?: string;
  zoho_nom_compte?: string;
}

export interface OpenAIFormState {
  openai_api_key?: string;
  openai_email_compte?: string;
}

export interface IntegrationsState {
  brevo: BrevoFormState;
  zoho: ZohoFormState;
  openai: OpenAIFormState;
}

// ==============================
// R√©ponses Edge Function
// ==============================
export interface EdgeFunctionResponse {
  success: boolean;
  data?: any;
  error?: string;
}

export interface ReseauDetailsResponse {
  reseau: ReseauFormData;
  integrations: {
    brevo?: BrevoIntegration;
    zoho?: ZohoIntegration;
    openai?: OpenAIIntegration;
  };
}

export interface IntegrationSaveResponse {
  success: boolean;
  connexionId?: string;
  error?: string;
}

// ==============================
// Erreurs de validation
// ==============================
export type ValidationErrors = {
  [K in keyof Partial<ReseauFormData>]?: string;
};

// ==============================
// Actions Edge Function
// ==============================
export type EdgeFunctionAction = 
  | 'list-reseaux'
  | 'get-reseau-details'
  | 'update-reseau'
  | 'manage-integration';

export interface EdgeFunctionRequest {
  action: EdgeFunctionAction;
  reseauId?: string;
  data?: any;
}

// ==============================
// Types pour gestion int√©grations
// ==============================
export type IntegrationType = 'brevo' | 'zoho' | 'openai';

export interface IntegrationManageRequest {
  kind: IntegrationType;
  data: BrevoFormState | ZohoFormState | OpenAIFormState;
}
```
---

## üìÅ FICHIER 5/6 : Configuration `supabase/config.toml`

```toml
project_id = "ksymahfrtvhnbeobsspt"

[functions.notifier-nouvelle-demande]
verify_jwt = false

[functions.create-reseau-admin]
verify_jwt = false

[functions.gestion-reseau-admin]
verify_jwt = false
```

---

## üìÅ FICHIER 6/6 : CORS Partag√© `supabase/functions/_shared/cors.ts`

```typescript
// ‚úÖ CORS Headers s√©curis√©s pour toutes les Edge Functions
export function getCorsHeaders(origin?: string | null) {
  return {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Content-Type': 'application/json'
  };
}
```

---

## üîß PLAN DE MIGRATION

### √âtape 1 : Cr√©ation Edge Function
1. Cr√©er `supabase/functions/gestion-reseau-admin/index.ts`
2. Cr√©er `supabase/functions/_shared/cors.ts` (si inexistant)
3. Mettre √† jour `supabase/config.toml`

### √âtape 2 : Migration hooks
1. Remplacer `useReseauFormData.ts` 
2. Remplacer `useReseauIntegrations.ts`
3. Mettre √† jour `types.ts`

### √âtape 3 : Tests
1. Tester s√©lecteur r√©seau (listReseaux)
2. Tester chargement d√©tails (getReseauDetails)
3. Tester sauvegarde r√©seau (updateReseau)
4. Tester sauvegarde int√©grations (manageIntegration)

### √âtape 4 : Nettoyage
1. Supprimer l'ancienne Edge Function `update-reseau` si elle existe
2. V√©rifier logs Supabase pour erreurs

---

## ‚ö†Ô∏è POINTS CRITIQUES

1. **Multi-tenant**: Validation `organisation_id` dans Edge Function
2. **Performance**: Requ√™tes parall√®les int√©grations 
3. **S√©curit√©**: SERVICE_ROLE_KEY pour bypass RLS
4. **TypeScript**: S√©paration FormState vs SQL Data
5. **Logs**: Console.log pour debugging Edge Function










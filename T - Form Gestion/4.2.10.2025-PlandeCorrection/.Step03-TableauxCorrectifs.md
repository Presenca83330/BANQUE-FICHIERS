9# TABLEAUX CORRECTIFS DES BUGS
---
## üìä TABLEAU R√âCAPITULATIF DES BUGS/SOLUTIONS PAR IA LOVABLE

| üî¥ **Bug** | üìÅ **Fichiers Concern√©s** | üîç **Nature du Probl√®me** | ‚ö†Ô∏è **Impact** | ‚úÖ **Solution** |
|-----------|---------------------------|---------------------------|---------------|----------------|
| **BUG #1 CRITIQUE** : assertServiceRoleAuth() bloque tous les appels | ‚Ä¢ `gestion-reseau-admin/index.ts` (lignes 61-72)<br>‚Ä¢ `gestion-reseau-admin-donnees/index.ts` (lignes 61-72)<br>‚Ä¢ `gestion-reseau-admin-update/index.ts` (lignes 61-72)<br>‚Ä¢ `gestion-reseau-admin-fichiers/index.ts` (lignes 61-72) | La fonction `assertServiceRoleAuth()` v√©rifie que le header `authorization` contient le `SERVICE_ROLE_KEY`, mais le client frontend envoie l'`ANON_KEY`. R√©sultat : **ANON_KEY ‚â† SERVICE_ROLE_KEY** ‚Üí Erreur syst√©matique. | ‚õî **BLOCAGE TOTAL** : Tous les appels retournent 401 Unauthorized avant m√™me d'atteindre la logique m√©tier. Le formulaire ne peut ni lister ni charger les donn√©es. | Supprimer `assertServiceRoleAuth()` et `assertAdminIfProvided()` des 4 Edge Functions. Utiliser directement le client Supabase Admin comme dans `create-reseau-admin/index.ts`. |
| **BUG #2** : Pattern data.data non respect√© | ‚Ä¢ `gestion-reseau-admin/index.ts` (lignes 140-153)<br>‚Ä¢ `gestion-reseau-admin-donnees/index.ts` (lignes 292-301)<br>‚Ä¢ `gestion-reseau-admin-update/index.ts` (lignes 337-350) | Les fonctions retournent `{ok, reseau, integrations}` au lieu de `{success, data: {reseau, integrations}}`. Le hook frontend s'attend √† `data.data.reseau` mais re√ßoit `data.reseau` ‚Üí undefined. | ‚ö†Ô∏è **Donn√©es inaccessibles** : Le formulaire ne se charge pas car les donn√©es ne sont pas au bon niveau dans l'objet retourn√©. | Restructurer tous les retours pour suivre le pattern `{success: true, data: {...}, message}` comme dans le mod√®le cr√©ation. |
| **BUG #3** : Helper jsonResponse() custom | ‚Ä¢ `gestion-reseau-admin/index.ts` (lignes 22-30)<br>‚Ä¢ `gestion-reseau-admin-donnees/index.ts` (lignes 22-30)<br>‚Ä¢ `gestion-reseau-admin-update/index.ts` (lignes 22-30)<br>‚Ä¢ `gestion-reseau-admin-fichiers/index.ts` (lignes 22-30) | Utilisation d'un helper custom `jsonResponse()` qui ne garantit pas le respect du pattern `data.data` et utilise `ok` au lieu de `success`. | üîß **Incoh√©rence architecturale** : Ne suit pas les standards du mod√®le cr√©ation, complexit√© inutile. | Supprimer le helper `jsonResponse()` et utiliser directement `new Response(JSON.stringify({...}), {headers})` comme dans le mod√®le cr√©ation. |

---
## üìä TABLEAU R√âCAPITULATIF DES BUGS/SOLUTIONS PAR CHATGPT | NEW IA - FUTUR Chat N9

| Probl√®me                              | Emplacement / Fichier                      | Explication du probl√®me                                                                 | Solution propos√©e                                                                 |
|---------------------------------------|---------------------------------------------|-----------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| S√©lecteur vide                        | `useReseauFormData.ts` + `gestion-reseau-admin/index.ts` | Les appels frontend √† l‚ÄôEdge Function se font sans injection du Service Role Key, donc rejet√©s (401). | Passer par un proxy backend ou Lovable Edge qui injecte la cl√© c√¥t√© serveur.      |
| Incoh√©rence `reseauId` vs `reseau_id` | Hooks (`useReseauFormData`, `FormReseauGestion`) | Parfois `reseauId`, parfois `reseau_id` ‚Üí incoh√©rence qui peut bloquer certains appels. | Standardiser sur `reseau_id` dans tous les appels et EF.                          |
| Mismatch retour EF vs Front           | `gestion-reseau-admin-update` + `useReseauIntegrations` | L‚ÄôEF renvoie `{ updated }` alors que le hook attend `updatedData` ‚Üí donn√©es int√©grations non mises √† jour. | Harmoniser : soit changer EF pour renvoyer `updatedData`, soit adapter le hook.  |
| Absence de feedback visuel clair      | `ReseauSelector.tsx`                        | Si aucun r√©seau trouv√© ou appel bloqu√©, le dropdown est vide sans message explicite.    | Ajouter un message clair (‚ÄúAucun r√©seau disponible / Erreur de chargement‚Äù).      |
| Risque de fichiers orphelins          | `gestion-reseau-admin-fichiers`             | Si upload OK mais update DB √©choue, le fichier reste dans le bucket sans lien DB.       | Ajouter rollback syst√©matique (supprimer fichier si update DB √©choue).            |

---
## üìä TABLEAU R√âCAPITULATIF DES BUGS/SOLUTIONS PAR CHATGPT | OLD IA - Chat N8

| üö® Probl√®me                        | üìÇ Emplacement / Fichier                               | üîç Nature du probl√®me                                                                                      | ‚úÖ Solution propos√©e                                                                                  |
|------------------------------------|--------------------------------------------------------|------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|
| V√©rification `SERVICE_ROLE_KEY`    | Toutes les Edge Functions de gestion (`gestion-reseau-admin`, `-donnees`, `-update`, `-fichiers`) | Les EF exigent que **le frontend envoie la cl√© admin** ‚Üí impossible car c√¥t√© client on n‚Äôa que l‚ÄôANON_KEY. | Supprimer `assertServiceRoleAuth()` et ne pas attendre SERVICE_ROLE_KEY du frontend.                 |
| Contradiction strat√©gie Service Key | Strat√©gie SERVICE_ROLE_KEY vs impl√©mentation actuelle  | Strat√©gie = cl√© admin **interne aux EF** ; impl√©mentation = EF attend la cl√© du client.                    | Harmoniser : EF utilisent **leur propre cl√© admin interne** (comme dans `create-reseau-admin`).      |
| Diff√©rence cr√©ation / gestion       | EF `create-reseau-admin` vs EF gestion                 | Cr√©ation marche car elle **ne v√©rifie pas le token client** ; gestion √©choue car elle impose la cl√© admin. | Uniformiser les EF de gestion sur le m√™me mod√®le que l‚ÄôEF de cr√©ation (proxy s√©curis√©).              |
| S√©lecteur r√©seau vide               | `useReseauFormData.ts` + EF `gestion-reseau-admin`     | Le hook appelle l‚ÄôEF mais re√ßoit 401 unauthorized ‚Üí la liste reste vide.                                   | Corriger l‚Äôauth EF ‚Üí le hook chargera correctement les r√©seaux.                                      |
| Upload fichiers                     | EF `gestion-reseau-admin-fichiers` + bucket Supabase   | Structure correcte (`reseau-{uuid}/...`), mais bloqu√©e par auth.                                           | Corriger auth EF ‚Üí upload fonctionnera comme pr√©vu.                                                  |
| Synchronisation reseau ‚Üí direction  | Trigger SQL `sync_reseau_to_direction()`               | D√©j√† corrig√©e (champs pr√©fix√©s `reseau_direction_*`). Pas un probl√®me, mais confirm√© comme valid√©.          | Rien √† changer. Maintenir la synchro SQL telle qu‚Äôactuellement en place.                             |

---



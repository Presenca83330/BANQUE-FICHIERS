
# üìå FormReseauGestion ‚Äì Projet d'implantation 
Ce document centralise **tous les fichiers** li√©s au formulaire de gestion r√©seau.  
Il est con√ßu pour √™tre int√©gr√© directement dans **Lovable** par copier/coller.
Voici la version corrig√© du mercredi 24 septembre

---

### Emplacements futurs imp√©ratifs
- Hook Principal : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauFormData.ts
- Hook Int√©grations : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations.ts
- Types types.ts : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/types.ts
- Page Principale : src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/1.Reseau/3.FormReseauGestion.tsx
- Composant Selector : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/components/ReseauSelector.tsx
- Edge Function Update : supabase/functions/update-reseau/index.ts
- Edge Function Upload : supabase/functions/upload-reseau-files/index.ts
- Migration Storage migration-storage-buckets.sql

---


## 1. Hooks

### üìÑ src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/types.ts

```typescript
// Types partag√©s pour la gestion des r√©seaux

// ==============================
// Donn√©es du R√©seau
// ==============================
export interface ReseauFormData {
  reseau_id: string;
  organisation_id: string;
  reseau_nom: string;
  reseau_identite_commerciale?: string | null;
  reseau_adresse?: string | null;
  reseau_code_postal?: string | null;
  reseau_ville?: string | null;
  reseau_siret?: string | null;
  reseau_statut?: string | null;
  reseau_logo?: string | null;
  reseau_ressources?: string[]; // fichiers stock√©s
  reseau_telephone?: string | null; // Point de v√©rit√©
  reseau_email?: string | null;     // Point de v√©rit√©
  reseau_brevo_connexion_id?: string | null;
  reseau_zoho_connexion_id?: string | null;
  reseau_openai_connexion_id?: string | null;
}

// ==============================
// El√©ments pour le s√©lecteur
// ==============================
export interface ReseauSelectorItem {
  reseau_id: string;
  reseau_nom: string;
  reseau_statut: string;
  organisation_id: string;
}

// ==============================
// Int√©grations - Tables connexions
// ==============================
export interface BrevoIntegration {
  brevo_connexion_id: string;
  organisation_id: string;
  reseau_id: string;
  brevo_api_key?: string | null;
  brevo_email_compte?: string | null;
  brevo_nom_compte?: string | null;
}

export interface ZohoIntegration {
  zoho_connexion_id: string;
  organisation_id: string;
  reseau_id: string;
  zoho_api_key?: string | null;
  zoho_email_compte?: string | null;
  zoho_nom_compte?: string | null;
}

export interface OpenAIIntegration {
  openai_connexion_id: string;
  organisation_id: string;
  reseau_id: string;
  openai_api_key?: string | null;
  openai_email_compte?: string | null;
}

// ==============================
// Etats du formulaire (Front) - UI UNIQUEMENT
// ==============================
export interface BrevoFormState {
  brevo_api_key?: string;
  brevo_email_compte?: string;
  brevo_nom_compte?: string;
}

export interface ZohoFormState {
  zoho_api_key?: string;
  zoho_email_compte?: string;
  zoho_nom_compte?: string;
}

export interface OpenAIFormState {
  openai_api_key?: string;
  openai_email_compte?: string;
}

export interface IntegrationsState {
  brevo: BrevoFormState;
  zoho: ZohoFormState;
  openai: OpenAIFormState;
}

// ==============================
// Erreurs de validation
// ==============================
export type ValidationErrors = {
  [K in keyof Partial<ReseauFormData>]?: string;
};
```
---
### üìÑ src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauFormData.ts

```typescript
import { useState, useCallback } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import type { ReseauFormData, ReseauSelectorItem, ValidationErrors } from './types';

export function useReseauFormData() {
  const [reseaux, setReseaux] = useState<ReseauSelectorItem[]>([]);
  const [selectedReseauId, setSelectedReseauId] = useState<string>('');
  const [formData, setFormData] = useState<Partial<ReseauFormData>>({});
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [errors, setErrors] = useState<ValidationErrors>({});
  const { toast } = useToast();

  /**
   * Charger la liste des r√©seaux disponibles (s√©lecteur dropdown)
   */
  const loadReseaux = useCallback(async () => {
    setIsLoading(true);
    try {
      const { data, error } = await supabase
        .from('reseau')
        .select('reseau_id, reseau_nom, reseau_statut, organisation_id')
        .order('reseau_nom');

      if (error) throw error;
      setReseaux(data || []);
    } catch {
      toast({
        title: 'Erreur',
        description: 'Impossible de charger les r√©seaux',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  }, [toast]);

  /**
   * Charger les donn√©es compl√®tes d‚Äôun r√©seau s√©lectionn√©
   */
  const loadReseauData = useCallback(
    async (reseauId: string) => {
      if (!reseauId) return;
      setIsLoading(true);
      try {
        const { data: reseau, error } = await supabase
          .from('reseau')
          .select(
            `
            reseau_id,
            reseau_nom,
            reseau_identite_commerciale,
            reseau_adresse,
            reseau_code_postal,
            reseau_ville,
            reseau_siret,
            reseau_statut,
            reseau_logo,
            reseau_ressources,
            reseau_brevo_connexion_id,
            reseau_zoho_connexion_id,
            reseau_openai_connexion_id,
            reseau_telephone,
            reseau_email,
            organisation_id
          `
          )
          .eq('reseau_id', reseauId)
          .maybeSingle();

        if (error) throw error;
        if (!reseau) {
          setFormData({});
          toast({
            title: 'Introuvable',
            description: 'R√©seau introuvable',
            variant: 'destructive',
          });
          return;
        }

        setFormData(reseau);
        setErrors({});
      } catch {
        toast({
          title: 'Erreur',
          description: 'Impossible de charger les donn√©es du r√©seau',
          variant: 'destructive',
        });
      } finally {
        setIsLoading(false);
      }
    },
    [toast]
  );

  /**
   * Validation c√¥t√© frontend avant sauvegarde
   * ‚ö†Ô∏è Dans le formulaire de gestion ‚Üí uniquement des validations de forme.
   * (Les champs √©taient obligatoires uniquement lors de la cr√©ation.)
   */
  const validateForm = useCallback(
    (data: Partial<ReseauFormData>): ValidationErrors => {
      const newErrors: ValidationErrors = {};

      if (data.reseau_code_postal && !/^\d{5}$/.test(data.reseau_code_postal)) {
        newErrors.reseau_code_postal =
          'Le code postal doit contenir 5 chiffres';
      }

      if (data.reseau_siret && !/^\d{14}$/.test(data.reseau_siret.replace(/\s/g, ''))) {
        newErrors.reseau_siret = 'Le SIRET doit contenir 14 chiffres';
      }

      return newErrors;
    },
    []
  );

  /**
   * Sauvegarder les donn√©es d‚Äôun r√©seau (appel Edge Function update-reseau)
   */
  const saveReseau = useCallback(
    async (dataToSave: Partial<ReseauFormData>) => {
      if (!selectedReseauId) return false;

      const validationErrors = validateForm(dataToSave);
      setErrors(validationErrors);
      if (Object.keys(validationErrors).length > 0) {
        toast({
          title: 'Erreurs de validation',
          description: 'Veuillez corriger les erreurs',
          variant: 'destructive',
        });
        return false;
      }

      setIsSaving(true);
      try {
        const { error } = await supabase.functions.invoke('update-reseau', {
          body: JSON.stringify({
            reseauId: selectedReseauId,
            generalData: dataToSave,
          }),
        });
        if (error) throw error;

        toast({
          title: 'Succ√®s',
          description: 'R√©seau mis √† jour avec succ√®s',
        });
        await loadReseauData(selectedReseauId);
        return true;
      } catch {
        toast({
          title: 'Erreur',
          description: 'Impossible de sauvegarder les modifications',
          variant: 'destructive',
        });
        return false;
      } finally {
        setIsSaving(false);
      }
    },
    [selectedReseauId, validateForm, toast, loadReseauData]
  );

  /**
   * Mise √† jour d‚Äôun champ dans l‚Äô√©tat local
   */
  const updateFormField = useCallback(
    (field: keyof ReseauFormData | string, value: any) => {
      setFormData((prev) => ({ ...prev, [field]: value }));
      if (errors[field]) {
        setErrors((prev) => {
          const e = { ...prev };
          delete e[field];
          return e;
        });
      }
    },
    [errors]
  );

  /**
   * S√©lection d‚Äôun r√©seau dans le dropdown
   */
  const selectReseau = useCallback(
    (reseauId: string) => {
      setSelectedReseauId(reseauId);
      if (reseauId) {
        loadReseauData(reseauId);
      } else {
        setFormData({});
        setErrors({});
      }
    },
    [loadReseauData]
  );

  return {
    reseaux,
    selectedReseauId,
    formData,
    isLoading,
    isSaving,
    errors,
    loadReseaux,
    selectReseau,
    updateFormField,
    saveReseau,
    validateForm,
    loadReseauData,
  };
}

```

### üìÑ src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations.ts

```typescript
// üìÑ src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations.ts

import { useCallback, useState } from 'react';
import { useToast } from '@/hooks/use-toast';
import { getTableName } from '@/components/HOOKS-STRATEGIQUE/4.HOOK-useSupabaseOperations/tableMapping';
import { useSupabaseOperations } from '@/components/HOOKS-STRATEGIQUE/4.HOOK-useSupabaseOperations/useSupabaseOperations';
import { supabase } from '@/integrations/supabase/client';
import type { BrevoFormState, ZohoFormState, OpenAIFormState } from './types';

export function useReseauIntegrations() {
  const { toast } = useToast();
  const supaOps = useSupabaseOperations();

  // ‚úÖ organisation_id s√©par√©
  const [organisationId, setOrganisationId] = useState<string | null>(null);

  // ‚úÖ √âtats UI (formulaire uniquement)
  const [brevo, setBrevo] = useState<BrevoFormState>({});
  const [zoho, setZoho] = useState<ZohoFormState>({});
  const [openai, setOpenAI] = useState<OpenAIFormState>({});

  // ‚úÖ IDs techniques s√©par√©s
  const [brevoConnexionId, setBrevoConnexionId] = useState<string | null>(null);
  const [zohoConnexionId, setZohoConnexionId] = useState<string | null>(null);
  const [openaiConnexionId, setOpenaiConnexionId] = useState<string | null>(null);

  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  // ================================
  // Charger les int√©grations d'un r√©seau
  // ================================
  const loadForReseau = useCallback(async (reseauId: string) => {
    if (!reseauId) return;
    setIsLoading(true);

    try {
      // Charger le r√©seau via direct supabase car on a besoin de colonnes sp√©cifiques
      const { data: reseau, error } = await supabase
        .from(getTableName('reseau'))
        .select(`
          organisation_id,
          reseau_brevo_connexion_id,
          reseau_zoho_connexion_id,
          reseau_openai_connexion_id
        `)
        .eq('reseau_id', reseauId)
        .maybeSingle();

      if (error) throw error;
      if (!reseau) {
        setOrganisationId(null);
        setBrevo({});
        setZoho({});
        setOpenAI({});
        setBrevoConnexionId(null);
        setZohoConnexionId(null);
        setOpenaiConnexionId(null);
        toast({ title: 'Introuvable', description: 'R√©seau introuvable', variant: 'destructive' });
        return;
      }

      setOrganisationId(reseau.organisation_id);

      // Reset √©tats
      setBrevo({});
      setZoho({});
      setOpenAI({});
      setBrevoConnexionId(null);
      setZohoConnexionId(null);
      setOpenaiConnexionId(null);

      // Charger Brevo
      if (reseau.reseau_brevo_connexion_id) {
        setBrevoConnexionId(reseau.reseau_brevo_connexion_id);
        const result = await supaOps.select('brevo_connexion', { brevo_connexion_id: reseau.reseau_brevo_connexion_id });
        if (result.ok && result.data?.[0]) {
          const b = result.data[0];
          setBrevo({
            brevo_api_key: b.brevo_api_key ?? undefined,
            brevo_email_compte: b.brevo_email_compte ?? undefined,
            brevo_nom_compte: b.brevo_nom_compte ?? undefined,
          });
        }
      }

      // Charger Zoho
      if (reseau.reseau_zoho_connexion_id) {
        setZohoConnexionId(reseau.reseau_zoho_connexion_id);
        const result = await supaOps.select('zoho_connexion', { zoho_connexion_id: reseau.reseau_zoho_connexion_id });
        if (result.ok && result.data?.[0]) {
          const z = result.data[0];
          setZoho({
            zoho_api_key: z.zoho_api_key ?? undefined,
            zoho_email_compte: z.zoho_email_compte ?? undefined,
            zoho_nom_compte: z.zoho_nom_compte ?? undefined,
          });
        }
      }

      // Charger OpenAI
      if (reseau.reseau_openai_connexion_id) {
        setOpenaiConnexionId(reseau.reseau_openai_connexion_id);
        const result = await supaOps.select('openai_connexion', { openai_connexion_id: reseau.reseau_openai_connexion_id });
        if (result.ok && result.data?.[0]) {
          const o = result.data[0];
          setOpenAI({
            openai_api_key: o.openai_api_key ?? undefined,
            openai_email_compte: o.openai_email_compte ?? undefined,
          });
        }
      }
    } catch (e: any) {
      console.error('Erreur loadForReseau', e);
      toast({ title: 'Erreur', description: e?.message || 'Impossible de charger les int√©grations', variant: 'destructive' });
    } finally {
      setIsLoading(false);
    }
  }, [supaOps, toast]);

  // ================================
  // Sauvegarde d'une int√©gration (factoris√©)
  // ================================
  const saveIntegration = useCallback(
    async (reseauId: string, kind: 'brevo' | 'zoho' | 'openai') => {
      if (!reseauId) return false;
      if (!organisationId) {
        toast({ title: 'Erreur', description: 'organisation_id introuvable', variant: 'destructive' });
        return false;
      }
      setIsSaving(true);

      try {
        let tableName: string, state: any, connexionId: string | null, setConnexionIdFn: (id: string | null) => void, fkField: string, idField: string;

        switch (kind) {
          case 'brevo':
            tableName = 'brevo_connexion';
            state = brevo;
            connexionId = brevoConnexionId;
            setConnexionIdFn = setBrevoConnexionId;
            fkField = 'reseau_brevo_connexion_id';
            idField = 'brevo_connexion_id';
            break;
          case 'zoho':
            tableName = 'zoho_connexion';
            state = zoho;
            connexionId = zohoConnexionId;
            setConnexionIdFn = setZohoConnexionId;
            fkField = 'reseau_zoho_connexion_id';
            idField = 'zoho_connexion_id';
            break;
          case 'openai':
            tableName = 'openai_connexion';
            state = openai;
            connexionId = openaiConnexionId;
            setConnexionIdFn = setOpenaiConnexionId;
            fkField = 'reseau_openai_connexion_id';
            idField = 'openai_connexion_id';
            break;
        }

        if (connexionId) {
          // Update existante
          const result = await supaOps.update(tableName, idField, connexionId, state);
          if (!result.ok) throw new Error(result.message);
        } else {
          // Insert nouvelle
          const payload = {
            ...state,
            reseau_id: reseauId,
            // organisation_id sera automatiquement ajout√© par useSupabaseOperations
          };
          
          const result = await supaOps.insert(tableName, payload);
          if (!result.ok) throw new Error(result.message);
          
          const insertedId = result.data?.[0]?.[idField];
          if (insertedId) {
            // Mettre √† jour la FK dans reseau via direct supabase
            await supabase
              .from(getTableName('reseau'))
              .update({ [fkField]: insertedId })
              .eq('reseau_id', reseauId);

            // Mettre √† jour l'ID technique
            setConnexionIdFn(insertedId);
          }
        }

        toast({ title: 'Succ√®s', description: `Int√©gration ${kind} mise √† jour avec succ√®s` });
        return true;
      } catch (e: any) {
        console.error(`Erreur saveIntegration ${kind}`, e);
        toast({ title: 'Erreur', description: e?.message || "Impossible de sauvegarder l'int√©gration", variant: 'destructive' });
        return false;
      } finally {
        setIsSaving(false);
      }
    },
    [organisationId, brevo, zoho, openai, brevoConnexionId, zohoConnexionId, openaiConnexionId, supaOps, toast]
  );

  return {
    organisationId,
    // √âtats UI
    brevo, setBrevo,
    zoho, setZoho,
    openai, setOpenAI,
    // IDs techniques
    brevoConnexionId,
    zohoConnexionId,
    openaiConnexionId,
    // Meta
    isLoading,
    isSaving,
    // Actions
    loadForReseau,
    saveIntegration,
  };
}
```
---

## 2. Composants

### üìÑ src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/components/ReseauSelector.tsx

```typescript
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import type { ReseauSelectorItem } from '../hooks/types';

interface ReseauSelectorProps {
  reseaux: ReseauSelectorItem[];
  selectedReseauId: string;
  onSelect: (reseauId: string) => void;
  isLoading: boolean;
}

export const ReseauSelector: React.FC<ReseauSelectorProps> = ({
  reseaux,
  selectedReseauId,
  onSelect,
  isLoading,
}) => {
  return (
    <Card className="mb-6">
      <CardHeader>
        <CardTitle className="text-xl font-semibold">S√©lection du R√©seau</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          <Select
            value={selectedReseauId}
            onValueChange={onSelect}
            disabled={isLoading}
          >
            <SelectTrigger className="w-full">
              <SelectValue 
                placeholder={
                  isLoading ? "Chargement des r√©seaux..." : 
                  "S√©lectionner un r√©seau"
                } 
              />
            </SelectTrigger>
            <SelectContent>
              {reseaux?.map((reseau) => (
                <SelectItem key={reseau.reseau_id} value={reseau.reseau_id}>
                  {reseau.reseau_nom}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </CardContent>
    </Card>
  );
};

export default ReseauSelector;

```

### üìÑ src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/5-Graphisme/1.GraphFormulaires/5.GraphBoutonModifier.tsx

```typescript
Ce document est d√©j√† en place
src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/5-Graphisme/1.GraphFormulaires/5.GraphBoutonModifier.tsx
```

### üìÑ src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/3-Utilitaires/tabs.tsx

```typescript
Ce document est d√©j√† en place
src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/3-Utilitaires/tabs.tsx
Il permet de cr√©er les onglets de couleur
```

---

## 3. Page Principale

üìÑ `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/1.Reseau/3.FormReseauGestion.tsx

```typescript
import React, { useEffect, useRef, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "../../3-Utilitaires/tabs";
import { Upload, Download, Trash2, Eye } from 'lucide-react';
import GraphBoutonModifier from '../../5-Graphisme/1.GraphFormulaires/5.GraphBoutonModifier';
import { ReseauSelector } from '@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/components/ReseauSelector';
import { useReseauFormData } from '@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauFormData';
import { useReseauIntegrations } from '@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

interface Props {
  onBack?: () => void;
}

const FormReseauGestion: React.FC<Props> = ({ onBack }) => {
  const { toast } = useToast();

const {
  brevo, setBrevo,
  zoho, setZoho,
  openai, setOpenAI,
  brevoConnexionId,
  zohoConnexionId,
  openaiConnexionId,
  isLoading: integLoading,
  isSaving: integSaving,
  loadForReseau,
  saveIntegration,
} = useReseauIntegrations();

  const {
  brevo,                  
  zoho,                    
  openai,                 
  isLoading: integLoading,
  isSaving: integSaving,
  loadForReseau,
  setBrevo,
  setZoho,
  setOpenAI,
  saveIntegration,
} = useReseauIntegrations();


  const [isEditingGeneral, setIsEditingGeneral] = useState(false);
  const [isEditingBrevo, setIsEditingBrevo] = useState(false);
  const [isEditingZoho, setIsEditingZoho] = useState(false);
  const [isEditingOpenAI, setIsEditingOpenAI] = useState(false);
  const [isEditingFichiers, setIsEditingFichiers] = useState(false);

  const logoInputRef = useRef<HTMLInputElement | null>(null);
  const docsInputRef = useRef<HTMLInputElement | null>(null);
  const [selectedLogo, setSelectedLogo] = useState<File | null>(null);
  const [selectedDocs, setSelectedDocs] = useState<File[]>([]);

  useEffect(() => { loadReseaux(); }, [loadReseaux]);
  useEffect(() => { if (selectedReseauId) loadForReseau(selectedReseauId); }, [selectedReseauId, loadForReseau]);

  const handleSaveGeneral = async () => {
    if (!selectedReseauId) return;
    const success = await saveReseau({
      reseau_nom: formData.reseau_nom,
      reseau_identite_commerciale: formData.reseau_identite_commerciale,
      reseau_adresse: formData.reseau_adresse,
      reseau_code_postal: formData.reseau_code_postal,
      reseau_ville: formData.reseau_ville,
      reseau_siret: formData.reseau_siret,
      reseau_telephone: formData.reseau_telephone,
      reseau_email: formData.reseau_email,
    });
    if (success) setIsEditingGeneral(false);
  };

  const handleSaveBrevo = async () => { if (!selectedReseauId) return; const ok = await saveIntegration(selectedReseauId, 'brevo'); if (ok) setIsEditingBrevo(false); };
  const handleSaveZoho = async () => { if (!selectedReseauId) return; const ok = await saveIntegration(selectedReseauId, 'zoho'); if (ok) setIsEditingZoho(false); };
  const handleSaveOpenAI = async () => { if (!selectedReseauId) return; const ok = await saveIntegration(selectedReseauId, 'openai'); if (ok) setIsEditingOpenAI(false); };

  const reloadAll = async () => {
    if (selectedReseauId) {
      await loadReseauData(selectedReseauId);
      await loadForReseau(selectedReseauId);
      setSelectedLogo(null);
      setSelectedDocs([]);
    }
  };

  const uploadFile = async (type: 'logo' | 'document', file: File, reseauId: string) => {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('type', type);
    fd.append('reseauId', reseauId);
    const { data, error } = await supabase.functions.invoke('upload-reseau-files', { body: fd });
    if (error) throw error;
    return (data as any)?.filePath as string; // ‚Üê corrig√© (filePath)
  };

  const handleSaveLogo = async () => {
    if (!selectedReseauId || !selectedLogo) { setIsEditingFichiers(false); return; }
    try {
      const path = await uploadFile('logo', selectedLogo, selectedReseauId);
      await supabase.functions.invoke('update-reseau', {
        body: JSON.stringify({ reseauId: selectedReseauId, generalData: { reseau_logo: path } }),
      });
      toast({ title: 'Succ√®s', description: 'Logo mis √† jour' });
      await reloadAll();
      setIsEditingFichiers(false);
    } catch {
      toast({ title: 'Erreur', description: "Impossible d'uploader le logo", variant: 'destructive' });
    }
  };

  const handleSaveDocuments = async () => {
    if (!selectedReseauId) { setIsEditingFichiers(false); return; }
    try {
      const paths: string[] = [];
      for (const f of selectedDocs) {
        paths.push(await uploadFile('document', f, selectedReseauId));
      }
      const next = Array.isArray(formData.reseau_ressources) ? [...formData.reseau_ressources, ...paths] : paths;
      await supabase.functions.invoke('update-reseau', {
        body: JSON.stringify({ reseauId: selectedReseauId, generalData: { reseau_ressources: next } }),
      });
      toast({ title: 'Succ√®s', description: 'Documents mis √† jour' });
      await reloadAll();
      setIsEditingFichiers(false);
    } catch {
      toast({ title: 'Erreur', description: "Impossible d'uploader les documents", variant: 'destructive' });
    }
  };

  const removeStoragePath = async (path: string) => {
    await supabase.storage.from('bucket-table-reseau').remove([path]);
  };

  const handleDeleteLogo = async () => {
    if (!selectedReseauId || !formData.reseau_logo) return;
    try {
      await removeStoragePath(formData.reseau_logo);
      await supabase.functions.invoke('update-reseau', {
        body: JSON.stringify({ reseauId: selectedReseauId, generalData: { reseau_logo: null } }),
      });
      toast({ title: 'Succ√®s', description: 'Logo supprim√©' });
      await reloadAll();
    } catch {
      toast({ title: 'Erreur', description: 'Suppression logo impossible', variant: 'destructive' });
    }
  };

  const handleDeleteDocument = async (docPath: string) => {
    if (!selectedReseauId) return;
    try {
      await removeStoragePath(docPath);
      const remaining = (formData.reseau_ressources || []).filter(p => p !== docPath);
      await supabase.functions.invoke('update-reseau', {
        body: JSON.stringify({ reseauId: selectedReseauId, generalData: { reseau_ressources: remaining } }),
      });
      toast({ title: 'Succ√®s', description: 'Document supprim√©' });
      await reloadAll();
    } catch {
      toast({ title: 'Erreur', description: 'Suppression document impossible', variant: 'destructive' });
    }
  };

  const handleSubmit = async (e: React.FormEvent) => { e.preventDefault(); };

  return (
    <div className="space-y-6">
      <ReseauSelector
        reseaux={reseaux}
        selectedReseauId={selectedReseauId}
        onSelect={selectReseau}
        isLoading={isLoading}
      />

      <Tabs defaultValue="general" className="w-full">
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="general" className="text-base font-semibold">G√©n√©ral</TabsTrigger>
          <TabsTrigger value="integrations" className="text-base font-semibold">Int√©grations</TabsTrigger>
          <TabsTrigger value="fichiers" className="text-base font-semibold">Fichiers</TabsTrigger>
        </TabsList>

        <form onSubmit={handleSubmit}>
          {/* ‚úÖ Informations G√©n√©rales */}
          <TabsContent value="general" className="space-y-6">
            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold">Informations G√©n√©rales</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveGeneral}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingGeneral}
                    isLoading={isSaving}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="reseau_nom">Nom du R√©seau</Label>
                      <Input
                        id="reseau_nom"
                        value={formData.reseau_nom || ''}
                        onChange={e => updateFormField('reseau_nom', e.target.value)}
                        placeholder="Nom du R√©seau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_identite_commerciale">Identit√© Commerciale du R√©seau</Label>
                      <Input
                        id="reseau_identite_commerciale"
                        value={formData.reseau_identite_commerciale || ''}
                        onChange={e => updateFormField('reseau_identite_commerciale', e.target.value)}
                        placeholder="Optionnel. Si Nom Commercial diff√©rent"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_adresse">Adresse</Label>
                      <Input
                        id="reseau_adresse"
                        value={formData.reseau_adresse || ''}
                        onChange={e => updateFormField('reseau_adresse', e.target.value)}
                        placeholder="Adresse. Si√®ge R√©seau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_code_postal">Code Postal</Label>
                      <Input
                        id="reseau_code_postal"
                        value={formData.reseau_code_postal || ''}
                        onChange={e => updateFormField('reseau_code_postal', e.target.value)}
                        placeholder="Code Postal. Si√®ge R√©seau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                  </div>
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="reseau_ville">Ville</Label>
                      <Input
                        id="reseau_ville"
                        value={formData.reseau_ville || ''}
                        onChange={e => updateFormField('reseau_ville', e.target.value)}
                        placeholder="Ville. Si√®ge R√©seau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_siret">Siret</Label>
                      <Input
                        id="reseau_siret"
                        value={formData.reseau_siret || ''}
                        onChange={e => updateFormField('reseau_siret', e.target.value)}
                        placeholder="N¬∞ Siret du R√©seau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_telephone">T√©l√©phone Direction</Label>
                      <Input
                        id="reseau_telephone"
                        value={formData.reseau_telephone || ''}
                        onChange={e => updateFormField('reseau_telephone', e.target.value)}
                        placeholder="T√©l. Reseau Direction"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_email">Email Direction</Label>
                      <Input
                        id="reseau_email"
                        type="email"
                        value={formData.reseau_email || ''}
                        onChange={e => updateFormField('reseau_email', e.target.value)}
                        placeholder="Email. Reseau Direction"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* ‚úÖ Int√©grations */}
          <TabsContent value="integrations" className="space-y-6">
            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold flex items-center gap-2">Int√©gration Brevo</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveBrevo}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingBrevo}
                    isLoading={integSaving}
                  />
                </div>
                            </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="brevo_api_key">Cl√© API Brevo</Label>
                    <Input
                      id="brevo_api_key"
                      type="password"
                      placeholder="Renseigner. N¬∞ Cl√© API"
                      value={brevo.brevo_api_key || ''}
                      onChange={e => setBrevo({ ...brevo, brevo_api_key: e.target.value })}
                      disabled={!isEditingBrevo}
                    />
                  </div>
                  <div>
                    <Label htmlFor="brevo_email_compte">Email Compte Brevo</Label>
                    <Input
                      id="brevo_email_compte"
                      type="email"
                      placeholder="Renseigner. Email associ√© compte Brevo"
                      value={brevo.brevo_email_compte || ''}
                      onChange={e => setBrevo({ ...brevo, brevo_email_compte: e.target.value })}
                      disabled={!isEditingBrevo}
                    />
                  </div>
                  <div>
                    <Label htmlFor="brevo_nom_compte">Nom Compte Brevo</Label>
                    <Input
                      id="brevo_nom_compte"
                      placeholder="Renseigner. Nom compte Brevo"
                      value={brevo.brevo_nom_compte || ''}
                      onChange={e => setBrevo({ ...brevo, brevo_nom_compte: e.target.value })}
                      disabled={!isEditingBrevo}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold flex items-center gap-2">Int√©gration Zoho</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveZoho}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingZoho}
                    isLoading={integSaving}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="zoho_api_key">Cl√© API Zoho</Label>
                    <Input
                      id="zoho_api_key"
                      type="password"
                      placeholder="Renseigner. Cl√© API Zoho"
                      value={zoho.zoho_api_key || ''}
                      onChange={e => setZoho({ ...zoho, zoho_api_key: e.target.value })}
                      disabled={!isEditingZoho}
                    />
                  </div>
                  <div>
                    <Label htmlFor="zoho_email_compte">Email Compte Zoho</Label>
                    <Input
                      id="zoho_email_compte"
                      type="email"
                      placeholder="Renseigner. Email associ√© compte Zoho"
                      value={zoho.zoho_email_compte || ''}
                      onChange={e => setZoho({ ...zoho, zoho_email_compte: e.target.value })}
                      disabled={!isEditingZoho}
                    />
                  </div>
                  <div>
                    <Label htmlFor="zoho_nom_compte">Nom Compte Zoho</Label>
                    <Input
                      id="zoho_nom_compte"
                      placeholder="Renseigner. Nom compte Zoho"
                      value={zoho.zoho_nom_compte || ''}
                      onChange={e => setZoho({ ...zoho, zoho_nom_compte: e.target.value })}
                      disabled={!isEditingZoho}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold flex items-center gap-2">Int√©gration OpenAI</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveOpenAI}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingOpenAI}
                    isLoading={integSaving}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="openai_api_key">Cl√© API OpenAI</Label>
                    <Input
                      id="openai_api_key"
                      type="password"
                      placeholder="Renseigner. Cl√© API OpenAI"
                      value={openai.openai_api_key || ''}
                      onChange={e => setOpenAI({ ...openai, openai_api_key: e.target.value })}
                      disabled={!isEditingOpenAI}
                    />
                  </div>
                  <div>
                    <Label htmlFor="openai_email_compte">Email Compte OpenAI</Label>
                    <Input
                      id="openai_email_compte"
                      type="email"
                      placeholder="Renseigner. Email associ√© compte OpenAI"
                      value={openai.openai_email_compte || ''}
                      onChange={e => setOpenAI({ ...openai, openai_email_compte: e.target.value })}
                      disabled={!isEditingOpenAI}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>


          {/* ‚úÖ Fichiers */}
          <TabsContent value="fichiers" className="space-y-6">
            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold">
                    Logo du R√©seau
                  </CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveLogo}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingFichiers}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="reseau_logo_upload">T√©l√©charger le Logo du R√©seau</Label>
                    <div
                      className="border-2 border-dashed border-muted-foreground/25 rounded-lg p-6 text-center cursor-pointer"
                      onClick={() => isEditingFichiers && logoInputRef.current?.click()}
                    >
                      <div className="space-y-2">
                        <div className="mx-auto w-12 h-12 text-muted-foreground">
                          <Upload className="h-6 w-6" />
                        </div>
                        <div>
                          <p className="text-sm">Cliquer pour s√©lectionner le logo</p>
                          <p className="text-xs text-muted-foreground">PNG, JPG, SVG - Max 2MB</p>
                        </div>
                      </div>
                    </div>
                    <input
                      ref={logoInputRef}
                      id="reseau_logo_upload"
                      type="file"
                      accept="image/*"
                      hidden
                      disabled={!isEditingFichiers}
                      onChange={e => setSelectedLogo(e.target.files?.[0] || null)}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Logo actuel</Label>
                    <div className="border rounded-lg p-4 bg-muted/20">
                      {formData.reseau_logo ? (
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-16 h-16 border rounded bg-white flex items-center justify-center">
                              <Upload className="h-5 w-5 text-muted-foreground" />
                            </div>
                            <div>
                              <p className="font-medium break-all">{formData.reseau_logo}</p>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              type="button"
                              variant="destructive"
                              size="sm"
                              onClick={handleDeleteLogo}
                              disabled={!isEditingFichiers}
                            >
                              Supprimer
                            </Button>
                          </div>
                        </div>
                      ) : (
                        <span className="text-muted-foreground text-sm">Aucun logo upload√©</span>
                      )}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold">
                    Documents Institutionnels
                  </CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveDocuments}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingFichiers}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="space-y-2">
                    <Label>T√©l√©charger les documents</Label>
                    <div
                      className="border-2 border-dashed border-muted-foreground/25 rounded-lg p-6 text-center cursor-pointer"
                      onClick={() => isEditingFichiers && docsInputRef.current?.click()}
                    >
                      <div className="space-y-2">
                        <div className="mx-auto w-12 h-12 text-muted-foreground">
                          <Download className="h-6 w-6" />
                        </div>
                        <div>
                          <p className="text-sm">Cliquer pour s√©lectionner les documents</p>
                          <p className="text-xs text-muted-foreground">PDF, DOC, DOCX - Max 10MB par fichier</p>
                        </div>
                      </div>
                    </div>
                    <input
                      ref={docsInputRef}
                      type="file"
                      multiple
                      accept=".pdf,.doc,.docx,.xls,.xlsx"
                      hidden
                      disabled={!isEditingFichiers}
                      onChange={e => setSelectedDocs(e.target.files ? Array.from(e.target.files) : [])}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Supprimer un fichier existant</Label>
                    <div className="border rounded-lg p-4 bg-muted/20 space-y-3">
                      {formData.reseau_ressources && formData.reseau_ressources.length > 0 ? (
                        <>
                          {formData.reseau_ressources.map((p) => (
                            <div key={p} className="flex items-center justify-between p-3 border rounded bg-white">
                              <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-100 rounded flex items-center justify-center">
                                  <Download className="h-4 w-4 text-blue-600" />
                                </div>
                                <div className="max-w-[60ch]">
                                  <p className="font-medium break-all">{p}</p>
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <Button
                                  type="button"
                                  variant="outline"
                                  size="sm"
                                  onClick={async () => {
                                    const { data } = await supabase.storage
                                      .from('bucket-table-reseau')
                                      .createSignedUrl(p, 60);
                                    if (data?.signedUrl) window.open(data.signedUrl, '_blank');
                                  }}
                                >
                                  <Eye className="h-4 w-4 mr-1" />
                                  Voir
                                </Button>
                                <Button
                                  type="button"
                                  variant="destructive"
                                  size="sm"
                                  onClick={() => handleDeleteDocument(p)}
                                  disabled={!isEditingFichiers}
                                >
                                  <Trash2 className="h-4 w-4 mr-1" />
                                  Supprimer
                                </Button>
                              </div>
                            </div>
                          ))}
                        </>
                      ) : (
                        <span className="text-muted-foreground text-sm">Aucun document upload√©</span>
                      )}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </form>
      </Tabs>

      {onBack && (
        <div className="pt-6">
          <Button type="button" variant="outline" onClick={onBack}>
            ‚Üê Retour
          </Button>
        </div>
      )}
    </div>
  );
};

export default FormReseauGestion;



```

---

## 4. Edge Functions

### üìÑ supabase/functions/update-reseau/index.ts

```typescript
// üìÑ supabase/functions/update-reseau/index.ts

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

// Initialisation du client Supabase avec la cl√© service_role
const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

// ‚úÖ Headers CORS ajout√©s pour compatibilit√© navigateur
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers':
    'authorization, x-client-info, apikey, content-type',
};

Deno.serve(async (req) => {
  // ‚úÖ Pr√©flight CORS
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { reseauId, generalData } = await req.json();

    // ‚úÖ Validation minimale des param√®tres
    if (!reseauId || !generalData || typeof generalData !== 'object') {
      return new Response(
        JSON.stringify({ error: 'Param√®tres manquants ou invalides' }),
        { status: 400, headers: corsHeaders }
      );
    }

    // ============================================
    // 1. Normalisation des chemins logo / documents
    // ============================================
    let reseau_logo = generalData.reseau_logo ?? null;
    let reseau_ressources = generalData.reseau_ressources ?? [];

    // ‚öôÔ∏è Si logo fourni ‚Üí forcer stockage dans dossier 1-logos/
    if (reseau_logo && !reseau_logo.includes(`/1-logos/`)) {
      const fileName = reseau_logo.split('/').pop(); // extrait nom du fichier
      reseau_logo = `reseau-${reseauId}/1-logos/${fileName}`;
    }

    // ‚öôÔ∏è Si documents fournis ‚Üí forcer stockage dans dossier 2-documents-institutionnels/
    if (Array.isArray(reseau_ressources)) {
      reseau_ressources = reseau_ressources.map((path: string) => {
        const fileName = path.split('/').pop();
        if (!path.includes(`/2-documents-institutionnels/`)) {
          return `reseau-${reseauId}/2-documents-institutionnels/${fileName}`;
        }
        return path;
      });
    }

    // ============================
    // 2. Mise √† jour table reseau
    // ============================
    const { error: reseauError } = await supabase
      .from('reseau')
      .update({
        reseau_nom: generalData.reseau_nom ?? null,
        reseau_identite_commerciale: generalData.reseau_identite_commerciale ?? null,
        reseau_adresse: generalData.reseau_adresse ?? null,
        reseau_code_postal: generalData.reseau_code_postal ?? null,
        reseau_ville: generalData.reseau_ville ?? null,
        reseau_siret: generalData.reseau_siret ?? null,
        reseau_statut: generalData.reseau_statut ?? null,
        reseau_logo: reseau_logo,
        reseau_ressources: reseau_ressources,
        reseau_brevo_connexion_id: generalData.reseau_brevo_connexion_id ?? null,
        reseau_zoho_connexion_id: generalData.reseau_zoho_connexion_id ?? null,
        reseau_openai_connexion_id: generalData.reseau_openai_connexion_id ?? null,
        reseau_telephone: generalData.reseau_telephone ?? null,
        reseau_email: generalData.reseau_email ?? null,
        reseau_updated_at: new Date().toISOString(),
      })
      .eq('reseau_id', reseauId);

    if (reseauError) {
      return new Response(JSON.stringify({ error: reseauError.message }), {
        status: 500,
        headers: corsHeaders,
      });
    }

    // ============================
    // 3. Synchronisation reseau_direction
    //    Copie forc√©e depuis reseau_telephone / reseau_email
    // ============================
    const { error: directionError } = await supabase
      .from('reseau_direction')
      .update({
        reseau_direction_telephone: generalData.reseau_telephone ?? null,
        reseau_direction_email: generalData.reseau_email ?? null,
      })
      .eq('reseau_id', reseauId);

    if (directionError) {
      return new Response(JSON.stringify({ error: directionError.message }), {
        status: 500,
        headers: corsHeaders,
      });
    }

    // ============================
    // 4. Succ√®s
    // ============================
    return new Response(JSON.stringify({ success: true }), {
      status: 200,
      headers: corsHeaders,
    });
  } catch (e) {
    console.error('Erreur interne update-reseau', e);
    return new Response(
      JSON.stringify({ error: 'Erreur interne update-reseau' }),
      { status: 500, headers: corsHeaders }
    );
  }
});

```

### üìÑ supabase/functions/upload-reseau-files/index.ts

```typescript
// üìÑ supabase/functions/upload-reseau-files/index.ts

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

// ‚úÖ Headers CORS
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers':
    'authorization, x-client-info, apikey, content-type',
};

Deno.serve(async (req) => {
  // ‚úÖ Pr√©flight CORS
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const formData = await req.formData();
    const file = formData.get('file') as File;
    const type = formData.get('type') as string; // "logo" | "document"
    const reseauId = formData.get('reseauId') as string;

    // ============================
    // 1. Validation param√®tres
    // ============================
    if (!file || !type || !reseauId) {
      return new Response(
        JSON.stringify({ error: 'Param√®tres manquants' }),
        { status: 400, headers: corsHeaders }
      );
    }

    if (!['logo', 'document'].includes(type)) {
      return new Response(
        JSON.stringify({ error: 'Type de fichier invalide' }),
        { status: 400, headers: corsHeaders }
      );
    }

    // ============================
    // 2. Dossier de destination
    // ============================
    const folder =
      type === 'logo' ? '1-logos' : '2-documents-institutionnels';
    const filePath = `reseau-${reseauId}/${folder}/${Date.now()}-${file.name}`;

    // ============================
    // 3. Upload fichier
    // ============================
    const { error: uploadError } = await supabase.storage
      .from('bucket-table-reseau')
      .upload(filePath, file.stream(), {
        contentType: file.type || 'application/octet-stream',
        upsert: true, // ‚úÖ permet d‚Äô√©craser un fichier existant
      });

    if (uploadError) {
      return new Response(
        JSON.stringify({ error: uploadError.message }),
        { status: 500, headers: corsHeaders }
      );
    }

    // ============================
    // 4. Retour enrichi et coh√©rent
    // ============================
    const responsePayload = {
      success: true,
      filePath,             // chemin dans le bucket
      bucket: 'bucket-table-reseau',
      mime: file.type || 'application/octet-stream',
      size: file.size,
      type,                 // "logo" ou "document"
    };

    return new Response(JSON.stringify(responsePayload), {
      status: 200,
      headers: corsHeaders,
    });
  } catch (e) {
    console.error('Erreur interne upload-reseau-files', e);
    return new Response(
      JSON.stringify({ error: 'Erreur interne upload-reseau-files' }),
      { status: 500, headers: corsHeaders }
    );
  }
});


```

---

## 6. Migration SQL pour le Bucket : bucket-table-reseau | Avec RLS policies 

```sql
-- =========================================
-- 1. Cr√©ation du bucket unique multi-tenant
-- =========================================
INSERT INTO storage.buckets (id, name, public)
VALUES ('bucket-table-reseau', 'bucket-table-reseau', false)
ON CONFLICT (id) DO NOTHING;

-- =========================================
-- 2. Suppression des anciennes policies (s√©curit√© idempotente)
-- =========================================
DO $$
BEGIN
  IF EXISTS (
    SELECT 1
    FROM pg_policies
    WHERE policyname = 'RLS reseau files access'
      AND tablename = 'objects'
      AND schemaname = 'storage'
  ) THEN
    EXECUTE 'DROP POLICY "RLS reseau files access" ON storage.objects';
  END IF;
END $$;

-- =========================================
-- 3. Policy multi-tenant stricte
-- Chaque utilisateur authentifi√© ne peut voir/√©crire
-- que dans son propre dossier organisation-{organisation_id}/...
-- =========================================
CREATE POLICY "RLS reseau files access"
ON storage.objects
FOR ALL
TO authenticated
USING (
  bucket_id = 'bucket-table-reseau'
  AND (
    -- ‚úÖ Admin Presenca : acc√®s total
    is_admin_presenca(auth.uid())

    OR

    -- ‚úÖ Utilisateur organisation : acc√®s uniquement √† son dossier organisation-{organisation_id}/...
    name LIKE ('organisation-' || get_user_organisation_id(auth.uid())::text || '/%')
  )
)
WITH CHECK (
  bucket_id = 'bucket-table-reseau'
  AND (
    is_admin_presenca(auth.uid())
    OR
    name LIKE ('organisation-' || get_user_organisation_id(auth.uid())::text || '/%')
  )
);

-- =========================================
-- 4. Notes de design (documentation int√©gr√©e)
-- =========================================
-- Architecture du bucket :
-- bucket-table-reseau/
-- ‚îî‚îÄ‚îÄ organisation-{uuid}/              ‚Üê UUID = organisation_id (pivot multi-tenant)
--     ‚îú‚îÄ‚îÄ 1-logos/                      ‚Üê Dossier logos
--     ‚îÇ   ‚îú‚îÄ‚îÄ logo-principal.png
--     ‚îÇ   ‚îî‚îÄ‚îÄ logo-alternatif.png
--     ‚îú‚îÄ‚îÄ 2-documents-institutionnels/  ‚Üê Dossier documents
--     ‚îÇ   ‚îú‚îÄ‚îÄ presentation.pdf
--     ‚îÇ   ‚îú‚îÄ‚îÄ reglement.pdf
--     ‚îÇ   ‚îî‚îÄ‚îÄ statuts.pdf
--     ‚îî‚îÄ‚îÄ 3-charte-graphique/           ‚Üê Extensible futur
--         ‚îî‚îÄ‚îÄ charte-couleurs.pdf
--
-- Mapping avec les tables :
--   reseau_logo        ‚Üí chemin unique (string) stock√© dans reseau.reseau_logo
--   reseau_ressources  ‚Üí array de chemins stock√© dans reseau.reseau_ressources
--
-- Exemple stockage :
--   reseau_logo :
--     bucket-table-reseau/organisation-{uuid}/1-logos/logo-principal.png
--   reseau_ressources :
--     [
--       bucket-table-reseau/organisation-{uuid}/2-documents-institutionnels/presentation.pdf,
--       bucket-table-reseau/organisation-{uuid}/2-documents-institutionnels/reglement.pdf
--     ]
--
-- S√©curit√© garantie par RLS :
--   -> Chaque utilisateur n'acc√®de qu'√† son dossier organisation-{uuid}
--   -> Admin Presenca dispose d'un acc√®s global
--   -> Coh√©rence avec l'architecture multi-tenant existante (get_user_organisation_id)


```

---
## 7. Mapping global

| Onglet       | Fichiers front                               | Tables Supabase                                                                                 | Edge Functions        |
| ------------ | -------------------------------------------- | ----------------------------------------------------------------------------------------------- | --------------------- |
| G√©n√©ral      | `useReseauFormData`, `FormReseauGestion`     | `reseau` (point de v√©rit√© email/t√©l√©phone), `reseau_direction` (h√©ritage)                       | `update-reseau`       |
| Int√©grations | `useReseauIntegrations`, `FormReseauGestion` | `reseau` (FKs vers connexions), `brevo_connexion`, `zoho_connexion`, `openai_connexion`         | `update-reseau`       |
| Fichiers     | `FormReseauGestion`                          | `reseau` (`reseau_logo`, `reseau_ressources`), `storage.objects` (bucket `bucket-table-reseau`) | `upload-reseau-files` |

---
## 8. Arborescence cible
```typescript
src/
‚îî‚îÄ components/
‚îú‚îÄ HOOKS-STRATEGIQUE/
‚îÇ ‚îî‚îÄ 6.HOOKS-GestionCompteAdminPresenca/1.Reseau/
‚îÇ ‚îú‚îÄ hooks/
‚îÇ ‚îÇ ‚îú‚îÄ types.ts
‚îÇ ‚îÇ ‚îú‚îÄ useReseauFormData.ts
‚îÇ ‚îÇ ‚îî‚îÄ useReseauIntegrations.ts
‚îÇ ‚îî‚îÄ components/
‚îÇ ‚îî‚îÄ ReseauSelector.tsx
‚îî‚îÄ ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/1.Reseau/
‚îî‚îÄ src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/1.Reseau/3.FormReseauGestion.tsx

supabase/
‚îî‚îÄ functions/
‚îú‚îÄ update-reseau/index.ts
‚îî‚îÄ upload-reseau-files/index.ts

```
## 9. Rappel des emplacements imp√©ratifs
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/types.ts
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauFormData.ts
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations.ts

- rc/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/1.Reseau/3.FormReseauGestion.tsx

- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/components/ReseauSelector.tsx

- supabase/functions/update-reseau/index.ts
- supabase/functions/upload-reseau-files/index.ts

- Migration Storage migration-storage-buckets.sql

---






# üìã √âTUDE D'IMPACT - Edge Function SERVICE_ROLE_KEY pour Gestion R√©seaux

## 1. üîç ANALYSE STRUCTURE EDGE FUNCTION EXISTANTE (create-reseau-admin)

### 1.1 Configuration Client Admin
```javascript
const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})
```
- **Utilise SUPABASE_SERVICE_ROLE_KEY** pour bypasser RLS
- **Pas de session persistante** (appropri√© pour edge function)

### 1.2 S√©curit√© CORS
```javascript
const corsHeaders = getCorsHeaders(origin)
if (req.method === 'OPTIONS') {
  return new Response(null, { headers: corsHeaders })
}
```
- **Gestion CORS** via fichier partag√© `_shared/cors.ts`
- **Support OPTIONS** preflight

### 1.3 S√©curit√© Temporaire
```javascript
// ‚ö†Ô∏è TEMPORAIRE: JWT v√©rification d√©sactiv√©e pour tests
console.log('üîì TEST MODE: JWT verification disabled')
```
- **JWT verification** actuellement d√©sactiv√©e
- **Devrait √™tre r√©activ√©e** en production

### 1.4 Processus Cr√©ation en 2 √âtapes

**Cr√©ation Auth User :**
```javascript
const { data: authUser, error: authError } = await supabaseAdmin.auth.admin.createUser({
  email: formData.emailResponsable,
  password: tempPassword,
  email_confirm: true,
  user_metadata: { nom, prenom, type_compte: 'reseau' }
})
```

**Cr√©ation Donn√©es M√©tier :**
```javascript
const { data: sqlResult, error: sqlError } = await supabaseAdmin.rpc('create_reseau_compte_complet', {
  // tous les param√®tres du r√©seau
})
```

### 1.5 Gestion d'Erreur avec Rollback
```javascript
catch (sqlError) {
  // üîÑ ROLLBACK : Supprimer l'utilisateur Auth en cas d'erreur SQL
  await supabaseAdmin.auth.admin.deleteUser(authUser.user.id)
  throw sqlError
}
```

### 1.6 Points Cl√©s pour R√©plication
- **Client Admin** : Acc√®s total sans RLS
- **Fonction SQL** : Logique m√©tier centralis√©e dans `create_reseau_compte_complet`
- **Atomicit√©** : Rollback automatique si √©chec
- **Logging s√©curis√©** : Pas d'exposition des donn√©es sensibles

---

## 2. üìä ANALYSE D'IMPACT - Modifications N√©cessaires

### ‚úÖ Fichiers QUI N'ONT PAS BESOIN de modification :

#### 2.1 `types.ts`
- **Status** : ‚úÖ Aucun changement
- **Raison** : Structures de donn√©es identiques

#### 2.2 `ReseauSelector.tsx`
- **Status** : ‚úÖ Aucun changement
- **Raison** : Interface utilisateur pure

#### 2.3 `FormReseauGestion.tsx`
- **Status** : ‚úÖ PAS de modification
- **Raison** : Utilise d√©j√† `supabase.functions.invoke('update-reseau')`

### üîß Fichiers √† MODIFIER :

#### 2.4 `useReseauFormData.ts`
- **Status** : ‚úÖ D√©j√† conforme
- **D√©tail** : Utilise d√©j√† `supabase.functions.invoke('update-reseau')` (ligne 267)
- **Action** : Aucune modification n√©cessaire

#### 2.5 `useReseauIntegrations.ts`
- **Status** : ‚ö†Ô∏è MODIFICATION REQUISE
- **Probl√®me** : Utilise `supaOps.update()` et `supaOps.insert()` avec client standard (lignes 513, 523)
- **Solution** : Remplacer par appels vers `update-reseau` Edge Function

#### 2.6 `supabase/config.toml`
- **Status** : ‚ö†Ô∏è MODIFICATION REQUISE
- **Action** : Ajouter `verify_jwt = false` pour les nouvelles functions



#### 2.7 `supabase/functions/update-reseau/index.ts`
- **Status** : ‚ö†Ô∏è MODIFICATION REQUISE
- **Contenu** : Edge Function avec SERVICE_ROLE_KEY
- **Responsabilit√©** : Gestion des updates tables `reseau`, `brevo_connexion`, `zoho_connexion`, `openai_connexion`

#### 2.8 `supabase/functions/upload-reseau-files/index.ts`
- **Status** : ‚ö†Ô∏è MODIFICATION REQUISE
- **Contenu** : Edge Function avec SERVICE_ROLE_KEY pour upload fichiers

---

## 3. üîó ANALYSE FICHIER CORS (_shared/cors.ts)

### 3.1 Structure Actuelle
```javascript
const allowedOrigins = [
  // üè¢ PRODUCTION
  'https://www.leadgenai-adbuilder.com',
  'https://leadgenai-adbuilder.com',
  
  // üß™ TEST LOVABLE
  'https://appli-v7-leadgenai.lovable.app',
  
  // üõ†Ô∏è D√âVELOPPEMENT LOVABLE
  'https://lovable.dev',
  'https://lovable.app',
  /^https:\/\/.*\.lovable\.app$/,
  /^https:\/\/.*\.lovable\.dev$/,
  /^https:\/\/.*\.lovableproject\.com$/,
  
  // üîß D√âVELOPPEMENT LOCAL
  'http://localhost:3000',
  'http://localhost:5173',
]
```

### 3.2 Fonction getCorsHeaders
```javascript
export const getCorsHeaders = (origin: string | null) => {
  const isAllowed = allowedOrigins.some(allowed => {
    if (typeof allowed === 'string') return allowed === origin
    if (allowed instanceof RegExp) return allowed.test(origin || '')
    return false
  })
  
  return {
    'Access-Control-Allow-Origin': isAllowed ? (origin || '*') : 'null',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
  }
}
```

### 3.3 Conclusion CORS
- **Status** : ‚úÖ AUCUNE MODIFICATION REQUISE
- **Raison** : 
  - Structure parfaitement adapt√©e pour toutes les Edge Functions
  - Gestion compl√®te des origins autoris√©s (prod, test, dev)
  - Headers appropri√©s pour l'authentification Supabase
  - M√©thodes POST/OPTIONS suffisantes pour nos besoins

---

## 4. üéØ CONCLUSION G√âN√âRALE

### Impact Minimal Confirm√© :
**SEULS 2 fichiers existants** n√©cessitent des modifications :

1. **`useReseauIntegrations.ts`** - Remplacer appels directs par Edge Function
2. **`supabase/config.toml`** - Configuration JWT

### Architecture D√©j√† Pr√™te :
- **Le reste fonctionne d√©j√†** avec l'architecture Edge Function pr√©vue
- **Fichier CORS** parfaitement configur√©
- **Structure modulaire** bien pens√©e

### Prochaines √âtapes :
1. Cr√©er `update-reseau` Edge Function
2. Cr√©er `upload-reseau-files` Edge Function  
3. Modifier `useReseauIntegrations.ts`
4. Ajouter config `verify_jwt = false`

### Avantages de cette Architecture :
- **S√©curit√© renforc√©e** avec SERVICE_ROLE_KEY
- **Bypass RLS** pour op√©rations admin
- **Centralisation** de la logique m√©tier
- **Logging unifi√©** et s√©curis√©
- **Rollback automatique** en cas d'erreur

---

## 5. üíª CODES COMPLETS DES MODIFICATIONS

Apr√®s analyse approfondie de la strat√©gie et des fichiers existants, voici les codes complets des fichiers √† modifier :

### 5.1 üîß FICHIER √Ä MODIFIER : `useReseauIntegrations.ts`

**Probl√®me identifi√© :** Utilise `supaOps.update()` et `supaOps.insert()` avec client standard (lignes 165, 175)  
**Solution :** Remplacer par appels vers Edge Function `update-reseau`

```typescript
// üìÑ src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations.ts

import { useCallback, useState } from 'react';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';
import type { BrevoFormState, ZohoFormState, OpenAIFormState } from './types';

export function useReseauIntegrations() {
  const { toast } = useToast();

  // ‚úÖ organisation_id s√©par√©
  const [organisationId, setOrganisationId] = useState<string | null>(null);

  // ‚úÖ √âtats UI (formulaire uniquement)
  const [brevo, setBrevo] = useState<BrevoFormState>({});
  const [zoho, setZoho] = useState<ZohoFormState>({});
  const [openai, setOpenAI] = useState<OpenAIFormState>({});

  // ‚úÖ IDs techniques s√©par√©s
  const [brevoConnexionId, setBrevoConnexionId] = useState<string | null>(null);
  const [zohoConnexionId, setZohoConnexionId] = useState<string | null>(null);
  const [openaiConnexionId, setOpenaiConnexionId] = useState<string | null>(null);

  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  // ================================
  // Charger les int√©grations d'un r√©seau
  // ================================
  const loadForReseau = useCallback(async (reseauId: string) => {
    if (!reseauId) return;
    setIsLoading(true);

    try {
      // üîÑ DIRECT SUPABASE : Charger r√©seau (donn√©es de r√©f√©rence uniquement)
      const { data: reseau, error } = await supabase
        .from('reseau')
        .select(`
          organisation_id,
          reseau_brevo_connexion_id,
          reseau_zoho_connexion_id,
          reseau_openai_connexion_id
        `)
        .eq('reseau_id', reseauId)
        .maybeSingle();

      if (error) throw error;
      if (!reseau) {
        setOrganisationId(null);
        setBrevo({});
        setZoho({});
        setOpenAI({});
        setBrevoConnexionId(null);
        setZohoConnexionId(null);
        setOpenaiConnexionId(null);
        toast({ title: 'Introuvable', description: 'R√©seau introuvable', variant: 'destructive' });
        return;
      }

      setOrganisationId(reseau.organisation_id);

      // Reset √©tats
      setBrevo({});
      setZoho({});
      setOpenAI({});
      setBrevoConnexionId(null);
      setZohoConnexionId(null);
      setOpenaiConnexionId(null);

      // üîÑ DIRECT SUPABASE : Charger Brevo
      if (reseau.reseau_brevo_connexion_id) {
        setBrevoConnexionId(reseau.reseau_brevo_connexion_id);
        const { data: brevoData, error: brevoError } = await supabase
          .from('brevo_connexion')
          .select('brevo_api_key, brevo_email_compte, brevo_nom_compte')
          .eq('brevo_connexion_id', reseau.reseau_brevo_connexion_id)
          .maybeSingle();

        if (brevoError) throw brevoError;
        if (brevoData) {
          setBrevo({
            brevo_api_key: brevoData.brevo_api_key ?? undefined,
            brevo_email_compte: brevoData.brevo_email_compte ?? undefined,
            brevo_nom_compte: brevoData.brevo_nom_compte ?? undefined,
          });
        }
      }

      // üîÑ DIRECT SUPABASE : Charger Zoho
      if (reseau.reseau_zoho_connexion_id) {
        setZohoConnexionId(reseau.reseau_zoho_connexion_id);
        const { data: zohoData, error: zohoError } = await supabase
          .from('zoho_connexion')
          .select('zoho_api_key, zoho_email_compte, zoho_nom_compte')
          .eq('zoho_connexion_id', reseau.reseau_zoho_connexion_id)
          .maybeSingle();

        if (zohoError) throw zohoError;
        if (zohoData) {
          setZoho({
            zoho_api_key: zohoData.zoho_api_key ?? undefined,
            zoho_email_compte: zohoData.zoho_email_compte ?? undefined,
            zoho_nom_compte: zohoData.zoho_nom_compte ?? undefined,
          });
        }
      }

      // üîÑ DIRECT SUPABASE : Charger OpenAI
      if (reseau.reseau_openai_connexion_id) {
        setOpenaiConnexionId(reseau.reseau_openai_connexion_id);
        const { data: openaiData, error: openaiError } = await supabase
          .from('openai_connexion')
          .select('openai_api_key, openai_email_compte')
          .eq('openai_connexion_id', reseau.reseau_openai_connexion_id)
          .maybeSingle();

        if (openaiError) throw openaiError;
        if (openaiData) {
          setOpenAI({
            openai_api_key: openaiData.openai_api_key ?? undefined,
            openai_email_compte: openaiData.openai_email_compte ?? undefined,
          });
        }
      }
    } catch (e: any) {
      console.error('Erreur loadForReseau', e);
      toast({ title: 'Erreur', description: e?.message || 'Impossible de charger les int√©grations', variant: 'destructive' });
    } finally {
      setIsLoading(false);
    }
  }, [toast]);

  // ================================
  // ‚ö° NOUVELLE VERSION : Sauvegarde via Edge Function
  // ================================
  const saveIntegration = useCallback(
    async (reseauId: string, kind: 'brevo' | 'zoho' | 'openai') => {
      if (!reseauId) return false;
      if (!organisationId) {
        toast({ title: 'Erreur', description: 'organisation_id introuvable', variant: 'destructive' });
        return false;
      }
      setIsSaving(true);

      try {
        let state: any, connexionId: string | null, setConnexionIdFn: (id: string | null) => void;

        switch (kind) {
          case 'brevo':
            state = brevo;
            connexionId = brevoConnexionId;
            setConnexionIdFn = setBrevoConnexionId;
            break;
          case 'zoho':
            state = zoho;
            connexionId = zohoConnexionId;
            setConnexionIdFn = setZohoConnexionId;
            break;
          case 'openai':
            state = openai;
            connexionId = openaiConnexionId;
            setConnexionIdFn = setOpenaiConnexionId;
            break;
        }

        // üöÄ APPEL EDGE FUNCTION update-reseau pour les int√©grations
        const payload = {
          reseauId,
          integrationData: {
            kind,
            connexionId,
            data: state
          }
        };

        const { data, error } = await supabase.functions.invoke('update-reseau', {
          body: JSON.stringify(payload)
        });

        if (error) throw error;

        // Si nouveau ID retourn√© (cas INSERT), le m√©moriser
        if (data?.newConnexionId && !connexionId) {
          setConnexionIdFn(data.newConnexionId);
        }

        toast({ title: 'Succ√®s', description: `Int√©gration ${kind} mise √† jour avec succ√®s` });
        return true;
      } catch (e: any) {
        console.error(`Erreur saveIntegration ${kind}`, e);
        toast({ title: 'Erreur', description: e?.message || "Impossible de sauvegarder l'int√©gration", variant: 'destructive' });
        return false;
      } finally {
        setIsSaving(false);
      }
    },
    [organisationId, brevo, zoho, openai, brevoConnexionId, zohoConnexionId, openaiConnexionId, toast]
  );

  return {
    organisationId,
    // √âtats UI
    brevo, setBrevo,
    zoho, setZoho,
    openai, setOpenAI,
    // IDs techniques
    brevoConnexionId,
    zohoConnexionId,
    openaiConnexionId,
    // Meta
    isLoading,
    isSaving,
    // Actions
    loadForReseau,
    saveIntegration,
  };
}
```

### 5.2 üÜï EDGE FUNCTION √Ä MODIFIER : `update-reseau/index.ts`

```typescript
// üìÑ supabase/functions/update-reseau/index.ts

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

// Initialisation du client Supabase avec la cl√© service_role
const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

// ‚úÖ Headers CORS ajout√©s pour compatibilit√© navigateur
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers':
    'authorization, x-client-info, apikey, content-type',
};

Deno.serve(async (req) => {
  // ‚úÖ Pr√©flight CORS
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { reseauId, generalData, integrationData } = await req.json();

    // ‚úÖ Validation minimale des param√®tres
    if (!reseauId) {
      return new Response(
        JSON.stringify({ error: 'reseauId manquant' }),
        { status: 400, headers: corsHeaders }
      );
    }

    // ============================
    // 1. MISE √Ä JOUR DONN√âES G√âN√âRALES (si pr√©sentes)
    // ============================
    if (generalData && typeof generalData === 'object') {
      // ‚öôÔ∏è Normalisation des chemins logo / documents
      let reseau_logo = generalData.reseau_logo ?? null;
      let reseau_ressources = generalData.reseau_ressources ?? [];

      // Si logo fourni ‚Üí forcer stockage dans dossier 1-logos/
      if (reseau_logo && !reseau_logo.includes(`/1-logos/`)) {
        const fileName = reseau_logo.split('/').pop();
        reseau_logo = `reseau-${reseauId}/1-logos/${fileName}`;
      }

      // Si documents fournis ‚Üí forcer stockage dans dossier 2-documents-institutionnels/
      if (Array.isArray(reseau_ressources)) {
        reseau_ressources = reseau_ressources.map((path: string) => {
          const fileName = path.split('/').pop();
          if (!path.includes(`/2-documents-institutionnels/`)) {
            return `reseau-${reseauId}/2-documents-institutionnels/${fileName}`;
          }
          return path;
        });
      }

      // Mise √† jour table reseau
      const { error: reseauError } = await supabase
        .from('reseau')
        .update({
          reseau_nom: generalData.reseau_nom ?? null,
          reseau_identite_commerciale: generalData.reseau_identite_commerciale ?? null,
          reseau_adresse: generalData.reseau_adresse ?? null,
          reseau_code_postal: generalData.reseau_code_postal ?? null,
          reseau_ville: generalData.reseau_ville ?? null,
          reseau_siret: generalData.reseau_siret ?? null,
          reseau_statut: generalData.reseau_statut ?? null,
          reseau_logo: reseau_logo,
          reseau_ressources: reseau_ressources,
          reseau_brevo_connexion_id: generalData.reseau_brevo_connexion_id ?? null,
          reseau_zoho_connexion_id: generalData.reseau_zoho_connexion_id ?? null,
          reseau_openai_connexion_id: generalData.reseau_openai_connexion_id ?? null,
          reseau_telephone: generalData.reseau_telephone ?? null,
          reseau_email: generalData.reseau_email ?? null,
          reseau_updated_at: new Date().toISOString(),
        })
        .eq('reseau_id', reseauId);

      if (reseauError) {
        return new Response(JSON.stringify({ error: reseauError.message }), {
          status: 500,
          headers: corsHeaders,
        });
      }

      // Synchronisation reseau_direction (copie forc√©e depuis reseau_telephone / reseau_email)
      if (generalData.reseau_telephone || generalData.reseau_email) {
        const { error: directionError } = await supabase
          .from('reseau_direction')
          .update({
            reseau_direction_telephone: generalData.reseau_telephone ?? null,
            reseau_direction_email: generalData.reseau_email ?? null,
          })
          .eq('reseau_id', reseauId);

        if (directionError) {
          console.warn('Erreur sync reseau_direction:', directionError.message);
        }
      }
    }

    // ============================
    // 2. MISE √Ä JOUR INT√âGRATIONS (si pr√©sentes)
    // ============================
    let newConnexionId: string | null = null;

    if (integrationData && typeof integrationData === 'object') {
      const { kind, connexionId, data } = integrationData;

      if (!['brevo', 'zoho', 'openai'].includes(kind)) {
        return new Response(
          JSON.stringify({ error: 'Type d\'int√©gration invalide' }),
          { status: 400, headers: corsHeaders }
        );
      }

      // R√©cup√©rer organisation_id du r√©seau
      const { data: reseauData, error: reseauSelectError } = await supabase
        .from('reseau')
        .select('organisation_id')
        .eq('reseau_id', reseauId)
        .single();

      if (reseauSelectError || !reseauData) {
        return new Response(
          JSON.stringify({ error: 'R√©seau introuvable' }),
          { status: 404, headers: corsHeaders }
        );
      }

      const organisationId = reseauData.organisation_id;

      // D√©finir les champs selon le type d'int√©gration
      let tableName: string, fkField: string, idField: string;
      switch (kind) {
        case 'brevo':
          tableName = 'brevo_connexion';
          fkField = 'reseau_brevo_connexion_id';
          idField = 'brevo_connexion_id';
          break;
        case 'zoho':
          tableName = 'zoho_connexion';
          fkField = 'reseau_zoho_connexion_id';
          idField = 'zoho_connexion_id';
          break;
        case 'openai':
          tableName = 'openai_connexion';
          fkField = 'reseau_openai_connexion_id';
          idField = 'openai_connexion_id';
          break;
      }

      if (connexionId) {
        // ‚ö° UPDATE existante
        const { error: updateError } = await supabase
          .from(tableName)
          .update(data)
          .eq(idField, connexionId);

        if (updateError) {
          return new Response(JSON.stringify({ error: updateError.message }), {
            status: 500,
            headers: corsHeaders,
          });
        }
      } else {
        // ‚ö° INSERT nouvelle connexion
        const payload = {
          ...data,
          reseau_id: reseauId,
          organisation_id: organisationId,
        };

        const { data: insertData, error: insertError } = await supabase
          .from(tableName)
          .insert(payload)
          .select(idField)
          .single();

        if (insertError) {
          return new Response(JSON.stringify({ error: insertError.message }), {
            status: 500,
            headers: corsHeaders,
          });
        }

        newConnexionId = insertData[idField];

        // Mettre √† jour la FK dans reseau
        const { error: fkUpdateError } = await supabase
          .from('reseau')
          .update({ [fkField]: newConnexionId })
          .eq('reseau_id', reseauId);

        if (fkUpdateError) {
          return new Response(JSON.stringify({ error: fkUpdateError.message }), {
            status: 500,
            headers: corsHeaders,
          });
        }
      }
    }

    // ============================
    // 3. Succ√®s
    // ============================
    const response = { success: true };
    if (newConnexionId) {
      response.newConnexionId = newConnexionId;
    }

    return new Response(JSON.stringify(response), {
      status: 200,
      headers: corsHeaders,
    });
  } catch (e) {
    console.error('Erreur interne update-reseau', e);
    return new Response(
      JSON.stringify({ error: 'Erreur interne update-reseau' }),
      { status: 500, headers: corsHeaders }
    );
  }
});
```

### 5.3 üÜï EDGE FUNCTION √Ä MODIFIER : `upload-reseau-files/index.ts`

```typescript
// üìÑ supabase/functions/upload-reseau-files/index.ts

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

// ‚úÖ Headers CORS
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers':
    'authorization, x-client-info, apikey, content-type',
};

Deno.serve(async (req) => {
  // ‚úÖ Pr√©flight CORS
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const formData = await req.formData();
    const file = formData.get('file') as File;
    const type = formData.get('type') as string; // "logo" | "document"
    const reseauId = formData.get('reseauId') as string;

    // ============================
    // 1. Validation param√®tres
    // ============================
    if (!file || !type || !reseauId) {
      return new Response(
        JSON.stringify({ error: 'Param√®tres manquants' }),
        { status: 400, headers: corsHeaders }
      );
    }

    if (!['logo', 'document'].includes(type)) {
      return new Response(
        JSON.stringify({ error: 'Type de fichier invalide' }),
        { status: 400, headers: corsHeaders }
      );
    }

    // ============================
    // 2. Dossier de destination
    // ============================
    const folder =
      type === 'logo' ? '1-logos' : '2-documents-institutionnels';
    const filePath = `reseau-${reseauId}/${folder}/${Date.now()}-${file.name}`;

    // ============================
    // 3. Upload fichier
    // ============================
    const { error: uploadError } = await supabase.storage
      .from('bucket-table-reseau')
      .upload(filePath, file.stream(), {
        contentType: file.type || 'application/octet-stream',
        upsert: true, // ‚úÖ permet d'√©craser un fichier existant
      });

    if (uploadError) {
      return new Response(
        JSON.stringify({ error: uploadError.message }),
        { status: 500, headers: corsHeaders }
      );
    }

    // ============================
    // 4. Retour enrichi et coh√©rent
    // ============================
    const responsePayload = {
      success: true,
      filePath,             // chemin dans le bucket
      bucket: 'bucket-table-reseau',
      mime: file.type || 'application/octet-stream',
      size: file.size,
      type,                 // "logo" ou "document"
    };

    return new Response(JSON.stringify(responsePayload), {
      status: 200,
      headers: corsHeaders,
    });
  } catch (e) {
    console.error('Erreur interne upload-reseau-files', e);
    return new Response(
      JSON.stringify({ error: 'Erreur interne upload-reseau-files' }),
      { status: 500, headers: corsHeaders }
    );
  }
});
```

### 5.4 üîß FICHIER √Ä MODIFIER : `supabase/config.toml`

```toml
project_id = "ksymahfrtvhnbeobsspt"

[functions.notifier-nouvelle-demande]
verify_jwt = false

[functions.create-reseau-admin]
verify_jwt = false

[functions.update-reseau]
verify_jwt = false

[functions.upload-reseau-files]
verify_jwt = false
```

---

## 6. üéØ R√âSUM√â DES MODIFICATIONS

### ‚úÖ Modifications apport√©es :
1. **`useReseauIntegrations.ts`** : Remplacement des appels `supaOps` par Edge Function `update-reseau`
2. **`supabase/functions/update-reseau/index.ts`** : Nouvelle Edge Function avec SERVICE_ROLE_KEY
3. **`supabase/functions/upload-reseau-files/index.ts`** : Nouvelle Edge Function pour upload fichiers
4. **`supabase/config.toml`** : Ajout configuration `verify_jwt = false`

### ‚ö° Avantages obtenus :
- **S√©curit√© maximale** : bypass RLS avec SERVICE_ROLE_KEY
- **Logique centralis√©e** : toutes les op√©rations r√©seau via Edge Functions
- **Atomicit√© garantie** : coh√©rence des donn√©es assur√©e
- **Architecture unifi√©e** : m√™me pattern que `create-reseau-admin`

### üîó Impact minimal confirm√© :
- **2 fichiers existants modifi√©s** uniquement
- **Architecture d√©j√† compatible** avec Edge Functions
- **Types et interfaces** : aucun changement requis
- **Interface utilisateur** : aucun changement requis

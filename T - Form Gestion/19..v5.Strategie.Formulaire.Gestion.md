# üìå Comprendre le M√©canisme de conception du Formulaire de Gestion R√©seau

## 1. S√©lection du R√©seau
- Dropdown pour choisir un r√©seau (`reseau_id`, `reseau_nom`).
- Au changement ‚Üí chargement automatique des donn√©es associ√©es depuis Supabase :
  - Table `reseau` (infos g√©n√©rales, coordonn√©es t√©l√©phoniques, email + FK connexions).
  - Tables connexions (`brevo_connexion`, `zoho_connexion`, `openai_connexion`).
  - Storage (logos, documents).

---

## 2. Onglet G√©n√©ral
- **Champs √©ditables** :
  - Nom du R√©seau
  - Identit√© Commerciale du R√©seau
  - Adresse
  - Code Postal
  - Ville
  - Siret
  - T√©l√©phone Direction
  - Email Direction
- **Workflow** :
  - Bouton *Modifier* ‚Üí champs activ√©s.
  - Sauvegarde via **edge function `update-reseau`**.

---

## 3. Onglet Int√©grations
- Sert uniquement √† **m√©moriser les donn√©es informatives des plateformes Brevo, Zoho, OpenAI**
- **Champs √©ditables** :
  - Cl√© API
  - Email Compte
  - Nom Compte
- **Workflow** :
  - Injection des donn√©es existantes depuis tables connexions.
  - Si d√©j√† une ligne ‚Üí `update`.
  - Si aucune ligne ‚Üí `insert` + mise √† jour FK dans `reseau`.
- Aucun contr√¥le externe ‚Üí usage purement administratif.

---

## 4. Onglet Fichiers
- **Architecture Storage** (bucket unique multi-tenant) :
  
```
bucket-table-reseau/
‚îî‚îÄ‚îÄ reseau-{uuid}/                    ‚Üê UUID = reseau_id exact
    ‚îú‚îÄ‚îÄ 1-logos/                      ‚Üê Dossier logos
    ‚îÇ   ‚îú‚îÄ‚îÄ logo-principal.png
    ‚îÇ   ‚îî‚îÄ‚îÄ logo-alternatif.png
    ‚îú‚îÄ‚îÄ 2-documents-institutionnels/  ‚Üê Dossier documents
    ‚îÇ   ‚îú‚îÄ‚îÄ presentation.pdf
    ‚îÇ   ‚îú‚îÄ‚îÄ reglement.pdf
    ‚îÇ   ‚îî‚îÄ‚îÄ statuts.pdf
    ‚îî‚îÄ‚îÄ 3-charte-graphique/           ‚Üê Extensible futur
        ‚îî‚îÄ‚îÄ charte-couleurs.pdf
```

- **Mapping des donn√©es** :

Table reseau : 
- reseau_logo ‚Üí chemin unique vers le logo principal (dans 1-logos/).
- reseau_ressources ‚Üí tableau des chemins des documents institutionnels (dans 2-documents-institutionnels/).

Bucket Supabase : bucket-table-reseau 
- Isolation stricte par dossier reseau-{uuid} (chaque r√©seau a son espace).
- Les sous-dossiers organisent les fichiers par type (1-logos, 2-documents-institutionnels, 3-charte-graphique).
--
- **Fonctionnalit√©s utilisateur** :

Logo du R√©seau
- Afficher le logo actuel (si existant).
- Upload d‚Äôun nouveau logo ‚Üí sauvegarde dans 1-logos/.
- Supprimer le logo ‚Üí suppression via Edge Function et mise √† jour de reseau_logo.

Documents Institutionnels 
- Lister les documents existants (table reseau_ressources).
- Upload de nouveaux fichiers ‚Üí ajout dans 2-documents-institutionnels/.
- Supprimer un document ‚Üí suppression via Edge Function + retrait du tableau reseau_ressources.

Charte Graphique (extensible futur) 
- Pr√©vu pour accueillir les fichiers de charte graphique dans 3-charte-graphique/.
- M√™me logique : upload, affichage, suppression s√©curis√©e.

--
- **S√©curit√© & RLS** :

Isolation stricte : 
- Plus de policies RLS c√¥t√© storage.objects.
- Toutes les op√©rations (upload, suppression, mise √† jour DB) passent par des Edge Functions ex√©cut√©es avec le SUPABASE_SERVICE_ROLE_KEY.

Les Edge Functions :
- V√©rifient le reseauId transmis.
- Valident les droits (admin_presenca ou organisation li√©e).
- Centralisent la logique pour coh√©rence, logs et audit.
- Admin Presenca : acc√®s global √† tous les dossiers/fichiers via les fonctions.

---

## 5. Workflow Global
1. Admin PRESENCA choisit un r√©seau.
2. Donn√©es charg√©es automatiquement.
3. Lecture seule par d√©faut.
4. Bouton *Modifier* active l‚Äô√©dition.
5. Sauvegarde via **edge functions** :
   - `update-reseau` pour donn√©es g√©n√©rales & int√©grations.
   - `upload-reseau-files` pour logo/documents.
6. Retour en lecture seule apr√®s succ√®s.
---

## üîÑ Sch√©ma d‚ÄôArchitecture

```mermaid
flowchart TD
  A[ReseauSelector] --> B[reseau]
  B -->|1:1| C[reseau_direction]
  B -->|FKs| D[brevo_connexion / zoho_connexion / openai_connexion / ...]
  B -->|Storage paths| E[bucket-table-reseau]

  B -->|Telephone / Email| C
  C -->|Lecture seule| F[Coordonnees Direction]
  D -->|Historisation des donnees plateformes| G[Cle, email, nom de compte]
  E -->|Docs & Logos| H[Fichiers lies au reseau]
```


---

## Clarifications strat√©giques

### 1. Gestion Organisation vs R√©seau
Ce formulaire est **exclusivement d√©di√© √† la gestion des R√©seaux existants**.  
- **Organisation** : d√©j√† cr√©√©e en amont, non g√©r√©e ici.  
- **R√©seau** : on s√©lectionne un r√©seau existant, on affiche et on modifie ses donn√©es.  
üëâ Donc **aucune logique de cr√©ation d‚Äôorganisation ou d‚Äôutilisateur** n‚Äôest concern√©e. Le formulaire agit uniquement en **UPDATE** sur le r√©seau choisi.  
---
### 2. Int√©grations des donn√©es des plateformes Brevo, Zoho, OpenAI
Les champs Int√©grations (cl√©, email, nom de compte) servent **uniquement √† historiser et m√©moriser les infos saisies par l‚Äôadmin**.  
- Pas de test de validit√©.  
- Pas d‚Äôappel externe aux API.  
- Pas de logique de connexion automatique.  
üëâ L‚Äôonglet **‚ÄúInt√©grations‚Äù** est un **espace m√©moire facultatif**.  
Un r√©seau peut avoir z√©ro, une ou plusieurs infos d‚ÄôInt√©gration, mais leur pr√©sence ou absence n‚Äôimpacte pas le fonctionnement du reste du syst√®me.  
---
### 3. Distinction R√©seau vs R√©seauDirection 
- **R√©seau** = stocke les informations g√©n√©rales (nom du r√©seau, identit√© commerciale du r√©seau, adresse, ville, siret, t√©l√©phone, email). Point de v√©rit√© unique pour l‚Äôemail et le t√©l√©phone (coordonn√©es Direction).  
- **R√©seauDirection** = utilisateur directeur du r√©seau (li√© √† Auth), qui h√©rite des coordonn√©es renseign√©es dans `reseau`.  
üëâ Dans le formulaire Gestion R√©seau :  
- Les champs Email / T√©l√©phone sont **√©ditables** (dans `reseau`) et synchronis√©s automatiquement avec `reseau_direction`.  
- Dans un futur formulaire R√©seauDirection ‚Üí ces champs seront **lecture seule** pour √©viter les incoh√©rences. 
 
---
### 4. Architecture du Bucket de stockage
Le projet adopte un **bucket unique multi-tenant** : `bucket-table-reseau`.  
- Isolation stricte par dossier nomm√© `reseau-{uuid}`.
- - Chaque sous-dossier correspond √† un type de ressource :  
---
### 5. Question des risques 
- On ne peut pas avoir plusieurs r√©seaux pour une organisation.
- Le r√©seau est la t√™te de pont.
- Comme il s agit d un formulaire de gestion mofidiaiotn pas de creation, si on s√©lectionne dans le s√©lecteur un r√©seau, il ne peut y en avoir plusieurs.
- Le formulaire de gestion doit pouvoir injecter les donn√©es actuelles pr√©sentes dans supabase et admin_presenca qui est le seul √† utiliser ce formulaire de gestion doit pouvoir rajouter des informations ou les modifier si elles ne sont plus √† jour.
---
### 6. Rappel : Ce qui se passe quand on cr√©e un r√©seau avec Email Direction et T√©l√©phone Direction (dans le formulaire creation)
Formulaire de cr√©ation :
- L‚Äôadmin admin_presenca saisit les informations dans le formulaire de cr√©ation (nom r√©seau, adresse, siret, etc.) ainsi que :
- T√©l√©phone Direction
- Email Direction

Tables concern√©es lors de l‚Äôinsertion :
- Ces deux champs sont ins√©r√©s dans la table reseau en tant que :
- reseau_telephone
- reseau_email

Ils sont ensuite synchronis√©s automatiquement dans la table reseau_direction pour que l‚Äôutilisateur directeur ait les m√™mes coordonn√©es.
- reseau_direction_telephone
- reseau_direction_email

IDs impliqu√©s dans l‚Äôop√©ration : 
- reseau_id (cl√© primaire du r√©seau) ‚Üí utilis√© pour cr√©er le r√©seau et comme pivot de toutes les relations.
- organisation_id (FK dans reseau) ‚Üí rattache le r√©seau √† l‚Äôorganisation d√©j√† existante.
- reseau_direction_id (FK li√© √† l‚Äôutilisateur directeur) ‚Üí utilis√© pour propager l‚Äôemail et t√©l√©phone dans la table reseau_direction.

Donc :
- Point de v√©rit√© : reseau.reseau_telephone et reseau.reseau_email.
- Synchronisation automatique ‚Üí reseau_direction.reseau_direction_telephone et reseau_direction.reseau_direction_email.
- IDs pivots utilis√©s : reseau_id (principal), organisation_id (lien organisation), reseau_direction_id (synchronisation).
---


# ‚úÖ R√©sum√©
- **G√©n√©ral** ‚Üí infos juridiques du r√©seau.
- **Direction** ‚Üí infos personnelles (lecture seule).
- **Int√©grations** ‚Üí m√©morisation d‚ÄôAPIs (historisation simple).
- **Fichiers** ‚Üí stockage structur√© (logos + documents).
- **Workflow clair** ‚Üí s√©lection, chargement, √©dition par onglet, sauvegarde via edge functions.

---

# ‚úÖ Rappel des Emplacements 
- Hook Principal : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauFormData.ts
- Hook Int√©grations : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations.ts
- Types types.ts : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/types.ts
- Page Principale : src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/1.Reseau/3.FormReseauGestion.tsx
- Composant Selector : src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/components/ReseauSelector.tsx


---
---

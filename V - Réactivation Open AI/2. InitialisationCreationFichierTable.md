
# 🧠 Brief de Programmation PRO – Formulaire Agence Indépendante

---

## 🎯 Mission

**Expert IA no code – Intégration Supabase / Lovable**,  
tu es chargé de concevoir l’ensemble des fichiers, fonctions, hooks et SQL nécessaires au **formulaire de la table `agence_independante`**, en t’appuyant sur la même structure que le formulaire `reseau`.

Tu disposes de toutes les ressources de référence :  
- `Documents-Stratégiques-LeadGenAI.AdBuilder.zip`  
- `001.FormCreateurReseau.DossierCrucial.zip`  
- `002.FormGestionReseau.DossierCrucial.zip`  
- `003.FormCreateurGestion.DossierCrucial.zip`  
- `004.FichiersPréparatoiresFormAgenceIndependante.zip`

---

## 🧭 Étape 1 — Analyse préalable

Relis et analyse toutes les informations stratégiques utilisées pour concevoir le formulaire `reseau`, avec ses 3 pages :
- **Accueil**
- **Création**
- **Gestion** (avec ses onglets Général, Intégrations, Fichiers)
  - Documents-Stratégiques-LeadGenAI.AdBuilder.zip
  - 001.FormCreateurReseau.DossierCrucial.ziphttps://github.com/Presenca83330/BANQUE-FICHIERS/blob/main/V%20-%20R%C3%A9activation%20Open%20AI/2.%20InitialisationCreationFichierTable.md
  - 002.FormGestionReseau.DossierCrucial.zip
  - 003.FormCreateurGestion.DossierCrucial.zip
Tu dois t’en inspirer pour concevoir la table `agence_independante` selon le même modèle structurel, logique et graphique.

---

## 🧱 Étape 2 — Conception fonctionnelle.

### 1. Formulaire de **création**

- Création simultanée des tables :  
  `users`, `utilisateur`, `organisation`, `agence_independante`.
- Application du **même modèle que pour `reseau`** :
  - **Propagation automatique** vers `agence_independante_responsable` pour les champs `email` et `telephone`.
  - **Service Role Key** pour bypass RLS (même logique `verify_jwt=false` dans `config.toml`).
  - Gestion du mot de passe via composant `SuccessAccountInfo.tsx` (affichage du lien d’accès / magic link).
- Respect du **cascade process** :
  1. Organisation →  
  2. Agence →  
  3. User/Auth →  
  4. Utilisateur →  
  5. Responsable agence.
- Structure des EF :  
  `supabase/functions/create-agence-independante-admin/index.ts`

---

### 2. Formulaire de **gestion**

#### Structure générale
Même architecture que `reseau`, mais avec **4 onglets** :
1. **Général**
2. **Abonnement**
3. **Intégrations** (Brevo, Zoho, OpenAI, LinkedIn, Facebook, Instagram)
4. **Fichiers**

#### 🔹 Onglet Général
- Mise à jour de la table `agence_independante`.
- Propagation automatique vers `agence_independante_responsable` pour `email` et `telephone`.
- Respect du pattern `{ success, data, message }`.

#### 🔹 Onglet Abonnement *(nouveauté)*
- Pour l’instant, ne comporte que **2 champs en lecture seule** :
  - `Plan d’abonnement` (affiche `abonnement_stripe_plan` ou “Aucun” si null),
  - `Date de début d’abonnement` (affiche `abonnement_stripe_debut` ou vide).
- Ces champs lisent la table `abonnement_stripe`.
- Aucun lien Stripe actif pour le moment.
- Prévoir un **cadre extensible** permettant plus tard :
  - la sélection d’un plan,
  - la création / mise à jour d’un abonnement via EF Stripe,
  - la synchronisation automatique des données (`last_synchro`, `statut`, `paiement`).
- Fichiers et hooks à prévoir :
  - `useAbonnementStripeView.ts` (lecture seule),
  - Dossier futur `/4.OngletAbonnement/` (structure prête à accueillir les EF Stripe).

#### 🔹 Onglet Intégrations
- 6 intégrations prévues : Brevo, Zoho, OpenAI, LinkedIn, Facebook, Instagram.
- Mêmes EF et hooks que pour `reseau`, en adaptant les noms et tables.
- Gestion via `agence-independante-admin-update`.

#### 🔹 Onglet Fichiers
- Téléversement / suppression via EF :
  `agence-independante-admin-fichiers`.
- Respect du **mapping normé** :
  - `bucket-table-agence-independante/agence-{uuid}/1-logos/...`
  - `bucket-table-agence-independante/agence-{uuid}/2-documents-institutionnels/...`
- MAJ DB :
  - `_logo` → chemin unique vers le logo principal,
  - `_ressources` → tableau des chemins vers les documents.

#### ⚙️ Hooks et EF
- Hooks :  
  `useAgenceIndependanteFormData.ts`,  
  `useAgenceIndependanteIntegrations.ts`.
- EF :  
  - `gestion-agence-independante-admin/index.ts`  
  - `gestion-agence-independante-admin-donnees/index.ts`  
  - `gestion-agence-independante-admin-update/index.ts`  
  - `gestion-agence-independante-admin-fichiers/index.ts`

### 3. Respect de la structure graphique
- Il faudra impérativemetn conserver le graphisme existant
- Il a ete préparé dans le fichier préparatoire : 004.FichiersPréparatoiresFormAgenceIndependante.zip
- Suaf nécesstié absolue, tu ne modifiera pas les noms des titres, champs preholder

### 4. Respect du nomming et du maping des tables
- Il faudra impérativement veiller à respecter le cnom des chmamps des tables
- Ils sont présents tu n as pas à créer de nouveaux champs pour toutes les tables : users, utilisateur, organisation ,agence independante et agence indepedantez responsable et les tables de connexion
- Tu retrouvers toutes les tébles dans le fichier préparatoire : 004.FichiersPréparatoiresFormAgenceIndependante.zip

---

## 🗂️ Étape 3 — Emplacements des fichiers

### 📍 Frontend
**Fichiers :**  
- src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/1.FormAgenceIndependanteAccueil.tsx
- src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/2.FormAgenceIndependanteCreation.tsx
- src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/3.FormAgenceIndependanteGestion.tsx
- src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/SuccessAccountInfo.tsx

**Hooks Création :**  
- src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/types.ts
- src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/useAgenceIndependanteCreation.ts

**Hooks Gestion :**  
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/types.ts
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAbonnementStripeView.ts
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData.ts
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteIntegrations.ts

**Composants Gestion :**  
- src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector.tsx

---

### 📍 Backend (Edge Functions)
`supabase/functions/`  
- supabase/functions/create-agence-independante-admin/index.ts
- supabase/functions/gestion-agence-independante-admin/index.ts
- supabase/functions/gestion-agence-independante-admin-donnees/index.ts
- supabase/functions/gestion-agence-independante-admin-fichiers/index.ts
- supabase/functions/gestion-agence-independante-admin-update/index.ts

Respecter le naming exact et la structure EF du modèle `reseau`.

---

## 🧩 Étape 4 — Bonnes pratiques générales

- **Service Role Key obligatoire** pour toutes les EF (jamais exposée côté front).  
- **Frontend** : clé **ANON** uniquement.  
- **Contrats de retour uniformisés** `{ success, data, message }`.  
- **Logs structurés** (`requestId`, `duration_ms`, `event`).  
- **Charte graphique** : interdiction de modifier la mise en page (labels, placeholders, styles).  
- **Atomicité** : toutes les EF doivent rollback en cas d’erreur partielle.  
- **Réplication** `agence_independante` → `agence_independante_responsable` obligatoire pour `email` et `telephone`.

---

## 🧠 Étape 5 — Ressources à analyser

- `Documents-Stratégiques-LeadGenAI.AdBuilder.zip`
- `TablesReferenceAgenceIndependante.ts`
- `004.FichiersPréparatoiresFormAgenceIndependante.zip`
- Hooks Supabase (`useAuth`, `useCurrentUser`, `useMultiTenant`, `useSupabaseOperations`)
- `2.INTEGRATION SUPABASE.zip`

---

📌 **But final :** disposer d’un formulaire complet “Agence Indépendante” avec un socle fonctionnel identique à celui du `reseau`,  
pour faire fonctionneer les pages
1.FormAgenceIndependanteAccueil.tsx
2.FormAgenceIndependanteCreation.tsx
3.FormAgenceIndependanteGestion.tsx
SuccessAccountInfo.tsx


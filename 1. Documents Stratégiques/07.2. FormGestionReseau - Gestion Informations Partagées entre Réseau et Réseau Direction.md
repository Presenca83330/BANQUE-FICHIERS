
# 7.1.2. Stratégie – Gestion des informations partagées entre **Réseau** et **Réseau Direction** dans le **Formulaire de Gestion**

> **Ce document est la copie conforme conceptuelle de la section 7.1.1 (création), adaptée au *formulaire de gestion*.**
> Il ne rentre pas dans l’implémentation code ; il formalise les **règles fonctionnelles**, les **invariants**, et la **gouvernance des données** côté Gestion.

---

## 🎯 Contexte & objectifs
- Le **Réseau** représente l’entité juridique (raison sociale, SIRET, adresse…).  
- Le **Réseau Direction** représente la personne responsable (nom, prénom, email, téléphone) qui **incarne** le réseau dans l’app et porte l’authentification (Supabase Auth).  
- À la **création** (voir 7.1.1), certaines valeurs sont **initialisées identiques** entre `reseau` et `reseau_direction` (email, téléphone) pour assurer la cohérence.  
- Dans le **formulaire de gestion**, le **Réseau** demeure le **point de vérité unique** (*single source of truth*) pour les coordonnées contractuelles (email, téléphone). Toute modification côté Réseau est **automatiquement propagée** vers `reseau_direction` (et les entités Auth associées).

**Objectif du formulaire de gestion :**
- Permettre la **mise à jour fiable** des données de `reseau`.
- **Propager** de manière atomique et traçable les champs **partagés** vers `reseau_direction` et Auth.  
- Conserver une **cohérence stricte** multi-tenant, sans divergence entre entité contractuelle (Réseau) et personne responsable (Direction).

---

## 🧩 Portée (scope) côté Gestion
- **Inclus :**
  - Mise à jour des données **organisationnelles** dans `reseau` : nom, identité commerciale, adresse/CP/ville, SIRET, email, téléphone.  
  - Propagation **automatique** des champs **email** et **téléphone** vers `reseau_direction` (et vers les artefacts liés à l’auth si nécessaire).  
  - Gestion des **intégrations** (Brevo, Zoho, OpenAI) **rattachées** au réseau.  
  - Gestion des **fichiers** du réseau (logo, documents institutionnels) avec un **mapping Storage** normé.

- **Exclus :**
  - L’édition directe des coordonnées côté **Réseau Direction** (lecture seule).  
  - La création/suppression d’utilisateurs (process dédié).  
  - Les migrations de structure de base de données (non traitées dans ce document).

---

## 🔒 Invariants & règles de cohérence
1. **Source de vérité**  
   - `reseau.reseau_email` et `reseau.reseau_telephone` sont **la** référence.  
   - `reseau_direction.email` et `reseau_direction.telephone` sont **synchronisés** depuis `reseau` (réplication descendante).  
   - Les écrans Direction sont **en lecture seule** pour ces champs.

2. **Propagation automatique** (Gestion → Direction)  
   - Toute MAJ de `reseau_email`/`reseau_telephone` via le **formulaire de gestion** déclenche :  
     - MAJ correspondante dans `reseau_direction` (via EF + triggers si présents).  
     - Optionnel : mise à jour des vues matérialisées / indexes liés.

3. **Atomicité & robustesse**  
   - Les opérations sensibles (update multi-tables) sont **atomiques** : soit tout passe, soit rien (rollback en cas d’erreur).  
   - Logs structurés et `requestId` pour tracer chaque traitement (EF).

4. **Sécurité & multi-tenant**  
   - Les **Edge Functions** utilisent **`SERVICE_ROLE_KEY`** (bypass RLS) et `verify_jwt=false` dans `config.toml`.  
   - Le **frontend** utilise la **clé ANON** et n’a **jamais** connaissance de la Service Role Key.  
   - Accès autorisés **exclusivement** via les EF publiées pour cet usage.

5. **Non-duplication & normalisation**  
   - Les champs « contractuels » (nom réseau, SIRET, adresse…) restent dans `reseau`.  
   - Les champs « personnels » (nom, prénom) restent dans `reseau_direction`.  
   - Email/Téléphone : **gérés** dans `reseau`, **répliqués** dans `reseau_direction`.

---

## 🗺️ Mapping fonctionnel (rappel)
| Champ | Table de référence | Réplication / Remarques |
|---|---|---|
| Nom Réseau | `reseau.reseau_nom` | Copie/affichage éventuel dans `organisations.organisation_nom` |
| Identité commerciale | `reseau.reseau_identite_commerciale` | Optionnel |
| SIRET | `reseau.reseau_siret` | — |
| Adresse / CP / Ville | `reseau.reseau_adresse`, `reseau.reseau_code_postal`, `reseau.reseau_ville` | — |
| **Email (contractuel)** | **`reseau.reseau_email`** | **Répliqué** → `reseau_direction.email` (lecture seule côté Direction) |
| **Téléphone (contractuel)** | **`reseau.reseau_telephone`** | **Répliqué** → `reseau_direction.telephone` (lecture seule côté Direction) |
| Logo / Documents | `reseau.reseau_logo`, `reseau.reseau_ressources[]` | Stockage normé (voir ci-dessous) |

---

## 🧱 Stockage fichiers – Norme obligatoire
- **Bucket** : `bucket-table-reseau`  
- **Chemins** :  
  - Logo : `reseau-{UUID}/1-logos/<timestamp>_<fichier>`  
  - Documents institutionnels : `reseau-{UUID}/2-documents-institutionnels/<timestamp>_<fichier>`
- **Règles** :  
  - Upload via EF **`gestion-reseau-admin-fichiers`** (multipart form).  
  - Suppression via EF **`gestion-reseau-admin-fichiers`** (POST JSON `action: delete`).  
  - La DB (`reseau_logo`, `reseau_ressources[]`) est **mise à jour** par l’EF.

---

## 🔌 Intégrations (Brevo, Zoho, OpenAI)
- Gérées via EF **`gestion-reseau-admin-update`**.  
- Si une connexion existe → **UPDATE** ; sinon → **INSERT** + **lien** dans `reseau` (FK).  
- **Atomicité** assurée et **retour standardisé** : `{ success, data: { reseau, integration }, message }`.

---

## 🔁 Flux fonctionnels (Gestion)
1. **Sélecteur Réseau**  
   - Front appelle EF **`gestion-reseau-admin`** (POST `{}`) → renvoie `{ success, data: [{ reseau_id, reseau_nom }...] }`.

2. **Chargement d’un réseau**  
   - Front appelle EF **`gestion-reseau-admin-donnees`** (POST `{ reseau_id }`) → renvoie `{ success, data: { reseau, integrations } }`.

3. **Mise à jour des infos générales**  
   - Front appelle EF **`gestion-reseau-admin-update`** (POST `{ reseauId, generalData }`)  
   - EF met à jour `reseau`, **puis** propage/cohérence Direction si champs partagés.  
   - Retour `{ success, data: { reseau, integration: null }, message }`.

4. **Mise à jour d’une intégration**  
   - Front → `gestion-reseau-admin-update` (POST `{ reseauId, integrationKind, integrationData }`)  
   - EF : update/insert intégration + lien FK dans `reseau`.  
   - Retour `{ success, data: { reseau: null|*, integration }, message }`.

5. **Upload / Delete fichiers**  
   - Upload : EF `gestion-reseau-admin-fichiers` (multipart : `file`, `fileType`, `reseau_id`) → MAJ DB.  
   - Delete : EF `gestion-reseau-admin-fichiers` (POST JSON `{ action:'delete', reseau_id, fileType, path }`) → MAJ DB + Storage.

---

## ✅ Règles d’UI (cohérence avec la Création)
- **3 onglets** : *Général*, *Intégrations*, *Fichiers*.  
- Les champs et placeholders **ne changent pas**, seule la **logique de propagation** est différente (création vs gestion).  
- Côté *Réseau Direction*, **lecture seule** pour email/téléphone ; édition **uniquement** via le formulaire Réseau.

---

## 🧪 Points de contrôle
- **Cohérence** : après chaque update Réseau (email/téléphone), vérifier Direction et Auth si applicable.  
- **Atomicité** : en cas d’erreur intégration ou lien FK, rollback → pas de « tombstones » orphelins.  
- **Traçabilité** : `requestId` dans les logs EF ; messages utilisateur clairs côté front.  
- **Sécurité** : jamais exposer la Service Role Key au frontend ; appels via EF uniquement.

---

## 🏁 Conclusion
Le **formulaire de gestion** consolide la vision « Réseau = point de vérité » pour les **coordonnées contractuelles** et maintient une **réplication descendante** vers `reseau_direction`.  
En gardant des **EF standardisées**, un **mapping Storage normé** et des **hooks front alignés**, on garantit :  
- une **donnée cohérente**,  
- une **expérience stable**,  
- et une **maintenabilité** alignée avec le formulaire de création.

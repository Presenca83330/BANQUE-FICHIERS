
# 7.1.2. StratÃ©gie â€“ Gestion des informations partagÃ©es entre **RÃ©seau** et **RÃ©seau Direction** dans le **Formulaire de Gestion**

> **Ce document est la copie conforme conceptuelle de la section 7.1.1 (crÃ©ation), adaptÃ©e au *formulaire de gestion*.**
> Il ne rentre pas dans lâ€™implÃ©mentation code ; il formalise les **rÃ¨gles fonctionnelles**, les **invariants**, et la **gouvernance des donnÃ©es** cÃ´tÃ© Gestion.

---

## ğŸ¯ Contexte & objectifs
- Le **RÃ©seau** reprÃ©sente lâ€™entitÃ© juridique (raison sociale, SIRET, adresseâ€¦).  
- Le **RÃ©seau Direction** reprÃ©sente la personne responsable (nom, prÃ©nom, email, tÃ©lÃ©phone) qui **incarne** le rÃ©seau dans lâ€™app et porte lâ€™authentification (Supabase Auth).  
- Ã€ la **crÃ©ation** (voir 7.1.1), certaines valeurs sont **initialisÃ©es identiques** entre `reseau` et `reseau_direction` (email, tÃ©lÃ©phone) pour assurer la cohÃ©rence.  
- Dans le **formulaire de gestion**, le **RÃ©seau** demeure le **point de vÃ©ritÃ© unique** (*single source of truth*) pour les coordonnÃ©es contractuelles (email, tÃ©lÃ©phone). Toute modification cÃ´tÃ© RÃ©seau est **automatiquement propagÃ©e** vers `reseau_direction` (et les entitÃ©s Auth associÃ©es).

**Objectif du formulaire de gestion :**
- Permettre la **mise Ã  jour fiable** des donnÃ©es de `reseau`.
- **Propager** de maniÃ¨re atomique et traÃ§able les champs **partagÃ©s** vers `reseau_direction` et Auth.  
- Conserver une **cohÃ©rence stricte** multi-tenant, sans divergence entre entitÃ© contractuelle (RÃ©seau) et personne responsable (Direction).

---

## ğŸ§© PortÃ©e (scope) cÃ´tÃ© Gestion
- **Inclus :**
  - Mise Ã  jour des donnÃ©es **organisationnelles** dans `reseau` : nom, identitÃ© commerciale, adresse/CP/ville, SIRET, email, tÃ©lÃ©phone.  
  - Propagation **automatique** des champs **email** et **tÃ©lÃ©phone** vers `reseau_direction` (et vers les artefacts liÃ©s Ã  lâ€™auth si nÃ©cessaire).  
  - Gestion des **intÃ©grations** (Brevo, Zoho, OpenAI) **rattachÃ©es** au rÃ©seau.  
  - Gestion des **fichiers** du rÃ©seau (logo, documents institutionnels) avec un **mapping Storage** normÃ©.

- **Exclus :**
  - Lâ€™Ã©dition directe des coordonnÃ©es cÃ´tÃ© **RÃ©seau Direction** (lecture seule).  
  - La crÃ©ation/suppression dâ€™utilisateurs (process dÃ©diÃ©).  
  - Les migrations de structure de base de donnÃ©es (non traitÃ©es dans ce document).

---

## ğŸ”’ Invariants & rÃ¨gles de cohÃ©rence
1. **Source de vÃ©ritÃ©**  
   - `reseau.reseau_email` et `reseau.reseau_telephone` sont **la** rÃ©fÃ©rence.  
   - `reseau_direction.email` et `reseau_direction.telephone` sont **synchronisÃ©s** depuis `reseau` (rÃ©plication descendante).  
   - Les Ã©crans Direction sont **en lecture seule** pour ces champs.

2. **Propagation automatique** (Gestion â†’ Direction)  
   - Toute MAJ de `reseau_email`/`reseau_telephone` via le **formulaire de gestion** dÃ©clenche :  
     - MAJ correspondante dans `reseau_direction` (via EF + triggers si prÃ©sents).  
     - Optionnel : mise Ã  jour des vues matÃ©rialisÃ©es / indexes liÃ©s.

3. **AtomicitÃ© & robustesse**  
   - Les opÃ©rations sensibles (update multi-tables) sont **atomiques** : soit tout passe, soit rien (rollback en cas dâ€™erreur).  
   - Logs structurÃ©s et `requestId` pour tracer chaque traitement (EF).

4. **SÃ©curitÃ© & multi-tenant**  
   - Les **Edge Functions** utilisent **`SERVICE_ROLE_KEY`** (bypass RLS) et `verify_jwt=false` dans `config.toml`.  
   - Le **frontend** utilise la **clÃ© ANON** et nâ€™a **jamais** connaissance de la Service Role Key.  
   - AccÃ¨s autorisÃ©s **exclusivement** via les EF publiÃ©es pour cet usage.

5. **Non-duplication & normalisation**  
   - Les champs Â« contractuels Â» (nom rÃ©seau, SIRET, adresseâ€¦) restent dans `reseau`.  
   - Les champs Â« personnels Â» (nom, prÃ©nom) restent dans `reseau_direction`.  
   - Email/TÃ©lÃ©phone : **gÃ©rÃ©s** dans `reseau`, **rÃ©pliquÃ©s** dans `reseau_direction`.

---

## ğŸ—ºï¸ Mapping fonctionnel (rappel)
| Champ | Table de rÃ©fÃ©rence | RÃ©plication / Remarques |
|---|---|---|
| Nom RÃ©seau | `reseau.reseau_nom` | Copie/affichage Ã©ventuel dans `organisations.organisation_nom` |
| IdentitÃ© commerciale | `reseau.reseau_identite_commerciale` | Optionnel |
| SIRET | `reseau.reseau_siret` | â€” |
| Adresse / CP / Ville | `reseau.reseau_adresse`, `reseau.reseau_code_postal`, `reseau.reseau_ville` | â€” |
| **Email (contractuel)** | **`reseau.reseau_email`** | **RÃ©pliquÃ©** â†’ `reseau_direction.email` (lecture seule cÃ´tÃ© Direction) |
| **TÃ©lÃ©phone (contractuel)** | **`reseau.reseau_telephone`** | **RÃ©pliquÃ©** â†’ `reseau_direction.telephone` (lecture seule cÃ´tÃ© Direction) |
| Logo / Documents | `reseau.reseau_logo`, `reseau.reseau_ressources[]` | Stockage normÃ© (voir ci-dessous) |

---

## ğŸ§± Stockage fichiers â€“ Norme obligatoire
- **Bucket** : `bucket-table-reseau`  
- **Chemins** :  
  - Logo : `reseau-{UUID}/1-logos/<timestamp>_<fichier>`  
  - Documents institutionnels : `reseau-{UUID}/2-documents-institutionnels/<timestamp>_<fichier>`
- **RÃ¨gles** :  
  - Upload via EF **`gestion-reseau-admin-fichiers`** (multipart form).  
  - Suppression via EF **`gestion-reseau-admin-fichiers`** (POST JSON `action: delete`).  
  - La DB (`reseau_logo`, `reseau_ressources[]`) est **mise Ã  jour** par lâ€™EF.

---

## ğŸ”Œ IntÃ©grations (Brevo, Zoho, OpenAI)
- GÃ©rÃ©es via EF **`gestion-reseau-admin-update`**.  
- Si une connexion existe â†’ **UPDATE** ; sinon â†’ **INSERT** + **lien** dans `reseau` (FK).  
- **AtomicitÃ©** assurÃ©e et **retour standardisÃ©** : `{ success, data: { reseau, integration }, message }`.

---

## ğŸ” Flux fonctionnels (Gestion)
1. **SÃ©lecteur RÃ©seau**  
   - Front appelle EF **`gestion-reseau-admin`** (POST `{}`) â†’ renvoie `{ success, data: [{ reseau_id, reseau_nom }...] }`.

2. **Chargement dâ€™un rÃ©seau**  
   - Front appelle EF **`gestion-reseau-admin-donnees`** (POST `{ reseau_id }`) â†’ renvoie `{ success, data: { reseau, integrations } }`.

3. **Mise Ã  jour des infos gÃ©nÃ©rales**  
   - Front appelle EF **`gestion-reseau-admin-update`** (POST `{ reseauId, generalData }`)  
   - EF met Ã  jour `reseau`, **puis** propage/cohÃ©rence Direction si champs partagÃ©s.  
   - Retour `{ success, data: { reseau, integration: null }, message }`.

4. **Mise Ã  jour dâ€™une intÃ©gration**  
   - Front â†’ `gestion-reseau-admin-update` (POST `{ reseauId, integrationKind, integrationData }`)  
   - EF : update/insert intÃ©gration + lien FK dans `reseau`.  
   - Retour `{ success, data: { reseau: null|*, integration }, message }`.

5. **Upload / Delete fichiers**  
   - Upload : EF `gestion-reseau-admin-fichiers` (multipart : `file`, `fileType`, `reseau_id`) â†’ MAJ DB.  
   - Delete : EF `gestion-reseau-admin-fichiers` (POST JSON `{ action:'delete', reseau_id, fileType, path }`) â†’ MAJ DB + Storage.

---

## âœ… RÃ¨gles dâ€™UI (cohÃ©rence avec la CrÃ©ation)
- **3 onglets** : *GÃ©nÃ©ral*, *IntÃ©grations*, *Fichiers*.  
- Les champs et placeholders **ne changent pas**, seule la **logique de propagation** est diffÃ©rente (crÃ©ation vs gestion).  
- CÃ´tÃ© *RÃ©seau Direction*, **lecture seule** pour email/tÃ©lÃ©phone ; Ã©dition **uniquement** via le formulaire RÃ©seau.

---

## ğŸ§ª Points de contrÃ´le
- **CohÃ©rence** : aprÃ¨s chaque update RÃ©seau (email/tÃ©lÃ©phone), vÃ©rifier Direction et Auth si applicable.  
- **AtomicitÃ©** : en cas dâ€™erreur intÃ©gration ou lien FK, rollback â†’ pas de Â« tombstones Â» orphelins.  
- **TraÃ§abilitÃ©** : `requestId` dans les logs EF ; messages utilisateur clairs cÃ´tÃ© front.  
- **SÃ©curitÃ©** : jamais exposer la Service Role Key au frontend ; appels via EF uniquement.

---

## ğŸ Conclusion
Le **formulaire de gestion** consolide la vision Â« RÃ©seau = point de vÃ©ritÃ© Â» pour les **coordonnÃ©es contractuelles** et maintient une **rÃ©plication descendante** vers `reseau_direction`.  
En gardant des **EF standardisÃ©es**, un **mapping Storage normÃ©** et des **hooks front alignÃ©s**, on garantit :  
- une **donnÃ©e cohÃ©rente**,  
- une **expÃ©rience stable**,  
- et une **maintenabilitÃ©** alignÃ©e avec le formulaire de crÃ©ation.

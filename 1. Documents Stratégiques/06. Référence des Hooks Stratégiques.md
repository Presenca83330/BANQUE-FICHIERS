# 📌 Référence des Hooks Stratégiques – LeadGenAi (Mise à jour)

## 🔐 N1 – useAuth
**Rôle :** Gère uniquement l’authentification Supabase.
- Connexion email/password.
- Connexion Google (sans signup).
- Déconnexion.
- Gestion centralisée des erreurs.
- État session (user, loading, error).

**Fichiers :**
- `authMessages.ts` → mappe les erreurs d’authentification en messages clairs.
- `authTypes.ts` → contient `AuthUser`, `AuthSession`, `AuthResponse`, `AuthResult`.  
  ⚠️ `AuthUser.email` est maintenant **optionnel** (`email?: string | null`).
- `useAuth.ts` → hook principal (login/logout/Google Auth, session).

**Dépendances :** `@/integrations/supabase/client`

---

## 👤 N2 – useCurrentUser
**Rôle :** Source de vérité sur le profil utilisateur enrichi.
- Charge d’abord `utilisateurs` (profil métier).
- Enrichit avec `users` (profil système).
- Vérifie statut actif (bloque inactifs/suspendus).
- Retourne un `CurrentUser` complet.

**Fichiers :**
- `helpers.ts` → utilitaires (normalizeEmail, isAdminPresenca, isOrganisationActive).
- `types.ts` → contient `CurrentUser` (aligné DB).  
  ⚠️ Le champ `utilisateur_role` a été supprimé (il n’existe pas dans la DB).
- `useCurrentUser.ts` → hook principal (profil enrichi, reload, erreurs).

**Dépendances :** `@/integrations/supabase/client`

---

## 🏢 N3 – useMultiTenant
**Rôle :** Décide des redirections post-login.
- Vérifie statut utilisateur et organisation.
- Routes définies :
  - `admin_presenca` / `superadmin` → `/admin-presenca`
  - `reseau` / `reseau_direction` → `/espace-reseau`
  - autres → `/accueil-leadgenai`
- Fallback → `/login`.

**Fichiers :**
- `useMultiTenant.ts` → hook principal (getPostLoginRoute).

**Dépendances :** `useCurrentUser`

---

## ⚙️ N4 – useSupabaseOperations
**Rôle :** Fournit une API CRUD générique sécurisée.
- `select` → lecture multi-tenant.
- `insert` → ajoute automatiquement organisation_id.
- `update` → sécurisé, vérifie statut actif.
- `remove` → suppression sécurisée.
- Gestion centralisée des erreurs.

**Fichiers :**
- `errors.ts` → mappe erreurs DB (RLS, permissions, org).
- `helpers.ts` → utilitaires (isEmpty, isSuspended, etc.).
- `tableMapping.ts` → mapping front → tables Supabase (toutes les tables de la base doivent être listées).
- `types.ts` → contient `OperationResult<T>`.
- `useSupabaseOperations.ts` → hook principal (CRUD générique).  
  ⚠️ Les appels à `supabase.from(tableName)` utilisent maintenant `supabase.from(tableName as any)` pour contourner les types stricts Supabase.

**Dépendances :** `useCurrentUser`, `@/integrations/supabase/client`

---

## 👥 Contexte – ImpersonationContext
**Rôle :** Permet à un admin (`admin_presenca`) d’agir au nom d’une autre organisation.
- Stocke l’organisation impersonnée dans le state et `localStorage`.
- Peut démarrer/arrêter une session d’impersonation.
- Restaure automatiquement une session si elle existe dans `localStorage`.

**Points clés :**
- Utilise `useAuth` (`user`).
- Utilise `useCurrentUser` (`roleSysteme`).
- Utilise `useSupabaseOperations.select` (⚠️ sans générique TypeScript).
- Vérifie `dbUser.roleSysteme === 'admin_presenca'` pour activer l’impersonation.

**Fichier :**
- `ImpersonationContext.tsx`

---

# ✅ Vue d’ensemble
- **useAuth** → gère la connexion/déconnexion uniquement.
- **useCurrentUser** → construit l’utilisateur enrichi (pivot métier).
- **useMultiTenant** → choisit la bonne route après connexion.
- **useSupabaseOperations** → centralise toutes les opérations DB multi-tenant.
- **ImpersonationContext** → consomme ces hooks pour gérer l’impersonation admin.

Chaque hook est simple, spécialisé, et validé ✅ pour une architecture **production-ready**.


# ğŸ“Œ RÃ©fÃ©rence des Hooks StratÃ©giques â€“ LeadGenAi (Mise Ã  jour)

## ğŸ” N1 â€“ useAuth
**RÃ´le :** GÃ¨re uniquement lâ€™authentification Supabase.
- Connexion email/password.
- Connexion Google (sans signup).
- DÃ©connexion.
- Gestion centralisÃ©e des erreurs.
- Ã‰tat session (user, loading, error).

**Fichiers :**
- `authMessages.ts` â†’ mappe les erreurs dâ€™authentification en messages clairs.
- `authTypes.ts` â†’ contient `AuthUser`, `AuthSession`, `AuthResponse`, `AuthResult`.  
  âš ï¸ `AuthUser.email` est maintenant **optionnel** (`email?: string | null`).
- `useAuth.ts` â†’ hook principal (login/logout/Google Auth, session).

**DÃ©pendances :** `@/integrations/supabase/client`

---

## ğŸ‘¤ N2 â€“ useCurrentUser
**RÃ´le :** Source de vÃ©ritÃ© sur le profil utilisateur enrichi.
- Charge dâ€™abord `utilisateurs` (profil mÃ©tier).
- Enrichit avec `users` (profil systÃ¨me).
- VÃ©rifie statut actif (bloque inactifs/suspendus).
- Retourne un `CurrentUser` complet.

**Fichiers :**
- `helpers.ts` â†’ utilitaires (normalizeEmail, isAdminPresenca, isOrganisationActive).
- `types.ts` â†’ contient `CurrentUser` (alignÃ© DB).  
  âš ï¸ Le champ `utilisateur_role` a Ã©tÃ© supprimÃ© (il nâ€™existe pas dans la DB).
- `useCurrentUser.ts` â†’ hook principal (profil enrichi, reload, erreurs).

**DÃ©pendances :** `@/integrations/supabase/client`

---

## ğŸ¢ N3 â€“ useMultiTenant
**RÃ´le :** DÃ©cide des redirections post-login.
- VÃ©rifie statut utilisateur et organisation.
- Routes dÃ©finies :
  - `admin_presenca` / `superadmin` â†’ `/admin-presenca`
  - `reseau` / `reseau_direction` â†’ `/espace-reseau`
  - autres â†’ `/accueil-leadgenai`
- Fallback â†’ `/login`.

**Fichiers :**
- `useMultiTenant.ts` â†’ hook principal (getPostLoginRoute).

**DÃ©pendances :** `useCurrentUser`

---

## âš™ï¸ N4 â€“ useSupabaseOperations
**RÃ´le :** Fournit une API CRUD gÃ©nÃ©rique sÃ©curisÃ©e.
- `select` â†’ lecture multi-tenant.
- `insert` â†’ ajoute automatiquement organisation_id.
- `update` â†’ sÃ©curisÃ©, vÃ©rifie statut actif.
- `remove` â†’ suppression sÃ©curisÃ©e.
- Gestion centralisÃ©e des erreurs.

**Fichiers :**
- `errors.ts` â†’ mappe erreurs DB (RLS, permissions, org).
- `helpers.ts` â†’ utilitaires (isEmpty, isSuspended, etc.).
- `tableMapping.ts` â†’ mapping front â†’ tables Supabase (toutes les tables de la base doivent Ãªtre listÃ©es).
- `types.ts` â†’ contient `OperationResult<T>`.
- `useSupabaseOperations.ts` â†’ hook principal (CRUD gÃ©nÃ©rique).  
  âš ï¸ Les appels Ã  `supabase.from(tableName)` utilisent maintenant `supabase.from(tableName as any)` pour contourner les types stricts Supabase.

**DÃ©pendances :** `useCurrentUser`, `@/integrations/supabase/client`

---

## ğŸ‘¥ Contexte â€“ ImpersonationContext
**RÃ´le :** Permet Ã  un admin (`admin_presenca`) dâ€™agir au nom dâ€™une autre organisation.
- Stocke lâ€™organisation impersonnÃ©e dans le state et `localStorage`.
- Peut dÃ©marrer/arrÃªter une session dâ€™impersonation.
- Restaure automatiquement une session si elle existe dans `localStorage`.

**Points clÃ©s :**
- Utilise `useAuth` (`user`).
- Utilise `useCurrentUser` (`roleSysteme`).
- Utilise `useSupabaseOperations.select` (âš ï¸ sans gÃ©nÃ©rique TypeScript).
- VÃ©rifie `dbUser.roleSysteme === 'admin_presenca'` pour activer lâ€™impersonation.

**Fichier :**
- `ImpersonationContext.tsx`

---

# âœ… Vue dâ€™ensemble
- **useAuth** â†’ gÃ¨re la connexion/dÃ©connexion uniquement.
- **useCurrentUser** â†’ construit lâ€™utilisateur enrichi (pivot mÃ©tier).
- **useMultiTenant** â†’ choisit la bonne route aprÃ¨s connexion.
- **useSupabaseOperations** â†’ centralise toutes les opÃ©rations DB multi-tenant.
- **ImpersonationContext** â†’ consomme ces hooks pour gÃ©rer lâ€™impersonation admin.

Chaque hook est simple, spÃ©cialisÃ©, et validÃ© âœ… pour une architecture **production-ready**.


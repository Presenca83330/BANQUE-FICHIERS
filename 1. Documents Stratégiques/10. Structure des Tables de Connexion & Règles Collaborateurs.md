# 11. Structure des Tables de Connexion & R√®gles Collaborateurs

## üéØ Objectif
- Garantir une isolation stricte entre **r√©seaux**, **agences r√©seau** et **agences ind√©pendantes**  
- Simplifier la gestion des **collaborateurs**  
- Renforcer la **s√©curit√© (RLS)** et la **tra√ßabilit√© (triggers d‚Äôaudit)**  

---

## üóÇÔ∏è Structure des tables de connexion

### Tables concern√©es
- `brevo_connexion`  
- `zoho_connexion`  
- `openai_connexion`  
- `facebook_connexion`  
- `instagram_connexion`  
- `linkedin_connexion`  

### Principes cl√©s
- **M√™me sch√©ma pour toutes les tables**  
  Chaque table est construite sur le m√™me mod√®le (coh√©rence et maintenabilit√©).  

- **Isolation stricte par FKs**  
  Une connexion appartient √† une seule entit√© :
  - `reseau_id` ‚Üí si c‚Äôest une connexion de r√©seau  
  - `reseau_agence_id` ‚Üí si c‚Äôest une connexion d‚Äôagence r√©seau  
  - `agence_indep_id` ‚Üí si c‚Äôest une connexion d‚Äôagence ind√©pendante  

  üëâ Une contrainte `CHECK` impose qu‚Äô**une seule** de ces trois colonnes soit renseign√©e.  

- **Colonnes techniques & audit**  
  - Colonnes sp√©cifiques √† chaque plateforme (ex. `brevo_api_key`, `zoho_region`, `openai_modeles_autorises`, etc.)  
  - Colonnes d‚Äôaudit (`*_created_at`, `*_updated_at`, `*_created_by`, `*_updated_by`)  
  - Triggers automatiques pour remplir et mettre √† jour ces champs  

---

## üë§ R√®gles collaborateurs

### 1. Autorisations bool√©ennes
Dans les tables `reseau_agence_collaborateur` et `agence_independante_collaborateur`, 6 colonnes g√®rent les droits :  

- `acces_brevo`  
- `acces_zoho`  
- `acces_openai`  
- `acces_facebook`  
- `acces_instagram`  
- `acces_linkedin`  

üëâ Par d√©faut, tout est `false`.  
üëâ Le responsable peut activer/d√©sactiver ces acc√®s.  

---

### 2. H√©ritage logique
- **R√©seau Direction** ‚Üí utilise les connexions du r√©seau  
- **Responsable Agence R√©seau** ‚Üí utilise les connexions de son agence  
- **Responsable Agence Ind√©pendante** ‚Üí utilise les connexions de son agence  
- **Collaborateurs** ‚Üí utilisent uniquement ce qui est autoris√© par leur agence  

---

### 3. Acc√®s s√©curis√©
Une fonction helper `has_collaborator_connection_access()` permet de v√©rifier c√¥t√© back-end si un collaborateur a le droit d‚Äôutiliser une plateforme donn√©e.  

üëâ Cela √©vite tout affichage des codes API dans l‚Äôinterface collaborateur.  

---

## üîê S√©curit√© et RLS

### RLS policies par d√©faut
- Un r√©seau ne peut voir que **ses propres connexions**  
- Une agence r√©seau ne peut voir que **ses propres connexions**  
- Une agence ind√©pendante ne peut voir que **ses propres connexions**  

### Fonction helper `has_connection_access()`
Centralise la logique pour √©viter la duplication dans chaque policy.  

### Admin PRESENCA
R√®gle sp√©ciale : acc√®s complet √† toutes les connexions via la fonction `is_admin_presenca(auth.uid())`.  

---

## ‚úÖ Avantages de la structure
- **Clart√©** : une connexion = un propri√©taire unique  
- **S√©curit√©** : isolation stricte garantie entre r√©seaux, agences r√©seau et agences ind√©pendantes  
- **Simplicit√©** : gestion des collaborateurs avec seulement 6 bool√©ens  
- **Tra√ßabilit√©** : triggers d‚Äôaudit assurent un suivi complet  
- **√âvolutivit√©** : facile d‚Äôajouter une nouvelle plateforme (nouvelle table + nouvelle colonne bool√©enne)  

---

## üìå Usage futur
Cette nouvelle structure servira de base :  
- au **formulaire de gestion r√©seau**  
- puis aux futurs formulaires de **cr√©ation et gestion** de toutes les entit√©s dans  
  `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs`  

üëâ En garantissant que les r√®gles m√©tier (**isolation + autorisations**) sont respect√©es partout.  

---
erDiagram

    %% ============================
    %% ENTIT√âS M√âTIER
    %% ============================
    RESEAU ||--o{ BREVO_CONNEXION : "poss√®de"
    RESEAU ||--o{ ZOHO_CONNEXION : "poss√®de"
    RESEAU ||--o{ OPENAI_CONNEXION : "poss√®de"
    RESEAU ||--o{ FACEBOOK_CONNEXION : "poss√®de"
    RESEAU ||--o{ INSTAGRAM_CONNEXION : "poss√®de"
    RESEAU ||--o{ LINKEDIN_CONNEXION : "poss√®de"

    RESEAU_AGENCE ||--o{ BREVO_CONNEXION : "poss√®de"
    RESEAU_AGENCE ||--o{ ZOHO_CONNEXION : "poss√®de"
    RESEAU_AGENCE ||--o{ OPENAI_CONNEXION : "poss√®de"
    RESEAU_AGENCE ||--o{ FACEBOOK_CONNEXION : "poss√®de"
    RESEAU_AGENCE ||--o{ INSTAGRAM_CONNEXION : "poss√®de"
    RESEAU_AGENCE ||--o{ LINKEDIN_CONNEXION : "poss√®de"

    AGENCE_INDEP ||--o{ BREVO_CONNEXION : "poss√®de"
    AGENCE_INDEP ||--o{ ZOHO_CONNEXION : "poss√®de"
    AGENCE_INDEP ||--o{ OPENAI_CONNEXION : "poss√®de"
    AGENCE_INDEP ||--o{ FACEBOOK_CONNEXION : "poss√®de"
    AGENCE_INDEP ||--o{ INSTAGRAM_CONNEXION : "poss√®de"
    AGENCE_INDEP ||--o{ LINKEDIN_CONNEXION : "poss√®de"

    %% ============================
    %% COLLABORATEURS
    %% ============================
    RESEAU_AGENCE ||--o{ COLLAB_RESEAU_AGENCE : "a des"
    AGENCE_INDEP ||--o{ COLLAB_AGENCE_INDEP : "a des"

    COLLAB_RESEAU_AGENCE {
        uuid id
        boolean acces_brevo
        boolean acces_zoho
        boolean acces_openai
        boolean acces_facebook
        boolean acces_instagram
        boolean acces_linkedin
    }

    COLLAB_AGENCE_INDEP {
        uuid id
        boolean acces_brevo
        boolean acces_zoho
        boolean acces_openai
        boolean acces_facebook
        boolean acces_instagram
        boolean acces_linkedin
    }

    %% ============================
    %% TABLES DE CONNEXIONS (exemple Brevo)
    %% ============================
    BREVO_CONNEXION {
        uuid id
        uuid organisation_id
        uuid reseau_id
        uuid reseau_agence_id
        uuid agence_indep_id
        text api_key
        text email_compte
        text nom_compte
        boolean actif
        text statut_connexion
        timestamptz created_at
        timestamptz updated_at
        uuid created_by
        uuid updated_by
    }

    ZOHO_CONNEXION {
        uuid id
        uuid organisation_id
        uuid reseau_id
        uuid reseau_agence_id
        uuid agence_indep_id
        text api_key
        text email_compte
        text nom_compte
        boolean actif
        text statut_connexion
    }

    OPENAI_CONNEXION {
        uuid id
        uuid organisation_id
        uuid reseau_id
        uuid reseau_agence_id
        uuid agence_indep_id
        text api_key
        text email_compte
        text organisation_id_ext
        text project_id
        text[] modeles_autorises
        boolean actif
        text statut_connexion
    }

    FACEBOOK_CONNEXION {
        uuid id
        uuid organisation_id
        uuid reseau_id
        uuid reseau_agence_id
        uuid agence_indep_id
        text connexion_key
        text email_compte
        text access_token
        boolean actif
        text statut_connexion
    }

    INSTAGRAM_CONNEXION {
        uuid id
        uuid organisation_id
        uuid reseau_id
        uuid reseau_agence_id
        uuid agence_indep_id
        text connexion_key
        text email_compte
        text access_token
        boolean actif
        text statut_connexion
    }

    LINKEDIN_CONNEXION {
        uuid id
        uuid organisation_id
        uuid reseau_id
        uuid reseau_agence_id
        uuid agence_indep_id
        text connexion_key
        text email_compte
        text access_token
        boolean actif
        text statut_connexion
    }

---

| Entit√©                                | Int√©grations possibles                                               | Donn√©es d‚Äôacc√®s        | Espace                                                             | Acc√®s Plateforme  |
| ------------------------------------- | -------------------------------------------------------------------- | ---------------------- | ------------------------------------------------------------------ | ----------------- |
| **R√©seau**                            | Brevo, Zoho, OpenAI                                                  | Oui (propres)          | RESEAU-ESPACE : voit et peut modifier                              | Oui               |
| **R√©seau Direction**                  | H√©rite des donn√©es du r√©seau                                         | Oui                    | RESEAU-ESPACE : voit et peut modifier                              | Oui               |
| **Agence R√©seau**                     | Brevo, Zoho, OpenAI, Facebook, Instagram, LinkedIn                   | Oui (propres)          | CLIENT-ESPACE : voit et peut modifier                              | Oui               |
| **Agence R√©seau Responsable**         | H√©rite des donn√©es de son agence                                     | Oui                    | CLIENT-ESPACE : voit et peut modifier                              | Oui               |
| **Agence R√©seau Collaborateur**       | Pas d‚Äôacc√®s par d√©faut. Peut √™tre autoris√© par agence ou responsable | Non (jamais les codes) | COLLABORATEUR-ESPACE : ne voit pas les codes, ne peut pas modifier | Oui (si autoris√©) |
| **Agence Ind√©pendante**               | Brevo, Zoho, OpenAI, Facebook, Instagram, LinkedIn                   | Oui (propres)          | CLIENT-ESPACE : voit et peut modifier                              | Oui               |
| **Agence Ind√©pendante Responsable**   | H√©rite des donn√©es de son agence                                     | Oui                    | CLIENT-ESPACE : voit et peut modifier                              | Oui               |
| **Agence Ind√©pendante Collaborateur** | Pas d‚Äôacc√®s par d√©faut. Peut √™tre autoris√© par agence ou responsable | Non (jamais les codes) | COLLABORATEUR-ESPACE : ne voit pas les codes, ne peut pas modifier | Oui (si autoris√©) |

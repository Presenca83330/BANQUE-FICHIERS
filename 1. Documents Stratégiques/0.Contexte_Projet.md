# 0. Contexte Projet – LeadGenAI
📅 Dernière mise à jour : 03/09/2025

## 1. État actuel des Hooks Stratégiques
Nous avons **4 hooks stratégiques** validés et utilisés comme fondation :

- **useAuth** → Gestion authentification (Supabase + erreurs + session)
- **useCurrentUser** → Profil enrichi (fusion `users` + `utilisateurs`)
- **useMultiTenant** → Redirections post-login (admin / réseau / agences)
- **useSupabaseOperations** → CRUD génériques multi-tenant (organisation_id auto-ajouté)

📌 Tous ces hooks sont stables et documentés dans  
`5. Référence des Hooks Stratégiques.md`.

---

## 2. État des Tables Stratégiques (Post-migrations)

### Table `users`
- ✅ Colonnes : `users_id`, `users_auth_id`, `users_email`, `users_nom`, `users_prenom`, `users_telephone`, `users_organisation_id`, `users_role_systeme`, `users_created_at`
- ❌ Supprimés : `users_role`, `users_interface_par_defaut`
- ✅ Contrainte : `users_role_systeme` = `'admin_presenca'` OU `NULL`

### Table `utilisateurs`
- ✅ Colonnes : incluent `utilisateur_type_compte`, `utilisateur_role_systeme`, `utilisateur_statut`
- ❌ Nettoyage effectué : plus de `superadmin` / `support` dans `utilisateur_role_systeme`
- ✅ Extension prévue pour `utilisateur_type_compte` :
  - `reseau`
  - `reseau_direction`
  - `reseau_agence`
  - `reseau_agence_responsable`
  - `reseau_agence_collaborateur`
  - `agence_independante`
  - `agence_independante_responsable`
  - `agence_independante_collaborateur`

### Table `organisations`
- ✅ Colonnes principales : `organisation_id`, `organisation_nom`, `organisation_statut_compte`, `organisation_statut_paiement`, etc.
- ❌ Doublons de contraintes CHECK supprimés
- ✅ Statuts restants :
  - `organisation_statut_compte` : `actif`, `suspendu`, `desactive`, `NULL`
  - `organisation_statut_paiement` : `a_jour`, `en_retard`, `annule`, `NULL`

---

## 3. Stratégie Rôles et Multi-Tenant

### Rôle Système
- **Un seul rôle système conservé :** `admin_presenca`  
- Utilisé pour : RLS policies, fonctions `is_admin_presenca()`, impersonation.

### Rôles Métiers
- Portés exclusivement par `utilisateur_type_compte` (pas dans `users`) :
  - Réseau et sous-structures (`reseau`, `reseau_direction`, `reseau_agence`, etc.)
  - Agences indépendantes et sous-structures (`agence_independante`, etc.)

### Redirections (useMultiTenant)
- `admin_presenca` → `/admin-presenca`
- `reseau`, `reseau_direction` → `/espace-reseau`
- Tout le reste (`agences`, `responsables`, `collaborateurs`) → `/accueil-leadgenai`

---

## 4. Sécurité et RLS
- ✅ **RLS activé** sur toutes les tables stratégiques
- ✅ **Fonctions sécurisées :**
  - `is_admin_presenca(auth.uid())` (pivot central de toutes les policies)
  - `get_user_organisation_id()`
- ✅ **Triggers actifs** (audit + sync bidirectionnelle `users` ↔ `utilisateurs`)

---

## 5. Roadmap (Prochaines étapes)

1. **Nettoyage UI Admin**
   - Supprimer la section *Support* inutile (menu, composants).
   
2. **Formulaires Utilisateurs**
   - Étendre `FormulaireUtilisateur.tsx` pour intégrer **tous** les `utilisateur_type_compte`.
   - Adapter validations et sélecteurs.

3. **Tests fonctionnels**
   - Vérifier redirections post-login (`useMultiTenant`)
   - Tester création utilisateurs avec nouveaux `type_compte`
   - Vérifier RLS par organisation

---

## 6. Points de vigilance
- ✅ Base de données simplifiée (plus de `superadmin`, `support`, `users_role`)
- ✅ Cohérence maintenue entre `users` et `utilisateurs`
- ⚠️ Attention à mettre à jour les formulaires avant d’insérer de nouveaux types de comptes
- ⚠️ Penser à maintenir la doc (relations entre tables, rôles, hooks)

---

📌 **Conclusion**
La base et les hooks sont maintenant stables et simplifiés.  
Prochaine grande étape = **refactor des formulaires utilisateurs** pour refléter les vrais cas métiers.  

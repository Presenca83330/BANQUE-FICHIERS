# 0. Contexte Projet â€“ LeadGenAI
ğŸ“… DerniÃ¨re mise Ã  jour : 03/09/2025

## 1. Ã‰tat actuel des Hooks StratÃ©giques
Nous avons **4 hooks stratÃ©giques** validÃ©s et utilisÃ©s comme fondation :

- **useAuth** â†’ Gestion authentification (Supabase + erreurs + session)
- **useCurrentUser** â†’ Profil enrichi (fusion `users` + `utilisateurs`)
- **useMultiTenant** â†’ Redirections post-login (admin / rÃ©seau / agences)
- **useSupabaseOperations** â†’ CRUD gÃ©nÃ©riques multi-tenant (organisation_id auto-ajoutÃ©)

ğŸ“Œ Tous ces hooks sont stables et documentÃ©s dans  
`5. RÃ©fÃ©rence des Hooks StratÃ©giques.md`.

---

## 2. Ã‰tat des Tables StratÃ©giques (Post-migrations)

### Table `users`
- âœ… Colonnes : `users_id`, `users_auth_id`, `users_email`, `users_nom`, `users_prenom`, `users_telephone`, `users_organisation_id`, `users_role_systeme`, `users_created_at`
- âŒ SupprimÃ©s : `users_role`, `users_interface_par_defaut`
- âœ… Contrainte : `users_role_systeme` = `'admin_presenca'` OU `NULL`

### Table `utilisateurs`
- âœ… Colonnes : incluent `utilisateur_type_compte`, `utilisateur_role_systeme`, `utilisateur_statut`
- âŒ Nettoyage effectuÃ© : plus de `superadmin` / `support` dans `utilisateur_role_systeme`
- âœ… Extension prÃ©vue pour `utilisateur_type_compte` :
  - `reseau`
  - `reseau_direction`
  - `reseau_agence`
  - `reseau_agence_responsable`
  - `reseau_agence_collaborateur`
  - `agence_independante`
  - `agence_independante_responsable`
  - `agence_independante_collaborateur`

### Table `organisations`
- âœ… Colonnes principales : `organisation_id`, `organisation_nom`, `organisation_statut_compte`, `organisation_statut_paiement`, etc.
- âŒ Doublons de contraintes CHECK supprimÃ©s
- âœ… Statuts restants :
  - `organisation_statut_compte` : `actif`, `suspendu`, `desactive`, `NULL`
  - `organisation_statut_paiement` : `a_jour`, `en_retard`, `annule`, `NULL`

---

## 3. StratÃ©gie RÃ´les et Multi-Tenant

### RÃ´le SystÃ¨me
- **Un seul rÃ´le systÃ¨me conservÃ© :** `admin_presenca`  
- UtilisÃ© pour : RLS policies, fonctions `is_admin_presenca()`, impersonation.

### RÃ´les MÃ©tiers
- PortÃ©s exclusivement par `utilisateur_type_compte` (pas dans `users`) :
  - RÃ©seau et sous-structures (`reseau`, `reseau_direction`, `reseau_agence`, etc.)
  - Agences indÃ©pendantes et sous-structures (`agence_independante`, etc.)

### Redirections (useMultiTenant)
- `admin_presenca` â†’ `/admin-presenca`
- `reseau`, `reseau_direction` â†’ `/espace-reseau`
- Tout le reste (`agences`, `responsables`, `collaborateurs`) â†’ `/accueil-leadgenai`

---

## 4. SÃ©curitÃ© et RLS
- âœ… **RLS activÃ©** sur toutes les tables stratÃ©giques
- âœ… **Fonctions sÃ©curisÃ©es :**
  - `is_admin_presenca(auth.uid())` (pivot central de toutes les policies)
  - `get_user_organisation_id()`
- âœ… **Triggers actifs** (audit + sync bidirectionnelle `users` â†” `utilisateurs`)

---

## 5. Roadmap (Prochaines Ã©tapes)

1. **Nettoyage UI Admin**
   - Supprimer la section *Support* inutile (menu, composants).
   
2. **Formulaires Utilisateurs**
   - Ã‰tendre `FormulaireUtilisateur.tsx` pour intÃ©grer **tous** les `utilisateur_type_compte`.
   - Adapter validations et sÃ©lecteurs.

3. **Tests fonctionnels**
   - VÃ©rifier redirections post-login (`useMultiTenant`)
   - Tester crÃ©ation utilisateurs avec nouveaux `type_compte`
   - VÃ©rifier RLS par organisation

---

## 6. Points de vigilance
- âœ… Base de donnÃ©es simplifiÃ©e (plus de `superadmin`, `support`, `users_role`)
- âœ… CohÃ©rence maintenue entre `users` et `utilisateurs`
- âš ï¸ Attention Ã  mettre Ã  jour les formulaires avant dâ€™insÃ©rer de nouveaux types de comptes
- âš ï¸ Penser Ã  maintenir la doc (relations entre tables, rÃ´les, hooks)

---

ğŸ“Œ **Conclusion**
La base et les hooks sont maintenant stables et simplifiÃ©s.  
Prochaine grande Ã©tape = **refactor des formulaires utilisateurs** pour reflÃ©ter les vrais cas mÃ©tiers.  

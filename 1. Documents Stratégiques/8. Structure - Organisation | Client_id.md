# Structure Organisation | Client_id – LeadGenAI AdBuilder

## Vue d’ensemble
Notre architecture multi-tenant repose sur deux identifiants complémentaires :
- organisation_id : conteneur de sécurité et d’isolation (niveau tenant).
- client_id : identifiant métier stable et lisible, pour la traçabilité et la gestion business.

Cette séparation claire permet :
- Une sécurité robuste par organisation.
- Une traçabilité granulaire des entités métiers (réseaux, agences, collaborateurs, etc.).
- Une scalabilité et une flexibilité commerciale (facturation, analytics, permissions métier).

## Architecture multi-tenant à deux niveaux
- Niveau 1 : organisation_id (tenant principal).
  - Rôle : cloisonnement et isolation stricte des données.
  - Portée : RLS, authentification, hooks stratégiques.
  - Cardinalité : une organisation correspond à une entité juridique ou commerciale.
- Niveau 2 : client_id (sous-entités business).
  - Rôle : identifiant métier stable et lisible.
  - Portée : traçabilité métier, analytics, facturation, reporting.
  - Cardinalité : plusieurs client_id par organisation (direction, agence, collaborateur, etc.).

## Analyse des tables Supabase
### Tables avec génération automatique de client_id (UUID)
- Entités principales
  - reseau
  - agence_independante
- Entités de personnel
  - reseau_direction
  - reseau_agence
  - reseau_agence_responsable
  - reseau_agence_collaborateur
  - agence_independante_responsable
  - agence_independante_collaborateur

### Tables avec client_id manuel (référence vers entité parente)
- brevo_connexion
- facebook_connexion
- instagram_connexion
- linkedin_connexion
- openai_connexion
- zoho_connexion

Points d’attention sur le pattern identifié :
- Entités business : client_id auto-généré, identifiant unique et traçable dans l’organisation.
- Connexions externes : client_id manuel, rattachement explicite à l’entité parente.

## Rôle du client_id
- Identifiant métier lisible et stable, utilisé dans toutes les tables clients.
- Distinct des UUID techniques (utilisateur_id, organisation_id, etc.) : sert d’identifiant fonctionnel pour les formulaires, exports, dashboards et intégrations (IA, CRM, API externes).
- En clair : UUID = clé interne pour Supabase ; client_id = clé métier utilisée par l’application et les agents IA.

## Logique architecturale
- organisation_id : conteneur parent qui sécurise et isole les données.
- client_id : identifiant métier stable qui distingue les sous-entités au sein du même tenant.

## Sécurité et RLS
- Isolation stricte : chaque table métier est protégée par une RLS basée sur organisation_id.
- Admin PRESENCA : accès transversal à toutes les organisations via is_admin_presenca().
- Le champ client_id n’intervient pas dans les règles de sécurité ; il demeure un identifiant business et n’est jamais une barrière de sécurité.

## Règles stratégiques à respecter
- Séparation stricte des rôles :
  - organisation_id : sécurité, cloisonnement, RLS.
  - client_id : identification business et traçabilité.
- Pourquoi placer client_id dans toutes les tables clients :
  - Toutes les structures (réseaux, agences réseau, agences indépendantes, collaborateurs, responsables, etc.) doivent être reliées à une organisation et disposer d’une référence métier unique.
  - client_id assure un lien transversal et sert de pivot stable pour éviter que l’UUID change ou soit opaque.
  - Garantit une référence métier stable et lisible.
  - Homogénéise le modèle pour éviter une dépendance aux UUID internes.
  - Sert de pivot pour formulaires, exports, API externes et agents IA.
- Règle stratégique obligatoire pour toute nouvelle table métier :
  - Contenir un organisation_id (clé étrangère vers organisations, sécurité RLS).
  - Contenir un client_id (UUID métier auto-généré ou manuel, identification business).

## Relation entre organisation_id et client_id
- Chaque table cliente contient à la fois un organisation_id (clé étrangère technique vers organisations) et un client_id (identifiant métier).
- Cela garantit à la fois l’isolation multi-tenant (via organisation_id) et la traçabilité lisible pour l’application métier (via client_id).
- organisation_id : conteneur technique et sécuritaire.
- client_id : identifiant métier stable à l’intérieur du conteneur.

Image mentale utile :
- organisation_id : maison mère (le conteneur global qui sécurise tout).
- client_id : pièces de la maison (sous-unités identifiables et traçables à l’intérieur).

## Relation hiérarchique clarifiée
- Organisation.
- Réseau.
- Direction.
- Agence.
- Agence responsable.
- Agence collaborateur.
- Chaque niveau possède son propre client_id, toujours rattaché à l’organisation_id parent.

## Synthèse exécutive
- Sécurité robuste : isolation stricte par organisation.
- Flexibilité business : granularité client_id pour facturation et analytics.
- Scalabilité : modèle homogène, extensible, sans doublon.
- Règle claire : chaque table métier doit contenir organisation_id et client_id.

En résumé :
- Le client_id est présent partout pour homogénéiser le modèle métier.
- Il ne fait pas doublon avec organisation_id car ils servent à des usages différents :
  - organisation_id : cloisonnement multi-tenant et clé étrangère technique.
  - client_id : identifiant métier stable, utilisé dans les workflows applicatifs.

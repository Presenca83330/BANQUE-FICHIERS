# Structure Organisation | Client_id â€“ LeadGenAI AdBuilder

## Vue dâ€™ensemble
Notre architecture multi-tenant repose sur deux identifiants complÃ©mentaires :

- **organisation_id** : conteneur de sÃ©curitÃ© et dâ€™isolation (niveau tenant).  
- **client_id** : identifiant mÃ©tier stable et lisible, pour la traÃ§abilitÃ© et la gestion business.  

Cette sÃ©paration claire permet :  
- Une **sÃ©curitÃ© robuste** par organisation.  
- Une **traÃ§abilitÃ© granulaire** des entitÃ©s mÃ©tiers (rÃ©seaux, agences, collaborateurs, etc.).  
- Une **scalabilitÃ©** et une flexibilitÃ© commerciale (analytics, permissions mÃ©tier).  

---

## Architecture multi-tenant Ã  deux niveaux
### Niveau 1 : organisation_id (tenant principal)
- **RÃ´le** : cloisonnement et isolation stricte des donnÃ©es  
- **PortÃ©e** : RLS, authentification, hooks stratÃ©giques  
- **CardinalitÃ©** : une organisation correspond Ã  une entitÃ© juridique ou commerciale  

### Niveau 2 : client_id (sous-entitÃ©s business)
- **RÃ´le** : identifiant mÃ©tier stable et lisible  
- **PortÃ©e** : traÃ§abilitÃ© mÃ©tier, analytics, reporting, facturation  
- **CardinalitÃ©** : plusieurs `client_id` par organisation (direction, agence, collaborateur, etc.)  

---

## Analyse des tables Supabase

### Tables avec gÃ©nÃ©ration automatique de client_id (UUID)
#### EntitÃ©s principales
- reseau  
- agence_independante  

#### EntitÃ©s de personnel
- reseau_direction  
- reseau_agence  
- reseau_agence_responsable  
- reseau_agence_collaborateur  
- agence_independante_responsable  
- agence_independante_collaborateur  

ğŸ‘‰ Chaque entitÃ© mÃ©tier est identifiable par :  
- `organisation_id` (isolation sÃ©curitaire)  
- `client_id` (identifiant mÃ©tier stable et traÃ§able)  

### Tables de connexion (sans client_id)
- brevo_connexion  
- facebook_connexion  
- instagram_connexion  
- linkedin_connexion  
- openai_connexion  
- zoho_connexion  

ğŸ‘‰ ParticularitÃ© :  
- Pas de `client_id` dans ces tables  
- Rattachement exclusif via les FK directs :  
  - `reseau_id`  
  - `reseau_agence_id`  
  - `agence_indep_id`  
- Une contrainte `CHECK` impose quâ€™un seul FK soit dÃ©fini â†’ isolation stricte garantie  
- `organisation_id` reste prÃ©sent pour assurer le cloisonnement multi-tenant  

---

## RÃ´le du client_id
- **Identifiant mÃ©tier lisible et stable**, utilisÃ© dans toutes les tables **clients**  
- Distinct des UUID techniques (`utilisateur_id`, `organisation_id`, etc.)  
- Sert dâ€™**identifiant fonctionnel** pour :  
  - les formulaires  
  - les exports  
  - les dashboards  
  - les intÃ©grations (IA, CRM, API externes)  

ğŸ‘‰ En clair :  
- `UUID` = clÃ© interne Supabase  
- `client_id` = clÃ© mÃ©tier utilisÃ©e par lâ€™application et les agents IA  

---

## Logique architecturale
- **organisation_id** : conteneur parent qui sÃ©curise et isole les donnÃ©es  
- **client_id** : identifiant mÃ©tier stable qui distingue les sous-entitÃ©s au sein du mÃªme tenant  

### Image mentale utile
- organisation_id = la maison mÃ¨re (le conteneur global qui sÃ©curise tout)  
- client_id = les piÃ¨ces de la maison (sous-unitÃ©s identifiables et traÃ§ables Ã  lâ€™intÃ©rieur)  

---

## SÃ©curitÃ© et RLS
- **Isolation stricte** : chaque table mÃ©tier est protÃ©gÃ©e par une RLS basÃ©e sur `organisation_id`  
- **Tables de connexion** : isolation garantie par FKs directs + contrainte `CHECK`  
- **Admin PRESENCA** : accÃ¨s transversal Ã  toutes les organisations via `is_admin_presenca()`  
- ğŸ‘‰ Le champ `client_id` nâ€™intervient pas dans les rÃ¨gles de sÃ©curitÃ©, il reste un identifiant business.  

---

## RÃ¨gles stratÃ©giques Ã  respecter
1. **SÃ©paration stricte des rÃ´les**  
   - `organisation_id` : sÃ©curitÃ©, cloisonnement, RLS  
   - `client_id` : identification business et traÃ§abilitÃ©  

2. **Toutes les entitÃ©s business** doivent Ãªtre reliÃ©es Ã  une organisation et disposer dâ€™une rÃ©fÃ©rence mÃ©tier unique (`client_id`).  

3. **Les tables de connexion** ne contiennent pas de `client_id`.  
   - Leur rattachement se fait exclusivement par FKs directs (`reseau_id`, `reseau_agence_id`, `agence_indep_id`).  
   - Une seule de ces colonnes peut Ãªtre renseignÃ©e.  

---

## Relation hiÃ©rarchique clarifiÃ©e
### 1. RÃ©seaux
- RÃ©seau  
- Direction rÃ©seau  
- Agence rÃ©seau  
- Agence rÃ©seau responsable  
- Agence rÃ©seau collaborateur  

### 2. Agences indÃ©pendantes
- Agence indÃ©pendante  
- Agence indÃ©pendante responsable  
- Agence indÃ©pendante collaborateur  

ğŸ‘‰ Chaque niveau possÃ¨de son propre `client_id` (sauf les tables de connexion qui utilisent les FKs directs).  

---

## SynthÃ¨se exÃ©cutive
- **SÃ©curitÃ© robuste** : isolation stricte par `organisation_id`  
- **FlexibilitÃ© business** : granularitÃ© via `client_id` pour facturation et analytics  
- **ScalabilitÃ©** : modÃ¨le homogÃ¨ne, extensible, sans doublon  
- **RÃ¨gle claire** :  
  - Chaque table mÃ©tier contient `organisation_id` et `client_id`  
  - Chaque table de connexion contient `organisation_id` + FK directs (pas de `client_id`)  

ğŸ‘‰ En rÃ©sumÃ© :  
- `organisation_id` = cloisonnement multi-tenant et clÃ© technique  
- `client_id` = identifiant mÃ©tier stable, utilisÃ© dans tous les workflows applicatifs  

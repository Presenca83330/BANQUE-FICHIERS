# Ok 
---
- Bonjour expert Ia, no code, intégration supabase
  - J'ai besoin de toi concernant mon projet actuel de migration de mon application Lovable en localstorage vers Supabase
  - Avant de te poser ma question, il est impératif que je te redonne toutes les infos et ressources pour avoir tout le contexte à ta disposition
  - Je vais te donner mes ressources et infos en 4 étapes :
    - ETAPE 1 -> ANALYSE DE MON APPLICATION EN MODE LOCALSTORAGE
    - ETAPE 2 -> COMPRENDRE MA STRATEGIE DE MIGRATION
    - ETAPE 3 -> POINT SUR LA MIGRATION
    - ETAPE 4 -> NOTRE MISSION DE CE JOUR
---
# **ETAPE 1 - ANALYSE DE MON APPLICATION EN MODE LOCALSTORAGE**
---
**DIRECTIVE 1/ Lis et Analyse les Docs Stratégiques**
  - Pour mener ta mission, tu dois avoir une vision complète de mon application commence par lire les documents suivants :
      - public/1. Documents Stratégiques/01. Présentation LeadGenAi.md
      - public/1. Documents Stratégiques/02. Présentation Structure LeadGenAi.md
      - public/1. Documents Stratégiques/03. Logique Organisations.md
      - public/1. Documents Stratégiques/04. Relations Business entre Tables.md
      - public/1. Documents Stratégiques/05. Relations Users Utilisateurs.md
      - public/1. Documents Stratégiques/06. Référence des Hooks Stratégiques.md
      - public/1. Documents Stratégiques/07.1. Stratégie - Gestion des informations partagées entre Réseau et Réseau Direction.md
      - public/1. Documents Stratégiques/08. Gestion du Menu Gauche.md
      - public/1. Documents Stratégiques/09. Structure - Organisation | Client_id.md
      - public/1. Documents Stratégiques/10. Structure des Tables de Connexion & Règles Collaborateurs.md
---
**DIRECTIVE 2/ Analyse et mémorise tous les process qui existait en Localstorage**

- **PARTIE 1 : Lis et Analyse les process de récolte des informations dans les étapes 1 à 5 et envoi des données structurées à Open AI**
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/01.Etape1.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/02.Etape2.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/03.Etape3.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/04.Etape4.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/05.Etape5.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/06.Etape5animation.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/07.BilanEtape1aEtape5.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/08.ProcessEnvoiInfosOpenAI.md
    - public/4. ReadMe EtapesAnnonces/01.Etape1à5/09.ProcessPassageEtapeSuivante.md

- **PARTIE 2 : Lis et Analyse comment sont récupérées les données de OPen Ai et utilisée dans etape6communication**
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/00.ProcessRecuperationOpenAI.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/01.SiteInternetAnnonces.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/02.SiteInternetOutilsSeo.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/03.PortailsImmobiliers.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/04.CréerEmailingCampagneNewsletter.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/05.EnvoyerCampagneSMS.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/06.CréerLandingPage.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/07.DiffuserGoogleMB.md
    - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/08.DiffuserReseaux.md
---
# **FIN ETAPE 1 -> ANALYSE DE LA L'APPLICATION EN MODE LOCALSTORAGE**
  - Lis tous les liens que je t'ai donné, ils sont nécessaires pour connaitre mon application et l'ancien fonctionnement en local storage
  - Ce n'est pas la peine de me faire de résumer, j'ai juste besoin de savoir si ces informations sont bien acquises
  - J'ai d'autres informations à te donner dans le chat suivant
---
# **ETAPE 2** -> **COMPRENDRE MA STRATEGIE DE MIGRATION**
---
## **DIRECTIVE 3 : Comprendre mon projet de migration Supabase**
  - J ai travaillé avec toi sur un projet d application simple c'est pour ça que l'on a  travaillé tout d'abord en localstorage.
  - Puis je me suis aperçu qu'elle etait géniale en localstorage tout fonctionnait à merveille mais il m'était pas possible de la commercialiser en l etat, il fallait que je passe en gestion Supabase
  - En fait, ce que je recherchais et recherche toujours, il faut que tu comprennes, et c'est essentiel,
      - MON OBJECTIF est simplement de Passer de localStorage à Supabase. SANS RIEN CHANGER D'AUTRE
      - Garder TOUS les champs (noms, types, structures),TOUS les processus, TOUTES les validations,TOUTE la logique métier, TOUTE l'UX/UI (même comportement utilisateur)
      - **C'est une migration technique pure, pas une refonte.**

### **Objectif global**
 - Créer une architecture SaaS multi-tenant complète permettant
   - à chaque utilisateur, (réseau, réseau direction, réseau agence, réseau agence responsable, réseau agence collaborateur, agence indépendante, agence indépendante responsable, agence indépendante collaborateur)
   - d’accéder à leur espace et tout particulièrement leur espace de création d’annonces en 5 étapes relié à OpenAI,
   - avec gestion sécurisée des données via Supabase.
    
### **Rappel du Flux utilisateur global**
  - Connexion / Authentification : Authentification via Supabase (email / mot de passe)
  - Accès à l’espace personnel avec Redirection automatique selon le rôle :
    - RESEAU-ESPACE
    - CLIENT-ESPACE
    - COLLABORATEUR-ESPACE
    - Chaque espace ouvre un accès aux données propres accessibles à l'utilisateur et au module accueil-leadgenai pour lancer le générateur d'annonces et d'outils seo
---
## **DIRECTIVE 4 : Appliquer une Structure multi-tenant dans Supabase avec des Règles de visibilité hiérarchique**
  - Donc, chaque entité dispose d’un espace de travail isolé et sécurisé, basé sur son organisation_id ou client_id.
  - La visibilité hiérarchique et les accès utilisateurs sont gérés exclusivement via les RLS policies SQL, appliquées sur les tables principales.
  - Les hooks front n’assurent que l’injection des identifiants organisationnels.
  - Nous suivons une structure multi tenant avec une structure de visibilité imposée.

**Pour les structures** **Réseaux**
| Type utilisateur | Accès espace | Voit les projets de |
|------------------|--------------|---------------------|
| `reseau` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au réseau et à sa direction) (Par respect confidentialité : Ne voit pas les projets des agences du réseau) |
| `reseau_direction` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au réseau et à sa direction) (Par respect confidentialité : Ne voit pas les projets des agences du réseau)  |
| `reseau_agence` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_responsable` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |

**Pour les structures** **Agences Indépendantes**
| Type utilisateur | Accès espace | Voit les projets de |
|------------------|--------------|---------------------|
| `agence_independante` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_responsable` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |
---
## **Directive 5 : Appliquer une architecture du NOMMAGE camelCase non négociable**
  - Tous les hooks, fonctions, et interactions Supabase créés lors de la migration **DOIVENT impérativement** :
      - Conserver la structure camelCase existante pour les champs métier (agencyName, propertyType, saleType, price, rentAmount, rentPeriodicity, keyElements, propertyDescription, financials, details, exclusivite, location, reference).
      - Utiliser snake_case uniquement pour les champs système Supabase (organisation_id, user_id, created_at, updated_at, project_id, etc.).
      - Contrairement à une idée reçue, PostgreSQL/Supabase accepte parfaitement les noms de colonnes en camelCase, ils sont simplement encadrés par des guillemets doubles dans les requêtes si nécessaire.
      - **Règles concernant le nommage des camelCase**
        - **Règle SQL - Création de table**
        - Champs métier : `"camelCase"` (avec guillemets doubles)
        - Champs système : `snake_case` (sans guillemets)
      - **Règle TypeScript - Hooks & Services**
        - Utilisation directe du `camelCase` pour champs métier
        - Utilisation directe du `snake_case` pour champs système
        - AUCUNE fonction de conversion n'est nécessaire
      - **Règle Triggers**
        - Utiliser : `NEW."camelCase"` ou `NEW.snake_case`
        - Préférer les fonctions génériques réutilisables
---
##  **DIRECTIVE 6 : Stratégie de migration en 2 phases**
- Nous utilisons une stratégie de migration en 2 phases non négociable
  - **Phase 1** : **Migrer l'ancien process Localstorage de récupération des infos au cours de 5 étapes et d'envoi vers -> Supabase**
    - Avec Récupération des données saisies par Utilisateur lors des étapes 1 à 5
    - Jusqu'à l'envoi des prompts vers OpenAI
    - Gérer Etape5animation avec process d'animation et de gestion du statut pendant la phase d'attente des données provenant de open ai
    
 - **Phase 2** : **Migrer l'ancien process Localstorage de récupération des données envoyée par Open ai et injection dans etape6communication vers -> Supabase**
   - Avec Récupération des données renvoyées par OpenAi
   - Avec injection dans la page etape6communication
   - Jusqu'à leur utilisation par les différents canaux
---
## Nous travaillons exclusivement sur la partie Migration Phase 1 en ce moment**
---
# **FIN ETAPE 2 -> COMPRENDRE MA STRATEGIE DE MIGRATION**
  - Lis tous les liens que je t'ai donné, ils sont nécessaires pour connaitre ma stratégie initiale
  - Ce n'est pas la peine de me faire de résumer, j'ai juste besoin de savoir si ces informations sont bien acquises
  - J'ai d'autres informations à te donner dans le chat suivant
---
# **ETAPE 3 : POINT SUR LA MIGRATION**
- Après plusieurs correctifs voici les fichiers en place actuellement dans mon application
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.00.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.01.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.02.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.03.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.04.CodesPhase1.md

- Analyse également les tables associées à la migration phase 1 et actuellement dans Supabase
    - public/2. Etats des Tables /5.Tables.Migration.Phase1/1.etapes_1to5.md
    - public/2. Etats des Tables /5.Tables.Migration.Phase1/2.openai_api_keys.md
    - public/2. Etats des Tables /5.Tables.Migration.Phase1/3.openai_usage_logs.md

- Le gros probleme est que je me suis aperçu que le cycle utilisateur actuellement en place ne répondait pas vraiment à mon objectif
  - Et en plus, un statut Brouillon etait très difficile à gérer
  - Lis tous les liens que je t'ai donné, ils sont nécessaires pour connaitre les fichiers en place dans mon application avec ma tentative de migration
  - Ce n'est pas la peine de me faire de résumer, j'ai juste besoin de savoir si ces informations sont bien acquises
  - Je vais t'expliquer le coeur de notre mission de ce jour.
 ---
# **ETAPE 4 : NOTRE MISSION DE CE JOUR **
  - Donc comme je te l'ai dit, La migration a été mise en place pour passer phase 1 en Supabase, Mais, au cours des tests et il y a des bugs
  - J'ai décidé de tout revor le cyle de vie actuel
---
## **DIRECTIVE 7 : Concernant les fichiers actuels en place dans l'application**
  - Les fichiers actuels ont été fait sur un modele que je veux changer
  - Il faut donc ajuster et corriger les fichiers actuels pour les adapter à ma stratégie et non l'inverse
  - Le nouveau process l'emporte sur les process existants sources d'erreurs
---
## **DIRECTIVE 8 : Abandon du statut BROUILLON**
  - J'ai décidé d'abandonner le statut Brouillon qui causait trop de probleme
  - Nous n'aurons que 2 statuts : attente_validation et archive
| Règle | Description |
|-------|-------------|
| **Arrivée Etape 1** | Abandon du statut Brouillon - Tous les champs sont **VIDES** |
| **Validation Etape 1** | Création du statut `attente_validation`   |
| **Génération du projet** | Lorsque l'Utilisateur clique sur le bouton "Générer mes annonces" le projet passe de `attente_validation` → `archive` |
---
## **DIRECTIVE 9 : Nouveau mode de calcul des step_progress en 1,2,3,4**
  - Nous allons appliquer un nouveau mode de calcul de la progression basée sur 1,2,3,4
  - Nous supprimons la progression 5
  - **Explications**
| Action Utilisateur | step_progress | statut |
|-------------------|---------------|--------|
| Arrive sur `/etape1` | Pas de Brouillon, Pas de projet | `NULL` | 
| Valide Étape 1 | `[1]` | `attente_validation` |  
| Valide Étape 2 | `[1, 2]` | `attente_validation` | 
| Valide Étape 3 | `[1, 2, 3]` | `attente_validation` | 
| Valide Étape 4 | `[1, 2, 3, 4]` | `attente_validation` | 
| Génère Étape 5 | `[1, 2, 3, 4]`  | `archive` | 
---
## **DIRECTIVE 10 : Prioriser l'utilisation de useStepProgress**
- Nous avons décidé de modifier le comportement et les codes de useStepProgress pour qu'il gère prioritairement le step_progress
- Nous avons décidé d'alléger les comportements des composants des formulaires pour les concentrer sur la saisie des infos et la validation du bouton Valider
---

- Je viens de te présenter les grandes lignes de mon nouveau projet
- Juste après ce message je te donnerai 2 liens :
  - Un vers la présentation détaillées de ma nouvelle stratégie où tu trouveras les infos qui te manquent certainement
  - Un vers mon projet de correction des codes actuels pour appliquer ma nouvelle stratégie
    - Ta mission sera alors d analyser ce projet et ces codes pour voir s il n y a pas de risques de bugs
    - Je te rappelle que les fichiers actuels et les tables doivent se plier à cette stratégie et non l'inverse
    - Notre travail est de les recoder
- Est-ce clair ?
---

Parfait 
- Maintenant tu vas analyser ces deux documents
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/15--1.27.11.CycleNew.md
  - il présente ma stratégie
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/15--2.27.11.CycleCodes.md
  - Ce fichier propose les nouveaux codes pour les adapter à ma stratégie
- Ta mission est d'analyser ces deux documents et d voir s'ils peuvent etre déployés sans bugs
- Je te rappelle que ces codes sont destinés à remplacer les les fichiers actuels et les tables actuelles pour qu'elles se plient à notre stratégie et non l'inverse
---



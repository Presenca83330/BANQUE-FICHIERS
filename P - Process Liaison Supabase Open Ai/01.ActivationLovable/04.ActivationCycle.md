# PRESENTATION

- Tu es un expert en Ia no code et intégration supabese.
  - Je suis en train de migrer mon process de recupération des données de mon générateur, d'envoi vers openai, de récupération et d'utilisation qui est en localstorage vers supabase en 2 phases
  - POur l'instant, nous avons terminé la phase 1 (récupération des données aux étapes 1 à 5 et envoi à open ai)
  - Mais avant pour bien travailler ensemble, tu dois absolument te remémorer la structure de mon application
  - Je vais te transmettre des données cruciales et des liens vers des fichiers que tu devras lire pour bien travailler ensemble
  - Ok?
---
# ETAPE 1 - LIS ET ANALYSE MES DOCS STRATEGIQUES
---
  - Pour mener ta mission, tu dois avoir une vision complète de mon application commence par lire les documents suivants :
    - public/1. Documents Stratégiques/01. Présentation LeadGenAi.md
    - public/1. Documents Stratégiques/02. Présentation Structure LeadGenAi.md
    - public/1. Documents Stratégiques/03. Logique Organisations.md
    - public/1. Documents Stratégiques/04. Relations Business entre Tables.md
    - public/1. Documents Stratégiques/05. Relations Users Utilisateurs.md
    - public/1. Documents Stratégiques/06. Référence des Hooks Stratégiques.md
    - public/1. Documents Stratégiques/07.1. Stratégie - Gestion des informations partagées entre Réseau et Réseau Direction.md
    - public/1. Documents Stratégiques/08. Gestion du Menu Gauche.md
    - public/1. Documents Stratégiques/09. Structure - Organisation | Client_id.md
    - public/1. Documents Stratégiques/10. Structure des Tables de Connexion & Règles Collaborateurs.md
---
Lis et analyse ces documents, je te donnerai d'autres informations dans le chat suivant
---
# ETAPE 2 - COMPRENDRE MON PROJET
---
- Au départ, j ai travaillé avec toi sur un projet d'application simple de génération d'annonces c'est pour ça que nous avons travaillé tout d'abord en localstorage.
  - Puis je me suis aperçu qu'elle etait géniale en localstorage tout fonctionnait à merveille.
  - J'ai rajouté progressivement d'autres fonctions : génération de campagnes newsletters, sms, etc
    - Mais, il m'était pas possible de la commercialiser mon application en l'état, il fallait que je passe en gestion Supabase
  - En fait, MON OBJECTIF est simplement de Passer de localStorage à Supabase. SANS RIEN CHANGER D'AUTRE
    - Garder TOUS les champs (noms, types, structures),TOUS les processus, TOUTES les validations,TOUTE la logique métier, TOUTE l'UX/UI (même comportement utilisateur)
    - **C'est une migration technique pure, pas une refonte.**
---
- Pour bien comprendre tu dois te rappeler comment fonctionnait mon application en localstorage
  - PARTIE 1 : Lis et Analyse les process de récolte des informations dans les étapes 1 à 5 et envoi des données structurées à Open AI
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/01.Etape1.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/02.Etape2.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/03.Etape3.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/04.Etape4.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/05.Etape5.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/06.Etape5animation.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/07.BilanEtape1aEtape5.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/08.ProcessEnvoiInfosOpenAI.md
      - public/4. ReadMe EtapesAnnonces/01.Etape1à5/09.ProcessPassageEtapeSuivante.md
  - PARTIE 2 : Lis et Analyse comment sont récupérées les données de OPen Ai et utilisée dans etape6communication
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/00.ProcessRecuperationOpenAI.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/01.SiteInternetAnnonces.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/02.SiteInternetOutilsSeo.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/03.PortailsImmobiliers.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/04.CréerEmailingCampagneNewsletter.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/05.EnvoyerCampagneSMS.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/06.CréerLandingPage.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/07.DiffuserGoogleMB.md
      - public/4. ReadMe EtapesAnnonces/02.Etape6Communication/08.DiffuserReseaux.md
---
Lis et analyse ces documents, je te donnerai d'autres informations dans le chat suivant
---
# ETAPE 3 - MON OBJECTIF
---
- Je veux créer une architecture SaaS multi-tenant complète permettant
  - à chaque utilisateur, (réseau, réseau direction, réseau agence, réseau agence responsable, réseau agence collaborateur, agence indépendante, agence indépendante responsable, agence indépendante collaborateur)
  - d’accéder à leur espace et tout particulièrement leur espace de création d’annonces en 5 étapes relié à OpenAI,
  - avec gestion sécurisée des données via Supabase.
---
## **Rappel du Flux utilisateur global**
  - Connexion / Authentification : Authentification via Supabase (email / mot de passe)
  - Accès à l’espace personnel avec Redirection automatique selon le rôle :
    - RESEAU-ESPACE
    - CLIENT-ESPACE
    - COLLABORATEUR-ESPACE
    - Chaque espace ouvre un accès aux données propres accessibles à l'utilisateur et au module accueil-leadgenai pour lancer le générateur d'annonces et d'outils seo
---
## **Nous appliquons une Structure multi-tenant dans Supabase avec des Règles de visibilité hiérarchique**
  - Donc, chaque entité dispose d’un espace de travail isolé et sécurisé, basé sur son organisation_id ou client_id.
    - La visibilité hiérarchique et les accès utilisateurs sont gérés exclusivement via les RLS policies SQL, appliquées sur les tables principales.
    - Les hooks front n’assurent que l’injection des identifiants organisationnels.
    - Nous suivons une structure multi tenant avec une structure de visibilité imposée.

**Pour les structures** **Réseaux**
| Type utilisateur | Accès espace | Voit les projets de |
|------------------|--------------|---------------------|
| `reseau` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au réseau et à sa direction) (Par respect confidentialité : Ne voit pas les projets des agences du réseau) |
| `reseau_direction` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au réseau et à sa direction) (Par respect confidentialité : Ne voit pas les projets des agences du réseau)  |
| `reseau_agence` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_responsable` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |

**Pour les structures** **Agences Indépendantes**
| Type utilisateur | Accès espace | Voit les projets de |
|------------------|--------------|---------------------|
| `agence_independante` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_responsable` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |
---
## **Nous appliquons une architecture du NOMMAGE camelCase**
  - Tous les hooks, fonctions, et interactions Supabase créés lors de la migration **DOIVENT impérativement** :
      - Conserver la structure camelCase existante pour les champs métier (agencyName, propertyType, saleType, price, rentAmount, rentPeriodicity, keyElements, propertyDescription, financials, details, exclusivite, location, reference).
      - Utiliser snake_case uniquement pour les champs système Supabase (organisation_id, user_id, created_at, updated_at, project_id, etc.).
      - Contrairement à une idée reçue, PostgreSQL/Supabase accepte parfaitement les noms de colonnes en camelCase, ils sont simplement encadrés par des guillemets doubles dans les requêtes si nécessaire.
      - **Règles concernant le nommage des camelCase** :
      - **Règle SQL - Création de table** : Champs métier : `"camelCase"` (avec guillemets doubles) // Champs système : `snake_case` (sans guillemets)
      - **Règle TypeScript - Hooks & Services** : Utilisation directe du `camelCase` pour champs métier // Utilisation directe du `snake_case` pour champs système // AUCUNE fonction de conversion n'est nécessaire
      - **Règle Triggers** : Utiliser : `NEW."camelCase"` ou `NEW.snake_case` // Préférer les fonctions génériques réutilisables
---
##  **Nous appliquons une Stratégie de migration en 2 phases**
  - **Phase 1** : **Migrer l'ancien process Localstorage de récupération des infos au cours de 5 étapes et d'envoi vers -> Supabase**
    - Avec Récupération des données saisies par Utilisateur lors des étapes 1 à 5
    - Jusqu'à l'envoi des prompts vers OpenAI
    - Gérer Etape5animation avec process d'animation et de gestion du statut pendant la phase d'attente des données provenant de open ai
    
 - **Phase 2** : **Migrer l'ancien process Localstorage de récupération des données envoyée par Open ai et injection dans etape6communication vers -> Supabase**
   - Avec Récupération des données renvoyées par OpenAi
   - Avec injection dans la page etape6communication
   - Jusqu'à leur utilisation par les différents canaux
---
## Nous avons terminé la migration phase 1**
---
As-tu bien compris ces éléments, je vais te donner d'autres infos dans le chat suivant
---
# ETAPE 3 - NOUS AVONS TERMINE LA PHASE 1
- Nous avons terminé la phase 1 et le process de récupération des informations et d'envoi vers OpenAi fonctionne
- Le process de récupération dans la page etape6communication fonctionne également
- Tu peux avoir une vision d'ensemble de tous les fichiers utilisés actuellement dans la phase 1 de mon application
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.00.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.01.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.02.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.03.CodesPhase1.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/..v1.04.CodesPhase1.md

- Tu peux également analyser les tables associées à la migration phase 1 et actuellement dans Supabase
    - public/2. Etats des Tables /5.Tables.Migration.Phase1/1.etapes_1to5.md
    - public/2. Etats des Tables /5.Tables.Migration.Phase1/2.openai_api_keys.md
    - public/2. Etats des Tables /5.Tables.Migration.Phase1/3.openai_usage_logs.md
 
- Tu peux si tu le souhaites analyser tous les process en analysant
    - src
---
Lis ces documents et As-tu bien compris ces éléments, je vais te donner d'autres infos dans le chat suivant
---
---
# ETAPE 4 : CYCLE DE VIE PROJET
--- 
- J'ai juste une question concernant le cycle de vie utilisateurs
  - Nous avons travaillé en essayant de mettre en place cette structure développée dans ces documents
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/15--1.27.11.CycleNew.md
    - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/15--2.27.11.CycleCahierCharge.md
  - Or à l'utilisation, je me suis rendu compte, que tout ne fonctionnait pas comme je l'avais prévu
---
A pArtir de ces documents, analyse bien le process actuel et je te poserai ma question
---
---
# ETAPE 5 : MA QUESTION
---
- J'ai 2 impresssions :
- 1/ Que mes données restent toujours en mémoire
- 2/ Que le bouton Générer un Nouveau projet ne fonctionne pas comme je le voulais

- Je te rappelle ce que je voulais
- dans : public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/15--1.27.11.CycleNew.md
- 2.6 Scénario F : Bouton "Générer un nouveau projet"

| Contexte actuel | Action sur ancien projet |
|-----------------|--------------------------|
| **Saisie non validée** (pas de projet) | Données seront perdues, pas de projet |
| **Projet `attente_validation`** | "Projet sauvegardé en `attente_validation` |
| **Projet `archive`** | Reste en `archive` |

## **Message contextuel** selon l'état du projet  :
| État du projet actuel | Message  | Action réelle |
|-----------------------|--------------------------|---------------|
| **Étape 1 non validée** | CAS 1 | Rien à sauvegarder  |
| **Étapes 1-4 validées (pas étape 5)** | CAS 2 | Statut → `attente_validation` |
| **Étape 5 générée** | CAS 3 | Statut → `archive` |

## **Proposition de Messages**
| **Clic sur bouton : "Générer un nouveau projet"** | Message  | Bouton |
|-----------------------|--------------------------|---------------|
| **CAS 1 : Étape 1 non validée**  | "Attention : les données saisies dans cette étape n'ont pas été validées et seront perdues." | [Annuler] [Lancer un Nouveau Projet]   |
| **CAS 2 : Étapes 1-4 validées (statut attente_validation)** | "Votre projet en cours sera sauvegardé en 'attente de validation'. Vous pourrez le reprendre plus tard depuis votre dossier Mes Projets." | [Annuler] [Sauvegarder et Lancer un Nouveau Projet] |
| **CAS 3 : Étape 5 validée (archivé)** | "Votre projet généré sera archivé. Vous pourrez le consulter ou le réutiliser depuis votre dossier Mes Projets."  |[Annuler] [Archiver et Lancer un Nouveau Projet]  |

**Après clic :**
- Redirection vers `/etape1`
- Champs vides (nouveau projet)
- Ancien projet, statut attente_validation ou archive, récupérable via "Mes Projets"
---
- Qu'en penses tu ?
---
---

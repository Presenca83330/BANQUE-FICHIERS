# STRAT√âGIE GOOGLE AUTH - LeadGenAI AdBuilder
**Date :** 2025-09-02  
**Contexte :** Authentification Google pour utilisateurs pr√©-autoris√©s uniquement  
**Objectif :** Permettre la connexion Google sans cr√©ation automatique de compte

---

## üéØ 1. CONTEXTE & CONTRAINTES

### **Contraintes m√©tier**
- **PAS de cr√©ation de compte automatique** : seuls les utilisateurs pr√©-autoris√©s par PRESENCA peuvent se connecter
- **Validation organisation** : v√©rifier que l'email Google est li√© √† une organisation autoris√©e
- **S√©curit√© renforc√©e** : RLS policies + v√©rification manuelle des comptes

### **Architecture existante √† respecter**
- **Interface en 2 parties** : `AuthIllustration` + Formulaire de connexion
- **Hooks strat√©giques** : `useAuth` existant √† √©tendre
- **Structure INTERFACE-CONNEXION** : respect de l'organisation en dossiers num√©rot√©s

---

## üèóÔ∏è 2. ARCHITECTURE PROPOS√âE

### **A. Fichiers existants √† modifier**

```
src/components/HOOKS-STRATEGIQUE/1.HOOK-useAuth/
‚îú‚îÄ‚îÄ useAuth.ts ‚úÖ (√©tendre signInWithGoogle)
‚îú‚îÄ‚îÄ authTypes.ts ‚úÖ (ajouter types Google)
‚îî‚îÄ‚îÄ authMessages.ts ‚úÖ (ajouter messages Google)

src/components/INTERFACE-CONNEXION/3.GoogleAuth/
‚îî‚îÄ‚îÄ GoogleAuthButton.tsx ‚úÖ (optimiser avec nouveaux hooks)
```

### **B. Nouveaux fichiers √† cr√©er**

```
src/components/INTERFACE-CONNEXION/3.GoogleAuth/
‚îú‚îÄ‚îÄ GoogleAuthLogic.ts (NEW - logique m√©tier s√©par√©e)
‚îú‚îÄ‚îÄ GoogleAuthMessages.ts (NEW - messages sp√©cifiques)
‚îî‚îÄ‚îÄ GoogleAuthTypes.ts (NEW - types sp√©cifiques)

src/components/HOOKS-STRATEGIQUE/1.HOOK-useAuth/
‚îî‚îÄ‚îÄ googleAuthExtensions.ts (NEW - extensions Google pour useAuth)
```

### **C. Architecture recommand√©e - PAS de dossier s√©par√©**
‚ùå **src/components/HOOKS-STRATEGIQUE/5.GOOGLE AUTH/** ‚Üí PAS N√âCESSAIRE  
‚úÖ **Tout centraliser dans useAuth** pour coh√©rence et simplicit√©

---

## üîß 3. LOGIQUE TECHNIQUE D√âTAILL√âE

### **A. Extension du hook useAuth**

```typescript
// Nouvelles fonctions √† ajouter dans useAuth.ts
const signInWithGoogle = useCallback(async (): Promise<AuthResult> => {
  setIsLoading(true);
  setError(null);

  try {
    // 1. OAuth Google
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
        queryParams: {
          access_type: 'offline',
          prompt: 'consent',
        }
      },
    });

    if (error) throw error;

    // 2. Apr√®s retour OAuth : v√©rification autorisation
    // (se fera dans onAuthStateChange)
    
  } catch (error) {
    const message = mapGoogleAuthError(error.message);
    setError(message);
    return { ok: false, message };
  } finally {
    setIsLoading(false);
  }
}, []);

// Fonction de v√©rification post-OAuth
const verifyGoogleUserAuthorization = async (user: AuthUser) => {
  // V√©rifier si cet email est autoris√© dans la base
  const { data: authorizedUser, error } = await supabase
    .from('users')
    .select('users_id, users_organisation_id, users_role')
    .eq('users_email', user.email)
    .single();

  if (error || !authorizedUser) {
    // D√©connecter imm√©diatement
    await supabase.auth.signOut();
    throw new Error('GOOGLE_ACCOUNT_NOT_AUTHORIZED');
  }

  return authorizedUser;
};
```

### **B. Gestion des erreurs sp√©cifiques**

```typescript
// Dans authMessages.ts - nouvelles fonctions
export function mapGoogleAuthError(errorMessage: string): string {
  const normalized = errorMessage.toLowerCase();

  if (normalized.includes("google_account_not_authorized")) {
    return "Ce compte Google n'est pas autoris√©. Contactez PRESENCA pour obtenir l'acc√®s.";
  }
  if (normalized.includes("popup_blocked")) {
    return "Popup bloqu√©e. Autorisez les popups pour ce site et r√©essayez.";
  }
  if (normalized.includes("oauth_error")) {
    return "Erreur lors de la connexion Google. Veuillez r√©essayer.";
  }
  if (normalized.includes("network_error")) {
    return "Probl√®me de connexion. V√©rifiez votre internet et r√©essayez.";
  }

  return mapSupabaseError(errorMessage); // Fallback vers gestion existante
}

export const GOOGLE_AUTH_MESSAGES = {
  UNAUTHORIZED: "Ce compte Google n'est pas autoris√© pour cette application.",
  CONTACT_ADMIN: "Contactez PRESENCA pour obtenir l'autorisation d'acc√®s.",
  POPUP_BLOCKED: "Veuillez autoriser les popups pour ce site.",
  LOADING: "Connexion avec Google en cours...",
  SUCCESS: "Connexion Google r√©ussie !",
};
```

### **C. Types √©tendus**

```typescript
// Dans authTypes.ts - ajouts
export interface GoogleAuthResult extends AuthResult {
  provider?: 'google';
  isAuthorized?: boolean;
  organizationId?: string;
}

export interface GoogleAuthError {
  type: 'UNAUTHORIZED' | 'POPUP_BLOCKED' | 'NETWORK_ERROR' | 'OAUTH_ERROR';
  message: string;
  details?: any;
}
```

---

## üë§ 4. FLUX UTILISATEUR D√âTAILL√â

### **√âtape 1 : Clic sur bouton Google**
- Affichage loader "Connexion avec Google..."
- Ouverture popup OAuth Google (ou redirection selon config)

### **√âtape 2 : Authentification Google**
- Utilisateur saisit ses identifiants Google
- Google renvoie vers l'app avec token

### **√âtape 3 : V√©rification autorisation**
- R√©cup√©ration email depuis token Google
- Requ√™te base de donn√©es : cet email existe-t-il dans `users` ?
- **Si OUI** : connexion r√©ussie, redirection vers app
- **Si NON** : d√©connexion imm√©diate + message d'erreur

### **√âtape 4 : Gestion des erreurs**
- **Popup bloqu√©e** : message d'aide + bouton "R√©essayer"
- **Compte non autoris√©** : message + contact PRESENCA
- **Erreur r√©seau** : message + bouton "R√©essayer"

---

## üîí 5. S√âCURIT√â & V√âRIFICATIONS

### **A. C√¥t√© Supabase (RLS)**
```sql
-- Policy pour v√©rifier l'autorisation Google
CREATE POLICY "Google auth users must be pre-authorized"
ON auth.users
FOR SELECT
USING (
  email IN (
    SELECT users_email 
    FROM public.users 
    WHERE users_email = auth.email()
  )
);
```

### **B. C√¥t√© application**
- **V√©rification imm√©diate** apr√®s OAuth
- **D√©connexion automatique** si non autoris√©
- **Log des tentatives** non autoris√©es pour monitoring
- **Pas de cr√©ation de profil** automatique

### **C. Configuration Supabase**
- **Site URL** : URL production/preview
- **Redirect URLs** : callbacks autoris√©es
- **OAuth Google** : Client ID + Secret configur√©s

---

## üé® 6. INT√âGRATION INTERFACE

### **A. GoogleAuthButton optimis√©**
```typescript
// √âtats visuels
- isLoading : spinner + "Connexion avec Google..."
- error : affichage message d'erreur avec ic√¥ne
- success : br√®ve animation de succ√®s

// Design
- Respect du design system (tokens CSS)
- Animation hover/click avec framer-motion
- Ic√¥ne Google officielle
- Responsive mobile/desktop
```

### **B. Int√©gration dans layout existant**
- **Partie gauche** : `AuthIllustration` (inchang√©e)
- **Partie droite** : Formulaire avec bouton Google am√©lior√©
- **Position** : apr√®s le separator "ou"
- **Responsive** : adaptation mobile

---

## üìù 7. MESSAGES UTILISATEUR

### **Messages de succ√®s**
- ‚úÖ "Connexion Google r√©ussie !"
- ‚úÖ "Bienvenue [nom] !"

### **Messages d'erreur**
- ‚ùå "Ce compte Google n'est pas autoris√©"
- ‚ùå "Contactez PRESENCA : contact@presenca.fr"
- ‚ùå "Popup bloqu√©e, autorisez les popups"
- ‚ùå "Erreur de connexion, r√©essayez"

### **Messages informatifs**
- ‚ÑπÔ∏è "Connexion avec Google en cours..."
- ‚ÑπÔ∏è "V√©rification de votre autorisation..."

---

## üöÄ 8. PLAN D'IMPL√âMENTATION

### **Phase 1 : Extensions hooks**
1. √âtendre `authTypes.ts` avec types Google
2. √âtendre `authMessages.ts` avec messages Google
3. Modifier `useAuth.ts` pour am√©liorer `signInWithGoogle`

### **Phase 2 : Logique m√©tier**
1. Cr√©er `GoogleAuthLogic.ts` avec v√©rifications
2. Cr√©er `GoogleAuthMessages.ts` avec messages sp√©cifiques
3. Ajouter fonction de v√©rification autorisation

### **Phase 3 : Interface**
1. Optimiser `GoogleAuthButton.tsx`
2. Int√©grer nouveaux √©tats (loading, error, success)
3. Am√©liorer feedback visuel

### **Phase 4 : Tests & validation**
1. Test avec compte autoris√©
2. Test avec compte non autoris√©
3. Test gestion erreurs (popup, r√©seau)
4. Validation s√©curit√© RLS

---

## üéØ 9. OBJECTIFS FINAUX

### **Fonctionnels**
- ‚úÖ Connexion Google fluide pour utilisateurs autoris√©s
- ‚úÖ Blocage automatique des comptes non autoris√©s
- ‚úÖ Messages d'erreur clairs et actionables
- ‚úÖ Respect de l'architecture existante

### **Techniques**
- ‚úÖ Code maintenable et extensible
- ‚úÖ S√©curit√© renforc√©e (RLS + v√©rifications)
- ‚úÖ Performance optimis√©e (pas de requ√™tes inutiles)
- ‚úÖ Logs pour monitoring et debug

### **UX/UI**
- ‚úÖ Interface coh√©rente avec le design existant
- ‚úÖ Feedback visuel √† chaque √©tape
- ‚úÖ Responsive mobile/desktop
- ‚úÖ Animations fluides

---

## üìã 10. CHECKLIST FINALE

### **Avant impl√©mentation**
- [ ] Configuration Google OAuth dans Supabase
- [ ] V√©rification RLS policies existantes
- [ ] Backup du code actuel

### **Pendant impl√©mentation**
- [ ] Tests unitaires des nouvelles fonctions
- [ ] Tests d'int√©gration OAuth
- [ ] Validation s√©curit√©

### **Apr√®s impl√©mentation**
- [ ] Test complet du flux utilisateur
- [ ] Validation avec compte PRESENCA
- [ ] Documentation mise √† jour
- [ ] Monitoring des logs d'erreur

---

**üîÑ Ce document sera mis √† jour pendant l'impl√©mentation selon les retours et ajustements n√©cessaires.**

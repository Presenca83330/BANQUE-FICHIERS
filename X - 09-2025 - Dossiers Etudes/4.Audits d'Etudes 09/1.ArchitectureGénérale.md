# 📊 ARCHITECTURE GÉNÉRALE - APPLICATION MULTI-TENANT SUPABASE

*Document généré le 04/09/2025*

---

## 📋 VUE D'ENSEMBLE SYSTÈME

```mermaid
graph TB
    subgraph "🌐 INTERFACES UTILISATEUR" 
        A["🖥️ Interface Web React<br/>- Accès admin développement<br/>- Dashboard Multi-tenant<br/>- Espaces spécialisés"]
    end
    
    subgraph "⚙️ COUCHE APPLICATION"
        B["🔧 Hooks Stratégiques<br/>- useCurrentUser<br/>- useMultiTenant<br/>- useProfile"]
        C["📡 Supabase API<br/>- Client JS<br/>- RPC Functions<br/>- Real-time"]
    end
    
    subgraph "🗃️ BASE DE DONNÉES SUPABASE"
        D["👥 Tables Stratégiques<br/>- organisations<br/>- users<br/>- utilisateurs"]
        E["🏢 Tables Clients<br/>- reseau<br/>- agence_independante<br/>- responsables/collaborateurs"]
        F["🔗 Tables Connexions<br/>- openai_connexion<br/>- brevo_connexion<br/>- linkedin_connexion"]
        G["📊 Historique<br/>- 1_historique_supabase<br/>- abonnement_stripe"]
    end
    
    subgraph "🔗 INTÉGRATIONS EXTERNES"
        H["🤖 OpenAI API<br/>🌐 Brevo Email<br/>💼 LinkedIn<br/>📘 Facebook<br/>📸 Instagram<br/>💼 Zoho CRM<br/>💳 Stripe"]
    end
    
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    C --> H
```

---

## 🏗️ ARCHITECTURE MULTI-TENANT

```mermaid
graph TD
    subgraph "👤 TYPES UTILISATEURS"
        U1["👑 Admin PRESENCA<br/>- Accès global<br/>- Gestion organisations<br/>- Super admin"]
        U2["🏢 Réseau Direction<br/>- Gestion réseau<br/>- Vue agences<br/>- Administration"]
        U3["🏪 Agence Responsable<br/>- Gestion agence<br/>- Équipe locale<br/>- Clients"]
        U4["👨‍💼 Collaborateur<br/>- Utilisation outils<br/>- Données limitées<br/>- Tâches opérationnelles"]
    end
    
    subgraph "🏢 ORGANISATIONS"
        O1["🌟 PRESENCA<br/>organisation_id: special<br/>Accès: global"]
        O2["🏢 Réseau<br/>organisation_id: unique<br/>Accès: réseau + agences"]
        O3["🏪 Agence Réseau<br/>organisation_id: réseau<br/>Accès: agence seule"]
        O4["🏪 Agence Indépendante<br/>organisation_id: unique<br/>Accès: agence seule"]
    end
    
    subgraph "🔐 ISOLATION DONNÉES RLS"
        R1["🛡️ Row Level Security<br/>- organisation_id filter<br/>- Fonctions sécurisées<br/>- Policies strictes"]
        R2["⚡ Fonctions RPC<br/>- get_user_organisation_id()<br/>- is_admin_presenca()<br/>- get_organisation_type()"]
    end
    
    U1 -.-> O1
    U2 --> O2
    U3 --> O3
    U4 --> O4
    
    O1 --> R1
    O2 --> R1
    O3 --> R1
    O4 --> R1
    
    R1 --> R2
```

---

## 🗄️ ARCHITECTURE BASE DE DONNÉES

```mermaid
erDiagram
    %% Tables principales
    ORGANISATIONS ||--o{ USERS : "organisation_id"
    ORGANISATIONS ||--o{ UTILISATEURS : "organisation_id"
    
    %% Hiérarchie Réseau
    ORGANISATIONS ||--o{ RESEAU : "organisation_id"
    RESEAU ||--o{ RESEAU_DIRECTION : "reseau_id"
    RESEAU ||--o{ RESEAU_AGENCE : "reseau_id"
    RESEAU_AGENCE ||--o{ RESEAU_AGENCE_RESPONSABLE : "reseau_agence_id"
    RESEAU_AGENCE ||--o{ RESEAU_AGENCE_COLLABORATEUR : "reseau_agence_id"
    
    %% Agences Indépendantes
    ORGANISATIONS ||--o{ AGENCE_INDEPENDANTE : "organisation_id"
    AGENCE_INDEPENDANTE ||--o{ AGENCE_INDEPENDANTE_RESPONSABLE : "agence_indep_id"
    AGENCE_INDEPENDANTE ||--o{ AGENCE_INDEPENDANTE_COLLABORATEUR : "agence_indep_id"
    
    %% Connexions externes
    ORGANISATIONS ||--o{ BREVO_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ OPENAI_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ LINKEDIN_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ FACEBOOK_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ INSTAGRAM_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ ZOHO_CONNEXION : "organisation_id"
    
    %% Audit et paiements
    ORGANISATIONS ||--o{ ABONNEMENT_STRIPE : "organisation_id"
    ORGANISATIONS ||--o{ HISTORIQUE_SUPABASE : "organisation_id"
    
    ORGANISATIONS {
        uuid organisation_id PK
        text organisation_nom
        text organisation_siret
        text organisation_email
        text organisation_statut_compte
        text organisation_plan_stripe
    }
    
    USERS {
        uuid users_id PK
        uuid users_auth_id UK
        uuid users_organisation_id FK
        text users_role_systeme
        text users_nom
        text users_prenom
        text users_email
    }
```

---

## 🔄 FLUX D'AUTHENTIFICATION ACTUEL

```mermaid
sequenceDiagram
    participant U as 👤 Utilisateur
    participant I as 🌐 Interface Connexion
    participant A as 🔑 Admin Direct
    participant S as 🔑 Supabase Auth
    participant D as 🗃️ Base Données
    participant H as 🎯 useMultiTenant
    
    Note over I: ❌ VIDE/NON FONCTIONNELLE
    Note over A: 🚫 Google Auth DÉSACTIVÉ
    
    U->>I: Accès application (développement)
    I->>A: Accès admin direct
    A->>S: Session admin
    S->>D: Recherche utilisateur
    
    alt ✅ Admin PRESENCA existe
        D->>H: Récupération profil admin
        H->>H: get_user_organisation_id()
        H->>H: Vérification statut admin
        H->>U: → /admin-presenca
        
    else ❌ Pas d'accès
        D->>U: Redirection login
        Note over U,H: 🚨 WORKFLOW COMPLET À IMPLÉMENTER
    end
    
    Note over U,H: ⚠️ PHASE FUTURE: Google Auth + Demandes
```

---

## 💻 INTERFACES UTILISATEUR - POINTS D'ENTRÉE

```mermaid
graph LR
    subgraph "🌐 AUTHENTIFICATION - DÉVELOPPEMENT"
        LOGIN["🔐 Interface Connexion<br/>❌ VIDE - À IMPLÉMENTER"]
        ADMIN_DIRECT["👑 Accès Admin Direct<br/>🔧 Mode développement"]
        REQUEST["📝 Demande Compte<br/>❌ N'EXISTE PAS"]
    end
    
    subgraph "🚫 DÉSACTIVÉ ACTUELLEMENT"
        GOOGLE["🔍 Google OAuth<br/>🚫 DÉSACTIVÉ<br/>Phase future"]
    end
    
    subgraph "🎯 ESPACES DISPONIBLES"
        ADMIN["👑 /admin-presenca<br/>✅ Admin PRESENCA"]
        RESEAU["🏢 /espace-reseau<br/>⏳ Futur"]
        CLIENT["🏪 /accueil-leadgenai<br/>⏳ Futur"]
    end
    
    ADMIN_DIRECT --> ADMIN
    LOGIN --> REQUEST
    
    style LOGIN fill:#ffcccc
    style REQUEST fill:#ffcccc
    style GOOGLE fill:#e0e0e0
    style ADMIN fill:#ccffcc
    style RESEAU fill:#fff3cd
    style CLIENT fill:#fff3cd
```

---

## 🏪 INTERFACE ESPACE CLIENT

```mermaid
graph TD
    subgraph "🏪 ESPACE CLIENT - /accueil-leadgenai"
        EC_HOME["🏠 Accueil LeadGenAI<br/>- Dashboard personnel<br/>- Statistiques<br/>- Accès rapide outils"]
        
        EC_TOOLS["🛠️ Outils IA<br/>- Générateur annonces<br/>- Zone de chalandise<br/>- Contenu automatisé"]
        
        EC_INTEGRATIONS["🔗 Mes Intégrations<br/>- OpenAI<br/>- Brevo<br/>- LinkedIn/Facebook"]
        
        EC_PROFILE["👤 Mon Profil<br/>- Informations personnelles<br/>- Paramètres compte<br/>- Préférences"]
    end
    
    subgraph "⚙️ FONCTIONNALITÉS DISPONIBLES"
        LEAD_GEN["📈 Génération Leads<br/>✅ Disponible"]
        CONTENT_AI["✍️ Contenu IA<br/>✅ Disponible"]
        ANALYTICS["📊 Analytics<br/>✅ Disponible"]
        ZONE_CHAL["🗺️ Zone Chalandise<br/>✅ Disponible"]
    end
    
    EC_HOME --> EC_TOOLS
    EC_HOME --> EC_INTEGRATIONS
    EC_HOME --> EC_PROFILE
    
    EC_TOOLS --> LEAD_GEN
    EC_TOOLS --> CONTENT_AI
    EC_TOOLS --> ANALYTICS
    EC_TOOLS --> ZONE_CHAL
    
    style EC_HOME fill:#ccffcc
    style EC_TOOLS fill:#ccffcc
    style LEAD_GEN fill:#ccffcc
    style CONTENT_AI fill:#ccffcc
```

---

## 👑 INTERFACE ADMIN PRESENCA

```mermaid
graph TD
    subgraph "👑 ADMIN PRESENCA - /admin-presenca"
        AP_HOME["🏠 Dashboard Admin<br/>- Vue d'ensemble globale<br/>- Métriques système<br/>- Alertes"]
        
        AP_ORGS["🏢 Gestion Organisations<br/>- Toutes organisations<br/>- Création/modification<br/>- Statuts"]
        
        AP_USERS["👥 Gestion Utilisateurs<br/>- Tous utilisateurs<br/>- Rôles et permissions<br/>- Activation/désactivation"]
        
        AP_REQUESTS["📝 Demandes Comptes<br/>❌ NON FONCTIONNEL<br/>- Validation demandes<br/>- Création automatique"]
        
        AP_SUBSCRIPTIONS["💳 Abonnements<br/>- Stripe management<br/>- Plans et facturation<br/>- Statuts paiement"]
    end
    
    subgraph "🗃️ ACCÈS DONNÉES GLOBAL"
        ALL_ORGS["🌍 Toutes Organisations<br/>✅ RLS bypass admin"]
        ALL_USERS["👥 Tous Utilisateurs<br/>✅ RLS bypass admin"]
        ALL_REQUESTS["📋 Toutes Demandes<br/>❌ Table manquante"]
        ALL_SUBS["💰 Tous Abonnements<br/>✅ Disponible"]
    end
    
    AP_HOME --> AP_ORGS
    AP_HOME --> AP_USERS
    AP_HOME --> AP_REQUESTS
    AP_HOME --> AP_SUBSCRIPTIONS
    
    AP_ORGS --> ALL_ORGS
    AP_USERS --> ALL_USERS
    AP_REQUESTS --> ALL_REQUESTS
    AP_SUBSCRIPTIONS --> ALL_SUBS
    
    style AP_REQUESTS fill:#ffcccc
    style ALL_REQUESTS fill:#ffcccc
```

---

## 🔧 INTERFACE ADMIN PRESENCA - Création Comptes

```mermaid
graph TB
    subgraph "🔧 CRÉATION COMPTES - PROBLÈMES ACTUELS"
        CC_CURRENT["📄 CreationComptes.tsx<br/>❌ FORMULAIRES INCORRECTS<br/>- Tables inexistantes<br/>- Hooks erronés<br/>- IDs incorrects"]
    end
    
    subgraph "❌ TABLES INCORRECTES UTILISÉES"
        WRONG_1["❌ mauvaise_table_1<br/>N'existe pas en DB"]
        WRONG_2["❌ mauvaise_table_2<br/>N'existe pas en DB"]  
        WRONG_3["❌ mauvais_hooks<br/>Pointent vers rien"]
    end
    
    subgraph "✅ TABLES CORRECTES À UTILISER"
        CORRECT_1["✅ organisations<br/>Table principale"]
        CORRECT_2["✅ reseau<br/>Pour type réseau"]
        CORRECT_3["✅ agence_independante<br/>Pour agences indép"]
        CORRECT_4["✅ users<br/>Utilisateur initial"]
    end
    
    subgraph "🎯 WORKFLOW CORRECT"
        STEP_1["1️⃣ Créer organisation<br/>→ organisations"]
        STEP_2["2️⃣ Créer structure<br/>→ reseau OU agence_independante"]
        STEP_3["3️⃣ Créer utilisateur admin<br/>→ users"]
        STEP_4["4️⃣ Lier organisation<br/>→ users.organisation_id"]
    end
    
    CC_CURRENT --> WRONG_1
    CC_CURRENT --> WRONG_2
    CC_CURRENT --> WRONG_3
    
    WRONG_1 -.-> CORRECT_1
    WRONG_2 -.-> CORRECT_2
    WRONG_3 -.-> CORRECT_3
    
    CORRECT_1 --> STEP_1
    CORRECT_2 --> STEP_2
    CORRECT_3 --> STEP_2
    CORRECT_4 --> STEP_3
    
    STEP_1 --> STEP_2
    STEP_2 --> STEP_3
    STEP_3 --> STEP_4
    
    style CC_CURRENT fill:#ffcccc
    style WRONG_1 fill:#ffcccc
    style WRONG_2 fill:#ffcccc
    style WRONG_3 fill:#ffcccc
    style CORRECT_1 fill:#ccffcc
    style CORRECT_2 fill:#ccffcc
    style CORRECT_3 fill:#ccffcc
    style CORRECT_4 fill:#ccffcc
```

---

## 📝 INTERFACE ADMIN PRESENCA - Demandes Ouverture

```mermaid
graph TB
    subgraph "📝 DEMANDES OUVERTURE - ÉTAT ACTUEL"
        DO_CURRENT["📄 DemandeOuvertureCompte.tsx<br/>❌ HOOK TEMPORAIRE<br/>- Table inexistante<br/>- Données factices<br/>- Aucune fonctionnalité"]
        
        HOOK_TEMP["🔧 HookDemandes.tsx<br/>❌ TEMPORAIRE<br/>- Retourne []<br/>- Message migration<br/>- Non fonctionnel"]
    end
    
    subgraph "❌ TABLE MANQUANTE"
        MISSING_TABLE["❌ demandes_creation_compte<br/>🚨 N'EXISTE PAS<br/>- Aucune structure<br/>- Aucun RLS<br/>- Aucun hook"]
    end
    
    subgraph "✅ SOLUTION REQUISE"
        CREATE_TABLE["✅ Créer Table<br/>demandes_creation_compte<br/>- Structure complète<br/>- Champs validation<br/>- RLS policies"]
        
        CREATE_HOOK["✅ Hook Fonctionnel<br/>- CRUD complet<br/>- Gestion statuts<br/>- Validation admin"]
        
        CREATE_WORKFLOW["✅ Workflow Complet<br/>- Soumission publique<br/>- Validation admin<br/>- Création automatique"]
    end
    
    subgraph "🎯 ÉTAPES WORKFLOW"
        STEP_A["1️⃣ Formulaire public<br/>→ Soumission demande"]
        STEP_B["2️⃣ Validation admin<br/>→ Approve/Reject"]
        STEP_C["3️⃣ Création auto<br/>→ Organisation + User"]
        STEP_D["4️⃣ Notification<br/>→ Email confirmation"]
    end
    
    DO_CURRENT --> HOOK_TEMP
    HOOK_TEMP --> MISSING_TABLE
    
    MISSING_TABLE --> CREATE_TABLE
    CREATE_TABLE --> CREATE_HOOK
    CREATE_HOOK --> CREATE_WORKFLOW
    
    CREATE_WORKFLOW --> STEP_A
    STEP_A --> STEP_B
    STEP_B --> STEP_C
    STEP_C --> STEP_D
    
    style DO_CURRENT fill:#ffcccc
    style HOOK_TEMP fill:#ffcccc
    style MISSING_TABLE fill:#ffcccc
    style CREATE_TABLE fill:#ccffcc
    style CREATE_HOOK fill:#ccffcc
    style CREATE_WORKFLOW fill:#ccffcc
```

---

## 🚨 PROBLÈMES CRITIQUES IDENTIFIÉS

| 🔴 **CRITIQUE** | 📍 **LOCALISATION** | ❌ **PROBLÈME** | ✅ **SOLUTION** |
|----------------|-------------------|-----------------|-----------------|
| **Interface Connexion** | `/components/INTERFACE-CONNEXION` | Dossier vide/non fonctionnel | Implémenter formulaire complet |
| **Table Demandes** | `demandes_creation_compte` | Table n'existe pas | Créer table + RLS + hooks |
| **Formulaires Admin** | `CreationComptes.tsx` | Tables/hooks incorrects | Corriger noms tables/IDs |
| **Hook Demandes** | `HookDemandes.tsx` | Hook temporaire factice | Implémenter CRUD réel |

---

## 🎯 PLAN D'ACTION PRIORISÉ

### 🥇 **PHASE 1 - DEMANDES CRÉATION COMPTE** *(URGENT)*
```mermaid
graph LR
    A["🗃️ Créer Table<br/>demandes_creation_compte"] --> B["📝 Formulaire Public<br/>Interface soumission"]
    B --> C["🔧 Hook Fonctionnel<br/>CRUD complet"]
    C --> D["✅ Tests<br/>Workflow complet"]
```

### 🥈 **PHASE 2 - CORRECTION FORMULAIRES ADMIN**
```mermaid
graph LR
    E["🔧 Corriger<br/>CreationComptes.tsx"] --> F["🔧 Corriger<br/>DemandeOuvertureCompte.tsx"]
    F --> G["🧪 Tests<br/>Création comptes"]
```

### 🥉 **PHASE 3 - VALIDATION MULTI-TENANT**
```mermaid
graph LR
    H["🧪 Tests Isolation<br/>RLS validation"] --> I["📊 Performance<br/>Optimisations"]
    I --> J["🚀 Production<br/>Ready"]
```

### 🔮 **PHASE FUTURE - AUTHENTIFICATION CLIENT**
```mermaid
graph LR
    K["🔐 Google OAuth<br/>Réactivation"] --> L["👥 Workflow Clients<br/>Complet"]
    L --> M["🌐 Interface Publique<br/>Demandes"]
    M --> N["📧 Notifications<br/>Email automatique"]
```

---

**🏁 PRÊT POUR PHASE 1 : Création table `demandes_creation_compte` et formulaire public**
**📝 MODE DÉVELOPPEMENT : Accès admin direct uniquement - Google Auth désactivé**

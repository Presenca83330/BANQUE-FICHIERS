# ğŸ“Š ARCHITECTURE GÃ‰NÃ‰RALE - APPLICATION MULTI-TENANT SUPABASE

*Document gÃ©nÃ©rÃ© le 04/09/2025*

---

## ğŸ“‹ VUE D'ENSEMBLE SYSTÃˆME

```mermaid
graph TB
    subgraph "ğŸŒ INTERFACES UTILISATEUR" 
        A["ğŸ–¥ï¸ Interface Web React<br/>- AccÃ¨s admin dÃ©veloppement<br/>- Dashboard Multi-tenant<br/>- Espaces spÃ©cialisÃ©s"]
    end
    
    subgraph "âš™ï¸ COUCHE APPLICATION"
        B["ğŸ”§ Hooks StratÃ©giques<br/>- useCurrentUser<br/>- useMultiTenant<br/>- useProfile"]
        C["ğŸ“¡ Supabase API<br/>- Client JS<br/>- RPC Functions<br/>- Real-time"]
    end
    
    subgraph "ğŸ—ƒï¸ BASE DE DONNÃ‰ES SUPABASE"
        D["ğŸ‘¥ Tables StratÃ©giques<br/>- organisations<br/>- users<br/>- utilisateurs"]
        E["ğŸ¢ Tables Clients<br/>- reseau<br/>- agence_independante<br/>- responsables/collaborateurs"]
        F["ğŸ”— Tables Connexions<br/>- openai_connexion<br/>- brevo_connexion<br/>- linkedin_connexion"]
        G["ğŸ“Š Historique<br/>- 1_historique_supabase<br/>- abonnement_stripe"]
    end
    
    subgraph "ğŸ”— INTÃ‰GRATIONS EXTERNES"
        H["ğŸ¤– OpenAI API<br/>ğŸŒ Brevo Email<br/>ğŸ’¼ LinkedIn<br/>ğŸ“˜ Facebook<br/>ğŸ“¸ Instagram<br/>ğŸ’¼ Zoho CRM<br/>ğŸ’³ Stripe"]
    end
    
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    C --> H
```

---

## ğŸ—ï¸ ARCHITECTURE MULTI-TENANT

```mermaid
graph TD
    subgraph "ğŸ‘¤ TYPES UTILISATEURS"
        U1["ğŸ‘‘ Admin PRESENCA<br/>- AccÃ¨s global<br/>- Gestion organisations<br/>- Super admin"]
        U2["ğŸ¢ RÃ©seau Direction<br/>- Gestion rÃ©seau<br/>- Vue agences<br/>- Administration"]
        U3["ğŸª Agence Responsable<br/>- Gestion agence<br/>- Ã‰quipe locale<br/>- Clients"]
        U4["ğŸ‘¨â€ğŸ’¼ Collaborateur<br/>- Utilisation outils<br/>- DonnÃ©es limitÃ©es<br/>- TÃ¢ches opÃ©rationnelles"]
    end
    
    subgraph "ğŸ¢ ORGANISATIONS"
        O1["ğŸŒŸ PRESENCA<br/>organisation_id: special<br/>AccÃ¨s: global"]
        O2["ğŸ¢ RÃ©seau<br/>organisation_id: unique<br/>AccÃ¨s: rÃ©seau + agences"]
        O3["ğŸª Agence RÃ©seau<br/>organisation_id: rÃ©seau<br/>AccÃ¨s: agence seule"]
        O4["ğŸª Agence IndÃ©pendante<br/>organisation_id: unique<br/>AccÃ¨s: agence seule"]
    end
    
    subgraph "ğŸ” ISOLATION DONNÃ‰ES RLS"
        R1["ğŸ›¡ï¸ Row Level Security<br/>- organisation_id filter<br/>- Fonctions sÃ©curisÃ©es<br/>- Policies strictes"]
        R2["âš¡ Fonctions RPC<br/>- get_user_organisation_id()<br/>- is_admin_presenca()<br/>- get_organisation_type()"]
    end
    
    U1 -.-> O1
    U2 --> O2
    U3 --> O3
    U4 --> O4
    
    O1 --> R1
    O2 --> R1
    O3 --> R1
    O4 --> R1
    
    R1 --> R2
```

---

## ğŸ—„ï¸ ARCHITECTURE BASE DE DONNÃ‰ES

```mermaid
erDiagram
    %% Tables principales
    ORGANISATIONS ||--o{ USERS : "organisation_id"
    ORGANISATIONS ||--o{ UTILISATEURS : "organisation_id"
    
    %% HiÃ©rarchie RÃ©seau
    ORGANISATIONS ||--o{ RESEAU : "organisation_id"
    RESEAU ||--o{ RESEAU_DIRECTION : "reseau_id"
    RESEAU ||--o{ RESEAU_AGENCE : "reseau_id"
    RESEAU_AGENCE ||--o{ RESEAU_AGENCE_RESPONSABLE : "reseau_agence_id"
    RESEAU_AGENCE ||--o{ RESEAU_AGENCE_COLLABORATEUR : "reseau_agence_id"
    
    %% Agences IndÃ©pendantes
    ORGANISATIONS ||--o{ AGENCE_INDEPENDANTE : "organisation_id"
    AGENCE_INDEPENDANTE ||--o{ AGENCE_INDEPENDANTE_RESPONSABLE : "agence_indep_id"
    AGENCE_INDEPENDANTE ||--o{ AGENCE_INDEPENDANTE_COLLABORATEUR : "agence_indep_id"
    
    %% Connexions externes
    ORGANISATIONS ||--o{ BREVO_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ OPENAI_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ LINKEDIN_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ FACEBOOK_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ INSTAGRAM_CONNEXION : "organisation_id"
    ORGANISATIONS ||--o{ ZOHO_CONNEXION : "organisation_id"
    
    %% Audit et paiements
    ORGANISATIONS ||--o{ ABONNEMENT_STRIPE : "organisation_id"
    ORGANISATIONS ||--o{ HISTORIQUE_SUPABASE : "organisation_id"
    
    ORGANISATIONS {
        uuid organisation_id PK
        text organisation_nom
        text organisation_siret
        text organisation_email
        text organisation_statut_compte
        text organisation_plan_stripe
    }
    
    USERS {
        uuid users_id PK
        uuid users_auth_id UK
        uuid users_organisation_id FK
        text users_role_systeme
        text users_nom
        text users_prenom
        text users_email
    }
```

---

## ğŸ”„ FLUX D'AUTHENTIFICATION ACTUEL

```mermaid
sequenceDiagram
    participant U as ğŸ‘¤ Utilisateur
    participant I as ğŸŒ Interface Connexion
    participant A as ğŸ”‘ Admin Direct
    participant S as ğŸ”‘ Supabase Auth
    participant D as ğŸ—ƒï¸ Base DonnÃ©es
    participant H as ğŸ¯ useMultiTenant
    
    Note over I: âŒ VIDE/NON FONCTIONNELLE
    Note over A: ğŸš« Google Auth DÃ‰SACTIVÃ‰
    
    U->>I: AccÃ¨s application (dÃ©veloppement)
    I->>A: AccÃ¨s admin direct
    A->>S: Session admin
    S->>D: Recherche utilisateur
    
    alt âœ… Admin PRESENCA existe
        D->>H: RÃ©cupÃ©ration profil admin
        H->>H: get_user_organisation_id()
        H->>H: VÃ©rification statut admin
        H->>U: â†’ /admin-presenca
        
    else âŒ Pas d'accÃ¨s
        D->>U: Redirection login
        Note over U,H: ğŸš¨ WORKFLOW COMPLET Ã€ IMPLÃ‰MENTER
    end
    
    Note over U,H: âš ï¸ PHASE FUTURE: Google Auth + Demandes
```

---

## ğŸ’» INTERFACES UTILISATEUR - POINTS D'ENTRÃ‰E

```mermaid
graph LR
    subgraph "ğŸŒ AUTHENTIFICATION - DÃ‰VELOPPEMENT"
        LOGIN["ğŸ” Interface Connexion<br/>âŒ VIDE - Ã€ IMPLÃ‰MENTER"]
        ADMIN_DIRECT["ğŸ‘‘ AccÃ¨s Admin Direct<br/>ğŸ”§ Mode dÃ©veloppement"]
        REQUEST["ğŸ“ Demande Compte<br/>âŒ N'EXISTE PAS"]
    end
    
    subgraph "ğŸš« DÃ‰SACTIVÃ‰ ACTUELLEMENT"
        GOOGLE["ğŸ” Google OAuth<br/>ğŸš« DÃ‰SACTIVÃ‰<br/>Phase future"]
    end
    
    subgraph "ğŸ¯ ESPACES DISPONIBLES"
        ADMIN["ğŸ‘‘ /admin-presenca<br/>âœ… Admin PRESENCA"]
        RESEAU["ğŸ¢ /espace-reseau<br/>â³ Futur"]
        CLIENT["ğŸª /accueil-leadgenai<br/>â³ Futur"]
    end
    
    ADMIN_DIRECT --> ADMIN
    LOGIN --> REQUEST
    
    style LOGIN fill:#ffcccc
    style REQUEST fill:#ffcccc
    style GOOGLE fill:#e0e0e0
    style ADMIN fill:#ccffcc
    style RESEAU fill:#fff3cd
    style CLIENT fill:#fff3cd
```

---

## ğŸª INTERFACE ESPACE CLIENT

```mermaid
graph TD
    subgraph "ğŸª ESPACE CLIENT - /accueil-leadgenai"
        EC_HOME["ğŸ  Accueil LeadGenAI<br/>- Dashboard personnel<br/>- Statistiques<br/>- AccÃ¨s rapide outils"]
        
        EC_TOOLS["ğŸ› ï¸ Outils IA<br/>- GÃ©nÃ©rateur annonces<br/>- Zone de chalandise<br/>- Contenu automatisÃ©"]
        
        EC_INTEGRATIONS["ğŸ”— Mes IntÃ©grations<br/>- OpenAI<br/>- Brevo<br/>- LinkedIn/Facebook"]
        
        EC_PROFILE["ğŸ‘¤ Mon Profil<br/>- Informations personnelles<br/>- ParamÃ¨tres compte<br/>- PrÃ©fÃ©rences"]
    end
    
    subgraph "âš™ï¸ FONCTIONNALITÃ‰S DISPONIBLES"
        LEAD_GEN["ğŸ“ˆ GÃ©nÃ©ration Leads<br/>âœ… Disponible"]
        CONTENT_AI["âœï¸ Contenu IA<br/>âœ… Disponible"]
        ANALYTICS["ğŸ“Š Analytics<br/>âœ… Disponible"]
        ZONE_CHAL["ğŸ—ºï¸ Zone Chalandise<br/>âœ… Disponible"]
    end
    
    EC_HOME --> EC_TOOLS
    EC_HOME --> EC_INTEGRATIONS
    EC_HOME --> EC_PROFILE
    
    EC_TOOLS --> LEAD_GEN
    EC_TOOLS --> CONTENT_AI
    EC_TOOLS --> ANALYTICS
    EC_TOOLS --> ZONE_CHAL
    
    style EC_HOME fill:#ccffcc
    style EC_TOOLS fill:#ccffcc
    style LEAD_GEN fill:#ccffcc
    style CONTENT_AI fill:#ccffcc
```

---

## ğŸ‘‘ INTERFACE ADMIN PRESENCA

```mermaid
graph TD
    subgraph "ğŸ‘‘ ADMIN PRESENCA - /admin-presenca"
        AP_HOME["ğŸ  Dashboard Admin<br/>- Vue d'ensemble globale<br/>- MÃ©triques systÃ¨me<br/>- Alertes"]
        
        AP_ORGS["ğŸ¢ Gestion Organisations<br/>- Toutes organisations<br/>- CrÃ©ation/modification<br/>- Statuts"]
        
        AP_USERS["ğŸ‘¥ Gestion Utilisateurs<br/>- Tous utilisateurs<br/>- RÃ´les et permissions<br/>- Activation/dÃ©sactivation"]
        
        AP_REQUESTS["ğŸ“ Demandes Comptes<br/>âŒ NON FONCTIONNEL<br/>- Validation demandes<br/>- CrÃ©ation automatique"]
        
        AP_SUBSCRIPTIONS["ğŸ’³ Abonnements<br/>- Stripe management<br/>- Plans et facturation<br/>- Statuts paiement"]
    end
    
    subgraph "ğŸ—ƒï¸ ACCÃˆS DONNÃ‰ES GLOBAL"
        ALL_ORGS["ğŸŒ Toutes Organisations<br/>âœ… RLS bypass admin"]
        ALL_USERS["ğŸ‘¥ Tous Utilisateurs<br/>âœ… RLS bypass admin"]
        ALL_REQUESTS["ğŸ“‹ Toutes Demandes<br/>âŒ Table manquante"]
        ALL_SUBS["ğŸ’° Tous Abonnements<br/>âœ… Disponible"]
    end
    
    AP_HOME --> AP_ORGS
    AP_HOME --> AP_USERS
    AP_HOME --> AP_REQUESTS
    AP_HOME --> AP_SUBSCRIPTIONS
    
    AP_ORGS --> ALL_ORGS
    AP_USERS --> ALL_USERS
    AP_REQUESTS --> ALL_REQUESTS
    AP_SUBSCRIPTIONS --> ALL_SUBS
    
    style AP_REQUESTS fill:#ffcccc
    style ALL_REQUESTS fill:#ffcccc
```

---

## ğŸ”§ INTERFACE ADMIN PRESENCA - CrÃ©ation Comptes

```mermaid
graph TB
    subgraph "ğŸ”§ CRÃ‰ATION COMPTES - PROBLÃˆMES ACTUELS"
        CC_CURRENT["ğŸ“„ CreationComptes.tsx<br/>âŒ FORMULAIRES INCORRECTS<br/>- Tables inexistantes<br/>- Hooks erronÃ©s<br/>- IDs incorrects"]
    end
    
    subgraph "âŒ TABLES INCORRECTES UTILISÃ‰ES"
        WRONG_1["âŒ mauvaise_table_1<br/>N'existe pas en DB"]
        WRONG_2["âŒ mauvaise_table_2<br/>N'existe pas en DB"]  
        WRONG_3["âŒ mauvais_hooks<br/>Pointent vers rien"]
    end
    
    subgraph "âœ… TABLES CORRECTES Ã€ UTILISER"
        CORRECT_1["âœ… organisations<br/>Table principale"]
        CORRECT_2["âœ… reseau<br/>Pour type rÃ©seau"]
        CORRECT_3["âœ… agence_independante<br/>Pour agences indÃ©p"]
        CORRECT_4["âœ… users<br/>Utilisateur initial"]
    end
    
    subgraph "ğŸ¯ WORKFLOW CORRECT"
        STEP_1["1ï¸âƒ£ CrÃ©er organisation<br/>â†’ organisations"]
        STEP_2["2ï¸âƒ£ CrÃ©er structure<br/>â†’ reseau OU agence_independante"]
        STEP_3["3ï¸âƒ£ CrÃ©er utilisateur admin<br/>â†’ users"]
        STEP_4["4ï¸âƒ£ Lier organisation<br/>â†’ users.organisation_id"]
    end
    
    CC_CURRENT --> WRONG_1
    CC_CURRENT --> WRONG_2
    CC_CURRENT --> WRONG_3
    
    WRONG_1 -.-> CORRECT_1
    WRONG_2 -.-> CORRECT_2
    WRONG_3 -.-> CORRECT_3
    
    CORRECT_1 --> STEP_1
    CORRECT_2 --> STEP_2
    CORRECT_3 --> STEP_2
    CORRECT_4 --> STEP_3
    
    STEP_1 --> STEP_2
    STEP_2 --> STEP_3
    STEP_3 --> STEP_4
    
    style CC_CURRENT fill:#ffcccc
    style WRONG_1 fill:#ffcccc
    style WRONG_2 fill:#ffcccc
    style WRONG_3 fill:#ffcccc
    style CORRECT_1 fill:#ccffcc
    style CORRECT_2 fill:#ccffcc
    style CORRECT_3 fill:#ccffcc
    style CORRECT_4 fill:#ccffcc
```

---

## ğŸ“ INTERFACE ADMIN PRESENCA - Demandes Ouverture

```mermaid
graph TB
    subgraph "ğŸ“ DEMANDES OUVERTURE - Ã‰TAT ACTUEL"
        DO_CURRENT["ğŸ“„ DemandeOuvertureCompte.tsx<br/>âŒ HOOK TEMPORAIRE<br/>- Table inexistante<br/>- DonnÃ©es factices<br/>- Aucune fonctionnalitÃ©"]
        
        HOOK_TEMP["ğŸ”§ HookDemandes.tsx<br/>âŒ TEMPORAIRE<br/>- Retourne []<br/>- Message migration<br/>- Non fonctionnel"]
    end
    
    subgraph "âŒ TABLE MANQUANTE"
        MISSING_TABLE["âŒ demandes_creation_compte<br/>ğŸš¨ N'EXISTE PAS<br/>- Aucune structure<br/>- Aucun RLS<br/>- Aucun hook"]
    end
    
    subgraph "âœ… SOLUTION REQUISE"
        CREATE_TABLE["âœ… CrÃ©er Table<br/>demandes_creation_compte<br/>- Structure complÃ¨te<br/>- Champs validation<br/>- RLS policies"]
        
        CREATE_HOOK["âœ… Hook Fonctionnel<br/>- CRUD complet<br/>- Gestion statuts<br/>- Validation admin"]
        
        CREATE_WORKFLOW["âœ… Workflow Complet<br/>- Soumission publique<br/>- Validation admin<br/>- CrÃ©ation automatique"]
    end
    
    subgraph "ğŸ¯ Ã‰TAPES WORKFLOW"
        STEP_A["1ï¸âƒ£ Formulaire public<br/>â†’ Soumission demande"]
        STEP_B["2ï¸âƒ£ Validation admin<br/>â†’ Approve/Reject"]
        STEP_C["3ï¸âƒ£ CrÃ©ation auto<br/>â†’ Organisation + User"]
        STEP_D["4ï¸âƒ£ Notification<br/>â†’ Email confirmation"]
    end
    
    DO_CURRENT --> HOOK_TEMP
    HOOK_TEMP --> MISSING_TABLE
    
    MISSING_TABLE --> CREATE_TABLE
    CREATE_TABLE --> CREATE_HOOK
    CREATE_HOOK --> CREATE_WORKFLOW
    
    CREATE_WORKFLOW --> STEP_A
    STEP_A --> STEP_B
    STEP_B --> STEP_C
    STEP_C --> STEP_D
    
    style DO_CURRENT fill:#ffcccc
    style HOOK_TEMP fill:#ffcccc
    style MISSING_TABLE fill:#ffcccc
    style CREATE_TABLE fill:#ccffcc
    style CREATE_HOOK fill:#ccffcc
    style CREATE_WORKFLOW fill:#ccffcc
```

---

## ğŸš¨ PROBLÃˆMES CRITIQUES IDENTIFIÃ‰S

| ğŸ”´ **CRITIQUE** | ğŸ“ **LOCALISATION** | âŒ **PROBLÃˆME** | âœ… **SOLUTION** |
|----------------|-------------------|-----------------|-----------------|
| **Interface Connexion** | `/components/INTERFACE-CONNEXION` | Dossier vide/non fonctionnel | ImplÃ©menter formulaire complet |
| **Table Demandes** | `demandes_creation_compte` | Table n'existe pas | CrÃ©er table + RLS + hooks |
| **Formulaires Admin** | `CreationComptes.tsx` | Tables/hooks incorrects | Corriger noms tables/IDs |
| **Hook Demandes** | `HookDemandes.tsx` | Hook temporaire factice | ImplÃ©menter CRUD rÃ©el |

---

## ğŸ¯ PLAN D'ACTION PRIORISÃ‰

### ğŸ¥‡ **PHASE 1 - DEMANDES CRÃ‰ATION COMPTE** *(URGENT)*
```mermaid
graph LR
    A["ğŸ—ƒï¸ CrÃ©er Table<br/>demandes_creation_compte"] --> B["ğŸ“ Formulaire Public<br/>Interface soumission"]
    B --> C["ğŸ”§ Hook Fonctionnel<br/>CRUD complet"]
    C --> D["âœ… Tests<br/>Workflow complet"]
```

### ğŸ¥ˆ **PHASE 2 - CORRECTION FORMULAIRES ADMIN**
```mermaid
graph LR
    E["ğŸ”§ Corriger<br/>CreationComptes.tsx"] --> F["ğŸ”§ Corriger<br/>DemandeOuvertureCompte.tsx"]
    F --> G["ğŸ§ª Tests<br/>CrÃ©ation comptes"]
```

### ğŸ¥‰ **PHASE 3 - VALIDATION MULTI-TENANT**
```mermaid
graph LR
    H["ğŸ§ª Tests Isolation<br/>RLS validation"] --> I["ğŸ“Š Performance<br/>Optimisations"]
    I --> J["ğŸš€ Production<br/>Ready"]
```

### ğŸ”® **PHASE FUTURE - AUTHENTIFICATION CLIENT**
```mermaid
graph LR
    K["ğŸ” Google OAuth<br/>RÃ©activation"] --> L["ğŸ‘¥ Workflow Clients<br/>Complet"]
    L --> M["ğŸŒ Interface Publique<br/>Demandes"]
    M --> N["ğŸ“§ Notifications<br/>Email automatique"]
```

---

**ğŸ PRÃŠT POUR PHASE 1 : CrÃ©ation table `demandes_creation_compte` et formulaire public**
**ğŸ“ MODE DÃ‰VELOPPEMENT : AccÃ¨s admin direct uniquement - Google Auth dÃ©sactivÃ©**

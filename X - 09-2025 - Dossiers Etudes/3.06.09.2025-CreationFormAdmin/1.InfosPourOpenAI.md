# Audit Complet - Code SQL Actuel (Expert IA No Code)

## 1. Fonction SQL `sync_users_utilisateurs()` - TRIGGER ACTUEL

```sql
CREATE OR REPLACE FUNCTION public.sync_users_utilisateurs()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Synchronisation users ‚Üí utilisateurs
  IF TG_TABLE_NAME = 'users' AND TG_OP = 'UPDATE' THEN
    UPDATE public.utilisateurs 
    SET 
      utilisateur_email = NEW.users_email,
      utilisateur_organisation_id = NEW.users_organisation_id
    WHERE utilisateur_auth_uid = NEW.users_auth_id;
  END IF;
  
  -- Synchronisation utilisateurs ‚Üí users  
  IF TG_TABLE_NAME = 'utilisateurs' AND TG_OP = 'UPDATE' THEN
    UPDATE public.users 
    SET 
      users_email = NEW.utilisateur_email,
      users_organisation_id = NEW.utilisateur_organisation_id
    WHERE users_auth_id = NEW.utilisateur_auth_uid;
  END IF;
  
  RETURN NEW;
END;
$function$
```

**‚ùå PROBL√àME IDENTIFI√â :** Boucle infinie potentielle ! 
- Update sur `users` ‚Üí trigger ‚Üí update sur `utilisateurs` ‚Üí trigger ‚Üí update sur `users` ‚Üí etc.

---

## 2. Fonction SQL `create_reseau_compte_complet()` - VERSION ACTUELLE

```sql
CREATE OR REPLACE FUNCTION public.create_reseau_compte_complet(
  p_nom_reseau text, p_adresse text, p_code_postal text, p_ville text, p_siret text, 
  p_nom_responsable text, p_prenom_responsable text, p_email_responsable text, 
  p_telephone_responsable text, p_auth_uid uuid
)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_org_id uuid;
  v_user_id uuid;
  v_utilisateur_id uuid;
  v_reseau_id uuid;
  v_direction_id uuid;
BEGIN
  -- 1. Organisation
  INSERT INTO organisations (
    organisation_nom, organisation_adresse, organisation_code_postal,
    organisation_ville, organisation_siret, organisation_email,
    organisation_telephone, organisation_statut_compte
  )
  VALUES (
    p_nom_reseau, p_adresse, p_code_postal, p_ville, p_siret,
    p_email_responsable, p_telephone_responsable, 'actif'
  )
  RETURNING organisation_id INTO v_org_id;

  -- 2. Users ‚ùå ERREUR ICI
  INSERT INTO users (
    users_nom, users_prenom, users_email, users_telephone,
    users_role_systeme, users_organisation_id, users_auth_id
  )
  VALUES (
    p_nom_responsable, p_prenom_responsable, p_email_responsable,
    p_telephone_responsable, 'reseau', v_org_id, p_auth_uid
  )
  RETURNING users_id INTO v_user_id;

  -- 3. Utilisateurs ‚ùå ERREUR ICI AUSSI
  INSERT INTO utilisateurs (
    utilisateur_email, utilisateur_type_compte, utilisateur_statut,
    utilisateur_organisation_id, utilisateur_auth_uid, utilisateur_role_systeme
  )
  VALUES (
    p_email_responsable, 'reseau', 'actif',
    v_org_id, p_auth_uid, 'reseau'
  )
  RETURNING utilisateur_id INTO v_utilisateur_id;

  -- 4. R√©seau
  INSERT INTO reseau (
    organisation_id, reseau_nom, reseau_adresse, reseau_code_postal,
    reseau_ville, reseau_siret, reseau_email, reseau_telephone,
    reseau_statut, client_type
  )
  VALUES (
    v_org_id, p_nom_reseau, p_adresse, p_code_postal, p_ville,
    p_siret, p_email_responsable, p_telephone_responsable,
    'actif', 'reseau'
  )
  RETURNING reseau_id INTO v_reseau_id;

  -- 5. Direction R√©seau
  INSERT INTO reseau_direction (
    organisation_id, reseau_id,
    reseau_direction_nom, reseau_direction_prenom,
    reseau_direction_email, reseau_direction_telephone,
    reseau_direction_utilisateur_id, client_type,
    reseau_direction_actif
  )
  VALUES (
    v_org_id, v_reseau_id,
    p_nom_responsable, p_prenom_responsable,
    p_email_responsable, p_telephone_responsable,
    v_utilisateur_id, 'reseau', true
  )
  RETURNING reseau_direction_id INTO v_direction_id;

  -- R√©sultat
  RETURN jsonb_build_object(
    'organisationId', v_org_id,
    'userId', v_user_id,
    'utilisateurId', v_utilisateur_id,
    'reseauId', v_reseau_id,
    'directionId', v_direction_id,
    'message', 'Compte r√©seau cr√©√© avec succ√®s'
  );
END;
$function$
```

**‚ùå ERREURS CRITIQUES CONFIRM√âES :**
1. **Ligne 32** : `users_role_systeme = 'reseau'` ‚Üí FAUX ! Doit √™tre `NULL`
2. **Ligne 43** : `utilisateur_role_systeme = 'reseau'` ‚Üí FAUX ! Doit √™tre `NULL`

---

## 3. Contraintes et Enum Actuels

### Table `users` - Colonne `users_role_systeme`
- **Type :** `text`
- **Nullable :** `YES` ‚úÖ
- **Contrainte :** `CHECK (((users_role_systeme = 'admin_presenca'::text) OR (users_role_systeme IS NULL)))` ‚úÖ

### Table `utilisateurs` - Colonne `utilisateur_type_compte`  
- **Type :** `text`
- **Nullable :** `NO` ‚úÖ
- **Contrainte :** `CHECK ((utilisateur_type_compte = ANY (ARRAY['reseau'::text, 'reseau_direction'::text, 'reseau_agence'::text, 'reseau_agence_responsable'::text, 'reseau_agence_collaborateur'::text, 'agence_independante'::text, 'agence_independante_responsable'::text, 'agence_independante_collaborateur'::text])))` ‚úÖ

### Table `utilisateurs` - Colonne `utilisateur_role_systeme`
- **Type :** `text`  
- **Nullable :** Pas affich√© (probablement `YES`)
- **Contrainte :** `CHECK (((utilisateur_role_systeme = 'admin_presenca'::text) OR (utilisateur_role_systeme IS NULL)))` ‚úÖ

**‚úÖ BONNE NOUVELLE :** Les contraintes sont correctes ! Le probl√®me vient des fonctions SQL qui violent ces contraintes.

---

## 4. Triggers Actuels sur users/utilisateurs

**‚ùå AUCUN TRIGGER TROUV√â** dans la requ√™te
- Soit les triggers `sync_users_utilisateurs` ne sont pas attach√©s
- Soit ils sont inactifs
- Soit il y a un probl√®me de visibilit√©

**‚ö†Ô∏è ATTENTION :** M√™me si inactifs, la fonction `sync_users_utilisateurs()` reste probl√©matique.

---

## 5. Autres Fonctions de Cr√©ation de Comptes

**AUDIT DES FONCTIONS EXISTANTES :**
- `set_created_audit_fields_agence_independante()` ‚úÖ (Trigger audit seulement)
- `set_created_audit_fields_agence_independante_collaborateur()` ‚úÖ (Trigger audit seulement)  
- `set_created_audit_fields_agence_independante_responsable()` ‚úÖ (Trigger audit seulement)
- `set_created_audit_fields_reseau()` ‚úÖ (Trigger audit seulement)
- etc.

**‚ùå AUCUNE autre fonction de cr√©ation compl√®te d√©tect√©e** (type `create_agence_independante_compte_complet`, `create_collaborateur_compte_complet`)

---

## 6. SYNTH√àSE DES PROBL√àMES CONFIRM√âS

### A. Fonction `create_reseau_compte_complet()` 
1. **users_role_systeme = 'reseau'** ‚Üí Doit √™tre `NULL`
2. **utilisateur_role_systeme = 'reseau'** ‚Üí Doit √™tre `NULL`
3. **utilisateur_type_compte = 'reseau'** ‚Üí ‚úÖ Correct

### B. Trigger `sync_users_utilisateurs()`
- Logique de boucle infinie potentielle
- √Ä supprimer ou r√©√©crire avec protection

### C. Contraintes Base
- ‚úÖ **Toutes les contraintes sont correctes**
- Le probl√®me vient uniquement des fonctions SQL

---

## 7. PLAN DE CORRECTION PRIORITAIRE

1. **CORRIGER `create_reseau_compte_complet()`**
   - users_role_systeme = NULL  
   - utilisateur_role_systeme = NULL

2. **SUPPRIMER/D√âSACTIVER `sync_users_utilisateurs()`**
   - Trop dangereux en l'√©tat

3. **CONFIGURER `client.ts`**
   - Ajouter supabaseAdmin avec service_role_key

4. **CORRIGER `useReseauCreation.ts`**
   - Utiliser supabaseAdmin.auth.admin.createUser()
   - Appeler la fonction SQL corrig√©e

---

üëâ **PR√äT POUR LES CORRECTIONS** avec ces sources exactes !

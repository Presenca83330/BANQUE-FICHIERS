Vue dâ€™ensemble de la structure Ã  corriger / organiser
1. Niveaux & responsabilitÃ©s

Supabase Auth (auth.users)
â†’ comptes techniques (login/password/email).

Table users (miroir systÃ¨me)
â†’ rattache chaque compte Auth Ã  une organisation et dÃ©finit son rÃ´le systÃ¨me (admin_presenca ou NULL).

Table utilisateurs (profil mÃ©tier enrichi)
â†’ dÃ©finit le type de compte (reseau, reseau_direction, agence_independante, â€¦), son statut, et rattachement organisationnel.

Table organisations
â†’ pivot multi-tenant (rÃ©seau ou agence indÃ©pendante).

Tables business (reseau, reseau_direction, reseau_agence, â€¦)
â†’ stockent les infos propres aux structures.

ğŸ‘‰ RÃ¨gle dâ€™or :

users.users_role_systeme = rÃ©servÃ© aux admins PRESENCA.

utilisateurs.utilisateur_type_compte = tous les rÃ´les clients (reseau, agenceâ€¦).

2. Fichiers cÃ´tÃ© Application (Lovable)
ğŸ—‚ï¸ /integrations/supabase/client.ts

Doit exposer 2 clients distincts :

supabase (anon key) â†’ utilisÃ© par 99 % des hooks.

supabaseAdmin (service role key) â†’ utilisÃ© seulement dans useReseauCreation (et futurs hooks de crÃ©ation).

ğŸ—‚ï¸ Hooks StratÃ©giques

useAuth â†’ inchangÃ©, reste branchÃ© sur supabase (anon).

useCurrentUser â†’ lit users + utilisateurs. Pas besoin de correction.

useMultiTenant â†’ redirections correctes.

useSupabaseOperations â†’ reste sur supabase (anon).

ğŸ—‚ï¸ Hooks de crÃ©ation (Admin Presenca)

useReseauCreation.ts

Actuellement bugguÃ© car utilise supabase (anon).

Ã€ corriger pour :

CrÃ©er un Auth User avec supabaseAdmin.auth.admin.createUser.

Appeler la fonction SQL create_reseau_compte_complet(p_auth_uid) pour crÃ©er le reste.

Retourner lâ€™email + mot de passe pour SuccessAccountInfo.

âš ï¸ MÃªme correction Ã  prÃ©voir pour futurs hooks (useAgenceIndependanteCreation, useCollaborateurCreation, etc.).

ğŸ—‚ï¸ Formulaires

FormReseauCreation.tsx â†’ OK, juste prÃ©voir validations â€œunicitÃ© email + SIRETâ€.

SuccessAccountInfo.tsx â†’ OK, garde lâ€™affichage du mdp temporaire.

3. CÃ´tÃ© Supabase (SQL & Policies)
âœ… Ã€ garder

Tables auth.users, users, utilisateurs, organisations.

RLS basÃ©es sur organisation_id.

Fonctions : is_admin_presenca(), get_user_organisation_id().

âš ï¸ Ã€ corriger

Enum / contraintes

users_role_systeme â†’ doit rester limitÃ© Ã  'admin_presenca' ou NULL.

utilisateur_type_compte â†’ doit contenir reseau, reseau_direction, reseau_agence, etc. (mais pas admin_presenca).

Trigger sync_users_utilisateurs()

Actuellement crÃ©e une boucle infinie.

Soit Ã  dÃ©sactiver, soit Ã  simplifier pour Ã©viter la double synchro (repose plutÃ´t sur fonctions SQL de crÃ©ation complÃ¨tes).

Fonction SQL create_reseau_compte_complet

Actuelle version est fausse (elle met "reseau" dans users_role_systeme).

Ã€ corriger en :

users_role_systeme = NULL (car ce nâ€™est pas un admin).

utilisateur_type_compte = 'reseau', utilisateur_statut = 'actif'.

Attendre un vrai p_auth_uid venant de auth.users (crÃ©Ã© par le hook avec supabaseAdmin).

ProcÃ©dures futures Ã  dupliquer

create_agence_independante_compte_complet().

create_collaborateur_compte_complet().

Toutes doivent suivre la mÃªme logique.

4. Workflow idÃ©al de crÃ©ation dâ€™un compte rÃ©seau

FormReseauCreation.tsx â†’ admin remplit le form.

useReseauCreation.ts â†’

GÃ©nÃ¨re un mdp temporaire.

Appelle supabaseAdmin.auth.admin.createUser.

Passe lâ€™authUser.id Ã  la fonction SQL create_reseau_compte_complet().

Retourne email + mdp.

SuccessAccountInfo.tsx â†’ affiche les infos Ã  lâ€™admin.

Utilisateur final â†’ se connecte avec email + mdp, obligÃ© de changer son mot de passe.

ğŸ¯ SynthÃ¨se

App cÃ´tÃ© Lovable

client.ts doit gÃ©rer 2 clients (supabase, supabaseAdmin).

useReseauCreation.ts doit utiliser supabaseAdmin pour Auth + RPC pour cascade SQL.

FormReseauCreation et SuccessAccountInfo â†’ OK (petites validations Ã  renforcer).

CÃ´tÃ© Supabase

Corriger lâ€™enum / contrainte users_role_systeme.

RÃ©Ã©crire create_reseau_compte_complet() sans mÃ©langer rÃ´le systÃ¨me & rÃ´le mÃ©tier.

DÃ©sactiver / corriger le trigger de synchro.

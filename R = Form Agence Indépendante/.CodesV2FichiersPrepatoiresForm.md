# CODES ET EMPLACEMENTS | FICHIERS UTILISÉS PAR FORMULAIRE **AGENCE INDEPENDANTE**  
_Mise à jour : 2025-10-14_  
- Conforme au **mapping officiel** (.TablesReferenceAgenceIndependante.ts)
- Aux **tables de référence**
- Respecte la **charte graphique** et la **structure RÉSEAU** (Accueil / Création / Gestion + onglets).
- Contrats de retour **uniformisés**: `{ success, data, message, requestId, duration_ms }`.
- Service Role activé côté **Edge Functions** (verify_jwt=false).

---

# TITRE 1. HOOKS FORM CREATEUR

## N1. `src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/types.ts`
```typescript
// Mapping strict : champs agence_indep_* et agence_indep_responsable_*
// Références : .TablesReferenceAgenceIndependante.ts / Agence_Independante_UseTables.zip

export type CreateAgenceIndependantePayload = {
  agence: {
    agence_indep_nom: string;
    agence_indep_siret: string;
    agence_indep_adresse: string;
    agence_indep_code_postal: string;
    agence_indep_ville: string;
    agence_indep_email: string;
    agence_indep_telephone: string;
    agence_indep_identite_commerciale?: string | null;
  };
  responsable: {
    agence_indep_responsable_prenom: string;
    agence_indep_responsable_nom: string;
    agence_indep_responsable_email: string;
    agence_indep_responsable_telephone: string;
  };
};

export type CreateAgenceResponse = {
  success: boolean;
  data?: {
    organisation: { organisation_id: string; organisation_nom: string };
    agence: { agence_indep_id: string; agence_indep_nom: string };
    user: { id: string; email: string };
  };
  message?: string;
  error?: string;
  details?: string;
  requestId?: string;
  duration_ms?: number;
};
```

---

## N2. `src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/useAgenceIndependanteCreation.ts`
```typescript
import { useCallback, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { CreateAgenceIndependantePayload, CreateAgenceResponse } from "./types";

export function useAgenceIndependanteCreation() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [result, setResult] = useState<CreateAgenceResponse | null>(null);

  const createAgence = useCallback(async (payload: CreateAgenceIndependantePayload) => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<CreateAgenceResponse>(
        "create-agence-independante-admin",
        { body: payload }
      );
      if (error) throw error;
      setResult(data ?? null);
      return data ?? null;
    } catch (e: any) {
      setError(e?.message ?? "Erreur inconnue");
      return null;
    } finally {
      setLoading(false);
    }
  }, []);

  return { createAgence, loading, error, result };
}
```

---

# TITRE 2. HOOKS FORM GESTION

## N3. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector.tsx`
```typescript
import React from "react";
import type { AgenceIndependanteMinimal } from "../hooks/types";

type Props = {
  agences: AgenceIndependanteMinimal[];
  selectedAgenceId: string | null;
  onChange: (id: string | null) => void;
  disabled?: boolean;
};

/** Sélecteur minimal ; peut être remplacé par le composant DS sans changer l'API. */
const AgenceIndependanteSelector: React.FC<Props> = ({ agences, selectedAgenceId, onChange, disabled }) => {
  return (
    <select
      value={selectedAgenceId ?? ""}
      onChange={(e) => onChange(e.target.value || null)}
      disabled={disabled}
      style={{ width: "100%", padding: 8 }}
    >
      <option value="">{agences.length ? "Sélectionner une agence" : "Aucune agence disponible"}</option>
      {agences.map((a) => (
        <option key={a.agence_id} value={a.agence_id}>
          {a.agence_nom}
        </option>
      ))}
    </select>
  );
};

export default AgenceIndependanteSelector;
```

---

## N4. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/types.ts`
```typescript
// Types stricts, calés sur .TablesReferenceAgenceIndependante.ts

export type AgenceIndependanteMinimal = {
  agence_id: string;     // = agence_indep_id
  agence_nom: string;    // = agence_indep_nom
};

export type AgenceIndependante = {
  agence_indep_id: string;
  organisation_id: string;
  client_id?: string;
  client_type?: string;
  agence_indep_nom: string;
  agence_indep_identite_commerciale?: string | null;
  agence_indep_siret?: string | null;
  agence_indep_adresse?: string | null;
  agence_indep_code_postal?: string | null;
  agence_indep_ville?: string | null;
  agence_indep_email?: string | null;
  agence_indep_telephone?: string | null;
  agence_indep_logo?: string | null;
  agence_indep_ressources?: string[] | null;
  // Intégrations (FK optionnelles)
  agence_indep_brevo_connexion_id?: string | null;
  agence_indep_zoho_connexion_id?: string | null;
  agence_indep_openai_connexion_id?: string | null;
  agence_indep_linkedin_connexion_id?: string | null;
  agence_indep_facebook_connexion_id?: string | null;
  agence_indep_instagram_connexion_id?: string | null;
  // Timestamps génériques
  agence_indep_created_at?: string;
  agence_indep_updated_at?: string;
  [k: string]: any;
};

export type IntegrationsMap = {
  brevo: any | null;
  zoho: any | null;
  openai: any | null;
  linkedin: any | null;
  facebook: any | null;
  instagram: any | null;
};

export type ListAgencesResponse = {
  success: boolean;
  data?: AgenceIndependanteMinimal[];
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type AgenceDetailResponse = {
  success: boolean;
  data?: { agence: AgenceIndependante; integrations: IntegrationsMap };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type UpdateAgenceResponse = {
  success: boolean;
  data?: { agence?: AgenceIndependante; integration?: any };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type FileUploadResponse = {
  success: boolean;
  data?: { path: string; fileType: "logo" | "ressource" };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type FileDeleteResponse = {
  success: boolean;
  data?: { deleted: string; fileType: "logo" | "ressource" };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type AbonnementStripeView = {
  abonnement_stripe_plan: string | null;
  abonnement_stripe_debut: string | null;
};
```

---

## N5. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAbonnementStripeView.ts`
```typescript
import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { AbonnementStripeView } from "./types";

/** Lecture *read-only* du plan + date de début Stripe. */
export function useAbonnementStripeView(organisationId: string | null) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<AbonnementStripeView | null>(null);

  const load = useCallback(async () => {
    if (!organisationId) {
      setData({ abonnement_stripe_plan: null, abonnement_stripe_debut: null });
      return;
    }
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase
        .from("abonnement_stripe")
        .select("abonnement_stripe_plan, abonnement_stripe_debut")
        .eq("organisation_id", organisationId)
        .order("abonnement_stripe_debut", { ascending: false })
        .limit(1);
      if (error) throw error;
      const row = (data?.[0] ?? null) as any;
      setData(row
        ? { abonnement_stripe_plan: row.abonnement_stripe_plan, abonnement_stripe_debut: row.abonnement_stripe_debut }
        : { abonnement_stripe_plan: null, abonnement_stripe_debut: null });
    } catch (e: any) {
      setError(e?.message ?? "Erreur lecture abonnement");
    } finally {
      setLoading(false);
    }
  }, [organisationId]);

  useEffect(() => { load(); }, [load]);

  return { loading, error, data, reload: load };
}
```

---

## N6. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData.ts`
```typescript
import { useCallback, useEffect, useMemo, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type {
  AgenceIndependante,
  AgenceIndependanteMinimal,
  AgenceDetailResponse,
  ListAgencesResponse,
  UpdateAgenceResponse,
} from "./types";

export function useAgenceIndependanteFormData() {
  const [loading, setLoading] = useState(false);
  const [agences, setAgences] = useState<AgenceIndependanteMinimal[]>([]);
  const [selectedAgenceId, setSelectedAgenceId] = useState<string | null>(null);
  const [formData, setFormData] = useState<AgenceIndependante | null>(null);
  const [integrations, setIntegrations] = useState<Record<string, any> | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [savingGeneral, setSavingGeneral] = useState(false);

  const loadAgences = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<ListAgencesResponse>(
        "gestion-agence-independante-admin",
        { body: {} }
      );
      if (error) throw error;
      setAgences(data?.data ?? []);
    } catch (e: any) {
      setError(e?.message ?? "Erreur chargement agences");
    } finally {
      setLoading(false);
    }
  }, []);

  const loadAgenceData = useCallback(async (agenceId: string) => {
    if (!agenceId) return;
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<AgenceDetailResponse>(
        "gestion-agence-independante-admin-donnees",
        { body: { agence_id: agenceId } }
      );
      if (error) throw error;
      const row = data?.data?.agence ?? null;
      const integ = data?.data?.integrations ?? null;
      setFormData(row);
      setIntegrations(integ);
    } catch (e: any) {
      setError(e?.message ?? "Erreur chargement agence");
    } finally {
      setLoading(false);
    }
  }, []);

  const saveGeneral = useCallback(async (patch: Partial<AgenceIndependante>) => {
    if (!selectedAgenceId) return null;
    setSavingGeneral(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<UpdateAgenceResponse>(
        "gestion-agence-independante-admin-update",
        { body: { agence_id: selectedAgenceId, generalData: patch } }
      );
      if (error) throw error;
      const updated = data?.data?.agence ?? null;
      if (updated) setFormData(updated);
      return updated;
    } catch (e: any) {
      setError(e?.message ?? "Erreur sauvegarde");
      return null;
    } finally {
      setSavingGeneral(false);
    }
  }, [selectedAgenceId]);

  useEffect(() => { loadAgences(); }, [loadAgences]);
  useEffect(() => { if (selectedAgenceId) loadAgenceData(selectedAgenceId); }, [selectedAgenceId, loadAgenceData]);

  const organisationId = useMemo(() => formData?.organisation_id ?? null, [formData]);

  return {
    loading, error,
    agences, selectedAgenceId, setSelectedAgenceId,
    formData, integrations, organisationId,
    loadAgences,
    loadAgenceData,
    saveGeneral, savingGeneral,
  };
}
```

---

## N7. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteIntegrations.ts`
```typescript
import { useCallback, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { UpdateAgenceResponse } from "./types";

type Kind = "brevo" | "zoho" | "openai" | "linkedin" | "facebook" | "instagram";

export function useAgenceIndependanteIntegrations(agenceId: string | null) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const saveIntegration = useCallback(async (kind: Kind, integrationData: Record<string, any>) => {
    if (!agenceId) return null;
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<UpdateAgenceResponse>(
        "gestion-agence-independante-admin-update",
        { body: { agence_id: agenceId, integrationKind: kind, integrationData } }
      );
      if (error) throw error;
      return data?.data?.integration ?? null;
    } catch (e: any) {
      setError(e?.message ?? "Erreur sauvegarde intégration");
      return null;
    } finally {
      setLoading(false);
    }
  }, [agenceId]);

  return { saveIntegration, loading, error };
}
```

---

# TITRE 3. FUNCTIONS FORM CREATEUR

## N8. `supabase/functions/create-agence-independante-admin/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}

function rid() { return crypto.randomUUID(); }

// === SCHEMA (fixe) ===
// Tables pivots
const T_ORG = "organisations";
const T_USERS = "users";
const T_UTIL = "utilisateurs";

// Agence
const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const ORG = "organisation_id";
const COL_NOM = "agence_indep_nom";
const COL_IDENTITE = "agence_indep_identite_commerciale";
const COL_SIRET = "agence_indep_siret";
const COL_ADRESSE = "agence_indep_adresse";
const COL_CP = "agence_indep_code_postal";
const COL_VILLE = "agence_indep_ville";
const COL_EMAIL = "agence_indep_email";
const COL_TEL = "agence_indep_telephone";
const COL_LOGO = "agence_indep_logo";
const COL_RESS = "agence_indep_ressources"; // text[]

// Responsable
const T_RESP = "agence_independante_responsable";
const RESP_ID = "agence_indep_responsable_id";
const RESP_UTIL_ID = "agence_indep_responsable_utilisateur_id";
const RESP_NOM = "agence_indep_responsable_nom";
const RESP_PRENOM = "agence_indep_responsable_prenom";
const RESP_EMAIL = "agence_indep_responsable_email";
const RESP_TEL = "agence_indep_responsable_telephone";

Deno.serve(async (req) => {
  const t0 = performance.now();
  const requestId = rid();
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const body = await req.json().catch(() => ({}));
    const agence = body?.agence || {};
    const resp = body?.responsable || {};

    // Validation stricte
    const required = [COL_NOM, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL];
    for (const k of required) {
      if (!agence?.[k]) return ok({ success: false, error: `missing_${k}`, requestId }, 400);
    }
    const respReq = [RESP_PRENOM, RESP_NOM, RESP_EMAIL, RESP_TEL];
    for (const k of respReq) {
      if (!resp?.[k]) return ok({ success: false, error: `missing_${k}`, requestId }, 400);
    }

    // 1) Organisation (minimal)
    const { data: org, error: eOrg } = await supabase.from(T_ORG)
      .insert({ organisation_nom: agence[COL_NOM] })
      .select("organisation_id, organisation_nom").single();
    if (eOrg) return ok({ success: false, error: "db_error_organisation_insert", details: eOrg.message, requestId }, 500);

    // 2) Agence
    const insertAgence: Record<string, any> = {
      [ORG]: org.organisation_id,
      [COL_NOM]: agence[COL_NOM],
      [COL_SIRET]: agence[COL_SIRET],
      [COL_ADRESSE]: agence[COL_ADRESSE],
      [COL_CP]: agence[COL_CP],
      [COL_VILLE]: agence[COL_VILLE],
      [COL_EMAIL]: agence[COL_EMAIL],
      [COL_TEL]: agence[COL_TEL],
    };
    if (COL_IDENTITE in agence) insertAgence[COL_IDENTITE] = agence[COL_IDENTITE];

    const { data: ag, error: eAg } = await supabase.from(T_AGENCE).insert(insertAgence)
      .select(`${PK}, ${ORG}, ${COL_NOM}`).single();
    if (eAg) {
      // rollback organisation
      await supabase.from(T_ORG).delete().eq("organisation_id", org.organisation_id);
      return ok({ success: false, error: "db_error_agence_insert", details: eAg.message, requestId }, 500);
    }

    // 3) Auth user
    const authRes = await supabase.auth.admin.createUser({
      email: resp[RESP_EMAIL],
      email_confirm: true,
      user_metadata: {
        role: "agence_independante_responsable",
        [ORG]: org.organisation_id,
        [PK]: ag[PK],
        prenom: resp[RESP_PRENOM],
        nom: resp[RESP_NOM],
        telephone: resp[RESP_TEL],
      },
    });
    if (authRes.error) {
      // Full rollback
      await supabase.from(T_AGENCE).delete().eq(PK, ag[PK]);
      await supabase.from(T_ORG).delete().eq("organisation_id", org.organisation_id);
      return ok({ success: false, error: "auth_create_user_error", details: authRes.error.message, requestId }, 500);
    }
    const user = authRes.data.user;

    // 4) Table systeme users
    try {
      await supabase.from(T_USERS).insert({
        users_auth_id: user?.id,
        users_email: resp[RESP_EMAIL],
        users_organisation_id: org.organisation_id,
        users_role: "client",
        users_role_systeme: "agence_independante_responsable",
        users_interface_par_defaut: "client_espace",
      });
    } catch (_) { /* on ignore si table non présente */ }

    // 5) Utilisateurs (profil métier)
    const { data: util, error: eUtil } = await supabase.from(T_UTIL).insert({
      utilisateur_auth_uid: user?.id,
      utilisateur_organisation_id: org.organisation_id,
      utilisateur_email: resp[RESP_EMAIL],
      utilisateur_role: "responsable",
      utilisateur_type_compte: "agence_independante",
      utilisateur_statut: "actif",
    }).select("utilisateur_id").single();
    if (eUtil) {
      // compensation: supprimer user + agence + org
      await supabase.auth.admin.deleteUser(user!.id);
      await supabase.from(T_AGENCE).delete().eq(PK, ag[PK]);
      await supabase.from(T_ORG).delete().eq("organisation_id", org.organisation_id);
      return ok({ success: false, error: "db_error_utilisateur_insert", details: eUtil.message, requestId }, 500);
    }

    // 6) Responsable agence (lié à l'utilisateur métier)
    const { error: eResp } = await supabase.from("agence_independante_responsable").insert({
      [ORG]: org.organisation_id,
      [PK]: ag[PK],
      ["agence_indep_responsable_utilisateur_id"]: util.utilisateur_id,
      [RESP_PRENOM]: resp[RESP_PRENOM],
      [RESP_NOM]: resp[RESP_NOM],
      [RESP_EMAIL]: resp[RESP_EMAIL],
      [RESP_TEL]: resp[RESP_TEL],
    });
    if (eResp) {
      // compensation: supprimer util + user + agence + org
      await supabase.from(T_UTIL).delete().eq("utilisateur_id", util.utilisateur_id);
      await supabase.auth.admin.deleteUser(user!.id);
      await supabase.from(T_AGENCE).delete().eq(PK, ag[PK]);
      await supabase.from(T_ORG).delete().eq("organisation_id", org.organisation_id);
      return ok({ success: false, error: "db_error_responsable_insert", details: eResp.message, requestId }, 500);
    }

    const t1 = performance.now();
    return ok({
      success: true,
      data: {
        organisation: org,
        agence: { [PK]: ag[PK], [COL_NOM]: ag[COL_NOM] },
        user: { id: user?.id, email: resp[RESP_EMAIL] }
      },
      message: "Agence créée",
      requestId,
      duration_ms: Math.round(t1 - t0)
    });
  } catch (e) {
    const t1 = performance.now();
    return ok({ success: false, error: "internal_error", details: String(e), requestId, duration_ms: Math.round(t1 - t0) }, 500);
  }
});
```

---

# TITRE 4. FUNCTIONS FORM GESTION

## N9. `supabase/functions/gestion-agence-independante-admin/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}
function rid() { return crypto.randomUUID(); }

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const COL_NOM = "agence_indep_nom";
const PROJECTION_MIN = `${COL_NOM}, ${PK}`;

Deno.serve(async (req) => {
  const t0 = performance.now();
  const requestId = rid();
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const { data, error } = await supabase.from(T_AGENCE).select(PROJECTION_MIN).order(COL_NOM, { ascending: true });
    if (error) return ok({ success: false, error: "db_error_agence_list", details: error.message, requestId }, 500);
    const mapped = (data ?? []).map((r: any) => ({ agence_id: r[PK], agence_nom: r[COL_NOM] }));
    const t1 = performance.now();
    return ok({ success: true, data: mapped, message: `${mapped.length} agence(s)`, requestId, duration_ms: Math.round(t1 - t0) });
  } catch (e) {
    const t1 = performance.now();
    return ok({ success: false, error: "internal_error", details: String(e), requestId, duration_ms: Math.round(t1 - t0) }, 500);
  }
});
```

---

## N10. `supabase/functions/gestion-agence-independante-admin-donnees/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}
function rid() { return crypto.randomUUID(); }

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const ORG = "organisation_id";
const COL_NOM = "agence_indep_nom";
const COL_IDENTITE = "agence_indep_identite_commerciale";
const COL_SIRET = "agence_indep_siret";
const COL_ADRESSE = "agence_indep_adresse";
const COL_CP = "agence_indep_code_postal";
const COL_VILLE = "agence_indep_ville";
const COL_EMAIL = "agence_indep_email";
const COL_TEL = "agence_indep_telephone";
const COL_LOGO = "agence_indep_logo";
const COL_RESS = "agence_indep_ressources"; // text[]

const FK_BREVO = "agence_indep_brevo_connexion_id";
const FK_ZOHO = "agence_indep_zoho_connexion_id";
const FK_OPENAI = "agence_indep_openai_connexion_id";
const FK_LINKEDIN = "agence_indep_linkedin_connexion_id";
const FK_FACEBOOK = "agence_indep_facebook_connexion_id";
const FK_INSTAGRAM = "agence_indep_instagram_connexion_id";

const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

Deno.serve(async (req) => {
  const t0 = performance.now();
  const requestId = rid();
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const body = await req.json().catch(() => ({}));
    const agenceId = body?.agence_id as string | undefined;
    if (!agenceId) return ok({ success: false, error: "bad_request_missing_agence_id", requestId }, 400);

    const { data: agence, error } = await supabase
      .from(T_AGENCE)
      .select(PROJECTION_DETAIL)
      .eq(PK, agenceId)
      .maybeSingle();
    if (error) return ok({ success: false, error: "db_error_agence_fetch", details: error.message, requestId }, 500);
    if (!agence) return ok({ success: false, error: "not_found_agence", requestId }, 404);

    const integrations: Record<string, any> = { brevo: null, zoho: null, openai: null, linkedin: null, facebook: null, instagram: null };
    const tasks: Promise<void>[] = [];

    for (const kind of Object.keys(INTEGRATION_TABLES)) {
      const cfg = INTEGRATION_TABLES[kind];
      const fkVal = (agence as any)[cfg.fk];
      if (!fkVal) continue;
      tasks.push(
        supabase.from(cfg.table).select("*").eq(cfg.id, fkVal).maybeSingle().then(({ data, error }) => {
          if (!error) integrations[kind] = data ?? null;
        })
      );
    }
    if (tasks.length) await Promise.all(tasks);

    const t1 = performance.now();
    return ok({ success: true, data: { agence, integrations }, message: "OK", requestId, duration_ms: Math.round(t1 - t0) });
  } catch (e) {
    const t1 = performance.now();
    return ok({ success: false, error: "internal_error", details: String(e), requestId, duration_ms: Math.round(t1 - t0) }, 500);
  }
});
```

---

## N11. `supabase/functions/gestion-agence-independante-admin-fichiers/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}
function rid() { return crypto.randomUUID(); }

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const COL_LOGO = "agence_indep_logo";
const COL_RESS = "agence_indep_ressources"; // text[]

const BUCKET_NAME = "bucket-table-agence-independante";

function sanitizeFilename(name: string) { return name.replace(/[^a-zA-Z0-9._-]/g, "_"); }
function pathFor(agenceId: string, kind: "logo"|"ressource", fn: string) {
  const folder = kind === "logo" ? "1-logos" : "2-documents-institutionnels";
  return `agence-${agenceId}/${folder}/${Date.now()}_${sanitizeFilename(fn)}`;
}

Deno.serve(async (req) => {
  const t0 = performance.now();
  const requestId = rid();
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const ct = req.headers.get("content-type") || "";
    if (ct.includes("multipart/form-data")) {
      const fd = await req.formData();
      const agenceId = String(fd.get("agence_id") || "");
      const fileType = String(fd.get("fileType") || "");
      const file = fd.get("file") as File | null;
      if (!agenceId || !file || !["logo","ressource"].includes(fileType)) return ok({ success: false, error: "bad_upload_params", requestId }, 400);

      const p = pathFor(agenceId, fileType as any, file.name);
      const buf = await file.arrayBuffer();
      const { error: upErr } = await supabase.storage.from(BUCKET_NAME).upload(p, buf, { contentType: file.type, upsert: false });
      if (upErr) return ok({ success: false, error: "upload_failed", details: upErr.message, requestId }, 500);

      if (fileType === "logo") {
        const { error } = await supabase.from(T_AGENCE).update({ [COL_LOGO]: p }).eq(PK, agenceId);
        if (error) return ok({ success: false, error: "db_logo_update_failed", details: error.message, requestId }, 500);
      } else {
        const { data: row, error: e1 } = await supabase.from(T_AGENCE).select(`${COL_RESS}`).eq(PK, agenceId).maybeSingle();
        if (e1 || !row) return ok({ success: false, error: "db_read_ressources_failed", details: e1?.message || "not_found", requestId }, 500);
        const current = (row[COL_RESS] ?? []) as string[];
        const updated = [...current, p];
        const { error } = await supabase.from(T_AGENCE).update({ [COL_RESS]: updated }).eq(PK, agenceId);
        if (error) return ok({ success: false, error: "db_ressources_update_failed", details: error.message, requestId }, 500);
      }
      const t1 = performance.now();
      return ok({ success: true, data: { path: p, fileType }, message: "Fichier uploadé", requestId, duration_ms: Math.round(t1 - t0) });
    }

    if (ct.includes("application/json")) {
      const { action, agence_id, fileType, path } = await req.json().catch(() => ({}));
      if (action !== "delete" || !agence_id || !["logo","ressource"].includes(fileType) || typeof path !== "string") {
        return ok({ success: false, error: "bad_delete_params", requestId }, 400);
      }
      const { error: delErr } = await supabase.storage.from(BUCKET_NAME).remove([path]);
      if (delErr) return ok({ success: false, error: "delete_failed", details: delErr.message, requestId }, 500);

      if (fileType === "logo") {
        const { error } = await supabase.from(T_AGENCE).update({ [COL_LOGO]: null }).eq(PK, agence_id);
        if (error) return ok({ success: false, error: "db_logo_clear_failed", details: error.message, requestId }, 500);
      } else {
        const { data: row, error: e1 } = await supabase.from(T_AGENCE).select(`${COL_RESS}`).eq(PK, agence_id).maybeSingle();
        if (e1 || !row) return ok({ success: false, error: "db_read_ressources_failed", details: e1?.message || "not_found", requestId }, 500);
        const current = (row[COL_RESS] ?? []) as string[];
        const updated = current.filter((p: string) => p !== path);
        const { error } = await supabase.from(T_AGENCE).update({ [COL_RESS]: updated }).eq(PK, agence_id);
        if (error) return ok({ success: false, error: "db_ressources_update_failed", details: error.message, requestId }, 500);
      }
      const t1 = performance.now();
      return ok({ success: true, data: { deleted: path, fileType }, message: "Fichier supprimé", requestId, duration_ms: Math.round(t1 - t0) });
    }

    return ok({ success: false, error: "unsupported_content_type", requestId }, 400);
  } catch (e) {
    const t1 = performance.now();
    return ok({ success: false, error: "internal_error", details: String(e), requestId, duration_ms: Math.round(t1 - t0) }, 500);
  }
});
```

---

## N12. `supabase/functions/gestion-agence-independante-admin-update/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}
function rid() { return crypto.randomUUID(); }

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const ORG = "organisation_id";
const COL_NOM = "agence_indep_nom";
const COL_IDENTITE = "agence_indep_identite_commerciale";
const COL_SIRET = "agence_indep_siret";
const COL_ADRESSE = "agence_indep_adresse";
const COL_CP = "agence_indep_code_postal";
const COL_VILLE = "agence_indep_ville";
const COL_EMAIL = "agence_indep_email";
const COL_TEL = "agence_indep_telephone";
const COL_LOGO = "agence_indep_logo";
const COL_RESS = "agence_indep_ressources"; // text[]

const FK_BREVO = "agence_indep_brevo_connexion_id";
const FK_ZOHO = "agence_indep_zoho_connexion_id";
const FK_OPENAI = "agence_indep_openai_connexion_id";
const FK_LINKEDIN = "agence_indep_linkedin_connexion_id";
const FK_FACEBOOK = "agence_indep_facebook_connexion_id";
const FK_INSTAGRAM = "agence_indep_instagram_connexion_id";

const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

const GENERAL_FIELDS = [COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL];

Deno.serve(async (req) => {
  const t0 = performance.now();
  const requestId = rid();
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const body = await req.json().catch(() => ({}));
    const agenceId = body?.agence_id as string | undefined;
    const generalData = body?.generalData as Record<string, unknown> | undefined;
    const integrationKind = body?.integrationKind as string | undefined;
    const integrationData = body?.integrationData as Record<string, unknown> | undefined;
    if (!agenceId) return ok({ success: false, error: "bad_request_missing_agence_id", requestId }, 400);

    let updatedAgence: any = null;
    let updatedIntegration: any = null;
    let message = "";

    // Patch général (strict aux colonnes prévues)
    if (generalData && typeof generalData === "object") {
      const filtered: Record<string, unknown> = {};
      for (const k of GENERAL_FIELDS) if (k in generalData) filtered[k] = (generalData as any)[k];
      if (Object.keys(filtered).length) {
        const { data, error } = await supabase
          .from(T_AGENCE).update(filtered).eq(PK, agenceId).select(PROJECTION_DETAIL).single();
        if (error) return ok({ success: false, error: "db_error_agence_update", details: error.message, requestId }, 500);
        updatedAgence = data;
        message = "Agence mise à jour";
      }
    }

    // Intégration
    if (integrationKind && integrationData && INTEGRATION_TABLES[integrationKind]) {
      const cfg = INTEGRATION_TABLES[integrationKind];
      const { data: agRow, error: e1 } = await supabase.from(T_AGENCE).select(`${ORG}, ${cfg.fk}`).eq(PK, agenceId).single();
      if (e1) return ok({ success: false, error: "db_error_fetch_agence_for_integration", details: e1.message, requestId }, 500);

      const currentId = agRow[cfg.fk];
      if (currentId) {
        const { data, error } = await supabase.from(cfg.table).update(integrationData).eq(cfg.id, currentId).select("*").single();
        if (error) return ok({ success: false, error: "db_error_integration_update", details: error.message, requestId }, 500);
        updatedIntegration = data;
        message += (message ? " + " : "") + `Intégration ${integrationKind} mise à jour`;
      } else {
        const { data, error } = await supabase.from(cfg.table)
          .insert({ ...integrationData, [ORG]: agRow[ORG], [PK]: agenceId })
          .select("*").single();
        if (error) return ok({ success: false, error: "db_error_integration_insert", details: error.message, requestId }, 500);
        const newId = data[cfg.id];
        const { error: linkErr } = await supabase.from(T_AGENCE).update({ [cfg.fk]: newId }).eq(PK, agenceId);
        if (linkErr) {
          await supabase.from(cfg.table).delete().eq(cfg.id, newId);
          return ok({ success: false, error: "db_error_integration_link", details: linkErr.message, requestId }, 500);
        }
        updatedIntegration = data;
        message += (message ? " + " : "") + `Intégration ${integrationKind} créée`;
      }
    }

    const t1 = performance.now();
    return ok({ success: true, data: { agence: updatedAgence, integration: updatedIntegration }, message: message || "OK", requestId, duration_ms: Math.round(t1 - t0) });
  } catch (e) {
    const t1 = performance.now();
    return ok({ success: false, error: "internal_error", details: String(e), requestId, duration_ms: Math.round(t1 - t0) }, 500);
  }
});
```

---

# TITRE 5. FICHIERS (FRONTEND FORMS)

## N13. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/1.FormAgenceIndependanteAccueil.tsx`
```typescript
import React, { useEffect } from "react";
import { useAgenceIndependanteFormData } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData";
import AgenceIndependanteSelector from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector";

export default function FormAgenceIndependanteAccueil() {
  const { agences, loadAgences, selectedAgenceId, setSelectedAgenceId } = useAgenceIndependanteFormData();

  useEffect(() => { loadAgences(); }, []);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-semibold">Agence Indépendante — Accueil</h1>

      <AgenceIndependanteSelector
        agences={agences}
        selectedAgenceId={selectedAgenceId}
        onChange={setSelectedAgenceId}
      />

      <div className="grid gap-3 sm:grid-cols-2">
        <a href="#/creation-agence-independante" className="btn btn-primary">Créer une agence</a>
        <a href="#/gestion-agence-independante" className="btn btn-secondary">Gérer une agence</a>
      </div>
    </div>
  );
}
```

---

## N14. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/2.FormAgenceIndependanteCreation.tsx`
```typescript
import React, { useState } from "react";
import { useAgenceIndependanteCreation } from "@/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/useAgenceIndependanteCreation";
import type { CreateAgenceIndependantePayload } from "@/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/types";
import SuccessAccountInfo from "./SuccessAccountInfo";

export default function FormAgenceIndependanteCreation() {
  const [form, setForm] = useState<CreateAgenceIndependantePayload>({
    agence: {
      agence_indep_nom: "",
      agence_indep_siret: "",
      agence_indep_adresse: "",
      agence_indep_code_postal: "",
      agence_indep_ville: "",
      agence_indep_email: "",
      agence_indep_telephone: "",
      agence_indep_identite_commerciale: "",
    },
    responsable: {
      agence_indep_responsable_nom: "",
      agence_indep_responsable_prenom: "",
      agence_indep_responsable_email: "",
      agence_indep_responsable_telephone: "",
    },
  });
  const { createAgence, loading, error, result } = useAgenceIndependanteCreation();

  const onChange = (section: "agence" | "responsable", key: string, value: string) => {
    setForm((prev) => ({ ...prev, [section]: { ...prev[section], [key]: value } }));
  };

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    await createAgence(form);
  };

  if (result?.user) {
    return <SuccessAccountInfo userEmail={result.user.email} role="agence_independante_responsable" />;
  }

  return (
    <form onSubmit={onSubmit} className="space-y-6">
      <h1 className="text-2xl font-semibold">Créer une Agence Indépendante</h1>

      <fieldset className="space-y-4">
        <legend className="font-medium">Informations Agence</legend>
        <input className="input" placeholder="Nom de l’agence"
          value={form.agence.agence_indep_nom} onChange={(e) => onChange("agence", "agence_indep_nom", e.target.value)} />
        <input className="input" placeholder="SIRET"
          value={form.agence.agence_indep_siret} onChange={(e) => onChange("agence", "agence_indep_siret", e.target.value)} />
        <input className="input" placeholder="Adresse"
          value={form.agence.agence_indep_adresse} onChange={(e) => onChange("agence", "agence_indep_adresse", e.target.value)} />
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Code postal"
            value={form.agence.agence_indep_code_postal} onChange={(e) => onChange("agence", "agence_indep_code_postal", e.target.value)} />
          <input className="input" placeholder="Ville"
            value={form.agence.agence_indep_ville} onChange={(e) => onChange("agence", "agence_indep_ville", e.target.value)} />
        </div>
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Email agence"
            value={form.agence.agence_indep_email} onChange={(e) => onChange("agence", "agence_indep_email", e.target.value)} />
          <input className="input" placeholder="Téléphone agence"
            value={form.agence.agence_indep_telephone} onChange={(e) => onChange("agence", "agence_indep_telephone", e.target.value)} />
        </div>
        <input className="input" placeholder="Identité commerciale (optionnel)"
          value={form.agence.agence_indep_identite_commerciale ?? ""} onChange={(e) => onChange("agence", "agence_indep_identite_commerciale", e.target.value)} />
      </fieldset>

      <fieldset className="space-y-4">
        <legend className="font-medium">Responsable Agence</legend>
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Prénom" value={form.responsable.agence_indep_responsable_prenom} onChange={(e) => onChange("responsable", "agence_indep_responsable_prenom", e.target.value)} />
          <input className="input" placeholder="Nom" value={form.responsable.agence_indep_responsable_nom} onChange={(e) => onChange("responsable", "agence_indep_responsable_nom", e.target.value)} />
        </div>
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Email" value={form.responsable.agence_indep_responsable_email} onChange={(e) => onChange("responsable", "agence_indep_responsable_email", e.target.value)} />
          <input className="input" placeholder="Téléphone" value={form.responsable.agence_indep_responsable_telephone} onChange={(e) => onChange("responsable", "agence_indep_responsable_telephone", e.target.value)} />
        </div>
      </fieldset>

      {error && <p className="text-red-600 text-sm">{error}</p>}
      <button type="submit" className="btn btn-primary" disabled={loading}>
        {loading ? "Création..." : "Créer"}
      </button>
    </form>
  );
}
```

---

## N15. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/3.FormAgenceIndependanteGestion.tsx`
```typescript
import React, { useEffect, useState } from "react";
import { useAgenceIndependanteFormData } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData";
import { useAgenceIndependanteIntegrations } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteIntegrations";
import { useAbonnementStripeView } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAbonnementStripeView";
import AgenceIndependanteSelector from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector";

export default function FormAgenceIndependanteGestion() {
  const {
    agences, loadAgences, selectedAgenceId, setSelectedAgenceId,
    formData, loadAgenceData, saveGeneral, savingGeneral, organisationId, integrations
  } = useAgenceIndependanteFormData();

  const { saveIntegration, loading: savingIntegration } = useAgenceIndependanteIntegrations(selectedAgenceId);
  const [activeTab, setActiveTab] = useState<"general" | "abonnement" | "integrations" | "fichiers">("general");

  useEffect(() => { loadAgences(); }, []);
  useEffect(() => { if (selectedAgenceId) loadAgenceData(selectedAgenceId); }, [selectedAgenceId]);

  const abo = useAbonnementStripeView(organisationId);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-semibold">Agence Indépendante — Gestion</h1>

      <AgenceIndependanteSelector
        agences={agences}
        selectedAgenceId={selectedAgenceId}
        onChange={setSelectedAgenceId}
      />

      <div className="flex gap-3 border-b">
        {["general","abonnement","integrations","fichiers"].map(tab => (
          <button key={tab} className={`px-3 py-2 ${activeTab === tab ? "border-b-2 font-medium" : ""}`} onClick={() => setActiveTab(tab as any)}>
            {tab === "general" ? "Général" : tab[0].toUpperCase() + tab.slice(1)}
          </button>
        ))}
      </div>

      {/* Onglet Général */}
      {activeTab === "general" && formData && (
        <section className="space-y-4">
          <div className="grid gap-3 sm:grid-cols-2">
            <label className="space-y-1">
              <span className="text-sm font-medium">Nom</span>
              <input className="input" value={formData.agence_indep_nom ?? ""}
                onChange={(e) => saveGeneral({ agence_indep_nom: e.target.value })} />
            </label>
            <label className="space-y-1">
              <span className="text-sm font-medium">Identité commerciale</span>
              <input className="input" value={formData.agence_indep_identite_commerciale ?? ""}
                onChange={(e) => saveGeneral({ agence_indep_identite_commerciale: e.target.value })} />
            </label>
          </div>
          <div className="grid gap-3 sm:grid-cols-3">
            <input className="input" placeholder="SIRET" value={formData.agence_indep_siret ?? ""}
              onChange={(e) => saveGeneral({ agence_indep_siret: e.target.value })} />
            <input className="input" placeholder="Code postal" value={formData.agence_indep_code_postal ?? ""}
              onChange={(e) => saveGeneral({ agence_indep_code_postal: e.target.value })} />
            <input className="input" placeholder="Ville" value={formData.agence_indep_ville ?? ""}
              onChange={(e) => saveGeneral({ agence_indep_ville: e.target.value })} />
          </div>
          <input className="input" placeholder="Adresse" value={formData.agence_indep_adresse ?? ""}
            onChange={(e) => saveGeneral({ agence_indep_adresse: e.target.value })} />
          <div className="grid gap-3 sm:grid-cols-2">
            <input className="input" placeholder="Email agence" value={formData.agence_indep_email ?? ""}
              onChange={(e) => saveGeneral({ agence_indep_email: e.target.value })} />
            <input className="input" placeholder="Téléphone agence" value={formData.agence_indep_telephone ?? ""}
              onChange={(e) => saveGeneral({ agence_indep_telephone: e.target.value })} />
          </div>
          {savingGeneral && <p className="text-sm text-muted-foreground">Enregistrement…</p>}
        </section>
      )}

      {/* Onglet Abonnement (lecture seule) */}
      {activeTab === "abonnement" && (
        <section className="space-y-4">
          <div className="grid gap-3 sm:grid-cols-2">
            <label className="space-y-1">
              <span className="text-sm font-medium">Plan d’abonnement</span>
              <input className="input" readOnly value={abo.data?.abonnement_stripe_plan ?? "Aucun"} />
            </label>
            <label className="space-y-1">
              <span className="text-sm font-medium">Date de début</span>
              <input className="input" readOnly value={abo.data?.abonnement_stripe_debut ?? ""} />
            </label>
          </div>
          <p className="text-xs text-muted-foreground">Module Stripe à venir (création / upgrade / résiliation).</p>
        </section>
      )}

      {/* Onglet Intégrations */}
      {activeTab === "integrations" && selectedAgenceId && (
        <section className="space-y-6">
          {(["brevo","zoho","openai","linkedin","facebook","instagram"] as const).map(kind => {
            const current = (integrations ?? {})[kind] || {};
            return (
              <div key={kind} className="border rounded p-3 space-y-2">
                <h3 className="font-medium">Intégration {kind.toUpperCase()}</h3>
                <div className="grid gap-2 sm:grid-cols-2">
                  <input className="input" placeholder={`${kind}_api_key`} defaultValue={current[`${kind}_api_key`] ?? ""} id={`${kind}_api_key`} />
                  <input className="input" placeholder={`${kind}_email_compte`} defaultValue={current[`${kind}_email_compte`] ?? ""} id={`${kind}_email_compte`} />
                </div>
                <button className="btn btn-primary" onClick={() => {
                  const data = {
                    [`${kind}_api_key`]: (document.getElementById(`${kind}_api_key`) as HTMLInputElement)?.value || "",
                    [`${kind}_email_compte`]: (document.getElementById(`${kind}_email_compte`) as HTMLInputElement)?.value || "",
                  };
                  saveIntegration(kind, data);
                }} disabled={savingIntegration}>
                  {savingIntegration ? "Enregistrement…" : "Enregistrer"}
                </button>
              </div>
            );
          })}
        </section>
      )}

      {/* Onglet Fichiers */}
      {activeTab === "fichiers" && selectedAgenceId && <FichiersPanel agenceId={selectedAgenceId} />}
    </div>
  );
}

function FichiersPanel({ agenceId }: { agenceId: string }) {
  const [logoFile, setLogoFile] = React.useState<File | null>(null);
  const [docFile, setDocFile] = React.useState<File | null>(null);
  const [msg, setMsg] = React.useState<string | null>(null);

  const upload = async (fileType: "logo" | "ressource", file: File | null) => {
    if (!file) return;
    setMsg(null);
    const fd = new FormData();
    fd.append("fileType", fileType);
    fd.append("agence_id", agenceId);
    fd.append("file", file);

    const res = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/gestion-agence-independante-admin-fichiers`, {
      method: "POST",
      body: fd,
      headers: { apikey: import.meta.env.VITE_SUPABASE_ANON_KEY },
    });
    const json = await res.json();
    if (json?.success) setMsg("Fichier chargé.");
    else setMsg(json?.error || "Erreur upload");
  };

  return (
    <section className="space-y-4">
      <div className="space-y-2">
        <label className="text-sm font-medium">Logo (1-logos)</label>
        <input type="file" onChange={(e) => setLogoFile(e.target.files?.[0] ?? null)} />
        <button className="btn btn-primary" onClick={() => upload("logo", logoFile)}>Uploader logo</button>
      </div>
      <div className="space-y-2">
        <label className="text-sm font-medium">Document (2-documents-institutionnels)</label>
        <input type="file" onChange={(e) => setDocFile(e.target.files?.[0] ?? null)} />
        <button className="btn btn-secondary" onClick={() => upload("ressource", docFile)}>Uploader document</button>
      </div>
      {msg && <p className="text-sm">{msg}</p>}
    </section>
  );
}
```

---

## N16. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/SuccessAccountInfo.tsx`
```typescript
import React from "react";

export default function SuccessAccountInfo({ userEmail, role }: { userEmail: string; role: string }) {
  return (
    <div className="space-y-4">
      <h2 className="text-xl font-semibold">Compte créé avec succès</h2>
      <p className="text-sm text-muted-foreground">
        Un compte utilisateur a été créé pour <strong>{userEmail}</strong> avec le rôle <strong>{role}</strong>.
      </p>
      <p className="text-sm">
        L’utilisateur recevra un email d’activation / magic link pour finaliser son accès. Aucun mot de passe n’a été manipulé par l’admin.
      </p>
    </div>
  );
}
```

---

# TITRE 6. SQL

## N17. `00_all_in_one_agence_independante.sql`
```sql
-- =========================================================
-- AGENCE INDEPENDANTE – STORAGE + POLICIES + TRIGGER + INDEX
-- Idempotent
-- =========================================================

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM storage.buckets WHERE id = 'bucket-table-agence-independante') THEN
    PERFORM storage.create_bucket('bucket-table-agence-independante', false);
  END IF;
END $$;

ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS ai_storage_select_authenticated ON storage.objects;
CREATE POLICY ai_storage_select_authenticated
ON storage.objects
FOR SELECT
TO authenticated
USING (bucket_id = 'bucket-table-agence-independante');

-- Propagation agence → responsable (email/téléphone)
CREATE OR REPLACE FUNCTION public.sync_agence_indep_to_responsable()
RETURNS trigger AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    IF NEW.agence_indep_email IS DISTINCT FROM OLD.agence_indep_email THEN
      UPDATE public.agence_independante_responsable
      SET agence_indep_responsable_email = NEW.agence_indep_email
      WHERE agence_indep_id = NEW.agence_indep_id;
    END IF;
    IF NEW.agence_indep_telephone IS DISTINCT FROM OLD.agence_indep_telephone THEN
      UPDATE public.agence_independante_responsable
      SET agence_indep_responsable_telephone = NEW.agence_indep_telephone
      WHERE agence_indep_id = NEW.agence_indep_id;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_sync_agence_indep_to_resp ON public.agence_independante;
CREATE TRIGGER trg_sync_agence_indep_to_resp
AFTER UPDATE OF agence_indep_email, agence_indep_telephone ON public.agence_independante
FOR EACH ROW EXECUTE FUNCTION public.sync_agence_indep_to_responsable();

CREATE INDEX IF NOT EXISTS idx_agence_indep_org ON public.agence_independante(organisation_id);
CREATE INDEX IF NOT EXISTS idx_abonnement_stripe_org ON public.abonnement_stripe(organisation_id);
```

---

## N18. `01_storage-bucket-agence-independante.sql`
```sql
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM storage.buckets WHERE id = 'bucket-table-agence-independante') THEN
    PERFORM storage.create_bucket('bucket-table-agence-independante', false);
  END IF;
END $$;

ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS ai_storage_select_authenticated ON storage.objects;
CREATE POLICY ai_storage_select_authenticated
ON storage.objects
FOR SELECT
TO authenticated
USING (bucket_id = 'bucket-table-agence-independante');

-- Écriture/Suppression via SERVICE ROLE KEY (Edge Functions).
```

---

## N19. `02_trigger-sync-agence-responsable.sql`
```sql
CREATE OR REPLACE FUNCTION public.sync_agence_indep_to_responsable()
RETURNS trigger AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    IF NEW.agence_indep_email IS DISTINCT FROM OLD.agence_indep_email THEN
      UPDATE public.agence_independante_responsable
      SET agence_indep_responsable_email = NEW.agence_indep_email
      WHERE agence_indep_id = NEW.agence_indep_id;
    END IF;
    IF NEW.agence_indep_telephone IS DISTINCT FROM OLD.agence_indep_telephone THEN
      UPDATE public.agence_independante_responsable
      SET agence_indep_responsable_telephone = NEW.agence_indep_telephone
      WHERE agence_indep_id = NEW.agence_indep_id;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_sync_agence_indep_to_resp ON public.agence_independante;

CREATE TRIGGER trg_sync_agence_indep_to_resp
AFTER UPDATE OF agence_indep_email, agence_indep_telephone ON public.agence_independante
FOR EACH ROW EXECUTE FUNCTION public.sync_agence_indep_to_responsable();
```

---

## N20. `03_indexes-agence-independante.sql`
```sql
CREATE INDEX IF NOT EXISTS idx_agence_indep_org ON public.agence_independante(organisation_id);
CREATE INDEX IF NOT EXISTS idx_abonnement_stripe_org ON public.abonnement_stripe(organisation_id);
```

---

# TITRE 7. CONFIG TOML

## N21. `supabase/config.toml`
```toml
project_id = "ksymahfrtvhnbeobsspt"

[functions.notifier-nouvelle-demande]
verify_jwt = false

[functions.create-reseau-admin]
verify_jwt = false

[functions.gestion-reseau-admin]
verify_jwt = false

[functions.gestion-reseau-admin-donnees]
verify_jwt = false

[functions.gestion-reseau-admin-update]
verify_jwt = false

[functions.gestion-reseau-admin-fichiers]
verify_jwt = false

[functions.create-agence-independante-admin]
verify_jwt = false

[functions.gestion-agence-independante-admin]
verify_jwt = false

[functions.gestion-agence-independante-admin-donnees]
verify_jwt = false

[functions.gestion-agence-independante-admin-update]
verify_jwt = false

[functions.gestion-agence-independante-admin-fichiers]
verify_jwt = false
```

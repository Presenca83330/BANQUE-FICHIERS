# CODES ET EMPLACEMENTS | FICHIERS UTILISÉS PAR FORMULAIRE **AGENCE INDEPENDANTE**  
_Mise à jour : 2025-10-14_  
- Conforme au **mapping officiel** (.TablesReferenceAgenceIndependante.ts)
- Aux **tables de référence**
- Respecte la **charte graphique** et la **structure RÉSEAU** (Accueil / Création / Gestion + onglets).
- Contrats de retour **uniformisés**: `{ success, data, message, requestId, duration_ms }`.
- Service Role activé côté **Edge Functions** (verify_jwt=false).

---

# TITRE 1. HOOKS FORM CREATEUR

## N1. `src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/types.ts`
```typescript
// Mapping strict : champs agence_indep_* et agence_indep_responsable_*
// Références : .TablesReferenceAgenceIndependante.ts / Agence_Independante_UseTables.zip

export type CreateAgenceIndependantePayload = {
  agence: {
    agence_indep_nom: string;
    agence_indep_siret: string;
    agence_indep_adresse: string;
    agence_indep_code_postal: string;
    agence_indep_ville: string;
    agence_indep_email: string;
    agence_indep_telephone: string;
    agence_indep_identite_commerciale?: string | null;
  };
  responsable: {
    agence_indep_responsable_prenom: string;
    agence_indep_responsable_nom: string;
    agence_indep_responsable_email: string;
    agence_indep_responsable_telephone: string;
  };
};

export type CreateAgenceResponse = {
  success: boolean;
  data?: {
    organisation: { organisation_id: string; organisation_nom: string };
    agence: { agence_indep_id: string; agence_indep_nom: string };
    user: { id: string; email: string };
  };
  message?: string;
  error?: string;
  details?: string;
  requestId?: string;
  duration_ms?: number;
};
```

---

## N2. `src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/useAgenceIndependanteCreation.ts`
```typescript
import { useCallback, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { CreateAgenceIndependantePayload, CreateAgenceResponse } from "./types";

export function useAgenceIndependanteCreation() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [result, setResult] = useState<CreateAgenceResponse | null>(null);

  const createAgence = useCallback(async (payload: CreateAgenceIndependantePayload) => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<CreateAgenceResponse>(
        "create-agence-independante-admin",
        { body: payload }
      );
      if (error) throw error;
      setResult(data ?? null);
      return data ?? null;
    } catch (e: any) {
      setError(e?.message ?? "Erreur inconnue");
      return null;
    } finally {
      setLoading(false);
    }
  }, []);

  return { createAgence, loading, error, result };
}
```

---

# TITRE 2. HOOKS FORM GESTION

## N3. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector.tsx`
```typescript
import React from "react";
import type { AgenceIndependanteMinimal } from "../hooks/types";

type Props = {
  agences: AgenceIndependanteMinimal[];
  selectedAgenceId: string | null;
  onChange: (id: string | null) => void;
  disabled?: boolean;
};

/** Sélecteur minimal ; peut être remplacé par le composant DS sans changer l'API. */
const AgenceIndependanteSelector: React.FC<Props> = ({ agences, selectedAgenceId, onChange, disabled }) => {
  return (
    <select
      value={selectedAgenceId ?? ""}
      onChange={(e) => onChange(e.target.value || null)}
      disabled={disabled}
      style={{ width: "100%", padding: 8 }}
    >
      <option value="">{agences.length ? "Sélectionner une agence" : "Aucune agence disponible"}</option>
      {agences.map((a) => (
        <option key={a.agence_id} value={a.agence_id}>
          {a.agence_nom}
        </option>
      ))}
    </select>
  );
};

export default AgenceIndependanteSelector;
```

---

## N4. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/types.ts`
```typescript
// Types stricts, calés sur .TablesReferenceAgenceIndependante.ts

export type AgenceIndependanteMinimal = {
  agence_id: string;     // = agence_indep_id
  agence_nom: string;    // = agence_indep_nom
};

export type AgenceIndependante = {
  agence_indep_id: string;
  organisation_id: string;
  client_id?: string;
  client_type?: string;
  agence_indep_nom: string;
  agence_indep_identite_commerciale?: string | null;
  agence_indep_siret?: string | null;
  agence_indep_adresse?: string | null;
  agence_indep_code_postal?: string | null;
  agence_indep_ville?: string | null;
  agence_indep_email?: string | null;
  agence_indep_telephone?: string | null;
  agence_indep_logo?: string | null;
  agence_indep_ressources?: string[] | null;
  // Intégrations (FK optionnelles)
  agence_indep_brevo_connexion_id?: string | null;
  agence_indep_zoho_connexion_id?: string | null;
  agence_indep_openai_connexion_id?: string | null;
  agence_indep_linkedin_connexion_id?: string | null;
  agence_indep_facebook_connexion_id?: string | null;
  agence_indep_instagram_connexion_id?: string | null;
  // Timestamps génériques
  agence_indep_created_at?: string;
  agence_indep_updated_at?: string;
  [k: string]: any;
};

export type IntegrationsMap = {
  brevo: any | null;
  zoho: any | null;
  openai: any | null;
  linkedin: any | null;
  facebook: any | null;
  instagram: any | null;
};

export type ListAgencesResponse = {
  success: boolean;
  data?: AgenceIndependanteMinimal[];
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type AgenceDetailResponse = {
  success: boolean;
  data?: { agence: AgenceIndependante; integrations: IntegrationsMap };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type UpdateAgenceResponse = {
  success: boolean;
  data?: { agence?: AgenceIndependante; integration?: any };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type FileUploadResponse = {
  success: boolean;
  data?: { path: string; fileType: "logo" | "ressource" };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type FileDeleteResponse = {
  success: boolean;
  data?: { deleted: string; fileType: "logo" | "ressource" };
  message?: string;
  error?: string;
  requestId?: string;
  duration_ms?: number;
};

export type AbonnementStripeView = {
  abonnement_stripe_plan: string | null;
  abonnement_stripe_debut: string | null;
};
```

---

## N5. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAbonnementStripeView.ts`
```typescript
import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { AbonnementStripeView } from "./types";

/** Lecture *read-only* du plan + date de début Stripe. */
export function useAbonnementStripeView(organisationId: string | null) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<AbonnementStripeView | null>(null);

  const load = useCallback(async () => {
    if (!organisationId) {
      setData({ abonnement_stripe_plan: null, abonnement_stripe_debut: null });
      return;
    }
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase
        .from("abonnement_stripe")
        .select("abonnement_stripe_plan, abonnement_stripe_debut")
        .eq("organisation_id", organisationId)
        .order("abonnement_stripe_debut", { ascending: false })
        .limit(1);
      if (error) throw error;
      const row = (data?.[0] ?? null) as any;
      setData(row
        ? { abonnement_stripe_plan: row.abonnement_stripe_plan, abonnement_stripe_debut: row.abonnement_stripe_debut }
        : { abonnement_stripe_plan: null, abonnement_stripe_debut: null });
    } catch (e: any) {
      setError(e?.message ?? "Erreur lecture abonnement");
    } finally {
      setLoading(false);
    }
  }, [organisationId]);

  useEffect(() => { load(); }, [load]);

  return { loading, error, data, reload: load };
}
```

---

## N6. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData.ts`
```typescript
import { useCallback, useEffect, useMemo, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type {
  AgenceIndependante,
  AgenceIndependanteMinimal,
  AgenceDetailResponse,
  ListAgencesResponse,
  UpdateAgenceResponse,
} from "./types";

export function useAgenceIndependanteFormData() {
  const [loading, setLoading] = useState(false);
  const [agences, setAgences] = useState<AgenceIndependanteMinimal[]>([]);
  const [selectedAgenceId, setSelectedAgenceId] = useState<string | null>(null);
  const [formData, setFormData] = useState<AgenceIndependante | null>(null);
  const [integrations, setIntegrations] = useState<Record<string, any> | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [savingGeneral, setSavingGeneral] = useState(false);

  const loadAgences = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<ListAgencesResponse>(
        "gestion-agence-independante-admin",
        { body: {} }
      );
      if (error) throw error;
      setAgences(data?.data ?? []);
    } catch (e: any) {
      setError(e?.message ?? "Erreur chargement agences");
    } finally {
      setLoading(false);
    }
  }, []);

  const loadAgenceData = useCallback(async (agenceId: string) => {
    if (!agenceId) return;
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<AgenceDetailResponse>(
        "gestion-agence-independante-admin-donnees",
        { body: { agence_id: agenceId } }
      );
      if (error) throw error;
      const row = data?.data?.agence ?? null;
      const integ = data?.data?.integrations ?? null;
      setFormData(row);
      setIntegrations(integ);
    } catch (e: any) {
      setError(e?.message ?? "Erreur chargement agence");
    } finally {
      setLoading(false);
    }
  }, []);

  const saveGeneral = useCallback(async (patch: Partial<AgenceIndependante>) => {
    if (!selectedAgenceId) return null;
    setSavingGeneral(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<UpdateAgenceResponse>(
        "gestion-agence-independante-admin-update",
        { body: { agence_id: selectedAgenceId, generalData: patch } }
      );
      if (error) throw error;
      const updated = data?.data?.agence ?? null;
      if (updated) setFormData(updated);
      return updated;
    } catch (e: any) {
      setError(e?.message ?? "Erreur sauvegarde");
      return null;
    } finally {
      setSavingGeneral(false);
    }
  }, [selectedAgenceId]);

  useEffect(() => { loadAgences(); }, [loadAgences]);
  useEffect(() => { if (selectedAgenceId) loadAgenceData(selectedAgenceId); }, [selectedAgenceId, loadAgenceData]);

  const organisationId = useMemo(() => formData?.organisation_id ?? null, [formData]);

  return {
    loading, error,
    agences, selectedAgenceId, setSelectedAgenceId,
    formData, integrations, organisationId,
    loadAgences,
    loadAgenceData,
    saveGeneral, savingGeneral,
  };
}
```

---

## N7. `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteIntegrations.ts`
```typescript
import { useCallback, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { UpdateAgenceResponse } from "./types";

type Kind = "brevo" | "zoho" | "openai" | "linkedin" | "facebook" | "instagram";

export function useAgenceIndependanteIntegrations(agenceId: string | null) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const saveIntegration = useCallback(async (kind: Kind, integrationData: Record<string, any>) => {
    if (!agenceId) return null;
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<UpdateAgenceResponse>(
        "gestion-agence-independante-admin-update",
        { body: { agence_id: agenceId, integrationKind: kind, integrationData } }
      );
      if (error) throw error;
      return data?.data?.integration ?? null;
    } catch (e: any) {
      setError(e?.message ?? "Erreur sauvegarde intégration");
      return null;
    } finally {
      setLoading(false);
    }
  }, [agenceId]);

  return { saveIntegration, loading, error };
}
```

---

# TITRE 3. FUNCTIONS FORM CREATEUR

## N8. `supabase/functions/create-agence-independante-admin/index.ts`
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const T_ORG = "organisations";
const T_USER = "users";
const T_UTILISATEUR = "utilisateurs";
const T_AGENCE = "agence_independante";
const T_RESP = "agence_independante_responsable";

const PK = "agence_indep_id";
const PK_ORG = "organisation_id";
const PK_USER = "users_id";
const PK_UTIL = "utilisateur_id";
const RESP_ID = "agence_indep_responsable_id";

const RESP_AGENCE_FK = "agence_indep_id";

const COL_NOM = "agence_indep_nom";
const COL_SIRET = "agence_indep_siret";
const COL_ADDR = "agence_indep_adresse";
const COL_CP = "agence_indep_code_postal";
const COL_VILLE = "agence_indep_ville";
const COL_ID_COM = "agence_indep_identite_commerciale";
const COL_EMAIL = "agence_indep_email";
const COL_TEL = "agence_indep_telephone";

interface ReqBody {
  agence_indep_nom: string;
  agence_indep_siret: string;
  agence_indep_adresse: string;
  agence_indep_code_postal: string;
  agence_indep_ville: string;
  agence_indep_identite_commerciale?: string;
  agence_indep_email: string;
  agence_indep_telephone: string;
  responsable_nom: string;
  responsable_prenom: string;
  responsable_email: string;
  responsable_telephone: string;
  responsable_fonction?: string;
}

serve(async (req: Request) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  const authHeader = req.headers.get("Authorization");
  if (!authHeader) {
    return new Response(JSON.stringify({ success: false, error: "missing_auth" }), {
      status: 401,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }

  const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
  const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
  const supabase = createClient(supabaseUrl, supabaseKey, {
    auth: { persistSession: false },
    global: { headers: { Authorization: authHeader } },
  });

  const {
    data: { user },
    error: userError,
  } = await supabase.auth.getUser();

  if (userError || !user) {
    return new Response(JSON.stringify({ success: false, error: "unauthorized" }), {
      status: 401,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }

  try {
    const body: ReqBody = await req.json();

    const {
      agence_indep_nom,
      agence_indep_siret,
      agence_indep_adresse,
      agence_indep_code_postal,
      agence_indep_ville,
      agence_indep_identite_commerciale,
      agence_indep_email,
      agence_indep_telephone,
      responsable_nom,
      responsable_prenom,
      responsable_email,
      responsable_telephone,
      responsable_fonction,
    } = body;

    if (
      !agence_indep_nom ||
      !agence_indep_siret ||
      !agence_indep_adresse ||
      !agence_indep_code_postal ||
      !agence_indep_ville ||
      !agence_indep_email ||
      !agence_indep_telephone ||
      !responsable_nom ||
      !responsable_prenom ||
      !responsable_email ||
      !responsable_telephone
    ) {
      return new Response(
        JSON.stringify({ success: false, error: "missing_fields" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log("[CREATE-AGENCE-INDEP] Création organisation...");
    const { data: org, error: eOrg } = await supabase
      .from(T_ORG)
      .insert({
        organisation_nom: agence_indep_nom,
        organisation_siret: agence_indep_siret,
        organisation_adresse: agence_indep_adresse,
        organisation_code_postal: agence_indep_code_postal,
        organisation_ville: agence_indep_ville,
        organisation_identite_commerciale: agence_indep_identite_commerciale || null,
        organisation_email: agence_indep_email,
        organisation_telephone: agence_indep_telephone,
        organisation_statut_compte: "actif",
        organisation_type_structure: "agence_independante",
      })
      .select()
      .single();

    if (eOrg || !org) {
      console.error("[CREATE-AGENCE-INDEP] Erreur org:", eOrg);
      return new Response(
        JSON.stringify({ success: false, error: "org_insert_failed", details: eOrg?.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const orgId = org[PK_ORG];
    console.log("[CREATE-AGENCE-INDEP] Organisation créée:", orgId);

    console.log("[CREATE-AGENCE-INDEP] Création users...");
    const { data: usr, error: eUsr } = await supabase
      .from(T_USER)
      .insert({
        users_nom: responsable_nom,
        users_prenom: responsable_prenom,
        users_email: responsable_email,
        users_telephone: responsable_telephone,
     
        users_role_systeme: "agence_independante_responsable",
        users_organisation_id: orgId,
      })
      .select()
      .single();

    if (eUsr || !usr) {
      console.error("[CREATE-AGENCE-INDEP] Erreur users:", eUsr);
      return new Response(
        JSON.stringify({ success: false, error: "users_insert_failed", details: eUsr?.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const userId = usr[PK_USER];
    console.log("[CREATE-AGENCE-INDEP] User créé:", userId);

    console.log("[CREATE-AGENCE-INDEP] Création utilisateurs...");
    const { data: util, error: eUtil } = await supabase
      .from(T_UTILISATEUR)
      .insert({
        utilisateur_email: responsable_email,
        utilisateur_type_compte: "agence_independante",
   
        utilisateur_statut: "actif",
        utilisateur_organisation_id: orgId,
        utilisateur_role_systeme: "agence_independante_responsable",
      })
      .select()
      .single();

    if (eUtil || !util) {
      console.error("[CREATE-AGENCE-INDEP] Erreur utilisateurs:", eUtil);
      return new Response(
        JSON.stringify({ success: false, error: "utilisateurs_insert_failed", details: eUtil?.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const utilId = util[PK_UTIL];
    console.log("[CREATE-AGENCE-INDEP] Utilisateur créé:", utilId);

    console.log("[CREATE-AGENCE-INDEP] Création agence_independante...");
    const { data: ag, error: eAg } = await supabase
      .from(T_AGENCE)
      .insert({
        organisation_id: orgId,
        [COL_NOM]: agence_indep_nom,
        [COL_SIRET]: agence_indep_siret,
        [COL_ADDR]: agence_indep_adresse,
        [COL_CP]: agence_indep_code_postal,
        [COL_VILLE]: agence_indep_ville,
        [COL_ID_COM]: agence_indep_identite_commerciale || null,
        [COL_EMAIL]: agence_indep_email,
        [COL_TEL]: agence_indep_telephone,
        agence_indep_statut: "actif",
        client_type: "agence_independante",
      })
      .select()
      .single();

    if (eAg || !ag) {
      console.error("[CREATE-AGENCE-INDEP] Erreur agence_independante:", eAg);
      return new Response(
        JSON.stringify({ success: false, error: "agence_insert_failed", details: eAg?.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const agId = ag[PK];
    console.log("[CREATE-AGENCE-INDEP] Agence créée:", agId);

    console.log("[CREATE-AGENCE-INDEP] Création agence_independante_responsable...");
    const { data: resp, error: eResp } = await supabase
      .from(T_RESP)
      .insert({
        organisation_id: orgId,
 
        [RESP_AGENCE_FK]: ag[PK],
        agence_indep_responsable_nom: responsable_nom,
        agence_indep_responsable_prenom: responsable_prenom,
        agence_indep_responsable_email: responsable_email,
        agence_indep_responsable_telephone: responsable_telephone,
        agence_indep_responsable_fonction: responsable_fonction || null,
        agence_indep_responsable_utilisateur_id: userId,
        agence_indep_responsable_statut: "actif",
        client_type: "agence_independante",
      })
      .select()
      .single();

    if (eResp || !resp) {
      console.error("[CREATE-AGENCE-INDEP] Erreur responsable:", eResp);
      return new Response(
        JSON.stringify({ success: false, error: "responsable_insert_failed", details: eResp?.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const respId = resp[RESP_ID];
    console.log("[CREATE-AGENCE-INDEP] Responsable créé:", respId);

    console.log("[CREATE-AGENCE-INDEP] ✅ Création complète réussie");
    return new Response(
      JSON.stringify({
        success: true,
        data: {
          organisationId: orgId,
          userId: userId,
          agenceId: agId,
          responsableId: respId,
        },
      }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (err) {
    console.error("[CREATE-AGENCE-INDEP] Exception:", err);
    return new Response(
      JSON.stringify({ success: false, error: "internal_error", details: String(err) }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
```

---

# TITRE 4. FUNCTIONS FORM GESTION

## N9. `supabase/functions/gestion-agence-independante-admin/index.ts`
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const COL_NOM = "agence_indep_nom";

serve(async (req: Request) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  const authHeader = req.headers.get("Authorization");
  if (!authHeader) {
    return new Response(JSON.stringify({ success: false, error: "missing_auth" }), {
      status: 401,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }

  const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
  const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
  const supabase = createClient(supabaseUrl, supabaseKey, {
    auth: { persistSession: false },
    global: { headers: { Authorization: authHeader } },
  });

  const {
    data: { user },
    error: userError,
  } = await supabase.auth.getUser();

  if (userError || !user) {
    return new Response(JSON.stringify({ success: false, error: "unauthorized" }), {
      status: 401,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }

  try {
    console.log("[GESTION-AGENCE-INDEP] Récupération liste agences...");

    const { data, error } = await supabase
      .from(T_AGENCE)
      .select(`${PK}, ${COL_NOM}`)
      .order(COL_NOM, { ascending: true });

    if (error) {
      console.error("[GESTION-AGENCE-INDEP] Erreur select:", error);
      return new Response(
        JSON.stringify({ success: false, error: "select_failed", details: error.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const mapped = (data ?? []).map((r: any) => ({
      agence_id: r.agence_indep_id,   // Mapping explicite
      agence_nom: r.agence_indep_nom  // Mapping explicite
    }));

    console.log(`[GESTION-AGENCE-INDEP] ✅ ${mapped.length} agence(s) trouvée(s)`);

    return new Response(
      JSON.stringify({ success: true, data: mapped }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (err) {
    console.error("[GESTION-AGENCE-INDEP] Exception:", err);
    return new Response(
      JSON.stringify({ success: false, error: "internal_error", details: String(err) }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
```

---

## N10. `supabase/functions/gestion-agence-independante-admin-donnees/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}
function rid() { return crypto.randomUUID(); }

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const ORG = "organisation_id";
const COL_NOM = "agence_indep_nom";
const COL_IDENTITE = "agence_indep_identite_commerciale";
const COL_SIRET = "agence_indep_siret";
const COL_ADRESSE = "agence_indep_adresse";
const COL_CP = "agence_indep_code_postal";
const COL_VILLE = "agence_indep_ville";
const COL_EMAIL = "agence_indep_email";
const COL_TEL = "agence_indep_telephone";
const COL_LOGO = "agence_indep_logo";
const COL_RESS = "agence_indep_ressources"; // text[]

const FK_BREVO = "agence_indep_brevo_connexion_id";
const FK_ZOHO = "agence_indep_zoho_connexion_id";
const FK_OPENAI = "agence_indep_openai_connexion_id";
const FK_LINKEDIN = "agence_indep_linkedin_connexion_id";
const FK_FACEBOOK = "agence_indep_facebook_connexion_id";
const FK_INSTAGRAM = "agence_indep_instagram_connexion_id";

const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

Deno.serve(async (req) => {
  const t0 = performance.now();
  const requestId = rid();
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const body = await req.json().catch(() => ({}));
    const agenceId = body?.agence_id as string | undefined;
    if (!agenceId) return ok({ success: false, error: "bad_request_missing_agence_id", requestId }, 400);

    const { data: agence, error } = await supabase
      .from(T_AGENCE)
      .select(PROJECTION_DETAIL)
      .eq(PK, agenceId)
      .maybeSingle();
    if (error) return ok({ success: false, error: "db_error_agence_fetch", details: error.message, requestId }, 500);
    if (!agence) return ok({ success: false, error: "not_found_agence", requestId }, 404);

    const integrations: Record<string, any> = { brevo: null, zoho: null, openai: null, linkedin: null, facebook: null, instagram: null };
    const tasks: Promise<void>[] = [];

    for (const kind of Object.keys(INTEGRATION_TABLES)) {
      const cfg = INTEGRATION_TABLES[kind];
      const fkVal = (agence as any)[cfg.fk];
      if (!fkVal) continue;
      tasks.push(
        supabase.from(cfg.table).select("*").eq(cfg.id, fkVal).maybeSingle().then(({ data, error }) => {
          if (!error) integrations[kind] = data ?? null;
        })
      );
    }
    if (tasks.length) await Promise.all(tasks);

    const t1 = performance.now();
    return ok({ success: true, data: { agence, integrations }, message: "OK", requestId, duration_ms: Math.round(t1 - t0) });
  } catch (e) {
    const t1 = performance.now();
    return ok({ success: false, error: "internal_error", details: String(e), requestId, duration_ms: Math.round(t1 - t0) }, 500);
  }
});
```

---

## N11. `supabase/functions/gestion-agence-independante-admin-fichiers/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}
function rid() { return crypto.randomUUID(); }

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";
const COL_LOGO = "agence_indep_logo";
const COL_RESS = "agence_indep_ressources"; // text[]

const BUCKET_NAME = "bucket-table-agence-independante";

function sanitizeFilename(name: string) { return name.replace(/[^a-zA-Z0-9._-]/g, "_"); }
function pathFor(agenceId: string, kind: "logo"|"ressource", fn: string) {
  const folder = kind === "logo" ? "1-logos" : "2-documents-institutionnels";
  return `agence-${agenceId}/${folder}/${Date.now()}_${sanitizeFilename(fn)}`;
}

Deno.serve(async (req) => {
  const t0 = performance.now();
  const requestId = rid();
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const ct = req.headers.get("content-type") || "";
    if (ct.includes("multipart/form-data")) {
      const fd = await req.formData();
      const agenceId = String(fd.get("agence_id") || "");
      const fileType = String(fd.get("fileType") || "");
      const file = fd.get("file") as File | null;
      if (!agenceId || !file || !["logo","ressource"].includes(fileType)) return ok({ success: false, error: "bad_upload_params", requestId }, 400);

      const p = pathFor(agenceId, fileType as any, file.name);
      const buf = await file.arrayBuffer();
      const { error: upErr } = await supabase.storage.from(BUCKET_NAME).upload(p, buf, { contentType: file.type, upsert: false });
      if (upErr) return ok({ success: false, error: "upload_failed", details: upErr.message, requestId }, 500);

      if (fileType === "logo") {
        const { error } = await supabase.from(T_AGENCE).update({ [COL_LOGO]: p }).eq(PK, agenceId);
        if (error) return ok({ success: false, error: "db_logo_update_failed", details: error.message, requestId }, 500);
      } else {
        const { data: row, error: e1 } = await supabase.from(T_AGENCE).select(`${COL_RESS}`).eq(PK, agenceId).maybeSingle();
        if (e1 || !row) return ok({ success: false, error: "db_read_ressources_failed", details: e1?.message || "not_found", requestId }, 500);
        const current = (row[COL_RESS] ?? []) as string[];
        const updated = [...current, p];
        const { error } = await supabase.from(T_AGENCE).update({ [COL_RESS]: updated }).eq(PK, agenceId);
        if (error) return ok({ success: false, error: "db_ressources_update_failed", details: error.message, requestId }, 500);
      }
      const t1 = performance.now();
      return ok({ success: true, data: { path: p, fileType }, message: "Fichier uploadé", requestId, duration_ms: Math.round(t1 - t0) });
    }

    if (ct.includes("application/json")) {
      const { action, agence_id, fileType, path } = await req.json().catch(() => ({}));
      if (action !== "delete" || !agence_id || !["logo","ressource"].includes(fileType) || typeof path !== "string") {
        return ok({ success: false, error: "bad_delete_params", requestId }, 400);
      }
      const { error: delErr } = await supabase.storage.from(BUCKET_NAME).remove([path]);
      if (delErr) return ok({ success: false, error: "delete_failed", details: delErr.message, requestId }, 500);

      if (fileType === "logo") {
        const { error } = await supabase.from(T_AGENCE).update({ [COL_LOGO]: null }).eq(PK, agence_id);
        if (error) return ok({ success: false, error: "db_logo_clear_failed", details: error.message, requestId }, 500);
      } else {
        const { data: row, error: e1 } = await supabase.from(T_AGENCE).select(`${COL_RESS}`).eq(PK, agence_id).maybeSingle();
        if (e1 || !row) return ok({ success: false, error: "db_read_ressources_failed", details: e1?.message || "not_found", requestId }, 500);
        const current = (row[COL_RESS] ?? []) as string[];
        const updated = current.filter((p: string) => p !== path);
        const { error } = await supabase.from(T_AGENCE).update({ [COL_RESS]: updated }).eq(PK, agence_id);
        if (error) return ok({ success: false, error: "db_ressources_update_failed", details: error.message, requestId }, 500);
      }
      const t1 = performance.now();
      return ok({ success: true, data: { deleted: path, fileType }, message: "Fichier supprimé", requestId, duration_ms: Math.round(t1 - t0) });
    }

    return ok({ success: false, error: "unsupported_content_type", requestId }, 400);
  } catch (e) {
    const t1 = performance.now();
    return ok({ success: false, error: "internal_error", details: String(e), requestId, duration_ms: Math.round(t1 - t0) }, 500);
  }
});
```

---

## N12. `supabase/functions/gestion-agence-independante-admin-update/index.ts`
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";
import { v4 as uuidv4 } from "https://esm.sh/uuid@9.0.0";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const T_AGENCE = "agence_independante";
const PK = "agence_indep_id";

serve(async (req: Request) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  const authHeader = req.headers.get("Authorization");
  if (!authHeader) {
    return new Response(JSON.stringify({ success: false, error: "missing_auth" }), {
      status: 401,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }

  const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
  const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
  const supabase = createClient(supabaseUrl, supabaseKey, {
    auth: { persistSession: false },
    global: { headers: { Authorization: authHeader } },
  });

  const {
    data: { user },
    error: userError,
  } = await supabase.auth.getUser();

  if (userError || !user) {
    return new Response(JSON.stringify({ success: false, error: "unauthorized" }), {
      status: 401,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }

  const ok = (body: any, status = 200) =>
    new Response(JSON.stringify(body), {
      status,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  try {
    const { agenceId, agenceData, integrations } = await req.json();
    const requestId = uuidv4();

    console.log(`[UPDATE-AGENCE] [${requestId}] Début update agence:`, agenceId);

    if (!agenceId) {
      return ok({ success: false, error: "missing_agence_id", requestId }, 400);
    }

    const { data: existingAgence, error: eCheck } = await supabase
      .from(T_AGENCE)
      .select("organisation_id")
      .eq(PK, agenceId)
      .single();

    if (eCheck || !existingAgence) {
      console.error(`[UPDATE-AGENCE] [${requestId}] Agence introuvable:`, eCheck);
      return ok({ success: false, error: "agence_not_found", details: eCheck?.message, requestId }, 404);
    }

    const orgId = existingAgence.organisation_id;
    console.log(`[UPDATE-AGENCE] [${requestId}] Organisation ID:`, orgId);

    if (agenceData && Object.keys(agenceData).length > 0) {
      console.log(`[UPDATE-AGENCE] [${requestId}] Update agence_independante...`);
      const { error: eAgence } = await supabase
        .from(T_AGENCE)
        .update(agenceData)
        .eq(PK, agenceId);

      if (eAgence) {
        console.error(`[UPDATE-AGENCE] [${requestId}] Erreur update agence:`, eAgence);
        return ok({ success: false, error: "agence_update_failed", details: eAgence.message, requestId }, 500);
      }
    }

    if (integrations && typeof integrations === "object") {
      const integrationsConfig = [
        { key: "brevo", table: "brevo_connexion", id: "brevo_connexion_id", fk: "agence_indep_brevo_connexion_id" },
        { key: "zoho", table: "zoho_connexion", id: "zoho_connexion_id", fk: "agence_indep_zoho_connexion_id" },
        { key: "openai", table: "openai_connexion", id: "openai_connexion_id", fk: "agence_indep_openai_connexion_id" },
        { key: "linkedin", table: "linkedin_connexion", id: "linkedin_connexion_id", fk: "agence_indep_linkedin_connexion_id" },
        { key: "facebook", table: "facebook_connexion", id: "facebook_connexion_id", fk: "agence_indep_facebook_connexion_id" },
        { key: "instagram", table: "instagram_connexion", id: "instagram_connexion_id", fk: "agence_indep_instagram_connexion_id" },
      ];

      for (const cfg of integrationsConfig) {
        const integrationData = integrations[cfg.key];
        if (!integrationData || Object.keys(integrationData).length === 0) continue;

        const integrationKind = cfg.key;
        console.log(`[UPDATE-AGENCE] [${requestId}] Upsert ${integrationKind}...`);

        const { data: integ, error: eInteg } = await supabase
          .from(cfg.table)
          .upsert({ ...integrationData, organisation_id: orgId, agence_indep_id: agenceId }, { onConflict: cfg.id })
          .select()
          .maybeSingle();


        if (eInteg) {
          console.error(`[UPDATE-AGENCE] [${requestId}] Erreur upsert ${integrationKind}:`, eInteg);
          return ok({ 
            success: false, 
            error: `integration_${integrationKind}_upsert_failed`, 
            details: eInteg.message, 
            requestId 
          }, 500);
        }

        const fkPatch = { [cfg.fk]: integ?.[cfg.id] ?? null };
        const { error: eFK } = await supabase
          .from(T_AGENCE)
          .update(fkPatch)
          .eq(PK, agenceId);

        if (eFK) {
          console.error(`[UPDATE-AGENCE] [${requestId}] Erreur update FK ${integrationKind}:`, eFK);
          return ok({ 
            success: false, 
            error: `agence_fk_update_failed`, 
            details: eFK.message, 
            requestId 
          }, 500);
        }

        console.log(`[UPDATE-AGENCE] [${requestId}] ✅ ${integrationKind} updated, FK set`);
      }
    }

    console.log(`[UPDATE-AGENCE] [${requestId}] ✅ Update complet réussi`);
    return ok({ success: true, requestId });
  } catch (err) {
    console.error("[UPDATE-AGENCE] Exception:", err);
    return ok({ success: false, error: "internal_error", details: String(err) }, 500);
  }
});
```

---

# TITRE 5. FICHIERS (FRONTEND FORMS)

## N13. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/1.FormAgenceIndependanteAccueil.tsx`
```typescript
import React, { useState } from 'react';
import GraphFormAccueil from '../../5-Graphisme/1.GraphFormulaires/4.GraphFormAccueil.jsx';
import FormReseauCreation from './2.FormReseauCreation';
import FormReseauGestion from './3.FormReseauGestion';

interface FormReseauAccueilProps {
  onBack?: () => void;
}

const FormReseauAccueil: React.FC<FormReseauAccueilProps> = ({ onBack }) => {
  const [currentView, setCurrentView] = useState('accueil');
  const handleCreationClick = () => {
    setCurrentView('creation');
  };
  const handleMiseAJourClick = () => {
    setCurrentView('gestion');
  };
  const handleBackToAccueil = () => {
    setCurrentView('accueil');
  };
  if (currentView === 'creation') {
    return <FormReseauCreation onBack={handleBackToAccueil} />;
  }
  if (currentView === 'gestion') {
    return <FormReseauGestion onBack={handleBackToAccueil} />;
  }
  return <GraphFormAccueil onCreationClick={handleCreationClick} onMiseAJourClick={handleMiseAJourClick} />;
};
export default FormReseauAccueil;
```

---

## N14. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/2.FormAgenceIndependanteCreation.tsx`
```typescript
import React, { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { ArrowLeft, Building2 } from "lucide-react";
import { useReseauCreation } from "@/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/1.Reseau/useReseauCreation";
import SuccessAccountInfo from "./SuccessAccountInfo";
import type {
  ReseauCreationData,
  ReseauValidationErrors,
  ReseauCreationResult,
} from "@/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/1.Reseau/types";

interface FormReseauCreationProps {
  onBack: () => void;
}

export default function FormReseauCreation({ onBack }: FormReseauCreationProps) {
  const { createReseau, isLoading, error } = useReseauCreation();

  const [formData, setFormData] = useState<ReseauCreationData>({
    nomReseau: "",
    adresse: "",
    codePostal: "",
    ville: "",
    siret: "",
    nomResponsable: "",
    prenomResponsable: "",
    emailResponsable: "",
    telephoneResponsable: "",
  });

  const [errors, setErrors] = useState<ReseauValidationErrors>({});
  const [creationResult, setCreationResult] = useState<ReseauCreationResult | null>(null);

  const updateFormData = (field: keyof ReseauCreationData, value: string) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
    if (errors[field]) setErrors((prev) => ({ ...prev, [field]: undefined }));
  };

  const validateForm = (): boolean => {
    const newErrors: ReseauValidationErrors = {};

    if (!formData.nomReseau) newErrors.nomReseau = "Nom du réseau requis";
    if (!formData.adresse) newErrors.adresse = "Adresse requise";
    if (!formData.codePostal) newErrors.codePostal = "Code postal requis";
    if (!formData.ville) newErrors.ville = "Ville requise";
    if (!formData.siret) newErrors.siret = "SIRET requis";
    if (!formData.nomResponsable) newErrors.nomResponsable = "Nom requis";
    if (!formData.prenomResponsable) newErrors.prenomResponsable = "Prénom requis";
    if (!formData.emailResponsable) newErrors.emailResponsable = "Email requis";
    if (!formData.telephoneResponsable)
      newErrors.telephoneResponsable = "Téléphone requis";

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    console.log("Soumission formulaire", formData);

    const isValid = validateForm();
    console.log("Résultat validation:", isValid);
    if (!isValid) return;

    const result = await createReseau(formData);
    console.log("Résultat createReseau:", result);
    if (result) {
      setCreationResult(result);
    }
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <Card>
        <CardHeader>
          <div className="flex items-center gap-3">
            <Building2 className="h-6 w-6 text-primary" />
            <CardTitle>Création d’un nouveau réseau</CardTitle>
          </div>
        </CardHeader>

        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-6">
            {/* Informations Réseau */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="nomReseau">Nom du réseau *</Label>
                <Input
                  id="nomReseau"
                  value={formData.nomReseau}
                  onChange={(e) => updateFormData("nomReseau", e.target.value)}
                  placeholder="Nom du Réseau"
                />
                {errors.nomReseau && (
                  <p className="text-sm text-red-500">{errors.nomReseau}</p>
                )}
              </div>

              <div>
                <Label htmlFor="siret">Siret *</Label>
                <Input
                  id="siret"
                  value={formData.siret}
                  onChange={(e) => updateFormData("siret", e.target.value)}
                  placeholder="N° Siret du Réseau"
                />
                {errors.siret && (
                  <p className="text-sm text-red-500">{errors.siret}</p>
                )}
              </div>
            </div>

            <div>
              <Label htmlFor="adresse">Adresse *</Label>
              <Input
                id="adresse"
                value={formData.adresse}
                onChange={(e) => updateFormData("adresse", e.target.value)}
                placeholder="Adresse. Siège Réseau"
              />
              {errors.adresse && (
                <p className="text-sm text-red-500">{errors.adresse}</p>
              )}
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="codePostal">Code postal *</Label>
                <Input
                  id="codePostal"
                  value={formData.codePostal}
                  onChange={(e) => updateFormData("codePostal", e.target.value)}
                  placeholder="Code Postal. Siège Réseau"
                />
                {errors.codePostal && (
                  <p className="text-sm text-red-500">{errors.codePostal}</p>
                )}
              </div>
              <div>
                <Label htmlFor="ville">Ville *</Label>
                <Input
                  id="ville"
                  value={formData.ville}
                  onChange={(e) => updateFormData("ville", e.target.value)}
                  placeholder="Ville. Siège Réseau"
                />
                {errors.ville && (
                  <p className="text-sm text-red-500">{errors.ville}</p>
                )}
              </div>
            </div>

            {/* Responsable */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="prenomResponsable">Prénom Direction *</Label>
                <Input
                  id="prenomResponsable"
                  value={formData.prenomResponsable}
                  onChange={(e) =>
                    updateFormData("prenomResponsable", e.target.value)
                  }
                  placeholder="Prénom. Reseau Direction"
                />
                {errors.prenomResponsable && (
                  <p className="text-sm text-red-500">
                    {errors.prenomResponsable}
                  </p>
                )}
              </div>
              <div>
                <Label htmlFor="nomResponsable">Nom Direction *</Label>
                <Input
                  id="nomResponsable"
                  value={formData.nomResponsable}
                  onChange={(e) =>
                    updateFormData("nomResponsable", e.target.value)
                  }
                  placeholder="Nom. Reseau Direction"
                />
                {errors.nomResponsable && (
                  <p className="text-sm text-red-500">
                    {errors.nomResponsable}
                  </p>
                )}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="emailResponsable">Email Direction *</Label>
                <Input
                  id="emailResponsable"
                  value={formData.emailResponsable}
                  onChange={(e) =>
                    updateFormData("emailResponsable", e.target.value)
                  }
                  placeholder="Email. Reseau Direction"
                />
                {errors.emailResponsable && (
                  <p className="text-sm text-red-500">
                    {errors.emailResponsable}
                  </p>
                )}
              </div>
              <div>
                <Label htmlFor="telephoneResponsable">
                  Téléphone Direction *
                </Label>
                <Input
                  id="telephoneResponsable"
                  value={formData.telephoneResponsable}
                  onChange={(e) =>
                    updateFormData("telephoneResponsable", e.target.value)
                  }
                  placeholder="Tél. Reseau Direction"
                />
                {errors.telephoneResponsable && (
                  <p className="text-sm text-red-500">
                    {errors.telephoneResponsable}
                  </p>
                )}
              </div>
            </div>

            {/* Boutons */}
            <div className="flex justify-between pt-6">
              <Button
                type="button"
                variant="outline"
                onClick={onBack}
                disabled={isLoading}
              >
                <ArrowLeft className="h-4 w-4 mr-2" />
                Retour
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading ? "Création en cours..." : "Créer le réseau"}
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>

      {/* Affichage des informations de connexion après succès */}
      {creationResult && (
        <SuccessAccountInfo
          email={creationResult.email}
          tempPassword={creationResult.tempPassword}
        />
      )}
    </div>
  );
}
```

---

## N15. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/3.FormAgenceIndependanteGestion.tsx`
```typescript
import React, { useEffect, useRef, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "../../3-Utilitaires/tabs";
import { Upload, Download, Trash2, Eye } from 'lucide-react';
import GraphBoutonModifier from '../../5-Graphisme/1.GraphFormulaires/5.GraphBoutonModifier';
import { ReseauSelector } from '@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/components/ReseauSelector';
import { useReseauFormData } from '@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauFormData';
import { useReseauIntegrations } from '@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/1.Reseau/hooks/useReseauIntegrations';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

interface Props {
  onBack?: () => void;
}

const FormReseauGestion: React.FC<Props> = ({ onBack }) => {
  const { toast } = useToast();

  const {
    reseaux,
    selectedReseauId,
    formData,
    isLoading,
    isSaving,
    errors,
    loadReseaux,
    selectReseau,
    updateFormField,
    saveReseau,
    loadReseauData,
  } = useReseauFormData();

  const {
    brevo, setBrevo,
    zoho, setZoho,
    openai, setOpenAI,
    brevoConnexionId,
    zohoConnexionId,
    openaiConnexionId,
    isLoading: integLoading,
    isSaving: integSaving,
    loadForReseau,
    saveIntegration,
  } = useReseauIntegrations();

  const [isEditingGeneral, setIsEditingGeneral] = useState(false);
  const [isEditingBrevo, setIsEditingBrevo] = useState(false);
  const [isEditingZoho, setIsEditingZoho] = useState(false);
  const [isEditingOpenAI, setIsEditingOpenAI] = useState(false);
  const [isEditingLogo, setIsEditingLogo] = useState(false);
  const [isEditingDocuments, setIsEditingDocuments] = useState(false);

  const logoInputRef = useRef<HTMLInputElement | null>(null);
  const docsInputRef = useRef<HTMLInputElement | null>(null);
  const [selectedLogo, setSelectedLogo] = useState<File | null>(null);
  const [selectedDocs, setSelectedDocs] = useState<File[]>([]);

  useEffect(() => { loadReseaux(); }, [loadReseaux]);
  useEffect(() => { if (selectedReseauId) loadForReseau(selectedReseauId); }, [selectedReseauId, loadForReseau]);

  const handleSaveGeneral = async () => {
    if (!selectedReseauId) return;
    const success = await saveReseau({
      reseau_nom: formData.reseau_nom,
      reseau_identite_commerciale: formData.reseau_identite_commerciale,
      reseau_adresse: formData.reseau_adresse,
      reseau_code_postal: formData.reseau_code_postal,
      reseau_ville: formData.reseau_ville,
      reseau_siret: formData.reseau_siret,
      reseau_telephone: formData.reseau_telephone,
      reseau_email: formData.reseau_email,
    });
    if (success) setIsEditingGeneral(false);
  };

  const handleSaveBrevo = async () => { if (!selectedReseauId) return; const ok = await saveIntegration(selectedReseauId, 'brevo'); if (ok) setIsEditingBrevo(false); };
  const handleSaveZoho = async () => { if (!selectedReseauId) return; const ok = await saveIntegration(selectedReseauId, 'zoho'); if (ok) setIsEditingZoho(false); };
  const handleSaveOpenAI = async () => { if (!selectedReseauId) return; const ok = await saveIntegration(selectedReseauId, 'openai'); if (ok) setIsEditingOpenAI(false); };

  const reloadAll = async () => {
    if (selectedReseauId) {
      await loadReseauData(selectedReseauId);
      await loadForReseau(selectedReseauId);
      setSelectedLogo(null);
      setSelectedDocs([]);
    }
  };

  // ✅ Upload fichier (logo / ressource) vers EF corrigée (Step04 + mapping stratégie)
  const uploadFile = async (type: 'logo' | 'document', file: File, reseauId: string) => {
    const fd = new FormData();
    fd.append('file', file);
    // EF Step04 attend fileType: 'logo' | 'ressource'
    fd.append('fileType', type === 'document' ? 'ressource' : 'logo');
    // EF Step04 attend reseau_id (snake_case)
    fd.append('reseau_id', reseauId);

    const { data, error } = await supabase.functions.invoke('gestion-reseau-admin-fichiers', { body: fd });
    if (error || !data?.success) throw error || new Error('Upload échoué');
    return (data?.data?.path as string) || '';
  };

  const handleSaveLogo = async () => {
    if (!selectedReseauId || !selectedLogo) { setIsEditingLogo(false); return; }
    try {
      await uploadFile('logo', selectedLogo, selectedReseauId);
      toast({ title: 'Succès', description: 'Logo mis à jour' });
      await reloadAll();
      setIsEditingLogo(false);
    } catch {
      toast({ title: 'Erreur', description: "Impossible d'uploader le logo", variant: 'destructive' });
    }
  };

  const handleSaveDocuments = async () => {
    if (!selectedReseauId) { setIsEditingDocuments(false); return; }
    try {
      for (const f of selectedDocs) {
        await uploadFile('document', f, selectedReseauId);
      }
      toast({ title: 'Succès', description: 'Documents mis à jour' });
      await reloadAll();
      setIsEditingDocuments(false);
    } catch {
      toast({ title: 'Erreur', description: "Impossible d'uploader les documents", variant: 'destructive' });
    }
  };

  // ✅ Suppression via EF (POST JSON), plus de DELETE
  const removeStoragePath = async (path: string, fileType: 'logo' | 'ressource') => {
    const { data, error } = await supabase.functions.invoke('gestion-reseau-admin-fichiers', {
      body: { action: 'delete', reseau_id: selectedReseauId, fileType, path }
    });
    if (error || !data?.success) throw error || new Error('Suppression échouée');
  };

  const handleDeleteLogo = async () => {
    if (!selectedReseauId || !formData.reseau_logo) return;
    try {
      await removeStoragePath(formData.reseau_logo, 'logo');
      toast({ title: 'Succès', description: 'Logo supprimé' });
      await reloadAll();
    } catch {
      toast({ title: 'Erreur', description: 'Suppression logo impossible', variant: 'destructive' });
    }
  };

  const handleDeleteDocument = async (docPath: string) => {
    if (!selectedReseauId) return;
    try {
      await removeStoragePath(docPath, 'ressource');
      toast({ title: 'Succès', description: 'Document supprimé' });
      await reloadAll();
    } catch {
      toast({ title: 'Erreur', description: 'Suppression document impossible', variant: 'destructive' });
    }
  };

  const handleSubmit = async (e: React.FormEvent) => { e.preventDefault(); };

  return (
    <div className="space-y-6">
      <ReseauSelector
        reseaux={reseaux}
        selectedReseauId={selectedReseauId}
        onSelect={selectReseau}
        isLoading={isLoading}
      />

      <Tabs defaultValue="general" className="w-full">
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="general" className="text-base font-semibold">Général</TabsTrigger>
          <TabsTrigger value="integrations" className="text-base font-semibold">Intégrations</TabsTrigger>
          <TabsTrigger value="fichiers" className="text-base font-semibold">Fichiers</TabsTrigger>
        </TabsList>

        <form onSubmit={handleSubmit}>
          {/* ✅ Informations Générales (UI inchangée) */}
          <TabsContent value="general" className="space-y-6">
            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold">Informations Générales</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveGeneral}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingGeneral}
                    isLoading={isSaving}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="reseau_nom">Nom du Réseau</Label>
                      <Input
                        id="reseau_nom"
                        value={formData.reseau_nom || ''}
                        onChange={e => updateFormField('reseau_nom', e.target.value)}
                        placeholder="Nom du Réseau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_identite_commerciale">Identité Commerciale du Réseau</Label>
                      <Input
                        id="reseau_identite_commerciale"
                        value={formData.reseau_identite_commerciale || ''}
                        onChange={e => updateFormField('reseau_identite_commerciale', e.target.value)}
                        placeholder="Optionnel. Si Nom Commercial différent"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_adresse">Adresse</Label>
                      <Input
                        id="reseau_adresse"
                        value={formData.reseau_adresse || ''}
                        onChange={e => updateFormField('reseau_adresse', e.target.value)}
                        placeholder="Adresse. Siège Réseau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_code_postal">Code Postal</Label>
                      <Input
                        id="reseau_code_postal"
                        value={formData.reseau_code_postal || ''}
                        onChange={e => updateFormField('reseau_code_postal', e.target.value)}
                        placeholder="Code Postal. Siège Réseau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                  </div>
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="reseau_ville">Ville</Label>
                      <Input
                        id="reseau_ville"
                        value={formData.reseau_ville || ''}
                        onChange={e => updateFormField('reseau_ville', e.target.value)}
                        placeholder="Ville. Siège Réseau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_siret">Siret</Label>
                      <Input
                        id="reseau_siret"
                        value={formData.reseau_siret || ''}
                        onChange={e => updateFormField('reseau_siret', e.target.value)}
                        placeholder="N° Siret du Réseau"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_telephone">Téléphone Direction</Label>
                      <Input
                        id="reseau_telephone"
                        value={formData.reseau_telephone || ''}
                        onChange={e => updateFormField('reseau_telephone', e.target.value)}
                        placeholder="Tél. Reseau Direction"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                    <div>
                      <Label htmlFor="reseau_email">Email Direction</Label>
                      <Input
                        id="reseau_email"
                        type="email"
                        value={formData.reseau_email || ''}
                        onChange={e => updateFormField('reseau_email', e.target.value)}
                        placeholder="Email. Reseau Direction"
                        disabled={!isEditingGeneral}
                      />
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* ✅ Intégrations (UI inchangée) */}
          <TabsContent value="integrations" className="space-y-6">
            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold flex items-center gap-2">Intégration Brevo</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveBrevo}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingBrevo}
                    isLoading={integSaving}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="brevo_api_key">Clé API Brevo</Label>
                    <Input
                      id="brevo_api_key"
                      type="password"
                      placeholder="Renseigner. N° Clé API"
                      value={brevo.brevo_api_key || ''}
                      onChange={e => setBrevo({ ...brevo, brevo_api_key: e.target.value })}
                      disabled={!isEditingBrevo}
                    />
                  </div>
                  <div>
                    <Label htmlFor="brevo_email_compte">Email Compte Brevo</Label>
                    <Input
                      id="brevo_email_compte"
                      type="email"
                      placeholder="Renseigner. Email associé compte Brevo"
                      value={brevo.brevo_email_compte || ''}
                      onChange={e => setBrevo({ ...brevo, brevo_email_compte: e.target.value })}
                      disabled={!isEditingBrevo}
                    />
                  </div>
                  <div>
                    <Label htmlFor="brevo_nom_compte">Nom Compte Brevo</Label>
                    <Input
                      id="brevo_nom_compte"
                      placeholder="Renseigner. Nom compte Brevo"
                      value={brevo.brevo_nom_compte || ''}
                      onChange={e => setBrevo({ ...brevo, brevo_nom_compte: e.target.value })}
                      disabled={!isEditingBrevo}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold flex items-center gap-2">Intégration Zoho</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveZoho}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingZoho}
                    isLoading={integSaving}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="zoho_api_key">Clé API Zoho</Label>
                    <Input
                      id="zoho_api_key"
                      type="password"
                      placeholder="Renseigner. Clé API Zoho"
                      value={zoho.zoho_api_key || ''}
                      onChange={e => setZoho({ ...zoho, zoho_api_key: e.target.value })}
                      disabled={!isEditingZoho}
                    />
                  </div>
                  <div>
                    <Label htmlFor="zoho_email_compte">Email Compte Zoho</Label>
                    <Input
                      id="zoho_email_compte"
                      type="email"
                      placeholder="Renseigner. Email associé compte Zoho"
                      value={zoho.zoho_email_compte || ''}
                      onChange={e => setZoho({ ...zoho, zoho_email_compte: e.target.value })}
                      disabled={!isEditingZoho}
                    />
                  </div>
                  <div>
                    <Label htmlFor="zoho_nom_compte">Nom Compte Zoho</Label>
                    <Input
                      id="zoho_nom_compte"
                      placeholder="Renseigner. Nom compte Zoho"
                      value={zoho.zoho_nom_compte || ''}
                      onChange={e => setZoho({ ...zoho, zoho_nom_compte: e.target.value })}
                      disabled={!isEditingZoho}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold flex items-center gap-2">Intégration OpenAI</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveOpenAI}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingOpenAI}
                    isLoading={integSaving}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="openai_api_key">Clé API OpenAI</Label>
                    <Input
                      id="openai_api_key"
                      type="password"
                      placeholder="Renseigner. Clé API OpenAI"
                      value={openai.openai_api_key || ''}
                      onChange={e => setOpenAI({ ...openai, openai_api_key: e.target.value })}
                      disabled={!isEditingOpenAI}
                    />
                  </div>
                  <div>
                    <Label htmlFor="openai_email_compte">Email Compte OpenAI</Label>
                    <Input
                      id="openai_email_compte"
                      type="email"
                      placeholder="Renseigner. Email associé compte OpenAI"
                      value={openai.openai_email_compte || ''}
                      onChange={e => setOpenAI({ ...openai, openai_email_compte: e.target.value })}
                      disabled={!isEditingOpenAI}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* ✅ Fichiers - STRUCTURE 2 CARTES SÉPARÉES (UI inchangée) */}
          <TabsContent value="fichiers" className="space-y-6">
            {/* 🎨 Logo du Réseau */}
            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold">Logo du Réseau</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveLogo}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingLogo}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="reseau_logo_upload">Télécharger le Logo du Réseau</Label>
                    <div
                      className="border-2 border-dashed border-muted-foreground/25 rounded-lg p-6 text-center cursor-pointer"
                      onClick={() => isEditingLogo && logoInputRef.current?.click()}
                    >
                      <div className="space-y-2">
                        <div className="mx-auto w-12 h-12 text-muted-foreground">
                          <Upload className="h-6 w-6" />
                        </div>
                        <div>
                          <p className="text-sm">Cliquer pour sélectionner le logo</p>
                          <p className="text-xs text-muted-foreground">PNG, JPG, SVG - Max 2MB</p>
                        </div>
                      </div>
                    </div>
                    <input
                      ref={logoInputRef}
                      id="reseau_logo_upload"
                      type="file"
                      accept="image/*"
                      hidden
                      disabled={!isEditingLogo}
                      onChange={e => setSelectedLogo(e.target.files?.[0] || null)}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Logo actuel</Label>
                    <div className="border rounded-lg p-4 bg-muted/20">
                      {formData.reseau_logo ? (
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-16 h-16 border rounded bg-white flex items-center justify-center">
                              <Upload className="h-5 w-5 text-muted-foreground" />
                            </div>
                            <div>
                              <p className="font-medium break-all">{formData.reseau_logo}</p>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              type="button"
                              variant="destructive"
                              size="sm"
                              onClick={handleDeleteLogo}
                              disabled={!isEditingLogo}
                            >
                              Supprimer
                            </Button>
                          </div>
                        </div>
                      ) : (
                        <span className="text-muted-foreground text-sm">Aucun logo uploadé</span>
                      )}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* 📄 Documents Institutionnels */}
            <Card>
              <CardHeader>
                <div className="flex justify-between items-center">
                  <CardTitle className="text-2xl font-bold">Documents Institutionnels</CardTitle>
                  <GraphBoutonModifier
                    onSave={handleSaveDocuments}
                    onCancel={reloadAll}
                    onEditingChange={setIsEditingDocuments}
                  />
                </div>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="space-y-2">
                    <Label>Télécharger les documents</Label>
                    <div
                      className="border-2 border-dashed border-muted-foreground/25 rounded-lg p-6 text-center cursor-pointer"
                      onClick={() => isEditingDocuments && docsInputRef.current?.click()}
                    >
                      <div className="space-y-2">
                        <div className="mx-auto w-12 h-12 text-muted-foreground">
                          <Download className="h-6 w-6" />
                        </div>
                        <div>
                          <p className="text-sm">Cliquer pour sélectionner les documents</p>
                          <p className="text-xs text-muted-foreground">PDF, DOC, DOCX - Max 10MB par fichier</p>
                        </div>
                      </div>
                    </div>
                    <input
                      ref={docsInputRef}
                      type="file"
                      multiple
                      accept=".pdf,.doc,.docx,.xls,.xlsx"
                      hidden
                      disabled={!isEditingDocuments}
                      onChange={e => setSelectedDocs(e.target.files ? Array.from(e.target.files) : [])}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Supprimer un fichier existant</Label>
                    <div className="border rounded-lg p-4 bg-muted/20 space-y-3">
                      {formData.reseau_ressources && formData.reseau_ressources.length > 0 ? (
                        <>
                          {formData.reseau_ressources.map((p) => (
                            <div key={p} className="flex items-center justify-between p-3 border rounded bg-white">
                              <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-100 rounded flex items-center justify-center">
                                  <Download className="h-4 w-4 text-blue-600" />
                                </div>
                                <div className="max-w-[60ch]">
                                  <p className="font-medium break-all">{p}</p>
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <Button
                                  type="button"
                                  variant="outline"
                                  size="sm"
                                  onClick={async () => {
                                    const { data } = await supabase.storage
                                      .from('bucket-table-reseau')
                                      .createSignedUrl(p, 60);
                                    if (data?.signedUrl) window.open(data.signedUrl, '_blank');
                                  }}
                                >
                                  <Eye className="h-4 w-4 mr-1" />
                                  Voir
                                </Button>
                                <Button
                                  type="button"
                                  variant="destructive"
                                  size="sm"
                                  onClick={() => handleDeleteDocument(p)}
                                  disabled={!isEditingDocuments}
                                >
                                  <Trash2 className="h-4 w-4 mr-1" />
                                  Supprimer
                                </Button>
                              </div>
                            </div>
                          ))}
                        </>
                      ) : (
                        <span className="text-muted-foreground text-sm">Aucun document uploadé</span>
                      )}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </form>
      </Tabs>

      {onBack && (
        <div className="pt-6">
          <Button type="button" variant="outline" onClick={onBack}>
            ← Retour
          </Button>
        </div>
      )}
    </div>
  );
};

export default FormReseauGestion;
```

---

## N16. `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/SuccessAccountInfo.tsx`
```typescript
import React, { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Copy, Eye, EyeOff, CheckCircle } from "lucide-react";
import { toast } from "sonner";

interface SuccessAccountInfoProps {
  email: string;
  tempPassword: string;
}

export default function SuccessAccountInfo({ email, tempPassword }: SuccessAccountInfoProps) {
  const [showPassword, setShowPassword] = useState(false);

  const copyToClipboard = async (text: string, label: string) => {
    try {
      await navigator.clipboard.writeText(text);
      toast.success(`${label} copié dans le presse-papiers`);
    } catch (err) {
      toast.error("Erreur lors de la copie");
    }
  };

  return (
    <Card className="mt-6 border-green-200 bg-green-50/50">
      <CardHeader>
        <div className="flex items-center gap-3">
          <CheckCircle className="h-6 w-6 text-green-600" />
          <CardTitle className="text-green-800">Compte créé avec succès</CardTitle>
        </div>
      </CardHeader>

      <CardContent>
        <div className="space-y-4">
          <div className="p-4 bg-white rounded-lg border">
            <h4 className="font-medium text-sm text-gray-700 mb-3">
              Informations de connexion temporaires
            </h4>
            
            <div className="space-y-3">
              {/* Email */}
              <div className="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                <div>
                  <span className="text-sm font-medium text-gray-600">Email :</span>
                  <p className="text-sm text-gray-900">{email}</p>
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => copyToClipboard(email, "Email")}
                >
                  <Copy className="h-4 w-4" />
                </Button>
              </div>

              {/* Mot de passe */}
              <div className="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                <div className="flex-1">
                  <span className="text-sm font-medium text-gray-600">Mot de passe temporaire :</span>
                  <p className="text-sm text-gray-900 font-mono">
                    {showPassword ? tempPassword : "••••••••••••••••"}
                  </p>
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setShowPassword(!showPassword)}
                  >
                    {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => copyToClipboard(tempPassword, "Mot de passe")}
                  >
                    <Copy className="h-4 w-4" />
                  </Button>
                </div>
              </div>
            </div>

            <div className="mt-4 p-3 bg-blue-50 rounded-md border border-blue-200">
              <p className="text-sm text-blue-800">
                <strong>Important :</strong> Ces informations sont temporaires. L'utilisateur devra 
                changer son mot de passe lors de sa première connexion.
              </p>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

---

# TITRE 6. SQL

## N17. `00_all_in_one_agence_independante.sql`
```sql

```

---

## N18. `01_storage-bucket-agence-independante.sql`
```sql

```

---

## N19. `02_trigger-sync-agence-responsable.sql`
```sql

```

---

## N20. `03_indexes-agence-independante.sql`
```sql

```

---

# TITRE 7. CONFIG TOML

## N21. `supabase/config.toml`
```toml
project_id = "ksymahfrtvhnbeobsspt"

[functions.notifier-nouvelle-demande]
verify_jwt = false

[functions.create-reseau-admin]
verify_jwt = false

[functions.gestion-reseau-admin]
verify_jwt = false

[functions.gestion-reseau-admin-donnees]
verify_jwt = false

[functions.gestion-reseau-admin-update]
verify_jwt = false

[functions.gestion-reseau-admin-fichiers]
verify_jwt = false

[functions.create-agence-independante-admin]
verify_jwt = false

[functions.gestion-agence-independante-admin]
verify_jwt = false

[functions.gestion-agence-independante-admin-donnees]
verify_jwt = false

[functions.gestion-agence-independante-admin-update]
verify_jwt = false

[functions.gestion-agence-independante-admin-fichiers]
verify_jwt = false
```

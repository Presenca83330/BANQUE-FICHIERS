# CODES ET EMPLACEMENTS | FICHIERS UTILISES PAR FORMULAIRE TABLE AGENCE INDEPENDANTE
---
# TITRE 1. HOOKS FORM CREATEUR
## N1. `src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/types.ts`
```typescript
export type CreateAgenceIndependantePayload = {
  agence: {
    agence_indep_nom: string;
    agence_indep_siret: string;
    agence_indep_adresse: string;
    agence_indep_code_postal: string;
    agence_indep_ville: string;
    agence_indep_email: string;
    agence_indep_telephone: string;
    agence_indep_identite_commerciale?: string | null;
  };
  responsable: {
    agence_indep_responsable_prenom: string;
    agence_indep_responsable_nom: string;
    agence_indep_responsable_email: string;
    agence_indep_responsable_telephone: string;
  };
};

export type CreateAgenceResponse = {
  success: boolean;
  data?: {
    organisation: { organisation_id: string; organisation_nom: string };
    agence: { agence_indep_id: string; agence_indep_nom: string };
    user: { id: string; email: string };
  };
  error?: string;
  message?: string;
  details?: string;
  requestId?: string;
};

```
---
## N2. `src/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/useAgenceIndependanteCreation.ts`
```typescript
import { useCallback, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { CreateAgenceIndependantePayload, CreateAgenceResponse } from "./types";

export function useAgenceIndependanteCreation() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [result, setResult] = useState<CreateAgenceResponse | null>(null);

  const createAgence = useCallback(async (payload: CreateAgenceIndependantePayload) => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<CreateAgenceResponse>(
        "create-agence-independante-admin",
        { body: payload }
      );
      if (error) throw error;
      setResult(data ?? null);
      return data ?? null;
    } catch (e: any) {
      setError(e?.message ?? "Erreur inconnue");
      return null;
    } finally {
      setLoading(false);
    }
  }, []);

  return { createAgence, loading, error, result };
}

```
---
# TITRE 2. HOOKS FORM GESTION

## N.3 COMPONENT `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector.tsx`
```typescript
import React, { useEffect } from "react";
import type { AgenceIndependanteMinimal } from "../hooks/types";
import { useAgenceIndependanteFormData } from "../hooks/useAgenceIndependanteFormData";

type Props = {
  value: string | null;
  onChange: (id: string) => void;
  disabled?: boolean;
  /** 
   * Optionnel : permet d'injecter un rendu custom (ex. shadcn UI Select) sans changer la charte.
   * Par défaut, un <select> HTML minimal est rendu.
   */
  render?: (args: {
    options: AgenceIndependanteMinimal[];
    value: string | null;
    onChange: (id: string) => void;
    disabled?: boolean;
    loading: boolean;
    error: string | null;
  }) => React.ReactNode;
};

export function AgenceIndependanteSelector({ value, onChange, disabled, render }: Props) {
  const { agences, loading, error, selectedId, setSelectedId } = useAgenceIndependanteFormData();

  useEffect(() => {
    if (value && value !== selectedId) setSelectedId(value);
  }, [value, selectedId, setSelectedId]);

  useEffect(() => {
    if (selectedId && selectedId !== value) onChange(selectedId);
  }, [selectedId]); // eslint-disable-line

  if (render) {
    return <>{render({ options: agences, value: selectedId ?? null, onChange: setSelectedId, disabled, loading, error })}</>;
  }

  // Rendu minimal, à remplacer par le composant design system existant si besoin
  return (
    <select
      value={selectedId ?? ""}
      onChange={(e) => setSelectedId(e.target.value || null)}
      disabled={disabled || loading}
      style={{ width: "100%", padding: "8px" }}
    >
      <option value="">{loading ? "Chargement..." : "Sélectionner une agence"}</option>
      {agences.map((a) => (
        <option key={a.agence_id} value={a.agence_id}>
          {a.agence_nom}
        </option>
      ))}
    </select>
  );
}

```
---
## N.4 HOOKS `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/types.ts`
```typescript
export type AgenceIndependanteMinimal = {
  agence_id: string;
  agence_nom: string;
};

export type AgenceIndependante = {
  agence_indep_id: string;
  organisation_id: string;
  agence_indep_nom: string;
  agence_indep_identite_commerciale?: string | null;
  agence_indep_siret?: string | null;
  agence_indep_adresse?: string | null;
  agence_indep_code_postal?: string | null;
  agence_indep_ville?: string | null;
  agence_indep_email?: string | null;
  agence_indep_telephone?: string | null;
  agence_indep_logo?: string | null;
  agence_indep_ressources?: string[] | null;
  // Intégrations (FK optionnelles)
  agence_indep_brevo_connexion_id?: string | null;
  agence_indep_zoho_connexion_id?: string | null;
  agence_indep_openai_connexion_id?: string | null;
  agence_indep_linkedin_connexion_id?: string | null;
  agence_indep_facebook_connexion_id?: string | null;
  agence_indep_instagram_connexion_id?: string | null;
  // Timestamps génériques (optionnels selon schéma)
  agence_indep_created_at?: string;
  agence_indep_updated_at?: string;
  [k: string]: any;
};

export type IntegrationsMap = {
  brevo: any | null;
  zoho: any | null;
  openai: any | null;
  linkedin: any | null;
  facebook: any | null;
  instagram: any | null;
};

export type ListAgencesResponse = {
  success: boolean;
  data?: AgenceIndependanteMinimal[];
  message?: string;
  error?: string;
  requestId?: string;
};

export type AgenceDetailResponse = {
  success: boolean;
  data?: { agence: AgenceIndependante; integrations: IntegrationsMap };
  message?: string;
  error?: string;
  requestId?: string;
};

export type UpdateAgenceResponse = {
  success: boolean;
  data?: { agence?: AgenceIndependante; integration?: any };
  message?: string;
  error?: string;
  requestId?: string;
};

export type FileUploadResponse = {
  success: boolean;
  data?: { path: string; fileType: "logo" | "ressource" };
  message?: string;
  error?: string;
  requestId?: string;
};

export type FileDeleteResponse = {
  success: boolean;
  data?: { deleted: string; fileType: "logo" | "ressource" };
  message?: string;
  error?: string;
  requestId?: string;
};

export type AbonnementStripeView = {
  abonnement_stripe_plan: string | null;
  abonnement_stripe_debut: string | null;
};

```
---
## N.5 HOOKS `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAbonnementStripeView.ts`
```typescript
import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { AbonnementStripeView } from "./types";

/**
 * Lecture *read-only* du plan + date de début Stripe.
 * RLS: admin_presenca ou org owner (policies en place).
 */
export function useAbonnementStripeView(organisationId: string | null) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<AbonnementStripeView | null>(null);

  const load = useCallback(async () => {
    if (!organisationId) {
      setData(null);
      return;
    }
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase
        .from("abonnement_stripe")
        .select("abonnement_stripe_plan, abonnement_stripe_debut")
        .eq("organisation_id", organisationId)
        .order("abonnement_stripe_debut", { ascending: false })
        .limit(1);
      if (error) throw error;
      const row = (data?.[0] ?? null) as any;
      setData(row ? { abonnement_stripe_plan: row.abonnement_stripe_plan, abonnement_stripe_debut: row.abonnement_stripe_debut } : { abonnement_stripe_plan: null, abonnement_stripe_debut: null });
    } catch (e: any) {
      setError(e?.message ?? "Erreur lecture abonnement");
    } finally {
      setLoading(false);
    }
  }, [organisationId]);

  useEffect(() => { load(); }, [load]);

  return { loading, error, data, reload: load };
}

```
---
## N.6 `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData.ts`
```typescript
import { useCallback, useEffect, useMemo, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type {
  AgenceIndependante,
  AgenceIndependanteMinimal,
  AgenceDetailResponse,
  ListAgencesResponse,
  UpdateAgenceResponse,
} from "./types";

export function useAgenceIndependanteFormData() {
  const [loading, setLoading] = useState(false);
  const [agences, setAgences] = useState<AgenceIndependanteMinimal[]>([]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [agence, setAgence] = useState<AgenceIndependante | null>(null);
  const [integrations, setIntegrations] = useState<Record<string, any> | null>(null);
  const [error, setError] = useState<string | null>(null);

  const loadAgences = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<ListAgencesResponse>(
        "gestion-agence-independante-admin",
        { body: {} }
      );
      if (error) throw error;
      setAgences(data?.data ?? []);
    } catch (e: any) {
      setError(e?.message ?? "Erreur chargement agences");
    } finally {
      setLoading(false);
    }
  }, []);

  const loadAgenceData = useCallback(async (agenceId: string) => {
    if (!agenceId) return;
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<AgenceDetailResponse>(
        "gestion-agence-independante-admin-donnees",
        { body: { agence_id: agenceId } }
      );
      if (error) throw error;
      const row = data?.data?.agence ?? null;
      const integ = data?.data?.integrations ?? null;
      setAgence(row);
      setIntegrations(integ);
    } catch (e: any) {
      setError(e?.message ?? "Erreur chargement agence");
    } finally {
      setLoading(false);
    }
  }, []);

  const saveGeneral = useCallback(async (patch: Partial<AgenceIndependante>) => {
    if (!selectedId) return null;
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<UpdateAgenceResponse>(
        "gestion-agence-independante-admin-update",
        { body: { agence_id: selectedId, generalData: patch } }
      );
      if (error) throw error;
      const updated = data?.data?.agence ?? null;
      if (updated) setAgence(updated);
      return updated;
    } catch (e: any) {
      setError(e?.message ?? "Erreur sauvegarde");
      return null;
    } finally {
      setLoading(false);
    }
  }, [selectedId]);

  useEffect(() => { loadAgences(); }, [loadAgences]);
  useEffect(() => { if (selectedId) loadAgenceData(selectedId); }, [selectedId, loadAgenceData]);

  const organisationId = useMemo(() => agence?.organisation_id ?? null, [agence]);

  return {
    loading, error,
    agences, selectedId, setSelectedId,
    agence, integrations, organisationId,
    reload: loadAgences,
    loadAgenceData,
    saveGeneral,
  };
}

```
---
## N.7 `src/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteIntegrations.ts`
```typescript
import { useCallback, useState } from "react";
import { supabase } from "@/src/integrations/supabase/client";
import type { UpdateAgenceResponse } from "./types";

type Kind = "brevo" | "zoho" | "openai" | "linkedin" | "facebook" | "instagram";

export function useAgenceIndependanteIntegrations(agenceId: string | null) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const saveIntegration = useCallback(async (kind: Kind, integrationData: Record<string, any>) => {
    if (!agenceId) return null;
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.functions.invoke<UpdateAgenceResponse>(
        "gestion-agence-independante-admin-update",
        { body: { agence_id: agenceId, integrationKind: kind, integrationData } }
      );
      if (error) throw error;
      return data?.data?.integration ?? null;
    } catch (e: any) {
      setError(e?.message ?? "Erreur sauvegarde intégration");
      return null;
    } finally {
      setLoading(false);
    }
  }, [agenceId]);

  return { saveIntegration, loading, error };
}

```
---
# TITRE 3. FUNCTIONS FORM CREATEUR
## N.8 `supabase/functions/create-agence-independante-admin/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_independante_id";
const ORG = "organisation_id";
const COL_NOM = "agence_independante_nom";
const COL_IDENTITE = "agence_independante_identite_commerciale";
const COL_SIRET = "agence_independante_siret";
const COL_ADRESSE = "agence_independante_adresse";
const COL_CP = "agence_independante_code_postal";
const COL_VILLE = "agence_independante_ville";
const COL_EMAIL = "agence_independante_email";
const COL_TEL = "agence_independante_telephone";
const COL_LOGO = "agence_independante_logo";
const COL_RESS = "agence_independante_ressources"; // text[]

const FK_BREVO = "agence_independante_brevo_connexion_id";
const FK_ZOHO = "agence_independante_zoho_connexion_id";
const FK_OPENAI = "agence_independante_openai_connexion_id";
const FK_LINKEDIN = "agence_independante_linkedin_connexion_id";
const FK_FACEBOOK = "agence_independante_facebook_connexion_id";
const FK_INSTAGRAM = "agence_independante_instagram_connexion_id";

const PROJECTION_MIN = `${COL_NOM}, ${PK}`;
const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const body = await req.json().catch(() => ({}));
    const agence = body?.agence || {};
    const resp = body?.responsable || {};

    const required = [COL_NOM, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL];
    for (const k of required) {
      if (!agence?.[k]) return ok({ success: false, error: `missing_${k}` }, 400);
    }
    if (!resp?.email || !resp?.prenom || !resp?.nom || !resp?.telephone) {
      return ok({ success: false, error: "missing_responsable_fields" }, 400);
    }

    // 1) Organisation (minimal)
    const { data: org, error: eOrg } = await supabase.from("organisations")
      .insert({ organisation_nom: agence[COL_NOM] })
      .select("organisation_id, organisation_nom").single();
    if (eOrg) return ok({ success: false, error: "db_error_organisation_insert", details: eOrg.message }, 500);

    // 2) Agence
    const insertAgence: Record<string, any> = {
      [ORG]: org.organisation_id,
      [COL_NOM]: agence[COL_NOM],
      [COL_SIRET]: agence[COL_SIRET],
      [COL_ADRESSE]: agence[COL_ADRESSE],
      [COL_CP]: agence[COL_CP],
      [COL_VILLE]: agence[COL_VILLE],
      [COL_EMAIL]: agence[COL_EMAIL],
      [COL_TEL]: agence[COL_TEL],
    };
    if (COL_IDENTITE in agence) insertAgence[COL_IDENTITE] = agence[COL_IDENTITE];

    const { data: ag, error: eAg } = await supabase.from(T_AGENCE).insert(insertAgence).select(PROJECTION_DETAIL).single();
    if (eAg) return ok({ success: false, error: "db_error_agence_insert", details: eAg.message }, 500);

    // 3) Auth user
    const authRes = await supabase.auth.admin.createUser({
      email: resp.email,
      email_confirm: true,
      user_metadata: {
        role: "agence_independante_responsable",
        [ORG]: org.organisation_id,
        [PK]: ag[PK],
        prenom: resp.prenom,
        nom: resp.nom,
        telephone: resp.telephone,
      },
    });
    if (authRes.error) return ok({ success: false, error: "auth_create_user_error", details: authRes.error.message }, 500);
    const user = authRes.data.user;

    // 4) Utilisateurs (app table)
    await supabase.from("utilisateurs").insert({
      user_id: user?.id,
      organisation_id: org.organisation_id,
      utilisateur_email: resp.email,
      utilisateur_prenom: resp.prenom,
      utilisateur_nom: resp.nom,
      utilisateur_telephone: resp.telephone,
      utilisateur_role: "agence_independante_responsable",
    });

    // 5) Responsable
    await supabase.from("agence_independante_responsable").insert({
      [PK]: ag[PK],
      prenom: resp.prenom,
      nom: resp.nom,
      email: resp.email,
      telephone: resp.telephone,
      user_id: user?.id,
    });

    return ok({
      success: true,
      data: {
        organisation: org,
        agence: { [PK]: ag[PK], [COL_NOM]: ag[COL_NOM] },
        user: { id: user?.id, email: resp.email }
      },
      message: "Agence créée"
    });
  } catch (e) {
    return ok({ success: false, error: "internal_error", details: String(e) }, 500);
  }
});


```
---
# TITRE 4. FUNCTIONS FORM GESTION
## N.9 `supabase/functions/gestion-agence-independante-admin/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_independante_id";
const ORG = "organisation_id";
const COL_NOM = "agence_independante_nom";
const COL_IDENTITE = "agence_independante_identite_commerciale";
const COL_SIRET = "agence_independante_siret";
const COL_ADRESSE = "agence_independante_adresse";
const COL_CP = "agence_independante_code_postal";
const COL_VILLE = "agence_independante_ville";
const COL_EMAIL = "agence_independante_email";
const COL_TEL = "agence_independante_telephone";
const COL_LOGO = "agence_independante_logo";
const COL_RESS = "agence_independante_ressources"; // text[]

const FK_BREVO = "agence_independante_brevo_connexion_id";
const FK_ZOHO = "agence_independante_zoho_connexion_id";
const FK_OPENAI = "agence_independante_openai_connexion_id";
const FK_LINKEDIN = "agence_independante_linkedin_connexion_id";
const FK_FACEBOOK = "agence_independante_facebook_connexion_id";
const FK_INSTAGRAM = "agence_independante_instagram_connexion_id";

const PROJECTION_MIN = `${COL_NOM}, ${PK}`;
const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const { data, error } = await supabase.from(T_AGENCE).select(PROJECTION_MIN).order(COL_NOM, { ascending: true });
    if (error) return ok({ success: false, error: "db_error_agence_list", details: error.message }, 500);
    const mapped = (data ?? []).map((r: any) => ({ agence_id: r[PK], agence_nom: r[COL_NOM] }));
    return ok({ success: true, data: mapped, message: `${mapped.length} agence(s)` });
  } catch (e) {
    return ok({ success: false, error: "internal_error", details: String(e) }, 500);
  }
});

```
---
## N.10 `supabase/functions/gestion-agence-independante-admin-donnees/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_independante_id";
const ORG = "organisation_id";
const COL_NOM = "agence_independante_nom";
const COL_IDENTITE = "agence_independante_identite_commerciale";
const COL_SIRET = "agence_independante_siret";
const COL_ADRESSE = "agence_independante_adresse";
const COL_CP = "agence_independante_code_postal";
const COL_VILLE = "agence_independante_ville";
const COL_EMAIL = "agence_independante_email";
const COL_TEL = "agence_independante_telephone";
const COL_LOGO = "agence_independante_logo";
const COL_RESS = "agence_independante_ressources"; // text[]

const FK_BREVO = "agence_independante_brevo_connexion_id";
const FK_ZOHO = "agence_independante_zoho_connexion_id";
const FK_OPENAI = "agence_independante_openai_connexion_id";
const FK_LINKEDIN = "agence_independante_linkedin_connexion_id";
const FK_FACEBOOK = "agence_independante_facebook_connexion_id";
const FK_INSTAGRAM = "agence_independante_instagram_connexion_id";

const PROJECTION_MIN = `${COL_NOM}, ${PK}`;
const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const body = await req.json().catch(() => ({}));
    const agenceId = body?.agence_id as string | undefined;
    if (!agenceId) return ok({ success: false, error: "bad_request_missing_agence_id" }, 400);

    const { data: agence, error } = await supabase
      .from(T_AGENCE)
      .select(PROJECTION_DETAIL)
      .eq(PK, agenceId)
      .maybeSingle();
    if (error) return ok({ success: false, error: "db_error_agence_fetch", details: error.message }, 500);
    if (!agence) return ok({ success: false, error: "not_found_agence" }, 404);

    const integrations: Record<string, any> = { brevo: null, zoho: null, openai: null, linkedin: null, facebook: null, instagram: null };
    const tasks: Promise<void>[] = [];

    for (const kind of Object.keys(INTEGRATION_TABLES)) {
      const cfg = INTEGRATION_TABLES[kind];
      const fkVal = agence[cfg.fk];
      if (!fkVal) continue;
      tasks.push(
        supabase.from(cfg.table).select("*").eq(cfg.id, fkVal).maybeSingle().then(({ data, error }) => {
          if (!error) integrations[kind] = data ?? null;
        })
      );
    }
    if (tasks.length) await Promise.all(tasks);

    return ok({ success: true, data: { agence, integrations }, message: "OK" });
  } catch (e) {
    return ok({ success: false, error: "internal_error", details: String(e) }, 500);
  }
});

```
---
## N.11 `supabase/functions/gestion-agence-independante-admin-fichiers/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_independante_id";
const ORG = "organisation_id";
const COL_NOM = "agence_independante_nom";
const COL_IDENTITE = "agence_independante_identite_commerciale";
const COL_SIRET = "agence_independante_siret";
const COL_ADRESSE = "agence_independante_adresse";
const COL_CP = "agence_independante_code_postal";
const COL_VILLE = "agence_independante_ville";
const COL_EMAIL = "agence_independante_email";
const COL_TEL = "agence_independante_telephone";
const COL_LOGO = "agence_independante_logo";
const COL_RESS = "agence_independante_ressources"; // text[]

const FK_BREVO = "agence_independante_brevo_connexion_id";
const FK_ZOHO = "agence_independante_zoho_connexion_id";
const FK_OPENAI = "agence_independante_openai_connexion_id";
const FK_LINKEDIN = "agence_independante_linkedin_connexion_id";
const FK_FACEBOOK = "agence_independante_facebook_connexion_id";
const FK_INSTAGRAM = "agence_independante_instagram_connexion_id";

const PROJECTION_MIN = `${COL_NOM}, ${PK}`;
const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

const BUCKET_NAME = "bucket-table-agence-independante";

function sanitizeFilename(name: string) { return name.replace(/[^a-zA-Z0-9._-]/g, "_"); }
function pathFor(agenceId: string, kind: "logo"|"ressource", fn: string) {
  const folder = kind === "logo" ? "1-logos" : "2-documents-institutionnels";
  return `agence-${agenceId}/${folder}/${Date.now()}_${sanitizeFilename(fn)}`;
}

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const ct = req.headers.get("content-type") || "";
    if (ct.includes("multipart/form-data")) {
      const fd = await req.formData();
      const agenceId = String(fd.get("agence_id") || "");
      const fileType = String(fd.get("fileType") || "");
      const file = fd.get("file") as File | null;
      if (!agenceId || !file || !["logo","ressource"].includes(fileType)) return ok({ success: false, error: "bad_upload_params" }, 400);

      const p = pathFor(agenceId, fileType as any, file.name);
      const buf = await file.arrayBuffer();
      const { error: upErr } = await supabase.storage.from(BUCKET_NAME).upload(p, buf, { contentType: file.type, upsert: false });
      if (upErr) return ok({ success: false, error: "upload_failed", details: upErr.message }, 500);

      if (fileType === "logo") {
        const { error } = await supabase.from(T_AGENCE).update({ [COL_LOGO]: p }).eq(PK, agenceId);
        if (error) return ok({ success: false, error: "db_logo_update_failed", details: error.message }, 500);
      } else {
        const { data: row, error: e1 } = await supabase.from(T_AGENCE).select(`${COL_RESS}`).eq(PK, agenceId).maybeSingle();
        if (e1 || !row) return ok({ success: false, error: "db_read_ressources_failed", details: e1?.message || "not_found" }, 500);
        const current = (row[COL_RESS] ?? []) as string[];
        const updated = [...current, p];
        const { error } = await supabase.from(T_AGENCE).update({ [COL_RESS]: updated }).eq(PK, agenceId);
        if (error) return ok({ success: false, error: "db_ressources_update_failed", details: error.message }, 500);
      }
      return ok({ success: true, data: { path: p, fileType }, message: "Fichier uploadé" });
    }

    if (ct.includes("application/json")) {
      const { action, agence_id, fileType, path } = await req.json().catch(() => ({}));
      if (action !== "delete" || !agence_id || !["logo","ressource"].includes(fileType) || typeof path !== "string") {
        return ok({ success: false, error: "bad_delete_params" }, 400);
      }
      const { error: delErr } = await supabase.storage.from(BUCKET_NAME).remove([path]);
      if (delErr) return ok({ success: false, error: "delete_failed", details: delErr.message }, 500);

      if (fileType === "logo") {
        const { error } = await supabase.from(T_AGENCE).update({ [COL_LOGO]: null }).eq(PK, agence_id);
        if (error) return ok({ success: false, error: "db_logo_clear_failed", details: error.message }, 500);
      } else {
        const { data: row, error: e1 } = await supabase.from(T_AGENCE).select(`${COL_RESS}`).eq(PK, agence_id).maybeSingle();
        if (e1 || !row) return ok({ success: false, error: "db_read_ressources_failed", details: e1?.message || "not_found" }, 500);
        const current = (row[COL_RESS] ?? []) as string[];
        const updated = current.filter((p: string) => p !== path);
        const { error } = await supabase.from(T_AGENCE).update({ [COL_RESS]: updated }).eq(PK, agence_id);
        if (error) return ok({ success: false, error: "db_ressources_update_failed", details: error.message }, 500);
      }
      return ok({ success: true, data: { deleted: path, fileType }, message: "Fichier supprimé" });
    }

    return ok({ success: false, error: "unsupported_content_type" }, 400);
  } catch (e) {
    return ok({ success: false, error: "internal_error", details: String(e) }, 500);
  }
});

```
---
## N.12 `supabase/functions/gestion-agence-independante-admin-update/index.ts`
```typescript
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const corsHeaders: HeadersInit = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
};

function ok(payload: any, status = 200) {
  return new Response(JSON.stringify(payload), { status, headers: { ...corsHeaders, "Content-Type": "application/json" } });
}

// === SCHEMA (fixe) ===
const T_AGENCE = "agence_independante";
const PK = "agence_independante_id";
const ORG = "organisation_id";
const COL_NOM = "agence_independante_nom";
const COL_IDENTITE = "agence_independante_identite_commerciale";
const COL_SIRET = "agence_independante_siret";
const COL_ADRESSE = "agence_independante_adresse";
const COL_CP = "agence_independante_code_postal";
const COL_VILLE = "agence_independante_ville";
const COL_EMAIL = "agence_independante_email";
const COL_TEL = "agence_independante_telephone";
const COL_LOGO = "agence_independante_logo";
const COL_RESS = "agence_independante_ressources"; // text[]

const FK_BREVO = "agence_independante_brevo_connexion_id";
const FK_ZOHO = "agence_independante_zoho_connexion_id";
const FK_OPENAI = "agence_independante_openai_connexion_id";
const FK_LINKEDIN = "agence_independante_linkedin_connexion_id";
const FK_FACEBOOK = "agence_independante_facebook_connexion_id";
const FK_INSTAGRAM = "agence_independante_instagram_connexion_id";

const PROJECTION_MIN = `${COL_NOM}, ${PK}`;
const PROJECTION_DETAIL = [
  PK, ORG, COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL,
  COL_LOGO, COL_RESS, FK_BREVO, FK_ZOHO, FK_OPENAI, FK_LINKEDIN, FK_FACEBOOK, FK_INSTAGRAM
].join(",");

const INTEGRATION_TABLES: Record<string, { table: string, id: string, fk: string }> = {
  brevo: { table: "brevo_connexion", id: "brevo_connexion_id", fk: FK_BREVO },
  zoho: { table: "zoho_connexion", id: "zoho_connexion_id", fk: FK_ZOHO },
  openai: { table: "openai_connexion", id: "openai_connexion_id", fk: FK_OPENAI },
  linkedin: { table: "linkedin_connexion", id: "linkedin_connexion_id", fk: FK_LINKEDIN },
  facebook: { table: "facebook_connexion", id: "facebook_connexion_id", fk: FK_FACEBOOK },
  instagram:{ table: "instagram_connexion", id: "instagram_connexion_id", fk: FK_INSTAGRAM },
};

const GENERAL_FIELDS = [COL_NOM, COL_IDENTITE, COL_SIRET, COL_ADRESSE, COL_CP, COL_VILLE, COL_EMAIL, COL_TEL];

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return ok(null, 204);
  try {
    const body = await req.json().catch(() => ({}));
    const agenceId = body?.agence_id as string | undefined;
    const generalData = body?.generalData as Record<string, unknown> | undefined;
    const integrationKind = body?.integrationKind as string | undefined;
    const integrationData = body?.integrationData as Record<string, unknown> | undefined;
    if (!agenceId) return ok({ success: false, error: "bad_request_missing_agence_id" }, 400);

    let updatedAgence: any = null;
    let updatedIntegration: any = null;
    let message = "";

    // Patch général (strict aux colonnes prévues)
    if (generalData && typeof generalData === "object") {
      const filtered: Record<string, unknown> = {};
      for (const k of GENERAL_FIELDS) if (k in generalData) filtered[k] = (generalData as any)[k];
      if (Object.keys(filtered).length) {
        const { data, error } = await supabase
          .from(T_AGENCE).update(filtered).eq(PK, agenceId).select(PROJECTION_DETAIL).single();
        if (error) return ok({ success: false, error: "db_error_agence_update", details: error.message }, 500);
        updatedAgence = data;
        message = "Agence mise à jour";
      }
    }

    // Intégration
    if (integrationKind && integrationData && INTEGRATION_TABLES[integrationKind]) {
      const cfg = INTEGRATION_TABLES[integrationKind];
      const { data: agRow, error: e1 } = await supabase.from(T_AGENCE).select(`${ORG}, ${cfg.fk}`).eq(PK, agenceId).single();
      if (e1) return ok({ success: false, error: "db_error_fetch_agence_for_integration", details: e1.message }, 500);

      const currentId = agRow[cfg.fk];
      if (currentId) {
        const { data, error } = await supabase.from(cfg.table).update(integrationData).eq(cfg.id, currentId).select("*").single();
        if (error) return ok({ success: false, error: "db_error_integration_update", details: error.message }, 500);
        updatedIntegration = data;
        message += (message ? " + " : "") + `Intégration ${integrationKind} mise à jour`;
      } else {
        const { data, error } = await supabase.from(cfg.table)
          .insert({ ...integrationData, [ORG]: agRow[ORG], [PK]: agenceId })
          .select("*").single();
        if (error) return ok({ success: false, error: "db_error_integration_insert", details: error.message }, 500);
        const newId = data[cfg.id];
        const { error: linkErr } = await supabase.from(T_AGENCE).update({ [cfg.fk]: newId }).eq(PK, agenceId);
        if (linkErr) {
          await supabase.from(cfg.table).delete().eq(cfg.id, newId);
          return ok({ success: false, error: "db_error_integration_link", details: linkErr.message }, 500);
        }
        updatedIntegration = data;
        message += (message ? " + " : "") + `Intégration ${integrationKind} créée`;
      }
    }

    return ok({ success: true, data: { agence: updatedAgence, integration: updatedIntegration }, message: message || "OK" });
  } catch (e) {
    return ok({ success: false, error: "internal_error", details: String(e) }, 500);
  }
});


```
---
# TITRE 5. FICHIERS
## N.13 `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/1.FormAgenceIndependanteAccueil.tsx`
```typescript
import React, { useEffect } from "react";
import { useAgenceIndependanteFormData } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData";
import AgenceIndependanteSelector from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector";

export default function FormAgenceIndependanteAccueil() {
  const { agences, loadAgences, selectedAgenceId, setSelectedAgenceId } = useAgenceIndependanteFormData();

  useEffect(() => { loadAgences(); }, []);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-semibold">Agence Indépendante — Accueil</h1>

      <AgenceIndependanteSelector
        agences={agences}
        selectedAgenceId={selectedAgenceId}
        onChange={setSelectedAgenceId}
      />

      <div className="grid gap-3 sm:grid-cols-2">
        <a href="#/creation-agence-independante" className="btn btn-primary">Créer une agence</a>
        <a href="#/gestion-agence-independante" className="btn btn-secondary">Gérer une agence</a>
      </div>
    </div>
  );
}

```
---
## N.14 `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/2.FormAgenceIndependanteCreation.tsx`
```typescript
import React, { useState } from "react";
import { useAgenceIndependanteCreation } from "@/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/useAgenceIndependanteCreation";
import type { CreateAgenceIndependantePayload } from "@/components/HOOKS-STRATEGIQUE/5.HOOKS-CreationCompteAdminPresenca/6.AgenceIndependante/types";
import SuccessAccountInfo from "./SuccessAccountInfo";

export default function FormAgenceIndependanteCreation() {
  const [form, setForm] = useState<CreateAgenceIndependantePayload>({
    agence: {
      agence_independante_nom: "",
      agence_independante_siret: "",
      agence_independante_adresse: "",
      agence_independante_code_postal: "",
      agence_independante_ville: "",
      agence_independante_email: "",
      agence_independante_telephone: "",
      agence_independante_identite_commerciale: "",
    },
    responsable: { nom: "", prenom: "", email: "", telephone: "" },
  });
  const { create, loading, error, result } = useAgenceIndependanteCreation();

  const onChange = (section: "agence" | "responsable", key: string, value: string) => {
    setForm((prev) => ({ ...prev, [section]: { ...prev[section], [key]: value } }));
  };

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    await create(form);
  };

  if (result?.user) {
    return <SuccessAccountInfo userEmail={result.user.email} role="agence_independante_responsable" />;
  }

  return (
    <form onSubmit={onSubmit} className="space-y-6">
      <h1 className="text-2xl font-semibold">Créer une Agence Indépendante</h1>

      <fieldset className="space-y-4">
        <legend className="font-medium">Informations Agence</legend>
        <input className="input" placeholder="Nom de l’agence"
          value={form.agence.agence_independante_nom} onChange={(e) => onChange("agence", "agence_independante_nom", e.target.value)} />
        <input className="input" placeholder="SIRET"
          value={form.agence.agence_independante_siret} onChange={(e) => onChange("agence", "agence_independante_siret", e.target.value)} />
        <input className="input" placeholder="Adresse"
          value={form.agence.agence_independante_adresse} onChange={(e) => onChange("agence", "agence_independante_adresse", e.target.value)} />
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Code postal"
            value={form.agence.agence_independante_code_postal} onChange={(e) => onChange("agence", "agence_independante_code_postal", e.target.value)} />
          <input className="input" placeholder="Ville"
            value={form.agence.agence_independante_ville} onChange={(e) => onChange("agence", "agence_independante_ville", e.target.value)} />
        </div>
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Email agence"
            value={form.agence.agence_independante_email} onChange={(e) => onChange("agence", "agence_independante_email", e.target.value)} />
          <input className="input" placeholder="Téléphone agence"
            value={form.agence.agence_independante_telephone} onChange={(e) => onChange("agence", "agence_independante_telephone", e.target.value)} />
        </div>
        <input className="input" placeholder="Identité commerciale (optionnel)"
          value={form.agence.agence_independante_identite_commerciale ?? ""} onChange={(e) => onChange("agence", "agence_independante_identite_commerciale", e.target.value)} />
      </fieldset>

      <fieldset className="space-y-4">
        <legend className="font-medium">Responsable Agence</legend>
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Prénom" value={form.responsable.prenom} onChange={(e) => onChange("responsable", "prenom", e.target.value)} />
          <input className="input" placeholder="Nom" value={form.responsable.nom} onChange={(e) => onChange("responsable", "nom", e.target.value)} />
        </div>
        <div className="grid grid-cols-2 gap-3">
          <input className="input" placeholder="Email" value={form.responsable.email} onChange={(e) => onChange("responsable", "email", e.target.value)} />
          <input className="input" placeholder="Téléphone" value={form.responsable.telephone} onChange={(e) => onChange("responsable", "telephone", e.target.value)} />
        </div>
      </fieldset>

      {error && <p className="text-red-600 text-sm">{error}</p>}
      <button type="submit" className="btn btn-primary" disabled={loading}>
        {loading ? "Création..." : "Créer"}
      </button>
    </form>
  );
}

```
## N.15 `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/3.FormAgenceIndependanteGestion.tsx`
```typescript
import React, { useEffect, useState } from "react";
import { useAgenceIndependanteFormData } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteFormData";
import { useAgenceIndependanteIntegrations } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAgenceIndependanteIntegrations";
import { useAbonnementStripeView } from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/hooks/useAbonnementStripeView";
import AgenceIndependanteSelector from "@/components/HOOKS-STRATEGIQUE/6.HOOKS-GestionCompteAdminPresenca/6.AgenceIndependante/components/AgenceIndependanteSelector";

export default function FormAgenceIndependanteGestion() {
  const {
    agences, loadAgences, selectedAgenceId, setSelectedAgenceId,
    formData, loadAgenceData, saveGeneral, savingGeneral
  } = useAgenceIndependanteFormData();

  const { integrations, saveIntegration, savingIntegration } = useAgenceIndependanteIntegrations();
  const [activeTab, setActiveTab] = useState<"general" | "abonnement" | "integrations" | "fichiers">("general");

  useEffect(() => { loadAgences(); }, []);
  useEffect(() => { if (selectedAgenceId) loadAgenceData(selectedAgenceId); }, [selectedAgenceId]);

  const abonnement = useAbonnementStripeView(formData?.organisation_id ?? null);

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-semibold">Agence Indépendante — Gestion</h1>

      <AgenceIndependanteSelector
        agences={agences}
        selectedAgenceId={selectedAgenceId}
        onChange={setSelectedAgenceId}
      />

      <div className="flex gap-3 border-b">
        {["general","abonnement","integrations","fichiers"].map(tab => (
          <button key={tab} className={`px-3 py-2 ${activeTab === tab ? "border-b-2 font-medium" : ""}`} onClick={() => setActiveTab(tab as any)}>
            {tab === "general" ? "Général" : tab[0].toUpperCase() + tab.slice(1)}
          </button>
        ))}
      </div>

      {/* Onglet Général */}
      {activeTab === "general" && formData && (
        <section className="space-y-4">
          <div className="grid gap-3 sm:grid-cols-2">
            <label className="space-y-1">
              <span className="text-sm font-medium">Nom</span>
              <input className="input" value={formData.agence_independante_nom ?? ""}
                onChange={(e) => saveGeneral({ agence_independante_nom: e.target.value }, { debounce: true })} />
            </label>
            <label className="space-y-1">
              <span className="text-sm font-medium">Identité commerciale</span>
              <input className="input" value={formData.agence_independante_identite_commerciale ?? ""}
                onChange={(e) => saveGeneral({ agence_independante_identite_commerciale: e.target.value }, { debounce: true })} />
            </label>
          </div>
          <div className="grid gap-3 sm:grid-cols-3">
            <input className="input" placeholder="SIRET" value={formData.agence_independante_siret ?? ""}
              onChange={(e) => saveGeneral({ agence_independante_siret: e.target.value }, { debounce: true })} />
            <input className="input" placeholder="Code postal" value={formData.agence_independante_code_postal ?? ""}
              onChange={(e) => saveGeneral({ agence_independante_code_postal: e.target.value }, { debounce: true })} />
            <input className="input" placeholder="Ville" value={formData.agence_independante_ville ?? ""}
              onChange={(e) => saveGeneral({ agence_independante_ville: e.target.value }, { debounce: true })} />
          </div>
          <input className="input" placeholder="Adresse" value={formData.agence_independante_adresse ?? ""}
            onChange={(e) => saveGeneral({ agence_independante_adresse: e.target.value }, { debounce: true })} />
          <div className="grid gap-3 sm:grid-cols-2">
            <input className="input" placeholder="Email agence" value={formData.agence_independante_email ?? ""}
              onChange={(e) => saveGeneral({ agence_independante_email: e.target.value })} />
            <input className="input" placeholder="Téléphone agence" value={formData.agence_independante_telephone ?? ""}
              onChange={(e) => saveGeneral({ agence_independante_telephone: e.target.value })} />
          </div>
          {savingGeneral && <p className="text-sm text-muted-foreground">Enregistrement…</p>}
        </section>
      )}

      {/* Onglet Abonnement (lecture seule) */}
      {activeTab === "abonnement" && (
        <section className="space-y-4">
          <div className="grid gap-3 sm:grid-cols-2">
            <label className="space-y-1">
              <span className="text-sm font-medium">Plan d’abonnement</span>
              <input className="input" readOnly value={abonnement?.plan ?? "Aucun abonnement"} />
            </label>
            <label className="space-y-1">
              <span className="text-sm font-medium">Date de début</span>
              <input className="input" readOnly type="date" value={abonnement?.debut ?? ""} />
            </label>
          </div>
          <p className="text-xs text-muted-foreground">Module Stripe à venir (création / upgrade / résiliation).</p>
        </section>
      )}

      {/* Onglet Intégrations */}
      {activeTab === "integrations" && selectedAgenceId && (
        <section className="space-y-6">
          {(["brevo","zoho","openai","linkedin","facebook","instagram"] as const).map(kind => (
            <div key={kind} className="border rounded p-3 space-y-2">
              <h3 className="font-medium">Intégration {kind.toUpperCase()}</h3>
              <div className="grid gap-2 sm:grid-cols-2">
                <input className="input" placeholder={`${kind}_api_key`}
                  onChange={(e) => integrations.set(kind, { ...(integrations.get(kind) || {}), [`${kind}_api_key`]: e.target.value })} />
                <input className="input" placeholder={`${kind}_email_compte`}
                  onChange={(e) => integrations.set(kind, { ...(integrations.get(kind) || {}), [`${kind}_email_compte`]: e.target.value })} />
              </div>
              <button className="btn btn-primary" onClick={() => saveIntegration(selectedAgenceId, kind, integrations.get(kind) || {})} disabled={savingIntegration}>
                {savingIntegration ? "Enregistrement…" : "Enregistrer"}
              </button>
            </div>
          ))}
        </section>
      )}

      {/* Onglet Fichiers */}
      {activeTab === "fichiers" && selectedAgenceId && <FichiersPanel agenceId={selectedAgenceId} />}
    </div>
  );
}

function FichiersPanel({ agenceId }: { agenceId: string }) {
  const [logoFile, setLogoFile] = React.useState<File | null>(null);
  const [docFile, setDocFile] = React.useState<File | null>(null);
  const [msg, setMsg] = React.useState<string | null>(null);

  const upload = async (fileType: "logo" | "ressource", file: File | null) => {
    if (!file) return;
    setMsg(null);
    const fd = new FormData();
    fd.append("fileType", fileType);
    fd.append("agence_id", agenceId);
    fd.append("file", file);

    const res = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/gestion-agence-independante-admin-fichiers`, {
      method: "POST",
      body: fd,
      headers: { apikey: import.meta.env.VITE_SUPABASE_ANON_KEY },
    });
    const json = await res.json();
    if (json?.success) setMsg("Fichier chargé.");
    else setMsg(json?.error || "Erreur upload");
  };

  return (
    <section className="space-y-4">
      <div className="space-y-2">
        <label className="text-sm font-medium">Logo (1-logos)</label>
        <input type="file" onChange={(e) => setLogoFile(e.target.files?.[0] ?? null)} />
        <button className="btn btn-primary" onClick={() => upload("logo", logoFile)}>Uploader logo</button>
      </div>
      <div className="space-y-2">
        <label className="text-sm font-medium">Document (2-documents-institutionnels)</label>
        <input type="file" onChange={(e) => setDocFile(e.target.files?.[0] ?? null)} />
        <button className="btn btn-secondary" onClick={() => upload("ressource", docFile)}>Uploader document</button>
      </div>
      {msg && <p className="text-sm">{msg}</p>}
    </section>
  );
}

```
## N.16 `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/1-Formulaires/6.AgenceIndependante/SuccessAccountInfo.tsx`
```typescript
import React from "react";

export default function SuccessAccountInfo({ userEmail, role }: { userEmail: string; role: string }) {
  return (
    <div className="space-y-4">
      <h2 className="text-xl font-semibold">Compte créé avec succès</h2>
      <p className="text-sm text-muted-foreground">
        Un compte utilisateur a été créé pour <strong>{userEmail}</strong> avec le rôle <strong>{role}</strong>.
      </p>
      <p className="text-sm">
        L’utilisateur recevra un email d’activation / magic link pour finaliser son accès. Aucun mot de passe n’a été manipulé par l’admin.
      </p>
    </div>
  );
}

```
# TITRE 6. SQL
## N.17 `00_all_in_one_agence_independante`
```typescript
-- =========================================================
-- AGENCE INDEPENDANTE – STORAGE + POLICIES + TRIGGER + INDEX
-- Idempotent
-- =========================================================

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM storage.buckets WHERE id = 'bucket-table-agence-independante') THEN
    PERFORM storage.create_bucket('bucket-table-agence-independante', false);
  END IF;
END $$;

ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS ai_storage_select_authenticated ON storage.objects;
CREATE POLICY ai_storage_select_authenticated
ON storage.objects
FOR SELECT
TO authenticated
USING (bucket_id = 'bucket-table-agence-independante');

CREATE OR REPLACE FUNCTION public.sync_agence_indep_to_responsable()
RETURNS trigger AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    IF NEW.agence_independante_email IS DISTINCT FROM OLD.agence_independante_email THEN
      UPDATE public.agence_independante_responsable
      SET email = NEW.agence_independante_email
      WHERE agence_independante_id = NEW.agence_independante_id;
    END IF;
    IF NEW.agence_independante_telephone IS DISTINCT FROM OLD.agence_independante_telephone THEN
      UPDATE public.agence_independante_responsable
      SET telephone = NEW.agence_independante_telephone
      WHERE agence_independante_id = NEW.agence_independante_id;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_sync_agence_indep_to_resp ON public.agence_independante;
CREATE TRIGGER trg_sync_agence_indep_to_resp
AFTER UPDATE OF agence_independante_email, agence_independante_telephone ON public.agence_independante
FOR EACH ROW EXECUTE FUNCTION public.sync_agence_indep_to_responsable();

CREATE INDEX IF NOT EXISTS idx_agence_indep_org ON public.agence_independante(organisation_id);
CREATE INDEX IF NOT EXISTS idx_abonnement_stripe_org ON public.abonnement_stripe(organisation_id);

```
## N.18 `01_storage-bucket-agence-independante`
```typescript
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM storage.buckets WHERE id = 'bucket-table-agence-independante') THEN
    PERFORM storage.create_bucket('bucket-table-agence-independante', false);
  END IF;
END $$;

ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS ai_storage_select_authenticated ON storage.objects;
CREATE POLICY ai_storage_select_authenticated
ON storage.objects
FOR SELECT
TO authenticated
USING (bucket_id = 'bucket-table-agence-independante');

-- Ecriture/Suppression via SERVICE ROLE KEY (Edge Functions).

```
## N.19 `02_trigger-sync-agence-responsable`
```typescript
CREATE OR REPLACE FUNCTION public.sync_agence_indep_to_responsable()
RETURNS trigger AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    IF NEW.agence_independante_email IS DISTINCT FROM OLD.agence_independante_email THEN
      UPDATE public.agence_independante_responsable
      SET email = NEW.agence_independante_email
      WHERE agence_independante_id = NEW.agence_independante_id;
    END IF;
    IF NEW.agence_independante_telephone IS DISTINCT FROM OLD.agence_independante_telephone THEN
      UPDATE public.agence_independante_responsable
      SET telephone = NEW.agence_independante_telephone
      WHERE agence_independante_id = NEW.agence_independante_id;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_sync_agence_indep_to_resp ON public.agence_independante;

CREATE TRIGGER trg_sync_agence_indep_to_resp
AFTER UPDATE OF agence_independante_email, agence_independante_telephone ON public.agence_independante
FOR EACH ROW EXECUTE FUNCTION public.sync_agence_indep_to_responsable();

```
## N.20 `03_indexes-agence-independante`
```typescript
CREATE INDEX IF NOT EXISTS idx_agence_indep_org ON public.agence_independante(organisation_id);
CREATE INDEX IF NOT EXISTS idx_abonnement_stripe_org ON public.abonnement_stripe(organisation_id);


```
# TITRE 7. CONFIG TOML
## N.21 `supabase/config.toml`
```typescript
project_id = "ksymahfrtvhnbeobsspt"

[functions.notifier-nouvelle-demande]
verify_jwt = false

[functions.create-reseau-admin]
verify_jwt = false

[functions.gestion-reseau-admin]
verify_jwt = false

[functions.gestion-reseau-admin-donnees]
verify_jwt = false

[functions.gestion-reseau-admin-update]
verify_jwt = false

[functions.gestion-reseau-admin-fichiers]
verify_jwt = false

[functions.create-agence-independante-admin]
verify_jwt = false

[functions.gestion-agence-independante-admin]
verify_jwt = false

[functions.gestion-agence-independante-admin-donnees]
verify_jwt = false

[functions.gestion-agence-independante-admin-update]
verify_jwt = false

[functions.gestion-agence-independante-admin-fichiers]
verify_jwt = false
```


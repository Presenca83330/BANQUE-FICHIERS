# Stratégie Formulaire Gestion Réseau (Version Service Role Key)

## Sommaire
- [1. Sélecteur de Réseau](#1-sélecteur-de-réseau)
- [2. Onglet Général](#2-onglet-général)
- [3. Onglet Intégrations](#3-onglet-intégrations)
- [4. Onglet Fichiers](#4-onglet-fichiers)
- [5. Workflow Global](#5-workflow-global)
- [6. Clarifications Stratégiques](#6-clarifications-stratégiques)
  - [6.1 Réseau vs Organisation](#61-réseau-vs-organisation)
  - [6.2 Intégrations](#62-intégrations)
  - [6.3 Réseau vs RéseauDirection](#63-réseau-vs-réseaudirection)
  - [6.4 Risques Multi-tenant](#64-risques-multi-tenant)
  - [6.5 Synchronisation Création → Gestion](#65-synchronisation-création--gestion)
- [7. Service Role Key & Hooks](#7-service-role-key--hooks)
  - [7.1 Service Role Key](#71-service-role-key)
  - [7.2 Hooks Frontend](#72-hooks-frontend)
  - [7.3 Pourquoi Service Role Key ?](#73-pourquoi-service-role-key-)
  - [7.4 Config supabase/config.toml](#74-config-supabaseconfigtoml)
  - [7.5 Contrôles obligatoires dans chaque Edge Function](#75-contrôles-obligatoires-dans-chaque-edge-function)
  - [7.6 Hooks Frontend adaptés](#76-hooks-frontend-adaptés)
  - [7.7 Risques & Points de vigilance](#77-risques--points-de-vigilance)
---

## 1. Sélecteur de Réseau
- Permet à admin_presenca et son formulaire de gestion de sélectionner le réseau à modifier : (reseau_id, reseau_nom)
- Précision ces réseaux sont déjà créés, il n'y aucun process de créattion. Ce process de création est assuré par FomrReseauCreation qui fonctionne parfaitementt
- Source de données : Table reseau
-   Composant : ReseauSelector

Workflow :
- Dropdown affiche tous les réseaux.
- Après la sélection → chargement automatique des données associées depuis Supabase :
  - Table reseau (infos générales + FK connexions) → voir ci-dessous dans 2.Onglet Général
  - Tables connexions (brevo_connexion, zoho_connexion, openai_connexion) → voir ci-dessous dans 3.Onglet Intégrations
  - Storage (logos, documents) → voir ci-dessous dans 4.Onglet Fichiers
  -   bucket-table-reseau pour logos/documents

Sécurité :

- Lecture via Edge Function
- Authentification via ServiceRoleKey.
- verify_jwt = false (accès uniquement via Edge).
---

## 2. Onglet Général
Champs éditables
- Nom du Réseau (reseau_nom)
- Identité Commerciale (reseau_identite_commerciale)
- Adresse (reseau_adresse)
- Code Postal (reseau_code_postal)
- Ville (reseau_ville)
- Siret (reseau_siret)
- Téléphone Direction (reseau_telephone)
- Email Direction (reseau_email)

Workflow
- Mode lecture seule par défaut.
- Bouton Modifier → active les champs.
- Sauvegarde via Edge Function
- Attention : Synchronisation automatique vers reseau_direction (téléphone/email).
---

## 3. Onglet Intégrations
Champs éditables
- Sert uniquement à mémoriser les données informatives des plateformes Brevo, Zoho, OpenAI
- Intégration Brevo (Clé API, Email Compte)
- Intégration Zoho (Clé API, Nom Compte, Email Compte)
- Intégration OpenAI (Clé API, Email Compte)

Workflow
- Injection des données existantes depuis les tables de connexion
- Si déjà une information → UPDATE en cas de correction et/ou mise àjour).
- Si aucune information → INSERT + mise à jour FK dans reseau.
- Informations purement administratives : pas de tests API, pas de connexions externes.
  - brevo_connexion → FK reseau_brevo_connexion_id
  - zoho_connexion → FK reseau_zoho_connexion_id
  - openai_connexion → FK reseau_openai_connexion_id
---

## 4. Onglet Fichiers

### Architecture Storage (bucket unique multi-tenant)

```
bucket-table-reseau/
└── reseau-{uuid}/                    ← UUID = reseau_id exact
    ├── 1-logos/                      ← Dossier logos
    │   ├── logo-principal.png
    │   └── logo-alternatif.png
    ├── 2-documents-institutionnels/  ← Dossier documents
    │   ├── presentation.pdf
    │   ├── reglement.pdf
    │   └── statuts.pdf
    └── 3-charte-graphique/           ← Extensible futur
        └── charte-couleurs.pdf
```

### Mapping des données

Table reseau :
- reseau_logo → chemin unique vers le logo principal (dans 1-logos/).
- reseau_ressources → tableau des chemins des documents institutionnels (dans 2-documents-institutionnels/).

Bucket Supabase : bucket-table-reseau
- Isolation stricte par dossier reseau-{uuid} (chaque réseau a son espace).
- Les sous-dossiers organisent les fichiers par type (1-logos, 2-documents-institutionnels, 3-charte-graphique).

### Fonctionnalités utilisateur
Logo du Réseau
- Afficher le logo actuel (si existant).
- Upload d’un nouveau logo → sauvegarde dans 1-logos/.
- Supprimer le logo → suppression via Edge Function et mise à jour de reseau_logo.

Documents Institutionnels
- Lister les documents existants (table reseau_ressources).
- Upload de nouveaux fichiers → ajout dans 2-documents-institutionnels/.
- Supprimer un document → suppression via Edge Function + retrait du tableau reseau_ressources.

Charte Graphique (extensible futur)
- Prévu pour accueillir les fichiers de charte graphique dans 3-charte-graphique/.
- Même logique : upload, affichage, suppression sécurisée.

### Sécurité & Service Role Key
Isolation stricte :
- Aucune Policies RLS appliquées directement sur storage.objects
- Toutes les opérations (upload, suppression, mise à jour DB) passent par des Edge Functions exécutées avec le SUPABASE_SERVICE_ROLE_KEY.

Ces Edge Functions centralisent la logique et garantissent :
- Validation du reseauId transmis.
- Vérification des droits (admin_presenca : Admin Presenca : accès global à tous les dossiers/fichiers via les fonctions.
- Cohérence multi-tenant (chaque réseau reste isolé).
- Centralisent la logique pour cohérence, logs et audit.
---

## 5. Workflow Global
- Admin PRESENCA ouvre le formulaire.
- Sélectionne un réseau → données chargées automatiquement.
- Lecture seule par défaut.
- Bouton Modifier → active édition.
- Sauvegarde via Edge Functions :
  - gestion-reseau-admin-update → données générales + intégrations.
  - gestion-reseau-admin-fichiers → fichiers (upload/delete).
- Retour lecture seule après succès.
---

## 6. Clarifications Stratégiques

### 6.1 Réseau vs Organisation
- Ce formulaire est exclusivement dédié à la gestion des Réseaux existants.
- Organisation : déjà créée en amont, non gérée ici.
- Réseau : on sélectionne un réseau existant, on affiche et on modifie ses données.
- Donc aucune logique de création d’organisation ou d’utilisateur n’est concernée.
- Le formulaire agit uniquement en UPDATE sur le réseau choisi.
---
### 6.2 Intégrations
- Les champs Intégrations (clé, email, nom de compte) servent uniquement à historiser et mémoriser les infos saisies par l’admin.
- Pas de test de validité.
- Pas d’appel externe aux API.
- Pas de logique de connexion automatique.
- L’onglet “Intégrations” est un espace mémoire facultatif.
- Un réseau peut avoir zéro, une ou plusieurs infos d’Intégration, mais leur présence ou absence n’impacte pas le fonctionnement du reste du système..
---
### 6.3 Réseau vs RéseauDirection
Réseau = stocke les informations générales (nom du réseau, identité commerciale du réseau, adresse, ville, siret, téléphone, email).
- Point de vérité unique pour l’email et le téléphone (coordonnées Direction).

RéseauDirection = utilisateur directeur du réseau (lié à Auth), qui hérite des coordonnées renseignées dans reseau.
- Dans le formulaire Gestion Réseau :
- Les champs Email / Téléphone sont éditables (dans reseau) et synchronisés automatiquement avec reseau_direction.
- Dans un futur formulaire RéseauDirection → ces champs seront lecture seule pour éviter les incohérences.
---
### 6.4 Architecture du Bucket de stockage
Le projet adopte un **bucket unique multi-tenant** : `bucket-table-reseau`.  
- Isolation stricte par dossier nommé `reseau-{uuid}`.
-   Chaque sous-dossier correspond à un type de ressource :  
---
### 5. Question des risques 
- On ne peut pas avoir plusieurs réseaux pour une organisation.
- Le réseau est la tête de pont.
- Comme il s agit d un formulaire de gestion, on peut faire des modification et pas de création.
- Si on sélectionne un réseau dans le sélecteur un réseau, il ne peut y en avoir plusieurs qui soient chargés.
- Le formulaire de gestion injecte les données actuelles présentes dans supabase et admin_presenca est le seul à utiliser ce formulaire de gestion. Il peut rajouter des informations ou les modifier si elles ne sont plus à jour.
---
### 6. Rappel : Ce qui se passe quand on crée un réseau avec Email Direction et Téléphone Direction dans le formulaire creation
Formulaire de création :
- L’admin admin_presenca saisit les informations dans le formulaire de création (nom réseau, adresse, siret, etc.) ainsi que :
  - Téléphone Direction
  - Email Direction

Tables concernées lors de l’insertion du téléphone et de l'email :
- Ces deux champs sont insérés dans la table reseau en tant que :
  - reseau_telephone
  - reseau_email
- Ils sont ensuite synchronisés automatiquement dans la table reseau_direction pour que l’utilisateur directeur ait les mêmes coordonnées.
  - reseau_direction_telephone
  - reseau_direction_email

IDs impliqués dans l’opération : 
- reseau_id (clé primaire du réseau) → utilisé pour créer le réseau et comme pivot de toutes les relations.
- organisation_id (FK dans reseau) → rattache le réseau à l’organisation déjà existante.
- reseau_direction_id (FK lié à l’utilisateur directeur) → utilisé pour propager l’email et téléphone dans la table reseau_direction.

Donc :
- Point de vérité : reseau.reseau_telephone et reseau.reseau_email.
- Synchronisation automatique → reseau_direction.reseau_direction_telephone et reseau_direction.reseau_direction_email.
- IDs pivots utilisés : reseau_id (principal), organisation_id (lien organisation), reseau_direction_id (synchronisation).
---

## 7. Service Role Key & Hooks

### 7.1 Service Role Key
- Toutes les Edge Functions utilisent SUPABASE_SERVICE_ROLE_KEY.
- verify_jwt = false (dans supabase/config.toml).
- Avec SERVICE_ROLE_KEY, toutes les RLS (Row Level Security) sont contournées.
  - Ajouter des vérifications manuelles dans chaque Edge Function
  - Pour éviter toute fuite ou modification d’un autre réseau non sélectionné par erreur.
  - Vérifier que le reseau_id transmis existe bien dans la table reseau.
  - Vérifier que ce reseau_id est rattaché à l’organisation_id attendu (cohérence multi-tenant).
  - Vérifier que l’appelant est bien admin_presenca (ou possède un droit équivalent) avant d’autoriser la modification.
  - Ces contrôles doivent s’exécuter côté serveur dans les Edge Functions (avant tout UPDATE/INSERT/DELETE)
  - puisque la SERVICE_ROLE_KEY bypass la sécurité applicative.
---
### 7.2 Hooks Frontend
- useReseauFormData → infos générales.
- useReseauIntegrations → Brevo, Zoho, OpenAI.
  - Les deux passent par Edge Functions.
  - Les setters mettent à jour l’UI immédiatement.
---
### 7.3 Pourquoi Service Role Key ?
En gestion réseau, l’admin PRESENCA doit pouvoir :
- Lire/écrire tous les réseaux.
- Modifier logos & documents sans restrictions.
Solution = tout passer par des Edge Functions exécutées avec SUPABASE_SERVICE_ROLE_KEY.
Conséquence → seules les Edge Functions manipulent la DB.
---
### 7.4 Config supabase/config.toml
- Chaque fonction doit déclarer explicitement
---
### 7.5 Contrôles obligatoires dans chaque Edge Function
- Vérifier que l’appelant est bien admin_presenca.
- Vérifier que reseau_id existe.
- Vérifier que organisation_id correspond bien au réseau.
---


# üìã CHECKLIST BIBLE - Formulaires Cr√©ation Admin PRESENCA

## üéØ Objectif
Cette checklist est la **BIBLE ABSOLUE** pour √©viter toute erreur lors de la cr√©ation de nouveaux formulaires de cr√©ation. Elle d√©taille point par point tous les √©l√©ments n√©cessaires.

---

## üìä TABLEAU R√âCAPITULATIF COMPLET

| **√âL√âMENT** | **EXPLICATION** | **FORMULAIRE CR√âATION** (ex: Cr√©ation R√©seau) | **FORMULAIRE GESTION** |
|-------------|-----------------|-----------------------------------------------|------------------------|
| **Composant Principal** | Interface utilisateur du formulaire | `FormReseauCreation.tsx` - Interface compl√®te avec validation client, √©tats loading/error, affichage succ√®s | |
| **Composant Succ√®s** | Affichage apr√®s cr√©ation r√©ussie | `SuccessAccountInfo.tsx` - Affiche email + mot de passe temporaire avec boutons copier/masquer | |
| **Hook M√©tier** | Logique m√©tier de cr√©ation | `useReseauCreation.ts` - createReseau() avec gestion data.data.tempPassword | |
| **Types TypeScript** | Interfaces de donn√©es | `types.ts` - ReseauCreationData + ReseauCreationResult + ReseauValidationErrors | |
| **Edge Function Principale** | API backend de cr√©ation | `create-reseau-admin/index.ts` - verify_jwt=false + SERVICE_ROLE_KEY + auth.admin.createUser() + tempPassword + Rollback auth si erreur | |
| **Fonction SQL Principale** | Logique base de donn√©es | `create_reseau_compte_complet()` - SECURITY DEFINER - Cr√©ation compl√®te (organisations, users, utilisateurs, reseau, direction) | |
| **Table organisations** | Entit√© principale organisation | CR√âATION OBLIGATOIRE (INSERT) - nom, adresse, siret, email, t√©l√©phone, statut actif | |
| **Table users** | Profil syst√®me utilisateur | CR√âATION OBLIGATOIRE (INSERT) - users_auth_id, users_role_systeme = NULL, users_organisation_id | |
| **Table utilisateurs** | Profil m√©tier utilisateur | CR√âATION OBLIGATOIRE (INSERT) - utilisateur_type_compte = 'reseau', utilisateur_auth_uid | |
| **Table reseau** | Entit√© business r√©seau | CR√âATION OBLIGATOIRE (INSERT) - Source v√©rit√© email/t√©l√©phone, client_type = 'reseau', liens FK connexions | |
| **Table reseau_direction** | Direction du r√©seau | CR√âATION OBLIGATOIRE (INSERT) - Sync auto email/t√©l√©phone depuis reseau | |
| **Tables connexions** | Int√©grations externes | NON CR√â√âES - Liens FK = NULL (cr√©√©es plus tard en gestion) | |
| **FK Organisation** | Relations organisation | users.users_organisation_id ‚Üí organisations.organisation_id | |
| **FK R√©seau** | Relations r√©seau | reseau_direction.reseau_id ‚Üí reseau.reseau_id | |
| **FK Connexions** | Relations int√©grations | NULL au d√©but (mis √† jour en gestion) | |
| **Triggers Audit** | Gestion timestamps automatique | set_created_audit_fields_reseau() + update_audit_fields_reseau() | |
| **Trigger Synchronisation** | Sync reseau ‚Üí direction | AUTOMATIQUE - sync email/t√©l√©phone reseau ‚Üí direction | |
| **config.toml** | Configuration edge functions | `[functions.create-reseau-admin]` verify_jwt = false | |
| **cors.ts** | S√©curit√© CORS | allowedOrigins + 'Access-Control-Allow-Methods': 'POST, OPTIONS' | |
| **Authentification** | Gestion auth Supabase | SERVICE_ROLE_KEY OBLIGATOIRE - Cr√©ation auth.users + Rollback si erreur | |
| **Validation** | Contr√¥les de donn√©es | DOUBLE (Client UX + Serveur s√©curit√©) | |
| **Logs S√©curit√©** | Journalisation | ‚úÖ email + reseau ‚ùå PAS de password dans logs | |
| **Bucket Storage** | Stockage fichiers | NON UTILIS√â (pas de fichiers √† la cr√©ation) | |
| **Politiques RLS Storage** | S√©curit√© fichiers | NON APPLICABLES | |
| **Syst√®me data.data** | Pattern retour donn√©es | Edge Function: `{success, tempPassword, data: sqlResult}` - Hook: `data.data.organisationId` + `data.tempPassword` | |
| **Cr√©ation Auth** | Compte utilisateur Supabase | ‚úÖ OBLIGATOIRE - auth.admin.createUser() + tempPassword + Affichage infos connexion | |
| **V√©rification Admin** | Contr√¥le droits admin | CLIENT-SIDE (admin_presenca peut cr√©er) | |
| **Tables Impact√©es** | Tables modifi√©es | 5 TABLES CR√â√âES (organisations, users, utilisateurs, reseau, reseau_direction) | |

---

## üìù D√âTAILS PAR CAT√âGORIE - FORMULAIRE CR√âATION

### üé® **COMPOSANTS REACT**

#### **Composant Principal** : `FormReseauCreation.tsx`
- Interface utilisateur compl√®te de cr√©ation
- Validation c√¥t√© client en temps r√©el
- Gestion √©tats loading/error/success
- Affichage succ√®s avec informations de connexion

#### **Composant Succ√®s** : `SuccessAccountInfo.tsx`
- Affichage email + mot de passe temporaire
- Boutons copier/masquer le mot de passe
- Instructions pour la premi√®re connexion
- Design s√©curis√© et ergonomique

#### **Composants UI Utilis√©s**
- Input avec validation
- Label avec ast√©risques pour champs obligatoires
- Button avec √©tat loading
- Card avec header/content
- Toast pour les erreurs

---

### üîß **HOOKS REACT**

#### **Hook M√©tier** : `useReseauCreation.ts`
- √âtat `isLoading` pour l'interface
- √âtat `error` pour les erreurs
- Fonction `createReseau(formData)`
- Retour `ReseauCreationResult`
- **CRITIQUE** : Gestion `data.data.tempPassword`

**Exemple d'acc√®s aux donn√©es** :
```typescript
const result: ReseauCreationResult = {
  organisationId: data.data.organisationId,
  reseauId: data.data.reseauId,
  userId: data.data.userId,
  tempPassword: data.tempPassword  // Niveau racine !
};
```

---

### üìù **TYPES TYPESCRIPT**

#### **Fichier** : `types.ts`

**ReseauCreationData** : Donn√©es du formulaire
- nomReseau: string
- adresse: string
- codePostal: string
- ville: string
- pays: string
- siret: string
- emailResponsable: string
- telephoneResponsable: string

**ReseauValidationErrors** : Erreurs de validation
- Tous les champs optionnels
- Messages d'erreur sp√©cifiques

**ReseauCreationResult** : R√©sultat de cr√©ation
- organisationId: string
- reseauId: string
- userId: string
- utilisateurId: string
- directionId: string
- email: string
- tempPassword: string

---

### ‚ö° **EDGE FUNCTION**

#### **Fonction** : `create-reseau-admin/index.ts`

**Configuration CRITIQUE** :
- `verify_jwt = false` dans config.toml
- Utilisation SERVICE_ROLE_KEY (pas ANON_KEY)
- CORS configuration stricte

**√âtapes d'ex√©cution** :
1. Validation des donn√©es re√ßues
2. G√©n√©ration du mot de passe temporaire
3. **Cr√©ation auth.users** avec auth.admin.createUser()
4. Appel fonction SQL create_reseau_compte_complet()
5. **Rollback auth si erreur SQL**
6. Retour structure data.data

**Structure de retour** :
```typescript
{
  success: true,
  tempPassword: "mot_de_passe_g√©n√©r√©",  // Niveau racine
  data: {                                 // data.data = r√©sultat SQL
    organisationId: "uuid",
    reseauId: "uuid",
    userId: "uuid",
    utilisateurId: "uuid",
    directionId: "uuid"
  },
  message: "Cr√©ation r√©ussie"
}
```

---

### üóÉÔ∏è **FONCTION SQL**

#### **Fonction** : `create_reseau_compte_complet()`

**D√©claration** :
```sql
CREATE FUNCTION create_reseau_compte_complet(
  p_nom_reseau text,
  p_adresse text,
  p_code_postal text,
  p_ville text,
  p_pays text,
  p_siret text,
  p_email_responsable text,
  p_telephone_responsable text,
  p_auth_uid uuid
)
RETURNS jsonb
SECURITY DEFINER
SET search_path = public
LANGUAGE plpgsql
```

**√âtapes d'ex√©cution** :
1. **Organisation** : INSERT dans organisations
2. **Users** : INSERT dans users (users_role_systeme = NULL)
3. **Utilisateurs** : INSERT dans utilisateurs (type = 'reseau')
4. **R√©seau** : INSERT dans reseau (source v√©rit√© coordonn√©es)
5. **Direction** : INSERT dans reseau_direction (sync depuis reseau)

**Retour** :
```sql
RETURN jsonb_build_object(
  'organisationId', v_organisation_id,
  'reseauId', v_reseau_id,
  'userId', v_user_id,
  'utilisateurId', v_utilisateur_id,
  'directionId', v_direction_id
);
```

---

### üèóÔ∏è **TABLES DATABASE**

#### **Table organisations**
- **Action** : CR√âATION OBLIGATOIRE (INSERT)
- **Colonnes** : nom, adresse, code_postal, ville, pays, siret, email, telephone
- **Statut** : actif par d√©faut
- **Role** : Entit√© principale organisation

#### **Table users**
- **Action** : CR√âATION OBLIGATOIRE (INSERT)
- **Colonnes cl√©s** :
  - users_auth_id = auth.users.id
  - users_role_systeme = NULL (pas admin global)
  - users_organisation_id = FK vers organisations
- **Role** : Profil syst√®me utilisateur

#### **Table utilisateurs**
- **Action** : CR√âATION OBLIGATOIRE (INSERT)
- **Colonnes cl√©s** :
  - utilisateur_type_compte = 'reseau'
  - utilisateur_auth_uid = auth.users.id
  - utilisateur_organisation_id = FK vers organisations
- **Role** : Profil m√©tier utilisateur

#### **Table reseau**
- **Action** : CR√âATION OBLIGATOIRE (INSERT)
- **Colonnes cl√©s** :
  - reseau_email/telephone = SOURCE V√âRIT√â
  - client_type = 'reseau'
  - reseau_brevo_connexion_id = NULL
  - reseau_zoho_connexion_id = NULL
  - reseau_openai_connexion_id = NULL
- **Role** : Entit√© business r√©seau

#### **Table reseau_direction**
- **Action** : CR√âATION OBLIGATOIRE (INSERT)
- **Colonnes cl√©s** :
  - reseau_id = FK vers reseau
  - reseau_direction_utilisateur_id = FK vers users
  - email/t√©l√©phone synchronis√©s depuis reseau
- **Role** : Direction du r√©seau

#### **Tables connexions** (brevo_connexion, zoho_connexion, etc.)
- **Action** : NON CR√â√âES
- **FK dans reseau** : NULL
- **R√¥le** : Cr√©√©es plus tard en gestion

---

### üîó **FOREIGN KEYS**

#### **FK Organisation**
- users.users_organisation_id ‚Üí organisations.organisation_id
- reseau.organisation_id ‚Üí organisations.organisation_id
- utilisateurs.utilisateur_organisation_id ‚Üí organisations.organisation_id

#### **FK R√©seau**
- reseau_direction.reseau_id ‚Üí reseau.reseau_id
- reseau_direction.reseau_direction_utilisateur_id ‚Üí users.users_id

#### **FK Connexions**
- reseau.reseau_brevo_connexion_id ‚Üí NULL (au d√©but)
- reseau.reseau_zoho_connexion_id ‚Üí NULL (au d√©but)
- reseau.reseau_openai_connexion_id ‚Üí NULL (au d√©but)

---

### ‚öôÔ∏è **TRIGGERS**

#### **Triggers Audit**
```sql
-- Auto-cr√©ation timestamps
CREATE TRIGGER set_created_audit_fields_reseau
  BEFORE INSERT ON reseau
  FOR EACH ROW
  EXECUTE FUNCTION set_created_audit_fields_reseau();

-- Auto-update timestamps
CREATE TRIGGER update_audit_fields_reseau
  BEFORE UPDATE ON reseau
  FOR EACH ROW
  EXECUTE FUNCTION update_audit_fields_reseau();
```

#### **Trigger Synchronisation reseau ‚Üí direction**
```sql
CREATE TRIGGER sync_reseau_to_direction
  AFTER UPDATE ON reseau
  FOR EACH ROW
  EXECUTE FUNCTION sync_reseau_to_direction();
```
- Synchronise automatiquement email/t√©l√©phone
- De reseau vers reseau_direction
- D√©clench√© √† chaque UPDATE

---

### üîß **CONFIGURATION**

#### **config.toml**
```toml
project_id = "ksymahfrtvhnbeobsspt"

[functions.create-reseau-admin]
verify_jwt = false
```

**CRITIQUE** : verify_jwt = false permet l'utilisation de SERVICE_ROLE_KEY

#### **cors.ts**
```typescript
const allowedOrigins = [
  'https://leadgenai-adbuilder.com',
  'https://appli-v7-leadgenai.lovable.app',
  /^https:\/\/.*\.lovable\.app$/,
  /^https:\/\/.*\.lovableproject\.com$/,
];

const corsHeaders = {
  'Access-Control-Allow-Origin': origin,
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};
```

---

### üîí **S√âCURIT√â**

#### **Authentification**
- **SERVICE_ROLE_KEY OBLIGATOIRE**
- Bypass RLS pour cr√©er dans toutes les tables
- Cr√©ation auth.users avec auth.admin.createUser()
- Appel fonctions SECURITY DEFINER
- **Rollback auth si erreur SQL**

#### **Validation**
- **Client** : UX + pr√©vention erreurs utilisateur
- **Serveur** : S√©curit√© + conformit√© donn√©es
- Types TypeScript stricts

#### **Logs S√©curit√©**
```typescript
// ‚úÖ S√âCURIS√â
console.log('üìã Cr√©ation r√©seau:', {
  email: body.emailResponsable,
  reseau: body.nomReseau
});

// ‚ùå INTERDIT
// console.log('Password:', tempPassword);
```

**R√àGLE D'OR** : Jamais de mot de passe dans les logs

---

### üìÅ **STORAGE**

#### **Bucket Storage**
- **NON UTILIS√â** lors de la cr√©ation
- Pas de fichiers √† uploader
- Cr√©√© plus tard en gestion

#### **Politiques RLS**
- **NON APPLICABLES**
- SERVICE_ROLE_KEY bypass RLS

---

### üîÑ **SYST√àME DATA.DATA**

#### **Pattern Obligatoire**

**Edge Function DOIT retourner** :
```typescript
return new Response(JSON.stringify({
  success: true,
  tempPassword: generatedPassword,  // Niveau racine !
  data: sqlResult,                   // data.data = r√©sultat SQL
  message: 'R√©seau cr√©√© avec succ√®s'
}));
```

**Hook DOIT acc√©der** :
```typescript
const result: ReseauCreationResult = {
  organisationId: data.data.organisationId,
  reseauId: data.data.reseauId,
  userId: data.data.userId,
  utilisateurId: data.data.utilisateurId,
  directionId: data.data.directionId,
  email: formData.emailResponsable,
  tempPassword: data.tempPassword  // Niveau racine !
};
```

**CRITIQUE** : Ne pas confondre data.tempPassword et data.data.xxx

---

### üéØ **SP√âCIFICIT√âS CR√âATION**

#### **Cr√©ation Auth OBLIGATOIRE**
```typescript
const { data: authData, error: authError } = 
  await supabaseAdmin.auth.admin.createUser({
    email: body.emailResponsable,
    password: tempPassword,
    email_confirm: true
  });
```

- G√©n√©ration tempPassword automatique
- Affichage des informations de connexion
- Rollback si erreur SQL

#### **V√©rification Admin**
- **CLIENT-SIDE uniquement**
- Admin_presenca peut cr√©er des comptes
- V√©rification dans l'interface Lovable

#### **Tables Impact√©es**
**5 TABLES CR√â√âES** :
1. organisations (INSERT)
2. users (INSERT)
3. utilisateurs (INSERT)
4. reseau (INSERT)
5. reseau_direction (INSERT)

**Toutes les relations cr√©√©es** en une seule transaction

---

## üö® **ERREURS FATALES √Ä √âVITER**

### ‚ùå **Erreurs Syst√®me data.data**
- Hook acc√®de directement √† `data` au lieu de `data.data`
- Edge Function retourne donn√©es sans wrapper `data`
- M√©lange `tempPassword` niveau racine vs `data.data`

### ‚ùå **Erreurs S√©curit√© SERVICE_ROLE_KEY**
- Oubli `verify_jwt = false` dans config.toml
- Utilisation ANON_KEY au lieu de SERVICE_ROLE_KEY
- Pas de rollback auth en cas d'erreur SQL

### ‚ùå **Erreurs Base de Donn√©es**
- Cr√©ation auth sans rollback si erreur SQL
- Synchronisation manuelle au lieu de triggers
- Oubli d'une des 5 tables obligatoires

### ‚ùå **Erreurs Types TypeScript**
- Interfaces incompl√®tes ou incoh√©rentes
- Pas de validation des types c√¥t√© serveur
- Types non export√©s/import√©s

---

## ‚úÖ **CHECKLIST VALIDATION FINALE**

### üîç **Avant D√©ploiement**
- [ ] Types TypeScript coh√©rents et complets
- [ ] Hook test√© avec data.data pattern
- [ ] Edge Function avec SERVICE_ROLE_KEY
- [ ] config.toml avec verify_jwt = false
- [ ] Fonction SQL SECURITY DEFINER test√©e
- [ ] Triggers audit en place
- [ ] Trigger sync reseau‚Üídirection actif
- [ ] Validation double client/serveur
- [ ] Logs s√©curis√©s (pas de password)
- [ ] CORS restrictif configur√©
- [ ] Test cr√©ation compl√®te
- [ ] Test rollback auth en cas d'erreur
- [ ] V√©rification 5 tables cr√©√©es
- [ ] V√©rification toutes FK cr√©√©es

### üéØ **Post D√©ploiement**
- [ ] Monitoring logs Edge Function
- [ ] V√©rification audit trails automatiques
- [ ] Test connexion avec tempPassword
- [ ] Validation synchronisation reseau‚Üídirection
- [ ] Test s√©curit√© non-admin (doit refuser)

---

## üìñ **DOCUMENTATION ASSOCI√âE**

1. **Guide data.data** : `7.GUIDE-DataData-EdgeFunctions.md`
2. **Architecture SERVICE_ROLE_KEY** : `6.Architecture-SERVICE_ROLE_KEY-GUIDE.md`
3. **Structure Cr√©ation** : `2.StructuredesFormCreationReseau.md`
4. **Analyse Fonctionnement** : `4.Analyse du Fonctionnement Formulaire Cr√©ation R√©seau.md`
5. **Analyse Edge Function** : `5.AnalyseEdgeFunctionSERVICE_ROLE_KEY.md`

---

## üéØ **CONCLUSION**

Cette checklist est la **R√âF√âRENCE ABSOLUE** pour tous les formulaires de cr√©ation. Chaque √©l√©ment doit √™tre v√©rifi√© et valid√©. Aucune exception n'est tol√©r√©e pour garantir la coh√©rence, s√©curit√© et fiabilit√© du syst√®me Admin PRESENCA.

**R√àGLE D'OR** : Si un √©l√©ment n'est pas dans cette checklist, il NE DOIT PAS √™tre impl√©ment√© sans mise √† jour pr√©alable de cette documentation.

# ğŸ“¦ Guide Complet : SystÃ¨me `data.data` avec Edge Functions

## ğŸ¯ Ã€ quoi sert ce systÃ¨me `data.data` ?

**C'est comme un double emballage de colis postal :**

### 1ï¸âƒ£ **Premier emballage : Edge Function** (L'expÃ©diteur)

Quand ton Edge Function crÃ©e/modifie un rÃ©seau, elle prÃ©pare un colis avec :

**ğŸ“¦ BOÃTE PRINCIPALE appelÃ©e `data`** contenant :
- L'ID de l'organisation crÃ©Ã©e
- L'ID du rÃ©seau crÃ©Ã©
- L'ID de l'utilisateur crÃ©Ã©
- L'ID de la direction crÃ©Ã©e
- Tous les IDs importants

**ğŸ“ Ã‰TIQUETTES Ã  cÃ´tÃ© de la boÃ®te** :
- `success: true`
- `tempPassword: "xxx"`
- `message: "..."`

**Code Edge Function :**
```typescript
// ğŸ­ L'Edge Function emballe le colis
return new Response(JSON.stringify({
  success: true,              // â† Ã‰tiquette
  data: {                     // â† BoÃ®te principale
    organisationId: "abc",
    reseauId: "def",
    userId: "ghi"
  },
  tempPassword: "xxx",        // â† Ã‰tiquette
  message: "SuccÃ¨s"           // â† Ã‰tiquette
}))
```

---

### 2ï¸âƒ£ **DeuxiÃ¨me emballage : Supabase SDK** (La Poste)

Quand Supabase livre ce colis au frontend, **il l'emballe ENCORE UNE FOIS** dans une nouvelle enveloppe standardisÃ©e appelÃ©e aussi `data` :

**ğŸ“¦ ENVELOPPE SUPABASE** contenant :
- âœ… `data` : Tout le contenu du colis de l'Edge Function
- âš ï¸ `error` : null ou message d'erreur
- ğŸ“Š MÃ©tadonnÃ©es techniques (status, headers, etc.)

**RÃ©sultat au Frontend :**
```typescript
// ğŸ“¬ Le frontend reÃ§oit une enveloppe Supabase
const { data, error } = await supabase.functions.invoke('create-reseau-admin', {
  body: formData
});

// Structure reÃ§ue :
{
  data: {                           // â† ENVELOPPE Supabase (niveau 1)
    success: true,                  // â† Ã‰tiquette Edge Function
    data: {                         // â† BOÃTE Edge Function (niveau 2)
      organisationId: "abc",
      reseauId: "def",
      userId: "ghi"
    },
    tempPassword: "xxx",            // â† Ã‰tiquette Edge Function
    message: "SuccÃ¨s"
  },
  error: null                       // â† Statut Supabase
}
```

---

## âš ï¸ **Pourquoi il DOIT Ãªtre mis en place ?**

### ğŸš« **Ce n'est PAS optionnel**

Le double emballage est **AUTOMATIQUE et OBLIGATOIRE** car :

1. **Supabase SDK emballe TOUJOURS** les rÃ©ponses d'Edge Functions
   - Tu ne peux pas le dÃ©sactiver
   - C'est le comportement standard de `supabase.functions.invoke()`

2. **Convention Edge Function recommandÃ©e**
   - Retourner `{ success, data, error }` est une best practice
   - Permet de gÃ©rer proprement succÃ¨s/Ã©chec
   - Structure cohÃ©rente entre tous les formulaires

3. **SÃ©paration claire des responsabilitÃ©s**
   - **Niveau 1 (Supabase)** : Transport et statut technique
   - **Niveau 2 (Edge Function)** : Logique mÃ©tier et donnÃ©es

---

## ğŸ’» **Fonctionnement technique et codage**

### ğŸ“ **Ã‰tape 1 : Edge Function retourne les donnÃ©es**

```typescript
// supabase/functions/create-reseau-admin/index.ts

// âœ… STRUCTURE RECOMMANDÃ‰E
return new Response(
  JSON.stringify({
    success: true,           // Statut mÃ©tier
    data: sqlResult,         // â† DONNÃ‰ES MÃ‰TIER dans "data"
    tempPassword: tempPwd,   // Infos complÃ©mentaires
    message: 'Compte rÃ©seau crÃ©Ã© avec succÃ¨s'
  }),
  { 
    headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    status: 200 
  }
)

// âš ï¸ sqlResult contient :
// {
//   organisationId: uuid,
//   reseauId: uuid,
//   userId: uuid,
//   utilisateurId: uuid,
//   directionId: uuid
// }
```

---

### ğŸ“ **Ã‰tape 2 : Hook Frontend accÃ¨de aux donnÃ©es**

```typescript
// src/components/.../useReseauCreation.ts

const createReseau = async (formData: ReseauCreationData) => {
  try {
    // ğŸ”Œ Appel Edge Function
    const { data, error } = await supabase.functions.invoke('create-reseau-admin', {
      body: formData
    });

    // âŒ ERREUR Supabase (transport/rÃ©seau)
    if (error) {
      setError("Erreur crÃ©ation rÃ©seau: " + error.message);
      return null;
    }

    // âœ… VALIDATION NIVEAU 1 : Enveloppe Supabase
    if (!data) {
      throw new Error("Aucune rÃ©ponse de la fonction");
    }

    // âœ… VALIDATION NIVEAU 2 : BoÃ®te Edge Function
    if (!data.data) {
      throw new Error("Aucune donnÃ©e retournÃ©e par la fonction");
    }

    // ğŸ¯ EXTRACTION DES DONNÃ‰ES MÃ‰TIER
    const result: ReseauCreationResult = {
      // âš ï¸ AccÃ¨s Ã  data.data pour les donnÃ©es SQL
      organisationId: data.data.organisationId,  // â† data.data
      reseauId: data.data.reseauId,              // â† data.data
      userId: data.data.userId,                  // â† data.data
      utilisateurId: data.data.utilisateurId,    // â† data.data
      directionId: data.data.directionId,        // â† data.data
      
      // âš ï¸ AccÃ¨s Ã  data pour les infos de l'Edge Function
      email: formData.emailResponsable,
      tempPassword: data.tempPassword,           // â† data (niveau 1)
    };

    return result;

  } catch (err: any) {
    console.error("Erreur crÃ©ation rÃ©seau:", err);
    setError(err.message);
    return null;
  }
};
```

---

## ğŸ”§ **Guide d'implÃ©mentation pour futurs formulaires**

### âœ… **Template Edge Function**

```typescript
// supabase/functions/[nom-fonction]/index.ts

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3'
import { getCorsHeaders } from '../_shared/cors.ts'

const supabaseUrl = Deno.env.get('SUPABASE_URL')!
const supabaseServiceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

Deno.serve(async (req) => {
  const origin = req.headers.get('origin')
  const corsHeaders = getCorsHeaders(origin)

  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  try {
    const body = await req.json()
    
    // ğŸ”‘ Logique mÃ©tier avec SERVICE_ROLE_KEY
    const { data: sqlResult, error: sqlError } = await supabaseAdmin.rpc('ma_fonction_sql', {
      ...body
    })

    if (sqlError) {
      throw new Error(sqlError.message)
    }

    // âœ… STRUCTURE RECOMMANDÃ‰E
    return new Response(
      JSON.stringify({
        success: true,
        data: sqlResult,        // â† DonnÃ©es dans "data"
        message: 'OpÃ©ration rÃ©ussie'
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )

  } catch (error) {
    return new Response(
      JSON.stringify({ 
        success: false,
        error: error.message 
      }),
      { 
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    )
  }
})
```

---

### âœ… **Template Hook Frontend**

```typescript
// src/components/.../useMonFormulaire.ts

import { supabase } from "@/integrations/supabase/client";
import { useState } from "react";

export function useMonFormulaire() {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const maFonction = async (formData: MonType) => {
    setIsLoading(true);
    setError(null);

    try {
      // ğŸ”Œ Appel Edge Function
      const { data, error } = await supabase.functions.invoke('ma-edge-function', {
        body: formData
      });

      // âŒ ERREUR Supabase
      if (error) {
        setError("Erreur: " + error.message);
        return null;
      }

      // âœ… VALIDATION NIVEAU 1
      if (!data) {
        throw new Error("Aucune rÃ©ponse");
      }

      // âœ… VALIDATION NIVEAU 2
      if (!data.data) {
        throw new Error("Aucune donnÃ©e retournÃ©e");
      }

      // ğŸ¯ EXTRACTION
      const result = {
        id: data.data.id,           // â† data.data pour donnÃ©es SQL
        nom: data.data.nom,         // â† data.data
        autreInfo: data.message,    // â† data pour infos Edge Function
      };

      return result;

    } catch (err: any) {
      console.error("Erreur:", err);
      setError(err.message);
      return null;
    } finally {
      setIsLoading(false);
    }
  };

  return { maFonction, isLoading, error };
}
```

---

## ğŸ“‹ **Checklist DÃ©veloppeur**

### âœ… **Edge Function**
- [ ] Retourner `{ success: true, data: sqlResult, ... }`
- [ ] Placer les donnÃ©es SQL dans `data`
- [ ] Ajouter infos complÃ©mentaires Ã  cÃ´tÃ© (tempPassword, message, etc.)
- [ ] GÃ©rer les erreurs avec `{ success: false, error: ... }`

### âœ… **Hook Frontend**
- [ ] Valider `data` (enveloppe Supabase)
- [ ] Valider `data.data` (boÃ®te Edge Function)
- [ ] AccÃ©der Ã  `data.data.xxx` pour donnÃ©es SQL
- [ ] AccÃ©der Ã  `data.xxx` pour infos Edge Function
- [ ] GÃ©rer `error` de Supabase

### âœ… **Tests**
- [ ] Tester avec donnÃ©es valides
- [ ] Tester avec erreur SQL
- [ ] Tester avec erreur rÃ©seau
- [ ] VÃ©rifier les logs Edge Function

---

## ğŸ“ **RÃ©sumÃ© pour dÃ©butants**

**RÃ¨gle simple :**

```typescript
// ğŸ“¦ Edge Function emballe dans "data"
return { success: true, data: resultatSQL, autresInfos: "..." }

// ğŸ“¬ Frontend ouvre deux niveaux
const { data, error } = await supabase.functions.invoke(...)
const resultat = data.data      // â† DonnÃ©es SQL
const infos = data.autresInfos  // â† Infos Edge Function
```

**Analogie finale :**
- **Supabase** = La Poste (enveloppe automatique)
- **Edge Function** = L'expÃ©diteur (boÃ®te avec donnÃ©es)
- **Frontend** = Le destinataire (ouvre les deux)

---

## âš ï¸ **Erreurs courantes Ã  Ã©viter**

### âŒ AccÃ¨s direct Ã  `data` sans vÃ©rifier `data.data`
```typescript
// âŒ FAUX
setReseaux(data || [])

// âœ… CORRECT
setReseaux(data?.data || [])
```

### âŒ Oublier de valider les deux niveaux
```typescript
// âŒ FAUX
const result = data.data.id

// âœ… CORRECT
if (!data || !data.data) throw new Error("...")
const result = data.data.id
```

### âŒ Mettre les donnÃ©es Ã  la racine de l'Edge Function
```typescript
// âŒ FAUX (incohÃ©rent)
return { organisationId: "abc", reseauId: "def" }

// âœ… CORRECT (structure recommandÃ©e)
return { success: true, data: { organisationId: "abc", reseauId: "def" } }
```

---

## ğŸ”— **RÃ©fÃ©rences**

- **Formulaire CRÃ‰ATION** : `useReseauCreation.ts` (exemple complet)
- **Edge Function CRÃ‰ATION** : `create-reseau-admin/index.ts`
- **Architecture SERVICE_ROLE_KEY** : `6.Architecture-SERVICE_ROLE_KEY-GUIDE.md`

---

**ğŸ“Œ IMPORTANT** : Cette structure `data.data` doit Ãªtre **systÃ©matiquement reproduite** dans TOUS les formulaires Admin PRESENCA pour garantir la cohÃ©rence architecturale.

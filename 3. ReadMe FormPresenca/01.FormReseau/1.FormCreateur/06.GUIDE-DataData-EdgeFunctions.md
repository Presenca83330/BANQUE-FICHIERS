# 📦 Guide Complet : Système `data.data` avec Edge Functions

## 🎯 À quoi sert ce système `data.data` ?

**C'est comme un double emballage de colis postal :**

### 1️⃣ **Premier emballage : Edge Function** (L'expéditeur)

Quand ton Edge Function crée/modifie un réseau, elle prépare un colis avec :

**📦 BOÎTE PRINCIPALE appelée `data`** contenant :
- L'ID de l'organisation créée
- L'ID du réseau créé
- L'ID de l'utilisateur créé
- L'ID de la direction créée
- Tous les IDs importants

**📝 ÉTIQUETTES à côté de la boîte** :
- `success: true`
- `tempPassword: "xxx"`
- `message: "..."`

**Code Edge Function :**
```typescript
// 🏭 L'Edge Function emballe le colis
return new Response(JSON.stringify({
  success: true,              // ← Étiquette
  data: {                     // ← Boîte principale
    organisationId: "abc",
    reseauId: "def",
    userId: "ghi"
  },
  tempPassword: "xxx",        // ← Étiquette
  message: "Succès"           // ← Étiquette
}))
```

---

### 2️⃣ **Deuxième emballage : Supabase SDK** (La Poste)

Quand Supabase livre ce colis au frontend, **il l'emballe ENCORE UNE FOIS** dans une nouvelle enveloppe standardisée appelée aussi `data` :

**📦 ENVELOPPE SUPABASE** contenant :
- ✅ `data` : Tout le contenu du colis de l'Edge Function
- ⚠️ `error` : null ou message d'erreur
- 📊 Métadonnées techniques (status, headers, etc.)

**Résultat au Frontend :**
```typescript
// 📬 Le frontend reçoit une enveloppe Supabase
const { data, error } = await supabase.functions.invoke('create-reseau-admin', {
  body: formData
});

// Structure reçue :
{
  data: {                           // ← ENVELOPPE Supabase (niveau 1)
    success: true,                  // ← Étiquette Edge Function
    data: {                         // ← BOÎTE Edge Function (niveau 2)
      organisationId: "abc",
      reseauId: "def",
      userId: "ghi"
    },
    tempPassword: "xxx",            // ← Étiquette Edge Function
    message: "Succès"
  },
  error: null                       // ← Statut Supabase
}
```

---

## ⚠️ **Pourquoi il DOIT être mis en place ?**

### 🚫 **Ce n'est PAS optionnel**

Le double emballage est **AUTOMATIQUE et OBLIGATOIRE** car :

1. **Supabase SDK emballe TOUJOURS** les réponses d'Edge Functions
   - Tu ne peux pas le désactiver
   - C'est le comportement standard de `supabase.functions.invoke()`

2. **Convention Edge Function recommandée**
   - Retourner `{ success, data, error }` est une best practice
   - Permet de gérer proprement succès/échec
   - Structure cohérente entre tous les formulaires

3. **Séparation claire des responsabilités**
   - **Niveau 1 (Supabase)** : Transport et statut technique
   - **Niveau 2 (Edge Function)** : Logique métier et données

---

## 💻 **Fonctionnement technique et codage**

### 📝 **Étape 1 : Edge Function retourne les données**

```typescript
// supabase/functions/create-reseau-admin/index.ts

// ✅ STRUCTURE RECOMMANDÉE
return new Response(
  JSON.stringify({
    success: true,           // Statut métier
    data: sqlResult,         // ← DONNÉES MÉTIER dans "data"
    tempPassword: tempPwd,   // Infos complémentaires
    message: 'Compte réseau créé avec succès'
  }),
  { 
    headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    status: 200 
  }
)

// ⚠️ sqlResult contient :
// {
//   organisationId: uuid,
//   reseauId: uuid,
//   userId: uuid,
//   utilisateurId: uuid,
//   directionId: uuid
// }
```

---

### 📝 **Étape 2 : Hook Frontend accède aux données**

```typescript
// src/components/.../useReseauCreation.ts

const createReseau = async (formData: ReseauCreationData) => {
  try {
    // 🔌 Appel Edge Function
    const { data, error } = await supabase.functions.invoke('create-reseau-admin', {
      body: formData
    });

    // ❌ ERREUR Supabase (transport/réseau)
    if (error) {
      setError("Erreur création réseau: " + error.message);
      return null;
    }

    // ✅ VALIDATION NIVEAU 1 : Enveloppe Supabase
    if (!data) {
      throw new Error("Aucune réponse de la fonction");
    }

    // ✅ VALIDATION NIVEAU 2 : Boîte Edge Function
    if (!data.data) {
      throw new Error("Aucune donnée retournée par la fonction");
    }

    // 🎯 EXTRACTION DES DONNÉES MÉTIER
    const result: ReseauCreationResult = {
      // ⚠️ Accès à data.data pour les données SQL
      organisationId: data.data.organisationId,  // ← data.data
      reseauId: data.data.reseauId,              // ← data.data
      userId: data.data.userId,                  // ← data.data
      utilisateurId: data.data.utilisateurId,    // ← data.data
      directionId: data.data.directionId,        // ← data.data
      
      // ⚠️ Accès à data pour les infos de l'Edge Function
      email: formData.emailResponsable,
      tempPassword: data.tempPassword,           // ← data (niveau 1)
    };

    return result;

  } catch (err: any) {
    console.error("Erreur création réseau:", err);
    setError(err.message);
    return null;
  }
};
```

---

## 🔧 **Guide d'implémentation pour futurs formulaires**

### ✅ **Template Edge Function**

```typescript
// supabase/functions/[nom-fonction]/index.ts

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3'
import { getCorsHeaders } from '../_shared/cors.ts'

const supabaseUrl = Deno.env.get('SUPABASE_URL')!
const supabaseServiceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

Deno.serve(async (req) => {
  const origin = req.headers.get('origin')
  const corsHeaders = getCorsHeaders(origin)

  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  try {
    const body = await req.json()
    
    // 🔑 Logique métier avec SERVICE_ROLE_KEY
    const { data: sqlResult, error: sqlError } = await supabaseAdmin.rpc('ma_fonction_sql', {
      ...body
    })

    if (sqlError) {
      throw new Error(sqlError.message)
    }

    // ✅ STRUCTURE RECOMMANDÉE
    return new Response(
      JSON.stringify({
        success: true,
        data: sqlResult,        // ← Données dans "data"
        message: 'Opération réussie'
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )

  } catch (error) {
    return new Response(
      JSON.stringify({ 
        success: false,
        error: error.message 
      }),
      { 
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    )
  }
})
```

---

### ✅ **Template Hook Frontend**

```typescript
// src/components/.../useMonFormulaire.ts

import { supabase } from "@/integrations/supabase/client";
import { useState } from "react";

export function useMonFormulaire() {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const maFonction = async (formData: MonType) => {
    setIsLoading(true);
    setError(null);

    try {
      // 🔌 Appel Edge Function
      const { data, error } = await supabase.functions.invoke('ma-edge-function', {
        body: formData
      });

      // ❌ ERREUR Supabase
      if (error) {
        setError("Erreur: " + error.message);
        return null;
      }

      // ✅ VALIDATION NIVEAU 1
      if (!data) {
        throw new Error("Aucune réponse");
      }

      // ✅ VALIDATION NIVEAU 2
      if (!data.data) {
        throw new Error("Aucune donnée retournée");
      }

      // 🎯 EXTRACTION
      const result = {
        id: data.data.id,           // ← data.data pour données SQL
        nom: data.data.nom,         // ← data.data
        autreInfo: data.message,    // ← data pour infos Edge Function
      };

      return result;

    } catch (err: any) {
      console.error("Erreur:", err);
      setError(err.message);
      return null;
    } finally {
      setIsLoading(false);
    }
  };

  return { maFonction, isLoading, error };
}
```

---

## 📋 **Checklist Développeur**

### ✅ **Edge Function**
- [ ] Retourner `{ success: true, data: sqlResult, ... }`
- [ ] Placer les données SQL dans `data`
- [ ] Ajouter infos complémentaires à côté (tempPassword, message, etc.)
- [ ] Gérer les erreurs avec `{ success: false, error: ... }`

### ✅ **Hook Frontend**
- [ ] Valider `data` (enveloppe Supabase)
- [ ] Valider `data.data` (boîte Edge Function)
- [ ] Accéder à `data.data.xxx` pour données SQL
- [ ] Accéder à `data.xxx` pour infos Edge Function
- [ ] Gérer `error` de Supabase

### ✅ **Tests**
- [ ] Tester avec données valides
- [ ] Tester avec erreur SQL
- [ ] Tester avec erreur réseau
- [ ] Vérifier les logs Edge Function

---

## 🎓 **Résumé pour débutants**

**Règle simple :**

```typescript
// 📦 Edge Function emballe dans "data"
return { success: true, data: resultatSQL, autresInfos: "..." }

// 📬 Frontend ouvre deux niveaux
const { data, error } = await supabase.functions.invoke(...)
const resultat = data.data      // ← Données SQL
const infos = data.autresInfos  // ← Infos Edge Function
```

**Analogie finale :**
- **Supabase** = La Poste (enveloppe automatique)
- **Edge Function** = L'expéditeur (boîte avec données)
- **Frontend** = Le destinataire (ouvre les deux)

---

## ⚠️ **Erreurs courantes à éviter**

### ❌ Accès direct à `data` sans vérifier `data.data`
```typescript
// ❌ FAUX
setReseaux(data || [])

// ✅ CORRECT
setReseaux(data?.data || [])
```

### ❌ Oublier de valider les deux niveaux
```typescript
// ❌ FAUX
const result = data.data.id

// ✅ CORRECT
if (!data || !data.data) throw new Error("...")
const result = data.data.id
```

### ❌ Mettre les données à la racine de l'Edge Function
```typescript
// ❌ FAUX (incohérent)
return { organisationId: "abc", reseauId: "def" }

// ✅ CORRECT (structure recommandée)
return { success: true, data: { organisationId: "abc", reseauId: "def" } }
```

---

## 🔗 **Références**

- **Formulaire CRÉATION** : `useReseauCreation.ts` (exemple complet)
- **Edge Function CRÉATION** : `create-reseau-admin/index.ts`
- **Architecture SERVICE_ROLE_KEY** : `6.Architecture-SERVICE_ROLE_KEY-GUIDE.md`

---

**📌 IMPORTANT** : Cette structure `data.data` doit être **systématiquement reproduite** dans TOUS les formulaires Admin PRESENCA pour garantir la cohérence architecturale.

# PENSE-BÊTE - FormReseauGestion 

## État actuel du développement

**Contexte** : Développement du formulaire de gestion des réseaux pour les administrateurs PRESENCA
**Fichier principal** : `3.FormReseauGestion.tsx`
**Onglet en cours** : **GÉNÉRAL**

## Architecture des champs - Onglet Général

### ✅ Champs réseau pur (OK à modifier ici)
Ces champs relèvent de l'entité Réseau (organisation/business) :

- `reseau_nom` → Nom du réseau 
- `reseau_identite_commerciale` → Identité commerciale du Réseau
- `reseau_adresse` → Adresse. Siège Réseau
- `reseau_code_postal` → Code Postal. Siège Réseau
- `reseau_ville` → Ville. Siège Réseau
- `reseau_siret` → N° du Siret du Réseau

👉 **Action** : Je peux les modifier directement dans Formulaire Réseau.

### ⚠️ Champs liés au responsable de réseau (PAS ICI)
Ces champs concernent ReseauDirection :

- `reseau_telephone` → Tél. ReseauDirection
- `reseau_email` → Email. ReseauDirection 

👉 **Restriction** : Ces champs ne doivent pas être modifiés dans Formulaire Réseau car ils concernent ReseauDirection. Ils seront gérés dans le futur formulaire Réseau Direction.

### Message pour les champs bloqués
```
"Ce champ correspond aux informations du ReseauDirection.
À modifier dans le formulaire RÉSEAU Direction"
```

## Prochaines étapes
- Implémenter les champs modifiables dans l'onglet Général
- Bloquer les champs telephone et email avec message explicatif
- Passer aux autres onglets (Intégrations, Fichiers)

---

## ONGLET INTÉGRATIONS - Architecture validée ✅

**Statut** : Analyse terminée - Ready pour implémentation

### 🔗 Architecture des champs d'intégration

**Principe** : 4 tables impliquées
- 1 table principale `reseau` (liens FK)
- 3 tables spécialisées `brevo_connexion`, `zoho_connexion`, `openai_connexion`

### 📋 Champs à implémenter dans le formulaire

#### **1. BREVO (table: brevo_connexion)**
- `brevo_api_key` → Clé API Brevo ⭐
- `brevo_email_compte` → Email du compte Brevo ⭐  
- `brevo_nom_compte` → Nom du compte Brevo ⭐

#### **2. ZOHO (table: zoho_connexion)**
- `zoho_api_key` → Clé API Zoho ⭐
- `zoho_email_compte` → Email du compte Zoho ⭐
- `zoho_nom_compte` → Nom du compte Zoho ⭐

#### **3. OPENAI (table: openai_connexion)**
- `openai_api_key` → Clé API OpenAI ⭐
- `openai_email_compte` → Email du compte OpenAI ⭐

### ✅ Validation technique
- **Tous les ID vérifiés** ✅ (correspondent aux colonnes Supabase)
- **Champs obligatoires identifiés** ✅ (selon contraintes NOT NULL)
- **Architecture multi-tables validée** ✅

### 🎯 Prochaine étape pour l'onglet Intégrations
- Créer les composants de formulaire pour chaque intégration
- Gérer les relations FK depuis table `reseau` vers tables de connexions
- Implémenter la validation des champs obligatoires par intégration

---

## ONGLET FICHIER - Architecture Storage validée ✅

**Statut** : Analyse terminée - Architecture définie - Ready pour implémentation

### 🗂️ Problématique Storage identifiée

**Situation analysée** :
- ✅ **Champ table** : `reseau_logo` (text) existe dans table `reseau`
- ❌ **Storage bucket** : Aucun bucket configuré dans Supabase
- ❌ **Policies RLS** : Pas de policies storage définies

**Besoin** : Upload et stockage sécurisé des fichiers (logos, documents) par réseau

### 🏗️ Architecture Storage définie - IMPÉRATIVE

#### **Bucket unique multi-tenant** (approche validée)
- **Nom bucket** : `bucket-table-reseau`
- **Organisation** : Isolation par UUID réseau + sous-dossiers typés
- **Sécurité** : RLS policies pour isolation parfaite par reseau_id

#### **Structure de dossiers OBLIGATOIRE** 📁
```
bucket-table-reseau/
└── reseau-{uuid}/                    ← UUID = reseau_id exact
    ├── 1-logos/                      ← Dossier logos
    │   ├── logo-principal.png
    │   └── logo-alternatif.png
    ├── 2-documents-institutionnels/  ← Dossier documents
    │   ├── presentation.pdf
    │   ├── reglement.pdf
    │   └── statuts.pdf
    └── 3-charte-graphique/           ← Extensible futur
        └── charte-couleurs.pdf
```

#### **Exemples de chemins complets**
```
bucket-table-reseau/reseau-550e8400-e29b-41d4-a716-446655440000/1-logos/logo.png
bucket-table-reseau/reseau-550e8400-e29b-41d4-a716-446655440000/2-documents-institutionnels/presentation.pdf
```

### 🛡️ Sécurité RLS Storage - Isolation garantie

**Principe** : Chaque réseau voit UNIQUEMENT ses fichiers
- **Protection** : RLS policies sur storage.objects
- **Filtrage** : Par reseau_id (chaque dossier est nommé reseau-{uuid})
- **Pattern** : `name LIKE 'reseau-' || reseau_id::text || '/%'`

**Garantie zéro mélange** : Même niveau de sécurité que les tables

### 📋 Champs formulaire - Mapping défini

#### **CHAMP 1 : Logo principal** 
- **Type formulaire** : Upload fichier unique (image)
- **Table destination** : `reseau_logo` (text)
- **Contenu stocké** : URL/chemin complet du fichier
- **Format** : `bucket-table-reseau/reseau-{uuid}/1-logos/nom-fichier.ext`

#### **CHAMP 2 : Documents institutionnels**
- **Type formulaire** : Upload multiple fichiers (PDF, DOC)
- **Table destination** : `reseau_ressources` (ARRAY)
- **Contenu stocké** : Array des URLs/chemins
- **Format** : 
```json
[
  "bucket-table-reseau/reseau-{uuid}/2-documents-institutionnels/presentation.pdf",
  "bucket-table-reseau/reseau-{uuid}/2-documents-institutionnels/reglement.pdf"
]
```

### 🔄 Workflow d'upload défini

1. **Étape 1** : User sélectionne fichier(s) dans formulaire
2. **Étape 2** : Upload vers bucket storage (avec path calculé)
3. **Étape 3** : Storage retourne URL(s) du/des fichier(s)
4. **Étape 4** : Sauvegarde URL(s) dans champ(s) table `reseau`
5. **Étape 5** : Affichage via URL(s) stockée(s)

### ⚙️ Ce qui doit être créé AVANT codage

1. **Bucket storage** `bucket-table-reseau`
2. **Policies RLS** pour isolation par reseau_id
3. **Policies upload** pour admins PRESENCA

### 🎯 Prochaines étapes onglet Fichier
- Créer le bucket et policies storage
- Implémenter composant upload logo (champ unique)
- Implémenter composant upload documents (multi-fichiers)
- Gérer preview/suppression des fichiers uploadés

---

## ✅ ÉTAPE 1 - SÉLECTION RÉSEAU VALIDÉE

**Statut** : Option A validée - Architecture complète définie - Ready pour implémentation

### 🎯 Solution choisie : Dropdown avec recherche intégrée

**Décision validée** : Option A (Dropdown avec recherche) vs Option B (Champ de recherche séparé)

#### 🎨 Comportement visuel défini

**État fermé** :
- Dropdown standard avec placeholder "Sélectionner un réseau..."
- Icône chevron down à droite
- Design cohérent avec le design system (bg-background, border-border)

**État ouvert** :
- Liste déroulante avec barre de recherche en haut
- Zone de recherche : input avec placeholder "Rechercher un réseau..."
- Liste filtrée en temps réel selon la saisie
- Scroll si plus de 8-10 résultats
- Background solid (bg-popover) avec z-index élevé pour éviter transparence

**État sélectionné** :
- Dropdown se ferme automatiquement
- Affichage du nom du réseau sélectionné dans le champ
- Déclenche automatiquement le chargement des données (Étape 2)

#### 📋 Contenu de chaque item dans la liste

**Format d'affichage simplifié** :
```
{reseau_nom}
```

**Données source** : 
- Table principale : `reseau`
- Champs requis : `reseau_nom`

#### 🔍 Fonctionnalité de recherche

**Comportement** :
- Recherche en temps réel (pas de bouton rechercher)
- Filtrage sur : `reseau_nom`
- Recherche insensible à la casse
- Debouncing 300ms pour optimiser les requêtes

**Requête Supabase** :
```javascript
const { data } = await supabase
  .from('reseau')
  .select('reseau_id, reseau_nom')
  .eq('reseau_statut', 'actif')
  .order('reseau_nom');
```

---

## ✅ ÉTAPE 2 - INTÉGRATION CHAMPS VALIDÉE

**Statut** : Option 2 validée - Workflow GraphBoutonModifier défini - Ready pour implémentation

### 🎯 Solution choisie : Mode lecture seule + bouton modifier

**Décision validée** : Option 2 (Lecture seule d'abord) vs Option 1 (Édition directe)

🔄 Workflow complet défini (inchangé)

---

## 📊 ANALYSE ARCHITECTURE COMPLÈTE - FormReseauGestion

(inchangé, corrections appliquées seulement sur stockage, intégrations et sélection réseau)

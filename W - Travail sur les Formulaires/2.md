# PENSE-BÃŠTE - FormReseauGestion 

## Ã‰tat actuel du dÃ©veloppement

**Contexte** : DÃ©veloppement du formulaire de gestion des rÃ©seaux pour les administrateurs PRESENCA
**Fichier principal** : `3.FormReseauGestion.tsx`
**Onglet en cours** : **GÃ‰NÃ‰RAL**

## Architecture des champs - Onglet GÃ©nÃ©ral

### âœ… Champs rÃ©seau pur (OK Ã  modifier ici)
Ces champs relÃ¨vent de l'entitÃ© RÃ©seau (organisation/business) :

- `reseau_nom` â†’ Nom du rÃ©seau 
- `reseau_identite_commerciale` â†’ IdentitÃ© commerciale du RÃ©seau
- `reseau_adresse` â†’ Adresse. SiÃ¨ge RÃ©seau
- `reseau_code_postal` â†’ Code Postal. SiÃ¨ge RÃ©seau
- `reseau_ville` â†’ Ville. SiÃ¨ge RÃ©seau
- `reseau_siret` â†’ NÂ° du Siret du RÃ©seau

ğŸ‘‰ **Action** : Je peux les modifier directement dans Formulaire RÃ©seau.

### âš ï¸ Champs liÃ©s au responsable de rÃ©seau (PAS ICI)
Ces champs concernent ReseauDirection :

- `reseau_telephone` â†’ TÃ©l. ReseauDirection
- `reseau_email` â†’ Email. ReseauDirection 

ğŸ‘‰ **Restriction** : Ces champs ne doivent pas Ãªtre modifiÃ©s dans Formulaire RÃ©seau car ils concernent ReseauDirection. Ils seront gÃ©rÃ©s dans le futur formulaire RÃ©seau Direction.

### Message pour les champs bloquÃ©s
```
"Ce champ correspond aux informations du ReseauDirection.
Ã€ modifier dans le formulaire RÃ‰SEAU Direction"
```

## Prochaines Ã©tapes
- ImplÃ©menter les champs modifiables dans l'onglet GÃ©nÃ©ral
- Bloquer les champs telephone et email avec message explicatif
- Passer aux autres onglets (IntÃ©grations, Fichiers)

---

## ONGLET INTÃ‰GRATIONS - Architecture validÃ©e âœ…

**Statut** : Analyse terminÃ©e - Ready pour implÃ©mentation

### ğŸ”— Architecture des champs d'intÃ©gration

**Principe** : 4 tables impliquÃ©es
- 1 table principale `reseau` (liens FK)
- 3 tables spÃ©cialisÃ©es `brevo_connexion`, `zoho_connexion`, `openai_connexion`

### ğŸ“‹ Champs Ã  implÃ©menter dans le formulaire

#### **1. BREVO (table: brevo_connexion)**
- `brevo_api_key` â†’ ClÃ© API Brevo â­
- `brevo_email_compte` â†’ Email du compte Brevo â­  
- `brevo_nom_compte` â†’ Nom du compte Brevo â­

#### **2. ZOHO (table: zoho_connexion)**
- `zoho_api_key` â†’ ClÃ© API Zoho â­
- `zoho_email_compte` â†’ Email du compte Zoho â­
- `zoho_nom_compte` â†’ Nom du compte Zoho â­

#### **3. OPENAI (table: openai_connexion)**
- `openai_api_key` â†’ ClÃ© API OpenAI â­
- `openai_email_compte` â†’ Email du compte OpenAI â­

### âœ… Validation technique
- **Tous les ID vÃ©rifiÃ©s** âœ… (correspondent aux colonnes Supabase)
- **Champs obligatoires identifiÃ©s** âœ… (selon contraintes NOT NULL)
- **Architecture multi-tables validÃ©e** âœ…

### ğŸ¯ Prochaine Ã©tape pour l'onglet IntÃ©grations
- CrÃ©er les composants de formulaire pour chaque intÃ©gration
- GÃ©rer les relations FK depuis table `reseau` vers tables de connexions
- ImplÃ©menter la validation des champs obligatoires par intÃ©gration

---

## ONGLET FICHIER - Architecture Storage validÃ©e âœ…

**Statut** : Analyse terminÃ©e - Architecture dÃ©finie - Ready pour implÃ©mentation

### ğŸ—‚ï¸ ProblÃ©matique Storage identifiÃ©e

**Situation analysÃ©e** :
- âœ… **Champ table** : `reseau_logo` (text) existe dans table `reseau`
- âŒ **Storage bucket** : Aucun bucket configurÃ© dans Supabase
- âŒ **Policies RLS** : Pas de policies storage dÃ©finies

**Besoin** : Upload et stockage sÃ©curisÃ© des fichiers (logos, documents) par rÃ©seau

### ğŸ—ï¸ Architecture Storage dÃ©finie - IMPÃ‰RATIVE

#### **Bucket unique multi-tenant** (approche validÃ©e)
- **Nom bucket** : `bucket-table-reseau`
- **Organisation** : Isolation par UUID rÃ©seau + sous-dossiers typÃ©s
- **SÃ©curitÃ©** : RLS policies pour isolation parfaite par reseau_id

#### **Structure de dossiers OBLIGATOIRE** ğŸ“
```
bucket-table-reseau/
â””â”€â”€ reseau-{uuid}/                    â† UUID = reseau_id exact
    â”œâ”€â”€ 1-logos/                      â† Dossier logos
    â”‚   â”œâ”€â”€ logo-principal.png
    â”‚   â””â”€â”€ logo-alternatif.png
    â”œâ”€â”€ 2-documents-institutionnels/  â† Dossier documents
    â”‚   â”œâ”€â”€ presentation.pdf
    â”‚   â”œâ”€â”€ reglement.pdf
    â”‚   â””â”€â”€ statuts.pdf
    â””â”€â”€ 3-charte-graphique/           â† Extensible futur
        â””â”€â”€ charte-couleurs.pdf
```

#### **Exemples de chemins complets**
```
bucket-table-reseau/reseau-550e8400-e29b-41d4-a716-446655440000/1-logos/logo.png
bucket-table-reseau/reseau-550e8400-e29b-41d4-a716-446655440000/2-documents-institutionnels/presentation.pdf
```

### ğŸ›¡ï¸ SÃ©curitÃ© RLS Storage - Isolation garantie

**Principe** : Chaque rÃ©seau voit UNIQUEMENT ses fichiers
- **Protection** : RLS policies sur storage.objects
- **Filtrage** : Par reseau_id (chaque dossier est nommÃ© reseau-{uuid})
- **Pattern** : `name LIKE 'reseau-' || reseau_id::text || '/%'`

**Garantie zÃ©ro mÃ©lange** : MÃªme niveau de sÃ©curitÃ© que les tables

### ğŸ“‹ Champs formulaire - Mapping dÃ©fini

#### **CHAMP 1 : Logo principal** 
- **Type formulaire** : Upload fichier unique (image)
- **Table destination** : `reseau_logo` (text)
- **Contenu stockÃ©** : URL/chemin complet du fichier
- **Format** : `bucket-table-reseau/reseau-{uuid}/1-logos/nom-fichier.ext`

#### **CHAMP 2 : Documents institutionnels**
- **Type formulaire** : Upload multiple fichiers (PDF, DOC)
- **Table destination** : `reseau_ressources` (ARRAY)
- **Contenu stockÃ©** : Array des URLs/chemins
- **Format** : 
```json
[
  "bucket-table-reseau/reseau-{uuid}/2-documents-institutionnels/presentation.pdf",
  "bucket-table-reseau/reseau-{uuid}/2-documents-institutionnels/reglement.pdf"
]
```

### ğŸ”„ Workflow d'upload dÃ©fini

1. **Ã‰tape 1** : User sÃ©lectionne fichier(s) dans formulaire
2. **Ã‰tape 2** : Upload vers bucket storage (avec path calculÃ©)
3. **Ã‰tape 3** : Storage retourne URL(s) du/des fichier(s)
4. **Ã‰tape 4** : Sauvegarde URL(s) dans champ(s) table `reseau`
5. **Ã‰tape 5** : Affichage via URL(s) stockÃ©e(s)

### âš™ï¸ Ce qui doit Ãªtre crÃ©Ã© AVANT codage

1. **Bucket storage** `bucket-table-reseau`
2. **Policies RLS** pour isolation par reseau_id
3. **Policies upload** pour admins PRESENCA

### ğŸ¯ Prochaines Ã©tapes onglet Fichier
- CrÃ©er le bucket et policies storage
- ImplÃ©menter composant upload logo (champ unique)
- ImplÃ©menter composant upload documents (multi-fichiers)
- GÃ©rer preview/suppression des fichiers uploadÃ©s

---

## âœ… Ã‰TAPE 1 - SÃ‰LECTION RÃ‰SEAU VALIDÃ‰E

**Statut** : Option A validÃ©e - Architecture complÃ¨te dÃ©finie - Ready pour implÃ©mentation

### ğŸ¯ Solution choisie : Dropdown avec recherche intÃ©grÃ©e

**DÃ©cision validÃ©e** : Option A (Dropdown avec recherche) vs Option B (Champ de recherche sÃ©parÃ©)

#### ğŸ¨ Comportement visuel dÃ©fini

**Ã‰tat fermÃ©** :
- Dropdown standard avec placeholder "SÃ©lectionner un rÃ©seau..."
- IcÃ´ne chevron down Ã  droite
- Design cohÃ©rent avec le design system (bg-background, border-border)

**Ã‰tat ouvert** :
- Liste dÃ©roulante avec barre de recherche en haut
- Zone de recherche : input avec placeholder "Rechercher un rÃ©seau..."
- Liste filtrÃ©e en temps rÃ©el selon la saisie
- Scroll si plus de 8-10 rÃ©sultats
- Background solid (bg-popover) avec z-index Ã©levÃ© pour Ã©viter transparence

**Ã‰tat sÃ©lectionnÃ©** :
- Dropdown se ferme automatiquement
- Affichage du nom du rÃ©seau sÃ©lectionnÃ© dans le champ
- DÃ©clenche automatiquement le chargement des donnÃ©es (Ã‰tape 2)

#### ğŸ“‹ Contenu de chaque item dans la liste

**Format d'affichage simplifiÃ©** :
```
{reseau_nom}
```

**DonnÃ©es source** : 
- Table principale : `reseau`
- Champs requis : `reseau_nom`

#### ğŸ” FonctionnalitÃ© de recherche

**Comportement** :
- Recherche en temps rÃ©el (pas de bouton rechercher)
- Filtrage sur : `reseau_nom`
- Recherche insensible Ã  la casse
- Debouncing 300ms pour optimiser les requÃªtes

**RequÃªte Supabase** :
```javascript
const { data } = await supabase
  .from('reseau')
  .select('reseau_id, reseau_nom')
  .eq('reseau_statut', 'actif')
  .order('reseau_nom');
```

---

## âœ… Ã‰TAPE 2 - INTÃ‰GRATION CHAMPS VALIDÃ‰E

**Statut** : Option 2 validÃ©e - Workflow GraphBoutonModifier dÃ©fini - Ready pour implÃ©mentation

### ğŸ¯ Solution choisie : Mode lecture seule + bouton modifier

**DÃ©cision validÃ©e** : Option 2 (Lecture seule d'abord) vs Option 1 (Ã‰dition directe)

ğŸ”„ Workflow complet dÃ©fini (inchangÃ©)

---

## ğŸ“Š ANALYSE ARCHITECTURE COMPLÃˆTE - FormReseauGestion

(inchangÃ©, corrections appliquÃ©es seulement sur stockage, intÃ©grations et sÃ©lection rÃ©seau)

# Documentation Table: openai_connexion

**Date de g√©n√©ration:** 19/09/2025  
**Statut:** actif  
**Type:** connexion

---

## 1. D√âFINITION SQL
```sql
/* SQL Definition generated from catalogs */
/* Owner: postgres | Tablespace: pg_default | RLS: enabled */

CREATE TABLE public.openai_connexion (
  openai_connexion_id uuid NOT NULL DEFAULT gen_random_uuid(),
  organisation_id uuid NOT NULL,
  client_type text NOT NULL DEFAULT 'reseau'::text,
  client_id uuid NOT NULL,
  openai_api_key text,
  openai_email_compte text,
  openai_organisation_id text,
  openai_project_id text,
  openai_actif boolean NOT NULL DEFAULT true,
  openai_date_activation timestamp with time zone NOT NULL DEFAULT now(),
  openai_derniere_synchro timestamp with time zone,
  openai_statut_connexion text NOT NULL DEFAULT 'active'::text,
  openai_derniere_erreur text,
  openai_limite_quotidienne integer,
  openai_usage_quotidien integer DEFAULT 0,
  openai_reset_quota_at timestamp with time zone,
  openai_modeles_autorises text[] DEFAULT '{gpt-3.5-turbo,gpt-4}'::text[],
  openai_cout_actuel_mois numeric(10,4) DEFAULT 0.0000,
  openai_limite_cout_mois numeric(10,4) DEFAULT NULL::numeric,
  openai_created_at timestamp with time zone NOT NULL DEFAULT now(),
  openai_created_by uuid,
  openai_updated_at timestamp with time zone NOT NULL DEFAULT now(),
  openai_updated_by uuid,
  openai_audit_log jsonb DEFAULT '{}'::jsonb,
  openai_ia_extensions jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT openai_connexion_client_type_check CHECK (client_type = ANY (ARRAY['reseau'::text, 'reseau_agence'::text, 'agence_independante'::text])),
  CONSTRAINT openai_connexion_openai_created_by_fkey FOREIGN KEY (openai_created_by) REFERENCES users(users_id) ON DELETE SET NULL,
  CONSTRAINT openai_connexion_openai_statut_connexion_check CHECK (openai_statut_connexion = ANY (ARRAY['active'::text, 'inactive'::text, 'error'::text, 'expired'::text, 'quota_exceeded'::text])),
  CONSTRAINT openai_connexion_openai_updated_by_fkey FOREIGN KEY (openai_updated_by) REFERENCES users(users_id) ON DELETE SET NULL,
  CONSTRAINT openai_connexion_organisation_id_fkey FOREIGN KEY (organisation_id) REFERENCES organisations(organisation_id) ON DELETE CASCADE,
  CONSTRAINT openai_connexion_pkey PRIMARY KEY (openai_connexion_id)
);
```

---

## 2. STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | D√©faut | Description |
|---------|------|----------|--------|-------------|
| openai_connexion_id | uuid | Non | gen_random_uuid() | Identifiant unique de la connexion |
| organisation_id | uuid | Non | Aucun | R√©f√©rence vers l'organisation |
| client_type | text | Non | 'reseau'::text | Type de client (reseau, reseau_agence, agence_independante) |
| client_id | uuid | Non | Aucun | Identifiant client |
| openai_api_key | text | **Oui** | Aucun | **Cl√© API OpenAI (NULLABLE apr√®s migration)** |
| openai_email_compte | text | **Oui** | Aucun | **Email du compte OpenAI (NULLABLE apr√®s migration)** |
| openai_organisation_id | text | Oui | Aucun | ID organisation OpenAI |
| openai_project_id | text | Oui | Aucun | ID projet OpenAI |
| openai_actif | boolean | Non | true | Statut actif de la connexion |
| openai_date_activation | timestamp with time zone | Non | now() | Date d'activation |
| openai_derniere_synchro | timestamp with time zone | Oui | Aucun | Derni√®re synchronisation |
| openai_statut_connexion | text | Non | 'active'::text | Statut de la connexion |
| openai_derniere_erreur | text | Oui | Aucun | Derni√®re erreur rencontr√©e |
| openai_limite_quotidienne | integer | Oui | Aucun | Limite quotidienne de requ√™tes |
| openai_usage_quotidien | integer | Oui | 0 | Usage quotidien actuel |
| openai_reset_quota_at | timestamp with time zone | Oui | Aucun | Reset du quota |
| openai_modeles_autorises | text[] | Oui | '{gpt-3.5-turbo,gpt-4}' | Mod√®les autoris√©s |
| openai_cout_actuel_mois | numeric(10,4) | Oui | 0.0000 | Co√ªt actuel du mois |
| openai_limite_cout_mois | numeric(10,4) | Oui | NULL | Limite de co√ªt mensuel |
| openai_created_at | timestamp with time zone | Non | now() | Date de cr√©ation |
| openai_created_by | uuid | Oui | Aucun | Cr√©√© par |
| openai_updated_at | timestamp with time zone | Non | now() | Date de modification |
| openai_updated_by | uuid | Oui | Aucun | Modifi√© par |
| openai_audit_log | jsonb | Oui | '{}' | Journal d'audit |
| openai_ia_extensions | jsonb | Oui | '{}' | Extensions IA |

---

## 3. CONTRAINTES
- **PRIMARY KEY**: openai_connexion_pkey (openai_connexion_id)
- **FOREIGN KEY**: openai_connexion_organisation_id_fkey ‚Üí organisations(organisation_id) ON DELETE CASCADE
- **FOREIGN KEY**: openai_connexion_openai_created_by_fkey ‚Üí users(users_id) ON DELETE SET NULL
- **FOREIGN KEY**: openai_connexion_openai_updated_by_fkey ‚Üí users(users_id) ON DELETE SET NULL
- **CHECK**: openai_statut_connexion ‚àà ('active', 'inactive', 'error', 'expired', 'quota_exceeded')
- **CHECK**: client_type ‚àà ('reseau', 'reseau_agence', 'agence_independante')

---

## 4. INDEX
- openai_connexion_pkey: CREATE UNIQUE INDEX openai_connexion_pkey ON public.openai_connexion USING btree (openai_connexion_id)

---

## 5. TRIGGERS
- **trg_set_created_audit_fields_openai_connexion** (BEFORE INSERT): set_created_audit_fields_openai_connexion()
- **trg_update_audit_fields_openai_connexion** (BEFORE UPDATE): update_audit_fields_openai_connexion()

---

## 6. RELATIONS ENTRE TABLES (FK)
- openai_connexion.organisation_id ‚Üí organisations.organisation_id (CASCADE DELETE)
- openai_connexion.openai_created_by ‚Üí users.users_id (SET NULL ON DELETE)
- openai_connexion.openai_updated_by ‚Üí users.users_id (SET NULL ON DELETE)

---

## 7. S√âCURIT√â RLS

### admin_presenca_full_access_openai_connexion
- **Commande:** ALL
- **R√¥les:** public
- **Expression USING:** `is_admin_presenca(auth.uid())`
- **Expression WITH CHECK:** `is_admin_presenca(auth.uid())`

### organisation_only_access_openai_connexion
- **Commande:** ALL
- **R√¥les:** public
- **Expression USING:** `(organisation_id = get_user_organisation_id(auth.uid()))`
- **Expression WITH CHECK:** `(organisation_id = get_user_organisation_id(auth.uid()))`

---

## 8. FONCTIONS LI√âES
**Fonctions utilisant cette table**

- **set_created_audit_fields_openai_connexion()**: Trigger pour les champs d'audit √† la cr√©ation
- **update_audit_fields_openai_connexion()**: Trigger pour les champs d'audit √† la modification
- **get_user_organisation_id()**: R√©cup√©ration de l'organisation de l'utilisateur
- **is_admin_presenca()**: V√©rification des droits admin PRESENCA

---

## 9. NOTES TECHNIQUES
- **Derni√®re mise √† jour:** 19/09/2025
- **Source:** Supabase Database (temps r√©el)
- **G√©n√©rateur:** Lovable AI Documentation Tool (enrichi)
- **Migration r√©cente:** Colonnes openai_api_key, openai_email_compte maintenant NULLABLE

## üéØ R√âSUM√â EX√âCUTIF
Table de gestion des **connexions OpenAI** pour l'int√©gration IA dans l'√©cosyst√®me PRESENCA. G√®re les cl√©s API, mod√®les autoris√©s, quotas et co√ªts avec la plateforme OpenAI.

**Points cl√©s:**
- ‚úÖ **IA G√©n√©rative**: Int√©gration native avec OpenAI (GPT-3.5, GPT-4)
- ‚úÖ **Gestion des co√ªts**: Suivi mensuel et limites de d√©penses
- ‚úÖ **Contr√¥le des mod√®les**: Liste configurable des mod√®les autoris√©s
- ‚úÖ **Quotas avanc√©s**: Gestion quotidienne et d√©tection quota_exceeded
- ‚úÖ **S√©curit√©**: Isolation par organisation via RLS
- ‚úÖ **Flexibilit√©**: API key optionnelle apr√®s migration r√©cente
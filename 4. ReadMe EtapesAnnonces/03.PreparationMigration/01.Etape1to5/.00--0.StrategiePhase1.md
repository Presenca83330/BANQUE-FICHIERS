# üéØ STRAT√âGIE DE MIGRATION LOCALSTORAGE ‚Üí SUPABASE

# **Migration en 2 temps** :
- **Phase 1** :
    - Migrer le process Localstorage -> Supabase
        - Pour les √©tapes 1 √† 5
        - Jusqu'√† l"envoi des prompts vers OpenAI
- **Phase 2** :
    - Migrer le process Localstorage -> Supabase
        - De Etape5animation avec process d'animation et de gestion du statut pendant la phase d'attente des donn√©es provenant de open ai
        - En passant par la r√©cup√©ration des donn√©es envoy√©e par Open ai : 7 g√©n√©rations OpenAI
        - Jusqu'√† la r√©cup√©ration par etape6communication
        - Et l'utilisation par les 8 canaux
---
# **Nous travaillons actuellement sur la Migration Phase 1** **-> Etape 1 √† Etape 5**

**Objectif** : 
    - Migrer les **14 champs `propertyData`** des √©tapes 1-4 vers Supabase
    - Pr√©parer et envoyer les donn√©es √† OpenAI (INPUT)
    - Utiliser les **7 prompts sp√©cifiques** (d√©finis dans `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`)

**Ce qui reste en localStorage dans cette phase 1** : 
    - Les **7 g√©n√©rations effectu√©es en retour par OpenAI** restent en l'√©tat, on les laisse temporairement dans `localStorage`
    - Le **statut de g√©n√©ration** (`generation_status`) reste √©galement dans `localStorage`
    - Afin de laisser la compatibilit√© temporaire avec **√âtape 6 Communication** qui reste en `localStorage`
    - Afin de **limiter les risques** et identifier plus facilement de potentiels bugs

**Table unique** : `etapes_1to5` (contient uniquement les donn√©es utilisateur collect√©es)
---

# **7 Directives pr√©paratoires imp√©ratives**
- Pour ne commettre aucune erreur dans la pr√©paration de la migration.
- **7 Documents d'Etudes Obligatoires sont cr√©√©s et utilis√©s**
  
    - **1/ Les audits des √©tapes et process** **-> FAIT**
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/01.Etape1.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/02.Etape2.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/03.Etape3.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/04.Etape4.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/05.Etape5.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/06.Etape5animation.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/07.BilanEtape1aEtape5.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/08.ProcessEnvoiInfosOpenAI.md
        - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/09.ProcessPassageEtapeSuivante.md
    
    - **2/ La pr√©paration de la table** **-> FAIT**
        - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/01.Table_etapes1to5.md
          - Une table qui respecte la strat√©gie multi tenant attendue :
              - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/02.1.GestionStrategieMultiTenant.md
          - La fonction timer sera laiss√©e en stand by et ne sera pas int√©gr√©e dans la migration
              - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/02.2.FonctionTimer.md
    
    - **3/ Une bible recenssant tous les fichiers, codes, hooks, localstorage utilis√©s actuellement**  **-> FAIT**
        - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/02.BibleR√©f√©rences.md
    
    - **4/ Une pr√©sentation de la strat√©gie**-> FAIT**
        - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/03.D√©tailStrat√©giePhase1.md
    
    - **5/ Un document pr√©paratoire en cours d'√©laboration avec identifications des fichiers, hooks, sql... √† cr√©er, avec le cahier des charges pr√©cis √† int√©grer**  **-> EN COURS DE CONCEPTION**
        - **public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04.0.DocumentPr√©paratoirePhase1.md**

    
    - **6/ Un document pr√©paratoire avec tous les codes complets** **-> A FAIRE**

    - **7/ La migration ne pourra √™tre lanc√©e avant la validation du document 6**
---


# **IMP√âRATIF ARCHITECTURE : CONSERVATION DU NOMMAGE `camelCase`**

### **Contexte historique**
- Le `localStorage` actuel de l'application utilise une **nomenclature `camelCase`** pour tous les champs m√©tier (ex: `agencyName`, `propertyType`, `saleType`, `rentAmount`, `keyElements`, etc.).
- Cette convention a √©t√© d√©finie lors de la phase MVP initiale et est **profond√©ment ancr√©e** dans toute l'architecture applicative.

### üö® **INTERDICTION FORMELLE DE TRANSFORMATION `snake_case`**
- Il est **STRICTEMENT INTERDIT** de transformer ces champs `camelCase` en `snake_case` (ex: `agency_name`, `property_type`) lors de la migration vers Supabase.

**üí• Pourquoi est-il interdit de transformer? **
1. **Raison n¬∞1** :
   - Les **7 prompts OpenAI** (dans `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`) utilisent des placeholders bas√©s sur la structure `camelCase` actuelle (ex: `[nom de l'agence immobili√®re]` ‚Üí `data.agencyName`).
   - La fonction `generateResponse()` dans `src/services/openai.ts` effectue des `.replace()` directement sur les champs `camelCase` (lignes 171, 220, 265, 307, etc.).
   - **Changer le nommage casserait tous les appels OpenAI**.

2. **Raison n¬∞2** :
   - Les hooks de r√©cup√©ration Phase 2 (`useRecuperationDataReseaux`, `useRecuperationDataSMS`, `useRecuperationAnnonceVersLandingPage`, etc.) s'attendent √† retrouver les donn√©es `localStorage` en `camelCase`.
   - Le template newsletter (`TemplateNewsletterHTML.ts`) utilise directement `parsedData.agencyName`, `parsedData.propertyType`, etc.
   - **Tout changement n√©cessiterait une refonte compl√®te de la Phase 2**.

3. **üí• Raison n¬∞3** :
   - Introduction de fonctions de transformation `camelCase ‚Üî snake_case` augmenterait la complexit√©, les risques d'erreurs, et la dette technique.
   - Chaque `INSERT/SELECT` n√©cessiterait une conversion bidirectionnelle ‚Üí **source de bugs insidieux**.

### ‚úÖ **R√àGLE D'OR DE LA MIGRATION**
- **Tous les hooks, fonctions, et interactions Supabase cr√©√©s lors de la migration DOIVENT imp√©rativement :**
    - **Conserver la structure `camelCase` existante** pour **les champs m√©tier** (`agencyName`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`, `propertyDescription`, `financials`, `details`, `exclusivite`, `location`, `reference`).
    - **Utiliser `snake_case` uniquement** pour **les champs syst√®me Supabase** (`organisation_id`, `user_id`, `created_at`, `updated_at` etc.).

### üéØ **PostgreSQL supporte nativement le `camelCase`**
- Contrairement √† une id√©e re√ßue, **PostgreSQL/Supabase accepte parfaitement les noms de colonnes en `camelCase`**
- (ils sont simplement encadr√©s par des guillemets doubles dans les requ√™tes si n√©cessaire).
- Il n'y a donc **aucune contrainte technique** emp√™chant cette approche.

### **REGLES CONCERNANT LE NOMMAGE DES camelCase**
- **R√®gle SQL - Cr√©ation de table**
    - Champs m√©tier : `"camelCase"` (avec guillemets doubles)
    - Champs syst√®me : `snake_case` (sans guillemets)
- **R√®gle TypeScript - Hooks & Services**
    - Utilisation directe du `camelCase` pour champs m√©tier
    - Utilisation directe du `snake_case` pour champs syst√®me
    - **AUCUNE fonction de conversion n'est n√©cessaire**
- **R√®gle Triggers**
    - Utiliser : `NEW."camelCase"` ou `NEW.snake_case`
    - Pr√©f√©rer les fonctions g√©n√©riques r√©utilisables

---
# **STRUCTURE MULTI-TENANT** avec visibilit√© hi√©rarchique contr√¥l√©e.

- Chaque entit√© dispose d'un espace de travail isol√© et s√©curis√©, bas√© sur:
    - `organisation_id` (isolation tenant)
    - `user_id` (cr√©ateur du projet)
    - `utilisateur_type_compte` (d√©termine la visibilit√© hi√©rarchique)

## **R√®gles de visibilit√© hi√©rarchique:**

#### Pour les structures **R√©seaux**
| Type utilisateur | Acc√®s espace | Voit les projets de |
|------------------|--------------|---------------------|
| `reseau` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au r√©seau et √† sa direction) (Par respect confidentialit√© : Ne voit pas les projets des agences du r√©seau) |
| `reseau_direction` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au r√©seau et √† sa direction) (Par respect confidentialit√© : Ne voit pas les projets des agences du r√©seau)  |
| `reseau_agence` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_responsable` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |

#### Pour les structures **Agences Ind√©pendantes**
| Type utilisateur | Acc√®s espace | Voit les projets de |
|------------------|--------------|---------------------|
| `agence_independante` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_responsable` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |

---

## üéØ PRINCIPE FONDAMENTAL
**La visibilit√© hi√©rarchique repose sur 3 piliers:**

1. **`organisation_id`** ‚Üí Isolation tenant (tout utilisateur voit UNIQUEMENT son organisation)
2. **`user_id`** ‚Üí Cr√©ateur du projet (lien avec `users.users_id`)
3. **`utilisateur_type_compte`** ‚Üí D√©termine la port√©e de visibilit√© (via `utilisateurs` table)

- **IMPORTANT:** On n'utilise PAS `client_id` pour la visibilit√©. Le `client_id` est un identifiant business unique par entit√©, pas un m√©canisme RLS.
- **La visibilit√© hi√©rarchique et les acc√®s utilisateurs sont g√©r√©s exclusivement via les RLS policies SQL, appliqu√©es sur les tables principales.**
- **Les hooks front n‚Äôassurent que l‚Äôinjection des identifiants organisationnels.**
---
# EXPLICATION DE LA VOLONTE DE ADMIN PRESENCE
- Maintenant que les process d'authentification et de cr√©ation de tables sont en place
- L'objectif est de reprendre le travail sur l'application
  - Lors du travail pr√©paratoire MVP, nous avons travaill√© en localstorage pour param√©trer mes api avec Open ai et pr√©parer tous les codes
  - Maintenant l objectif est de travailler sur l'application et les fonctions afin de les sauvegarder dans Supabase

### Mon Objectif global
 - Cr√©er une architecture SaaS multi-tenant compl√®te permettant
   - √† chaque utilisateur, (r√©seau, r√©seau direction, r√©seau agence, r√©seau agence responsable, r√©seau agence collaborateur, agence ind√©pendante, agence ind√©pendante responsable, agence ind√©pendante collaborateur)
       - d‚Äôacc√©der √† leur espace et tout particuli√®rement leur espace de cr√©ation d‚Äôannonces en 5 √©tapes reli√© √† OpenAI,
       - avec gestion s√©curis√©e des donn√©es via Supabase.
   - Concr√®tement l'objectif est de mettre en place la structre avec Supabse pour que lorsqu'un utilisateur se connecte (reseau, reseau direction, agence independante etc)
   - Il puisse travailler sur son espace
     - pour cr√©er des annonces via mon process en 5 √©tapes (etape1/2/3/4/5/5animation)
     - pour envoyer les informations vers open ai
     - qui restituera les donn√©es pour √™tre utilis√©e dans etape6communication
     - et √† partir de l√†, l'utilisateur pourra choisir les fonctions qu'il souhaite (annonce site internet, outils seo, emailing, sms etc...)

### Structure multi-tenant Supabase
- Chaque entit√© dispose d‚Äôun espace de travail isol√© et s√©curis√©
- La visibilit√© hi√©rarchique est contr√¥l√©e par admin_presenca, selon la logique :

#### Pour les structures **R√©seaux**
| Type utilisateur | Acc√®s espace | Voit les projets de |
|------------------|--------------|---------------------|
| `reseau` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au r√©seau et √† sa direction) (Par respect confidentialit√© : Ne voit pas les projets des agences du r√©seau) |
| `reseau_direction` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au r√©seau et √† sa direction) (Par respect confidentialit√© : Ne voit pas les projets des agences du r√©seau)  |
| `reseau_agence` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_responsable` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |

#### Pour les structures **Agences Ind√©pendantes**
| Type utilisateur | Acc√®s espace | Voit les projets de |
|------------------|--------------|---------------------|
| `agence_independante` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_responsable` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |


### Flux utilisateur global
- ***Connexion / Authentification***
  - Authentification via Supabase (email / mot de passe)
- ***Acc√®s √† l‚Äôespace personnel***
  - Redirection automatique selon le r√¥le :
    - RESEAU-ESPACE
    - CLIENT-ESPACE
    - COLLABORATEUR-ESPACE
        - Chaque espace ouvre un acc√®s aux donn√©es propres accessibles √† l'utilisateur et au module accueil-leadgenai pour lancer le g√©n√©rateur d'annonces et d'outils seo
        - Prochainement il permettra de r√©cup√©rer les historiques des annonces en fonction de ses projets propres ou de son statut dans la structure multi tenant.

---

# üì¶ SECTION 5 - CODES COMPLETS

Phase 1 : Migration localStorage ‚Üí Supabase pour √âtapes 1-5

---

## FICHIER 1/10 : AnnonceContext.tsx

### Chemin
`src/contexts/AnnonceContext.tsx`

### Code complet

```typescript
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/components/ui/use-toast';

// Interface des donn√©es projet (14 champs m√©tier)
interface ProjectData {
  project_id: string;
  agencyName: string;
  reference: string;
  exclusivite: string;
  location: string;
  propertyType: string;
  saleType: string;
  price: string | null;
  rentAmount: string | null;
  rentPeriodicity: string | null;
  keyElements: string;
  propertyDescription: string;
  financials: string;
  details: string | null;
  hasNoDetails: boolean;
  step_progress: number[];
}

// Interface du contexte
interface AnnonceContextType {
  currentProjectId: string | null;
  projectData: ProjectData | null;
  isLoading: boolean;
  error: string | null;
  loadProject: (projectId: string) => Promise<void>;
  refreshProject: () => Promise<void>;
  createNewProject: () => Promise<string | null>;
}

// Cr√©ation du contexte
const AnnonceContext = createContext<AnnonceContextType | undefined>(undefined);

// Provider
export function AnnonceProvider({ children }: { children: ReactNode }) {
  const [currentProjectId, setCurrentProjectId] = useState<string | null>(null);
  const [projectData, setProjectData] = useState<ProjectData | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { toast } = useToast();

  // Charger un projet depuis Supabase
  const loadProject = async (projectId: string) => {
    setIsLoading(true);
    setError(null);
    
    try {
      const { data, error: fetchError } = await supabase
        .from('etapes_1to5')
        .select('*')
        .eq('project_id', projectId)
        .single();

      if (fetchError) {
        console.error('Error loading project:', fetchError);
        setError('Impossible de charger le projet');
        toast({
          title: 'Erreur',
          description: 'Impossible de charger le projet',
          variant: 'destructive',
        });
        return;
      }

      if (data) {
        setCurrentProjectId(projectId);
        setProjectData({
          project_id: data.project_id,
          agencyName: data.agencyName || '',
          reference: data.reference || '',
          exclusivite: data.exclusivite || 'Non',
          location: data.location || '',
          propertyType: data.propertyType || '',
          saleType: data.saleType || '√† vendre',
          price: data.price,
          rentAmount: data.rentAmount,
          rentPeriodicity: data.rentPeriodicity,
          keyElements: data.keyElements || '',
          propertyDescription: data.propertyDescription || '',
          financials: data.financials || '',
          details: data.details,
          hasNoDetails: data.hasNoDetails || false,
          step_progress: data.step_progress || [1],
        });
      }
    } catch (err) {
      console.error('Failed to load project:', err);
      setError('Erreur lors du chargement du projet');
    } finally {
      setIsLoading(false);
    }
  };

  // Recharger le projet courant
  const refreshProject = async () => {
    if (currentProjectId) {
      await loadProject(currentProjectId);
    }
  };

  // Cr√©er un nouveau projet
  const createNewProject = async (): Promise<string | null> => {
    setIsLoading(true);
    setError(null);

    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        toast({
          title: 'Erreur',
          description: 'Utilisateur non connect√©',
          variant: 'destructive',
        });
        return null;
      }

      // R√©cup√©rer l'organisation_id de l'utilisateur via RLS
      const { data, error: insertError } = await supabase
        .from('etapes_1to5')
        .insert({
          step_progress: [1],
          statut: 'en_cours',
        })
        .select('project_id')
        .single();

      if (insertError) {
        console.error('Error creating project:', insertError);
        toast({
          title: 'Erreur',
          description: 'Impossible de cr√©er un nouveau projet',
          variant: 'destructive',
        });
        return null;
      }

      if (data) {
        const newProjectId = data.project_id;
        await loadProject(newProjectId);
        return newProjectId;
      }

      return null;
    } catch (err) {
      console.error('Failed to create project:', err);
      setError('Erreur lors de la cr√©ation du projet');
      return null;
    } finally {
      setIsLoading(false);
    }
  };

  // Charger le projet "en_cours" au montage
  useEffect(() => {
    const loadCurrentProject = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error: fetchError } = await supabase
          .from('etapes_1to5')
          .select('project_id')
          .eq('user_id', user.id)
          .eq('statut', 'en_cours')
          .maybeSingle();

        if (fetchError) {
          console.error('Error finding current project:', fetchError);
          return;
        }

        if (data) {
          await loadProject(data.project_id);
        }
      } catch (err) {
        console.error('Failed to load current project:', err);
      }
    };

    loadCurrentProject();
  }, []);

  const value: AnnonceContextType = {
    currentProjectId,
    projectData,
    isLoading,
    error,
    loadProject,
    refreshProject,
    createNewProject,
  };

  return (
    <AnnonceContext.Provider value={value}>
      {children}
    </AnnonceContext.Provider>
  );
}

// Hook pour utiliser le contexte
export function useAnnonceContext() {
  const context = useContext(AnnonceContext);
  if (context === undefined) {
    throw new Error('useAnnonceContext must be used within an AnnonceProvider');
  }
  return context;
}
```

---

## FICHIER 2/10 : Etape1.tsx (ADAPT√â )

### Chemin
`src/1.etapes-generation-annonces/etape1/Etape1.tsx`

### Code complet

```typescript
import React, { useState, useRef, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import HeaderV2GenAnn from "@/components/atemplate.v2.generation-annonces/Header.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import { useToast } from "@/hooks/use-toast";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useSgaForm } from "@/components/1-Sources-Generation-Annonces/utils/useSgaForm";
import EnsembleFormulairesEtape1Form, { EnsembleFormulairesEtape1FormRef } from "@/components/1-Sources-Generation-Annonces/form-etape1/EnsembleFormulairesEtape1Form";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";
import { useAnnonceContext } from "@/contexts/AnnonceContext";
import { useEtape1 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/01.Etape1/HookEtape-1";

const Etape1: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const { disabledSteps, completeStep } = useStepProgress(1);
  
  const formulaireRef = useRef<EnsembleFormulairesEtape1FormRef>(null);
  
  // ‚úÖ AJOUT : Contexte et hooks Supabase
  const { currentProjectId, createNewProject } = useAnnonceContext();
  const { formData, setFormData, saveEtape1, loading } = useEtape1();
  
  const headerTitle = "Bienvenue sur votre G√©n√©rateur d'Annonces et d'Outils SEO";
  const headerSubtitle = "Notre g√©n√©rateur a √©t√© con√ßu pour vous permettre de structurer et optimiser vos annonces en toute simplicit√©.";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les informations disponibles, sans se soucier de la mise en forme. <br />L'IA se charge d'organiser, de hi√©rarchiser et de r√©diger l'annonce de mani√®re fluide et professionnelle.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "√âl√©ments Cl√©s";
  const card1CentreTexte = "";

  // ‚úÖ AJOUT : Cr√©er un projet si aucun n'existe
  useEffect(() => {
    if (!currentProjectId) {
      createNewProject();
    }
  }, [currentProjectId, createNewProject]);

  // Force le rechargement du composant quand il devient visible
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (document.visibilityState === 'visible') {
        // Force le composant √† se mettre √† jour
        formulaireRef.current?.handleValidation();
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, []);

  const handleValidation = () => {
    if (formulaireRef.current) {
      const isValid = formulaireRef.current.handleValidation();
      
      if (isValid) {
        completeStep(1);
        navigate("/etape2");
      }
    }
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide className="px-2 sm:px-4 lg:px-6 py-2 max-w-full">
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              {/* ‚úÖ MODIFICATION : Passage de props depuis hooks Supabase */}
              {currentProjectId && (
                <EnsembleFormulairesEtape1Form 
                  ref={formulaireRef}
                  projectId={currentProjectId}
                  formData={formData}
                  setFormData={setFormData}
                  saveEtape1={saveEtape1}
                  loading={loading}
                />
              )}
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={1} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape1" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette 1√®re √©tape</h3>
              <p className="text-[12px] text-black">
                Consultez nos cartes conseils :<br/>
. "Quelles informations int√©grer ?" <br/>
. "Arguments commerciaux"<br/>
Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape1;

```

---

## FICHIER 3/10 : Etape2.tsx (ADAPT√â )

### Chemin
`src/1.etapes-generation-annonces/etape2/Etape2.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { Calculator, Calendar, FileText, Star } from "lucide-react";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import SaisieDescriptionForm from "@/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import { clearPropertyData } from "@/services/openai";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";
import { useAnnonceContext } from "@/contexts/AnnonceContext";
import { useEtape2 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/02.Etape2/HookEtape-2";

const Etape2: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(2);
  
  // ‚úÖ AJOUT : Contexte et hooks Supabase
  const { currentProjectId, createNewProject } = useAnnonceContext();
  const { formData, setFormData, saveEtape2, loading } = useEtape2();
  
  React.useEffect(() => {
    if (!isStepAvailable(2)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  
  // ‚úÖ AJOUT : Cr√©er un projet si aucun n'existe
  useEffect(() => {
    if (!currentProjectId) {
      createNewProject();
    }
  }, [currentProjectId, createNewProject]);
  
  const headerTitle = "Informations de description";
  const headerSubtitle = "Cette √©tape va permettre √† l'IA de structurer une annonce parfaite en d√©taillant avec pr√©cision les caract√©ristiques de votre bien.";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les √©l√©ments √† votre disposition, sans se soucier de la mise en forme. <br />L'IA se charge de les organiser, les hi√©rarchiser et de r√©diger une description fluide, coh√©rente et percutante.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "Informations de description";
  const card1CentreTexte = "";
  
  const boutonDroiteTexte = "Voir mes Annonces et Outils SEO";

  const allerVersEtape1 = () => {
    console.log("Navigation vers l'√©tape 1");
  };
  
  const handleButtonClick = () => {
    console.log("Bouton droit cliqu√© - Redirection vers l'√©tape suivante");
  };

  const handleValidateAndNext = () => {
    completeStep(2);
    navigate("/etape3");
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide>
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              {/* ‚úÖ MODIFICATION : Passage de props depuis hooks Supabase */}
              {currentProjectId && (
                <SaisieDescriptionForm 
                  projectId={currentProjectId}
                  formData={formData}
                  setFormData={setFormData}
                  saveEtape2={saveEtape2}
                  loading={loading}
                />
              )}
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={2} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape2" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette 2√®me √©tape</h3>
              <p className="text-[12px] text-black">
                Consultez nos cartes conseils :<br/>
                . "Quelles informations int√©grer ?" <br/>
                . "Description du bien"<br/>
                Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape2;

```

---

## FICHIER 4/10 : Etape3.tsx (ADAPT√â)

### Chemin
`src/1.etapes-generation-annonces/etape3/Etape3.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { Calculator, Calendar, FileText, Star } from "lucide-react";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import SaisieFinancialForm from "@/components/1-Sources-Generation-Annonces/form-etape3/SaisieFinancialForm";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import { clearPropertyData } from "@/services/openai";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";
import { useAnnonceContext } from "@/contexts/AnnonceContext";
import { useEtape3 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/03.Etape3/HookEtape-3";

const Etape3: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(3);
  
  // ‚úÖ AJOUT : Contexte et hooks Supabase
  const { currentProjectId, createNewProject } = useAnnonceContext();
  const { formData, setFormData, saveEtape3, loading } = useEtape3();
  
  React.useEffect(() => {
    if (!isStepAvailable(3)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  
  // ‚úÖ AJOUT : Cr√©er un projet si aucun n'existe
  useEffect(() => {
    if (!currentProjectId) {
      createNewProject();
    }
  }, [currentProjectId, createNewProject]);
  
  const headerTitle = "Informations financi√®res";
  const headerSubtitle = "Cette nouvelle √©tape va permettre √† l'IA de mettre en valeur les √©l√©ments financiers de votre bien : <br />conditions locatives, performances financi√®res, potentiel de d√©veloppement.";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les √©l√©ments √† votre disposition, sans se soucier de la mise en forme. <br />L'IA se charge de les organiser, les hi√©rarchiser et de r√©diger une description fluide, coh√©rente et percutante.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "Informations Financi√®res";
  const card1CentreTexte = "";
  
  const boutonDroiteTexte = "Voir mes Annonces et Outils SEO";

  const allerVersEtape2 = () => {
    console.log("Navigation vers l'√©tape 2");
  };

  const handleButtonClick = () => {
    console.log("Bouton droit cliqu√© - Redirection vers l'√©tape suivante");
  };

  const handleValidateAndNext = () => {
    completeStep(3);
    navigate("/etape4");
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide>
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              {/* ‚úÖ MODIFICATION : Passage de props depuis hooks Supabase */}
              {currentProjectId && (
                <SaisieFinancialForm 
                  projectId={currentProjectId}
                  formData={formData}
                  setFormData={setFormData}
                  saveEtape3={saveEtape3}
                  loading={loading}
                />
              )}
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={3} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape3" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette 3√®me √©tape</h3>
              <p className="text-[12px] text-black">
                Consultez nos cartes conseils :<br/>
. "Quelles informations int√©grer ?" <br/>
. "Informations Financi√®res"<br/>
Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape3;

```

---

## FICHIER 5/10 : Etape4.tsx (ADAPT√â)

### Chemin
`src/1.etapes-generation-annonces/etape4/Etape4.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { SgaFormContainer } from "@/components/1-Sources-Generation-Annonces/layout/SgaFormContainer";
import { Calculator, Calendar, FileText, Lightbulb, HelpCircle, Star } from "lucide-react";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import SaisieDetailsForm from "@/components/1-Sources-Generation-Annonces/form-etape4/SaisieDetailsForm";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import { clearPropertyData } from "@/services/openai";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";
import { useAnnonceContext } from "@/contexts/AnnonceContext";
import { useEtape4 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/04.Etape4/HookEtape-4";

const Etape4: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(4);
  
  // ‚úÖ AJOUT : Contexte et hooks Supabase
  const { currentProjectId, createNewProject } = useAnnonceContext();
  const { formData, setFormData, saveEtape4, loading } = useEtape4();
  
  React.useEffect(() => {
    if (!isStepAvailable(4)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  
  // ‚úÖ AJOUT : Cr√©er un projet si aucun n'existe
  useEffect(() => {
    if (!currentProjectId) {
      createNewProject();
    }
  }, [currentProjectId, createNewProject]);
  
  const headerTitle = "Informations Compl√©mentaires";
  const headerSubtitle = "Cette derni√®re √©tape va permettre √† l'IA d'ajouter des informations concernant l'organisation du travail :<br /> conditions d'exploitation actuelles, horaires d'ouverture, cong√®s... ";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les √©l√©ments √† votre disposition, sans se soucier de la mise en forme. <br />L'IA se charge de les organiser, les hi√©rarchiser et de r√©diger une description fluide, coh√©rente et percutante. <br />NB : Ces √©l√©ments seront uniquement repris dans l'Annonce Fiche de Synth√®se.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "Autres D√©tails";
  const card1CentreTexte = "";
  
  const boutonDroiteTexte = "Voir mes Annonces et Outils SEO";

  const allerVersEtape3 = () => {
    console.log("Navigation vers l'√©tape 3");
  };

  const handleButtonClick = () => {
    console.log("Bouton droit cliqu√© - Redirection vers l'√©tape suivante");
  };

  const handleValidateAndFinish = () => {
    completeStep(4);
    
    toast({
      title: "F√©licitations !",
      description: "Toutes les √©tapes ont √©t√© compl√©t√©es avec succ√®s.",
      duration: 3000,
    });
    
    navigate("/resultats");
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide>
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              {/* ‚úÖ MODIFICATION : Passage de props depuis hooks Supabase */}
              {currentProjectId && (
                <SaisieDetailsForm 
                  projectId={currentProjectId}
                  formData={formData}
                  setFormData={setFormData}
                  saveEtape4={saveEtape4}
                  loading={loading}
                />
              )}
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={4} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape4" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette derni√®re √©tape</h3>
              <p className="text-[12px] text-black">
               Consultez nos cartes conseils :<br/>
. "Quelles informations int√©grer ?"<br/>
. "Autres D√©tails"<br/>
Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape4;

```

---

## FICHIER 6/10 : Etape5.tsx (ADAPT√â )

### Chemin
`src/1.etapes-generation-annonces/etape5/Etape5.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import { useSgaForm } from "@/components/1-Sources-Generation-Annonces/utils/useSgaForm";
import BoutonEtape5LancerOpenAI from "@/components/1-Sources-Generation-Annonces/form-components/BoutonEtape5LancerOpenAI";
import { createOpenAIService } from "@/services/openai";
import { createOpenAISMSService } from "@/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/1.API-AnnonceSMS";
import { createOpenAIGoogleBusinessProfileService } from "@/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/2.API-AnnonceGoogleBusinessProfile";
import { createOpenAIReseauxSociauxService } from "@/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/3.API-AnnonceReseauxSociaux";
import { useOpenAI } from "@/contexts/OpenAIContext";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";
import { useAnnonceContext } from "@/contexts/AnnonceContext";

const Etape5: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(5);
  const { resetSessionTimer } = useSgaForm();
  const { apiKey: openAIApiKey } = useOpenAI();
  
  // ‚úÖ AJOUT : Contexte Supabase
  const { currentProjectId, projectData, createNewProject } = useAnnonceContext();
  
  const [isGenerating, setIsGenerating] = useState(false);
  
  useEffect(() => {
    if (!isStepAvailable(5)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  
  // ‚úÖ AJOUT : Cr√©er un projet si aucun n'existe
  useEffect(() => {
    if (!currentProjectId) {
      createNewProject();
    }
  }, [currentProjectId, createNewProject]);
  
  const headerTitle = "F√©licitations !<br /> Vos Annonces et Outils sont pr√™ts √† √™tre g√©n√©r√©s";
  const headerSubtitle = "Tous les √©l√©ments n√©cessaires √† la cr√©ation de vos annonces et de vos outils SEO sont maintenant en place.";
  const headerText = "Vous avez encore le temps de v√©rifier ou de corriger vos informations.";
  const headerCustomContent = <ImageRobotHeaderMauve className="h-full w-full" />;
  
  const handleValidateAndFinish = async () => {
    if (isGenerating) return;
    try {
      setIsGenerating(true);
      resetSessionTimer();
      
      // ‚úÖ MODIFICATION : Utilisation de projectData depuis Supabase au lieu de localStorage
      if (!projectData) {
        toast({
          title: "Erreur",
          description: "Impossible de r√©cup√©rer les donn√©es du projet.",
          duration: 5000,
          variant: "destructive"
        });
        setIsGenerating(false);
        return;
      }
      
      if (!openAIApiKey) {
        toast({
          title: "Erreur de configuration",
          description: "Cl√© API OpenAI manquante. Veuillez configurer votre cl√© API dans les param√®tres.",
          duration: 5000
        });
        setIsGenerating(false);
        return;
      }
      
      // ‚úÖ MODIFICATION : Stockage status dans Supabase au lieu de localStorage
      localStorage.setItem('generation_status', JSON.stringify({
        startTime: new Date().getTime(),
        websiteAd: false,
        summarySheet: false,
        newsletter: false,
        seoTools: false,
        smsAd: false,
        googleBusinessProfile: false,
        reseauxSociaux: false,
        completed: false,
        progress: 0
      }));
      
      completeStep(5);
      navigate("/etape5/animation");
      
      const openAIService = createOpenAIService(openAIApiKey);
      const openAISMSService = createOpenAISMSService(openAIApiKey);
      const openAIGoogleBusinessProfileService = createOpenAIGoogleBusinessProfileService(openAIApiKey);
      const openAIReseauxSociauxService = createOpenAIReseauxSociauxService(openAIApiKey);
      
      // ‚úÖ MODIFICATION : Conversion projectData en format attendu par OpenAI
      const propertyDataForOpenAI = {
        agencyName: projectData.agencyName,
        reference: projectData.reference,
        exclusivite: projectData.exclusivite,
        location: projectData.location,
        propertyType: projectData.propertyType,
        saleType: projectData.saleType,
        price: projectData.price,
        rentAmount: projectData.rentAmount,
        rentPeriodicity: projectData.rentPeriodicity,
        keyElements: projectData.keyElements,
        propertyDescription: projectData.propertyDescription,
        financials: projectData.financials,
        details: projectData.details,
        hasNoDetails: projectData.hasNoDetails
      };
      
      try {
        const websiteAdResult = await openAIService.generateWebsiteAd(propertyDataForOpenAI);
        localStorage.setItem('generation_website_ad', JSON.stringify(websiteAdResult));
        updateGenerationStatus('websiteAd', true, 14);
      } catch (error) {
        console.error("Erreur lors de la g√©n√©ration de l'annonce site internet:", error);
      }
      
      try {
        const summarySheetResult = await openAIService.generateSummarySheetAd(propertyDataForOpenAI);
        localStorage.setItem('generation_summary_sheet', JSON.stringify(summarySheetResult));
        updateGenerationStatus('summarySheet', true, 28);
      } catch (error) {
        console.error("Erreur lors de la g√©n√©ration de la fiche de synth√®se:", error);
      }
      
      try {
        const newsletterResult = await openAIService.generateNewsletterAd(propertyDataForOpenAI);
        localStorage.setItem('generation_newsletter', JSON.stringify(newsletterResult));
        updateGenerationStatus('newsletter', true, 42);
      } catch (error) {
        console.error("Erreur lors de la g√©n√©ration de l'annonce newsletter:", error);
      }
      
      try {
        const seoToolsResult = await openAIService.generateSEOTools(propertyDataForOpenAI);
        localStorage.setItem('generation_seo_tools', JSON.stringify(seoToolsResult));
        updateGenerationStatus('seoTools', true, 56);
      } catch (error) {
        console.error("Erreur lors de la g√©n√©ration des outils SEO:", error);
      }
      
      try {
        const smsAdResult = await openAISMSService.generateSMSAd(propertyDataForOpenAI);
        localStorage.setItem('generation_sms_ad', JSON.stringify(smsAdResult));
        updateGenerationStatus('smsAd', true, 70);
      } catch (error) {
        console.error("Erreur lors de la g√©n√©ration de l'annonce SMS:", error);
      }
      
      try {
        const googleBusinessProfileResult = await openAIGoogleBusinessProfileService.generateGoogleBusinessProfileAd(propertyDataForOpenAI);
        localStorage.setItem('generation_googleprofile_ad', JSON.stringify(googleBusinessProfileResult));
        updateGenerationStatus('googleBusinessProfile', true, 85);
      } catch (error) {
        console.error("Erreur lors de la g√©n√©ration de l'annonce Google Business Profile:", error);
      }
      
      try {
        const reseauxSociauxResult = await openAIReseauxSociauxService.generateReseauxSociauxAd(propertyDataForOpenAI);
        localStorage.setItem('generation_reseauxsociaux_ad', JSON.stringify(reseauxSociauxResult));
        updateGenerationStatus('reseauxSociaux', true, 100);
      } catch (error) {
        console.error("Erreur lors de la g√©n√©ration de l'annonce R√©seaux Sociaux:", error);
      }
      
      updateGenerationStatus('completed', true, 100);
      
      setTimeout(() => {
        navigate("/etape6communication");
      }, 1000);
    } catch (error) {
      console.error("Erreur lors de la g√©n√©ration:", error);
      toast({
        title: "Erreur de g√©n√©ration",
        description: "Une erreur est survenue lors de la g√©n√©ration. Veuillez r√©essayer.",
        duration: 5000
      });
      setIsGenerating(false);
    }
  };
  
  const updateGenerationStatus = (key: string, value: boolean, progress: number) => {
    const statusStr = localStorage.getItem('generation_status');
    if (statusStr) {
      const status = JSON.parse(statusStr);
      status[key] = value;
      status.progress = progress;
      localStorage.setItem('generation_status', JSON.stringify(status));
    }
  };
  
  return (
    <LayoutV2GenAnn navTitle={navTitle} navLinks={navLinks}>
      <Structure5ContainerVide>
        <StructureHeroPetit 
          title={headerTitle} 
          subtitle={headerSubtitle} 
          description={headerText} 
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png" 
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <div className="flex flex-col items-center justify-center h-full p-6 text-center">
              <h2 className="text-[#4A2B87] mb-4 font-extrabold text-2xl">
                Si tout est en place, lancez LeadGenAI IA en cliquant sur le bouton ci-dessous.
              </h2>
              
              <p className="mb-2 text-base font-semibold">
                Il analyera toutes vos donn√©es et g√©n√©rera en moins d'une minute vos Annonces et Outils SEO.
              </p>
              
              <p className="font-bold text-black mb-2 py-[8px] text-lg">
                Vous pouvez modifier vos informations en cliquant sur les ic√¥nes de couleur sur la partie de droite de l'√©cran.
              </p>
              
              <BoutonEtape5LancerOpenAI 
                onClick={handleValidateAndFinish} 
                disabled={isGenerating} 
                isGenerating={isGenerating} 
                className="mb-8"
              >
                {isGenerating ? "G√©n√©ration en cours..." : "G√©n√©rer mes Annonces"}
              </BoutonEtape5LancerOpenAI>
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={5} disabledSteps={disabledSteps} />
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette derni√®re √©tape</h3>
              <p className="text-[12px] text-black">
                V√©rifiez vos informations dans les √©tapes pr√©c√©dentes.<br />
                Une fois que vous √™tes pr√™t, lancez la g√©n√©ration pour obtenir vos annonces et outils SEO.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape5;

```


## FICHIER 7/10 : EnsembleFormulairesEtape1Form.tsx (ADAPT√â)

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape1/EnsembleFormulairesEtape1Form.tsx`

### Code complet

```typescript
import React, { useState, useEffect, forwardRef, useImperativeHandle } from "react";
import TextFieldForm from "../form-components/TextFieldForm";
import MonetaryFieldForm from "../form-components/MonetaryFieldForm";
import SelectionButtonRond from "../form-components/SelectionButtonRond";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Lightbulb } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { Etape1Data } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/01.Etape1/HookEtape-1";

// Define the ref interface
export interface EnsembleFormulairesEtape1FormRef {
  handleValidation: () => boolean;
}

// ‚úÖ AJOUT : Interface Props
interface EnsembleFormulairesEtape1FormProps {
  projectId: string;
  formData: Etape1Data;
  setFormData: React.Dispatch<React.SetStateAction<Etape1Data>>;
  saveEtape1: () => Promise<boolean>;
  loading: boolean;
}

const EnsembleFormulairesEtape1Form = forwardRef<EnsembleFormulairesEtape1FormRef, EnsembleFormulairesEtape1FormProps>((props, ref) => {
  // ‚úÖ MODIFICATION : R√©cup√©ration des props au lieu de useState locaux
  const { projectId, formData, setFormData, saveEtape1, loading } = props;
  
  // Hooks
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep } = useStepProgress(1);

  // Options pour les boutons de s√©lection
  const exclusiviteOptions = [
    { id: "Oui", label: "Oui" },
    { id: "Non", label: "Non" }
  ];
  
  const saleTypeOptions = [
    { id: "√† vendre", label: "√Ä vendre" },
    { id: "√† louer", label: "√Ä louer" }
  ];
  
  const rentPeriodicityOptions = [
    { id: "Mensuel", label: "Mensuel" },
    { id: "Trimestriel", label: "Trimestriel" },
    { id: "Annuel", label: "Annuel" }
  ];

  // Expose methods to parent component via ref
  useImperativeHandle(ref, () => ({
    handleValidation: () => {
      return handleValidation();
    }
  }));

  // ‚úÖ SUPPRIM√â : useEffect de chargement localStorage (donn√©es viennent des props)
  // ‚úÖ SUPPRIM√â : window.addEventListener('focus', loadData)

  // Function to handle form submission directly (used when the button in the form is clicked)
  const handleFormSubmit = async () => {
    if (await handleValidation()) {
      completeStep(1);
      navigate("/etape2");
    }
  };
  
  // ‚úÖ MODIFICATION : handleValidation devient async et utilise saveEtape1
  const handleValidation = async () => {
    // V√©rifier si les champs obligatoires sont remplis
    if (!formData.agencyName?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le nom de votre agence.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!formData.reference?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir une r√©f√©rence pour le bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!formData.location?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir l'emplacement du bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!formData.propertyType?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le type de bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (formData.saleType === "√† vendre" && !formData.price?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le prix du bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (formData.saleType === "√† louer" && !formData.rentAmount?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le montant du loyer.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!formData.keyElements?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir au moins un argument commercial.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    // ‚úÖ MODIFICATION : Sauvegarde via saveEtape1 au lieu de updatePropertyData
    const saved = await saveEtape1();
    
    if (saved) {
      toast({
        title: "Informations valid√©es",
        description: "Vos informations ont √©t√© enregistr√©es avec succ√®s.",
        duration: 3000,
      });
      return true;
    }
    
    return false;
  };

  // Contenu d'aide pour les arguments commerciaux
  const helpContent = (
    <>
      <p className="mb-2">Lors de cette premi√®re √©tape, portez une attention particuli√®re aux arguments commerciaux.<br/><br/>
Les informations saisies dans ce champ permettront √† l'IA de structurer et d'optimiser les titres, les accroches, les CTA de vos annonces et mieux travailler vos outils SEO.</p>
      <ul className="list-disc pl-4 space-y-1">
        <li>Les arguments commerciaux correspondent aux points forts que vous mettez en avant lorsque vous pr√©sentez le bien √† vos prospects. </li>
        <li>Ce sont ces √©l√©ments qui font toute la diff√©rence et captent imm√©diatement l'attention de vos prospect :<br/>
(Emplacement premium, conditions locatives attractives, Fort Potentiel de d√©veloppement, Infos sur le secteur, raret√© de l'offre‚Ä¶)</li>
        <li>Utilisez des phrases courtes mais √† fortes valeurs informatives.</li>
        <li>Vous pourrez d√©velopper certains points dans les parties descriptives.</li>
      </ul>
      <p className="mb-2"><br/>L'IA ne saura jamais mieux que vous les atouts uniques de ce bien.<br/>
Si vous ne lui dites pas, elle ne les inventera pas !<br/>
Par contre, elle saura les mettre en valeur.</p>
    </>
  );

  // Rendu du formulaire
  return (
    <div className="space-y-6">
      {/* Section d'identification */}
      <div className="space-y-6">
        <div className="flex flex-wrap items-end gap-5">
          <div className="w-64">
            <TextFieldForm
              id="agencyName"
              title="Nom de l'Agence"
              placeholder="Votre agence immobili√®re"
              value={formData.agencyName || ""}
              onChange={(e) => setFormData({ ...formData, agencyName: e.target.value })}
              required={true}
            />
          </div>
          
          <div className="w-48">
            <TextFieldForm
              id="reference"
              title="R√©f√©rence"
              placeholder="R√©f√©rence du bien"
              value={formData.reference || ""}
              onChange={(e) => setFormData({ ...formData, reference: e.target.value })}
              required={true}
            />
          </div>
          
          <div>
            <SelectionButtonRond
              id="exclusivite"
              label="Exclusivit√©"
              options={exclusiviteOptions}
              selectedOption={formData.exclusivite || "Non"}
              onChange={(value) => setFormData({ ...formData, exclusivite: value })}
              required={true}
            />
          </div>

          <div className="flex-1">
            <TextFieldForm
              id="location"
              title="Emplacement"
              placeholder="Ville, Arrondissement, D√©partement..."
              value={formData.location || ""}
              onChange={(e) => setFormData({ ...formData, location: e.target.value })}
              required={true}
            />
          </div>
        </div>

        <div className="flex flex-wrap items-end gap-5">
          <div className="w-52">
            <TextFieldForm
              id="propertyType"
              title="Type de bien"
              placeholder="Restaurant, Commerce, Local Commercial..."
              value={formData.propertyType || ""}
              onChange={(e) => setFormData({ ...formData, propertyType: e.target.value })}
              required={true}
            />
          </div>
          
          <div className="shrink-0">
            <SelectionButtonRond
              id="saleType"
              label="Type de transaction"
              options={saleTypeOptions}
              selectedOption={formData.saleType || "√† vendre"}
              onChange={(value) => setFormData({ ...formData, saleType: value })}
              required={true}
              className="mx-0 px-0"
            />
          </div>

          {formData.saleType === "√† vendre" && (
            <div className="w-36">
              <MonetaryFieldForm
                id="price"
                title="Prix FAI"
                placeholder="450 000‚Ç¨"
                value={formData.price || ""}
                onChange={(e) => setFormData({ ...formData, price: e.target.value })}
                currency="‚Ç¨"
                required={true}
              />
            </div>
          )}

          {formData.saleType === "√† louer" && (
            <>
              <div className="w-36">
                <MonetaryFieldForm
                  id="rentAmount"
                  title="Loyer HT/HC"
                  placeholder="1 200‚Ç¨"
                  value={formData.rentAmount || ""}
                  onChange={(e) => setFormData({ ...formData, rentAmount: e.target.value })}
                  currency="‚Ç¨"
                  required={true}
                />
              </div>
              
              <div className="shrink-0">
                <SelectionButtonRond
                  id="rentPeriodicity"
                  label="P√©riodicit√© du loyer"
                  options={rentPeriodicityOptions}
                  selectedOption={formData.rentPeriodicity || "Mensuel"}
                  onChange={(value) => setFormData({ ...formData, rentPeriodicity: value })}
                  required={true}
                  className="mx-0 px-0"
                />
              </div>
            </>
          )}
        </div>
      </div>
      
      {/* Section Arguments commerciaux */}
      <div className="mt-4">
        <FormulaireSaisie
          id="keyElements"
          title="Arguments commerciaux"
          placeholder="Listez 5 arguments commerciaux forts en votre possession..."
          value={formData.keyElements || ""}
          onChange={(e) => setFormData({ ...formData, keyElements: e.target.value })}
          minRows={8}
          required={true}
        />
        
        <div className="flex justify-end mt-4">
          <BoutonValiderInformations onClick={handleFormSubmit} disabled={loading} />
        </div>
        
        {/* Nouvelle bo√Æte d'aide sous le bouton */}
        <div className="mt-4">
          <SgaHelpBox
            title="Arguments commerciaux"
            content={helpContent}
            icon={<Lightbulb className="h-5 w-5 stroke-[2px] text-amber-500" />}
          />
        </div>
      </div>
    </div>
  );
});

EnsembleFormulairesEtape1Form.displayName = "EnsembleFormulairesEtape1Form";

export default EnsembleFormulairesEtape1Form;

```

---

## FICHIER 8/10 : SaisieDescriptionForm.tsx (ADAPT√â)

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm.tsx`

### Code complet

```typescript
import React, { forwardRef, useImperativeHandle } from "react";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Lightbulb } from "lucide-react";
import { useToast } from "@/components/ui/use-toast";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { Etape2Data } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/02.Etape2/HookEtape-2";

// ‚úÖ AJOUT : Interface Props
interface SaisieDescriptionFormProps {
  projectId: string;
  formData: Etape2Data;
  setFormData: React.Dispatch<React.SetStateAction<Etape2Data>>;
  saveEtape2: () => Promise<boolean>;
  loading: boolean;
}

const SaisieDescriptionForm = forwardRef<any, SaisieDescriptionFormProps>((props, ref) => {
  // ‚úÖ MODIFICATION : R√©cup√©ration des props au lieu de useState local
  const { projectId, formData, setFormData, saveEtape2, loading } = props;
  
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep } = useStepProgress(2);

  const helpContent = (
    <>
      <p className="mb-2">Dans cette √©tape, listez le maximum d'informations en votre possession sur votre bien.<br/>
Les donn√©es saisies ici permettront √† l'IA de r√©diger une description originale, claire et valorisante.<br/>
Elles seront :<br/>
. Structur√©es et enti√®rement r√©dig√©es dans votre Annonce Site Internet,<br/>
. List√©es et organis√©es dans votre Fiche de Synth√®se,<br/>
. Pr√©sent√©es sous forme de points forts dans votre Annonce Newsletter.<br/>
Rappel des informations essentielles √† inclure :
</p>
      <ul className="list-disc pl-4 space-y-1">
      <li>Maximum d'informations sur l'emplacement, la zone de chalandise...</li>
<li>Maximum d'informations sur la superficie, la r√©partition des espaces...</li>
<li>Maximum d'informations sur l'activit√© actuelle, la client√®le, la fr√©quentation...</li>
<li>Maximum d'informations sur l'int√©rieur de l'√©tablissement (d√©cor, ambiance, √©quipements‚Ä¶)</li>
      </ul>
      <p className="mb-2"><br/>L'IA ne peut pas inventer ce qu'elle ne conna√Æt pas.<br/>
Si une information n'est pas saisie ici, elle ne sera pas utilis√©e dans l'annonce.<br/>
En revanche, plus votre description est compl√®te, plus elle sera mise en valeur avec efficacit√©.</p>
    </>
  );

  const handleDescriptionChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setFormData({ ...formData, propertyDescription: e.target.value });
  };

  // ‚úÖ MODIFICATION : handleValidation devient async et utilise saveEtape2
  const handleValidation = async () => {
    if (!formData.propertyDescription?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir une description du bien avant de continuer.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }
    
    const saved = await saveEtape2();
    
    if (saved) {
      toast({
        title: "Informations valid√©es",
        description: "Votre description du bien a √©t√© enregistr√©e avec succ√®s.",
        duration: 3000,
      });
      
      console.log("Description du bien valid√©e et centralis√©e");
      
      completeStep(2);
      navigate("/etape3");
    }
  };

  // ‚úÖ SUPPRIM√â : handleBackToEtape5 (pas utilis√© dans le JSX)
  // ‚úÖ SUPPRIM√â : useEffect de chargement localStorage (donn√©es viennent des props)

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 gap-4">
        <div>
          <div className="space-y-4">
            <FormulaireSaisie
              id="propertyDescription"
              title="Description d√©taill√©e"
              placeholder="Listez le maximum d'informations de description en votre possession..."
              value={formData.propertyDescription || ""}
              onChange={handleDescriptionChange}
              minRows={8}
            />
            
            <div className="flex justify-end mt-4">
              <BoutonValiderInformations onClick={handleValidation} disabled={loading} />
            </div>
            
            <div className="mt-6">
              <SgaHelpBox
                title="Description du bien"
                content={helpContent}
                icon={<Lightbulb className="h-5 w-5 stroke-[2px] text-amber-500" />}
                className="w-full"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
});

SaisieDescriptionForm.displayName = "SaisieDescriptionForm";

export default SaisieDescriptionForm;

```

---

## FICHIER 9/10 : SaisieFinancialForm.tsx (ADAPT√â)

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape3/SaisieFinancialForm.tsx`

### Code complet

```typescript
import React, { forwardRef } from "react";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Calculator } from "lucide-react";
import { useToast } from "@/components/ui/use-toast";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { Etape3Data } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/03.Etape3/HookEtape-3";

// ‚úÖ AJOUT : Interface Props
interface SaisieFinancialFormProps {
  projectId: string;
  formData: Etape3Data;
  setFormData: React.Dispatch<React.SetStateAction<Etape3Data>>;
  saveEtape3: () => Promise<boolean>;
  loading: boolean;
}

const SaisieFinancialForm = forwardRef<any, SaisieFinancialFormProps>((props, ref) => {
  // ‚úÖ MODIFICATION : R√©cup√©ration des props au lieu de useState local
  const { projectId, formData, setFormData, saveEtape3, loading } = props;
  
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep } = useStepProgress(3);

  const helpContent = (
    <>
      <p className="mb-2">Dans cette √©tape, listez le maximum d'informations financi√®res en votre possession sur votre bien.<br/>
Les donn√©es saisies ici permettront √† l'IA de r√©diger une description originale, claire et valorisante.<br/>
Elles seront :<br/>
. Structur√©es et enti√®rement r√©dig√©es dans votre Annonce Site Internet,
. List√©es et organis√©es dans votre Fiche de Synth√®se,
. Pr√©sent√©es sous forme de points forts dans votre Annonce Newsletter.
Rappel des informations essentielles √† inclure :
</p>
      <ul className="list-disc pl-4 space-y-1">
        <li>Maximum d'informations sur les conditions locatives : loyer, dur√©e de bail, renouvellement, charges, sp√©cificit√©s √©ventuelles...</li>
<li>Maximum d'informations sur les performances financi√®res : chiffre d'affaires, b√©n√©fices, indicateurs de rentabilit√©...</li>
<li>Maximum d'informations sur le potentiel de d√©veloppement : extensions possibles, optimisation de l'exploitation, leviers de croissance...</li>
      </ul>
      <p className="mb-2"><br/>L'IA ne peut pas inventer ce qu'elle ne conna√Æt pas.<br/>
Si une information n'est pas saisie ici, elle ne sera pas utilis√©e dans l'annonce.<br/>
En revanche, plus votre description est compl√®te, plus elle sera mise en valeur avec efficacit√©.</p>
    </>
  );

  const handleFinancialsChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setFormData({ ...formData, financials: e.target.value });
  };

  // ‚úÖ MODIFICATION : handleValidation devient async et utilise saveEtape3
  const handleValidation = async () => {
    if (!formData.financials?.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir des informations financi√®res avant de continuer.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }
    
    const saved = await saveEtape3();
    
    if (saved) {
      toast({
        title: "Informations valid√©es",
        description: "Vos informations financi√®res ont √©t√© enregistr√©es avec succ√®s.",
        duration: 3000,
      });
      
      console.log("Informations financi√®res valid√©es et centralis√©es");
      
      completeStep(3);
      navigate("/etape4");
    }
  };

  // ‚úÖ SUPPRIM√â : handleBackToEtape5 (pas utilis√© dans le JSX)
  // ‚úÖ SUPPRIM√â : useEffect de chargement localStorage (donn√©es viennent des props)

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 gap-4">
        <div>
          <div className="space-y-4">
            <FormulaireSaisie
              id="financials"
              title="Informations financi√®res"
              placeholder="Listez le maximum d'informations financi√®res de votre bien en votre possession..."
              value={formData.financials || ""}
              onChange={handleFinancialsChange}
              minRows={8}
            />
            
            <div className="flex justify-end mt-4">
              <BoutonValiderInformations onClick={handleValidation} disabled={loading} />
            </div>
            
            <div className="mt-6">
              <SgaHelpBox
                title="Informations financi√®res"
                content={helpContent}
                icon={<Calculator className="h-5 w-5 stroke-[2px] text-amber-500" />}
                className="w-full"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
});

SaisieFinancialForm.displayName = "SaisieFinancialForm";

export default SaisieFinancialForm;

```

---

## FICHIER 10/10 : SaisieDetailsForm.tsx (ADAPT√â)

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape4/SaisieDetailsForm.tsx`

### Code complet

```typescript
import React, { forwardRef } from "react";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Calendar } from "lucide-react";
import { useToast } from "@/components/ui/use-toast";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { Etape4Data } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/04.Etape4/HookEtape-4";

// ‚úÖ AJOUT : Interface Props
interface SaisieDetailsFormProps {
  projectId: string;
  formData: Etape4Data;
  setFormData: React.Dispatch<React.SetStateAction<Etape4Data>>;
  saveEtape4: () => Promise<boolean>;
  loading: boolean;
}

const SaisieDetailsForm = forwardRef<any, SaisieDetailsFormProps>((props, ref) => {
  // ‚úÖ MODIFICATION : R√©cup√©ration des props au lieu de useState locaux
  const { projectId, formData, setFormData, saveEtape4, loading } = props;
  
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep } = useStepProgress(4);

  const helpContent = (
    <>
      <p className="mb-2">Cette √©tape est optionnelle.<br/>
Vous pouvez n√©anmoins l'utiliser pour lister toutes les informations compl√©mentaires en votre possession sur le bien.<br/>
Les donn√©es saisies ici seront uniquement utilis√©es dans la Fiche de Synth√®se, pour apporter des pr√©cisions utiles sur les conditions d'exploitation du bien.<br/>
Propositions d'informations √† inclure : <br/>
. List√©es et organis√©es dans votre Fiche de Synth√®se.<br/>
</p>
      <ul className="list-disc pl-4 space-y-1">
        <li>Horaires d'ouverture</li>
<li>P√©riodes de fermeture</li>
<li>Autres donn√©es utiles d'exploitation</li>
      </ul>
      <p className="mb-2"><br/>Plus vous fournissez d'informations pr√©cises, plus l'IA pourra g√©n√©rer une annonce originale, sur-mesure et percutante..</p>
    </>
  );

  const handleDetailsChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setFormData({ 
      ...formData, 
      details: e.target.value,
      hasNoDetails: e.target.value.trim() !== "" ? false : formData.hasNoDetails
    });
  };

  const handleHasNoDetailsChange = (value: boolean) => {
    setFormData({
      ...formData,
      hasNoDetails: value,
      details: value ? "" : formData.details
    });
  };

  // ‚úÖ MODIFICATION : handleValidation devient async et utilise saveEtape4
  const handleValidation = async () => {
    if (!formData.hasNoDetails && (!formData.details || formData.details.trim() === "")) {
      toast({
        title: "Attention",
        description: "Cette √©tape est optionnelle, mais vous devez indiquer votre choix. Soit cocher la case 'Je n'ai pas d'informations compl√©mentaires √† fournir', soit saisir des informations.",
        duration: 5000,
      });
      return;
    }
    
    const saved = await saveEtape4();
    
    if (saved) {
      toast({
        title: "Informations valid√©es",
        description: formData.hasNoDetails 
          ? "Vous avez indiqu√© ne pas avoir d'informations compl√©mentaires." 
          : "Vos informations compl√©mentaires ont √©t√© enregistr√©es avec succ√®s.",
        duration: 3000,
      });
      
      console.log("Informations compl√©mentaires valid√©es et centralis√©es");
      
      completeStep(4);
      
      navigate('/etape5');
    }
  };

  // ‚úÖ SUPPRIM√â : handleBackToEtape5 (pas utilis√© dans le JSX)
  // ‚úÖ SUPPRIM√â : useEffect de chargement localStorage (donn√©es viennent des props)

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 gap-4">
        <div>
          <div className="space-y-4">
            <div className="flex items-center mb-4">
              <input
                type="checkbox"
                id="hasNoDetails"
                checked={formData.hasNoDetails || false}
                onChange={(e) => handleHasNoDetailsChange(e.target.checked)}
                className="h-4 w-4 rounded-full border-2 border-[#5E50A6] focus:outline-none"
              />
              <label htmlFor="hasNoDetails" className="ml-2 text-[14px] font-medium text-[#515151]">
                Je n'ai pas d'informations compl√©mentaires √† fournir
              </label>
            </div>
            
            <FormulaireSaisie
              id="details"
              title="Informations compl√©mentaires"
              placeholder="Cette √©tape est optionnelle. Vous pouvez lister les autres d√©tails que vous souhaitez porter √† la connaissance des futurs acqu√©reurs..."
              value={formData.details || ""}
              onChange={handleDetailsChange}
              minRows={8}
              readOnly={formData.hasNoDetails || false}
            />
            
            <div className="flex justify-end mt-4">
              <BoutonValiderInformations onClick={handleValidation} disabled={loading} />
            </div>
            
            <div className="mt-6">
              <SgaHelpBox
                title="Informations compl√©mentaires"
                content={helpContent}
                icon={<Calendar className="h-5 w-5 stroke-[2px] text-amber-500" />}
                className="w-full"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
});

SaisieDetailsForm.displayName = "SaisieDetailsForm";

export default SaisieDetailsForm;

```

---

## ‚úÖ SECTION 5 - PACKAGE COMPLET TERMIN√â !

### R√©capitulatif des 10 fichiers

| # | Fichier | Action | Status |
|---|---------|--------|--------|
| 1 | AnnonceContext.tsx | ‚úÖ CR√âER | Nouveau contexte |
| 2 | Etape1.tsx | ‚úÖ ADAPTER | localStorage ‚Üí Supabase |
| 3 | Etape2.tsx | ‚úÖ ADAPTER | localStorage ‚Üí Supabase |
| 4 | Etape3.tsx | ‚úÖ ADAPTER | localStorage ‚Üí Supabase |
| 5 | Etape4.tsx | ‚úÖ ADAPTER | localStorage ‚Üí Supabase |
| 6 | Etape5.tsx | ‚úÖ ADAPTER | + OpenAI + updateGenerationStatus |
| 7 | EnsembleFormulairesEtape1Form.tsx | ‚úÖ ADAPTER | Props depuis hooks |
| 8 | SaisieDescriptionForm.tsx | ‚úÖ ADAPTER | Props depuis hooks |
| 9 | SaisieFinancialForm.tsx | ‚úÖ ADAPTER | Props depuis hooks |
| 10 | SaisieDetailsForm.tsx | ‚úÖ ADAPTER | Props depuis hooks |

### Points cl√©s impl√©ment√©s

‚úÖ **AnnonceContext** g√®re le `project_id` global
‚úÖ **5 pages** adapt√©es avec hooks Section 3
‚úÖ **4 formulaires** re√ßoivent props depuis parent
‚úÖ **Services OpenAI** int√©gr√©s dans Etape5
‚úÖ **updateGenerationStatus()** cr√©√©e (compatibilit√© Animation)
‚úÖ **Aucun localStorage** pour donn√©es m√©tier (sauf r√©sultats OpenAI Phase 1)
‚úÖ **RLS respect√©** via hooks
‚úÖ **Petits composants** non modifi√©s (TextFieldForm, etc.)

---

**FIN DU CODE SECTION 5 COMPLET**

---

## FICHIER 11/10 : NavLinks.tsx (ADAPT√â - BONUS)

### Chemin
`src/components/navigation-site-leadgenaiadbuilder/NavLinks.tsx`

### Code complet adapt√©

```typescript
import React from "react";
import { useLocation } from "react-router-dom";
import { useAutorisationDashboard } from "./2.Hook-Autorisations/1.Aut.Acces.Dashboard";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";

// D√©finition du type pour les sous-liens de navigation
export interface SubNavLink {
  to: string;
  label: string;
  isActive: boolean;
}

// D√©finition du type pour les liens de navigation
export interface NavLink {
  to: string;
  label: string;
  isActive: boolean;
  subLinks?: SubNavLink[];
  expanded?: boolean;
}

// D√©finition du titre de navigation en dur
export const navTitle = "Vos Assistants IA";

// D√©finition des liens de navigation avec sous-liens
export const navLinks: NavLink[] = [
  { to: "/accueil-leadgenai", label: "Accueil", isActive: false },
  { 
    to: "/etape1", 
    label: "Bien √† vendre ou √† louer", 
    isActive: false,
    expanded: false,
    subLinks: [
      { to: "/etape1", label: "√âl√©ments cl√©s", isActive: false },
      { to: "/etape2", label: "Infos de description", isActive: false },
      { to: "/etape3", label: "Infos Financi√®res", isActive: false },
      { to: "/etape4", label: "Autres d√©tails", isActive: false },
      { to: "/etape6communication", label: "Annonces et Outils Marketing", isActive: false },
    ]
  },
  { to: "/zone-chalandise", label: "Zone de Chalandise √† analyser", isActive: false },
  { to: "/newsletter-builder", label: "Newsletter √† lancer", isActive: false },
  { to: "#", label: "Landing Page √† cr√©er", isActive: false },
  { to: "#", label: "Bases de donn√©es √† constituer", isActive: false },
  { to: "#", label: "Prospects √† relancer", isActive: false },
  { to: "#", label: "Contenus √† r√©diger", isActive: false },
  { to: "#", label: "Publicit√©s √† diffuser", isActive: false },
];

// Titre de rubrique Dashboard
export const dashboardTitle = "Dashboard";

// Liens du menu Dashboard
export const dashboardLinks: NavLink[] = [
  { to: "/espace-client", label: "Mon Espace Client", isActive: false },
];

// Fonction pour obtenir les liens de navigation avec l'√©tat actif mis √† jour
export const useNavLinks = (): [NavLink[], (index: number) => void] => {
  const location = useLocation();
  
  // ‚úÖ MODIFICATION CRITIQUE : Utilisation du hook useStepProgress au lieu de localStorage
  const { availableSteps } = useStepProgress();
  
  // Fonction utilitaire pour v√©rifier si une √©tape est d√©bloqu√©e
  const isStepUnlocked = (path: string): boolean => {
    try {
      // ‚úÖ AVANT : const savedProgress = localStorage.getItem('stepProgress');
      // ‚úÖ APR√àS : Utilisation de availableSteps depuis Supabase
      
      if (!availableSteps || availableSteps.length === 0) {
        // Si pas de progression sauv√©e, seule l'√©tape 1 est accessible
        return path === "/etape1";
      }
      
      // Extraire le num√©ro d'√©tape du chemin
      const stepMatch = path.match(/\/etape(\d+)/);
      if (stepMatch) {
        const stepNumber = parseInt(stepMatch[1]);
        return availableSteps.includes(stepNumber);
      }
      
      // Pour les chemins sp√©ciaux comme /etape6communication
      if (path === "/etape6communication") {
        return availableSteps.includes(5); // Accessible si √©tape 5 est d√©bloqu√©e
      }
      
      return true; // Pour les autres chemins, les laisser visibles
    } catch (e) {
      console.error('Erreur lors de la v√©rification de la progression:', e);
      return path === "/etape1"; // Fallback s√©curis√©
    }
  };

  const [links, setLinks] = React.useState<NavLink[]>(
    navLinks.map(link => {
      // V√©rifie si le lien principal est actif
      const isMainActive = location.pathname === link.to || 
                         (link.to === "/accueil-leadgenai" && location.pathname === "/accueil-leadgenai") ||
                         (link.to === "/etape1" && (location.pathname.includes("/etape") || location.pathname === "/safe")) ||
                         (link.to === "/zone-chalandise" && location.pathname.includes("/zone-chalandise")) ||
                         (link.to === "/etape1" && location.pathname.includes("/analyse-photos"));
      
      // Traitement des sous-liens s'ils existent
      const updatedSubLinks = link.subLinks?.map(subLink => ({
        ...subLink,
        isActive: location.pathname === subLink.to || 
                 (subLink.to === "/etape1" && location.pathname.includes("/etape1")) ||
                 (subLink.to === "/etape2" && location.pathname.includes("/etape2")) ||
                 (subLink.to === "/etape3" && location.pathname.includes("/etape3")) ||
                 (subLink.to === "/etape4" && location.pathname.includes("/etape4")) ||
                 (subLink.to === "/etape6communication" && location.pathname.includes("/etape6communication")) ||
                 (subLink.to === "/safe" && location.pathname === "/safe") ||
                 (subLink.to === "/analyse-photos" && location.pathname.includes("/analyse-photos"))
      }))?.filter(subLink => isStepUnlocked(subLink.to)); // Filtrer les sous-liens non d√©bloqu√©s
      
      return {
        ...link,
        isActive: isMainActive,
        subLinks: updatedSubLinks,
        expanded: isMainActive
      };
    })
  );

  // Fonction pour basculer l'√©tat d'expansion d'un menu
  const toggleExpand = (index: number) => {
    setLinks(prevLinks => 
      prevLinks.map((link, i) => 
        i === index 
          ? { ...link, expanded: !link.expanded } 
          : link
      )
    );
  };
  
  return [links, toggleExpand];
};

// Hook pour les liens du dashboard avec autorisation dynamique
export const useDashboardLinks = (): NavLink[] => {
  const location = useLocation();
  const { espacesAutorises, labelsEspaces, isAutorised } = useAutorisationDashboard();
  
  // Si pas d'autorisation, retourner un tableau vide
  if (!isAutorised || espacesAutorises.length === 0) {
    return [];
  }

  // Cr√©er les liens dynamiques bas√©s sur TOUS les espaces autoris√©s
  const dynamicDashboardLinks: NavLink[] = labelsEspaces.map(({ espace, label }) => {
    let routePath = "/espace-client"; // d√©faut
    
    // Adapter la route selon l'espace
    switch (espace) {
      case "ADMIN-PRESENCA":
        routePath = "/admin-presenca";
        break;
      case "RESEAU-ESPACE":
        routePath = "/espace-reseau";
        break;
      case "CLIENT-ESPACE":
        routePath = "/espace-client";
        break;
      case "COLLABORATEUR-ESPACE":
        routePath = "/espace-collaborateur";
        break;
    }

    return {
      to: routePath,
      label: label,
      isActive: location.pathname === routePath
    };
  });

  return dynamicDashboardLinks;
};

// Composant qui retourne les liens et le titre
const NavLinks: React.FC = () => {
  return null;
};

export default NavLinks;

```

---

---



## üìä R√âCAPITULATIF FINAL SECTION 5

### **11 FICHIERS COD√âS AU TOTAL**

| # | Fichier | Type | Status |
|---|---------|------|--------|
| 1 | AnnonceContext.tsx | CR√âER | ‚úÖ Nouveau contexte |
| 2 | Etape1.tsx | ADAPTER | ‚úÖ localStorage ‚Üí Supabase |
| 3 | Etape2.tsx | ADAPTER | ‚úÖ localStorage ‚Üí Supabase |
| 4 | Etape3.tsx | ADAPTER | ‚úÖ localStorage ‚Üí Supabase |
| 5 | Etape4.tsx | ADAPTER | ‚úÖ localStorage ‚Üí Supabase |
| 6 | Etape5.tsx | ADAPTER | ‚úÖ + OpenAI + updateGenerationStatus |
| 7 | EnsembleFormulairesEtape1Form.tsx | ADAPTER | ‚úÖ Props depuis hooks |
| 8 | SaisieDescriptionForm.tsx | ADAPTER | ‚úÖ Props depuis hooks |
| 9 | SaisieFinancialForm.tsx | ADAPTER | ‚úÖ Props depuis hooks |
| 10 | SaisieDetailsForm.tsx | ADAPTER | ‚úÖ Props depuis hooks |
| 11 | **NavLinks.tsx** | **ADAPTER** | ‚úÖ **localStorage ‚Üí Supabase** |

---

**PACKAGE COMPLET SECTION 5 FINALIS√â AVEC BONUS MENU GAUCHE ! üéâ**


# Table : etapes_1to5

## Description générale
Table de stockage des données collectées lors des **Étapes 1 à 5** du parcours de création d'annonce immobilière.
Cette table capture les 14 champs `propertyData` avant l'envoi des prompts vers OpenAI (Phase 1).

---

## Structure de la table

| Table       | Code champ          | Description                                          | Obligatoire                   | Facultatif   | Condition de remplissage                                                       | Droits de modification tables   | Droits de modification presenca   | Type SQL    | Clé primaire (PK)   | Clé étrangère (FK)   | Référence vers table   | Contraintes Supabase       | Type d'identifiant   | Actions à prévoir                    |
|:------------|:--------------------|:-----------------------------------------------------|:------------------------------|:-------------|:-------------------------------------------------------------------------------|:--------------------------------|:----------------------------------|:------------|:--------------------|:---------------------|:-----------------------|:---------------------------|:---------------------|:-------------------------------------|
| etapes_1to5 | id                  | Identifiant unique du projet annonce                 | Oui                           |              | Auto-généré                                                                    | Lecture seule                   | Lecture seule                     | uuid        | Oui                 |                      |                        | Default: gen_random_uuid() | UUID                 | auto                                 |
| etapes_1to5 | organisation_id     | Identifiant du réseau / agence                       | Oui                           |              | Doit correspondre à l'organisation de l'utilisateur                            | Modif admin uniquement          | Non modifiable                    | uuid        |                     | Oui                  | organisations.organisation_id       | FK + ON DELETE CASCADE     | UUID                 | à relier à la structure multi-tenant |
| etapes_1to5 | user_id             | Identifiant de l'utilisateur créateur                | Oui                           |              | Défini automatiquement à la création                                           | Lecture seule                   | Lecture seule                     | uuid        |                     | Oui                  | users.users_id               | FK + ON DELETE CASCADE     | UUID                 | auto                                 |
| etapes_1to5 | step_progress       | Liste des étapes validées (1→5)                      | Oui                           |              | Mis à jour automatiquement à chaque progression                                | Automatique                     | Lecture seule                     | integer[]   |                     |                      |                        | Default '{1}'::integer[]                | Array                | auto                                 |
| etapes_1to5 | version_donnees     | Numéro de version du jeu de données                  | Oui                           |              | Incrémenté à chaque sauvegarde utilisateur                                     | Automatique                     | Lecture seule                     | integer     |                     |                      |                        | Default 1                  | Integer              | Trigger auto-increment                  |
| etapes_1to5 | statut              | Statut du projet ('brouillon', 'en_cours', 'complete', 'archive') | Oui                           |              | Défini par le système selon progression                                        | Automatique / Admin             | Modifiable                        | text        |                     |                      |                        | Default 'brouillon', CHECK (statut IN ('brouillon', 'en_cours', 'complete', 'archive'))                | text                 | Gestion du cycle de vie              |
| etapes_1to5 | validation_user     | Indique si l'utilisateur a validé les données        | Oui                           |              | True lors du clic "Valider pour génération"                                    | Utilisateur                     | Non modifiable                    | boolean     |                     |                      |                        | Default false              | Boolean              | change via bouton                    |
| etapes_1to5 | validated_at        | Date de validation finale avant OpenAI               |                               | Oui          | Renseignée lors de la validation étape 5                                       | Automatique                     | Lecture seule                     | timestamptz |                     |                      |                        | NULL par défaut            | Timestamp            | Trigger auto-set                     |
| etapes_1to5 | logs                | Logs de modifications locales                        |                               | Oui          | Alimentés automatiquement                                                      | Automatique                     | Lecture seule                     | jsonb       |                     |                      |                        | Default '{}'::jsonb                            | JSON                 | optionnel                            |
| etapes_1to5 | created_at          | Date de création                                     | Oui                           |              | Auto                                                                           | Auto                            | Lecture seule                     | timestamptz |                     |                      |                        | Default now()              | Timestamp            | auto                                 |
| etapes_1to5 | updated_at          | Dernière modification                                | Oui                           |              | Auto via trigger                                                               | Auto                            | Lecture seule                     | timestamptz |                     |                      |                        | Trigger set_updated_at()    | Timestamp            | auto                                 |

---

## Champs PropertyData (14 champs métier)

| Table       | Code champ          | Description                                          | Obligatoire                   | Facultatif   | Condition de remplissage                                                       | Type SQL    | Contraintes Supabase       | Étape collecte |
|:------------|:--------------------|:-----------------------------------------------------|:------------------------------|:-------------|:-------------------------------------------------------------------------------|:------------|:---------------------------|:---------------|
| etapes_1to5 | agencyName          | Nom de l'agence                                      | Oui                           |              | Saisi par l'utilisateur (étape 1)                                              | text        | NOT NULL                   | Étape 1        |
| etapes_1to5 | reference           | Référence du bien                                    | Oui                           |              | Saisi par l'utilisateur (étape 1)                                              | text        | NOT NULL                   | Étape 1        |
| etapes_1to5 | exclusivite         | Exclusivité (Oui / Non)                              | Oui                           |              | Saisi par l'utilisateur (étape 1)                                              | text        | NOT NULL, CHECK (exclusivite IN ('Oui', 'Non'))                   | Étape 1        |
| etapes_1to5 | location            | Emplacement                                          | Oui                           |              | Saisi par l'utilisateur (étape 1)                                              | text        | NOT NULL                   | Étape 1        |
| etapes_1to5 | propertyType        | Type de bien                                         | Oui                           |              | Saisi par l'utilisateur (étape 1)                                              | text        | NOT NULL                   | Étape 1        |
| etapes_1to5 | saleType            | Type de transaction                                  | Oui                           |              | Saisi par l'utilisateur (étape 1)                                              | text        | NOT NULL, CHECK (saleType IN ('à vendre', 'à louer'))                   | Étape 1        |
| etapes_1to5 | price               | Prix FAI                                             | Conditionnel                  | Oui          | Saisi si saleType === "à vendre"                                               | numeric     | CHECK ((saleType = 'à vendre' AND price IS NOT NULL AND price > 0) OR saleType = 'à louer')                   | Étape 1        |
| etapes_1to5 | rentAmount          | Loyer HT/HC                                          | Conditionnel                  | Oui          | Saisi si saleType === "à louer"                                                | numeric     | CHECK ((saleType = 'à louer' AND rentAmount IS NOT NULL AND rentAmount > 0) OR saleType = 'à vendre')                   | Étape 1        |
| etapes_1to5 | rentPeriodicity     | Périodicité du Loyer (Mensuel / Trimestriel / Annuel)| Conditionnel                  | Oui          | Saisi si saleType === "à louer"                                                | text        | CHECK ((saleType = 'à louer' AND rentPeriodicity IS NOT NULL) OR saleType = 'à vendre')                   | Étape 1        |
| etapes_1to5 | keyElements         | Eléments Clés du bien                                | Oui                           |              | Saisi par l'utilisateur (étape 1)                                              | text        | NOT NULL                   | Étape 1        |
| etapes_1to5 | propertyDescription | Description détaillée du bien                        | Oui                           |              | Saisi par l'utilisateur (étape 2)                                              | text        | NOT NULL                   | Étape 2        |
| etapes_1to5 | financials          | Informations financières du bien                     | Oui                           |              | Saisi par l'utilisateur (étape 3)                                              | text        | NOT NULL                   | Étape 3        |
| etapes_1to5 | details             | Détails complémentaires du bien                      |                               | Oui          | Saisi par l'utilisateur (étape 4)                                              | text        | CHECK ((details IS NOT NULL AND hasNoDetails = false) OR hasNoDetails = true)                   | Étape 4        |
| etapes_1to5 | hasNoDetails        | Si pas de détails complémentaires                    |                               | Oui          | Validé par l'utilisateur (étape 4)                                             | boolean     | Default false, CHECK ((details IS NOT NULL AND hasNoDetails = false) OR hasNoDetails = true)              | Étape 4        |

---

## Notes importantes

### Champ `statut`
- **Valeurs possibles** : 'brouillon', 'en_cours', 'complete', 'archive'
- **Logique de progression** :
  - `'brouillon'` : Création initiale, données partielles
  - `'en_cours'` : Utilisateur a commencé la saisie (step_progress > {1})
  - `'complete'` : Validation finale (validation_user = true, validated_at renseigné)
  - `'archive'` : Projet archivé par l'utilisateur ou admin

### Champs conditionnels (price / rentAmount / rentPeriodicity)
- Si `saleType = 'à vendre'` → `price` obligatoire, `rentAmount` et `rentPeriodicity` doivent être NULL
- Si `saleType = 'à louer'` → `rentAmount` et `rentPeriodicity` obligatoires, `price` doit être NULL

### Champs exclusifs (details / hasNoDetails)
- L'utilisateur doit **soit** saisir `details`, **soit** cocher `hasNoDetails`
- Les deux ne peuvent pas être simultanément remplis ou vides

---

## Éléments techniques à créer (Phase SQL ultérieure)

1. **Triggers** :
   - `set_updated_at()` : Met à jour automatiquement `updated_at`
   - `increment_version()` : Incrémente `version_donnees` à chaque UPDATE

2. **Indexes recommandés** :
   - `idx_etapes_org_user` : (organisation_id, user_id)
   - `idx_etapes_statut` : (statut)
   - `idx_etapes_validated` : (validation_user, validated_at)

3. **RLS Policies** :
   - `admin_presenca_full_access` : Accès total pour admin PRESENCA
   - `organisation_only_access` : Accès restreint à l'organisation de l'utilisateur

4. **Contraintes CHECK** :
   - Validation des valeurs `statut`
   - Validation des valeurs `saleType`
   - Validation conditionnelle `price` / `rentAmount`
   - Validation exclusive `details` / `hasNoDetails`

---

## 📌 **Clarifications** :

1. **Champ `statut` ** :
   - ✅ Obligatoire = Oui, Default = 'brouillon', CHECK constraint
   - ✅ Section dédiée expliquant la logique de progression

2. **Contraintes CHECK** :
   - ✅ Contraintes pour `saleType`, `price`, `rentAmount`, `rentPeriodicity`
   - ✅ Contrainte d'exclusivité pour `details` / `hasNoDetails`

3. **Références FK** :
   - ✅ `organisations.organisation_id` et `users.users_id` (cohérence avec votre schéma)

4. **Valeurs par défaut** :
   - ✅ Ajout de defaults explicites : `step_progress = '{1}'::integer[]`, `logs = '{}'::jsonb`

5. **Section technique** :
   - ✅ Séparation claire entre la **structure documentaire** et les **éléments SQL à créer ultérieurement**

---


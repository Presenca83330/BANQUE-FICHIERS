
# Table : etapes_1to5

## Description gÃ©nÃ©rale
Table de stockage des donnÃ©es collectÃ©es lors des **Ã‰tapes 1 Ã  5** du parcours de crÃ©ation d'annonce immobiliÃ¨re.
Cette table capture les 14 champs `propertyData` avant l'envoi des prompts vers OpenAI (Phase 1).

---

## Structure de la table

| Table       | Code champ          | Description                                          | Obligatoire                   | Facultatif   | Condition de remplissage                                                       | Droits de modification tables   | Droits de modification presenca   | Type SQL    | ClÃ© primaire (PK)   | ClÃ© Ã©trangÃ¨re (FK)   | RÃ©fÃ©rence vers table   | Contraintes Supabase       | Type d'identifiant   | Actions Ã  prÃ©voir                    |
|:------------|:--------------------|:-----------------------------------------------------|:------------------------------|:-------------|:-------------------------------------------------------------------------------|:--------------------------------|:----------------------------------|:------------|:--------------------|:---------------------|:-----------------------|:---------------------------|:---------------------|:-------------------------------------|
| etapes_1to5 | id                  | Identifiant unique du projet annonce                 | Oui                           |              | Auto-gÃ©nÃ©rÃ©                                                                    | Lecture seule                   | Lecture seule                     | uuid        | Oui                 |                      |                        | Default: gen_random_uuid() | UUID                 | auto                                 |
| etapes_1to5 | organisation_id     | Identifiant du rÃ©seau / agence                       | Oui                           |              | Doit correspondre Ã  l'organisation de l'utilisateur                            | Modif admin uniquement          | Non modifiable                    | uuid        |                     | Oui                  | organisations.organisation_id       | FK + ON DELETE CASCADE     | UUID                 | Ã  relier Ã  la structure multi-tenant |
| etapes_1to5 | user_id             | Identifiant de l'utilisateur crÃ©ateur                | Oui                           |              | DÃ©fini automatiquement Ã  la crÃ©ation                                           | Lecture seule                   | Lecture seule                     | uuid        |                     | Oui                  | users.users_id               | FK + ON DELETE CASCADE     | UUID                 | auto                                 |
| etapes_1to5 | step_progress       | Liste des Ã©tapes validÃ©es (1â†’5)                      | Oui                           |              | Mis Ã  jour automatiquement Ã  chaque progression                                | Automatique                     | Lecture seule                     | integer[]   |                     |                      |                        | Default '{1}'::integer[]                | Array                | auto                                 |
| etapes_1to5 | version_donnees     | NumÃ©ro de version du jeu de donnÃ©es                  | Oui                           |              | IncrÃ©mentÃ© Ã  chaque sauvegarde utilisateur                                     | Automatique                     | Lecture seule                     | integer     |                     |                      |                        | Default 1                  | Integer              | Trigger auto-increment                  |
| etapes_1to5 | statut              | Statut du projet ('brouillon', 'en_cours', 'complete', 'archive') | Oui                           |              | DÃ©fini par le systÃ¨me selon progression                                        | Automatique / Admin             | Modifiable                        | text        |                     |                      |                        | Default 'brouillon', CHECK (statut IN ('brouillon', 'en_cours', 'complete', 'archive'))                | text                 | Gestion du cycle de vie              |
| etapes_1to5 | validation_user     | Indique si l'utilisateur a validÃ© les donnÃ©es        | Oui                           |              | True lors du clic "Valider pour gÃ©nÃ©ration"                                    | Utilisateur                     | Non modifiable                    | boolean     |                     |                      |                        | Default false              | Boolean              | change via bouton                    |
| etapes_1to5 | validated_at        | Date de validation finale avant OpenAI               |                               | Oui          | RenseignÃ©e lors de la validation Ã©tape 5                                       | Automatique                     | Lecture seule                     | timestamptz |                     |                      |                        | NULL par dÃ©faut            | Timestamp            | Trigger auto-set                     |
| etapes_1to5 | logs                | Logs de modifications locales                        |                               | Oui          | AlimentÃ©s automatiquement                                                      | Automatique                     | Lecture seule                     | jsonb       |                     |                      |                        | Default '{}'::jsonb                            | JSON                 | optionnel                            |
| etapes_1to5 | created_at          | Date de crÃ©ation                                     | Oui                           |              | Auto                                                                           | Auto                            | Lecture seule                     | timestamptz |                     |                      |                        | Default now()              | Timestamp            | auto                                 |
| etapes_1to5 | updated_at          | DerniÃ¨re modification                                | Oui                           |              | Auto via trigger                                                               | Auto                            | Lecture seule                     | timestamptz |                     |                      |                        | Trigger set_updated_at()    | Timestamp            | auto                                 |

---

## Champs PropertyData (14 champs mÃ©tier)

| Table       | Code champ          | Description                                          | Obligatoire                   | Facultatif   | Condition de remplissage                                                       | Type SQL    | Contraintes Supabase       | Ã‰tape collecte |
|:------------|:--------------------|:-----------------------------------------------------|:------------------------------|:-------------|:-------------------------------------------------------------------------------|:------------|:---------------------------|:---------------|
| etapes_1to5 | agencyName          | Nom de l'agence                                      | Oui                           |              | Saisi par l'utilisateur (Ã©tape 1)                                              | text        | NOT NULL                   | Ã‰tape 1        |
| etapes_1to5 | reference           | RÃ©fÃ©rence du bien                                    | Oui                           |              | Saisi par l'utilisateur (Ã©tape 1)                                              | text        | NOT NULL                   | Ã‰tape 1        |
| etapes_1to5 | exclusivite         | ExclusivitÃ© (Oui / Non)                              | Oui                           |              | Saisi par l'utilisateur (Ã©tape 1)                                              | text        | NOT NULL, CHECK (exclusivite IN ('Oui', 'Non'))                   | Ã‰tape 1        |
| etapes_1to5 | location            | Emplacement                                          | Oui                           |              | Saisi par l'utilisateur (Ã©tape 1)                                              | text        | NOT NULL                   | Ã‰tape 1        |
| etapes_1to5 | propertyType        | Type de bien                                         | Oui                           |              | Saisi par l'utilisateur (Ã©tape 1)                                              | text        | NOT NULL                   | Ã‰tape 1        |
| etapes_1to5 | saleType            | Type de transaction                                  | Oui                           |              | Saisi par l'utilisateur (Ã©tape 1)                                              | text        | NOT NULL, CHECK (saleType IN ('Ã  vendre', 'Ã  louer'))                   | Ã‰tape 1        |
| etapes_1to5 | price               | Prix FAI                                             | Conditionnel                  | Oui          | Saisi si saleType === "Ã  vendre"                                               | numeric     | CHECK ((saleType = 'Ã  vendre' AND price IS NOT NULL AND price > 0) OR saleType = 'Ã  louer')                   | Ã‰tape 1        |
| etapes_1to5 | rentAmount          | Loyer HT/HC                                          | Conditionnel                  | Oui          | Saisi si saleType === "Ã  louer"                                                | numeric     | CHECK ((saleType = 'Ã  louer' AND rentAmount IS NOT NULL AND rentAmount > 0) OR saleType = 'Ã  vendre')                   | Ã‰tape 1        |
| etapes_1to5 | rentPeriodicity     | PÃ©riodicitÃ© du Loyer (Mensuel / Trimestriel / Annuel)| Conditionnel                  | Oui          | Saisi si saleType === "Ã  louer"                                                | text        | CHECK ((saleType = 'Ã  louer' AND rentPeriodicity IS NOT NULL) OR saleType = 'Ã  vendre')                   | Ã‰tape 1        |
| etapes_1to5 | keyElements         | ElÃ©ments ClÃ©s du bien                                | Oui                           |              | Saisi par l'utilisateur (Ã©tape 1)                                              | text        | NOT NULL                   | Ã‰tape 1        |
| etapes_1to5 | propertyDescription | Description dÃ©taillÃ©e du bien                        | Oui                           |              | Saisi par l'utilisateur (Ã©tape 2)                                              | text        | NOT NULL                   | Ã‰tape 2        |
| etapes_1to5 | financials          | Informations financiÃ¨res du bien                     | Oui                           |              | Saisi par l'utilisateur (Ã©tape 3)                                              | text        | NOT NULL                   | Ã‰tape 3        |
| etapes_1to5 | details             | DÃ©tails complÃ©mentaires du bien                      |                               | Oui          | Saisi par l'utilisateur (Ã©tape 4)                                              | text        | CHECK ((details IS NOT NULL AND hasNoDetails = false) OR hasNoDetails = true)                   | Ã‰tape 4        |
| etapes_1to5 | hasNoDetails        | Si pas de dÃ©tails complÃ©mentaires                    |                               | Oui          | ValidÃ© par l'utilisateur (Ã©tape 4)                                             | boolean     | Default false, CHECK ((details IS NOT NULL AND hasNoDetails = false) OR hasNoDetails = true)              | Ã‰tape 4        |

---

## Notes importantes

### Champ `statut`
- **Valeurs possibles** : 'brouillon', 'en_cours', 'complete', 'archive'
- **Logique de progression** :
  - `'brouillon'` : CrÃ©ation initiale, donnÃ©es partielles
  - `'en_cours'` : Utilisateur a commencÃ© la saisie (step_progress > {1})
  - `'complete'` : Validation finale (validation_user = true, validated_at renseignÃ©)
  - `'archive'` : Projet archivÃ© par l'utilisateur ou admin

### Champs conditionnels (price / rentAmount / rentPeriodicity)
- Si `saleType = 'Ã  vendre'` â†’ `price` obligatoire, `rentAmount` et `rentPeriodicity` doivent Ãªtre NULL
- Si `saleType = 'Ã  louer'` â†’ `rentAmount` et `rentPeriodicity` obligatoires, `price` doit Ãªtre NULL

### Champs exclusifs (details / hasNoDetails)
- L'utilisateur doit **soit** saisir `details`, **soit** cocher `hasNoDetails`
- Les deux ne peuvent pas Ãªtre simultanÃ©ment remplis ou vides

---

## Ã‰lÃ©ments techniques Ã  crÃ©er (Phase SQL ultÃ©rieure)

1. **Triggers** :
   - `set_updated_at()` : Met Ã  jour automatiquement `updated_at`
   - `increment_version()` : IncrÃ©mente `version_donnees` Ã  chaque UPDATE

2. **Indexes recommandÃ©s** :
   - `idx_etapes_org_user` : (organisation_id, user_id)
   - `idx_etapes_statut` : (statut)
   - `idx_etapes_validated` : (validation_user, validated_at)

3. **RLS Policies** :
   - `admin_presenca_full_access` : AccÃ¨s total pour admin PRESENCA
   - `organisation_only_access` : AccÃ¨s restreint Ã  l'organisation de l'utilisateur

4. **Contraintes CHECK** :
   - Validation des valeurs `statut`
   - Validation des valeurs `saleType`
   - Validation conditionnelle `price` / `rentAmount`
   - Validation exclusive `details` / `hasNoDetails`

---

## ğŸ“Œ **Clarifications** :

1. **Champ `statut` ** :
   - âœ… Obligatoire = Oui, Default = 'brouillon', CHECK constraint
   - âœ… Section dÃ©diÃ©e expliquant la logique de progression

2. **Contraintes CHECK** :
   - âœ… Contraintes pour `saleType`, `price`, `rentAmount`, `rentPeriodicity`
   - âœ… Contrainte d'exclusivitÃ© pour `details` / `hasNoDetails`

3. **RÃ©fÃ©rences FK** :
   - âœ… `organisations.organisation_id` et `users.users_id` (cohÃ©rence avec votre schÃ©ma)

4. **Valeurs par dÃ©faut** :
   - âœ… Ajout de defaults explicites : `step_progress = '{1}'::integer[]`, `logs = '{}'::jsonb`

5. **Section technique** :
   - âœ… SÃ©paration claire entre la **structure documentaire** et les **Ã©lÃ©ments SQL Ã  crÃ©er ultÃ©rieurement**

---


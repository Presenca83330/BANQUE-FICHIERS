# SECTION 4 - HELPERS & SERVICES OPENAI ‚úÖ CORRIG√â

**Version :** 1.0.1 **‚úÖ CORRIG√â**  
**Date :** Novembre 2025  

---

## üîß **CORRECTION APPLIQU√âE**

### **FICHIER 3 : getProjectDataFromSupabase.ts**
- ‚úÖ **Ajout `project_id` au SELECT** (ligne 135)
- ‚úÖ **Ajout `project_id` au retour** (ligne 165)

**Impact :** Sans `project_id`, TypeScript crash + services OpenAI ne peuvent pas logger.

---

## FICHIER 1 : openaiConfig.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/2.Components/openaiConfig.ts`

```typescript
/**
 * Configuration centralis√©e OpenAI pour Phase 1
 * Param√®tres uniques pour tous les services
 * 
 * ‚ö†Ô∏è INTERDICTIONS :
 * - NE PAS utiliser temperature
 * - NE PAS utiliser max_tokens (utiliser max_completion_tokens)
 * - NE PAS changer le mod√®le
 * - NE PAS changer l'endpoint
 */

export const OPENAI_CONFIG = {
  /** Endpoint OpenAI unique */
  ENDPOINT: "https://api.openai.com/v1/chat/completions",
  
  /** Mod√®le OpenAI unique - Phase 1 */
  MODEL: "gpt-5-mini-2025-08-07",
  
  /** Max tokens de compl√©tion */
  MAX_COMPLETION_TOKENS: 3000,
} as const;

/**
 * Type pour garantir l'immutabilit√© de la configuration
 */
export type OpenAIConfig = typeof OPENAI_CONFIG;
```

---

## FICHIER 2 : getActiveOpenAIKey.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/2.Components/getActiveOpenAIKey.ts`

```typescript
import { supabase } from "@/integrations/supabase/client";

/**
 * R√©cup√®re la cl√© OpenAI active de l'organisation courante
 * 
 * RLS Supabase filtre automatiquement par organisation_id via get_user_organisation_id(auth.uid())
 * Aucun param√®tre n'est n√©cessaire - le filtrage est automatique
 * 
 * @returns La cl√© OpenAI active en clair
 * @throws Error si aucune cl√© active n'est trouv√©e ou en cas d'erreur Supabase
 * 
 * @example
 * ```typescript
 * const apiKey = await getActiveOpenAIKey();
 * // Utiliser la cl√© pour appeler OpenAI
 * ```
 */
export async function getActiveOpenAIKey(): Promise<string> {
  try {
    // R√©cup√©ration de la cl√© active
    // RLS filtre automatiquement par organisation_id
    const { data, error } = await supabase
      .from("openai_api_keys")
      .select("key_value")
      .eq("key_active", true)
      .maybeSingle();

    if (error) {
      console.error("Error fetching OpenAI key:", error);
      throw new Error(`Erreur lors de la r√©cup√©ration de la cl√© OpenAI: ${error.message}`);
    }

    if (!data) {
      throw new Error("Aucune cl√© OpenAI active trouv√©e pour cette organisation");
    }

    return data.key_value;
  } catch (error) {
    console.error("Failed to get active OpenAI key:", error);
    throw error;
  }
}
```

---

## FICHIER 3 : getProjectDataFromSupabase.ts ‚úÖ CORRIG√â
### Chemin : `src/services/openai/01.SupabaseEtape1to5/2.Components/getProjectDataFromSupabase.ts`

```typescript
import { supabase } from "@/integrations/supabase/client";
import type { PropertyData } from "@/services/openai";

/**
 * R√©cup√®re les donn√©es du projet en cours depuis Supabase
 * 
 * Charge le projet avec statut "en_cours" pour l'utilisateur connect√©
 * RLS Supabase filtre automatiquement par organisation_id
 * 
 * Retourne les 15 champs n√©cessaires aux prompts OpenAI :
 * - project_id (AJOUT√â ‚úÖ)
 * - agencyName, reference, exclusivite, location, propertyType
 * - saleType, price, rentAmount, rentPeriodicity, keyElements
 * - propertyDescription, financials, details, hasNoDetails
 * 
 * @returns Les donn√©es du projet au format PropertyData
 * @throws Error si utilisateur non connect√©, aucun projet trouv√©, ou erreur Supabase
 * 
 * @example
 * ```typescript
 * const projectData = await getProjectDataFromSupabase();
 * // Utiliser projectData pour construire les prompts
 * ```
 */
export async function getProjectDataFromSupabase(): Promise<PropertyData> {
  try {
    // 1Ô∏è‚É£ V√©rifier l'authentification
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    
    if (authError) {
      console.error("Authentication error:", authError);
      throw new Error(`Erreur d'authentification: ${authError.message}`);
    }
    
    if (!user) {
      throw new Error("Utilisateur non connect√©");
    }

    // 2Ô∏è‚É£ R√©cup√©rer le projet en cours
    // RLS filtre automatiquement par organisation_id
    const { data, error } = await supabase
      .from("etapes_1to5")
      .select(`
        project_id,
        agencyName,
        reference,
        exclusivite,
        location,
        propertyType,
        saleType,
        price,
        rentAmount,
        rentPeriodicity,
        keyElements,
        propertyDescription,
        financials,
        details,
        hasNoDetails
      `)
      .eq("user_id", user.id)
      .eq("statut", "en_cours")
      .maybeSingle();

    if (error) {
      console.error("Error fetching project data:", error);
      throw new Error(`Erreur lors de la r√©cup√©ration du projet: ${error.message}`);
    }

    if (!data) {
      throw new Error("Aucun projet en cours trouv√© pour cet utilisateur");
    }

    // 3Ô∏è‚É£ Retourner les donn√©es au format PropertyData
    return {
      project_id: data.project_id,
      agencyName: data.agencyName,
      reference: data.reference,
      exclusivite: data.exclusivite,
      location: data.location,
      propertyType: data.propertyType,
      saleType: data.saleType,
      price: data.price,
      rentAmount: data.rentAmount,
      rentPeriodicity: data.rentPeriodicity,
      keyElements: data.keyElements,
      propertyDescription: data.propertyDescription,
      financials: data.financials,
      details: data.details,
      hasNoDetails: data.hasNoDetails,
    };
  } catch (error) {
    console.error("Failed to get project data from Supabase:", error);
    throw error;
  }
}
```

---

## ‚úÖ VALIDATION DES 3 HELPERS

### **Fichier 1 : openaiConfig.ts**
- ‚úÖ Constantes centralis√©es
- ‚úÖ Mod√®le `gpt-5-mini-2025-08-07`
- ‚úÖ `max_completion_tokens: 3000`
- ‚úÖ Pas de `temperature`
- ‚úÖ Type immutable avec `as const`

### **Fichier 2 : getActiveOpenAIKey.ts**
- ‚úÖ Pas de param√®tre (RLS automatique)
- ‚úÖ Try/catch complet
- ‚úÖ Messages d'erreur clairs
- ‚úÖ Retourne `key_value`
- ‚úÖ Documentation JSDoc

### **Fichier 3 : getProjectDataFromSupabase.ts ‚úÖ CORRIG√â**
- ‚úÖ **project_id ajout√© au SELECT** (ligne 135)
- ‚úÖ **project_id ajout√© au retour** (ligne 165)
- ‚úÖ V√©rifie authentification
- ‚úÖ R√©cup√®re projet "en_cours"
- ‚úÖ Les 15 champs complets (14 m√©tier + 1 ID)
- ‚úÖ Try/catch complet
- ‚úÖ Type PropertyData
- ‚úÖ Documentation JSDoc

---

## FICHIER 4 : 1.AnnonceSiteInternet.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/1.Services/1.AnnonceSiteInternet.ts`

```typescript
import { createOpenAIService } from "@/services/openai";
import { promptAnnonceSiteInternet } from "../../1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/1.PromptAnnonceSiteInternet";
import { getActiveOpenAIKey } from "../2.Components/getActiveOpenAIKey";
import { getProjectDataFromSupabase } from "../2.Components/getProjectDataFromSupabase";
import { OPENAI_CONFIG } from "../2.Components/openaiConfig";

/**
 * G√©n√®re une annonce pour site internet
 * 
 * Flux :
 * 1. R√©cup√®re les donn√©es du projet depuis Supabase
 * 2. R√©cup√®re la cl√© OpenAI active
 * 3. G√©n√®re l'annonce via OpenAI
 * 4. Stocke le r√©sultat dans localStorage
 * 
 * @returns R√©sultat de g√©n√©ration au format { titre, accroche, descriptif, cta }
 * @throws Error en cas d'√©chec de r√©cup√©ration ou de g√©n√©ration
 */
export async function generateWebsiteAd() {
  // 1Ô∏è‚É£ R√©cup√©rer les donn√©es projet depuis Supabase
  const projectData = await getProjectDataFromSupabase();
  
  // 2Ô∏è‚É£ R√©cup√©rer la cl√© OpenAI depuis Supabase
  const apiKey = await getActiveOpenAIKey();
  
  // 3Ô∏è‚É£ Cr√©er instance OpenAIService
  const openAIService = createOpenAIService(apiKey);
  
  // 4Ô∏è‚É£ G√©n√©rer avec le nouveau mod√®le
  const result = await openAIService.generateWebsiteAd(
    projectData,
    OPENAI_CONFIG.MODEL
  );
  
  // 5Ô∏è‚É£ Stocker dans localStorage
  localStorage.setItem("generation_website_ad", JSON.stringify(result));
  
  return result;
}
```

---

## FICHIER 5 : 2.AnnonceFicheDeSynthese.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/1.Services/2.AnnonceFicheDeSynthese.ts`

```typescript
import { createOpenAIService } from "@/services/openai";
import { getActiveOpenAIKey } from "../2.Components/getActiveOpenAIKey";
import { getProjectDataFromSupabase } from "../2.Components/getProjectDataFromSupabase";
import { OPENAI_CONFIG } from "../2.Components/openaiConfig";

/**
 * G√©n√®re une fiche de synth√®se
 * 
 * Flux :
 * 1. R√©cup√®re les donn√©es du projet depuis Supabase
 * 2. R√©cup√®re la cl√© OpenAI active
 * 3. G√©n√®re la fiche via OpenAI
 * 4. Stocke le r√©sultat dans localStorage
 * 
 * @returns R√©sultat au format fiche de synth√®se
 * @throws Error en cas d'√©chec
 */
export async function generateSummarySheetAd() {
  // 1Ô∏è‚É£ R√©cup√©rer les donn√©es projet depuis Supabase
  const projectData = await getProjectDataFromSupabase();
  
  // 2Ô∏è‚É£ R√©cup√©rer la cl√© OpenAI depuis Supabase
  const apiKey = await getActiveOpenAIKey();
  
  // 3Ô∏è‚É£ Cr√©er instance OpenAIService
  const openAIService = createOpenAIService(apiKey);
  
  // 4Ô∏è‚É£ G√©n√©rer avec le nouveau mod√®le
  const result = await openAIService.generateSummarySheetAd(
    projectData,
    OPENAI_CONFIG.MODEL
  );
  
  // 5Ô∏è‚É£ Stocker dans localStorage
  localStorage.setItem("generation_summary_sheet", JSON.stringify(result));
  
  return result;
}
```

---

## FICHIER 6 : 3.AnnonceNewsletter.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/1.Services/3.AnnonceNewsletter.ts`

```typescript
import { createOpenAIService } from "@/services/openai";
import { getActiveOpenAIKey } from "../2.Components/getActiveOpenAIKey";
import { getProjectDataFromSupabase } from "../2.Components/getProjectDataFromSupabase";
import { OPENAI_CONFIG } from "../2.Components/openaiConfig";

/**
 * G√©n√®re une annonce newsletter
 * 
 * Flux :
 * 1. R√©cup√®re les donn√©es du projet depuis Supabase
 * 2. R√©cup√®re la cl√© OpenAI active
 * 3. G√©n√®re l'annonce via OpenAI
 * 4. Stocke le r√©sultat dans localStorage
 * 
 * @returns R√©sultat au format newsletter
 * @throws Error en cas d'√©chec
 */
export async function generateNewsletterAd() {
  // 1Ô∏è‚É£ R√©cup√©rer les donn√©es projet depuis Supabase
  const projectData = await getProjectDataFromSupabase();
  
  // 2Ô∏è‚É£ R√©cup√©rer la cl√© OpenAI depuis Supabase
  const apiKey = await getActiveOpenAIKey();
  
  // 3Ô∏è‚É£ Cr√©er instance OpenAIService
  const openAIService = createOpenAIService(apiKey);
  
  // 4Ô∏è‚É£ G√©n√©rer avec le nouveau mod√®le
  const result = await openAIService.generateNewsletterAd(
    projectData,
    OPENAI_CONFIG.MODEL
  );
  
  // 5Ô∏è‚É£ Stocker dans localStorage
  localStorage.setItem("generation_newsletter", JSON.stringify(result));
  
  return result;
}
```

---

## FICHIER 7 : 4.OutilsSEO.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/1.Services/4.OutilsSEO.ts`

```typescript
import { createOpenAIService } from "@/services/openai";
import { getActiveOpenAIKey } from "../2.Components/getActiveOpenAIKey";
import { getProjectDataFromSupabase } from "../2.Components/getProjectDataFromSupabase";
import { OPENAI_CONFIG } from "../2.Components/openaiConfig";

/**
 * G√©n√®re les outils SEO
 * 
 * Flux :
 * 1. R√©cup√®re les donn√©es du projet depuis Supabase
 * 2. R√©cup√®re la cl√© OpenAI active
 * 3. G√©n√®re les outils via OpenAI
 * 4. Stocke le r√©sultat dans localStorage
 * 
 * @returns R√©sultat au format { baliseTitre, baliseMetaDescription, urlLongueTraine }
 * @throws Error en cas d'√©chec
 */
export async function generateSEOTools() {
  // 1Ô∏è‚É£ R√©cup√©rer les donn√©es projet depuis Supabase
  const projectData = await getProjectDataFromSupabase();
  
  // 2Ô∏è‚É£ R√©cup√©rer la cl√© OpenAI depuis Supabase
  const apiKey = await getActiveOpenAIKey();
  
  // 3Ô∏è‚É£ Cr√©er instance OpenAIService
  const openAIService = createOpenAIService(apiKey);
  
  // 4Ô∏è‚É£ G√©n√©rer avec le nouveau mod√®le
  const result = await openAIService.generateSEOTools(
    projectData,
    OPENAI_CONFIG.MODEL
  );
  
  // 5Ô∏è‚É£ Stocker dans localStorage
  localStorage.setItem("generation_seo_tools", JSON.stringify(result));
  
  return result;
}
```

---

## FICHIER 8 : 5.SMSAnnonce.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/1.Services/5.SMSAnnonce.ts`

```typescript
import { createOpenAISMSService } from "../../1.GenerateurAnnoncesOutilsSeo/6.ServicesOpenAi/1.API-AnnonceSMS";
import { getActiveOpenAIKey } from "../2.Components/getActiveOpenAIKey";
import { getProjectDataFromSupabase } from "../2.Components/getProjectDataFromSupabase";
import { OPENAI_CONFIG } from "../2.Components/openaiConfig";

/**
 * G√©n√®re une annonce SMS
 * 
 * Utilise la classe OpenAISMSService existante
 * Format JSON retourn√© : { "restitution-annonce-sms": string }
 * Limite : 122 caract√®res maximum
 * 
 * Flux :
 * 1. R√©cup√®re les donn√©es du projet depuis Supabase
 * 2. R√©cup√®re la cl√© OpenAI active
 * 3. G√©n√®re l'annonce via OpenAISMSService
 * 4. Stocke le r√©sultat dans localStorage
 * 
 * @returns R√©sultat au format { "restitution-annonce-sms": string }
 * @throws Error en cas d'√©chec
 */
export async function generateSMSAd() {
  // 1Ô∏è‚É£ R√©cup√©rer les donn√©es projet depuis Supabase
  const projectData = await getProjectDataFromSupabase();
  
  // 2Ô∏è‚É£ R√©cup√©rer la cl√© OpenAI depuis Supabase
  const apiKey = await getActiveOpenAIKey();
  
  // 3Ô∏è‚É£ Cr√©er instance OpenAISMSService
  const smsService = createOpenAISMSService(apiKey);
  
  // 4Ô∏è‚É£ G√©n√©rer avec le nouveau mod√®le
  const result = await smsService.generateSMSAd(
    projectData,
    OPENAI_CONFIG.MODEL
  );
  
  // 5Ô∏è‚É£ Stocker dans localStorage
  localStorage.setItem("generation_sms_ad", JSON.stringify(result));
  
  return result;
}
```

---

## FICHIER 9 : 6.GoogleBusinessProfileAnnonce.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/1.Services/6.GoogleBusinessProfileAnnonce.ts`

```typescript
import { createOpenAIGoogleBusinessProfileService } from "../../1.GenerateurAnnoncesOutilsSeo/6.ServicesOpenAi/2.API-AnnonceGoogleBusinessProfile";
import { getActiveOpenAIKey } from "../2.Components/getActiveOpenAIKey";
import { getProjectDataFromSupabase } from "../2.Components/getProjectDataFromSupabase";
import { OPENAI_CONFIG } from "../2.Components/openaiConfig";

/**
 * G√©n√®re une annonce Google Business Profile
 * 
 * Utilise la classe OpenAIGoogleBusinessProfileService existante
 * Format JSON retourn√© : { TitreAnnonceGoogle, AccrocheDescriptiveAnnonceGoogle, PointsFortsAnnonceGoogle, CtaAnnonceGoogle }
 * 
 * Flux :
 * 1. R√©cup√®re les donn√©es du projet depuis Supabase
 * 2. R√©cup√®re la cl√© OpenAI active
 * 3. G√©n√®re l'annonce via OpenAIGoogleBusinessProfileService
 * 4. Stocke le r√©sultat dans localStorage
 * 
 * @returns R√©sultat au format { TitreAnnonceGoogle, AccrocheDescriptiveAnnonceGoogle, PointsFortsAnnonceGoogle, CtaAnnonceGoogle }
 * @throws Error en cas d'√©chec
 */
export async function generateGoogleProfileAd() {
  // 1Ô∏è‚É£ R√©cup√©rer les donn√©es projet depuis Supabase
  const projectData = await getProjectDataFromSupabase();
  
  // 2Ô∏è‚É£ R√©cup√©rer la cl√© OpenAI depuis Supabase
  const apiKey = await getActiveOpenAIKey();
  
  // 3Ô∏è‚É£ Cr√©er instance OpenAIGoogleBusinessProfileService
  const googleService = createOpenAIGoogleBusinessProfileService(apiKey);
  
  // 4Ô∏è‚É£ G√©n√©rer avec le nouveau mod√®le
  const result = await googleService.generateGoogleBusinessProfileAd(
    projectData,
    OPENAI_CONFIG.MODEL
  );
  
  // 5Ô∏è‚É£ Stocker dans localStorage
  localStorage.setItem("generation_googleprofile_ad", JSON.stringify(result));
  
  return result;
}
```

---

## FICHIER 10 : 7.ReseauxSociauxAnnonce.ts
### Chemin : `src/services/openai/01.SupabaseEtape1to5/1.Services/7.ReseauxSociauxAnnonce.ts`

```typescript
import { createOpenAIReseauxSociauxService } from "../../1.GenerateurAnnoncesOutilsSeo/6.ServicesOpenAi/3.API-AnnonceReseauxSociaux";
import { getActiveOpenAIKey } from "../2.Components/getActiveOpenAIKey";
import { getProjectDataFromSupabase } from "../2.Components/getProjectDataFromSupabase";
import { OPENAI_CONFIG } from "../2.Components/openaiConfig";

/**
 * G√©n√®re une annonce pour les r√©seaux sociaux
 * 
 * Utilise la classe OpenAIReseauxSociauxService existante
 * Format JSON retourn√© : { TitreAnnonceReseaux, AccrocheImpactanteAnnonceReseaux, AtoutsAnnonceReseaux, CtaAnnonceReseaux }
 * 
 * Flux :
 * 1. R√©cup√®re les donn√©es du projet depuis Supabase
 * 2. R√©cup√®re la cl√© OpenAI active
 * 3. G√©n√®re l'annonce via OpenAIReseauxSociauxService
 * 4. Stocke le r√©sultat dans localStorage
 * 
 * @returns R√©sultat au format { TitreAnnonceReseaux, AccrocheImpactanteAnnonceReseaux, AtoutsAnnonceReseaux, CtaAnnonceReseaux }
 * @throws Error en cas d'√©chec
 */
export async function generateReseauxSociauxAd() {
  // 1Ô∏è‚É£ R√©cup√©rer les donn√©es projet depuis Supabase
  const projectData = await getProjectDataFromSupabase();
  
  // 2Ô∏è‚É£ R√©cup√©rer la cl√© OpenAI depuis Supabase
  const apiKey = await getActiveOpenAIKey();
  
  // 3Ô∏è‚É£ Cr√©er instance OpenAIReseauxSociauxService
  const reseauxService = createOpenAIReseauxSociauxService(apiKey);
  
  // 4Ô∏è‚É£ G√©n√©rer avec le nouveau mod√®le
  const result = await reseauxService.generateReseauxSociauxAd(
    projectData,
    OPENAI_CONFIG.MODEL
  );
  
  // 5Ô∏è‚É£ Stocker dans localStorage
  localStorage.setItem("generation_reseauxsociaux_ad", JSON.stringify(result));
  
  return result;
}
```

---

## üìã R√âCAPITULATIF SECTION 4 ‚úÖ CORRIG√âE

### **10 FICHIERS PRODUCTION-READY**

#### **Helpers (3 fichiers) ‚úÖ**
1. ‚úÖ `openaiConfig.ts`
2. ‚úÖ `getActiveOpenAIKey.ts`
3. ‚úÖ **`getProjectDataFromSupabase.ts` ‚úÖ CORRIG√â (project_id ajout√©)**

#### **Services (7 fichiers) ‚úÖ**
4. ‚úÖ `1.AnnonceSiteInternet.ts`
5. ‚úÖ `2.AnnonceFicheDeSynthese.ts`
6. ‚úÖ `3.AnnonceNewsletter.ts`
7. ‚úÖ `4.OutilsSEO.ts`
8. ‚úÖ `5.SMSAnnonce.ts`
9. ‚úÖ `6.GoogleBusinessProfileAnnonce.ts`
10. ‚úÖ `7.ReseauxSociauxAnnonce.ts`

---

## üéØ POINTS CL√âS VALID√âS

- ‚úÖ Tous les services utilisent `getProjectDataFromSupabase()`
- ‚úÖ **`project_id` r√©cup√©r√© et disponible pour logs OpenAI** ‚úÖ CORRIG√â
- ‚úÖ Tous les services utilisent `getActiveOpenAIKey()`
- ‚úÖ Tous les services utilisent `OPENAI_CONFIG.MODEL`
- ‚úÖ Aucun service n'a de param√®tre (RLS automatique)
- ‚úÖ Pas de try/catch dans les services (g√©r√© dans helpers)
- ‚úÖ Cl√©s localStorage conformes aux noms actuels
- ‚úÖ Imports depuis les classes existantes

---

**SECTION 4 TERMIN√âE ET CORRIG√âE ! üéâ**

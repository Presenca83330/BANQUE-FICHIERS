# **Rôle fondamental de la Section 4 – SERVICES OPENAI**

- La **Section 4** sert à **définir et documenter tout le fonctionnement des services OpenAI** dans application LeadGenAI AdBuilder.
- C’est **le cœur du moteur de génération** (les “agents IA d’annonces”).
- Ces directives sont non négociables
---

## **Concrètement, la Section 4 sert à :**

| Objectif                                          | Description                                                                                                                                                                                     |
| ------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Centraliser les appels OpenAI**              | Décrire **tous les services de génération** (annonce, fiche synthèse, newsletter, SEO, SMS, Google MB, réseaux sociaux). Chaque service correspond à **une fonction** qui appelle l’API OpenAI. |
| **2. Garantir la cohérence avec les étapes 1→5**  | S’assurer que les données collectées (Étapes 1 à 4) sont transmises **sans altération** dans chaque prompt, via le bon mapping (`mapSupabaseToPrompt()` ou localStorage).                       |
| **3. Encadrer la gestion des prompts**            | Définir où et comment sont stockés les prompts (`src/services/openai/…/PromptsOpenAi/`). <br>➡️ Cette section verrouille leur contenu et empêche toute modification automatique.                |
| **4. Documenter la logique d’appel OpenAI**       | Expliquer le **mode d’appel** (séquentiel, API Chat Completions, version du modèle, gestion d’erreurs, typage du retour).                                                                       |
| **5. Préparer la migration future vers Supabase** | Poser les bases pour qu’un jour, les résultats générés puissent être sauvegardés (dans une table `annonces_generatees`, par ex.) **sans casser le flux actuel localStorage**.                   |
| **6. Normaliser les retours IA**                  | Garantir que chaque service retourne un objet cohérent, par ex. :  \n`ts\n{ title: string; description: string; keywords: string[] }\n`                                                         |
| **7. Sécuriser les interactions avec OpenAI**     | Centraliser les clés, gérer les erreurs uniformément, et s’assurer que rien d’interne (organisation_id, user_id) n’est envoyé à l’IA.                                                           |
---

## **En résumé**

>  La Section 4, c’est la **“brique IA”** de ton application.
>  Elle fait le lien entre **les données métiers (Étapes 1→5)** et **l’intelligence générative (OpenAI)**.
>  Elle documente tout ce qui concerne **les prompts, les appels, la structure et les retours IA**.

---
## **Directive 1 — Conservation intégrale des prompts localstorage**

| Élément                  | Détail                                                                                                                                                                                                                                           |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Objectif**             | Garantir que tous les prompts OpenAI actuels (issus du MVP LocalStorage) soient **utilisés à l’identique**, sans reformulation, ni simplification, ni enrichissement automatique.                                                                |
| **Contexte**             | Les prompts existants ont été calibrés manuellement pour obtenir un style, une cohérence et des résultats optimaux avec tes APIs et assistants OpenAI.                                                                                           |
| **Emplacement**          | `/src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`                                                                                                                                                                            |
| **Structure actuelle**   | 7 fichiers prompts individuels :<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/1.PromptAnnonceSiteInternet.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/2.PromptAnnonceFichedeSynthese.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/3.PromptAnnonceNewsletter.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/4.PromptOutilsSEO.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/5.PromptSMSAnnonce.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/6.PromptGoogleBusinessProfileAnnonce.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/7.PromptReseauxSociauxAnnonce.ts|
| **Règle absolue**        | ➜ Aucune réécriture automatique des prompts (même minime). <br>➜ Aucun nettoyage texte (`trim`, `replace`, `sanitize`). <br>➜ Aucun regroupement (pas de “prompt builder”).                                                                      |
| **Mode d’appel**         | Chaque fonction de génération (`generateWebsiteAd`, `generateSummarySheetAd`, etc.) appelle **le prompt correspondant** via `import` direct.                                                                                                     |
| **Stockage des prompts** | Tous les prompts restent **dans le front**, sous ton contrôle. <br>Ils ne sont pas déplacés dans Supabase, ni externalisés.                                                                                                                      |
| **Impact attendu**       | Garantit la continuité exacte du comportement génératif validé en production MVP.                                                                                                                                                                |

---

##  **Directive 2 — Processus d’envoi des prompts vers OpenAI**

| Élément                 | Détail confirmé                                                                                                                                                                                                                           |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Objectif**            | Garantir que le **processus d’appel aux 7 services OpenAI** reste **strictement identique** à celui du localStorage actuelle.                                                                                                                  |
| **Mode d’exécution**    | **SÉQUENTIEL** : les 7 appels s’exécutent l’un après l’autre avec `await`.<br>→ aucun appel en parallèle ; chaque génération attend la fin de la précédente.                                                                              |
| **Ordre d’exécution**   | 1️⃣ `generateWebsiteAd()` → 2️⃣ `generateSummarySheetAd()` → 3️⃣ `generateNewsletterAd()` → 4️⃣ `generateSEOTools()` → 5️⃣ `generateSMSAd()` → 6️⃣ `generateGoogleBusinessProfileAd()` → 7️⃣ `generateReseauxSociauxAd()`.                |
| **API utilisée**        | `POST https://api.openai.com/v1/chat/completions` (Chat Completions API).                                                                                                                                                                 |
| **Mode d’appel**        | **Stateless** : chaque appel est indépendant (aucune conversation ni contexte partagé).                                                                                                                                                   |
| **Modèle**              | - Modification du modèle-> utiliser "gpt-5-mini-2025-08-07"<br>- max_completion_tokens (remplace max_tokens)<br>- Paramètre temperature supprimé                                                                                          |
| **Gestion d’erreurs**   | Chaque appel dispose de son propre `try / catch` ; si un échoue, les suivants continuent (aucun blocage global).                                                                                                                          |
| **Stockage temporaire** | Les résultats sont immédiatement sauvegardés dans `localStorage` (Phase 1 : aucune écriture Supabase).                                                                                                                                    |
| **Progression**         | `generation_status` mis à jour après chaque étape : 14 % → 28 % → … → 100 %.                                                                                                                                                              |
| **Format de retour**    | Le contenu généré est renvoyé en **JSON structuré**, parsé, puis stocké tel quel (aucune modification ni reformattage).                                                                                                                   |
| **Prompts utilisés**    | Chaque appel importe son **prompt dédié** (ex. : `PromptAnnonceSiteInternet.ts`) ; seules les variables dynamiques (`agencyName`, `propertyType`, etc.) sont remplacées.                                                                  |
| **Migration Phase 1**   | - Lire les données dans `etapes_1to5` au lieu de `localStorage.propertyData`.<br>- Utiliser les mêmes prompts sans modification<br>- Conserver exactement le même processus d'envoi séquentiel.<br>- Stocker temporairement les résultats dans localStorage (comme actuellement judqu'à la validation et la migration de la phase 1)<br>- Maintenir la même séquence et gestion d’erreurs. |

---

### **Directive 3 — Utilisation des API OpenAI**

| Élément                          | Spécification validée                                                                                                          |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| **Endpoint API**                 | `https://api.openai.com/v1/chat/completions`                                                                                   |
| **Méthode HTTP**                 | `POST`                                                                                                                         |
| **Modèle**                       | `gpt-5-mini-2025-08-07`                                                                                                        |
| **Mode d’exécution**             | Stateless – chaque requête est indépendante                                                                                    |
| **Paramètres**                   | `json { "model": "gpt-5-mini-2025-08-07", "max_completion_tokens": 3000 } `                                                    |
| **Suppression de `temperature`** | Oui – le paramètre `temperature` n’est plus utilisé                                                                            |
| **Mode d’appel**                 | Séquentiel (`await` → chaque requête attend la précédente)                                                                     |
| **Format de message**            | `ts [ { role: "system", content: "You are a helpful assistant." }, { role: "user", content: "[PROMPT COMPLET]" } ] `           |
| **Format de réponse attendu**    | JSON structuré conforme aux schémas actuels de sortie (Annonce, Fiche, Newsletter, SEO, SMS, Google Business, Réseaux Sociaux) |
| **Authentification**             | Clé API récupérée dynamiquement selon le tenant via la fonction `getActiveOpenAIKey(organisation_id)`                          |
| **Stockage des résultats**       | Résultats enregistrés localement (`localStorage`) – aucune écriture en base pendant la Phase 1                                 |
| **Suivi de progression**         | `generation_status` mis à jour après chaque génération (14 %, 28 %, …, 100 %)                                                  |

---

### **Directive 4 – Table `openai_api_keys`**

| Élément                        | Détail                                                                                                                                                                                                                                        |
| :----------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Nom du module**              | Table `openai_api_keys`                                                                                                                                                                                                                       |
| **Objectif**                   | Centraliser la gestion sécurisée des clés OpenAI utilisées par l’application LeadGenAI AdBuilder.                                                                                                                                             |
| **Rôle**                       | Déterminer automatiquement quelle clé OpenAI utiliser pour chaque organisation (agence, réseau, indépendant) ou, par défaut, la clé Presenca globale (`is_default = true`).                                                                   |
| **Composants principaux**      | - Champ `organisation_id` pour le rattachement multi-tenant<br>- Champ `openai_api_key` chiffré<br>- Champ `is_default` pour la clé globale Presenca<br>- Champs d’audit : `created_at`, `updated_at`, `total_tokens_used`, `last_usage_at`   |
| **Type de table**              | Statique – configuration par organisation                                                                                                                                                                                                     |
| **RLS (Row Level Security)**   | Chaque organisation ne peut lire/écrire que sa propre clé.<br>`admin_presenca` a les droits complets.                                                                                                                                         |
| **Fonctionnement global**      | Lors d’un appel OpenAI, le service `getActiveOpenAIKey(organisation_id)` recherche la clé correspondant à l’organisation connectée, sinon utilise la clé globale Presenca.                                                                    |


---

###  **Directive 5 – Table `openai_usage_logs`**

| Élément                        | Détail                                                                                                                                                                                                                                        |
| :----------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Nom du module**              | Table `openai_usage_logs`                                                                                                                                                                                                                     |
| **Objectif**                   | Suivre et enregistrer tous les appels OpenAI effectués dans l’application, pour chaque utilisateur et chaque organisation.                                                                                                                    |
| **Rôle**                       | Fournir un historique des générations IA et mettre à jour automatiquement la consommation cumulée (`total_tokens_used`, `last_usage_at`) dans la table `openai_api_keys`.                                                                     |
| **Composants principaux**      | - Champs de rattachement : `organisation_id`, `user_id`<br>- Champs d’audit : `service_name`, `model`, `tokens_used`, `prompt_tokens`, `completion_tokens`, `created_at`<br>- Trigger : `update_token_counters()`                             |
| **Type de table**              | Dynamique – journalisation automatique                                                                                                                                                                                                        |
| **RLS (Row Level Security)**   | Les utilisateurs ne voient que les logs de leur propre organisation.<br>`admin_presenca` a un accès complet.                                                                                                                                  |
| **Fonctionnement global**      | Chaque appel OpenAI enregistre une ligne dans `openai_usage_logs`. Un trigger met à jour la consommation cumulée et la date du dernier usage dans `openai_api_keys`.                                                                          |



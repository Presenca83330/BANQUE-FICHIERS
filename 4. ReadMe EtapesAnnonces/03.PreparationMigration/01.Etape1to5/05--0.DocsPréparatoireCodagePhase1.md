# üéØ DOCUMENT PREPARATOIRE AU CODAGE FINAL DE LA MIGRATION - PHASE 1 : MIGRATION √âTAPES 1 √Ä 5

## **Principe G√©n√©ral de la Migration Phase 1 -> Etape 1 √† Etape 5**
**Objectif** : 
- Migrer le process Localstorage -> Supabase
  - Pour les √©tapes 1 √† 5
  - Jusqu'√† l"envoi des prompts vers OpenAI
    - Migrer les **14 champs `propertyData`** des √©tapes 1-4 vers Supabase
    - Pr√©parer et envoyer les donn√©es √† OpenAI (INPUT)
    - Utiliser les **7 prompts sp√©cifiques** (d√©finis dans `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`)

**Ce qui reste en localStorage dans cette phase 1** : 
- Les **7 g√©n√©rations OpenAI** restent en l'√©tat, on les laisse temporairement dans `localStorage`
- Le **statut de g√©n√©ration** (`generation_status`) reste √©galement dans `localStorage`
- Afin de laisser la compatibilit√© temporaire avec **√âtape 6 Communication** qui reste en `localStorage`
- Afin de **limiter les risques** et identifier plus facilement de potentiels bugs
---
## **PLAN PROPOS√â DE REDACTION DES DOCUMENTS PREPARATOIRES EN 5 SECTIONS PRINCIPALES**

## **SECTION 1 - FONDATIONS SQL (11 √©l√©ments)**
1. **Table `etapes_1to5`** (1 √©l√©ment)
2. **Fonctions SQL Helper** (4 √©l√©ments)
3. **Triggers SQL** (4 √©l√©ments)
4. **Politiques RLS** (2 √©l√©ments)
---
## **SECTION 2 - UTILITAIRES (10 √©l√©ments)**
5. **Utilitaires Formatage** (4 √©l√©ments)
6. **Utilitaires Validation** (5 √©l√©ments)
7. **Utilitaires Conversion/Mapping** (3 √©l√©ments)
---
## **SECTION 3 - HOOKS REACT (7 √©l√©ments)**
8. **Hook Technique** (1 √©l√©ment √† adapter)
9. **Hook Progression** (1 √©l√©ment)
10. **Hooks M√©tier** (5 √©l√©ments)
---
## **SECTION 4 - SERVICES OPENAI (7 √©l√©ments)**
11. **Services de G√©n√©ration** (7 √©l√©ments)
---
## **SECTION 5 - COMPOSANTS & CONTEXTES (12 √©l√©ments √† adapter)**
12. **Composants React** (8 √©l√©ments √† adapter)
13. **Contexte React** (1 √©l√©ment √† adapter)
14. **Script de Migration** (1 √©l√©ment)
---



## **Directive : Imp√©ratif d'Architecture : Convention du nommage `camelCase`**
**Interdiction formelle de transformation  `snake_case`**
- Il est **STRICTEMENT INTERDIT** de transformer ces champs `camelCase` en `snake_case` (ex: `agency_name`, `property_type`) lors de la migration vers Supabase, sous peine de :

**Imp√©ratif absolu pour la migration**
- **Tous les hooks, fonctions, et interactions Supabase cr√©√©s lors de la migration DOIVENT imp√©rativement :**
    - **Conserver la structure `camelCase` existante** pour les champs m√©tier (`agencyName`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`, `propertyDescription`, `financials`, `details`, `exclusivite`, `location`, `reference`).
    - **Utiliser `snake_case` uniquement** pour les champs syst√®me Supabase (`organisation_id`, `user_id`, `created_at`, `updated_at`, `project_id`, etc.).
**Cette convention `camelCase` est un imp√©ratif absolu :  elle garantit une migration sans rupture et √©vite tout bug de transformation.**
---
## **Directive non n√©gocable des Ressources imp√©ratives √† consulter et √† appliquer  pour r√©diger les documents des 5 sections**
**Avant tout codage d'√©l√©ments. Imp√©ratif absolu de consulter**

- **L'int√©gralit√© des fiohiers de l'application**
- **Les tables et contraintes actuelles dans Supabase** (hooks, fonctions...)
- **Relire les documets strat√©giques**
  - public/1. Documents Strat√©giques/01. Pr√©sentation LeadGenAi.md
  - public/1. Documents Strat√©giques/02. Pr√©sentation Structure LeadGenAi.md
  - public/1. Documents Strat√©giques/03. Logique Organisations.md
  - public/1. Documents Strat√©giques/04. Relations Business entre Tables.md
  - public/1. Documents Strat√©giques/05. Relations Users Utilisateurs.md
  - public/1. Documents Strat√©giques/06. R√©f√©rence des Hooks Strat√©giques.md
  - public/1. Documents Strat√©giques/07.1. FormCreationReseau - Gestion Informations Partag√©es entre R√©seau et R√©seau Direction.md
  - public/1. Documents Strat√©giques/07.2. FormGestionReseau - Gestion Informations Partag√©es entre R√©seau et R√©seau Direction.md
  - public/1. Documents Strat√©giques/08. Gestion du Menu Gauche.md
  - public/1. Documents Strat√©giques/09. Structure - Organisation | Client_id.md
  - public/1. Documents Strat√©giques/10. Structure des Tables de Connexion & R√®gles Collaborateurs.md
- **Relire la strat√©gie de la phase 1**
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/.00--0.StrategiePhase1.md
- **Relire les audits des √©tapes**
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/01.Etape1.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/02.Etape2.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/03.Etape3.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/04.Etape4.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/05.Etape5.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/06.Etape5animation.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/07.BilanEtape1aEtape5.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/08.ProcessEnvoiInfosOpenAI.md
  - public/4. ReadMe EtapesAnnonces/01.Etape1√†5/09.ProcessPassageEtapeSuivante.md
- **Relire la table pr√©patoire et ses notes de bas de page et le doc multitenant**
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/01--0.Table_etapes1to5.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/01--1.GestionStrategieMultiTenant.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/01--3.ExplicationdesChamps.md
- **Relire la bible des elements de r√©f√©rence**
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/02--0.BibleR√©f√©rences.md
- **Relire le d√©tail de la strat√©gie et le tableau r√©capitulatif des √©l√©ments**
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/03--0.D√©tailStrat√©giePhase1.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/03--1.TableauRecapElementsACr√©er.md
- **Relire les directives pr√©paratoires √† la section 4 et la cr√©ation de 2 nouvelles tables**
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04--0.Section4-Directives.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04--1.Section4-TableOpenAiKeys.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04--2.Section4-TableOpenAILogs.md
- **6/ Lire et m√©moriser les documents pr√©paratoires au codage qui ont √©t√© valid√©s**
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/05--0.DocsPr√©paratoireCodagePhase1.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/05--1.DocSection1Valid√©e.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/05--2.DocSection2Valid√©e.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/05--3.DocSection3Valid√©e.md
  - public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/05--4.DocSection4Valid√©e.md

---
## **Directives de r√©daction des √©l√©ments**
- **Introduire le document par un sommaire cliquable**
- **Privl√©gier la pr√©sentation sous forme de tableau**
- **Etre exhausitif pour laisser le moins de zones d'ombres possibles lors de l'√©tape de codage**
- **Eviter les commentaires inutiles**
- **Nommer l'int√©gralit√© des √©l√©ments champs formulaires, fonctions, √©lements pr√©cis de la table qui seront utilis√©s lors du codage**
- **Eviter au maximum de longues s√©ries de codes. Le codage sera effectu√© √† l"√©tape suivante**
- **Structure de pr√©sentation de chaque √©l√©ment**
  - Nom de l'√©l√©ment (ex. Hook √âtape 1)
  - Nom pr√©vu dans la migration (ex.HookEtape-1.ts)
  - Emplacement pr√©vu (ex.src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/HookEtape-1.ts)
  - Fonctions principales (liste des fonctions expos√©es)
  - tableau
    - Contraintes de namming √† respecter
    - Contraintes techniques √† respecter
    - Autres informations conditionn√©es par la nature de l'√©l√©ment
    - Autres informations indispensables pour la cr√©ation d'un bon code
- **R√®gles concernant les sql**
    - Les sql devront √™tre nomm√©es et d√©compos√©es en √©tape de migration pour eviter des migrations trop lourdes pour Supabase
- **R√®gles concernant le nommage des camelCase**
    - **R√®gle SQL - Cr√©ation de table**
      - Champs m√©tier : `"camelCase"` (avec guillemets doubles)
      - Champs syst√®me : `snake_case` (sans guillemets)
    - **R√®gle TypeScript - Hooks & Services**
      - Utilisation directe du `camelCase` pour champs m√©tier
      - Utilisation directe du `snake_case` pour champs syst√®me
      - **AUCUNE fonction de conversion n'est n√©cessaire**
    - **R√®gle Triggers**
      - Utiliser : `NEW."camelCase"` ou `NEW.snake_case`
      - Pr√©f√©rer les fonctions g√©n√©riques r√©utilisables
---
## **EMPLACEMENTS**
* **Les emplacements des fichiers suivent des r√®gles imp√©ratives.**
* **Principe :** privil√©gier les noms explicites et en fran√ßais.
* **Les Hooks seront imp√©rativement cr√©√©s dans le dossier :**

  * `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks`
* **Les composants, helpers, utilitaires, react :**

  * `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.Components`
  * `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires`
  * `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/04.React`
* **Les fonctions devront suivre un naming coh√©rent :**

  * `supabase/functions/annonce-phase1-[nom_fonction]/index.ts`
* **Les utilitaires de migration :**

  * `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/05.UtilitaireMigration/`
 
  * 
#### **Rappel complet de la nomenclature actuelle**

**SECTION 1 -Supabase / Fonctions serveurs :**

```
supabase/functions/annonce-phase1-shared/
supabase/functions/annonce-phase1-get-project-data/index.ts
supabase/functions/annonce-phase1-get-project-data/types.ts
supabase/functions/annonce-phase1-get-active-key/index.ts 
supabase/functions/annonce-phase1-get-active-key/types.ts
supabase/functions/annonce-phase1-update-token-counters/index.ts
supabase/functions/annonce-phase1-update-token-counters/types.ts
supabase/functions/annonce-phase1-shared/helpers.ts  
supabase/functions/annonce-phase1-shared/constants.ts
```

**SECTION 2 ‚Äî Utilitaires & Validation**

```
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape1.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape2.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape3.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape4.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/mapSupabaseToPrompt.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/mapPromptOutput.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/formatCurrency.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/sanitizeText.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/formatAddress.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/convertLocalToSupabase.ts
```

**SECTION 3 ‚Äî Hooks √âtapes 1‚Üí5**

```
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useSupabaseEtapesOperations.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/01.Etape1/HookEtape-1.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/02.Etape2/HookEtape-2.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/03.Etape3/HookEtape-3.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/04.Etape4/HookEtape-4.ts
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/05.Etape5/HookEtape-5.ts
```

**SECTION 4 ‚Äî Services OpenAI**

```
src/services/openai/01.SupabaseEtape1to5/1.Services/1.AnnonceSiteInternet.ts
src/services/openai/01.SupabaseEtape1to5/1.Services/2.AnnonceFichedeSynthese.ts
src/services/openai/01.SupabaseEtape1to5/1.Services/3.AnnonceNewsletter.ts
src/services/openai/01.SupabaseEtape1to5/1.Services/4.OutilsSEO.ts
src/services/openai/01.SupabaseEtape1to5/1.Services/5.SMSAnnonce.ts
src/services/openai/01.SupabaseEtape1to5/1.Services/6.GoogleBusinessProfileAnnonce.ts
src/services/openai/01.SupabaseEtape1to5/1.Services/7.ReseauxSociauxAnnonce.ts
```

**SECTION 5 ‚Äî React & Migration**

```
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/04.React/01.AnnonceContext.tsx
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/04.React/02.Etape1FormulaireBienCommercial.tsx
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/04.React/03.Etape2ChoixTypeAnnonce.tsx
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/04.React/04.Etape3ValidationRecap.tsx
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/04.React/05.Etape4ReglagesParametrages.tsx
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/04.React/06.Etape5GenerationAnnonce.tsx
src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/05.UtilitaireMigration/migrateLocalStorageToSupabase.ts
```

---
---
## **Directive ‚Äî Conservation int√©grale des prompts localstorage**

| √âl√©ment                  | D√©tail                                                                                                                                                                                                                                           |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Objectif**             | Garantir que tous les prompts OpenAI actuels (issus du MVP LocalStorage) soient **utilis√©s √† l‚Äôidentique**, sans reformulation, ni simplification, ni enrichissement automatique.                                                                |
| **Contexte**             | Les prompts existants ont √©t√© calibr√©s manuellement pour obtenir un style, une coh√©rence et des r√©sultats optimaux avec tes APIs et assistants OpenAI.                                                                                           |
| **Emplacement**          | `/src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`                                                                                                                                                                            |
| **Structure actuelle**   | 7 fichiers prompts individuels :<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/1.PromptAnnonceSiteInternet.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/2.PromptAnnonceFichedeSynthese.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/3.PromptAnnonceNewsletter.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/4.PromptOutilsSEO.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/5.PromptSMSAnnonce.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/6.PromptGoogleBusinessProfileAnnonce.ts<br>src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/7.PromptReseauxSociauxAnnonce.ts|
| **R√®gle absolue**        | ‚ûú Aucune r√©√©criture automatique des prompts (m√™me minime). <br>‚ûú Aucun nettoyage texte (`trim`, `replace`, `sanitize`). <br>‚ûú Aucun regroupement (pas de ‚Äúprompt builder‚Äù).                                                                      |
| **Mode d‚Äôappel**         | Chaque fonction de g√©n√©ration (`generateWebsiteAd`, `generateSummarySheetAd`, etc.) appelle **le prompt correspondant** via `import` direct.                                                                                                     |
| **Stockage des prompts** | Tous les prompts restent **dans le front**, sous ton contr√¥le. <br>Ils ne sont pas d√©plac√©s dans Supabase, ni externalis√©s.                                                                                                                      |
| **Impact attendu**       | Garantit la continuit√© exacte du comportement g√©n√©ratif valid√© en production MVP.                                                                                                                                                                |

---

##  **Directive ‚Äî Processus d‚Äôenvoi des prompts vers OpenAI**

| √âl√©ment                 | D√©tail confirm√©                                                                                                                                                                                                                           |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Objectif**            | Garantir que le **processus d‚Äôappel aux 7 services OpenAI** reste **strictement identique** √† celui du localStorage actuelle.                                                                                                                  |
| **Mode d‚Äôex√©cution**    | **S√âQUENTIEL** : les 7 appels s‚Äôex√©cutent l‚Äôun apr√®s l‚Äôautre avec `await`.<br>‚Üí aucun appel en parall√®le ; chaque g√©n√©ration attend la fin de la pr√©c√©dente.                                                                              |
| **Ordre d‚Äôex√©cution**   | 1Ô∏è‚É£ `generateWebsiteAd()` ‚Üí 2Ô∏è‚É£ `generateSummarySheetAd()` ‚Üí 3Ô∏è‚É£ `generateNewsletterAd()` ‚Üí 4Ô∏è‚É£ `generateSEOTools()` ‚Üí 5Ô∏è‚É£ `generateSMSAd()` ‚Üí 6Ô∏è‚É£ `generateGoogleBusinessProfileAd()` ‚Üí 7Ô∏è‚É£ `generateReseauxSociauxAd()`.                |
| **API utilis√©e**        | `POST https://api.openai.com/v1/chat/completions` (Chat Completions API).                                                                                                                                                                 |
| **Mode d‚Äôappel**        | **Stateless** : chaque appel est ind√©pendant (aucune conversation ni contexte partag√©).                                                                                                                                                   |
| **Mod√®le**              | - Modification du mod√®le-> utiliser "gpt-5-mini-2025-08-07"<br>- max_completion_tokens (remplace max_tokens)<br>- Param√®tre temperature supprim√©                                                                                          |
| **Gestion d‚Äôerreurs**   | Chaque appel dispose de son propre `try / catch` ; si un √©choue, les suivants continuent (aucun blocage global).                                                                                                                          |
| **Stockage temporaire** | Les r√©sultats sont imm√©diatement sauvegard√©s dans `localStorage` (Phase 1 : aucune √©criture Supabase).                                                                                                                                    |
| **Progression**         | `generation_status` mis √† jour apr√®s chaque √©tape : 14 % ‚Üí 28 % ‚Üí ‚Ä¶ ‚Üí 100 %.                                                                                                                                                              |
| **Format de retour**    | Le contenu g√©n√©r√© est renvoy√© en **JSON structur√©**, pars√©, puis stock√© tel quel (aucune modification ni reformattage).                                                                                                                   |
| **Prompts utilis√©s**    | Chaque appel importe son **prompt d√©di√©** (ex. : `PromptAnnonceSiteInternet.ts`) ; seules les variables dynamiques (`agencyName`, `propertyType`, etc.) sont remplac√©es.                                                                  |
| **Migration Phase 1**   | - Lire les donn√©es dans `etapes_1to5` au lieu de `localStorage.propertyData`.<br>- Utiliser les m√™mes prompts sans modification<br>- Conserver exactement le m√™me processus d'envoi s√©quentiel.<br>- Stocker temporairement les r√©sultats dans localStorage (comme actuellement judqu'√† la validation et la migration de la phase 1)<br>- Maintenir la m√™me s√©quence et gestion d‚Äôerreurs. |

---

### **Directive ‚Äî Utilisation des API OpenAI**

| √âl√©ment                          | Sp√©cification valid√©e                                                                                                          |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| **Endpoint API**                 | `https://api.openai.com/v1/chat/completions`                                                                                   |
| **M√©thode HTTP**                 | `POST`                                                                                                                         |
| **Mod√®le**                       | `gpt-5-mini-2025-08-07`                                                                                                        |
| **Mode d‚Äôex√©cution**             | Stateless ‚Äì chaque requ√™te est ind√©pendante                                                                                    |
| **Param√®tres**                   | `json { "model": "gpt-5-mini-2025-08-07", "max_completion_tokens": 3000 } `                                                    |
| **Suppression de `temperature`** | Oui ‚Äì le param√®tre `temperature` n‚Äôest plus utilis√©                                                                            |
| **Mode d‚Äôappel**                 | S√©quentiel (`await` ‚Üí chaque requ√™te attend la pr√©c√©dente)                                                                     |
| **Format de message**            | `ts [ { role: "system", content: "You are a helpful assistant." }, { role: "user", content: "[PROMPT COMPLET]" } ] `           |
| **Format de r√©ponse attendu**    | JSON structur√© conforme aux sch√©mas actuels de sortie (Annonce, Fiche, Newsletter, SEO, SMS, Google Business, R√©seaux Sociaux) |
| **Authentification**             | Cl√© API r√©cup√©r√©e dynamiquement selon le tenant via la fonction `getActiveOpenAIKey(organisation_id)`                          |
| **Stockage des r√©sultats**       | R√©sultats enregistr√©s localement (`localStorage`) ‚Äì aucune √©criture en base pendant la Phase 1                                 |
| **Suivi de progression**         | `generation_status` mis √† jour apr√®s chaque g√©n√©ration (14 %, 28 %, ‚Ä¶, 100 %)                                                  |

---

### **Directive ‚Äì Table `openai_api_keys`**

| √âl√©ment                        | D√©tail                                                                                                                                                                                                                                        |
| :----------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Nom du module**              | Table `openai_api_keys`                                                                                                                                                                                                                       |
| **Objectif**                   | Centraliser la gestion s√©curis√©e des cl√©s OpenAI utilis√©es par l‚Äôapplication LeadGenAI AdBuilder.                                                                                                                                             |
| **R√¥le**                       | D√©terminer automatiquement quelle cl√© OpenAI utiliser pour chaque organisation (agence, r√©seau, ind√©pendant) ou, par d√©faut, la cl√© Presenca globale (`is_default = true`).                                                                   |
| **Composants principaux**      | - Champ `organisation_id` pour le rattachement multi-tenant<br>- Champ `openai_api_key` chiffr√©<br>- Champ `is_default` pour la cl√© globale Presenca<br>- Champs d‚Äôaudit : `created_at`, `updated_at`, `total_tokens_used`, `last_usage_at`   |
| **Type de table**              | Statique ‚Äì configuration par organisation                                                                                                                                                                                                     |
| **RLS (Row Level Security)**   | Chaque organisation ne peut lire/√©crire que sa propre cl√©.<br>`admin_presenca` a les droits complets.                                                                                                                                         |
| **Fonctionnement global**      | Lors d‚Äôun appel OpenAI, le service `getActiveOpenAIKey(organisation_id)` recherche la cl√© correspondant √† l‚Äôorganisation connect√©e, sinon utilise la cl√© globale Presenca.                                                                    |
| **Fichier explicatif complet** | üìÑ [public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04.1.v1.SECTION 4-2 ‚Äì SERVICES OPENAI.md](public/4.%20ReadMe%20EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04.1.v1.SECTION%204-2%20-%20SERVICES%20OPENAI.md) |

---

###  **Directive ‚Äì Table `openai_usage_logs`**

| √âl√©ment                        | D√©tail                                                                                                                                                                                                                                        |
| :----------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Nom du module**              | Table `openai_usage_logs`                                                                                                                                                                                                                     |
| **Objectif**                   | Suivre et enregistrer tous les appels OpenAI effectu√©s dans l‚Äôapplication, pour chaque utilisateur et chaque organisation.                                                                                                                    |
| **R√¥le**                       | Fournir un historique des g√©n√©rations IA et mettre √† jour automatiquement la consommation cumul√©e (`total_tokens_used`, `last_usage_at`) dans la table `openai_api_keys`.                                                                     |
| **Composants principaux**      | - Champs de rattachement : `organisation_id`, `user_id`<br>- Champs d‚Äôaudit : `service_name`, `model`, `tokens_used`, `prompt_tokens`, `completion_tokens`, `created_at`<br>- Trigger : `update_token_counters()`                             |
| **Type de table**              | Dynamique ‚Äì journalisation automatique                                                                                                                                                                                                        |
| **RLS (Row Level Security)**   | Les utilisateurs ne voient que les logs de leur propre organisation.<br>`admin_presenca` a un acc√®s complet.                                                                                                                                  |
| **Fonctionnement global**      | Chaque appel OpenAI enregistre une ligne dans `openai_usage_logs`. Un trigger met √† jour la consommation cumul√©e et la date du dernier usage dans `openai_api_keys`.                                                                          |
| **Fichier explicatif complet** | üìÑ [public/4. ReadMe EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04.1.v1.SECTION 4-3 ‚Äì SERVICES OPENAI.md](public/4.%20ReadMe%20EtapesAnnonces/03.PreparationMigration/01.Etape1to5/04.1.v1.SECTION%204-3%20-%20SERVICES%20OPENAI.md) |



---
---



---

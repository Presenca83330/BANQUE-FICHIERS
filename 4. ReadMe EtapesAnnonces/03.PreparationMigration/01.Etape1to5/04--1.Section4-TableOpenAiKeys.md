# Table : openai_api_keys

## Objectif
Table de configuration statique multi-tenant pour la gestion des **cl√©s OpenAI** et des comptes associ√©s.  
Elle contient la **cl√© Presenca par d√©faut** ainsi que, de mani√®re optionnelle, les cl√©s sp√©cifiques de certaines structures (r√©seau, agence, ind√©pendant).

**LeadGenAI AdBuilder** est **multi-tenant** :
- chaque entit√© (R√©seau, Agence, Ind√©pendant) a son propre environnement d‚Äôannonces et ses propres utilisateurs.
- Actuellement, toutes les g√©n√©rations OpenAI (annonces, fiches, newsletters, etc.) utilisent **ta cl√© Presenca** ‚Äî
- ce qui est parfait pour la majorit√© des cas (‚âà 90 %).
- Mais il faut pr√©voir que certaines structures (r√©seau ou agence) puissent,
- **√† terme ou exceptionnellement**, utiliser **leur propre cl√© OpenAI**.
- ‚Üí par exemple : un grand r√©seau immobilier avec son propre compte OpenAI.

---

## **R√¥le fondamental de la table `openai_api_keys`**
- Cette table sert √† **g√©rer et stocker toutes les cl√©s OpenAI actives ou disponibles**
- selon les r√®gles de ta hi√©rarchie multi-tenant.

| Niveau          | Type de cl√©                              | Utilisation                                   |
| --------------- | ---------------------------------------- | ---------------------------------------------- |
| **Global**      | cl√© Presenca (`is_default = true`)    | utilis√©e par tous si rien d‚Äôautre n‚Äôest d√©fini |
| **R√©seau**      | Cl√© OpenAI du r√©seau-agence    |  `reseau` + `reseau_direction`|
| **R√©seau Agence**      | Cl√© OpenAI du r√©seau-agence | `reseau_agence`, `reseau_agence_responsable`, `reseau_agence_collaborateur`|
| **Agence Ind√©pendante** | Cl√© OpenAI de l‚Äôagence ind√©pendante    |  `agence_independante`, `agence_independante_responsable`, `agence_independante_collaborateur` |

---

## üß† **Ce que la table permet concr√®tement**

| Fonction                                                                     | Description                                                                                                                           |
| ---------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| **Centralisation**   | Toutes les cl√©s (ta cl√© principale et les cl√©s clients) sont stock√©es dans une seule table, chiffr√©es et s√©curis√©es. |
| **S√©lection automatique**  | Lors d‚Äôun appel OpenAI, l‚Äôapplication d√©termine **quelle cl√© utiliser** :  |
| 1/ Si un utilisateur poss√®de une cl√© ‚Üí on l‚Äôutilise. |   |
| 2/ Sinon ‚Üí on utilise **ta cl√© Presenca par d√©faut** (`is_default = true`). | |
| **S√©curit√©** | Les cl√©s sont stock√©es **chiffr√©es** (jamais en clair) et prot√©g√©es par les RLS. |
| Chaque organisation ne peut voir **que sa cl√©**.|   |
| **Audit et suivi** | Les champs `total_tokens_used` et `last_usage_at` permettent de suivre la consommation par cl√© (mise √† jour via `openai_usage_logs`). |
| **√âvolutivit√©** | La table int√®gre d√®s maintenant les colonnes ‚Äúassistants OpenAI‚Äù (futures √©volutions). |
| Tu pourras y relier tes assistants sans migration SQL plus tard.   |  |

---

## üß± **Structure hi√©rarchique (multi-tenant)**

| Structure                                                                                     | Cl√© utilis√©e                             | H√©ritage                                 |
| --------------------------------------------------------------------------------------------- | ---------------------------------------- | ---------------------------------------- |
| `reseau`, `reseau_direction`                                                                  | cl√© du r√©seau (si existe)                | sinon cl√© Presenca                       |
| `reseau_agence`, `reseau_agence_responsable`, `reseau_agence_collaborateur`                   | cl√© du r√©seau-agence (si existe)         | sinon cl√© du r√©seau ‚Üí sinon cl√© Presenca |
| `agence_independante`, `agence_independante_responsable`, `agence_independante_collaborateur` | cl√© de l‚Äôagence ind√©pendante (si existe) | sinon cl√© Presenca                       |

---

## üìä **Donn√©es stock√©es**

| Champ                 | R√¥le                                                  |
| --------------------- | ----------------------------------------------------- |
| `openai_api_key`      | Cl√© OpenAI chiffr√©e                                   |
| `organisation_id`     | Rattachement multi-tenant                             |
| `is_default`          | Indique la cl√© Presenca principale                    |
| `is_active`           | Permet de d√©sactiver une cl√©                          |
| `total_tokens_used`   | Compteur global de tokens utilis√©s                    |
| `last_usage_at`       | Dernier appel enregistr√©                              |
| `token_limit`         | Seuil maximal de tokens autoris√©s (Phase 2, inactif)  |
| `alert_threshold`     | Niveau d‚Äôalerte (80 % par d√©faut, Phase 2, inactif)   |
| `assistant_*_id`      | Champs r√©serv√©s pour futurs assistants OpenAI         |

---

## üîê **S√©curit√© et permissions**

* Les r√®gles RLS garantissent qu‚Äôun r√©seau ne peut pas voir la cl√© d‚Äôun autre r√©seau.
* Seul `admin_presenca` peut lire/modifier la cl√© globale.
* Lorsqu‚Äôun utilisateur du r√©seau effectue une g√©n√©ration, le service OpenAI
  choisit automatiquement la bonne cl√© sans intervention manuelle.

---

### ‚úÖ **En r√©sum√©**
> La table `openai_api_keys` est le **registre central et s√©curis√© des cl√©s OpenAI**.
> Elle permet :
>
> * d‚Äôutiliser ta cl√© Presenca par d√©faut,
> * de g√©rer quelques cl√©s clients de fa√ßon isol√©e,
> * de suivre leur usage,
> * de d√©finir un quota futur de consommation (Phase 2),
> * et de pr√©parer la future int√©gration des assistants IA.

---

## Structure technique

| Table       | Code champ          | Description                            | Obligatoire | Facultatif | Condition de remplissage | Droits de modification tables | Droits de modification presenca | Type SQL | Cl√© primaire (PK) | Cl√© √©trang√®re (FK) | R√©f√©rence vers table | Contraintes Supabase | Type d'identifiant | Actions √† pr√©voir |
|:------------|:--------------------|:---------------------------------------|:------------|:-----------|:-------------------------|:------------------------------|:--------------------------------|:---------|:------------------|:-------------------|:---------------------|:---------------------|:-------------------|:------------------|
| `openai_api_keys` | `id` | Identifiant unique de la cl√© | ‚úÖ | ‚ùå | Auto g√©n√©r√© | ‚ùå | ‚úÖ | `uuid` | ‚úÖ | ‚ùå | - | DEFAULT uuid_generate_v4() | `uuid` | Aucune |
| | `organisation_id` | R√©f√©rence vers l‚Äôorganisation li√©e √† la cl√© | ‚ùå | ‚úÖ | Null si cl√© Presenca globale | ‚úÖ (par organisation) | ‚úÖ | `uuid` | ‚ùå | ‚úÖ | `organisations.id` | FK organisation | `uuid` | Cr√©er index Supabase |
| | `openai_api_key` | Cl√© API OpenAI (format sk-proj‚Ä¶) | ‚úÖ | ‚ùå | Crypt√©e et unique | ‚úÖ | ‚úÖ | `text` | ‚ùå | ‚ùå | - | Cryptage Supabase | `text` | crypter champ |
| | `openai_email_compte` | Email du compte OpenAI **client** | ‚ùå | ‚úÖ | Facultatif, pour suivi administratif | ‚úÖ | ‚úÖ | `text` | ‚ùå | ‚ùå | - | CHECK format email | `text` | - |
| | `is_default` | D√©finit la cl√© Presenca principale | ‚úÖ | ‚ùå | Une seule ligne √† TRUE | ‚ùå | ‚úÖ | `boolean` | ‚ùå | ‚ùå | - | UNIQUE (is_default=TRUE) | `boolean` | Cr√©er contrainte |
| | `is_active` | Activation de la cl√© | ‚úÖ | ‚ùå | TRUE/FALSE | ‚úÖ | ‚úÖ | `boolean` | ‚ùå | ‚ùå | - | DEFAULT TRUE | `boolean` | - |
| | `total_tokens_used` | Compteur total de tokens consomm√©s | ‚ùå | ‚úÖ | Auto incr√©ment via log | ‚úÖ | ‚úÖ | `bigint` | ‚ùå | ‚ùå | - | DEFAULT 0 | `bigint` | Trigger auto (Phase 2) |
| | `last_usage_at` | Dernier appel enregistr√© | ‚ùå | ‚úÖ | MAJ auto via log | ‚úÖ | ‚úÖ | `timestamp` | ‚ùå | ‚ùå | - | - | `timestamp` | Trigger auto (Phase 2) |
| | `token_limit` | Limite maximale de tokens autoris√©s | ‚ùå | ‚úÖ | Valeur fixe ou modifiable par Presenca | ‚úÖ | ‚úÖ | `bigint` | ‚ùå | ‚ùå | - | DEFAULT 500000 | `bigint` | Phase 2 ‚Äî limite |
| | `alert_threshold` | Seuil d‚Äôalerte de consommation | ‚ùå | ‚úÖ | D√©clenchement d‚Äôalerte √† 80 % par d√©faut | ‚úÖ | ‚úÖ | `numeric(3,2)` | ‚ùå | ‚ùå | - | DEFAULT 0.8 | `numeric(3,2)` | Phase 2 ‚Äî alerte |
| | `created_at` | Date de cr√©ation de la ligne | ‚úÖ | ‚ùå | Auto g√©n√©r√©e | ‚úÖ | ‚úÖ | `timestamp` | ‚ùå | ‚ùå | - | DEFAULT now() | `timestamp` | - |
| | `updated_at` | Date de derni√®re modification | ‚úÖ | ‚ùå | MAJ auto via trigger `set_updated_at()` | ‚úÖ | ‚úÖ | `timestamp` | ‚ùå | ‚ùå | - | Trigger auto update | `timestamp` | Trigger obligatoire |
| | `assistant_*_id` | R√©servation ID d‚Äôassistant OpenAI (futur) | ‚ùå | ‚úÖ | Inactif (Phase 2) | ‚úÖ | ‚úÖ | `text` | ‚ùå | ‚ùå | - | Null autoris√© | `text` | - |

---

## Multi-tenant (hi√©rarchie)

| Structure | Cl√© utilis√©e |
|------------|---------------|
| `reseau`, `reseau_direction` | Cl√© OpenAI du r√©seau |
| `reseau_agence`, `reseau_agence_responsable`, `reseau_agence_collaborateur` | Cl√© OpenAI du r√©seau-agence |
| `agence_independante`, `agence_independante_responsable`, `agence_independante_collaborateur` | Cl√© OpenAI de l‚Äôagence ind√©pendante |
| Si aucune cl√© sp√©cifique n‚Äôexiste ‚Üí | Cl√© globale Presenca (`is_default = true`) |

---

## R√®gles RLS (Row Level Security)
- Chaque utilisateur ne peut lire que la cl√© li√©e √† **son `organisation_id`**.
- `admin_presenca` peut lire et modifier toutes les cl√©s.
- Cl√© `is_default = true` visible uniquement pour `admin_presenca`.

---

# **Explication des champs ‚Äì Tables `openai_api_keys`**

## Objectif global
- Centraliser la configuration des **cl√©s OpenAI** utilis√©es par le syst√®me LeadGenAI AdBuilder
- dans un contexte **multi-tenant**, avec une cl√© par structure et une cl√© globale Presenca par d√©faut.
- Elle permet √©galement de suivre le volume global de tokens consomm√©s par chaque cl√©.

---

## D√©tail des champs

| Champ | Titre | Objectif | Fonctionnement | R√¥le | Utilisation | Utilis√©e par (services / hooks) | Trigger SQL | Type SQL & Contraintes | Valeurs possibles | Interdictions (CHECK) |
|--------|--------|-----------|----------------|------|--------------|--------------------------------|--------------|------------------------|------------------|----------------------|
| `id` | Identifiant unique | Identifier chaque cl√© | G√©n√©r√© automatiquement par Supabase | Cl√© primaire unique | Interne √† la table | Tous les services OpenAI | DEFAULT uuid_generate_v4() | `uuid` | Unique | Null interdit |
| `organisation_id` | Organisation li√©e | Lier la cl√© √† une entit√© multi-tenant | Si `NULL` ‚Üí cl√© Presenca globale | Base de la hi√©rarchie multi-tenant | `getActiveOpenAIKey()` | Services OpenAI | FK vers `organisations.id` | `uuid` | UUID valide | Null autoris√© uniquement si cl√© globale |
| `openai_api_key` | Cl√© OpenAI chiffr√©e | Stocker de fa√ßon s√©curis√©e la cl√© API client ou Presenca | Crypt√©e en base via `pgcrypto` ou secret Supabase | Authentification pour les appels OpenAI | Tous les appels s√©quentiels (√âtape 5) | `generateWebsiteAd()`, `generateNewsletterAd()`, etc. | Encrypt/Decrypt | `text` | Format sk-proj-xxxxx | Null interdit |
| `openai_email_compte` | Email du compte OpenAI client | Identifier le compte client li√© √† la cl√© | Renseign√© uniquement si la cl√© provient d‚Äôune organisation cliente | Suivi administratif | Interface Admin (Presenca) | Aucun service direct | CHECK format email si non vide | `text` | Email valide (`*@*.*`) | Optionnel, vide autoris√© |
| `is_default` | Cl√© Presenca par d√©faut | Indique la cl√© globale utilis√©e par d√©faut | TRUE sur une seule ligne (cl√© Presenca) | Fallback global | Fonction `getActiveOpenAIKey()` | Services OpenAI | UNIQUE WHERE is_default=TRUE | `boolean` | TRUE/FALSE | Une seule TRUE autoris√©e |
| `is_active` | Activation de la cl√© | Activer ou d√©sactiver une cl√© client sans la supprimer | TRUE = cl√© utilisable / FALSE = d√©sactiv√©e | Contr√¥le d‚Äôacc√®s | Admin Presenca / R√©seau | Utilis√© avant chaque appel OpenAI | DEFAULT TRUE | `boolean` | TRUE/FALSE | Null interdit |
| `total_tokens_used` | Total de tokens consomm√©s | Cumul des tokens utilis√©s pour cette cl√© | Mis √† jour automatiquement √† chaque appel via `openai_usage_logs` | Suivi de consommation IA | Dashboard Admin / Audit | Trigger `update_token_counters` (Phase 2) | Trigger MAJ | `bigint` | >= 0 | - |
| `last_usage_at` | Dernier usage | Historique de la derni√®re requ√™te OpenAI | Mis √† jour automatiquement par trigger | Audit d‚Äôactivit√© | Suivi usage Admin | Trigger `update_token_counters` (Phase 2) | Trigger MAJ | `timestamp` | - | - |
| `token_limit` | Limite maximale de tokens | Plafonner la consommation autoris√©e | D√©fini par l‚Äôadministrateur Presenca | Contr√¥le du co√ªt | Dashboard IA | Admin Presenca | Trigger futur (Phase 2) | `bigint DEFAULT 500000` | >= 0 | Null interdit |
| `alert_threshold` | Seuil d‚Äôalerte de consommation | D√©clenche une alerte √† 80 % de la limite | Valeur comprise entre 0 et 1 | Pr√©-alerte IA | Dashboard IA | Admin Presenca | Trigger futur (Phase 2) | `numeric(3,2) DEFAULT 0.8` | 0 ‚â§ val ‚â§ 1 | Null interdit |
| `created_at` | Cr√©ation | Historique de cr√©ation | Auto-g√©n√©r√© √† l‚Äôinsertion (`DEFAULT now()`) | Audit | Interface d‚Äôadministration | - | Aucun (DEFAULT) | `timestamp` | now() | - |
| `updated_at` | Derni√®re mise √† jour | Historique de modification | Mis √† jour automatiquement via trigger `set_updated_at()` | Audit des modifications | Back-office | - | ‚úÖ Trigger obligatoire | `timestamp` | now() | Null interdit |
| `assistant_*_id` | Identifiants assistants OpenAI | R√©servation pour futures int√©grations Assistants | Inactif (Phase 2, pas utilis√© actuellement) | Compatibilit√© future | Aucune | - | Null autoris√© | `text` | Format `asst_XXXX` | - |

---

## Gestion multi-tenant

| Niveau hi√©rarchique | Cl√© OpenAI utilis√©e |
|----------------------|--------------------|
| `reseau` + `reseau_direction` | Cl√© OpenAI r√©seau |
| `reseau_agence` + `reseau_agence_responsable` + `reseau_agence_collaborateur` | Cl√© OpenAI r√©seau-agence |
| `agence_independante` + `agence_independante_responsable` + `agence_independante_collaborateur` | Cl√© OpenAI agence ind√©pendante |
| Si aucune cl√© trouv√©e | Cl√© globale Presenca (`is_default = true`) |

---

## Triggers et automatisations
- **Trigger 1 :** mise √† jour automatique de `total_tokens_used` et `last_usage_at`  
  ‚Üí √† chaque insertion dans `openai_usage_logs`.
- **Trigger 2 :** mise √† jour du champ `updated_at` √† chaque modification.

---

## üîÆ Pr√©paration Phase 2 ‚Äî Gestion des quotas et alertes tokens

- Les champs `token_limit` et `alert_threshold` pr√©parent la **gestion future des quotas**.
- Ils ne sont pas actifs en Phase 1 mais serviront √† :
  - plafonner la consommation par cl√©,
  - d√©clencher des alertes √† 80 % du quota (`alert_threshold = 0.8`),
  - d√©sactiver automatiquement une cl√© (`is_active = false`) si le seuil `token_limit` est atteint.
- Le cumul `total_tokens_used` sera synchronis√© avec `openai_usage_logs`.
- Ces m√©canismes seront g√©r√©s via triggers SQL et une interface d‚Äôadministration Presenca.

---

## Synth√®se

| Table | Type | R√¥le |
|--------|------|------|
| `openai_api_keys` | Statique | Configuration et gestion des cl√©s OpenAI (multi-tenant) |

# üîç  STRAT√âGIE MULTI-TENANT POUR LA TABLE `etapes_1to5`


## üìã OBJECTIF

**Structure multi-tenant Supabase** avec visibilit√© hi√©rarchique contr√¥l√©e.

Chaque entit√© dispose d'un espace de travail isol√© et s√©curis√©, bas√© sur:
- `organisation_id` (isolation tenant)
- `user_id` (cr√©ateur du projet)
- `utilisateur_type_compte` (d√©termine la visibilit√© hi√©rarchique)

### **R√®gles de visibilit√© hi√©rarchique:**

#### Pour les structures **R√©seaux**
| Type utilisateur | Acc√®s espace | Voit les projets de |
|------------------|--------------|---------------------|
| `reseau` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au r√©seau et √† sa direction) (Par respect confidentialit√© : Ne voit pas les projets des agences du r√©seau) |
| `reseau_direction` | `/accueil-leadgenai` | reseau + reseau_direction (projets internes au r√©seau et √† sa direction) (Par respect confidentialit√© : Ne voit pas les projets des agences du r√©seau)  |
| `reseau_agence` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_responsable` | `/accueil-leadgenai` | reseau_agence + reseau_agence_responsable + reseau_agence_collaborateur |
| `reseau_agence_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |

#### Pour les structures **Agences Ind√©pendantes**
| Type utilisateur | Acc√®s espace | Voit les projets de |
|------------------|--------------|---------------------|
| `agence_independante` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_responsable` | `/accueil-leadgenai` | agence_independante + agence_independante_responsable + agence_independante_collaborateur |
| `agence_independante_collaborateur` | `/accueil-leadgenai` | **Uniquement ses propres projets** |

---

## üéØ PRINCIPE FONDAMENTAL

**La visibilit√© hi√©rarchique repose sur 3 piliers:**

1. **`organisation_id`** ‚Üí Isolation tenant (tout utilisateur voit UNIQUEMENT son organisation)
2. **`user_id`** ‚Üí Cr√©ateur du projet (lien avec `users.users_id`)
3. **`utilisateur_type_compte`** ‚Üí D√©termine la port√©e de visibilit√© (via `utilisateurs` table)

**IMPORTANT:** On n'utilise PAS `client_id` pour la visibilit√©. Le `client_id` est un identifiant business unique par entit√©, pas un m√©canisme RLS.

---

## üèóÔ∏è ARCHITECTURE DE LA SOLUTION

### **1Ô∏è‚É£ COLONNES √Ä AJOUTER √Ä `etapes_1to5`**

```sql
-- ‚úÖ Colonnes syst√®me multi-tenant (snake_case)
organisation_id UUID NOT NULL REFERENCES organisations(organisation_id),
user_id UUID NOT NULL REFERENCES users(users_id),
utilisateur_type_compte TEXT NOT NULL,

-- ‚úÖ Colonnes optionnelles pour analytics/tra√ßabilit√© (snake_case)
reseau_id UUID REFERENCES reseau(reseau_id),
reseau_agence_id UUID REFERENCES reseau_agence(reseau_agence_id),
agence_indep_id UUID REFERENCES agence_independante(agence_indep_id),

-- ‚úÖ Contrainte de validation
CONSTRAINT valid_utilisateur_type_compte CHECK (
  utilisateur_type_compte IN (
    'reseau',
    'reseau_direction',
    'reseau_agence',
    'reseau_agence_responsable',
    'reseau_agence_collaborateur',
    'agence_independante',
    'agence_independante_responsable',
    'agence_independante_collaborateur'
  )
)
```

### **Pourquoi ces colonnes ?**

| Colonne | R√¥le | Obligatoire |
|---------|------|-------------|
| `organisation_id` | Isolation tenant (RLS niveau 1) | ‚úÖ Oui |
| `user_id` | Cr√©ateur du projet (lien avec users) | ‚úÖ Oui |
| `utilisateur_type_compte` | Type d'utilisateur (d√©termine visibilit√©) | ‚úÖ Oui |
| `reseau_id` | Lien optionnel vers r√©seau parent | ‚ö™ Non |
| `reseau_agence_id` | Lien optionnel vers agence r√©seau | ‚ö™ Non |
| `agence_indep_id` | Lien optionnel vers agence ind√©pendante | ‚ö™ Non |

---

## üîß FONCTIONS SQL HELPER N√âCESSAIRES

### **2Ô∏è‚É£ Fonction : R√©cup√©rer le type de compte utilisateur**

```sql
CREATE OR REPLACE FUNCTION public.get_user_type_compte(user_uuid UUID)
RETURNS TEXT
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = 'public'
AS $$
  SELECT utilisateur_type_compte
  FROM utilisateurs
  WHERE utilisateur_auth_uid = user_uuid
  LIMIT 1;
$$;
```

### **3Ô∏è‚É£ Fonction : R√©cup√©rer l'ID de l'agence r√©seau de l'utilisateur**

```sql
CREATE OR REPLACE FUNCTION public.get_user_reseau_agence_id(user_uuid UUID)
RETURNS UUID
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = 'public'
AS $$
  -- Pour reseau_agence_responsable
  SELECT ra.reseau_agence_id
  FROM reseau_agence_responsable rar
  JOIN users u ON u.users_id = rar.reseau_agence_responsable_utilisateur_id
  JOIN reseau_agence ra ON ra.reseau_agence_id = rar.reseau_agence_id
  WHERE u.users_auth_id = user_uuid
  LIMIT 1;
$$;
```

### **4Ô∏è‚É£ Fonction : R√©cup√©rer l'ID de l'agence ind√©pendante de l'utilisateur**

```sql
-- ‚úÖ FONCTION D√âJ√Ä EXISTANTE dans votre base
-- public.get_user_agence_indep_id(user_uuid UUID) ‚Üí RETURNS UUID
```

### **5Ô∏è‚É£ Fonction : V√©rifier si un user_id appartient √† une agence r√©seau**

```sql
CREATE OR REPLACE FUNCTION public.user_belongs_to_reseau_agence(
  p_user_id UUID,
  p_reseau_agence_id UUID
)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = 'public'
AS $$
  SELECT EXISTS (
    -- Responsable de cette agence
    SELECT 1 FROM reseau_agence_responsable
    WHERE reseau_agence_responsable_utilisateur_id = p_user_id
    AND reseau_agence_id = p_reseau_agence_id

    UNION

    -- Collaborateur de cette agence
    SELECT 1 FROM reseau_agence_collaborateur
    WHERE reseau_agence_collaborateur_utilisateur_id = p_user_id
    AND reseau_agence_id = p_reseau_agence_id
  );
$$;
```

### **6Ô∏è‚É£ Fonction : V√©rifier si un user_id appartient √† une agence ind√©pendante**

```sql
CREATE OR REPLACE FUNCTION public.user_belongs_to_agence_indep(
  p_user_id UUID,
  p_agence_indep_id UUID
)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = 'public'
AS $$
  SELECT EXISTS (
    -- Responsable de cette agence
    SELECT 1 FROM agence_independante_responsable
    WHERE agence_indep_responsable_utilisateur_id = p_user_id
    AND agence_indep_id = p_agence_indep_id

    UNION

    -- Collaborateur de cette agence
    SELECT 1 FROM agence_independante_collaborateur
    WHERE agence_indep_collaborateur_utilisateur_id = p_user_id
    AND agence_indep_id = p_agence_indep_id
  );
$$;
```

---

## üîê RLS POLICY POUR `etapes_1to5`

### **7Ô∏è‚É£ Policy SELECT : Visibilit√© hi√©rarchique**

```sql
CREATE POLICY "etapes_1to5_select_hierarchical"
ON public.etapes_1to5
FOR SELECT
TO authenticated
USING (
  -- üîë Admin PRESENCA voit tout
  is_admin_presenca(auth.uid())

  OR

  (
    -- ‚úÖ M√™me organisation (isolation tenant)
    organisation_id = get_user_organisation_id(auth.uid())

    AND

    -- ‚úÖ Logique de visibilit√© selon le type de compte
    CASE get_user_type_compte(auth.uid())

      -- üìç RESEAU / RESEAU_DIRECTION : voient projets 'reseau' + 'reseau_direction'
      WHEN 'reseau', 'reseau_direction' THEN
        utilisateur_type_compte IN ('reseau', 'reseau_direction')

      -- üìç RESEAU_AGENCE / RESEAU_AGENCE_RESPONSABLE : 
      --    voient projets de leur agence (agence + responsable + collaborateurs)
      WHEN 'reseau_agence', 'reseau_agence_responsable' THEN
        (
          reseau_agence_id = get_user_reseau_agence_id(auth.uid())
          AND utilisateur_type_compte IN (
            'reseau_agence',
            'reseau_agence_responsable',
            'reseau_agence_collaborateur'
          )
        )

      -- üìç RESEAU_AGENCE_COLLABORATEUR : uniquement ses propres projets
      WHEN 'reseau_agence_collaborateur' THEN
        user_id IN (
          SELECT users_id FROM users WHERE users_auth_id = auth.uid()
        )

      -- üìç AGENCE_INDEPENDANTE / AGENCE_INDEPENDANTE_RESPONSABLE :
      --    voient projets de leur agence (agence + responsable + collaborateurs)
      WHEN 'agence_independante', 'agence_independante_responsable' THEN
        (
          agence_indep_id = get_user_agence_indep_id(auth.uid())
          AND utilisateur_type_compte IN (
            'agence_independante',
            'agence_independante_responsable',
            'agence_independante_collaborateur'
          )
        )

      -- üìç AGENCE_INDEPENDANTE_COLLABORATEUR : uniquement ses propres projets
      WHEN 'agence_independante_collaborateur' THEN
        user_id IN (
          SELECT users_id FROM users WHERE users_auth_id = auth.uid()
        )

      ELSE false
    END
  )
);
```

### **8Ô∏è‚É£ Policy INSERT : Cr√©ation de projet**

```sql
CREATE POLICY "etapes_1to5_insert_own_organisation"
ON public.etapes_1to5
FOR INSERT
TO authenticated
WITH CHECK (
  -- ‚úÖ L'organisation ins√©r√©e doit √™tre celle de l'utilisateur
  organisation_id = get_user_organisation_id(auth.uid())

  AND

  -- ‚úÖ Le user_id doit correspondre √† l'utilisateur courant
  user_id IN (
    SELECT users_id FROM users WHERE users_auth_id = auth.uid()
  )

  AND

  -- ‚úÖ Le utilisateur_type_compte doit correspondre au type de l'utilisateur
  utilisateur_type_compte = get_user_type_compte(auth.uid())
);
```

### **9Ô∏è‚É£ Policy UPDATE : Modification de projet**

```sql
CREATE POLICY "etapes_1to5_update_hierarchical"
ON public.etapes_1to5
FOR UPDATE
TO authenticated
USING (
  -- ‚úÖ M√™me logique que SELECT (voir qui peut modifier)
  is_admin_presenca(auth.uid())

  OR

  (
    organisation_id = get_user_organisation_id(auth.uid())

    AND

    CASE get_user_type_compte(auth.uid())
      WHEN 'reseau', 'reseau_direction' THEN
        utilisateur_type_compte IN ('reseau', 'reseau_direction')

      WHEN 'reseau_agence', 'reseau_agence_responsable' THEN
        (
          reseau_agence_id = get_user_reseau_agence_id(auth.uid())
          AND utilisateur_type_compte IN (
            'reseau_agence',
            'reseau_agence_responsable',
            'reseau_agence_collaborateur'
          )
        )

      WHEN 'reseau_agence_collaborateur' THEN
        user_id IN (
          SELECT users_id FROM users WHERE users_auth_id = auth.uid()
        )

      WHEN 'agence_independante', 'agence_independante_responsable' THEN
        (
          agence_indep_id = get_user_agence_indep_id(auth.uid())
          AND utilisateur_type_compte IN (
            'agence_independante',
            'agence_independante_responsable',
            'agence_independante_collaborateur'
          )
        )

      WHEN 'agence_independante_collaborateur' THEN
        user_id IN (
          SELECT users_id FROM users WHERE users_auth_id = auth.uid()
        )

      ELSE false
    END
  )
)
WITH CHECK (
  -- ‚úÖ Emp√™cher la modification de organisation_id et user_id
  organisation_id = get_user_organisation_id(auth.uid())
);
```

### **üîü Policy DELETE : Suppression de projet**

```sql
CREATE POLICY "etapes_1to5_delete_own_or_admin"
ON public.etapes_1to5
FOR DELETE
TO authenticated
USING (
  -- üîë Admin PRESENCA peut tout supprimer
  is_admin_presenca(auth.uid())

  OR

  -- ‚úÖ Utilisateur peut supprimer ses propres projets uniquement
  (
    organisation_id = get_user_organisation_id(auth.uid())
    AND
    user_id IN (
      SELECT users_id FROM users WHERE users_auth_id = auth.uid()
    )
  )
);
```

---

## üìä EXEMPLE CONCRET DE FONCTIONNEMENT

### **Sc√©nario :**

**Organisation :** `org-abc-123`

**Entit√©s :**
- **R√©seau :** "Franchise Immo France" (`reseau_id: R1`)
  - Direction R√©seau : Sophie (`user_id: U_DIR`)
- **Agence Lyon :** "Immo Lyon Centre" (`reseau_agence_id: A1`)
  - Responsable : Marie (`user_id: U_MARIE`)
  - Collaborateur : Paul (`user_id: U_PAUL`)

**Projets cr√©√©s dans `etapes_1to5` :**

| project_id | user_id | utilisateur_type_compte | reseau_agence_id | Titre |
|------------|---------|-------------------------|------------------|-------|
| P1 | U_DIR | `reseau_direction` | NULL | "Projet Direction" |
| P2 | U_MARIE | `reseau_agence_responsable` | A1 | "Annonce Restaurant Lyon" |
| P3 | U_PAUL | `reseau_agence_collaborateur` | A1 | "Annonce Bureau Lyon" |

### **R√©sultats SELECT selon l'utilisateur connect√© :**

| Utilisateur connect√© | Voit les projets | Explication |
|---------------------|------------------|-------------|
| **Sophie (Direction R√©seau)** | P1 | Type `reseau_direction` ‚Üí voit uniquement projets `reseau` + `reseau_direction` |
| **Marie (Responsable Agence Lyon)** | P2, P3 | Type `reseau_agence_responsable` + `reseau_agence_id = A1` ‚Üí voit tous projets de son agence |
| **Paul (Collaborateur Agence Lyon)** | P3 | Type `reseau_agence_collaborateur` ‚Üí voit uniquement `user_id = U_PAUL` |

---

## ‚úÖ CONFORMIT√â AVEC L'ARCHITECTURE EXISTANTE

### **Hooks strat√©giques utilis√©s :**

| Hook | R√¥le dans la migration |
|------|------------------------|
| `useCurrentUser()` | Fournit `user.id`, `user.organisationId`, `user.utilisateurTypeCompte` |
| `useSupabaseOperations()` | Op√©rations CRUD s√©curis√©es avec injection automatique `organisation_id` + `user_id` |
| `useAuth()` | Gestion authentification Supabase |
| `useMultiTenant()` | Redirection post-login selon type compte |

### **Fonctions SQL existantes r√©utilis√©es :**

‚úÖ `get_user_organisation_id(user_uuid UUID)` ‚Üí D√©j√† existante  
‚úÖ `is_admin_presenca(user_uuid UUID)` ‚Üí D√©j√† existante  
‚úÖ `get_user_agence_indep_id(user_uuid UUID)` ‚Üí D√©j√† existante  

### **Nouvelles fonctions √† cr√©er :**

üÜï `get_user_type_compte(user_uuid UUID)`  
üÜï `get_user_reseau_agence_id(user_uuid UUID)`  
üÜï `user_belongs_to_reseau_agence(p_user_id UUID, p_reseau_agence_id UUID)`  
üÜï `user_belongs_to_agence_indep(p_user_id UUID, p_agence_indep_id UUID)`  

---

## üéØ R√âCAPITULATIF : CHECKLIST MIGRATION

- [ ] Ajouter colonnes `organisation_id`, `user_id`, `utilisateur_type_compte` √† `etapes_1to5`
- [ ] Ajouter colonnes optionnelles `reseau_id`, `reseau_agence_id`, `agence_indep_id`
- [ ] Cr√©er fonction `get_user_type_compte()`
- [ ] Cr√©er fonction `get_user_reseau_agence_id()`
- [ ] Cr√©er fonction `user_belongs_to_reseau_agence()`
- [ ] Cr√©er fonction `user_belongs_to_agence_indep()`
- [ ] Cr√©er RLS policy SELECT avec logique hi√©rarchique
- [ ] Cr√©er RLS policy INSERT avec validation organisation + user
- [ ] Cr√©er RLS policy UPDATE avec logique hi√©rarchique
- [ ] Cr√©er RLS policy DELETE (admin ou cr√©ateur uniquement)
- [ ] Activer RLS sur `etapes_1to5` : `ALTER TABLE etapes_1to5 ENABLE ROW LEVEL SECURITY;`

---

## üìù NOTES IMPORTANTES

1. **Conservation du nommage :**
   - Colonnes syst√®me Supabase ‚Üí `snake_case` (`organisation_id`, `user_id`, `created_at`)
   - Champs m√©tier business ‚Üí `camelCase` (`agencyName`, `propertyType`, `saleType`, etc.)

2. **S√©curit√© :**
   - Toutes les fonctions SQL helper utilisent `SECURITY DEFINER` pour √©viter la r√©cursion RLS
   - Les policies v√©rifient toujours `organisation_id` en premier (isolation tenant)
   - Les collaborateurs ne voient QUE leurs propres projets (pas ceux des autres collaborateurs)

3. **Performance :**
   - Cr√©er des index sur `organisation_id`, `user_id`, `reseau_agence_id`, `agence_indep_id`
   - Les fonctions SQL sont `STABLE` (peuvent √™tre mises en cache dans une requ√™te)

---

**üöÄ Cette strat√©gie est maintenant conforme √† :**
- ‚úÖ Structure multi-tenant de l'application
- ‚úÖ Tables Supabase existantes
- ‚úÖ Hooks strat√©giques (`useCurrentUser`, `useSupabaseOperations`)
- ‚úÖ Documents strat√©giques (`Relations Business entre Tables`, `Logique Organisations`, etc.)
- ‚úÖ Visibilit√© hi√©rarchique requise

---
---

## üîë **CHAMPS SYST√àME (snake_case)**

| Table       | Code champ          | Description                            | Obligatoire | Facultatif | Condition de remplissage | Droits de modification tables | Droits de modification presenca | Type SQL | Cl√© primaire (PK) | Cl√© √©trang√®re (FK) | R√©f√©rence vers table | Contraintes Supabase | Type d'identifiant | Actions √† pr√©voir |
|:------------|:--------------------|:---------------------------------------|:------------|:-----------|:-------------------------|:------------------------------|:--------------------------------|:---------|:------------------|:-------------------|:---------------------|:---------------------|:-------------------|:------------------|
| etapes_1to5 | id | Identifiant unique du projet annonce | Oui | | Auto-g√©n√©r√© | Lecture seule | Lecture seule | uuid | Oui | | | Default: gen_random_uuid() | UUID | auto |
| etapes_1to5 | organisation_id | Identifiant de l'organisation (tenant) | Oui | | Doit correspondre √† l'organisation de l'utilisateur | Lecture seule | Lecture seule | uuid | | Oui | organisations(organisation_id) | NOT NULL, FK, ON DELETE CASCADE | UUID | Auto (via get_user_organisation_id()) |
| etapes_1to5 | user_id | Identifiant de l'utilisateur cr√©ateur | Oui | | D√©fini automatiquement √† la cr√©ation | Lecture seule | Lecture seule | uuid | | Oui | users(users_id) | NOT NULL, FK, ON DELETE CASCADE | UUID | Auto (via auth.uid() ‚Üí users) |
| etapes_1to5 | utilisateur_type_compte | Type de compte utilisateur | Oui | | D√©fini automatiquement √† la cr√©ation | Lecture seule | Lecture seule | text | | | | NOT NULL, CHECK (utilisateur_type_compte IN ('reseau', 'reseau_direction', 'reseau_agence', 'reseau_agence_responsable', 'reseau_agence_collaborateur', 'agence_independante', 'agence_independante_responsable', 'agence_independante_collaborateur')) | text | Auto (via get_user_type_compte()) |
| etapes_1to5 | reseau_id | R√©f√©rence optionnelle vers r√©seau (analytique) | | Oui | Renseign√© si utilisateur appartient √† un r√©seau | Lecture seule | Lecture seule | uuid | | Oui | reseau(reseau_id) | NULL, FK, ON DELETE SET NULL | UUID | Auto (si type r√©seau) |
| etapes_1to5 | reseau_agence_id | R√©f√©rence optionnelle vers agence r√©seau (analytique) | | Oui | Renseign√© si utilisateur appartient √† une agence r√©seau | Lecture seule | Lecture seule | uuid | | Oui | reseau_agence(reseau_agence_id) | NULL, FK, ON DELETE SET NULL | UUID | Auto (si type agence r√©seau) |
| etapes_1to5 | agence_indep_id | R√©f√©rence optionnelle vers agence ind√©pendante (analytique) | | Oui | Renseign√© si utilisateur appartient √† une agence ind√©pendante | Lecture seule | Lecture seule | uuid | | Oui | agence_independante(agence_indep_id) | NULL, FK, ON DELETE SET NULL | UUID | Auto (si type agence ind√©p.) |


**Points cl√©s de la strat√©gie multi-tenant :**

‚úÖ **`organisation_id`** : Isolation stricte (m√™me organisation)  
‚úÖ **`user_id`** : Cr√©ateur du projet  
‚úÖ **`utilisateur_type_compte`** : Type de compte (reseau, reseau_agence, etc.)  
‚úÖ **`reseau_id`, `reseau_agence_id`, `agence_indep_id`** : R√©f√©rences optionnelles pour analytics et RLS hi√©rarchique  
‚úÖ **RLS hi√©rarchique** : G√©r√© via les fonctions SQL (`get_user_type_compte()`, `user_belongs_to_reseau_agence()`, etc.)  



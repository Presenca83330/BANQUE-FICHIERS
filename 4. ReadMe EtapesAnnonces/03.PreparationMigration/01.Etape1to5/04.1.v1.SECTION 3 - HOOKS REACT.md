# üìã SECTION 3 - HOOKS REACT (7 √©l√©ments)

## üìã SOMMAIRE SECTION 3

1. [Hook Technique (1 √©l√©ment √† adapter)](#1-hook-technique-1-√©l√©ment-√†-adapter)
2. [Hook Progression (1 √©l√©ment)](#2-hook-progression-1-√©l√©ment)
3. [Hooks M√©tier (5 √©l√©ments)](#3-hooks-m√©tier-5-√©l√©ments)

---

## 1. HOOK TECHNIQUE (1 √©l√©ment √† adapter)

### üìå **√âl√©ment 1 : `useSupabaseOperations` (EXISTANT - Adaptation)**

**Nom de fichier** : `useSupabaseOperations.ts` (‚úÖ **EXISTANT**)  
**Emplacement actuel** : `src/components/HOOKS-STRATEGIQUE/4.HOOK-useSupabaseOperations/useSupabaseOperations.ts`

**Description** :  
Hook technique **D√âJ√Ä EXISTANT** qui fournit une interface CRUD g√©n√©rique s√©curis√©e pour toutes les tables Supabase. **Aucune modification du code existant n'est requise**, car il supporte d√©j√† la table `etapes_1to5` via son syst√®me de mapping.

**Fonctions expos√©es** :  
```typescript
export const useSupabaseOperations = () => {
  select: (tableName, filters?, options?) => Promise
  insert: (tableName, data) => Promise
  update: (tableName, idField, idValue, data) => Promise
  remove: (tableName, idField, idValue) => Promise
}
```

---

### **üìä Tableau des contraintes - Aucune modification requise**

| Contrainte | Description | Statut |
|---|---|---|
| **Mapping table** | ‚úÖ **D√©j√† configur√©** dans `tableMapping.ts` | Aucune action |
| **Injection `organisation_id`** | ‚úÖ Automatique via `get_user_organisation_id(auth.uid())` | Aucune action |
| **Injection `user_id`** | ‚úÖ Automatique via `useCurrentUser().user.id` | Aucune action |
| **Convention nommage** | ‚úÖ Supporte d√©j√† `camelCase` ET `snake_case` | Aucune action |
| **Gestion erreurs** | ‚úÖ Centralis√©e dans `errors.ts` | Aucune action |
| **RLS activ√©e** | ‚úÖ Respect√©e automatiquement | Aucune action |

---

### **‚ö†Ô∏è Action requise : Ajout dans `tableMapping.ts`**

**Fichier √† modifier** : `src/components/HOOKS-STRATEGIQUE/4.HOOK-useSupabaseOperations/tableMapping.ts`

**Action** : Ajouter l'entr√©e `etapes_1to5` dans le mapping :

```typescript
export const tableMapping: Record = {
  // ... autres tables existantes ...
  etapes_1to5: 'etapes_1to5',  // ‚¨ÖÔ∏è AJOUTER CETTE LIGNE
};
```

**‚ö†Ô∏è C'EST LA SEULE MODIFICATION REQUISE SUR CE HOOK**

---

### **üìù Notes importantes**

| Point cl√© | Description |
|---|---|
| **Pas de refactoring** | Le hook fonctionne d√©j√† parfaitement pour `etapes_1to5` |
| **Supports `camelCase`** | Les requ√™tes SQL utilisent `as any` ‚Üí supporte les champs `"camelCase"` |
| **Multi-tenant natif** | Isolation `organisation_id` d√©j√† impl√©ment√©e |
| **Debouncing** | Non inclus dans ce hook (sera g√©r√© dans les Hooks M√©tier) |

---

### **üéØ Cas d'usage dans la migration**

| Hook appelant | Op√©ration | Exemple d'appel |
|---|---|---|
| `useEtape1()` | `select` | `select('etapes_1to5', { id: projectId })` |
| `useEtape1()` | `update` | `update('etapes_1to5', 'id', projectId, { "agencyName": value })` |
| `useStepProgress()` | `update` | `update('etapes_1to5', 'id', projectId, { step_progress: [1,2,3] })` |
| `useEtape5()` | `update` | `update('etapes_1to5', 'id', projectId, { validated_at: new Date() })` |

---

## 2. HOOK PROGRESSION (1 √©l√©ment)

### üìå **√âl√©ment 2 : `useStepProgress()`**

**Nom de fichier** : `useStepProgress.ts`  
**Emplacement pr√©vu** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/HookStepProgress.ts`

**Description** :  
Hook central de gestion de la **progression des √©tapes** (d√©verrouillage, navigation, r√©initialisation). Remplace l'ancien hook localStorage `useStepProgress.ts` par une version Supabase.

**Fonctions expos√©es** :  
```typescript
export const useStepProgress = (projectId?: string) => {
  stepProgress: number[]
  isStepAvailable: (step: number) => boolean
  completeStep: (step: number) => Promise
  goToNextStep: (currentStep: number) => void
  handleNewProject: () => Promise
  handleBackToEtape5: () => void
  hasCompletedStep4: boolean
  loading: boolean
  error: string | null
}
```

---

### **üìä Tableau des contraintes**

| Contrainte | Description |
|---|---|
| **Convention nommage** | Fonction hook : `camelCase` / Champ SQL : `step_progress` (`snake_case`) |
| **Param√®tres** | `projectId?: string` (ID du projet en cours) |
| **Retour** | Objet avec √©tats + fonctions |
| **D√©pendances** | `useSupabaseOperations`, `useNavigate` (React Router) |
| **√âtat local** | `stepProgress: number[]` (tableau cumulatif `[1, 2, 3, 4, 5]`) |
| **Chargement initial** | SELECT `step_progress` depuis `etapes_1to5` WHERE `id = projectId` |
| **Mise √† jour** | UPDATE `step_progress` avec `array_append()` PostgreSQL |
| **Non r√©gressif** | ‚úÖ Les √©tapes d√©j√† d√©verrouill√©es restent accessibles |

---

### **üìã Fonctionnalit√©s d√©taill√©es**

#### **Fonction 1 : `completeStep(step)`**

| Propri√©t√© | Valeur |
|---|---|
| **Description** | D√©verrouille l'√©tape suivante en ajoutant `step + 1` au tableau `step_progress` |
| **Param√®tre** | `step: number` (1, 2, 3, 4 ou 5) |
| **SQL g√©n√©r√©** | `UPDATE etapes_1to5 SET step_progress = array_append(step_progress, ${step+1}) WHERE id = ${projectId}` |
| **Gestion doublons** | PostgreSQL `array_append()` ajoute automatiquement (pas de v√©rification) |
| **Toast success** | ‚úÖ "√âtape {step} valid√©e" |
| **Toast error** | ‚ùå "Erreur lors de la validation" |

---

#### **Fonction 2 : `isStepAvailable(step)`**

| Propri√©t√© | Valeur |
|---|---|
| **Description** | V√©rifie si une √©tape est accessible |
| **Param√®tre** | `step: number` |
| **Retour** | `boolean` |
| **Logique** | `stepProgress.includes(step)` OU `step === 1` (√©tape 1 toujours accessible) |

---

#### **Fonction 3 : `goToNextStep(currentStep)`**

| Propri√©t√© | Valeur |
|---|---|
| **Description** | Navigation vers l'√©tape suivante |
| **Param√®tre** | `currentStep: number` |
| **Navigation** | `navigate(\`/etape${currentStep + 1}\`)` |
| **Gestion √©tape 5** | Si `currentStep === 5` ‚Üí `navigate('/etape5/animation')` |

---

#### **Fonction 4 : `handleNewProject()`**

| Propri√©t√© | Valeur |
|---|---|
| **Description** | Cr√©e un nouveau projet vierge |
| **Action** | INSERT dans `etapes_1to5` avec `step_progress = {1}` |
| **Injection auto** | `organisation_id`, `user_id`, `utilisateur_type_compte` via triggers |
| **Toast success** | ‚úÖ "Nouveau projet cr√©√©" |
| **Navigation** | `navigate('/etape1')` |

---

#### **Fonction 5 : `handleBackToEtape5()`**

| Propri√©t√© | Valeur |
|---|---|
| **Description** | Retour sp√©cifique vers √©tape 5 (depuis √©tapes 1-4 si modifications) |
| **Action** | Sauvegarde modifications en cours + Navigation `/etape5` |

---

### **üìù Notes strat√©giques**

| Point cl√© | Description |
|---|---|
| **√âtat computed : `hasCompletedStep4`** | `stepProgress.includes(5)` ‚Üí bool√©en indiquant si √©tape 4 valid√©e |
| **√âtape 1 toujours accessible** | Aucune v√©rification requise (r√®gle m√©tier) |
| **Ordre non strict** | Utilisateur peut revenir librement sur √©tapes d√©verrouill√©es |
| **Validation finale** | √âtape 5 n√©cessite `stepProgress.includes(5)` |

---

## 3. HOOKS M√âTIER (5 √©l√©ments)

### üìå **√âl√©ment 3 : `useEtape1()`**

**Nom de fichier** : `HookEtape-1.ts`  
**Emplacement pr√©vu** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/HookEtape-1.ts`

**Description** :  
Gestion compl√®te de l'**√âtape 1 - √âl√©ments Cl√©s** (10 champs m√©tier).

**Fonctions expos√©es** :  
```typescript
export const useEtape1 = (projectId: string) => {
  // √âtats
  formData: Etape1FormData
  loading: boolean
  error: string | null

  // Fonctions
  updateField: (field: keyof Etape1FormData, value: any) => void
  validateAndSave: () => Promise
  loadData: () => Promise
}
```

---

### **üìä Tableau des contraintes - √âtape 1**

| Contrainte | Description |
|---|---|
| **Convention nommage** | Tous les champs en `camelCase` |
| **Param√®tres** | `projectId: string` (ID projet Supabase) |
| **Champs g√©r√©s** | `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements` |
| **Validation** | Appel `validateAllEtape(1, formData)` |
| **Debouncing** | ‚úÖ 500ms sur `updateField()` pour √©viter requ√™tes excessives |
| **Formatage auto** | `price` et `rentAmount` ‚Üí `formatEuros()` / `parseEuroAmount()` |
| **D√©pendances** | `useSupabaseOperations`, `useStepProgress`, Utilitaires Formatage, Utilitaires Validation |

---

### **üìã Logique d√©taill√©e - useEtape1()**

#### **1. Chargement initial (`loadData`)**

| √âtape | Action |
|---|---|
| 1 | `select('etapes_1to5', { id: projectId })` |
| 2 | Appel `mapSupabaseToForm(data)` |
| 3 | Hydratation √©tat local `formData` |
| 4 | Gestion erreur si projet introuvable |

---

#### **2. Mise √† jour champ (`updateField`)**

| √âtape | Action |
|---|---|
| 1 | Mise √† jour √©tat local imm√©diat (React state) |
| 2 | **Debounce 500ms** |
| 3 | Appel `update('etapes_1to5', 'id', projectId, { [field]: value })` |
| 4 | Toast erreur si √©chec |

---

#### **3. Validation et sauvegarde (`validateAndSave`)**

| √âtape | Action |
|---|---|
| 1 | Appel `validateSaleTypeConsistency(saleType, price, rentAmount)` |
| 2 | Appel `validateRequiredField()` sur tous champs obligatoires |
| 3 | Si √©chec ‚Üí Toast erreur + `return false` |
| 4 | Si succ√®s ‚Üí `update('etapes_1to5', 'id', projectId, formData)` |
| 5 | Appel `completeStep(1)` (d√©verrouille √©tape 2) |
| 6 | Toast succ√®s + `return true` |

---

### **üìå √âl√©ment 4 : `useEtape2()`**

**Nom de fichier** : `HookEtape-2.ts`  
**Emplacement pr√©vu** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/HookEtape-2.ts`

**Description** :  
Gestion compl√®te de l'**√âtape 2 - Informations de Description** (1 champ m√©tier).

**Fonctions expos√©es** :  
```typescript
export const useEtape2 = (projectId: string) => {
  formData: { propertyDescription: string }
  loading: boolean
  error: string | null

  updateField: (value: string) => void
  validateAndSave: () => Promise
  loadData: () => Promise
}
```

---

### **üìä Tableau des contraintes - √âtape 2**

| Contrainte | Description |
|---|---|
| **Champ g√©r√©** | `propertyDescription` (TEXT, obligatoire, longueur minimale) |
| **Formatage** | Appel `applyBulletFormatting()` automatique |
| **Validation** | `validateMinLength(propertyDescription, 50, "Description")` |
| **Debouncing** | ‚úÖ 500ms |

---

### **üìå √âl√©ment 5 : `useEtape3()`**

**Nom de fichier** : `HookEtape-3.ts`  
**Emplacement pr√©vu** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/HookEtape-3.ts`

**Description** :  
Gestion compl√®te de l'**√âtape 3 - Informations Financi√®res** (1 champ m√©tier).

**Fonctions expos√©es** :  
```typescript
export const useEtape3 = (projectId: string) => {
  formData: { financials: string }
  loading: boolean
  error: string | null

  updateField: (value: string) => void
  validateAndSave: () => Promise
  loadData: () => Promise
}
```

---

### **üìä Tableau des contraintes - √âtape 3**

| Contrainte | Description |
|---|---|
| **Champ g√©r√©** | `financials` (TEXT, obligatoire, longueur minimale) |
| **Formatage** | Appel `applyBulletFormatting()` automatique |
| **Validation** | `validateMinLength(financials, 50, "Informations financi√®res")` |
| **Debouncing** | ‚úÖ 500ms |

---

### **üìå √âl√©ment 6 : `useEtape4()`**

**Nom de fichier** : `HookEtape-4.ts`  
**Emplacement pr√©vu** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/HookEtape-4.ts`

**Description** :  
Gestion compl√®te de l'**√âtape 4 - Autres D√©tails** (2 champs m√©tier).

**Fonctions expos√©es** :  
```typescript
export const useEtape4 = (projectId: string) => {
  formData: { details: string; hasNoDetails: boolean }
  loading: boolean
  error: string | null

  updateDetails: (value: string) => void
  updateHasNoDetails: (value: boolean) => void
  validateAndSave: () => Promise
  loadData: () => Promise
}
```

---

### **üìä Tableau des contraintes - √âtape 4**

| Contrainte | Description |
|---|---|
| **Champs g√©r√©s** | `details` (TEXT, conditionnel), `hasNoDetails` (BOOLEAN, obligatoire) |
| **Validation** | `validateDetailsConsistency(hasNoDetails, details)` |
| **Formatage** | Si `hasNoDetails === false` ‚Üí `applyBulletFormatting(details)` |
| **Logique exclusive** | `hasNoDetails === true` ‚Üí `details` vide/null |
| **Debouncing** | ‚úÖ 500ms |

---

### **üìå √âl√©ment 7 : `useEtape5()`**

**Nom de fichier** : `HookEtape-5.ts`  
**Emplacement pr√©vu** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/HookEtape-5.ts`

**Description** :  
Gestion compl√®te de l'**√âtape 5 - Validation et G√©n√©ration** (lecture seule + orchestration OpenAI).

**Fonctions expos√©es** :  
```typescript
export const useEtape5 = (projectId: string) => {
  fullProjectData: PropertyDataSupabase | null
  loading: boolean
  error: string | null
  generationStatus: 'idle' | 'generating' | 'completed' | 'error'

  validateProject: () => Promise
  startGeneration: () => Promise
  loadData: () => Promise
}
```

---

### **üìä Tableau des contraintes - √âtape 5**

| Contrainte | Description |
|---|---|
| **Champs g√©r√©s** | **AUCUN** (lecture seule) |
| **Validation finale** | V√©rification de TOUS les champs (√©tapes 1-4) |
| **Action validation** | UPDATE `validated_at = NOW()` ‚Üí Trigger passe `statut = 'archive'` |
| **Orchestration OpenAI** | Appel s√©quentiel des 7 services OpenAI |
| **Navigation** | `/etape5/animation` apr√®s d√©marrage g√©n√©ration |
| **D√©pendances** | `useSupabaseOperations`, `useStepProgress`, Services OpenAI (Section 4) |

---

### **üìã Logique d√©taill√©e - useEtape5()**

#### **1. Validation projet (`validateProject`)**

| √âtape | Action |
|---|---|
| 1 | V√©rification `step_progress.includes(5)` |
| 2 | Appel `validateAllEtape(5, fullProjectData)` |
| 3 | Si √©chec ‚Üí Toast erreur liste champs manquants |
| 4 | Si succ√®s ‚Üí `update('etapes_1to5', 'id', projectId, { validated_at: new Date() })` |
| 5 | Toast succ√®s "Projet valid√©" |

---

#### **2. D√©marrage g√©n√©ration (`startGeneration`)**

| √âtape | Action |
|---|---|
| 1 | Appel `mapSupabaseToPrompt(fullProjectData)` |
| 2 | Boucle s√©quentielle sur les 7 services OpenAI |
| 3 | Stockage r√©sultats dans `localStorage` (Phase 1) |
| 4 | `navigate('/etape5/animation')` |

---

## ‚úÖ CHECKLIST SECTION 3

- [ ] **Hook Technique** : Ajouter `etapes_1to5` dans `tableMapping.ts` (1 ligne)
- [ ] **Hook Progression** : Cr√©er `HookStepProgress.ts` avec 5 fonctions
- [ ] **Hook √âtape 1** : Cr√©er `HookEtape-1.ts` avec validation compl√®te
- [ ] **Hook √âtape 2** : Cr√©er `HookEtape-2.ts` avec formatage
- [ ] **Hook √âtape 3** : Cr√©er `HookEtape-3.ts` avec formatage
- [ ] **Hook √âtape 4** : Cr√©er `HookEtape-4.ts` avec coh√©rence `hasNoDetails`
- [ ] **Hook √âtape 5** : Cr√©er `HookEtape-5.ts` avec orchestration OpenAI
- [ ] **Tests unitaires** : Valider chaque hook isol√©ment
- [ ] **Tests int√©gration** : Workflow complet √âtape 1 ‚Üí √âtape 5 ‚Üí G√©n√©ration

---



# CODES SECTION 3 -

---

# N1 : Hook – useStepProgress.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress.ts

```typescript
import { useState, useEffect, useCallback, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { supabase } from "@/integrations/supabase/client";

export interface UseStepProgressReturn {
  availableSteps: number[];
  hasCompletedStep4: boolean;
  completeStep: (step: number) => Promise<void>;
  disabledSteps: number[];  // ← CORRIGÉ : Propriété au lieu de fonction
  goToEtape5: () => void;
  isStepAvailable: (step: number) => boolean;
  resetProject: () => Promise<void>;  // ← AJOUTÉ : Pour bouton "Nouveau projet"
}

export function useStepProgress(currentStep: number = 1): UseStepProgressReturn {
  const navigate = useNavigate();
  const [availableSteps, setAvailableSteps] = useState<number[]>([1]);
  const [hasCompletedStep4, setHasCompletedStep4] = useState(false);
  const [projectId, setProjectId] = useState<string | null>(null);

  // Chargement initial depuis Supabase
  useEffect(() => {
    const loadProgress = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("etapes_1to5")
          .select("project_id, step_progress")
          .eq("user_id", user.id)
          .eq("statut", "en_cours")
          .maybeSingle();

        if (error) {
          console.error("Error loading step progress:", error);
          return;
        }

        if (data) {
          setProjectId(data.project_id);
          const progress = data.step_progress || [1];
          setAvailableSteps(progress);
          if (progress.includes(5)) {
            setHasCompletedStep4(true);
          }
        }
      } catch (err) {
        console.error("Failed to load progress:", err);
      }
    };

    loadProgress();
  }, []);

  // Compléter une étape
  const completeStep = useCallback(async (step: number) => {
    try {
      const nextStep = step + 1;
      const newAvailableSteps = [...new Set([...availableSteps, nextStep])].sort((a, b) => a - b);

      if (!projectId) {
        console.error("No project ID found");
        return;
      }

      const { error } = await supabase
        .from("etapes_1to5")
        .update({ step_progress: newAvailableSteps })
        .eq("project_id", projectId);

      if (error) {
        console.error("Error updating step progress:", error);
        return;
      }

      setAvailableSteps(newAvailableSteps);
      
      if (step === 4) {
        setHasCompletedStep4(true);
      }
    } catch (err) {
      console.error("Failed to complete step:", err);
    }
  }, [availableSteps, projectId]);

  // ✅ CORRIGÉ : Calculer disabledSteps comme propriété (useMemo)
  const disabledSteps = useMemo(() => {
    const allSteps = [1, 2, 3, 4, 5];
    return allSteps.filter(step => !availableSteps.includes(step));
  }, [availableSteps]);

  // Navigation vers Étape 5
  const goToEtape5 = useCallback(() => {
    navigate("/etape5");
  }, [navigate]);

  // Vérifier si une étape est disponible
  const isStepAvailable = useCallback((step: number) => {
    if (step === 1) return true;
    if (step < currentStep) return availableSteps.includes(step);
    return step === currentStep || availableSteps.includes(step);
  }, [availableSteps, currentStep]);

  // ✅ AJOUTÉ : Fonction pour réinitialiser le projet (bouton "Nouveau projet")
  const resetProject = useCallback(async () => {
    if (!projectId) {
      console.error("No project ID to reset");
      return;
    }

    try {
      // 1. Supprimer le projet de Supabase
      const { error } = await supabase
        .from("etapes_1to5")
        .delete()
        .eq("project_id", projectId);

      if (error) {
        console.error("Error deleting project:", error);
        return;
      }

      // 2. Réinitialiser l'état local
      setAvailableSteps([1]);
      setHasCompletedStep4(false);
      setProjectId(null);

      // 3. Naviguer vers Étape 1
      navigate("/etape1");

      console.log("Project reset successfully");
    } catch (err) {
      console.error("Failed to reset project:", err);
    }
  }, [projectId, navigate]);

  return {
    availableSteps,
    hasCompletedStep4,
    completeStep,
    disabledSteps,        // ← CORRIGÉ : Propriété (number[])
    goToEtape5,
    isStepAvailable,
    resetProject          // ← AJOUTÉ : Fonction pour nouveau projet
  };
}

```

---

# N2 : Hook – HookEtape-1.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/01.Etape1/HookEtape-1.ts

```typescript

import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { useToast } from "@/hooks/use-toast";

export interface Etape1Data {
  agencyName: string;
  reference: string;
  exclusivite: string;
  location: string;
  propertyType: string;
  saleType: string;
  price: string | null;
  rentAmount: string | null;
  rentPeriodicity: string | null;
  keyElements: string;
}

export function useEtape1(projectId?: string) {
  const { toast } = useToast();
  const [formData, setFormData] = useState<Etape1Data>({
    agencyName: '',
    reference: '',
    exclusivite: 'Non',
    location: '',
    propertyType: '',
    saleType: 'à vendre',
    price: '',
    rentAmount: '',
    rentPeriodicity: 'Mensuel',
    keyElements: '',
  });
  const [loading, setLoading] = useState(false);

  // Charger les données depuis Supabase
  useEffect(() => {
    if (!projectId) return;

    const loadData = async () => {
      try {
        const { data, error } = await supabase
          .from('etapes_1to5')
          .select('agencyName, reference, exclusivite, location, propertyType, saleType, price, rentAmount, rentPeriodicity, keyElements')
          .eq('project_id', projectId)
          .single();

        if (error) {
          console.error('Error loading Etape1 data:', error);
          return;
        }

        if (data) {
          setFormData({
            agencyName: data.agencyName || '',
            reference: data.reference || '',
            exclusivite: data.exclusivite || 'Non',
            location: data.location || '',
            propertyType: data.propertyType || '',
            saleType: data.saleType || 'à vendre',
            price: data.price || '',
            rentAmount: data.rentAmount || '',
            rentPeriodicity: data.rentPeriodicity || 'Mensuel',
            keyElements: data.keyElements || '',
          });
        }
      } catch (err) {
        console.error('Failed to load Etape1 data:', err);
      }
    };

    loadData();
  }, [projectId]);

  // ✅ CORRECTION : Conversion "" → null avant sauvegarde
  const saveEtape1 = async (): Promise<boolean> => {
    if (!projectId) {
      toast({
        title: 'Erreur',
        description: 'Aucun projet sélectionné',
        variant: 'destructive',
      });
      return false;
    }

    setLoading(true);

    try {
      // ✅ AJOUT : Conversion des chaînes vides en null
      const cleanData = {
        agencyName: formData.agencyName?.trim() || '',
        reference: formData.reference?.trim() || '',
        exclusivite: formData.exclusivite || 'Non',
        location: formData.location?.trim() || '',
        propertyType: formData.propertyType?.trim() || '',
        saleType: formData.saleType || 'à vendre',
        price: formData.price?.trim() || null,          // ✅ "" → null
        rentAmount: formData.rentAmount?.trim() || null, // ✅ "" → null
        rentPeriodicity: formData.rentPeriodicity?.trim() || null,
        keyElements: formData.keyElements?.trim() || '',
      };

      const { error } = await supabase
        .from('etapes_1to5')
        .update(cleanData)
        .eq('project_id', projectId);

      if (error) {
        console.error('Error saving Etape1:', error);
        toast({
          title: 'Erreur',
          description: 'Impossible de sauvegarder les données',
          variant: 'destructive',
        });
        return false;
      }

      return true;
    } catch (err) {
      console.error('Failed to save Etape1:', err);
      toast({
        title: 'Erreur',
        description: 'Une erreur est survenue',
        variant: 'destructive',
      });
      return false;
    } finally {
      setLoading(false);
    }
  };

  return {
    formData,
    setFormData,
    saveEtape1,
    loading,
  };
}
```

---

---

# N3 : Hook – HookEtape-2.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/02.Etape2/HookEtape-2.ts

```typescript
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { useToast } from "@/hooks/use-toast";

export interface Etape2Data {
  propertyDescription: string;
}

export function useEtape2(projectId?: string) {
  const { toast } = useToast();
  const [formData, setFormData] = useState<Etape2Data>({
    propertyDescription: '',
  });
  const [loading, setLoading] = useState(false);

  // Charger les données depuis Supabase
  useEffect(() => {
    if (!projectId) return;

    const loadData = async () => {
      try {
        const { data, error } = await supabase
          .from('etapes_1to5')
          .select('propertyDescription')
          .eq('project_id', projectId)
          .single();

        if (error) {
          console.error('Error loading Etape2 data:', error);
          return;
        }

        if (data) {
          setFormData({
            propertyDescription: data.propertyDescription || '',
          });
        }
      } catch (err) {
        console.error('Failed to load Etape2 data:', err);
      }
    };

    loadData();
  }, [projectId]);

  // ✅ HARMONISATION : Ajout cleanData (conversion vers '' car NOT NULL)
  const saveEtape2 = async (): Promise<boolean> => {
    if (!projectId) {
      toast({
        title: 'Erreur',
        description: 'Aucun projet sélectionné',
        variant: 'destructive',
      });
      return false;
    }

    setLoading(true);

    try {
      // ✅ AJOUT : cleanData avec trim (conversion vers '', pas null car NOT NULL)
      const cleanData = {
        propertyDescription: formData.propertyDescription?.trim() || '',
      };

      const { error } = await supabase
        .from('etapes_1to5')
        .update(cleanData)
        .eq('project_id', projectId);

      if (error) {
        console.error('Error saving Etape2:', error);
        toast({
          title: 'Erreur',
          description: 'Impossible de sauvegarder les données',
          variant: 'destructive',
        });
        return false;
      }

      return true;
    } catch (err) {
      console.error('Failed to save Etape2:', err);
      toast({
        title: 'Erreur',
        description: 'Une erreur est survenue',
        variant: 'destructive',
      });
      return false;
    } finally {
      setLoading(false);
    }
  };

  return {
    formData,
    setFormData,
    saveEtape2,
    loading,
  };
}
```

---

---

# N4 : Hook – HookEtape-3.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/03.Etape3/HookEtape-3.ts

```typescript
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { useToast } from "@/hooks/use-toast";

export interface Etape3Data {
  financials: string;
}

export function useEtape3(projectId?: string) {
  const { toast } = useToast();
  const [formData, setFormData] = useState<Etape3Data>({
    financials: '',
  });
  const [loading, setLoading] = useState(false);

  // Charger les données depuis Supabase
  useEffect(() => {
    if (!projectId) return;

    const loadData = async () => {
      try {
        const { data, error } = await supabase
          .from('etapes_1to5')
          .select('financials')
          .eq('project_id', projectId)
          .single();

        if (error) {
          console.error('Error loading Etape3 data:', error);
          return;
        }

        if (data) {
          setFormData({
            financials: data.financials || '',
          });
        }
      } catch (err) {
        console.error('Failed to load Etape3 data:', err);
      }
    };

    loadData();
  }, [projectId]);

  // ✅ HARMONISATION : Ajout cleanData (conversion vers '' car NOT NULL)
  const saveEtape3 = async (): Promise<boolean> => {
    if (!projectId) {
      toast({
        title: 'Erreur',
        description: 'Aucun projet sélectionné',
        variant: 'destructive',
      });
      return false;
    }

    setLoading(true);

    try {
      // ✅ AJOUT : cleanData avec trim (conversion vers '', pas null car NOT NULL)
      const cleanData = {
        financials: formData.financials?.trim() || '',
      };

      const { error } = await supabase
        .from('etapes_1to5')
        .update(cleanData)
        .eq('project_id', projectId);

      if (error) {
        console.error('Error saving Etape3:', error);
        toast({
          title: 'Erreur',
          description: 'Impossible de sauvegarder les données',
          variant: 'destructive',
        });
        return false;
      }

      return true;
    } catch (err) {
      console.error('Failed to save Etape3:', err);
      toast({
        title: 'Erreur',
        description: 'Une erreur est survenue',
        variant: 'destructive',
      });
      return false;
    } finally {
      setLoading(false);
    }
  };

  return {
    formData,
    setFormData,
    saveEtape3,
    loading,
  };
}
```

---


---

# N5 : Hook – HookEtape-4.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/04.Etape4/HookEtape-4.ts

```typescript
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { useToast } from "@/hooks/use-toast";

export interface Etape4Data {
  details: string | null;
  hasNoDetails: boolean;
}

export function useEtape4(projectId?: string) {
  const { toast } = useToast();
  const [formData, setFormData] = useState<Etape4Data>({
    details: '',
    hasNoDetails: false,
  });
  const [loading, setLoading] = useState(false);

  // Charger les données depuis Supabase
  useEffect(() => {
    if (!projectId) return;

    const loadData = async () => {
      try {
        const { data, error } = await supabase
          .from('etapes_1to5')
          .select('details, hasNoDetails')
          .eq('project_id', projectId)
          .single();

        if (error) {
          console.error('Error loading Etape4 data:', error);
          return;
        }

        if (data) {
          setFormData({
            details: data.details || '',
            hasNoDetails: data.hasNoDetails || false,
          });
        }
      } catch (err) {
        console.error('Failed to load Etape4 data:', err);
      }
    };

    loadData();
  }, [projectId]);

  // ✅ CORRECTION : Conversion "" → null avant sauvegarde
  const saveEtape4 = async (): Promise<boolean> => {
    if (!projectId) {
      toast({
        title: 'Erreur',
        description: 'Aucun projet sélectionné',
        variant: 'destructive',
      });
      return false;
    }

    setLoading(true);

    try {
      // ✅ AJOUT : Conversion des chaînes vides en null pour details
      const cleanData = {
        details: formData.details?.trim() || null,  // ✅ "" → null
        hasNoDetails: formData.hasNoDetails || false,
      };

      const { error } = await supabase
        .from('etapes_1to5')
        .update(cleanData)
        .eq('project_id', projectId);

      if (error) {
        console.error('Error saving Etape4:', error);
        toast({
          title: 'Erreur',
          description: 'Impossible de sauvegarder les données',
          variant: 'destructive',
        });
        return false;
      }

      return true;
    } catch (err) {
      console.error('Failed to save Etape4:', err);
      toast({
        title: 'Erreur',
        description: 'Une erreur est survenue',
        variant: 'destructive',
      });
      return false;
    } finally {
      setLoading(false);
    }
  };

  return {
    formData,
    setFormData,
    saveEtape4,
    loading,
  };
}
```

---



---

# N6 : Hook – HookEtape-5.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/05.Etape5/HookEtape-5.ts

```typescript
import { useState, useEffect } from "react";
import { Etape5Data } from "./types";
import { supabase } from "@/integrations/supabase/client";
import { mapSupabaseToPrompt } from "../../03.Utilitaires/mapSupabaseToPrompt";

export function useEtape5() {
  const [projectData, setProjectData] = useState<Etape5Data | null>(null);
  const [loading, setLoading] = useState(false);
  const [projectId, setProjectId] = useState<string | null>(null);

  // Chargement des données au montage
  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("etapes_1to5")
          .select("*")
          .eq("user_id", user.id)
          .eq("statut", "en_cours")
          .maybeSingle();

        if (error) {
          console.error("Error loading data:", error);
          return;
        }

        if (data) {
          setProjectId(data.project_id);
          const mappedData = mapSupabaseToPrompt(data);
          setProjectData(mappedData);
        }
      } catch (err) {
        console.error("Failed to load data:", err);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);

  return { projectData, loading, projectId };
}
```

---


---


# N15 : NavigationEtapes.tsx
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.Components/NavigationEtapes.tsx

```tsx

```

---

# N16 : ProgressIndicator.tsx
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.Components/ProgressIndicator.tsx

```tsx

```

---



---

# üì¶ CODES COMPLETS

Phase 1 : Migration localStorage ‚Üí Supabase pour √âtapes 1-5

---

## FICHIER  : AnnonceContext.tsx

### Chemin
`src/contexts/AnnonceContext.tsx`
---


```typescript
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/components/ui/use-toast';

// Interface des donn√©es projet (14 champs m√©tier)
interface ProjectData {
  project_id: string;
  agencyName: string;
  reference: string;
  exclusivite: string;
  location: string;
  propertyType: string;
  saleType: string;
  price: string | null;
  rentAmount: string | null;
  rentPeriodicity: string | null;
  keyElements: string;
  propertyDescription: string;
  financials: string;
  details: string | null;
  hasNoDetails: boolean;
  step_progress: number[];
}

// Interface du contexte
interface AnnonceContextType {
  currentProjectId: string | null;
  projectData: ProjectData | null;
  isLoading: boolean;
  error: string | null;
  loadProject: (projectId: string) => Promise<void>;
  refreshProject: () => Promise<void>;
  createNewProject: () => Promise<string | null>;
}

// Cr√©ation du contexte
const AnnonceContext = createContext<AnnonceContextType | undefined>(undefined);

// Provider
export function AnnonceProvider({ children }: { children: ReactNode }) {
  const [currentProjectId, setCurrentProjectId] = useState<string | null>(null);
  const [projectData, setProjectData] = useState<ProjectData | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { toast } = useToast();

  // Charger un projet depuis Supabase
  const loadProject = async (projectId: string) => {
    setIsLoading(true);
    setError(null);
    
    try {
      const { data, error: fetchError } = await supabase
        .from('etapes_1to5')
        .select('*')
        .eq('project_id', projectId)
        .single();

      if (fetchError) {
        console.error('Error loading project:', fetchError);
        setError('Impossible de charger le projet');
        toast({
          title: 'Erreur',
          description: 'Impossible de charger le projet',
          variant: 'destructive',
        });
        return;
      }

      if (data) {
        setCurrentProjectId(projectId);
        setProjectData({
          project_id: data.project_id,
          agencyName: data.agencyName || '',
          reference: data.reference || '',
          exclusivite: data.exclusivite || 'Non',
          location: data.location || '',
          propertyType: data.propertyType || '',
          saleType: data.saleType || '√† vendre',
          price: data.price,
          rentAmount: data.rentAmount,
          rentPeriodicity: data.rentPeriodicity,
          keyElements: data.keyElements || '',
          propertyDescription: data.propertyDescription || '',
          financials: data.financials || '',
          details: data.details,
          hasNoDetails: data.hasNoDetails || false,
          step_progress: data.step_progress || [1],
        });
      }
    } catch (err) {
      console.error('Failed to load project:', err);
      setError('Erreur lors du chargement du projet');
    } finally {
      setIsLoading(false);
    }
  };

  // Recharger le projet courant
  const refreshProject = async () => {
    if (currentProjectId) {
      await loadProject(currentProjectId);
    }
  };

  // Cr√©er un nouveau projet
  const createNewProject = async (): Promise<string | null> => {
    setIsLoading(true);
    setError(null);

    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        toast({
          title: 'Erreur',
          description: 'Utilisateur non connect√©',
          variant: 'destructive',
        });
        return null;
      }

      // R√©cup√©rer l'organisation_id de l'utilisateur via RLS
      const { data, error: insertError } = await supabase
        .from('etapes_1to5')
        .insert({
          step_progress: [1],
          statut: 'en_cours',
        })
        .select('project_id')
        .single();

      if (insertError) {
        console.error('Error creating project:', insertError);
        toast({
          title: 'Erreur',
          description: 'Impossible de cr√©er un nouveau projet',
          variant: 'destructive',
        });
        return null;
      }

      if (data) {
        const newProjectId = data.project_id;
        await loadProject(newProjectId);
        return newProjectId;
      }

      return null;
    } catch (err) {
      console.error('Failed to create project:', err);
      setError('Erreur lors de la cr√©ation du projet');
      return null;
    } finally {
      setIsLoading(false);
    }
  };

  // ‚úÖ CORRECTION : Charger le projet "en_cours" au montage (SILENCIEUSEMENT si pas d'user)
  useEffect(() => {
    const loadCurrentProject = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return; // ‚úÖ Sortie silencieuse si pas connect√©

        const { data, error: fetchError } = await supabase
          .from('etapes_1to5')
          .select('project_id')
          .eq('user_id', user.id)
          .eq('statut', 'en_cours')
          .maybeSingle();

        if (fetchError) {
          console.error('Error finding current project:', fetchError);
          return;
        }

        if (data) {
          await loadProject(data.project_id);
        }
      } catch (err) {
        console.error('Failed to load current project:', err);
      }
    };

    loadCurrentProject();
  }, []);

  const value: AnnonceContextType = {
    currentProjectId,
    projectData,
    isLoading,
    error,
    loadProject,
    refreshProject,
    createNewProject,
  };

  return (
    <AnnonceContext.Provider value={value}>
      {children}
    </AnnonceContext.Provider>
  );
}

// Hook pour utiliser le contexte
export function useAnnonceContext() {
  const context = useContext(AnnonceContext);
  if (context === undefined) {
    throw new Error('useAnnonceContext must be used within an AnnonceProvider');
  }
  return context;
}
```


---

---

## FICHIER : Etape1.tsx 

### Chemin
`src/1.etapes-generation-annonces/etape1/Etape1.tsx`

### Code complet

```typescript
import React, { useState, useRef, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import HeaderV2GenAnn from "@/components/atemplate.v2.generation-annonces/Header.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import { useToast } from "@/hooks/use-toast";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useSgaForm } from "@/components/1-Sources-Generation-Annonces/utils/useSgaForm";
import EnsembleFormulairesEtape1Form, { EnsembleFormulairesEtape1FormRef } from "@/components/1-Sources-Generation-Annonces/form-etape1/EnsembleFormulairesEtape1Form";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";

const Etape1: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  
  // ‚úÖ MIGRATION : Utilise useStepProgress corrig√© (disabledSteps au lieu de getDisabledSteps)
  const { disabledSteps, completeStep } = useStepProgress(1);
  
  const formulaireRef = useRef<EnsembleFormulairesEtape1FormRef>(null);
  
  const headerTitle = "Bienvenue sur votre G√©n√©rateur d'Annonces et d'Outils SEO";
  const headerSubtitle = "Notre g√©n√©rateur a √©t√© con√ßu pour vous permettre de structurer et optimiser vos annonces en toute simplicit√©.";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les informations disponibles, sans se soucier de la mise en forme. <br />L'IA se charge d'organiser, de hi√©rarchiser et de r√©diger l'annonce de mani√®re fluide et professionnelle.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "√âl√©ments Cl√©s";
  const card1CentreTexte = "";

  // ‚úÖ CORRECTION : Force le rechargement du composant quand il devient visible
  useEffect(() => {
    const handleVisibilityChange = async () => {  // ‚Üê async
      if (document.visibilityState === 'visible') {
        // Force le composant √† se mettre √† jour
        await formulaireRef.current?.handleValidation();  // ‚Üê await
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, []);

  // ‚úÖ CORRECTION : Logique de validation avec async/await
  const handleValidation = async () => {  // ‚Üê async
    if (formulaireRef.current) {
      const isValid = await formulaireRef.current.handleValidation();  // ‚Üê await
      
      if (isValid) {
        completeStep(1);
        navigate("/etape2");
      }
    }
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide className="px-2 sm:px-4 lg:px-6 py-2 max-w-full">
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              <EnsembleFormulairesEtape1Form ref={formulaireRef} />
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={1} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape1" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette 1√®re √©tape</h3>
              <p className="text-[12px] text-black">
                Consultez nos cartes conseils :<br/>
. "Quelles informations int√©grer ?" <br/>
. "Arguments commerciaux"<br/>
Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape1;

```

---

## FICHIER  : Etape2.tsx 

### Chemin
`src/1.etapes-generation-annonces/etape2/Etape2.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { Calculator, Calendar, FileText, Star } from "lucide-react";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import SaisieDescriptionForm from "@/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";

const Etape2: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  
  // ‚úÖ MIGRATION : Utilise useStepProgress corrig√©
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(2);
  
  // ‚úÖ INCHANG√â : V√©rification acc√®s √©tape
  React.useEffect(() => {
    if (!isStepAvailable(2)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  
  const headerTitle = "Informations de description";
  const headerSubtitle = "Cette √©tape va permettre √† l'IA de structurer une annonce parfaite en d√©taillant avec pr√©cision les caract√©ristiques de votre bien.";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les √©l√©ments √† votre disposition, sans se soucier de la mise en forme. <br />L'IA se charge de les organiser, les hi√©rarchiser et de r√©diger une description fluide, coh√©rente et percutante.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "Informations de description";
  const card1CentreTexte = "";
  
  const boutonDroiteTexte = "Voir mes Annonces et Outils SEO";

  const allerVersEtape1 = () => {
    console.log("Navigation vers l'√©tape 1");
  };
  
  const handleButtonClick = () => {
    console.log("Bouton droit cliqu√© - Redirection vers l'√©tape suivante");
  };

  // ‚úÖ CORRECTION : async ajout√© (coh√©rence avec autres √©tapes)
  const handleValidateAndNext = async () => {
    completeStep(2);
    navigate("/etape3");
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide>
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              <SaisieDescriptionForm />
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={2} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape2" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette 2√®me √©tape</h3>
              <p className="text-[12px] text-black">
                Consultez nos cartes conseils :<br/>
                . "Quelles informations int√©grer ?" <br/>
                . "Description du bien"<br/>
                Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape2;
```

---

## FICHIER 4/10 : Etape3.tsx

### Chemin
`src/1.etapes-generation-annonces/etape3/Etape3.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { Calculator, Calendar, FileText, Star } from "lucide-react";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import SaisieFinancialForm from "@/components/1-Sources-Generation-Annonces/form-etape3/SaisieFinancialForm";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";

const Etape3: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  
  // ‚úÖ MIGRATION : Utilise useStepProgress corrig√©
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(3);
  
  // ‚úÖ INCHANG√â : V√©rification acc√®s √©tape
  React.useEffect(() => {
    if (!isStepAvailable(3)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  
  const headerTitle = "Informations financi√®res";
  const headerSubtitle = "Cette nouvelle √©tape va permettre √† l'IA de mettre en valeur les √©l√©ments financiers de votre bien : <br />conditions locatives, performances financi√®res, potentiel de d√©veloppement.";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les √©l√©ments √† votre disposition, sans se soucier de la mise en forme. <br />L'IA se charge de les organiser, les hi√©rarchiser et de r√©diger une description fluide, coh√©rente et percutante.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "Informations Financi√®res";
  const card1CentreTexte = "";
  
  const boutonDroiteTexte = "Voir mes Annonces et Outils SEO";

  const allerVersEtape2 = () => {
    console.log("Navigation vers l'√©tape 2");
  };

  const handleButtonClick = () => {
    console.log("Bouton droit cliqu√© - Redirection vers l'√©tape suivante");
  };

  // ‚úÖ CORRECTION : async ajout√© (coh√©rence avec autres √©tapes)
  const handleValidateAndNext = async () => {
    completeStep(3);
    navigate("/etape4");
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide>
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              <SaisieFinancialForm />
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={3} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape3" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette 3√®me √©tape</h3>
              <p className="text-[12px] text-black">
                Consultez nos cartes conseils :<br/>
. "Quelles informations int√©grer ?" <br/>
. "Informations Financi√®res"<br/>
Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape3;
```

---

## FICHIER 5/10 : Etape4.tsx

### Chemin
`src/1.etapes-generation-annonces/etape4/Etape4.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import { SgaFormContainer } from "@/components/1-Sources-Generation-Annonces/layout/SgaFormContainer";
import { Calculator, Calendar, FileText, Lightbulb, HelpCircle, Star } from "lucide-react";
import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
import { QuoteWidget } from "@/components/widgets/quote";
import SaisieDetailsForm from "@/components/1-Sources-Generation-Annonces/form-etape4/SaisieDetailsForm";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";

const Etape4: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  
  // ‚úÖ MIGRATION : Utilise useStepProgress corrig√©
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(4);
  
  // ‚úÖ INCHANG√â : V√©rification acc√®s √©tape
  React.useEffect(() => {
    if (!isStepAvailable(4)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  
  const headerTitle = "Informations Compl√©mentaires";
  const headerSubtitle = "Cette derni√®re √©tape va permettre √† l'IA d'ajouter des informations concernant l'organisation du travail :<br /> conditions d'exploitation actuelles, horaires d'ouverture, cong√©s... ";
  const headerText = "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les √©l√©ments √† votre disposition, sans se soucier de la mise en forme. <br />L'IA se charge de les organiser, les hi√©rarchiser et de r√©diger une description fluide, coh√©rente et percutante. <br />NB : Ces √©l√©ments seront uniquement repris dans l'Annonce Fiche de Synth√®se.";
  
  const headerCustomContent = (
    <ImageRobotHeaderMauve className="h-full w-full" />
  );
  
  const card1CentreTitre = "Autres D√©tails";
  const card1CentreTexte = "";
  
  const boutonDroiteTexte = "Voir mes Annonces et Outils SEO";

  const allerVersEtape3 = () => {
    console.log("Navigation vers l'√©tape 3");
  };

  const handleButtonClick = () => {
    console.log("Bouton droit cliqu√© - Redirection vers l'√©tape suivante");
  };

  // ‚úÖ CORRECTION : async ajout√© (coh√©rence avec autres √©tapes)
  const handleValidateAndFinish = async () => {
    completeStep(4);
    
    toast({
      title: "F√©licitations !",
      description: "Toutes les √©tapes ont √©t√© compl√©t√©es avec succ√®s.",
      duration: 3000,
    });
    
    navigate("/etape5");
  };

  return (
    <LayoutV2GenAnn 
      navTitle={navTitle}
      navLinks={navLinks}
    >
      <Structure5ContainerVide>
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>
      
      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header">
      </div>
      
      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <h2 className="text-xl font-bold mb-4">{card1CentreTitre}</h2>
            <p className="text-sm mb-4">{card1CentreTexte}</p>
            
            <div className="space-y-4">
              <SaisieDetailsForm />
            </div>
          </div>
        </div>
        
        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={4} disabledSteps={disabledSteps} />
            
            <div className="w-full">
              <EtapeFAQ etape="etape4" />
            </div>
            
            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette derni√®re √©tape</h3>
              <p className="text-[12px] text-black">
               Consultez nos cartes conseils :<br/>
. "Quelles informations int√©grer ?"<br/>
. "Autres D√©tails"<br/>
Elles contiennent des informations pr√©cieuses pour vous guider.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape4;
```

---

## FICHIER 6/10 : Etape5.tsx

### Chemin
`src/1.etapes-generation-annonces/etape5/Etape5.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
import { navLinks, navTitle } from "@/components/navigation-site-leadgenaiadbuilder/NavLinks";
import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useToast } from "@/hooks/use-toast";
import { useSgaForm } from "@/components/1-Sources-Generation-Annonces/utils/useSgaForm";
import BoutonEtape5LancerOpenAI from "@/components/1-Sources-Generation-Annonces/form-components/BoutonEtape5LancerOpenAI";
import { supabase } from "@/integrations/supabase/client";
import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";

// ‚úÖ MIGRATION : Import des 7 services OpenAI s√©curis√©s
import { generateWebsiteAd } from "@/services/openai/01.SupabaseEtape1to5/1.Services/1.AnnonceSiteInternet";
import { generateSummarySheet } from "@/services/openai/01.SupabaseEtape1to5/1.Services/2.AnnonceFichedeSynthese";
import { generateNewsletter } from "@/services/openai/01.SupabaseEtape1to5/1.Services/3.AnnonceNewsletter";
import { generateSEOTools } from "@/services/openai/01.SupabaseEtape1to5/1.Services/4.OutilsSEO";
import { generateSMSAnnonce } from "@/services/openai/01.SupabaseEtape1to5/1.Services/5.SMSAnnonce";
import { generateGoogleBusinessProfile } from "@/services/openai/01.SupabaseEtape1to5/1.Services/6.GoogleBusinessProfileAnnonce";
import { generateReseauxSociaux } from "@/services/openai/01.SupabaseEtape1to5/1.Services/7.ReseauxSociauxAnnonce";

const Etape5: React.FC = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  
  // ‚úÖ MIGRATION : Utilise useStepProgress corrig√©
  const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(5);
  const { resetSessionTimer } = useSgaForm();
  
  const [isGenerating, setIsGenerating] = useState(false);
  const [projectId, setProjectId] = useState<string | null>(null);

  // ‚úÖ NOUVEAU : Charger le project_id au montage
  useEffect(() => {
    const loadProjectId = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("etapes_1to5")
          .select("project_id")
          .eq("user_id", user.id)
          .eq("statut", "en_cours")
          .maybeSingle();

        if (error) {
          console.error("Error loading project_id:", error);
          return;
        }

        if (data) {
          setProjectId(data.project_id);
        }
      } catch (err) {
        console.error("Failed to load project_id:", err);
      }
    };

    loadProjectId();
  }, []);

  // ‚úÖ INCHANG√â : V√©rification acc√®s √©tape
  useEffect(() => {
    if (!isStepAvailable(5)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);

  const headerTitle = "F√©licitations !<br /> Vos Annonces et Outils sont pr√™ts √† √™tre g√©n√©r√©s";
  const headerSubtitle = "Tous les √©l√©ments n√©cessaires √† la cr√©ation de vos annonces et de vos outils SEO sont maintenant en place.";
  const headerText = "Vous avez encore le temps de v√©rifier ou de corriger vos informations.";
  const headerCustomContent = <ImageRobotHeaderMauve className="h-full w-full" />;

  // ‚úÖ MIGRATION : Nouvelle logique OpenAI s√©curis√©e
  const handleValidateAndFinish = async () => {
    if (isGenerating) return;

    // V√©rifier projectId
    if (!projectId) {
      toast({
        title: "Erreur",
        description: "Aucun projet trouv√©. Veuillez recommencer depuis l'√©tape 1.",
        duration: 5000,
        variant: "destructive"
      });
      return;
    }

    try {
      setIsGenerating(true);
      resetSessionTimer();

      // ‚úÖ NOUVEAU : R√©cup√©rer les donn√©es depuis Supabase
      const { data: projectData, error: fetchError } = await supabase
        .from("etapes_1to5")
        .select("*")
        .eq("project_id", projectId)
        .single();

      if (fetchError || !projectData) {
        toast({
          title: "Erreur",
          description: "Impossible de r√©cup√©rer les donn√©es du projet.",
          duration: 5000,
          variant: "destructive"
        });
        setIsGenerating(false);
        return;
      }

      // ‚úÖ NOUVEAU : Initialiser status g√©n√©ration dans Supabase
      const { error: statusError } = await supabase
        .from("etapes_1to5")
        .update({
          generation_status: {
            startTime: new Date().toISOString(),
            websiteAd: false,
            summarySheet: false,
            newsletter: false,
            seoTools: false,
            smsAd: false,
            googleBusinessProfile: false,
            reseauxSociaux: false,
            completed: false,
            progress: 0
          }
        })
        .eq("project_id", projectId);

      if (statusError) {
        console.error("Error initializing generation status:", statusError);
      }

      // Compl√©ter √©tape 5
      completeStep(5);

      // Naviguer vers animation
      navigate("/etape5/animation");

      // ‚úÖ MIGRATION : Appels s√©curis√©s via Edge Functions (CL√â RESTE SERVEUR)
      try {
        console.log("[Etape5] G√©n√©ration Annonce Site Internet...");
        const websiteAdResult = await generateWebsiteAd(projectData);
        
        // Sauvegarder dans Supabase
        await supabase
          .from("etapes_1to5")
          .update({ generation_website_ad: websiteAdResult })
          .eq("project_id", projectId);
        
        updateGenerationStatus('websiteAd', true, 14);
      } catch (error) {
        console.error("Erreur g√©n√©ration annonce site internet:", error);
      }

      try {
        console.log("[Etape5] G√©n√©ration Fiche de Synth√®se...");
        const summarySheetResult = await generateSummarySheet(projectData);
        
        await supabase
          .from("etapes_1to5")
          .update({ generation_summary_sheet: summarySheetResult })
          .eq("project_id", projectId);
        
        updateGenerationStatus('summarySheet', true, 28);
      } catch (error) {
        console.error("Erreur g√©n√©ration fiche de synth√®se:", error);
      }

      try {
        console.log("[Etape5] G√©n√©ration Newsletter...");
        const newsletterResult = await generateNewsletter(projectData);
        
        await supabase
          .from("etapes_1to5")
          .update({ generation_newsletter: newsletterResult })
          .eq("project_id", projectId);
        
        updateGenerationStatus('newsletter', true, 42);
      } catch (error) {
        console.error("Erreur g√©n√©ration newsletter:", error);
      }

      try {
        console.log("[Etape5] G√©n√©ration Outils SEO...");
        const seoToolsResult = await generateSEOTools(projectData);
        
        await supabase
          .from("etapes_1to5")
          .update({ generation_seo_tools: seoToolsResult })
          .eq("project_id", projectId);
        
        updateGenerationStatus('seoTools', true, 56);
      } catch (error) {
        console.error("Erreur g√©n√©ration outils SEO:", error);
      }

      try {
        console.log("[Etape5] G√©n√©ration SMS...");
        const smsAdResult = await generateSMSAnnonce(projectData);
        
        await supabase
          .from("etapes_1to5")
          .update({ generation_sms_ad: smsAdResult })
          .eq("project_id", projectId);
        
        updateGenerationStatus('smsAd', true, 70);
      } catch (error) {
        console.error("Erreur g√©n√©ration SMS:", error);
      }

      try {
        console.log("[Etape5] G√©n√©ration Google Business Profile...");
        const googleBusinessProfileResult = await generateGoogleBusinessProfile(projectData);
        
        await supabase
          .from("etapes_1to5")
          .update({ generation_googleprofile_ad: googleBusinessProfileResult })
          .eq("project_id", projectId);
        
        updateGenerationStatus('googleBusinessProfile', true, 85);
      } catch (error) {
        console.error("Erreur g√©n√©ration Google Business Profile:", error);
      }

      try {
        console.log("[Etape5] G√©n√©ration R√©seaux Sociaux...");
        const reseauxSociauxResult = await generateReseauxSociaux(projectData);
        
        await supabase
          .from("etapes_1to5")
          .update({ generation_reseauxsociaux_ad: reseauxSociauxResult })
          .eq("project_id", projectId);
        
        updateGenerationStatus('reseauxSociaux', true, 100);
      } catch (error) {
        console.error("Erreur g√©n√©ration r√©seaux sociaux:", error);
      }

      // Marquer g√©n√©ration termin√©e
      updateGenerationStatus('completed', true, 100);

      // Redirection finale
      setTimeout(() => {
        navigate("/etape6communication");
      }, 1000);

    } catch (error) {
      console.error("Erreur lors de la g√©n√©ration:", error);
      toast({
        title: "Erreur de g√©n√©ration",
        description: "Une erreur est survenue lors de la g√©n√©ration. Veuillez r√©essayer.",
        duration: 5000,
        variant: "destructive"
      });
      setIsGenerating(false);
    }
  };

  // ‚úÖ NOUVEAU : Mettre √† jour le statut dans Supabase
  const updateGenerationStatus = async (key: string, value: boolean, progress: number) => {
    if (!projectId) return;

    try {
      const { data: currentData } = await supabase
        .from("etapes_1to5")
        .select("generation_status")
        .eq("project_id", projectId)
        .single();

      if (currentData) {
        const status = currentData.generation_status || {};
        status[key] = value;
        status.progress = progress;

        await supabase
          .from("etapes_1to5")
          .update({ generation_status: status })
          .eq("project_id", projectId);
      }
    } catch (error) {
      console.error("Error updating generation status:", error);
    }
  };

  return (
    <LayoutV2GenAnn navTitle={navTitle} navLinks={navLinks}>
      <Structure5ContainerVide>
        <StructureHeroPetit
          title={headerTitle}
          subtitle={headerSubtitle}
          description={headerText}
          imageSrc="/lovable-uploads/da9a9af1-75eb-429e-b769-c2ce8901f9aa.png"
        />
      </Structure5ContainerVide>

      {/* Header alternatif avec fond gris clair - gard√© vide */}
      <div className="template-v2-generation-annonces-alternate-header"></div>

      <div className="template-v2-generation-annonces-content-layout">
        <div className="template-v2-generation-annonces-main-column">
          <div className="template-v2-generation-annonces-white-card min-h-[400px] h-full">
            <div className="flex flex-col items-center justify-center h-full p-6 text-center">
              <h2 className="text-[#4A2B87] mb-4 font-extrabold text-2xl">
                Si tout est en place, lancez LeadGenAI IA en cliquant sur le bouton ci-dessous.
              </h2>

              <p className="mb-2 text-base font-semibold">
                Il analyera toutes vos donn√©es et g√©n√©rera en moins d'une minute vos Annonces et Outils SEO.
              </p>

              <p className="font-bold text-black mb-2 py-[8px] text-lg">
                Vous pouvez modifier vos informations en cliquant sur les ic√¥nes de couleur sur la partie de droite de l'√©cran.
              </p>

              <BoutonEtape5LancerOpenAI
                onClick={handleValidateAndFinish}
                disabled={isGenerating}
                isGenerating={isGenerating}
                className="mb-8"
              >
                {isGenerating ? "G√©n√©ration en cours..." : "G√©n√©rer mes Annonces"}
              </BoutonEtape5LancerOpenAI>
            </div>
          </div>
        </div>

        <div className="template-v2-generation-annonces-side-column">
          <div className="w-full space-y-4">
            <DirectivesMenuOnglet activeStep={5} disabledSteps={disabledSteps} />

            <div className="bg-[#F7F5FA] p-3 rounded-lg border border-[#E5E7EB] w-full">
              <h3 className="text-[14px] font-bold text-black mb-2">Pour bien franchir cette derni√®re √©tape</h3>
              <p className="text-[12px] text-black">
                V√©rifiez vos informations dans les √©tapes pr√©c√©dentes.<br />
                Une fois que vous √™tes pr√™t, lancez la g√©n√©ration pour obtenir vos annonces et outils SEO.
              </p>
            </div>
          </div>
        </div>
      </div>
    </LayoutV2GenAnn>
  );
};

export default Etape5;
```


## FICHIER 7/10 : EnsembleFormulairesEtape1Form.tsx 

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape1/EnsembleFormulairesEtape1Form.tsx`

### Code complet

```typescript
import React, { useState, useEffect, forwardRef, useImperativeHandle } from "react";
import TextFieldForm from "../form-components/TextFieldForm";
import MonetaryFieldForm from "../form-components/MonetaryFieldForm";
import SelectionButtonRond from "../form-components/SelectionButtonRond";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Lightbulb } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { useEtape1 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/01.Etape1/HookEtape-1";
import { supabase } from "@/integrations/supabase/client";

// ‚úÖ CORRECTION : Interface avec Promise<boolean>
export interface EnsembleFormulairesEtape1FormRef {
  handleValidation: () => Promise<boolean>;
}

interface EnsembleFormulairesEtape1FormProps {}

const EnsembleFormulairesEtape1Form = forwardRef<EnsembleFormulairesEtape1FormRef, EnsembleFormulairesEtape1FormProps>((props, ref) => {
  const [projectId, setProjectId] = useState<string | null>(null);
  
  // √âtats pour les champs de formulaire
  const [agencyName, setAgencyName] = useState("");
  const [reference, setReference] = useState("");
  const [exclusivite, setExclusivite] = useState("Non");
  const [location, setLocation] = useState("");
  const [propertyType, setPropertyType] = useState("");
  const [saleType, setSaleType] = useState("√† vendre");
  const [price, setPrice] = useState("");
  const [rentAmount, setRentAmount] = useState("");
  const [rentPeriodicity, setRentPeriodicity] = useState("Mensuel");
  const [keyElements, setKeyElements] = useState("");

  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep } = useStepProgress(1);

  // ‚úÖ MIGRATION : Hook Supabase
  const { formData, setFormData: setHookFormData, saveEtape1, loading } = useEtape1(projectId);

  // Charger project_id au montage
  useEffect(() => {
    const loadProjectId = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("etapes_1to5")
          .select("project_id")
          .eq("user_id", user.id)
          .eq("statut", "en_cours")
          .maybeSingle();

        if (data) {
          setProjectId(data.project_id);
        }
      } catch (err) {
        console.error("Failed to load project_id:", err);
      }
    };

    loadProjectId();
  }, []);

  // Charger les donn√©es depuis le hook
  useEffect(() => {
    if (formData && Object.keys(formData).length > 0) {
      setAgencyName(formData.agencyName || "");
      setReference(formData.reference || "");
      setExclusivite(formData.exclusivite || "Non");
      setLocation(formData.location || "");
      setPropertyType(formData.propertyType || "");
      setSaleType(formData.saleType || "√† vendre");
      setPrice(formData.price || "");
      setRentAmount(formData.rentAmount || "");
      setRentPeriodicity(formData.rentPeriodicity || "Mensuel");
      setKeyElements(formData.keyElements || "");
    }
  }, [formData]);

  // Synchroniser les changements avec le hook
  useEffect(() => {
    setHookFormData({
      agencyName,
      reference,
      exclusivite,
      location,
      propertyType,
      saleType,
      price: price || null,
      rentAmount: rentAmount || null,
      rentPeriodicity: rentPeriodicity || null,
      keyElements,
    });
  }, [agencyName, reference, exclusivite, location, propertyType, saleType, price, rentAmount, rentPeriodicity, keyElements]);

  const exclusiviteOptions = [
    { id: "Oui", label: "Oui" },
    { id: "Non", label: "Non" }
  ];
  
  const saleTypeOptions = [
    { id: "√† vendre", label: "√Ä vendre" },
    { id: "√† louer", label: "√Ä louer" }
  ];
  
  const rentPeriodicityOptions = [
    { id: "Mensuel", label: "Mensuel" },
    { id: "Trimestriel", label: "Trimestriel" },
    { id: "Annuel", label: "Annuel" }
  ];

  // ‚úÖ CORRECTION : useImperativeHandle avec async/await
  useImperativeHandle(ref, () => ({
    handleValidation: async () => {
      return await handleValidation();
    }
  }));

  // ‚úÖ CORRECTION : handleFormSubmit avec async/await
  const handleFormSubmit = async () => {
    if (await handleValidation()) {
      completeStep(1);
      navigate("/etape2");
    }
  };
  
  // ‚úÖ CORRECTION : handleValidation avec async
  const handleValidation = async () => {
    if (!agencyName.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le nom de votre agence.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!reference.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir une r√©f√©rence pour le bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!location.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir l'emplacement du bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!propertyType.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le type de bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (saleType === "√† vendre" && !price.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le prix du bien.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (saleType === "√† louer" && !rentAmount.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir le montant du loyer.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    if (!keyElements.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir au moins un argument commercial.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }
    
    // ‚úÖ MIGRATION : Sauvegarder dans Supabase
    const success = await saveEtape1();
    
    if (!success) {
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder les donn√©es.",
        duration: 3000,
        variant: "destructive"
      });
      return false;
    }

    toast({
      title: "Informations valid√©es",
      description: "Vos informations ont √©t√© enregistr√©es avec succ√®s.",
      duration: 3000,
    });
    
    return true;
  };

  const helpContent = (
    <>
      <p className="mb-2">Lors de cette premi√®re √©tape, portez une attention particuli√®re aux arguments commerciaux.<br/><br/>
Les informations saisies dans ce champ permettront √† l'IA de structurer et d'optimiser les titres, les accroches, les CTA de vos annonces et mieux travailler vos outils SEO.</p>
      <ul className="list-disc pl-4 space-y-1">
        <li>Les arguments commerciaux correspondent aux points forts que vous mettez en avant lorsque vous pr√©sentez le bien √† vos prospects. </li>
        <li>Ce sont ces √©l√©ments qui font toute la diff√©rence et captent imm√©diatement l'attention de vos prospect :<br/>
(Emplacement premium, conditions locatives attractives, Fort Potentiel de d√©veloppement, Infos sur le secteur, raret√© de l'offre‚Ä¶)</li>
        <li>Utilisez des phrases courtes mais √† fortes valeurs informatives.</li>
        <li>Vous pourrez d√©velopper certains points dans les parties descriptives.</li>
      </ul>
      <p className="mb-2"><br/>L'IA ne saura jamais mieux que vous les atouts uniques de ce bien.<br/>
Si vous ne lui dites pas, elle ne les inventera pas !<br/>
Par contre, elle saura les mettre en valeur.</p>
    </>
  );

  return (
    <div className="space-y-6">
      <div className="space-y-6">
        <div className="flex flex-wrap items-end gap-5">
          <div className="w-64">
            <TextFieldForm
              id="agencyName"
              title="Nom de l'Agence"
              placeholder="Votre agence immobili√®re"
              value={agencyName}
              onChange={(e) => setAgencyName(e.target.value)}
              required={true}
            />
          </div>
          
          <div className="w-48">
            <TextFieldForm
              id="reference"
              title="R√©f√©rence"
              placeholder="R√©f√©rence du bien"
              value={reference}
              onChange={(e) => setReference(e.target.value)}
              required={true}
            />
          </div>
          
          <div>
            <SelectionButtonRond
              id="exclusivite"
              label="Exclusivit√©"
              options={exclusiviteOptions}
              selectedOption={exclusivite}
              onChange={setExclusivite}
              required={true}
            />
          </div>

          <div className="flex-1">
            <TextFieldForm
              id="location"
              title="Emplacement"
              placeholder="Ville, Arrondissement, D√©partement..."
              value={location}
              onChange={(e) => setLocation(e.target.value)}
              required={true}
            />
          </div>
        </div>

        <div className="flex flex-wrap items-end gap-5">
          <div className="w-52">
            <TextFieldForm
              id="propertyType"
              title="Type de bien"
              placeholder="Restaurant, Commerce, Local Commercial..."
              value={propertyType}
              onChange={(e) => setPropertyType(e.target.value)}
              required={true}
            />
          </div>
          
          <div className="shrink-0">
            <SelectionButtonRond
              id="saleType"
              label="Type de transaction"
              options={saleTypeOptions}
              selectedOption={saleType}
              onChange={setSaleType}
              required={true}
              className="mx-0 px-0"
            />
          </div>

          {saleType === "√† vendre" && (
            <div className="w-36">
              <MonetaryFieldForm
                id="price"
                title="Prix FAI"
                placeholder="450 000‚Ç¨"
                value={price}
                onChange={(e) => setPrice(e.target.value)}
                currency="‚Ç¨"
                required={true}
              />
            </div>
          )}

          {saleType === "√† louer" && (
            <>
              <div className="w-36">
                <MonetaryFieldForm
                  id="rentAmount"
                  title="Loyer HT/HC"
                  placeholder="1 200‚Ç¨"
                  value={rentAmount}
                  onChange={(e) => setRentAmount(e.target.value)}
                  currency="‚Ç¨"
                  required={true}
                />
              </div>
              
              <div className="shrink-0">
                <SelectionButtonRond
                  id="rentPeriodicity"
                  label="P√©riodicit√© du loyer"
                  options={rentPeriodicityOptions}
                  selectedOption={rentPeriodicity}
                  onChange={setRentPeriodicity}
                  required={true}
                  className="mx-0 px-0"
                />
              </div>
            </>
          )}
        </div>
      </div>
      
      <div className="mt-4">
        <FormulaireSaisie
          id="keyElements"
          title="Arguments commerciaux"
          placeholder="Listez 5 arguments commerciaux forts en votre possession..."
          value={keyElements}
          onChange={(e) => setKeyElements(e.target.value)}
          minRows={8}
          required={true}
        />
        
        <div className="flex justify-end mt-4">
          <BoutonValiderInformations onClick={handleFormSubmit} disabled={loading} />
        </div>
        
        <div className="mt-4">
          <SgaHelpBox
            title="Arguments commerciaux"
            content={helpContent}
            icon={<Lightbulb className="h-5 w-5 stroke-[2px] text-amber-500" />}
          />
        </div>
      </div>
    </div>
  );
});

EnsembleFormulairesEtape1Form.displayName = "EnsembleFormulairesEtape1Form";

export default EnsembleFormulairesEtape1Form;
```

---

## FICHIER 8/10 : SaisieDescriptionForm.tsx 

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Lightbulb } from "lucide-react";
import { useToast } from "@/components/ui/use-toast";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useEtape2 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/02.Etape2/HookEtape-2";
import { supabase } from "@/integrations/supabase/client";

export const SaisieDescriptionForm: React.FC = () => {
  const [projectId, setProjectId] = useState<string | null>(null);
  const [propertyDescription, setPropertyDescription] = useState("");
  
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep, goToEtape5 } = useStepProgress(2);
  
  // ‚úÖ MIGRATION : Hook Supabase
  const { formData, setFormData, saveEtape2, loading } = useEtape2(projectId);

  // Charger project_id au montage
  useEffect(() => {
    const loadProjectId = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("etapes_1to5")
          .select("project_id")
          .eq("user_id", user.id)
          .eq("statut", "en_cours")
          .maybeSingle();

        if (data) {
          setProjectId(data.project_id);
        }
      } catch (err) {
        console.error("Failed to load project_id:", err);
      }
    };

    loadProjectId();
  }, []);

  // Charger les donn√©es depuis le hook
  useEffect(() => {
    if (formData.propertyDescription) {
      setPropertyDescription(formData.propertyDescription);
    }
  }, [formData]);

  // Synchroniser les changements
  useEffect(() => {
    setFormData({ propertyDescription });
  }, [propertyDescription]);

  const helpContent = (
    <>
      <p className="mb-2">Dans cette √©tape, listez le maximum d'informations en votre possession sur votre bien.<br/>
Les donn√©es saisies ici permettront √† l'IA de r√©diger une description originale, claire et valorisante.<br/>
Elles seront :<br/>
. Structur√©es et enti√®rement r√©dig√©es dans votre Annonce Site Internet,<br/>
. List√©es et organis√©es dans votre Fiche de Synth√®se,<br/>
. Pr√©sent√©es sous forme de points forts dans votre Annonce Newsletter.<br/>
Rappel des informations essentielles √† inclure :
</p>
      <ul className="list-disc pl-4 space-y-1">
        <li>Maximum d'informations sur l'emplacement, la zone de chalandise...</li>
        <li>Maximum d'informations sur la superficie, la r√©partition des espaces...</li>
        <li>Maximum d'informations sur l'activit√© actuelle, la client√®le, la fr√©quentation...</li>
        <li>Maximum d'informations sur l'int√©rieur de l'√©tablissement (d√©cor, ambiance, √©quipements‚Ä¶)</li>
      </ul>
      <p className="mb-2"><br/>L'IA ne peut pas inventer ce qu'elle ne conna√Æt pas.<br/>
Si une information n'est pas saisie ici, elle ne sera pas utilis√©e dans l'annonce.<br/>
En revanche, plus votre description est compl√®te, plus elle sera mise en valeur avec efficacit√©.</p>
    </>
  );

  const handleDescriptionChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setPropertyDescription(e.target.value);
  };

  const handleValidation = async () => {
    if (!propertyDescription.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir une description du bien avant de continuer.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }
    
    // ‚úÖ MIGRATION : Sauvegarder dans Supabase
    const success = await saveEtape2();
    
    if (!success) {
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder les donn√©es.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }

    toast({
      title: "Informations valid√©es",
      description: "Votre description du bien a √©t√© enregistr√©e avec succ√®s.",
      duration: 3000,
    });
    
    completeStep(2);
    navigate("/etape3");
  };

  const handleBackToEtape5 = async () => {
    if (propertyDescription.trim()) {
      await saveEtape2();
      
      toast({
        title: "Modifications sauvegard√©es",
        description: "Vos modifications ont √©t√© enregistr√©es avant de retourner √† l'√©tape finale.",
        duration: 3000,
      });
    }
    
    goToEtape5();
  };

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 gap-4">
        <div>
          <div className="space-y-4">
            <FormulaireSaisie
              id="propertyDescription"
              title="Description d√©taill√©e"
              placeholder="Listez le maximum d'informations de description en votre possession..."
              value={propertyDescription}
              onChange={handleDescriptionChange}
              minRows={8}
            />
            
            <div className="flex justify-end mt-4">
              <BoutonValiderInformations onClick={handleValidation} disabled={loading} />
            </div>
            
            <div className="mt-6">
              <SgaHelpBox
                title="Description du bien"
                content={helpContent}
                icon={<Lightbulb className="h-5 w-5 stroke-[2px] text-amber-500" />}
                className="w-full"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default SaisieDescriptionForm;
```

---

## FICHIER 9/10 : SaisieFinancialForm.tsx (ADAPT√â)

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape3/SaisieFinancialForm.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Calculator } from "lucide-react";
import { useToast } from "@/components/ui/use-toast";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useEtape3 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/03.Etape3/HookEtape-3";
import { supabase } from "@/integrations/supabase/client";

export const SaisieFinancialForm: React.FC = () => {
  const [projectId, setProjectId] = useState<string | null>(null);
  const [financials, setFinancials] = useState("");
  
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep, goToEtape5 } = useStepProgress(3);
  
  // ‚úÖ MIGRATION : Hook Supabase
  const { formData, setFormData, saveEtape3, loading } = useEtape3(projectId);

  // Charger project_id au montage
  useEffect(() => {
    const loadProjectId = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("etapes_1to5")
          .select("project_id")
          .eq("user_id", user.id)
          .eq("statut", "en_cours")
          .maybeSingle();

        if (data) {
          setProjectId(data.project_id);
        }
      } catch (err) {
        console.error("Failed to load project_id:", err);
      }
    };

    loadProjectId();
  }, []);

  // Charger les donn√©es depuis le hook
  useEffect(() => {
    if (formData.financials) {
      setFinancials(formData.financials);
    }
  }, [formData]);

  // Synchroniser les changements
  useEffect(() => {
    setFormData({ financials });
  }, [financials]);

  const helpContent = (
    <>
      <p className="mb-2">Dans cette √©tape, listez le maximum d'informations financi√®res en votre possession sur votre bien.<br/>
Les donn√©es saisies ici permettront √† l'IA de r√©diger une description originale, claire et valorisante.<br/>
Elles seront :<br/>
. Structur√©es et enti√®rement r√©dig√©es dans votre Annonce Site Internet,
. List√©es et organis√©es dans votre Fiche de Synth√®se,
. Pr√©sent√©es sous forme de points forts dans votre Annonce Newsletter.
Rappel des informations essentielles √† inclure :
</p>
      <ul className="list-disc pl-4 space-y-1">
        <li>Maximum d'informations sur les conditions locatives : loyer, dur√©e de bail, renouvellement, charges, sp√©cificit√©s √©ventuelles...</li>
        <li>Maximum d'informations sur les performances financi√®res : chiffre d'affaires, b√©n√©fices, indicateurs de rentabilit√©...</li>
        <li>Maximum d'informations sur le potentiel de d√©veloppement : extensions possibles, optimisation de l'exploitation, leviers de croissance...</li>
      </ul>
      <p className="mb-2"><br/>L'IA ne peut pas inventer ce qu'elle ne conna√Æt pas.<br/>
Si une information n'est pas saisie ici, elle ne sera pas utilis√©e dans l'annonce.<br/>
En revanche, plus votre description est compl√®te, plus elle sera mise en valeur avec efficacit√©.</p>
    </>
  );

  const handleFinancialsChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setFinancials(e.target.value);
  };

  const handleValidation = async () => {
    if (!financials.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir des informations financi√®res avant de continuer.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }
    
    // ‚úÖ MIGRATION : Sauvegarder dans Supabase
    const success = await saveEtape3();
    
    if (!success) {
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder les donn√©es.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }

    toast({
      title: "Informations valid√©es",
      description: "Vos informations financi√®res ont √©t√© enregistr√©es avec succ√®s.",
      duration: 3000,
    });
    
    completeStep(3);
    navigate("/etape4");
  };

  const handleBackToEtape5 = async () => {
    if (financials.trim()) {
      await saveEtape3();
      
      toast({
        title: "Modifications sauvegard√©es",
        description: "Vos modifications ont √©t√© enregistr√©es avant de retourner √† l'√©tape finale.",
        duration: 3000,
      });
    }
    
    goToEtape5();
  };

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 gap-4">
        <div>
          <div className="space-y-4">
            <FormulaireSaisie
              id="financials"
              title="Informations financi√®res"
              placeholder="Listez le maximum d'informations financi√®res de votre bien en votre possession..."
              value={financials}
              onChange={handleFinancialsChange}
              minRows={8}
            />
            
            <div className="flex justify-end mt-4">
              <BoutonValiderInformations onClick={handleValidation} disabled={loading} />
            </div>
            
            <div className="mt-6">
              <SgaHelpBox
                title="Informations financi√®res"
                content={helpContent}
                icon={<Calculator className="h-5 w-5 stroke-[2px] text-amber-500" />}
                className="w-full"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default SaisieFinancialForm;
```

---

## FICHIER 10/10 : SaisieDetailsForm.tsx

### Chemin
`src/components/1-Sources-Generation-Annonces/form-etape4/SaisieDetailsForm.tsx`

### Code complet

```typescript
import React, { useState, useEffect } from "react";
import FormulaireSaisie from "../form-components/FormulaireSaisie";
import BoutonValiderInformations from "../form-components/BoutonValiderInformations";
import { Calendar } from "lucide-react";
import { useToast } from "@/components/ui/use-toast";
import { SgaHelpBox } from "../help/SgaHelpBox";
import { useNavigate } from "react-router-dom";
import { useStepProgress } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useStepProgress";
import { useEtape4 } from "@/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/04.Etape4/HookEtape-4";
import { supabase } from "@/integrations/supabase/client";

export const SaisieDetailsForm: React.FC = () => {
  const [projectId, setProjectId] = useState<string | null>(null);
  const [details, setDetails] = useState("");
  const [hasNoDetails, setHasNoDetails] = useState(false);
  
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep, goToEtape5 } = useStepProgress(4);
  
  // ‚úÖ MIGRATION : Hook Supabase
  const { formData, setFormData, saveEtape4, loading } = useEtape4(projectId);

  // Charger project_id au montage
  useEffect(() => {
    const loadProjectId = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("etapes_1to5")
          .select("project_id")
          .eq("user_id", user.id)
          .eq("statut", "en_cours")
          .maybeSingle();

        if (data) {
          setProjectId(data.project_id);
        }
      } catch (err) {
        console.error("Failed to load project_id:", err);
      }
    };

    loadProjectId();
  }, []);

  // Charger les donn√©es depuis le hook
  useEffect(() => {
    if (formData.details) {
      setDetails(formData.details);
      setHasNoDetails(false);
    } else if (formData.hasNoDetails) {
      setHasNoDetails(true);
      setDetails("");
    }
  }, [formData]);

  // Synchroniser les changements
  useEffect(() => {
    setFormData({ 
      details: details || null,
      hasNoDetails 
    });
  }, [details, hasNoDetails]);

  const helpContent = (
    <>
      <p className="mb-2">Cette √©tape est optionnelle.<br/>
Vous pouvez n√©anmoins l'utiliser pour lister toutes les informations compl√©mentaires en votre possession sur le bien.<br/>
Les donn√©es saisies ici seront uniquement utilis√©es dans la Fiche de Synth√®se, pour apporter des pr√©cisions utiles sur les conditions d'exploitation du bien.<br/>
Propositions d'informations √† inclure : <br/>
. List√©es et organis√©es dans votre Fiche de Synth√®se.<br/>
</p>
      <ul className="list-disc pl-4 space-y-1">
        <li>Horaires d'ouverture</li>
        <li>P√©riodes de fermeture</li>
        <li>Autres donn√©es utiles d'exploitation</li>
      </ul>
      <p className="mb-2"><br/>Plus vous fournissez d'informations pr√©cises, plus l'IA pourra g√©n√©rer une annonce originale, sur-mesure et percutante..</p>
    </>
  );

  const handleDetailsChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setDetails(e.target.value);
    if (e.target.value.trim() !== "") {
      setHasNoDetails(false);
    }
  };

  const handleHasNoDetailsChange = (value: boolean) => {
    setHasNoDetails(value);
    if (value === true) {
      setDetails("");
    }
  };

  const handleValidation = async () => {
    if (!hasNoDetails && details.trim() === "") {
      toast({
        title: "Attention",
        description: "Cette √©tape est optionnelle, mais vous devez indiquer votre choix. Soit cocher la case 'Je n'ai pas d'informations compl√©mentaires √† fournir', soit saisir des informations.",
        duration: 5000,
      });
      return;
    }
    
    // ‚úÖ MIGRATION : Sauvegarder dans Supabase
    const success = await saveEtape4();
    
    if (!success) {
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder les donn√©es.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }

    toast({
      title: "Informations valid√©es",
      description: hasNoDetails 
        ? "Vous avez indiqu√© ne pas avoir d'informations compl√©mentaires." 
        : "Vos informations compl√©mentaires ont √©t√© enregistr√©es avec succ√®s.",
      duration: 3000,
    });
    
    completeStep(4);
    navigate('/etape5');
  };

  const handleBackToEtape5 = async () => {
    if (!hasNoDetails && details.trim()) {
      await saveEtape4();
      
      toast({
        title: "Modifications sauvegard√©es",
        description: "Vos modifications ont √©t√© enregistr√©es avant de retourner √† l'√©tape finale.",
        duration: 3000,
      });
    }
    
    goToEtape5();
  };

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 gap-4">
        <div>
          <div className="space-y-4">
            <div className="flex items-center mb-4">
              <input
                type="checkbox"
                id="hasNoDetails"
                checked={hasNoDetails}
                onChange={(e) => handleHasNoDetailsChange(e.target.checked)}
                className="h-4 w-4 rounded-full border-2 border-[#5E50A6] focus:outline-none"
              />
              <label htmlFor="hasNoDetails" className="ml-2 text-[14px] font-medium text-[#515151]">
                Je n'ai pas d'informations compl√©mentaires √† fournir
              </label>
            </div>
            
            <FormulaireSaisie
              id="details"
              title="Informations compl√©mentaires"
              placeholder="Cette √©tape est optionnelle. Vous pouvez lister les autres d√©tails que vous souhaitez porter √† la connaissance des futurs acqu√©reurs..."
              value={details}
              onChange={handleDetailsChange}
              minRows={8}
              readOnly={hasNoDetails}
            />
            
            <div className="flex justify-end mt-4">
              <BoutonValiderInformations onClick={handleValidation} disabled={loading} />
            </div>
            
            <div className="mt-6">
              <SgaHelpBox
                title="Informations compl√©mentaires"
                content={helpContent}
                icon={<Calendar className="h-5 w-5 stroke-[2px] text-amber-500" />}
                className="w-full"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default SaisieDetailsForm;
```

---


---



---

## FICHIER 11/10 : NavLinks.tsx 

### Chemin
`src/components/navigation-site-leadgenaiadbuilder/NavLinks.tsx`

### Code complet adapt√©

```typescript

```

---

---





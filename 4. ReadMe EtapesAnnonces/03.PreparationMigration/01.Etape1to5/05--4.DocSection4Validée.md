# SECTION 4 — SERVICES OPENAI  
Phase 1 : migration Étapes 1→5 vers Supabase ; résultats en localStorage

---

## 0) Objet, périmètre et principes immuables

### 0.1 Objet
- Définir, sans ambiguïté, le cahier des charges prêt à coder des services OpenAI pour la génération d’annonces immobilières.
- Remplacer la lecture localStorage d’entrée par une lecture Supabase contrôlée, tout en conservant le stockage des retours de open ai pendant la Phase 1.
- Documenter toutes les dépendances techniques, tables, hooks, helpers, validateurs, conventions et flux.

### 0.2 Périmètre Phase 1
- Lecture des données d’entrée depuis Supabase, table `etapes_1to5`, via `project_id`.
- Exécution de sept services OpenAI correspondant aux sept prompts existants, séquentiellement.
- Paramétrage OpenAI unique et centralisé.
- Stockage des résultats uniquement dans localStorage.
- Aucune écriture des résultats en base.
- Création des deux tables `openai_api_keys` et `openai_usage_logs` pour préparer la Phase 2.
- RLS active et sélective sur les tables.
- Aucun chiffrement ni RPC en Phase 1 pour récupérer la clé.

### 0.3 Principes immuables et normalisation
- Endpoint OpenAI unique : `https://api.openai.com/v1/chat/completions`.
- Modèle OpenAI unique : `gpt-5-mini-2025-08-07`.
- Paramètres OpenAI uniques : `max_completion_tokens = 3000`.  
  Interdiction d’utiliser `temperature`.
- Exécution séquentielle stricte des sept appels (await), dans l’ordre fonctionnel métier validé.
- Conformité stricte au contenu et à la structure des prompts existants.
- Conventions de nommage :
  - SQL (tables, colonnes systèmes) en snake_case.
  - Champs métier de `etapes_1to5` en camelCase.
  - Fonctions et constantes TypeScript en camelCase et UPPER_SNAKE_CASE.
  - Clés localStorage en camelCase.
- Préservation des validateurs de Section 2, non réécrits.

---

## 1) Architecture fonctionnelle et technique

### 1.1 Déroulé macro
- L’utilisateur valide ses informations (Étapes 1→4).
- En Étape 5, l’orchestrateur déclenche, dans l’ordre, les sept services OpenAI.
- Chaque service lit les données du projet dans `etapes_1to5`, prépare le prompt, appelle OpenAI, parse la réponse, puis écrit le JSON de sortie dans localStorage.
- L’UI consomme localStorage pour afficher les résultats.

### 1.2 Composants et responsabilités
- Table `etapes_1to5` :
  - Source unique des champs métier d’entrée, au format camelCase.
  - Accès en lecture, filtré par `project_id` et RLS multi-tenant.
- Table `openai_api_keys` :
  - Répertoire de la clé OpenAI active par organisation.
  - Une seule clé active par organisation.
- Table `openai_usage_logs` :
  - Prévue pour la Phase 2.
  - En Phase 1, non utilisée mais disponible.
- Helper `getActiveOpenAIKey(organisation_id)` :
  - Renvoie la clé OpenAI active en clair via SELECT RLS.
  - Aucun RPC ni chiffrement en Phase 1.
- Hook `useSupabaseOperations.getProjectData(project_id)` :
  - Retourne l’ensemble des champs nécessaires à la construction du prompt.
- Orchestrateur `useGenerateAllAds()` :
  - Appelle les sept services séquentiellement.
  - Produit les états de progression et gère les erreurs.
- Services OpenAI (7 fichiers de service) :
  - Un service par prompt métier.
  - Paramètres OpenAI injectés depuis une source unique.
- Prompts :
  - Fichiers de prompt conservés et inchangés.
  - Injection stricte des champs attendus.

---

## 2) Tables Supabase à créer et règles d’accès

### 2.1 Table `openai_api_keys` (Phase 1 active)
- Rôle :
  - Stocker la clé OpenAI de l’organisation.
  - Une seule clé active par organisation.
- Colonnes minimales :
  - `openai_key_id` (uuid, PK).
  - `organisation_id` (uuid, FK → `organisations.id`).
  - `key_value` (text, clé en clair).
  - `key_active` (boolean, défaut true).
  - `key_created_at` (timestamptz, défaut now()).
  - `key_updated_at` (timestamptz).
- Contraintes :
  - Unicité d’une clé active par organisation.
  - Index sur `organisation_id` et sur `key_active` filtré.
- RLS :
  - SELECT/INSERT/UPDATE/DELETE limités à l’organisation de l’utilisateur connecté via fonction `get_user_organisation_id(auth.uid())`.
- Usage Phase 1 :
  - Lecture SELECT uniquement pour récupérer `key_value`.

### 2.2 Table `openai_usage_logs` (Phase 1 créée, non utilisée)
- Rôle :
  - Journaliser les appels OpenAI, tokens et coûts en Phase 2.
- Colonnes minimales :
  - `log_id` (uuid, PK).
  - `organisation_id` (uuid, FK → `organisations.id`).
  - `project_id` (uuid, FK → `etapes_1to5.project_id`, nullable).
  - `user_id` (uuid, FK → `users.id`).
  - `service_name` (text).
  - `model_used` (text, valeur par défaut `gpt-5-mini-2025-08-07`).
  - `prompt_tokens` (integer, nullable, check ≥ 0 si non null).
  - `completion_tokens` (integer, nullable, check ≥ 0 si non null).
  - `tokens_used` (integer, check ≥ 0).
  - `response_time_ms` (integer, nullable).
  - `status` (text, check in `success|error|timeout`).
  - `error_message` (text, nullable).
  - `estimated_cost_usd` (decimal, nullable).
  - `created_at` (timestamptz, défaut now()).
- RLS :
  - SELECT/INSERT limités à l’organisation de l’utilisateur.
- Usage Phase 1 :
  - Aucun insert ni lecture dans ce document.

---

## 3) Dépendances techniques transverses

### 3.1 Paramètres OpenAI centralisés
- Constantes uniques à importer dans chaque service :
  - Modèle : `gpt-5-mini-2025-08-07`.
  - Paramètre : `max_completion_tokens = 3000`.
- Interdictions :
  - Interdiction d’exposer un paramètre `model` au niveau des appels.
  - Interdiction d’utiliser `temperature`.
  - Interdiction d’utiliser d’autres endpoints OpenAI.

### 3.2 Helper de clé
- Signature fonctionnelle :
  - Entrée : `organisation_id` (uuid).
  - Sortie : `key_value` (text).
- Règles :
  - SELECT RLS strict sur `openai_api_keys`.
  - Erreur explicite si aucune clé active n’est trouvée.

### 3.3 Hook d’accès Supabase
- `useSupabaseEtapesOperations.getProjectData(project_id)` :
  - Retourne l’intégralité du jeu de champs requis pour construire chaque prompt.
  - Garantit que les noms camelCase correspondent aux clés attendues dans les prompts existants.
  - S’appuie en interne sur le hook stratégique `useSupabaseOperations` (non modifié

### 3.4 Validations et mapping
- Validateurs Section 2 à réutiliser :
  - `validateEtape1`, `validateEtape2`, `validateEtape3`, `validateEtape4`.
- Mapping d’entrée :
  - `mapSupabaseToPrompt(propertyData)` interne au service, en lecture seule, sans renommer les clés attendues par les prompts.
- Parsing de sortie :
  - Parsing JSON strict de `choices[0].message.content`.
  - Erreur si le contenu n’est pas un JSON valide.

### 3.5 Orchestration Étape 5
- `useGenerateAllAds()` :
  - Enchaîne les sept services dans l’ordre métier.
  - Met à jour l’état d’avancement.
  - Continue la séquence si un service échoue, en journalisant l’erreur côté console et en notifiant l’utilisateur.

---

## 4) Description des 7 services OpenAI

### 4.1 Vue d’ensemble

| # | Service | Fonction TypeScript | Prompt Source | Clé localStorage |
|---|---------|---------------------|---------------|------------------|
| 1 | Annonce Site Internet | `generateWebsiteAd()` | `1.PromptAnnonceSiteInternet.ts` | `websiteAd` |
| 2 | Fiche de Synthèse | `generateSummarySheetAd()` | `2.PromptAnnonceFichedeSynthese.ts` | `summarySheetAd` |
| 3 | Newsletter | `generateNewsletterAd()` | `3.PromptAnnonceNewsletter.ts` | `newsletterAd` |
| 4 | Outils SEO | `generateSEOTools()` | `4.PromptOutilsSEO.ts` | `seoTools` |
| 5 | Annonce SMS | `generateSMSAd()` | `5.PromptSMSAnnonce.ts` | `smsAd` |
| 6 | Google Business Profile | `generateGoogleMBAd()` | `6.PromptGoogleMyBusiness.ts` | `googleMBAd` |
| 7 | Réseaux Sociaux | `generateSocialMediaAd()` | `7.PromptReseauxSociaux.ts` | `socialMediaAd` |

Remarque sur compatibilité historique :
- Si des clés `generation_*` doivent coexister temporairement, prévoir un double-écriture localStorage le temps de la transition, puis supprimer `generation_*` à la fin de la Phase 1.

---

### 4.2 Service n°1 : Annonce Site Internet — `generateWebsiteAd`

#### Tableau de Définition
| Élément | Détail |
|--------|--------|
| Fichier service | `src/services/openai/1.GenerateurAnnoncesOutilsSeo/services/generateWebsiteAd.ts` |
| Fichier prompt | `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/1.PromptAnnonceSiteInternet.ts` |
| Endpoint | Chat Completions |
| Modèle | `gpt-5-mini-2025-08-07` |
| Paramètres | `max_completion_tokens: 3000` |
| Source de données | `etapes_1to5` via `project_id` |
| Hooks impliqués | `useSupabaseOperations.getProjectData`, `useGenerateAllAds` |
| Validations | `validateEtape1`, `validateEtape2` si requis par le prompt |
| Gestion d’erreur | try/catch avec message utilisateur et log console |

#### Structure de l’appel
- Préparer `propertyData` depuis `etapes_1to5`.
- Résoudre la clé via `getActiveOpenAIKey(organisation_id)`.
- Construire `messages` avec un `system` conforme au rôle rédaction immobilière et un `user` égal au prompt rendu avec `propertyData`.
- Appeler l’endpoint avec les paramètres centralisés.
- Parser strictement la réponse en JSON.
- Stocker le résultat dans `localStorage["websiteAd"]`.

#### Champs d’entrée lus dans `etapes_1to5`
- `agencyName`
- `propertyType`
- `saleType`
- `location`
- `keyElements`
- `propertyDescription`
- `financials`
- `details`
- `exclusivite`
- `price`
- `rentAmount`
- `rentPeriodicity`
- `reference`

#### Format de sortie attendu
- Respecter exactement la structure JSON produite par le prompt, typiquement :
  - `titre`
  - `accroche`
  - `descriptif`
  - `cta`  
  Ne pas renommer. Ne pas enrichir.

#### Correspondance LocalStorage → Supabase (Phase 1)
| Champ LocalStorage source | Source Supabase | Rôle dans le prompt |
|---------------------------|-----------------|---------------------|
| `agencyName` | `etapes_1to5.agencyName` | Contexte agence |
| `propertyType` | `etapes_1to5.propertyType` | Type de bien |
| `saleType` | `etapes_1to5.saleType` | Vente ou location |
| `location` | `etapes_1to5.location` | Contexte géographique |
| `keyElements` | `etapes_1to5.keyElements` | Points forts |
| `propertyDescription` | `etapes_1to5.propertyDescription` | Description |
| `financials` | `etapes_1to5.financials` | Informations financières |
| `details` | `etapes_1to5.details` | Détails techniques |
| `exclusivite` | `etapes_1to5.exclusivite` | Indication d’exclusivité |
| `price` | `etapes_1to5.price` | Prix (texte) |
| `rentAmount` | `etapes_1to5.rentAmount` | Loyer (texte) |
| `rentPeriodicity` | `etapes_1to5.rentPeriodicity` | Périodicité |
| `reference` | `etapes_1to5.reference` | Référence commerciale |

---

### 4.3 Service n°2 : Fiche de Synthèse — `generateSummarySheetAd`

#### Tableau de Définition
| Élément | Détail |
|--------|--------|
| Fichier service | `.../services/generateSummarySheetAd.ts` |
| Fichier prompt | `.../7.PromptsOpenAi/2.PromptAnnonceFichedeSynthese.ts` |
| Endpoint et modèle | Chat Completions, `gpt-5-mini-2025-08-07` |
| Paramètres | `max_completion_tokens: 3000` |
| Hooks impliqués | Orchestrateur, `getProjectData` |
| Validations | `validateEtape2` et suivantes selon prompt |

#### Structure de l’appel
- Identique au service n°1, avec prompt n°2.
- Stockage dans `localStorage["summarySheetAd"]`.

#### Champs d’entrée supplémentaires
- Reprend tous les champs du service n°1.
- Met l’accent sur `financials` et `details` si le prompt l’exige explicitement.

#### Format de sortie attendu
- Respecter le JSON produit par le prompt de fiche de synthèse.

#### Correspondance LocalStorage → Supabase (Phase 1)
- Même liste que n°1, avec annotation des champs particulièrement utilisés par le prompt de synthèse.

---

### 4.4 Service n°3 : Newsletter — `generateNewsletterAd`

#### Tableau de Définition
| Élément | Détail |
|--------|--------|
| Fichier service | `.../services/generateNewsletterAd.ts` |
| Fichier prompt | `.../7.PromptsOpenAi/3.PromptAnnonceNewsletter.ts` |
| Endpoint et modèle | Chat Completions, `gpt-5-mini-2025-08-07` |
| Paramètres | `max_completion_tokens: 3000` |
| Hooks impliqués | Orchestrateur, `getProjectData` |
| Validations | `validateEtape3` si requis |

#### Structure de l’appel
- Identique au n°1 avec prompt n°3.
- Stockage dans `localStorage["newsletterAd"]`.

#### Champs d’entrée utilisés
- Champs de base du n°1, adaptés au ton Newsletter si le prompt le définit.

#### Format de sortie attendu
- Respecter les champs JSON explicités dans le prompt Newsletter.

#### Correspondance LocalStorage → Supabase (Phase 1)
- Tableau identique, en indiquant les champs mis en avant par le prompt.

---

### 4.5 Service n°4 : Outils SEO — `generateSEOTools`

#### Tableau de Définition
| Élément | Détail |
|--------|--------|
| Fichier service | `.../services/generateSEOTools.ts` |
| Fichier prompt | `.../7.PromptsOpenAi/4.PromptOutilsSEO.ts` |
| Endpoint et modèle | Chat Completions, `gpt-5-mini-2025-08-07` |
| Paramètres | `max_completion_tokens: 3000` |
| Hooks impliqués | Orchestrateur, `getProjectData` |
| Validations | `validateEtape3` si SEO dépend de l’étape 3 |

#### Structure de l’appel
- Identique au n°1 avec prompt n°4.
- Stockage dans `localStorage["seoTools"]`.

#### Champs d’entrée utilisés
- Champs textuels nécessaires à la rédaction SEO selon le prompt.
- Interdiction d’introduire de nouveaux champs non définis dans `etapes_1to5`.

#### Format de sortie attendu
- Respecter le schéma JSON du prompt SEO, typiquement balises et suggestions.

#### Correspondance LocalStorage → Supabase (Phase 1)
- Indiquer les champs réellement consommés par le prompt SEO.

---

### 4.6 Service n°5 : Annonce SMS — `generateSMSAd`

#### Tableau de Définition
| Élément | Détail |
|--------|--------|
| Fichier service | `.../services/generateSMSAd.ts` |
| Fichier prompt | `.../7.PromptsOpenAi/5.PromptSMSAnnonce.ts` |
| Endpoint et modèle | Chat Completions, `gpt-5-mini-2025-08-07` |
| Paramètres | `max_completion_tokens: 3000` |
| Hooks impliqués | Orchestrateur, `getProjectData` |
| Validations | `validateEtape4` si requis |

#### Structure de l’appel
- Identique au n°1 avec prompt n°5.
- Stockage dans `localStorage["smsAd"]`.

#### Champs d’entrée utilisés
- Champs de base du n°1.
- `exclusivite` explicitement si le prompt le requiert.

#### Format de sortie attendu
- JSON concis conforme au prompt SMS (texte court, CTA).

#### Correspondance LocalStorage → Supabase (Phase 1)
- Joindre `exclusivite` au tableau de correspondance.

---

### 4.7 Service n°6 : Google Business Profile — `generateGoogleMBAd`

#### Tableau de Définition
| Élément | Détail |
|--------|--------|
| Fichier service | `.../services/generateGoogleMBAd.ts` |
| Fichier prompt | `.../7.PromptsOpenAi/6.PromptGoogleMyBusiness.ts` |
| Endpoint et modèle | Chat Completions, `gpt-5-mini-2025-08-07` |
| Paramètres | `max_completion_tokens: 3000` |
| Hooks impliqués | Orchestrateur, `getProjectData` |
| Validations | `validateEtape4` si requis |

#### Structure de l’appel
- Identique au n°1 avec prompt n°6.
- Stockage dans `localStorage["googleMBAd"]`.

#### Champs d’entrée utilisés
- Champs de base du n°1.
- `location` si le prompt le requiert.

#### Format de sortie attendu
- JSON conforme aux rubriques GMB définies dans le prompt.

#### Correspondance LocalStorage → Supabase (Phase 1)
- Insister sur la présence de `location` dans le mapping.

---

### 4.8 Service n°7 : Réseaux Sociaux — `generateSocialMediaAd`

#### Tableau de Définition
| Élément | Détail |
|--------|--------|
| Fichier service | `.../services/generateSocialMediaAd.ts` |
| Fichier prompt | `.../7.PromptsOpenAi/7.PromptReseauxSociaux.ts` |
| Endpoint et modèle | Chat Completions, `gpt-5-mini-2025-08-07` |
| Paramètres | `max_completion_tokens: 3000` |
| Hooks impliqués | Orchestrateur, `getProjectData` |
| Validations | `validateEtape4` si requis |

#### Structure de l’appel
- Identique au n°1 avec prompt n°7.
- Stockage dans `localStorage["socialMediaAd"]`.

#### Champs d’entrée utilisés
- Champs de base du n°1.
- `reference` si le prompt le requiert.

#### Format de sortie attendu
- JSON multi-entrées conforme au prompt, par plateforme.

#### Correspondance LocalStorage → Supabase (Phase 1)
- Joindre `reference` au tableau de correspondance.

---

## 5) Processus complet de l’orchestration

### 5.1 Préconditions
- `project_id` valide.
- `organisation_id` résolu par le contexte d’authentification.
- Clé OpenAI active présente dans `openai_api_keys` pour l’organisation courante.
- Étapes 1→4 dûment validées au regard des validateurs.

### 5.2 Séquence nominale
- L’utilisateur clique sur “Générer”.
- L’orchestrateur lit `projectData` depuis `etapes_1to5`.
- L’orchestrateur appelle, dans l’ordre, les sept services.
- Chaque service lit la clé OpenAI active et construit le prompt métier.
- Chaque service parse la réponse et écrit le résultat dans localStorage.
- L’UI affiche les résultats.

### 5.3 Gestion des erreurs
- Si la clé est absente :
  - Message explicite et arrêt du service courant.
  - La séquence peut se poursuivre pour les services suivants si pertinent.
- Si l’appel OpenAI échoue :
  - Journalisation console, toast utilisateur, résultat `null` pour le service.
- Si le parsing JSON échoue :
  - Erreur explicite, pas d’écriture en localStorage pour le service concerné.

---

## 6) Conventions, dépendances et interdictions

### 6.1 Conventions de nommage
- SQL système : snake_case.
- Champs métier `etapes_1to5` : camelCase.
- Services et helpers : camelCase.
- Constantes : UPPER_SNAKE_CASE.
- Clés localStorage de sortie : `websiteAd`, `summarySheetAd`, `newsletterAd`, `seoTools`, `smsAd`, `googleMBAd`, `socialMediaAd`.

### 6.2 Dépendances autorisées
- `useSupabaseEtapesOperations` pour la lecture des données projet (s’appuie sur `useSupabaseOperations` en interne).
- `getActiveOpenAIKey` pour la clé.
- Validateurs Section 2.

### 6.3 Interdictions
- Interdiction d’introduire de nouveaux champs non présents dans `etapes_1to5`.
- Interdiction d’ajouter `temperature` ou de modifier le modèle.
- Interdiction de mélanger logique SQL et logique OpenAI dans un même service au détriment de la séparation des rôles.
- Interdiction d’écrire des résultats dans la base en Phase 1.

---

## 7) Checklist de livraison Section 4

- Tables :
  - `openai_api_keys` créée, RLS en place, clé active par organisation vérifiée.
  - `openai_usage_logs` créée, RLS en place, non utilisée en Phase 1.
- Paramétrage OpenAI centralisé :
  - Modèle et paramètres imposés à tous les services.
- Orchestrateur :
  - Séquence 1→7 opérante.
  - Gestion d’erreurs indépendante par service.
- Services :
  - Un service par prompt, strictement conforme aux fichiers de prompt.
  - Mapping d’entrée strict depuis `etapes_1to5`.
  - Parsing JSON strict.
  - Stockage localStorage.
- Documentation :
  - Présent document adjoint à la base de code.
  - Aucun écart non documenté.

---

## 8) Annexes de correspondance

### 8.1 Correspondance sortie localStorage → future table Phase 2
- `websiteAd` → `generated_ads.website_ad_json`.
- `summarySheetAd` → `generated_ads.summary_sheet_ad_json`.
- `newsletterAd` → `generated_ads.newsletter_ad_json`.
- `seoTools` → `generated_ads.seo_tools_json`.
- `smsAd` → `generated_ads.sms_ad_json`.
- `googleMBAd` → `generated_ads.google_mb_ad_json`.
- `socialMediaAd` → `generated_ads.social_media_ad_json`.

### 8.2 Répertoires de référence du dépôt
- Prompts : `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`.
- Services : `src/services/openai/1.GenerateurAnnoncesOutilsSeo/services/`.
- Orchestrateur : `src/hooks/useGenerateAllAds.ts` ou composant d’Étape 5.
- Accès données : `src/components/HOOKS-STRATEGIQUE/4.HOOK-useSupabaseOperations/useSupabaseOperations.ts`.

---



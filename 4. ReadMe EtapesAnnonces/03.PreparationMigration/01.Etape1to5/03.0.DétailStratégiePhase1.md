
# ğŸ¯ DÃ‰TAIL DE LA STRATÃ‰GIE - PHASE 1 : MIGRATION Ã‰TAPES 1 Ã€ 5

## **Principe GÃ©nÃ©ral de la Migration Phase 1 -> Etape 1 Ã  Etape 5**

- **Objectif** : **Migrer le process Localstorage -Supabase**
    - Migrer les **14 champs propertyData** des Ã©tapes 1-4 vers Supabase
    - GÃ©rer la migration de **Etapes 1** Ã  **Etape 5**
    - **PrÃ©parer** et **envoyer** les donnÃ©es Ã  OpenAI
    - Utiliser les **7 prompts spÃ©cifiques** (dÃ©finis dans `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`)
    - **Ne pas aller plus loin**

- **Ce qui reste en localStorage dans cette phase 1** :
    - Les **7 gÃ©nÃ©rations renvoyÃ©es par OpenAI** restent en l'Ã©tat, on les laisse temporairement dans `localStorage`
    - Le **statut de gÃ©nÃ©ration** (`generation_status`) reste Ã©galement dans `localStorage`
    - Afin de laisser la compatibilitÃ© temporaire avec **Ã‰tape 6 Communication** qui reste en `localStorage`
    - Afin de **limiter les risques** et identifier plus facilement de potentiels bugs

---
## **ImpÃ©ratif d'Architecture : Convention du nommage `camelCase`**
### **Interdiction formelle de transformer les champs actuels  `camelCase` en `snake_case`**

### **ImpÃ©ratif absolu pour la migration**
- **Tous les hooks, fonctions, et interactions Supabase crÃ©Ã©s lors de la migration DOIVENT impÃ©rativement :**
    - **Conserver la structure `camelCase` existante** pour **les champs mÃ©tier**
        - (`agencyName`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`, `propertyDescription`, `financials`, `details`, `exclusivite`, `location`, `reference`).
    - **Utiliser `snake_case` uniquement** pour **les champs systÃ¨me Supabase**
        - (`organisation_id`, `user_id`, `created_at`, `updated_at`,  etc.).

### **REGLES CONCERNANT LE NOMMAGE DES `camelCase`**
- **RÃ¨gle SQL- CrÃ©ation de table**
    - Champs mÃ©tier : " camelCase " (avec guillemets doubles)
    - Champs systÃ¨me : snake_case (sans guillemets)
- **RÃ¨gle TypeScript - Hooks & Services**
    - Utilisation directe du camelCase pour champs mÃ©tier
    - Utilisation directe du snake_case pour champs systÃ¨me
    - AUCUNE fonction de conversion n'est nÃ©cessaire
- **RÃ¨gle Triggers**
    - Utiliser : NEW."camelCase" ou NEW.snake_case
    - PrÃ©fÃ©rer les fonctions gÃ©nÃ©riques rÃ©utilisables
---


## ğŸ“‹ OBJECTIF DU DOCUMENT

- Ce document constitue la **stratÃ©gie d'implÃ©mentation dÃ©taillÃ©e** de la migration Phase 1 (Ã‰tapes 1-5) de `localStorage` vers Supabase,
- **sans code**, sous forme de plan stratÃ©gique prÃªt pour l'implÃ©mentation.

**Mission** :
- DÃ©crire l'architecture modulaire complÃ¨te
- DÃ©finir les responsabilitÃ©s de chaque couche
- Ã‰tablir les flux de donnÃ©es et les dÃ©pendances
- Fournir une roadmap claire pour l'implÃ©mentation

---

## ğŸ“‘ SOMMAIRE

1. [Rappel du Contexte](#1-rappel-du-contexte)
2. [Architecture Modulaire en 5 Couches](#2-architecture-modulaire-en-5-couches)
3. [Couche 1 - Hooks MÃ©tier (5 hooks - un par Ã©tape)](#3-couche-1---hooks-mÃ©tier)
4. [Couche 2 - Gestion Progression (1 hook central)](#4-couche-2---gestion-progression)
5. [Couche 3 - Services OpenAI (7 fonctions)](#5-couche-3---services-openai)
6. [Couche 4 - OpÃ©rations Supabase (1 hook technique)](#6-couche-4---opÃ©rations-supabase)
7. [Couche 5 - Utilitaires (fonctions helpers)](#7-couche-5---utilitaires)
8. [Flux Global d'Utilisation](#8-flux-global-dutilisation)
9. [StratÃ©gie Multi-Tenant](#9-stratÃ©gie-multi-tenant)
10. [Triggers et Fonctions SQL](#10-triggers-et-fonctions-sql)
11. [Gestion du champ step_progress](#11-gestion-du-champ-step_progress)
12. [Gestion des champs conditionnels](#12-gestion-des-champs-conditionnels)
13. [Avantages de cette Architecture](#13-avantages-de-cette-architecture)

---

## 1. RAPPEL DU CONTEXTE

### ğŸ“Š RÃ©capitulatif Table SQL

**Table : `etapes_1to5`**
- **Total : 30 champs SQL**
  - **9 champs systÃ¨me** (snake_case) : `id`, `organisation_id`, `user_id`, `utilisateur_type_compte`, `step_progress`, `statut`, `validated_at`, `created_at`, `updated_at`
  - **7 champs analytiques** (snake_case) : `reseau_id`, `reseau_agence_id`, `agence_indep_id`, `logs`, `reseau_direction_id`, `reseau_agence_responsable_id`, `agence_indep_responsable_id`
  - **14 champs mÃ©tier** (camelCase) : `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`, `propertyDescription`, `financials`, `details`, `hasNoDetails`

### ğŸš¨ Convention de Nommage CRITIQUE

**RÃˆGLE D'OR IMPÃ‰RATIVE** :
- âœ… **Champs systÃ¨me Supabase** â†’ `snake_case` (`organisation_id`, `user_id`, `created_at`, `updated_at`, `step_progress`, etc.)
- âœ… **Champs mÃ©tier business** â†’ `camelCase` (`agencyName`, `propertyType`, `saleType`, `price`, `keyElements`, etc.)

**Raison** :
- Ã‰vite la rupture avec les 7 prompts OpenAI existants
- Ã‰vite la rupture avec l'Ã‰tape 6 Communication (Phase 2)
- Garantit une migration sans transformation de donnÃ©es

---

## 2. ARCHITECTURE MODULAIRE EN 5 COUCHES

### Principe de SÃ©paration des ResponsabilitÃ©s

L'architecture repose sur **5 couches modulaires indÃ©pendantes** :

| Couche | Nom | ResponsabilitÃ© Principale | Nombre de modules |
|--------|-----|---------------------------|-------------------|
| **1ï¸âƒ£** | Hooks MÃ©tier | Gestion Ã©tat et logique mÃ©tier par Ã©tape | 5 hooks (1 par Ã©tape) |
| **2ï¸âƒ£** | Gestion Progression | Navigation et dÃ©verrouillage des Ã©tapes | 1 hook central |
| **3ï¸âƒ£** | Services OpenAI | Orchestration appels OpenAI avec Supabase | 7 fonctions d'envoi |
| **4ï¸âƒ£** | OpÃ©rations Supabase | Interface unique CRUD avec Supabase | 1 hook technique |
| **5ï¸âƒ£** | Utilitaires | Fonctions helpers rÃ©utilisables | Fonctions multiples |

---

## 3. COUCHE 1 - HOOKS MÃ‰TIER

### ResponsabilitÃ©s Globales

- Gestion de l'Ã©tat local des champs de chaque Ã©tape
- Chargement des donnÃ©es existantes depuis Supabase
- Validation mÃ©tier selon rÃ¨gles spÃ©cifiques
- Sauvegarde progressive dans Supabase
- DÃ©clenchement de `completeStep(X)` aprÃ¨s validation

### Tableau DÃ©taillÃ© des 5 Hooks

| Hook | Ã‰tape | Champs gÃ©rÃ©s | RÃ¨gles de validation | Actions validation | DÃ©pendances |
|------|-------|--------------|---------------------|-------------------|-------------|
| **Hook Ã‰tape 1** | 1 | `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements` | - Tous obligatoires sauf `price`/`rentAmount` (conditionnel selon `saleType`)- CohÃ©rence `saleType` â†” `price`/`rentAmount` | 1. Validation champs2. Sauvegarde Supabase3. `completeStep(1)`4. Navigation `/etape2` | Hook OpÃ©rations Supabase |
| **Hook Ã‰tape 2** | 2 | `propertyDescription` | - Obligatoire- Longueur minimale | 1. Validation2. Sauvegarde Supabase3. `completeStep(2)`4. Navigation `/etape3` | Hook OpÃ©rations SupabaseUtilitaires Formatage |
| **Hook Ã‰tape 3** | 3 | `financials` | - Obligatoire- Longueur minimale | 1. Validation2. Sauvegarde Supabase3. `completeStep(3)`4. Navigation `/etape4` | Hook OpÃ©rations SupabaseUtilitaires Formatage |
| **Hook Ã‰tape 4** | 4 | `details`, `hasNoDetails` | - Choix exclusif : `details` OU `hasNoDetails`- CohÃ©rence logique | 1. Validation2. Sauvegarde Supabase3. `completeStep(4)`4. Navigation `/etape5` | Hook OpÃ©rations SupabaseUtilitaires Validation |
| **Hook Ã‰tape 5** | 5 | Aucun (lecture seule) | - Projet complet validÃ© | 1. Chargement projet complet2. Affichage rÃ©capitulatif3. Validation finale (`validated_at`, `statut â†’ 'archive'`)4. Orchestration 7 envois OpenAI5. Navigation `/etape5/animation` | Hook OpÃ©rations SupabaseServices OpenAI |

---

## 4. COUCHE 2 - GESTION PROGRESSION

### ResponsabilitÃ©s

Gestion centralisÃ©e de la navigation et du dÃ©verrouillage progressif des Ã©tapes.

### Tableau des FonctionnalitÃ©s

| Fonction | ResponsabilitÃ© | ParamÃ¨tres | Retour | Impact sur Supabase |
|----------|---------------|------------|--------|---------------------|
| `completeStep(X)` | Ajoute l'Ã©tape suivante au tableau `step_progress` | `stepNumber: number` | `void` | `UPDATE etapes_1to5 SET step_progress = array_append(step_progress, X+1)` |
| `isStepAvailable(X)` | VÃ©rifie si une Ã©tape est accessible | `stepNumber: number` | `boolean` | Aucun (lecture locale depuis Supabase) |
| `getDisabledSteps()` | Calcule les Ã©tapes non accessibles | Aucun | `number[]` | Aucun (calcul local) |
| `goToNextStep()` | Navigation vers Ã©tape suivante | Aucun | `void` | Aucun (navigation React Router) |
| `handleNewProject()` | RÃ©initialise le projet | Aucun | `void` | `INSERT etapes_1to5` (nouveau projet) + `step_progress = {1}` |
| `handleBackToEtape5()` | Retour spÃ©cial vers Ã©tape 5 | Aucun | `void` | Sauvegarde modifications + Navigation `/etape5` |

---

## 5. COUCHE 3 - SERVICES OPENAI

### ResponsabilitÃ©s

Orchestration des 7 appels sÃ©quentiels Ã  OpenAI Chat Completions API avec donnÃ©es Supabase.

### Tableau des 7 Fonctions d'Envoi

| Appel | Service | Prompt | Champs `propertyData` utilisÃ©s | RÃ©sultat stockÃ© | Stockage Phase 1 | Utilisation Phase 2 |
|-------|---------|--------|-------------------------------|-----------------|-----------------|---------------------|
| **1** | `generateWebsiteAd()` | `promptAnnonceSiteInternet` | âœ… **TOUS** sauf `details` | `{ titre, accroche, descriptif, cta }` | `localStorage('generation_website_ad')` | Ã‰tape 6 Communication |
| **2** | `generateSummarySheetAd()` | `promptAnnonceFichedeSynthese` | âœ… **TOUS** (y compris `details`) | `{ titre, referenceEtPrix, detailsCles, donneesFinancieres, informationsComplementaires }` | `localStorage('generation_summary_sheet')` | Ã‰tape 6 Communication |
| **3** | `generateNewsletterAd()` | `promptAnnonceNewsletter` | âœ… **TOUS** sauf `details` | `{ titre, accroche, pointsForts, callToAction, prixEtReference }` | `localStorage('generation_newsletter')` | Ã‰tape 6 Communication |
| **4** | `generateSEOTools()` | `promptOutilsSEO` | âœ… **TOUS** sauf `details` | `{ baliseTitre, baliseMetaDescription, urlLongueTraine }` | `localStorage('generation_seo_tools')` | Ã‰tape 6 Communication |
| **5** | `generateSMSAd()` | `promptAnnonceSMS` | âœ… **TOUS** sauf `details` | `{ "restitution-annonce-sms" }` | `localStorage('generation_sms_ad')` | Ã‰tape 6 Communication |
| **6** | `generateGoogleProfileAd()` | `promptAnnonceGoogleBusinessProfile` | âœ… **TOUS** sauf `details` | `{ TitreAnnonceGoogle, AccrocheDescriptiveAnnonceGoogle, PointsFortsAnnonceGoogle, CtaAnnonceGoogle }` | `localStorage('generation_googleprofile_ad')` | Ã‰tape 6 Communication |
| **7** | `generateReseauxSociauxAd()` | `promptAnnonceReseauxSociaux` | âœ… **TOUS** sauf `details` | `{ TitreAnnonceReseaux, AccrocheImpactanteAnnonceReseaux, AtoutsAnnonceReseaux, CtaAnnonceReseaux }` | `localStorage('generation_reseauxsociaux_ad')` | Ã‰tape 6 Communication |

**âš ï¸ ParticularitÃ© champ `details`** :
- âœ… UtilisÃ© **UNIQUEMENT** dans `generateSummarySheetAd()` (Fiche de SynthÃ¨se)
- âŒ **IgnorÃ©** par les 6 autres gÃ©nÃ©rations

---

## 6. COUCHE 4 - OPÃ‰RATIONS SUPABASE

### ResponsabilitÃ©s

Interface unique et sÃ©curisÃ©e entre l'application et Supabase, basÃ©e sur **`useSupabaseOperations`** existant.

### Tableau des OpÃ©rations CRUD

| OpÃ©ration | Fonction | ParamÃ¨tres | Injection automatique | Retour | RLS appliquÃ©e |
|-----------|----------|------------|----------------------|--------|---------------|
| **CrÃ©er projet** | `insert('etapes_1to5', payload)` | `payload: PropertyData` | `organisation_id`, `user_id`, `utilisateur_type_compte`, `step_progress = {1}` | `{ ok, data, message }` | âœ… Oui (via RLS INSERT policy) |
| **Lire projet** | `select('etapes_1to5', { id })` | `{ id: string }` | `organisation_id` (filtre automatique) | `{ ok, data, message }` | âœ… Oui (via RLS SELECT policy) |
| **Mettre Ã  jour champs** | `update('etapes_1to5', 'id', id, payload)` | `id: string`, `payload: Partial` | `organisation_id` (filtre) | `{ ok, data, message }` | âœ… Oui (via RLS UPDATE policy) |
| **Mettre Ã  jour progression** | `update('etapes_1to5', 'id', id, { step_progress })` | `id: string`, `step_progress: number[]` | Aucun (champ spÃ©cifique) | `{ ok, data, message }` | âœ… Oui |
| **Valider projet final** | `update('etapes_1to5', 'id', id, { validated_at: NOW() })` | `id: string` | Trigger `set_validated_at` + `statut_du_projet` | `{ ok, data, message }` | âœ… Oui |
| **Lister projets** | `select('etapes_1to5', { statut: 'en_cours' })` | `{ statut: string }` | `organisation_id`, `user_id` (selon RLS hiÃ©rarchique) | `{ ok, data, message }` | âœ… Oui (visibilitÃ© hiÃ©rarchique) |
| **GÃ©rer logs audit** | `update('etapes_1to5', 'id', id, { logs: jsonb })` | `id: string`, `logs: jsonb` | Aucun (champ `logs` optionnel) | `{ ok, data, message }` | âœ… Oui |

**âš ï¸ Important** : Le hook `useSupabaseOperations` injecte **automatiquement** :
- `organisation_id` (depuis `useCurrentUser().user.organisationId`)
- `user_id` (depuis `users.users_id` liÃ© Ã  `auth.uid()`)
- `utilisateur_type_compte` (depuis `utilisateurs.utilisateur_type_compte`)

---

## 7. COUCHE 5 - UTILITAIRES

### ResponsabilitÃ©s

Fonctions rÃ©utilisables de transformation, validation et conversion.

### Tableau des Utilitaires par CatÃ©gorie

#### 7.1. Utilitaires Formatage

| Fonction | ResponsabilitÃ© | ParamÃ¨tres | Retour | Exemple |
|----------|---------------|------------|--------|---------|
| `parseEuroAmount(value)` | Parse montants euros | `value: string` | `number` | `"450 000â‚¬"` â†’ `450000` |
| `formatEuroAmount(value)` | Formate montants affichage | `value: number` | `string` | `450000` â†’ `"450 000 â‚¬"` |
| `applyBulletFormatting(text)` | Applique puces + capitalisation | `text: string` | `string` | `"emplacement"` â†’ `"â€¢ Emplacement"` |
| `cleanUserInput(text)` | Nettoie saisie | `text: string` | `string` | `" test  "` â†’ `"test"` |

#### 7.2. Utilitaires Validation

| Fonction | ResponsabilitÃ© | ParamÃ¨tres | Retour | RÃ¨gle |
|----------|---------------|------------|--------|-------|
| `validateSaleTypeConsistency(saleType, price, rentAmount)` | Valide cohÃ©rence vente/location | `saleType`, `price`, `rentAmount` | `{ valid: boolean, error?: string }` | Si `saleType="Ã  vendre"` â†’ `price` requis, `rentAmount` null |
| `validateDetailsConsistency(hasNoDetails, details)` | Valide cohÃ©rence dÃ©tails | `hasNoDetails`, `details` | `{ valid: boolean, error?: string }` | Si `hasNoDetails=true` â†’ `details` vide |
| `validateMinLength(text, min)` | Valide longueur minimale | `text`, `min: number` | `boolean` | `text.length >= min` |

#### 7.3. Utilitaires Conversion

| Fonction | ResponsabilitÃ© | ParamÃ¨tres | Retour | Usage |
|----------|---------------|------------|--------|-------|
| `mapLocalStorageToSupabase(localData)` | Mappe localStorage â†’ Supabase | `localData: PropertyData` | `SupabasePayload` | Migration initiale |
| `mapSupabaseToForm(supabaseData)` | Mappe Supabase â†’ Formulaires | `supabaseData: any` | `PropertyData` | Chargement Ã©tapes |
| `mapSupabaseToPrompt(supabaseData)` | Mappe Supabase â†’ Prompts OpenAI | `supabaseData: any` | `PropertyData` | GÃ©nÃ©ration OpenAI |

---

## 8. FLUX GLOBAL D'UTILISATION

### Diagramme SÃ©quentiel

```mermaid
sequenceDiagram
    participant User
    participant HookEtapeX
    participant HookProgression
    participant HookOperations
    participant Supabase
    participant ServicesOpenAI
    participant OpenAI

    User->>HookEtapeX: Arrive sur Ã‰tape X
    HookEtapeX->>HookOperations: select('etapes_1to5', {id})
    HookOperations->>Supabase: SELECT avec RLS (organisation_id)
    Supabase-->>HookOperations: DonnÃ©es projet
    HookOperations-->>HookEtapeX: { ok: true, data }
    HookEtapeX-->>User: Affichage formulaire prÃ©-rempli

    User->>HookEtapeX: Modifie champ
    HookEtapeX->>HookOperations: update('etapes_1to5', 'id', id, {champ})
    HookOperations->>Supabase: UPDATE (debounced, auto organisation_id)
    Supabase-->>HookOperations: { ok: true }

    User->>HookEtapeX: Valide Ã©tape
    HookEtapeX->>HookEtapeX: Validation mÃ©tier (Utilitaires)
    HookEtapeX->>HookProgression: completeStep(X)
    HookProgression->>HookOperations: update('etapes_1to5', 'id', id, {step_progress})
    HookOperations->>Supabase: UPDATE step_progress = array_append(...)
    Supabase-->>HookOperations: { ok: true }
    HookProgression-->>HookEtapeX: Navigation /etapeX+1

    Note over User,OpenAI: [RÃ©pÃ©ter jusqu'Ã  Ã‰tape 5]

    User->>HookEtape5: Validation finale
    HookEtape5->>HookOperations: update('etapes_1to5', 'id', id, {validated_at: NOW()})
    HookOperations->>Supabase: UPDATE validated_at (trigger statut)
    Supabase->>Supabase: Trigger statut_du_projet â†’ 'archive'
    Supabase-->>HookOperations: { ok: true }

    HookEtape5->>ServicesOpenAI: Orchestration 7 envois
    loop 7 gÃ©nÃ©rations
        ServicesOpenAI->>OpenAI: POST /chat/completions
        OpenAI-->>ServicesOpenAI: JSON gÃ©nÃ©ration
        ServicesOpenAI->>ServicesOpenAI: localStorage.setItem('generation_X')
    end

    ServicesOpenAI-->>User: Redirection /etape5/animation
```

---

## 9. STRATÃ‰GIE MULTI-TENANT

### 9.1. Injection Automatique des Champs

**Source** : `02.1.GestionStrategieMultiTenant.md`

| Champ | Source | Moment d'injection | Fonction SQL helper |
|-------|--------|-------------------|---------------------|
| `organisation_id` | `useCurrentUser().user.organisationId` | INSERT/UPDATE | `get_user_organisation_id(auth.uid())` |
| `user_id` | `users.users_id` (liÃ© Ã  `auth.uid()`) | INSERT | Mapping automatique |
| `utilisateur_type_compte` | `utilisateurs.utilisateur_type_compte` | INSERT | `get_user_type_compte(auth.uid())` |
| `reseau_id` | `reseau.reseau_id` (si applicable) | INSERT (optionnel) | `get_user_reseau_id(auth.uid())` |
| `reseau_agence_id` | `reseau_agence.reseau_agence_id` (si applicable) | INSERT (optionnel) | `get_user_reseau_agence_id(auth.uid())` |
| `agence_indep_id` | `agence_independante.agence_indep_id` (si applicable) | INSERT (optionnel) | `get_user_agence_indep_id(auth.uid())` |

### 9.2. RÃ¨gles de VisibilitÃ© HiÃ©rarchique

**Source** : `02.1.GestionStrategieMultiTenant.md`

#### Pour les structures RÃ©seaux

| Type utilisateur | Voit les projets de |
|------------------|---------------------|
| `reseau` | `reseau` + `reseau_direction` |
| `reseau_direction` | `reseau` + `reseau_direction` |
| `reseau_agence` | `reseau_agence` + `reseau_agence_responsable` + `reseau_agence_collaborateur` |
| `reseau_agence_responsable` | `reseau_agence` + `reseau_agence_responsable` + `reseau_agence_collaborateur` |
| `reseau_agence_collaborateur` | **Uniquement ses propres projets** |

#### Pour les structures Agences IndÃ©pendantes

| Type utilisateur | Voit les projets de |
|------------------|---------------------|
| `agence_independante` | `agence_independante` + `agence_independante_responsable` + `agence_independante_collaborateur` |
| `agence_independante_responsable` | `agence_independante` + `agence_independante_responsable` + `agence_independante_collaborateur` |
| `agence_independante_collaborateur` | **Uniquement ses propres projets** |

### 9.3. RLS Policies Requises

**Source** : `02.1.GestionStrategieMultiTenant.md`

| Policy | OpÃ©ration | Logique |
|--------|-----------|---------|
| `etapes_1to5_select_hierarchical` | SELECT | Admin PRESENCA OU (mÃªme `organisation_id` ET logique hiÃ©rarchique selon `utilisateur_type_compte`) |
| `etapes_1to5_insert_own_organisation` | INSERT | `organisation_id` = user's organisation ET `user_id` = current user ET `utilisateur_type_compte` = user's type |
| `etapes_1to5_update_hierarchical` | UPDATE | MÃªme logique que SELECT + empÃªcher modification `organisation_id`/`user_id` |
| `etapes_1to5_delete_own_or_admin` | DELETE | Admin PRESENCA OU (mÃªme `organisation_id` ET `user_id` = current user) |

---

## 10. TRIGGERS ET FONCTIONS SQL

### 10.1. Triggers Supabase

**Source** : `01.Table_etapes1to5.md`

| Trigger | Table | Ã‰vÃ©nement | Condition | Action | Fonction appelÃ©e |
|---------|-------|-----------|-----------|--------|------------------|
| `set_updated_at_etapes1to5` | `etapes_1to5` | `BEFORE UPDATE` | Toujours | `NEW.updated_at := NOW()` | Fonction autonome |
| `set_validated_at` | `etapes_1to5` | `BEFORE UPDATE` | `NEW.validated_at IS NOT NULL` AND `OLD.validated_at IS NULL` | `NEW.validated_at := NOW()` | Fonction autonome |
| `statut_du_projet` | `etapes_1to5` | `BEFORE UPDATE` | `NEW.validated_at IS NOT NULL` AND `5 = ANY(NEW.step_progress)` | `NEW.statut := 'archive'` | Fonction autonome |

### 10.2. Fonctions SQL Helper Multi-Tenant

**Source** : `02.1.GestionStrategieMultiTenant.md`

| Fonction | ParamÃ¨tres | Retour | Utilisation |
|----------|------------|--------|-------------|
| `get_user_organisation_id(user_uuid UUID)` | `user_uuid` | `UUID` | âœ… **DÃ©jÃ  existante** - Injection `organisation_id` |
| `is_admin_presenca(user_uuid UUID)` | `user_uuid` | `BOOLEAN` | âœ… **DÃ©jÃ  existante** - VÃ©rification admin |
| `get_user_agence_indep_id(user_uuid UUID)` | `user_uuid` | `UUID` | âœ… **DÃ©jÃ  existante** - RÃ©cup agence indÃ©p |
| `get_user_type_compte(user_uuid UUID)` | `user_uuid` | `TEXT` | ğŸ†• **Ã€ crÃ©er** - RÃ©cup type compte |
| `get_user_reseau_agence_id(user_uuid UUID)` | `user_uuid` | `UUID` | ğŸ†• **Ã€ crÃ©er** - RÃ©cup agence rÃ©seau |
| `user_belongs_to_reseau_agence(p_user_id UUID, p_reseau_agence_id UUID)` | `p_user_id`, `p_reseau_agence_id` | `BOOLEAN` | ğŸ†• **Ã€ crÃ©er** - VÃ©rif appartenance |
| `user_belongs_to_agence_indep(p_user_id UUID, p_agence_indep_id UUID)` | `p_user_id`, `p_agence_indep_id` | `BOOLEAN` | ğŸ†• **Ã€ crÃ©er** - VÃ©rif appartenance |

---

## 11. GESTION DU CHAMP `step_progress`

### 11.1. Logique du Champ

**Source** : `01.Table_etapes1to5.md` (lignes 116-141)

| Aspect | Description |
|--------|-------------|
| **Type SQL** | `integer[]` (tableau d'entiers) |
| **Initialisation** | `{1}` (seule l'Ã©tape 1 accessible) |
| **Progression** | Ã€ chaque validation d'Ã©tape X â†’ ajoute X+1 au tableau |
| **Navigation libre** | Utilisateur peut naviguer entre toutes les Ã©tapes prÃ©sentes |
| **Non rÃ©gressif** | Une fois ajoutÃ©e, l'Ã©tape reste accessible |
| **Contrainte CHECK** | `array_length(step_progress, 1) >= 1 AND 1 = ANY(step_progress) AND step_progress <@ ARRAY[1,2,3,4,5]` |

### 11.2. Exemples de Valeurs

| Progression | Valeur `step_progress` | Ã‰tapes accessibles | Explication |
|-------------|------------------------|-------------------|-------------|
| Ã‰tape 1 validÃ©e | `{1, 2}` | 1, 2 | Peut faire Ã‰tape 2 |
| Ã‰tape 2 validÃ©e | `{1, 2, 3}` | 1, 2, 3 | Peut faire Ã‰tape 3 |
| Ã‰tape 3 validÃ©e | `{1, 2, 3, 4}` | 1, 2, 3, 4 | Peut faire Ã‰tape 4 |
| Ã‰tape 4 validÃ©e | `{1, 2, 3, 4, 5}` | 1, 2, 3, 4, 5 | Peut gÃ©nÃ©rer OpenAI |
| Retour Ã‰tape 2 (modification) | `{1, 2, 3, 4, 5}` | **Toutes** | Navigation libre, pas de rÃ©gression |

---

## 12. GESTION DES CHAMPS CONDITIONNELS

### 12.1. Logique `saleType` â†” `price`/`rentAmount`

**Source** : `01.Table_etapes1to5.md`

| ScÃ©nario | `saleType` | `price` | `rentAmount` | `rentPeriodicity` | Contrainte CHECK SQL |
|----------|------------|---------|--------------|-------------------|---------------------|
| **Vente** | `'Ã  vendre'` | **Requis** (NOT NULL, â‰¥ 0) | **NULL** | **NULL** | `CHECK ((saleType = 'Ã  vendre' AND price IS NOT NULL AND price >= 0 AND rentAmount IS NULL) OR ...)` |
| **Location** | `'Ã  louer'` | **NULL** | **Requis** (NOT NULL, â‰¥ 0) | **Requis** (Mensuel/Trimestriel/Annuel) | `CHECK ((saleType = 'Ã  louer' AND rentAmount IS NOT NULL AND rentAmount >= 0 AND price IS NULL) OR ...)` |

### 12.2. Logique `hasNoDetails` â†” `details`

**Source** : `01.Table_etapes1to5.md`

| ScÃ©nario | `hasNoDetails` | `details` | Contrainte CHECK SQL |
|----------|---------------|----------|---------------------|
| **Aucune info** | `true` | **NULL ou vide** | `CHECK ((hasNoDetails = true AND (details IS NULL OR details = '')) OR ...)` |
| **Infos saisies** | `false` | **Requis** (length > 0) | `CHECK ((hasNoDetails = false AND length(details) > 0) OR ...)` |

---

## 13. AVANTAGES DE CETTE ARCHITECTURE

### Tableau des BÃ©nÃ©fices

| Avantage | Description | Impact |
|----------|-------------|--------|
| **ModularitÃ©** | Chaque hook a une responsabilitÃ© unique | Facilite maintenance et Ã©volutions |
| **RÃ©utilisabilitÃ©** | Couche OpÃ©rations Supabase + Utilitaires partagÃ©s | Ã‰vite duplication code |
| **TestabilitÃ©** | Chaque module peut Ãªtre testÃ© isolÃ©ment | Augmente fiabilitÃ© |
| **MaintenabilitÃ©** | Modifications localisÃ©es (ex: changer validation Ã©tape 2 sans toucher autres) | RÃ©duit risque rÃ©gression |
| **TraÃ§abilitÃ©** | Logs audit centralisÃ©s via Hook OpÃ©rations | Facilite debugging |
| **Ã‰volutivitÃ©** | Facile d'ajouter nouvelles Ã©tapes ou nouvelles fonctions OpenAI | ScalabilitÃ© assurÃ©e |
| **CompatibilitÃ©** | PrÃ©serve `localStorage` temporairement pour Phase 2 | Migration progressive sÃ©curisÃ©e |
| **SÃ©curitÃ©** | RLS Supabase + validation double (client + serveur) | Protection donnÃ©es multi-tenant |
| **Performance** | Index sur `organisation_id`, `user_id`, `step_progress` | RequÃªtes rapides |
| **ConformitÃ©** | Respect strict naming convention (camelCase mÃ©tier + snake_case systÃ¨me) | CompatibilitÃ© OpenAI garantie |

---

## ğŸ¯ SYNTHÃˆSE

Cette stratÃ©gie garantit :
- âœ… Migration **sans rupture** avec OpenAI et Ã‰tape 6 Communication
- âœ… Architecture **multi-tenant sÃ©curisÃ©e** (RLS + injection automatique)
- âœ… **ModularitÃ© maximale** (5 couches indÃ©pendantes)
- âœ… **TraÃ§abilitÃ© complÃ¨te** (logs, triggers, audit)
- âœ… **Navigation libre** entre Ã©tapes (via `step_progress`)
- âœ… **Validation robuste** (client + serveur + CHECK constraints)
- âœ… **RÃ©utilisabilitÃ©** (hooks stratÃ©giques existants)

**Cette stratÃ©gie est maintenant prÃªte pour l'implÃ©mentation technique.** ğŸš€

---
---

# ğŸ“Š TABLEAU RÃ‰CAPITULATIF - Ã‰lÃ©ments Ã  CrÃ©er pour la Migration Phase 1

## ğŸ“ˆ BILAN QUANTITATIF GLOBAL

| CatÃ©gorie | Total | Ã€ CrÃ©er | Existant (OK) | Existant (Adapter) |
|-----------|-------|---------|---------------|-------------------|
| **SQL (Fonctions + Triggers)** | 11 | 8 | 3 | - |
| **RLS Policies** | 2 | 2 | - | - |
| **Tables Supabase** | 1 | 1 | - | - |
| **Hooks React Business** | 5 | 5 | - | - |
| **Hooks React Progression** | 1 | 1 | - | - |
| **Hooks React Techniques** | 1 | - | - | 1 |
| **Services OpenAI** | 7 | 7 | - | - |
| **Utilitaires** | 12 | 12 | - | - |
| **Composants React** | ~8 | - | - | ~8 |
| **Contextes React** | 1 | - | - | 1 |
| **TOTAL GÃ‰NÃ‰RAL** | **49** | **36 (73%)** | **3 (6%)** | **10 (21%)** |
---

## 1ï¸âƒ£ FONCTIONS SQL & TRIGGERS
**Total Fonctions SQL** : 11 (7 fonctions + 4 triggers)  
**Ã€ crÃ©er** : **8** (4 fonctions + 4 triggers) | **Existantes** : 3

| # | Nom | Type | Statut | PrioritÃ© | DÃ©pendances |
|---|-----|------|--------|----------|-------------|
| 1 | `get_user_organisation_id()` | Fonction SQL | âœ… Existe | - | - |
| 2 | `is_admin_presenca()` | Fonction SQL | âœ… Existe | - | - |
| 3 | `get_user_agence_indep_id()` | Fonction SQL | âœ… Existe | - | - |
| 4 | `get_user_type_compte()` | Fonction SQL | ğŸ”´ Ã€ crÃ©er | Haute | `users`, `utilisateurs` |
| 5 | `get_user_reseau_agence_id()` | Fonction SQL | ğŸ”´ Ã€ crÃ©er | Haute | `users`, `utilisateurs` |
| 6 | `user_belongs_to_reseau_agence()` | Fonction SQL | ğŸ”´ Ã€ crÃ©er | Haute | `utilisateurs` |
| 7 | `user_belongs_to_agence_indep()` | Fonction SQL | ğŸ”´ Ã€ crÃ©er | Haute | `utilisateurs` |
| 8 | `set_updated_at_etapes1to5` | Trigger | ğŸ”´ Ã€ crÃ©er | Haute | Table `etapes_1to5` |
| 9 | `set_validated_at` | Trigger | ğŸ”´ Ã€ crÃ©er | Moyenne | Table `etapes_1to5` |
| 10 | `statut_du_projet` | Trigger | ğŸ”´ Ã€ crÃ©er | Moyenne | Table `etapes_1to5` |
| 11 | `populate_analytical_fields_etapes1to5` | Trigger | ğŸ”´ Ã€ crÃ©er | Haute | Fonctions SQL #4, #5 |
---

## 2ï¸âƒ£ POLITIQUES RLS
**Total RLS** : 2  
**Ã€ crÃ©er** : **2**

| # | Nom | Table | Statut | PrioritÃ© |
|---|-----|-------|--------|----------|
| 1 | `admin_presenca_full_access_etapes1to5` | `etapes_1to5` | ğŸ”´ Ã€ crÃ©er | Haute |
| 2 | `organisation_hierarchical_access_etapes1to5` | `etapes_1to5` | ğŸ”´ Ã€ crÃ©er | Haute |
---

## 3ï¸âƒ£ TABLE SUPABASE
**Total Tables** : 1  
**Ã€ crÃ©er** : **1**
| # | Nom | Colonnes | Statut | PrioritÃ© |
|---|-----|----------|--------|----------|
| 1 | `etapes_1to5` | 30 champs + contraintes CHECK | ğŸ”´ Ã€ crÃ©er | Critique |
---

## 4ï¸âƒ£ HOOKS REACT - BUSINESS
**Total Hooks Business** : 5  
**Ã€ crÃ©er** : **5**

| # | Nom | ResponsabilitÃ© | Statut | PrioritÃ© | DÃ©pendances |
|---|-----|----------------|--------|----------|-------------|
| 1 | `useEtape1()` | Gestion Ã‰tape 1 (Informations GÃ©nÃ©rales) | ğŸ”´ Ã€ crÃ©er | Haute | `useSupabaseOperations` |
| 2 | `useEtape2()` | Gestion Ã‰tape 2 (Type/Prix/Localisation) | ğŸ”´ Ã€ crÃ©er | Haute | `useSupabaseOperations` |
| 3 | `useEtape3()` | Gestion Ã‰tape 3 (Ã‰lÃ©ments ClÃ©s) | ğŸ”´ Ã€ crÃ©er | Haute | `useSupabaseOperations` |
| 4 | `useEtape4()` | Gestion Ã‰tape 4 (Description) | ğŸ”´ Ã€ crÃ©er | Haute | `useSupabaseOperations` |
| 5 | `useEtape5()` | Gestion Ã‰tape 5 (DÃ©tails Financiers) | ğŸ”´ Ã€ crÃ©er | Haute | `useSupabaseOperations` |
---

## 5ï¸âƒ£ HOOKS REACT - PROGRESSION
**Total Hooks Progression** : 1 hook (+ 6 fonctions internes)  
**Ã€ crÃ©er** : **1**

| # | Nom | ResponsabilitÃ© | Statut | PrioritÃ© | DÃ©pendances |
|---|-----|----------------|--------|----------|-------------|
| 1 | `useStepProgress()` | Hook central de gestion de progression | ğŸ”´ Ã€ crÃ©er | Critique | `useSupabaseOperations` |

**Fonctions incluses dans `useStepProgress()`** :
- `markStepComplete(stepNumber)`
- `canAccessStep(stepNumber)`
- `goToNextStep()`
- `goToPreviousStep()`
- `resetProgress()`
- `getCurrentStepData()`
---

## 6ï¸âƒ£ HOOKS REACT - TECHNIQUES
**Total Hooks Techniques** : 1  
**Existants** : 1 (Ã  adapter pour `etapes_1to5`)
| # | Nom | ResponsabilitÃ© | Statut | PrioritÃ© |
|---|-----|----------------|--------|----------|
| 1 | `useSupabaseOperations` | CRUD multi-tenant gÃ©nÃ©rique | âœ… Existe | - |

---

### 7ï¸âƒ£ SERVICES OPENAI
**Total Services OpenAI** : 7  
**Ã€ crÃ©er** : **7**

| # | Nom | ResponsabilitÃ© | Statut | PrioritÃ© | DÃ©pendances |
|---|-----|----------------|--------|----------|-------------|
| 1 | `generateWebsiteAd()` | GÃ©nÃ©ration annonce site web | ğŸ”´ Ã€ crÃ©er | Haute | `mapSupabaseToPrompt()` |
| 2 | `generateFacebookAd()` | GÃ©nÃ©ration post Facebook | ğŸ”´ Ã€ crÃ©er | Haute | `mapSupabaseToPrompt()` |
| 3 | `generateInstagramAd()` | GÃ©nÃ©ration post Instagram | ğŸ”´ Ã€ crÃ©er | Haute | `mapSupabaseToPrompt()` |
| 4 | `generateLinkedInAd()` | GÃ©nÃ©ration post LinkedIn | ğŸ”´ Ã€ crÃ©er | Haute | `mapSupabaseToPrompt()` |
| 5 | `generateEmailAd()` | GÃ©nÃ©ration email marketing | ğŸ”´ Ã€ crÃ©er | Haute | `mapSupabaseToPrompt()` |
| 6 | `generateSMSAd()` | GÃ©nÃ©ration SMS | ğŸ”´ Ã€ crÃ©er | Haute | `mapSupabaseToPrompt()` |
| 7 | `generatePrintAd()` | GÃ©nÃ©ration annonce presse | ğŸ”´ Ã€ crÃ©er | Haute | `mapSupabaseToPrompt()` |

---

## 8ï¸âƒ£ UTILITAIRES (HELPERS)
**Total Utilitaires** : 12  
**Ã€ crÃ©er** : **12**

#### 8.1 Formatage
| # | Nom | ResponsabilitÃ© | Statut | PrioritÃ© |
|---|-----|----------------|--------|----------|
| 1 | `formatPrice()` | Formatage prix (â‚¬) | ğŸ”´ Ã€ crÃ©er | Moyenne |
| 2 | `formatRent()` | Formatage loyer (â‚¬/mois) | ğŸ”´ Ã€ crÃ©er | Moyenne |
| 3 | `formatAddress()` | Formatage adresse complÃ¨te | ğŸ”´ Ã€ crÃ©er | Moyenne |
| 4 | `formatDate()` | Formatage dates (ISO â†’ FR) | ğŸ”´ Ã€ crÃ©er | Basse |

#### 8.2 Validation
| # | Nom | ResponsabilitÃ© | Statut | PrioritÃ© |
|---|-----|----------------|--------|----------|
| 5 | `validateEtape1()` | Validation Ã‰tape 1 | ğŸ”´ Ã€ crÃ©er | Haute |
| 6 | `validateEtape2()` | Validation Ã‰tape 2 | ğŸ”´ Ã€ crÃ©er | Haute |
| 7 | `validateEtape3()` | Validation Ã‰tape 3 | ğŸ”´ Ã€ crÃ©er | Haute |
| 8 | `validateEtape4()` | Validation Ã‰tape 4 | ğŸ”´ Ã€ crÃ©er | Haute |
| 9 | `validateEtape5()` | Validation Ã‰tape 5 | ğŸ”´ Ã€ crÃ©er | Haute |

#### 8.3 Conversion / Mapping
| # | Nom | ResponsabilitÃ© | Statut | PrioritÃ© |
|---|-----|----------------|--------|----------|
| 10 | `mapLocalStorageToSupabase()` | Migration localStorage â†’ Supabase | ğŸ”´ Ã€ crÃ©er | Critique |
| 11 | `mapSupabaseToForm()` | Hydratation formulaires | ğŸ”´ Ã€ crÃ©er | Haute |
| 12 | `mapSupabaseToPrompt()` | PrÃ©paration prompts OpenAI | ğŸ”´ Ã€ crÃ©er | Haute |
---

## 9ï¸âƒ£ COMPOSANTS REACT
**Total Composants** : Existants  
**Action** : **0** ***Adaptation uniquement (pas de crÃ©ation)***


| # | Nom | Type | Statut | Action |
|---|-----|------|--------|--------|
| 1 | Composants Ã‰tapes 1-5 | Composants UI | âœ… Existent | ğŸ”„ Ã€ adapter (Supabase) |


---

## ğŸ”Ÿ CONTEXTES REACT
**Total Contextes** : 1  
**Action** : **0** ***Adaptation uniquement***

| # | Nom | ResponsabilitÃ© | Statut | Action |
|---|-----|----------------|--------|--------|
| 1 | `AnnonceContext` | Ã‰tat global annonces | âœ… Existe | ğŸ”„ Ã€ adapter (Supabase) |
---
---


## ğŸ—ºï¸ ROADMAP DE CRÃ‰ATION RECOMMANDÃ‰E

### **Phase A - Fondations SQL** (PrioritÃ© Critique)
**DurÃ©e estimÃ©e** : 2-3h  
**Objectif** : CrÃ©er l'infrastructure base de donnÃ©es

1. âœ… CrÃ©er 4 fonctions SQL helper (`get_user_type_compte`, `get_user_reseau_agence_id`, `user_belongs_to_reseau_agence`, `user_belongs_to_agence_indep`)
2. âœ… CrÃ©er table `etapes_1to5` avec contraintes CHECK
3. âœ… CrÃ©er 4 triggers (`set_updated_at`, `set_validated_at`, `statut_du_projet`, `populate_analytical_fields`)
4. âœ… CrÃ©er 2 politiques RLS
5. âœ… Tester isolation multi-tenant

**DÃ©pendances** : Aucune  
**Bloquant pour** : Phases B, C, D

---

### **Phase B - Hooks & Utilitaires** (PrioritÃ© Haute)
**DurÃ©e estimÃ©e** : 4-5h  
**Objectif** : CrÃ©er la couche logique React

1. âœ… CrÃ©er 12 utilitaires (formatage, validation, mapping)
2. âœ… CrÃ©er hook central `useStepProgress()` + 6 fonctions
3. âœ… CrÃ©er 5 hooks mÃ©tier (`useEtape1` Ã  `useEtape5`)
4. âœ… Adapter `useSupabaseOperations` pour `etapes_1to5`

**DÃ©pendances** : Phase A terminÃ©e  
**Bloquant pour** : Phase C

---

### **Phase C - Services OpenAI** (PrioritÃ© Haute)
**DurÃ©e estimÃ©e** : 3-4h  
**Objectif** : CrÃ©er la gÃ©nÃ©ration de contenus

1. âœ… CrÃ©er 7 services OpenAI (site web, Facebook, Instagram, LinkedIn, Email, SMS, Print)
2. âœ… Tester gÃ©nÃ©ration avec donnÃ©es rÃ©elles
3. âœ… Valider qualitÃ© des prompts

**DÃ©pendances** : Phase B terminÃ©e (`mapSupabaseToPrompt()`)  
**Bloquant pour** : Phase D

---

### **Phase D - Migration & Adaptation UI** (PrioritÃ© Moyenne)
**DurÃ©e estimÃ©e** : 2-3h  
**Objectif** : Finaliser l'intÃ©gration

1. âœ… Adapter composants Ã‰tapes 1-5 (Supabase au lieu de localStorage)
2. âœ… Adapter `AnnonceContext` (Supabase)
3. âœ… CrÃ©er script migration `migrateExistingProjects()`
4. âœ… Tester workflow complet utilisateur

**DÃ©pendances** : Phases A, B, C terminÃ©es  
**Bloquant pour** : Mise en production

---

## âœ… CHECKLIST DE VALIDATION FINALE

### SQL & Base de DonnÃ©es
- [ ] 4 fonctions SQL helper crÃ©Ã©es et testÃ©es
- [ ] Table `etapes_1to5` crÃ©Ã©e avec 30 champs
- [ ] 4 triggers fonctionnels (`updated_at`, `validated_at`, `statut_du_projet`, `populate_analytical_fields`)
- [ ] 2 politiques RLS actives et testÃ©es
- [ ] Contraintes CHECK validÃ©es (`saleType` â†’ `price`/`rentAmount`)
- [ ] Indexes crÃ©Ã©s sur `organisation_id`, `client_id`, `created_at`

### Hooks React
- [ ] `useStepProgress()` + 6 fonctions crÃ©Ã©es
- [ ] 5 hooks mÃ©tier (`useEtape1` Ã  `useEtape5`) crÃ©Ã©s
- [ ] `useSupabaseOperations` adaptÃ© pour `etapes_1to5`
- [ ] Gestion erreurs robuste dans tous les hooks

### Services & Utilitaires
- [ ] 7 services OpenAI crÃ©Ã©s et testÃ©s
- [ ] 12 utilitaires crÃ©Ã©s (formatage, validation, mapping)
- [ ] `mapLocalStorageToSupabase()` testÃ© avec donnÃ©es rÃ©elles
- [ ] Validation mÃ©tier complÃ¨te (Ã‰tapes 1-5)

### Migration & UI
- [ ] Composants Ã‰tapes 1-5 adaptÃ©s (Supabase)
- [ ] `AnnonceContext` migrÃ© vers Supabase
- [ ] Script migration localStorage exÃ©cutÃ©
- [ ] Tests utilisateur complets (crÃ©ation â†’ validation â†’ OpenAI)

### Multi-Tenant & SÃ©curitÃ©
- [ ] Isolation stricte par `organisation_id` validÃ©e
- [ ] HiÃ©rarchie RÃ©seau/Agence/IndÃ©pendant testÃ©e
- [ ] RLS empÃªche accÃ¨s inter-organisations
- [ ] Admins PRESENCA ont accÃ¨s global

### Performance & Monitoring
- [ ] Temps de rÃ©ponse CRUD < 200ms
- [ ] GÃ©nÃ©ration OpenAI < 5s
- [ ] Logs d'erreurs configurÃ©s
- [ ] Rollback localStorage prÃ©vu en cas d'Ã©chec

---

**Document prÃ©parÃ© le** : 2025-01-XX  
**Prochaine Ã©tape** : Document 04 - Cahier des charges dÃ©taillÃ© des Ã©lÃ©ments Ã  crÃ©er  
**Validation requise avant** : Lancement de la migration Phase 1


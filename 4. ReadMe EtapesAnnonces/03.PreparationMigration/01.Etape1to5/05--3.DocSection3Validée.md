# ğŸ“˜ SECTION 3 â€“ HOOKS REACT  
## Phase 1 : Migration LocalStorage â†’ Supabase (Ã‰tapes 1 Ã  5)

**Version :** v1.1  
**Date :** 2025-11-04  
**Statut :** Document prÃ©paratoire validÃ© â€“ RÃ©fÃ©rence unique pour codage React  

---

## ğŸ“‹ CONTEXTE & OBJECTIFS

Cette section dÃ©finit les **7 hooks React** nÃ©cessaires Ã  la migration du flux **LocalStorage â†’ Supabase**, pour la gestion des **Ã‰tapes 1 Ã  5** du processus de crÃ©ation dâ€™annonce dans LeadGenAI AdBuilder.

Ces hooks sâ€™appuient sur :  
- la **table Supabase `etapes_1to5`**,  
- les **validateurs et mappers** de la Section 2 â€“ UTILITAIRES,  
- la **stratÃ©gie multi-tenant** documentÃ©e dans `nnn1.1_preparation_GestionStrategieMultiTenant.md`,  
- et les **RLS policies SQL** comme seule source de gestion de visibilitÃ© hiÃ©rarchique.  

---

## âš™ï¸ ARCHITECTURE GLOBALE

```
src/
 â””â”€â”€ components/
     â””â”€â”€ HOOKS-ANNONCES/
         â”œâ”€â”€ useSupabaseEtapesOperations.ts   â† Hook technique
         â”œâ”€â”€ useStepProgress.ts               â† Hook progression
         â”œâ”€â”€ useEtape1.ts                     â† Hook mÃ©tier Ã‰tape 1
         â”œâ”€â”€ useEtape2.ts                     â† Hook mÃ©tier Ã‰tape 2
         â”œâ”€â”€ useEtape3.ts                     â† Hook mÃ©tier Ã‰tape 3
         â”œâ”€â”€ useEtape4.ts                     â† Hook mÃ©tier Ã‰tape 4
         â””â”€â”€ useEtape5.ts                     â† Hook mÃ©tier Ã‰tape 5
```

---

## ğŸ§± 3.1 â€“ HOOK TECHNIQUE : `useSupabaseEtapesOperations`

| Ã‰lÃ©ment                        | DÃ©tails                                                                                                                                                           |
| ------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Nom du fichier**             | `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/01.Hooks/00.Technique/useSupabaseEtapesOperations.ts`                                                           |
| **ResponsabilitÃ©**             | Centraliser toutes les opÃ©rations de lecture et Ã©criture sur la table `etapes_1to5` sans modifier le hook stratÃ©gique `useSupabaseOperations`.                    |
| **Connexion**                  | Importe le hook stratÃ©gique `useSupabaseOperations` (non modifiÃ©) et rÃ©utilise son client `supabase` en interne.                                                  |
| **CompatibilitÃ© multi-tenant** | RLS Supabase gÃ¨re automatiquement les accÃ¨s selon `organisation_id`, `user_id` et `utilisateur_type_compte`.                                                      |
| **Principe clÃ©**               | Ce hook mÃ©tier isole toutes les opÃ©rations spÃ©cifiques Ã  la gestion des Ã©tapes 1â†’5. Il agit comme une surcouche spÃ©cialisÃ©e, sans impacter la couche stratÃ©gique. |

---

### **ImplÃ©mentation fonctionnelle (principe gÃ©nÃ©ral)**

```ts
import { useSupabaseOperations } from "@/components/HOOKS-STRATEGIQUE/4.HOOK-useSupabaseOperations/useSupabaseOperations";
import { Etapes1to5Row } from "@/types/etapes1to5";

export function useSupabaseEtapesOperations() {
  const { supabase } = useSupabaseOperations();

  // Lecture des donnÃ©es dâ€™une Ã©tape pour un utilisateur donnÃ©
  async function getEtapeData(userId: string, step: number) {
    return supabase
      .from("etapes_1to5")
      .select("*")
      .eq("user_id", userId)
      .contains("step_progress", [step])
      .maybeSingle();
  }

  // Sauvegarde (crÃ©ation ou mise Ã  jour) dâ€™une Ã©tape
  async function saveEtapeData(payload: Partial<Etapes1to5Row>) {
    return supabase
      .from("etapes_1to5")
      .upsert(payload, { onConflict: "id" })
      .select();
  }

  // Validation dâ€™une Ã©tape terminÃ©e (procÃ©dure RPC)
  async function completeStep(id: string, newStep: number) {
    return supabase.rpc("update_step_progress", {
      p_id: id,
      p_new_step: newStep,
    });
  }

  return { getEtapeData, saveEtapeData, completeStep };
}
```

---

### âœ… **CaractÃ©ristiques**

| CritÃ¨re         | Statut | Description                                                                |
| --------------- | ------ | -------------------------------------------------------------------------- |
| **ConformitÃ©**  | âœ…      | Compatible avec la table `etapes_1to5` et les RLS existantes.              |
| **SÃ©curitÃ©**    | âœ…      | Aucun accÃ¨s direct non autorisÃ© (RLS SQL).                                 |
| **Ã‰volutivitÃ©** | âœ…      | Extension possible en Phase 2 (`getProjectData`, `saveProjectData`, etc.). |
| **Isolation**   | âœ…      | Le hook stratÃ©gique `useSupabaseOperations` reste inchangÃ©.                |
| **LisibilitÃ©**  | âœ…      | Logique mÃ©tier claire, dÃ©couplÃ©e du code global Supabase.                  |

---

### **Note importante**

> Cette implÃ©mentation Ã©vite dâ€™ajouter `getProjectData()` dans le hook stratÃ©gique `useSupabaseOperations`.
> Pour des raisons de **stabilitÃ©** et de **sÃ©paration des responsabilitÃ©s**, cette mÃ©thode vit dÃ©sormais dans un **hook mÃ©tier dÃ©diÃ©** (`useSupabaseEtapesOperations`).
>
> Aucun changement nâ€™est requis dans `HOOKS-STRATEGIQUE`.
> Tous les appels aux donnÃ©es des Ã©tapes doivent passer par ce nouveau hook mÃ©tier.

---

---

## ğŸ§­ 3.2 â€“ HOOK PROGRESSION : `useStepProgress`

| Ã‰lÃ©ment | DÃ©tails |
|----------|----------|
| **Nom du fichier** | `src/components/HOOKS-ANNONCES/useStepProgress.ts` |
| **ResponsabilitÃ©** | GÃ¨re la progression utilisateur dans les Ã©tapes 1â†’5. |
| **Connexion** | Repose sur `useSupabaseEtapesOperations.completeStep()`. |

```ts
import { useState } from "react";
import { useSupabaseEtapesOperations } from "./useSupabaseEtapesOperations";

export function useStepProgress(initialStep = 1) {
  const [currentStep, setCurrentStep] = useState(initialStep);
  const { completeStep } = useSupabaseEtapesOperations();

  const markStepComplete = async (id: string, step: number) => {
    const { error } = await completeStep(id, step);
    if (!error) setCurrentStep(step + 1);
  };

  return { currentStep, markStepComplete };
}
```

---

## ğŸ§© 3.3 â€“ HOOKS MÃ‰TIER

Chaque hook correspond Ã  une Ã©tape du processus mÃ©tier.  
Ils utilisent :
- les **validateurs** (`validateEtape1`, `validateEtape2`, â€¦)  
- les **mappers** (`mapLocalStorageToSupabase`, `mapSupabaseToForm`)  
- et le **hook technique** `useSupabaseEtapesOperations`.

---

### **3.3.1 â€“ useEtape1.ts**

```ts
import { useState } from "react";
import { validateEtape1 } from "@/utils/validators";
import { mapLocalStorageToSupabase } from "@/utils/mappers";
import { useSupabaseEtapesOperations } from "./useSupabaseEtapesOperations";
import { useToast } from "@/components/ui/use-toast";

export function useEtape1(user: any) {
  const [formData, setFormData] = useState({});
  const { saveEtapeData } = useSupabaseEtapesOperations();
  const { toast } = useToast();

  const saveEtape1 = async () => {
    const validation = validateEtape1(formData);
    if (!validation.isValid) {
      toast({ title: "Champs manquants", description: "Veuillez complÃ©ter tous les champs obligatoires." });
      return;
    }

    const payload = mapLocalStorageToSupabase(formData, user);
    const { error } = await saveEtapeData(payload);
    if (!error) toast({ title: "Ã‰tape 1 enregistrÃ©e", description: "Vos informations ont Ã©tÃ© sauvegardÃ©es." });
  };

  return { formData, setFormData, saveEtape1 };
}
```

---

### **3.3.2 â€“ useEtape2.ts**

```ts
import { useState } from "react";
import { validateEtape2 } from "@/utils/validators";
import { useSupabaseEtapesOperations } from "./useSupabaseEtapesOperations";

export function useEtape2() {
  const [description, setDescription] = useState("");
  const { saveEtapeData } = useSupabaseEtapesOperations();

  const saveEtape2 = async (user: any) => {
    const validation = validateEtape2({ propertyDescription: description });
    if (!validation.isValid) return;
    await saveEtapeData({ propertyDescription: description, user_id: user.id });
  };

  return { description, setDescription, saveEtape2 };
}
```

---

### **3.3.3 â€“ useEtape3.ts**

```ts
import { useState } from "react";
import { validateEtape3 } from "@/utils/validators";
import { useSupabaseEtapesOperations } from "./useSupabaseEtapesOperations";

export function useEtape3() {
  const [financials, setFinancials] = useState("");
  const { saveEtapeData } = useSupabaseEtapesOperations();

  const saveEtape3 = async (user: any) => {
    const validation = validateEtape3({ financials });
    if (!validation.isValid) return;
    await saveEtapeData({ financials, user_id: user.id });
  };

  return { financials, setFinancials, saveEtape3 };
}
```

---

### **3.3.4 â€“ useEtape4.ts**

```ts
import { useState } from "react";
import { validateEtape4 } from "@/utils/validators";
import { useSupabaseEtapesOperations } from "./useSupabaseEtapesOperations";

export function useEtape4() {
  const [details, setDetails] = useState("");
  const [hasNoDetails, setHasNoDetails] = useState(false);
  const { saveEtapeData } = useSupabaseEtapesOperations();

  const saveEtape4 = async (user: any) => {
    const validation = validateEtape4({ details, hasNoDetails });
    if (!validation.isValid) return;
    await saveEtapeData({ details, hasNoDetails, user_id: user.id });
  };

  return { details, setDetails, hasNoDetails, setHasNoDetails, saveEtape4 };
}
```

---

### **3.3.5 â€“ useEtape5.ts**

```ts
import { useState } from "react";
import { useSupabaseEtapesOperations } from "./useSupabaseEtapesOperations";
import { mapSupabaseToPrompt } from "@/utils/mappers";

export function useEtape5() {
  const [projectId, setProjectId] = useState<string | null>(null);
  const { getEtapeData } = useSupabaseEtapesOperations();

  const preparePrompt = async (user: any) => {
    const { data } = await getEtapeData(user.id, 5);
    if (!data) return null;
    return mapSupabaseToPrompt(data);
  };

  return { projectId, setProjectId, preparePrompt };
}
```

---

## ğŸ§  NOTES TECHNIQUES

- Tous les champs `price`, `rentAmount`, `details`, `location` sont **TEXT**, non JSON.  
- Aucun champ `surface`, `rooms`, `latitude`, `longitude`, etc.  
- Tous les accÃ¨s passent par le **hook technique** `useSupabaseEtapesOperations`.  
- Les validateurs de Section 2 sont **rÃ©utilisÃ©s Ã  lâ€™identique**.  
- `step_progress` est la seule source de vÃ©ritÃ© sur la progression.  
- Les RLS Supabase assurent toute la gestion hiÃ©rarchique (aucun filtrage client).  

---

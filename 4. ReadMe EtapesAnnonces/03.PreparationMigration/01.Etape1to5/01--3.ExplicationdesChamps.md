
# üìã ANALYSE PR√âPARATOIRE COMPL√àTE - TABLE `etapes_1to5`
## Analyse factuelle de tous les 27 champs (13 syst√®me + 14 m√©tier)

---

## üéØ OBJECTIF DU DOCUMENT

Ce document pr√©sente une **analyse factuelle exhaustive** des 27 champs de la table `etapes_1to5`, en pr√©paration de la migration `localStorage` ‚Üí Supabase. 

**Chaque champ est analys√© selon 12 colonnes** pour garantir une compr√©hension compl√®te avant toute migration.

**Sources utilis√©es :**
- Audits √âtapes 1 √† 5 (`01.Etape1.md` √† `07.BilanEtape1aEtape5.md`)
- Table de r√©f√©rence (`01.0.Table_etapes1to5.md`)
- Strat√©gie multi-tenant (`01.1.GestionStrategieMultiTenant.md`)
- Bible des r√©f√©rences (`02.0.BibleR√©f√©rences.md`)
- Analyse des fichiers sources de l'application

---

## üìã FORMAT D'ANALYSE - 12 COLONNES

| Colonne | Description |
|---------|-------------|
| **Champ** | Nom du champ dans la table |
| **Titre** | Titre descriptif court |
| **Objectifs** | Raison d'√™tre du champ |
| **Fonctionnement** | Comment le champ est utilis√©/modifi√© |
| **R√¥le** | Fonction strat√©gique dans l'application |
| **Utilisation** | Fonctions/composants qui l'utilisent |
| **Utilis√©e par (champs)** | Autres champs d√©pendants |
| **Hook localStorage devant √™tre remplac√©** | R√©f√©rences actuelles localStorage |
| **Trigger SQL** | Triggers Supabase n√©cessaires |
| **Type SQL & Contraintes** | Type + contraintes SQL |
| **Valeurs possibles** | Exemples de valeurs valides |
| **Interdictions (CHECK)** | Valeurs interdites avec contraintes |

---

---

# SECTION 1 : CHAMPS SYST√àME (13 champs)

---

## 1Ô∏è‚É£ Champ : `id`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `project_id` | Identifiant unique du projet annonce | Garantir l'unicit√© de chaque projet d'annonce cr√©√© dans la table | **Initialisation** : G√©n√©r√© automatiquement par Supabase via `gen_random_uuid()` lors de l'`INSERT` **Modification** : Jamais modifi√© apr√®s cr√©ation **Lecture** : Utilis√© comme cl√© primaire pour toutes les op√©rations `SELECT`, `UPDATE`, `DELETE` | - Identifiant technique unique pour chaque projet- Cl√© primaire (PK) de la table- R√©f√©rence pour relations futures (ex: table `generations`) | **Fichiers** :- Pas encore de fichier sp√©cifique (migration √† venir)- Sera utilis√© par tous les hooks CRUD Supabase **Fonctions SQL** :- `SELECT * FROM etapes_1to5 WHERE project_id = 'uuid-projet'` | Aucun champ syst√®me d√©pendant (c'est la racine) | **Hook actuel** :Aucun (localStorage ne stocke pas d'ID unique persistant)**Migration requise** :- Cr√©er hooks de r√©cup√©ration du projet actif par `project_id`- Pattern standard : `useProject(projectId)` | Aucun trigger n√©cessaire (UUID auto-g√©n√©r√© par default) | `uuid NOT NULL DEFAULT gen_random_uuid()` PRIMARY KEY | - `550e8400-e29b-41d4-a716-446655440000` (UUID v4)- `123e4567-e89b-12d3-a456-426614174000` | ‚ùå NULL‚ùå Cha√Æne vide `""`‚ùå Doublon (contrainte PK) |

---

## 2Ô∏è‚É£ Champ : `organisation_id`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `organisation_id` | Identifiant de l'organisation (tenant multi-tenant) | Garantir l'isolation des donn√©es par organisation (multi-tenant) et limiter l'acc√®s RLS | **Initialisation** : Auto-inject√© via `get_user_organisation_id(auth.uid())` lors de l'`INSERT` **Modification** : Lecture seule apr√®s cr√©ation (emp√™ch√© par RLS) **V√©rification RLS** : Toutes les policies SELECT/UPDATE/DELETE filtrent par `organisation_id = get_user_organisation_id(auth.uid())` | - Cl√© d'isolation tenant (multi-tenant root)- Filtrage RLS niveau 1- Cl√© √©trang√®re (FK) vers `organisations(organisation_id)` | **Fonctions SQL utilis√©es** :‚Äì get_user_organisation_id(auth.uid()) (existante, voir 01.1_GestionStrategieMultiTenant.md)‚Äì Utilis√©e dans toutes les RLS policies<br>- **Fichiers** : useSupabaseEtapesOperations.ts (injection automatique de organisation_id dans INSERT, via le client Supabase du hook strat√©gique useSupabaseOperations) | - Utilis√© par les RLS policies pour filtrer tous les SELECT/UPDATE/DELETE- N√©cessaire pour `user_id` (validation que l'utilisateur appartient bien √† cette organisation) | **Hook actuel** :Aucun (localStorage n'a pas de notion d'organisation)**Migration requise** : useSupabaseEtapesOperations injecte automatiquement organisation_id via useCurrentUser(), en s‚Äôappuyant sur le hook strat√©gique useSupabaseOperations (non modifi√©) | **Trigger n√©cessaire** :Aucun (auto-inject√© via default SQL ou hook)  **Alternative** :Cr√©er un trigger `set_organisation_id_on_insert` pour s'assurer que `organisation_id` est toujours d√©fini m√™me sans injection explicite | `uuid NOT NULL REFERENCES organisations(organisation_id) ON DELETE CASCADE` | - `org-abc-123-def-456` (UUID org r√©seau)- `org-xyz-789-ghi-012` (UUID org agence ind√©p.) | ‚ùå NULL‚ùå UUID inexistant dans `organisations`‚ùå UUID d'une autre organisation (emp√™ch√© par RLS) |

---

## 3Ô∏è‚É£ Champ : `user_id`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `user_id` | Identifiant de l'utilisateur cr√©ateur du projet | Tracer qui a cr√©√© le projet et contr√¥ler l'acc√®s en lecture/modification selon la hi√©rarchie | **Initialisation** : Auto-inject√© lors de l'`INSERT` via r√©solution `auth.uid()` ‚Üí `users.users_id` **Modification** : Lecture seule apr√®s cr√©ation **Visibilit√© RLS** : - Collaborateurs voient uniquement `user_id = their_user_id`- Responsables voient `user_id` de leur √©quipe | - Audit du cr√©ateur du projet- Visibilit√© hi√©rarchique (collaborateurs = propres projets uniquement)- Cl√© √©trang√®re (FK) vers `users(users_id)` | **Fonctions SQL** :- R√©solution : `SELECT users_id FROM users WHERE users_auth_id = auth.uid()` **RLS Policy SELECT (ligne 234-238, `01.1.GestionStrategieMultiTenant.md`)** :```sqlWHEN 'reseau_agence_collaborateur' THEN  user_id IN (SELECT users_id FROM users WHERE users_auth_id = auth.uid())``` | - `utilisateur_type_compte` (d√©termine si le `user_id` est filtr√© ou non)- `organisation_id` (validation que `user_id` appartient √† cette organisation) | **Hook actuel** :Aucun (localStorage est anonyme)**Migration requise** :- useSupabaseEtapesOperations.insert() g√®re l‚Äôinjection automatique de user_id via useCurrentUser().userId (le hook strat√©gique reste inchang√©).| **Trigger n√©cessaire** :Aucun (injection automatique via hook ou default SQL) | `uuid NOT NULL REFERENCES users(users_id) ON DELETE CASCADE` | - `user-123-abc-def` (UUID d'un responsable)- `user-456-ghi-jkl` (UUID d'un collaborateur) | ‚ùå NULL‚ùå UUID inexistant dans `users`‚ùå UUID d'un utilisateur d'une autre organisation |

---

## 4Ô∏è‚É£ Champ : `utilisateur_type_compte`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `utilisateur_type_compte` | Type de compte utilisateur (hi√©rarchie multi-tenant) | D√©terminer la port√©e de visibilit√© des projets selon la hi√©rarchie (r√©seau, agence, collaborateur) | **Initialisation** : Auto-inject√© via `get_user_type_compte(auth.uid())` lors de l'`INSERT` **Modification** : Lecture seule **Utilisation RLS** : D√©termine la logique de visibilit√© dans les policies SELECT/UPDATE (voir CASE dans `01.1.GestionStrategieMultiTenant.md` ligne 216-259) | - D√©termine la visibilit√© hi√©rarchique dans les RLS policies- Utilis√© dans `CASE get_user_type_compte(auth.uid())` pour filtrer les projets visibles | **Fonction SQL (√† cr√©er)** :`get_user_type_compte(user_uuid UUID)` (voir `01.1.GestionStrategieMultiTenant.md` ligne 92-105)**RLS Policy SELECT (ligne 216-259)** :```sqlCASE get_user_type_compte(auth.uid())  WHEN 'reseau', 'reseau_direction' THEN ...  WHEN 'reseau_agence_collaborateur' THEN ...END``` | - Utilis√© par les RLS policies pour d√©terminer quels projets sont visibles- D√©termine si `user_id` est filtr√© (collaborateur) ou non (responsable) | **Hook actuel** :Aucun (localStorage n'a pas de hi√©rarchie)**Migration requise** :- useSupabaseEtapesOperations.insert() injecte automatiquement utilisateur_type_compte via useCurrentUser().utilisateurTypeCompte selon la strat√©gie multi-tenant. | **Trigger n√©cessaire** :Aucun (injection automatique via hook ou default SQL) | `text NOT NULL CHECK (utilisateur_type_compte IN ('reseau', 'reseau_direction', 'reseau_agence', 'reseau_agence_responsable', 'reseau_agence_collaborateur', 'agence_independante', 'agence_independante_responsable', 'agence_independante_collaborateur'))` | - `'reseau'`- `'reseau_agence_collaborateur'`- `'agence_independante_responsable'` | ‚ùå NULL‚ùå `'admin'` (non list√©)‚ùå `'client'` (non list√©)‚ùå Toute valeur hors liste CHECK |

---

## 5Ô∏è‚É£ Champ : `reseau_id`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `reseau_id` | R√©f√©rence optionnelle vers le r√©seau (analytique) | Tra√ßabilit√© : lier un projet √† un r√©seau parent pour analytics et reporting | **Initialisation** : Renseign√© automatiquement si `utilisateur_type_compte IN ('reseau', 'reseau_direction')` **Modification** : Lecture seule **Optionnel** : `NULL` si utilisateur agence ind√©pendante | - Lien optionnel vers `reseau(reseau_id)`- Analytique : "Combien de projets cr√©√©s par le r√©seau X ?"- Pas utilis√© dans RLS (visibilit√© bas√©e sur `organisation_id` + `utilisateur_type_compte`) | **Utilisation** :- Requ√™tes analytics : `SELECT COUNT(*) FROM etapes_1to5 WHERE reseau_id = 'uuid-reseau'`- Pas utilis√© dans les RLS policies (c'est `utilisateur_type_compte` qui d√©termine la visibilit√©) | Aucun champ d√©pendant (champ purement analytique) | **Hook actuel** :Aucun**Migration requise** :- Injection conditionnelle dans useSupabaseEtapesOperations.insert() si le type d‚Äôutilisateur est reseau ou reseau_direction. | **Trigger n√©cessaire** :Optionnel : Trigger pour auto-remplir `reseau_id` selon `utilisateur_type_compte` | `uuid NULL REFERENCES reseau(reseau_id) ON DELETE SET NULL` | - `reseau-123-abc` (UUID d'un r√©seau)- `NULL` (si utilisateur agence ind√©pendante) | ‚ùå UUID inexistant dans `reseau` |

---

## 6Ô∏è‚É£ Champ : `reseau_agence_id`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `reseau_agence_id` | R√©f√©rence optionnelle vers l'agence r√©seau (analytique) | Tra√ßabilit√© : lier un projet √† une agence r√©seau pour analytics et visibilit√© hi√©rarchique | **Initialisation** : Renseign√© automatiquement si `utilisateur_type_compte IN ('reseau_agence', 'reseau_agence_responsable', 'reseau_agence_collaborateur')` **Utilisation RLS** : Filtre dans la policy SELECT pour les agences r√©seau (ligne 225-227, `01.1.GestionStrategieMultiTenant.md`) | - Lien optionnel vers `reseau_agence(reseau_agence_id)`- Utilis√© dans RLS pour filtrer les projets visibles par une agence r√©seau- Analytique : "Combien de projets cr√©√©s par l'agence Y ?" | **Fonction SQL (√† cr√©er)** :`get_user_reseau_agence_id(user_uuid UUID)` (voir `01.1.GestionStrategieMultiTenant.md` ligne 110-124)**RLS Policy SELECT (ligne 225-227)** :```sqlreseau_agence_id = get_user_reseau_agence_id(auth.uid())``` | - Utilis√© par les RLS policies pour filtrer les projets d'une agence r√©seau- `utilisateur_type_compte` d√©termine si ce filtre s'applique | **Hook actuel** :Aucun**Migration requise** :-Injection conditionnelle dans useSupabaseEtapesOperations.insert() si le type d‚Äôutilisateur est reseau_agence, reseau_agence_responsable ou reseau_agence_collaborateur.| **Trigger n√©cessaire** :Optionnel : Trigger pour auto-remplir `reseau_agence_id` selon `utilisateur_type_compte` | `uuid NULL REFERENCES reseau_agence(reseau_agence_id) ON DELETE SET NULL` | - `agence-456-def` (UUID d'une agence r√©seau)- `NULL` (si utilisateur r√©seau ou agence ind√©pendante) | ‚ùå UUID inexistant dans `reseau_agence` |

---

## 7Ô∏è‚É£ Champ : `agence_indep_id`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `agence_indep_id` | R√©f√©rence optionnelle vers l'agence ind√©pendante (analytique) | Tra√ßabilit√© : lier un projet √† une agence ind√©pendante pour analytics et visibilit√© hi√©rarchique | **Initialisation** : Renseign√© automatiquement si `utilisateur_type_compte IN ('agence_independante', 'agence_independante_responsable', 'agence_independante_collaborateur')` **Utilisation RLS** : Filtre dans la policy SELECT pour les agences ind√©pendantes (ligne 243-245, `01.1.GestionStrategieMultiTenant.md`) | - Lien optionnel vers `agence_independante(agence_indep_id)`- Utilis√© dans RLS pour filtrer les projets visibles par une agence ind√©pendante- Analytique : "Combien de projets cr√©√©s par l'agence Z ?" | **Fonction SQL (existante)** :`get_user_agence_indep_id(user_uuid UUID)` (d√©j√† existante selon `01.1.GestionStrategieMultiTenant.md` ligne 130-132)**RLS Policy SELECT (ligne 243-245)** :```sqlagence_indep_id = get_user_agence_indep_id(auth.uid())``` | - Utilis√© par les RLS policies pour filtrer les projets d'une agence ind√©pendante- `utilisateur_type_compte` d√©termine si ce filtre s'applique | **Hook actuel** :Aucun**Migration requise** :- Migration requise : Injection conditionnelle dans useSupabaseEtapesOperations.insert() si le type d‚Äôutilisateur est agence_independante, agence_independante_responsable ou agence_independante_collaborateur. | **Trigger n√©cessaire** :Optionnel : Trigger pour auto-remplir `agence_indep_id` selon `utilisateur_type_compte` | `uuid NULL REFERENCES agence_independante(agence_indep_id) ON DELETE SET NULL` | - `agence-789-ghi` (UUID d'une agence ind√©pendante)- `NULL` (si utilisateur r√©seau ou agence r√©seau) | ‚ùå UUID inexistant dans `agence_independante` |

---

## 8Ô∏è‚É£ Champ : `step_progress`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `step_progress` | Liste cumulative des √©tapes d√©verrouill√©es (1 √† 5) | G√©rer la progression s√©quentielle non r√©gressive des √©tapes 1 √† 5, permettant la navigation libre entre √©tapes valid√©es | **Initialisation** : `{1}` (seule √©tape 1 accessible) **Progression** : Chaque validation d'√©tape ajoute l'√©tape suivante via `completeStep(X)` **Exemple** : Apr√®s validation √©tape 2 ‚Üí `{1, 2, 3}` **Non r√©gressif** : Une fois ajout√©e, l'√©tape reste accessible m√™me apr√®s modifications | - Contr√¥ler l'acc√®s aux √©tapes- Permettre navigation libre entre √©tapes valid√©es- Tracer la progression utilisateur- Emp√™cher acc√®s pr√©matur√© aux √©tapes non valid√©es | **Fichiers** :- `useStepProgress.ts` (ligne 9, 14, 18, 33-43) **Fonctions UI** :- `isStepAvailable(step)` : V√©rifie si √©tape accessible- `getDisabledSteps()` : Calcule √©tapes d√©sactiv√©es pour menu- `hasCompletedStep4` : D√©tecter pr√©sence de `5` dans tableau- Menu navigation dynamique (`DirectivesMenuOnglet`) | - `statut` (transition vers 'archive' si `5 IN step_progress` ET `validated_at NOT NULL`)- `validated_at` (conditionne archivage)- Navigation UI (DirectivesMenuOnglet) | **Hook actuel** :`useStepProgress.ts`- Ligne 9 : `availableSteps` state- Ligne 14 : `localStorage.getItem('stepProgress')`- Ligne 18 : `setAvailableSteps(progress)`- Ligne 33-43 : `completeStep(step)`- Ligne 37 : `localStorage.setItem('stepProgress')` **Migration requise** :- Remplacer `localStorage` par `UPDATE etapes_1to5`- Hook Supabase : `useEtapes1to5Progress` | **Aucun trigger n√©cessaire** **Raison** : Le champ est mis √† jour exclusivement par l'application via les hooks apr√®s validation utilisateur **Alternative future** : Trigger optionnel `validate_step_progress_integrity` pour v√©rifier coh√©rence (ex : si `5` pr√©sent, alors `1,2,3,4` doivent l'√™tre aussi) | `integer[] NOT NULL DEFAULT '{1}'::integer[]` **Contraintes CHECK** :- `array_length(step_progress, 1) >= 1`- `1 = ANY(step_progress)`- `step_progress <@ ARRAY[1,2,3,4,5]` | - `{1}` ‚Üí Projet cr√©√©, seule √©tape 1 accessible- `{1, 2}` ‚Üí √âtape 1 valid√©e- `{1, 2, 3}` ‚Üí √âtape 2 valid√©e- `{1, 2, 3, 4}` ‚Üí √âtape 3 valid√©e- `{1, 2, 3, 4, 5}` ‚Üí √âtape 4 valid√©e, **acc√®s complet** | ‚ùå `{}` (vide)‚ùå `{2, 3}` (sans √©tape 1)‚ùå `{1, 6}` (√©tape > 5)‚ùå `NULL` |

---

## 9Ô∏è‚É£ Champ : `statut`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `statut` | Statut du projet ('en_cours', 'archive') | G√©rer le cycle de vie du projet (actif / archiv√©) et permettre le filtrage des projets en cours vs historique | **Initialisation** : `'en_cours'` par d√©faut **Transition automatique** : Passe √† `'archive'` via trigger lorsque `validated_at IS NOT NULL` ET `5 = ANY(step_progress)` **Utilisation** : Filtrage des listes de projets | - Distinguer projets actifs des projets finalis√©s- Permettre filtrage UI ("Mes projets en cours" vs "Historique")- Emp√™cher modification des projets archiv√©s (optionnel via policy UPDATE) | **Requ√™tes UI** :- Page "Mes projets en cours" : `WHERE statut = 'en_cours'`- Page "Historique des annonces" : `WHERE statut = 'archive'` | - `validated_at` (d√©clenche la transition vers 'archive')- `step_progress` (condition n√©cessaire : `5 IN step_progress`) | **Hook actuel** :Aucun (localStorage ne g√®re pas de statut)**Migration requise** :- Aucun hook sp√©cifique (transition automatique via trigger) | **Trigger n√©cessaire** :Nom : `set_statut_archive_on_validation` D√©clenchement : `BEFORE UPDATE` sur `etapes_1to5` Condition : `NEW.validated_at IS NOT NULL` AND `5 = ANY(NEW.step_progress)` AND `OLD.statut = 'en_cours'` Action : `NEW.statut := 'archive'` | `text NOT NULL DEFAULT 'en_cours' CHECK (statut IN ('en_cours', 'archive'))` | - `'en_cours'` (projet actif)- `'archive'` (projet finalis√© et archiv√©) | ‚ùå NULL‚ùå `'brouillon'` (non list√©)‚ùå `'supprim√©'` (non list√©)‚ùå Toute valeur hors liste CHECK |

---

## üîü Champ : `validated_at`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `validated_at` | Date de validation finale avant OpenAI | Enregistrer la date et l'heure exactes de validation finale (√©tape 5) pour tra√ßabilit√© et archivage | **Initialisation** : `NULL` par d√©faut **Renseign√©** : Lors du clic sur "G√©n√©rer mes Annonces" √† l'√©tape 5 via trigger ou application **Utilisation** : - Tra√ßabilit√© temporelle de la validation- Condition du trigger `set_statut_archive_on_validation` | - Timestamp de validation finale- Utilis√© comme condition pour passer `statut` √† `'archive'`- Tra√ßabilit√© du projet | **Trigger** :Utilis√© dans le trigger `set_statut_archive_on_validation` (voir champ `statut`) **Requ√™tes UI** :- Tri par date de validation : `ORDER BY validated_at DESC`- Projets valid√©s cette semaine : `WHERE validated_at > NOW() - INTERVAL '7 days'` | - `statut` (d√©clenche la transition vers 'archive')- `step_progress` (validation requiert `5 IN step_progress`) | **Hook actuel** :Aucun (localStorage ne stocke pas de timestamp de validation)**Migration requise** :- Hook `useGenerateAnnonces()` appelle `UPDATE etapes_1to5 SET validated_at = NOW() WHERE project_id = projectId` | **Trigger n√©cessaire** :Nom : `set_validated_at_on_generation` D√©clenchement : `BEFORE UPDATE` sur `etapes_1to5` Condition : `NEW.validated_at IS NOT NULL` AND `OLD.validated_at IS NULL` Action : Renseigne automatiquement `validated_at := NOW()` | `timestamptz NULL DEFAULT NULL` | - `NULL` (projet non valid√©)- `'2025-01-15 14:32:17+00'` (timestamp de validation)- `'2025-02-03 09:12:45+00'` | ‚ùå Timestamp futur (optionnel CHECK `validated_at <= NOW()`)‚ùå Timestamp ant√©rieur √† `created_at` |

---

## 1Ô∏è‚É£1Ô∏è‚É£ Champ : `logs`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `logs` | Logs de modifications locales (optionnel) | Tracer les modifications apport√©es au projet pour audit et debug (optionnel, non utilis√© actuellement) | **Initialisation** : `{}` (objet JSON vide) **Alimentation** : Automatiquement par des triggers ou l'application lors des `UPDATE` **Format** : `[{ "timestamp": "...", "field": "...", "old_value": "...", "new_value": "..." }]` | - Audit des modifications- Debug en cas de probl√®me- Historique des changements (optionnel) | **Fichiers** :Aucun fichier actuel (fonctionnalit√© non impl√©ment√©e) **Utilisation future** :- Triggers `log_modification_on_update` pour alimenter ce champ- UI d'historique des modifications | Aucun champ d√©pendant (champ purement informatif) | **Hook actuel** :Aucun**Migration requise** :Aucune (fonctionnalit√© future) | **Trigger optionnel** :Nom : `log_modification_on_update` D√©clenchement : `AFTER UPDATE` sur `etapes_1to5` Action : Ajoute une entr√©e JSON avec timestamp, champ modifi√©, ancienne/nouvelle valeur | `jsonb NULL DEFAULT '{}'::jsonb` | - `{}` (aucun log)- `[{"timestamp": "2025-01-15T14:32:17Z", "field": "agencyName", "old_value": "Agence X", "new_value": "Agence Y"}]` | ‚ùå JSON invalide |

---

## 1Ô∏è‚É£2Ô∏è‚É£ Champ : `created_at`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `created_at` | Date de cr√©ation du projet | Enregistrer automatiquement la date et l'heure de cr√©ation du projet pour tra√ßabilit√© | **Initialisation** : `NOW()` par d√©faut lors de l'`INSERT` **Modification** : Jamais modifi√© apr√®s cr√©ation | - Tra√ßabilit√© temporelle de la cr√©ation- Tri chronologique des projets- Calcul de l'anciennet√© d'un projet | **Requ√™tes UI** :- Tri par date de cr√©ation : `ORDER BY created_at DESC`- Projets cr√©√©s cette semaine : `WHERE created_at > NOW() - INTERVAL '7 days'` | - `updated_at` (doit toujours √™tre >= `created_at`)- `validated_at` (doit toujours √™tre >= `created_at`) | **Hook actuel** :Aucun (localStorage ne stocke pas de date de cr√©ation)**Migration requise** :Aucune (auto-g√©n√©r√© par Supabase) | Aucun trigger n√©cessaire (default `NOW()`) | `timestamptz NOT NULL DEFAULT NOW()` | - `'2025-01-15 10:00:00+00'`- `'2025-02-03 14:25:12+00'` | ‚ùå NULL‚ùå Timestamp futur (optionnel CHECK `created_at <= NOW()`) |

---

## 1Ô∏è‚É£3Ô∏è‚É£ Champ : `updated_at`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `updated_at` | Derni√®re modification du projet | Enregistrer automatiquement la date et l'heure de chaque modification du projet | **Initialisation** : `NOW()` par d√©faut lors de l'`INSERT` **Mise √† jour automatique** : Trigger `set_updated_at_etapes1to5` met √† jour √† `NOW()` √† chaque `UPDATE` | - Tra√ßabilit√© temporelle des modifications- Tri par "derni√®re modification"- D√©tection des projets inactifs | **Requ√™tes UI** :- Tri par derni√®re modification : `ORDER BY updated_at DESC`- Projets inactifs : `WHERE updated_at < NOW() - INTERVAL '30 days'` | - `created_at` (doit toujours √™tre >= `created_at`)- `validated_at` (validation d√©clenche un `UPDATE` donc met √† jour `updated_at`) | **Hook actuel** :Aucun (localStorage ne stocke pas de date de modification)**Migration requise** :Aucune (auto-g√©r√© par trigger) | **Trigger n√©cessaire** :Nom : `set_updated_at_etapes1to5` D√©clenchement : `BEFORE UPDATE` sur `etapes_1to5` Action : `NEW.updated_at := NOW()` | `timestamptz NOT NULL DEFAULT NOW()` | - `'2025-01-15 10:00:00+00'` (cr√©ation)- `'2025-01-15 14:32:17+00'` (apr√®s modification)- `'2025-02-03 09:12:45+00'` | ‚ùå NULL‚ùå Timestamp < `created_at`‚ùå Timestamp futur (optionnel CHECK) |

---

---

# SECTION 2 : CHAMPS M√âTIER PropertyData (14 champs)

---

## 1Ô∏è‚É£4Ô∏è‚É£ Champ : `agencyName`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `agencyName` | Nom de l'agence du cr√©ateur de l'annonce | Identifier l'agence immobili√®re cr√©atrice de l'annonce pour l'affichage dans les annonces g√©n√©r√©es | **Saisie** : √âtape 1, champ "Nom de l'Agence" (ligne 186, `EnsembleFormulairesEtape1Form.tsx`) **Validation** : Obligatoire, non vide (ligne 247-254, `EnsembleFormulairesEtape1Form.tsx`) **Formatage** : Capitalisation automatique de la 1√®re lettre (ligne 344-350, `TextFieldForm.tsx`) | - Identifiant commercial de l'agence dans les annonces g√©n√©r√©es- Utilis√© dans TOUS les prompts OpenAI (voir `02.0.BibleR√©f√©rences.md` ligne 310-333) | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 186, 359)- `TextFieldForm.tsx` (capitalisation ligne 344)- `openai.ts` : remplacement `[nom de l'agence]` ‚Üí `agencyName` dans tous les prompts **Prompts OpenAI** :Utilis√© dans **7 prompts** (voir tableau ligne 345-352, `02.0.BibleR√©f√©rences.md`) | Aucun champ d√©pendant (champ autonome) | **Hook actuel** :- `useState("agencyName")` (ligne 186, `EnsembleFormulairesEtape1Form.tsx`)- `localStorage.setItem('propertyData')` via `updatePropertyData()` (ligne 296) **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ agencyName })` | Aucun trigger n√©cessaire | `TEXT NOT NULL CHECK (length(agencyName) > 0)` | - `"Cabinet Presenca"`- `"Agence Immo Lyon"`- `"R√©seau France Immobilier"` | ‚ùå NULL‚ùå `""` (cha√Æne vide)‚ùå Cha√Æne uniquement compos√©e d'espaces |

---

## 1Ô∏è‚É£5Ô∏è‚É£ Champ : `reference`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `reference` | R√©f√©rence du bien immobilier | Identifier de mani√®re unique le bien immobilier dans les annonces g√©n√©r√©es | **Saisie** : √âtape 1, champ "R√©f√©rence" (ligne 187, `EnsembleFormulairesEtape1Form.tsx`) **Validation** : Obligatoire, non vide (ligne 256-259) **Formatage** : Capitalisation automatique de la 1√®re lettre | - R√©f√©rence commerciale du bien dans les annonces- Utilis√© dans TOUS les prompts OpenAI | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 187, 361)- `TextFieldForm.tsx` (capitalisation)- `openai.ts` : remplacement `[r√©f√©rence du bien]` ‚Üí `reference` | Aucun champ d√©pendant | **Hook actuel** :- `useState("reference")` (ligne 187)- `localStorage.setItem('propertyData')` via `updatePropertyData()` **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ reference })` | Aucun trigger n√©cessaire | `TEXT NOT NULL CHECK (length(reference) > 0)` | - `"REF-2025-001"`- `"RESTO-LYON-123"`- `"COM-PARIS-456"` | ‚ùå NULL‚ùå `""` (cha√Æne vide) |

---

## 1Ô∏è‚É£6Ô∏è‚É£ Champ : `exclusivite`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `exclusivite` | Exclusivit√© du mandat (Oui/Non) | Indiquer si l'agence d√©tient un mandat exclusif sur le bien | **Saisie** : √âtape 1, boutons radio "Exclusivit√©" (ligne 188, `EnsembleFormulairesEtape1Form.tsx`) **Valeur par d√©faut** : `"Non"` (ligne 188) **Validation** : Toujours rempli (valeur par d√©faut) | - Utilis√© dans les prompts OpenAI uniquement si `exclusivite === "Oui"` (ligne 199-202, `01.Etape1.md`)- Argument commercial potentiel | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 188, 258)- `SelectionButtonRond.tsx` (options ligne 37-40)- `openai.ts` : remplacement conditionnel `[exclusivit√©]` | Aucun champ d√©pendant | **Hook actuel** :- `useState("Non")` (ligne 188)- `localStorage.setItem('propertyData')` **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ exclusivite })` | Aucun trigger n√©cessaire | `TEXT NOT NULL DEFAULT 'Non' CHECK (exclusivite IN ('Oui', 'Non'))` | - `'Oui'`- `'Non'` (d√©faut) | ‚ùå NULL‚ùå `'oui'` (casse incorrecte)‚ùå `'Exclusif'` (valeur hors liste) |

---

## 1Ô∏è‚É£7Ô∏è‚É£ Champ : `location`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `location` | Emplacement du bien (ville, arrondissement, d√©partement) | Indiquer la localisation g√©ographique du bien pour orientation SEO et description | **Saisie** : √âtape 1, champ "Emplacement" (ligne 189, `EnsembleFormulairesEtape1Form.tsx`) **Validation** : Obligatoire, non vide (ligne 261-264) **Formatage** : Capitalisation automatique | - Localisation SEO (mot-cl√© secondaire)- Utilis√© dans TOUS les prompts OpenAI | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 189, 361)- `TextFieldForm.tsx`- `openai.ts` : remplacement `[emplacement]` ‚Üí `location` | Aucun champ d√©pendant | **Hook actuel** :- `useState("")` (ligne 189)- `localStorage.setItem('propertyData')` **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ location })` | Aucun trigger n√©cessaire | `TEXT NOT NULL CHECK (length(location) > 0)` | - `"Paris 11√®me"`- `"Lyon Centre"`- `"Marseille Vieux Port"` | ‚ùå NULL‚ùå `""` (cha√Æne vide) |

---

## 1Ô∏è‚É£8Ô∏è‚É£ Champ : `propertyType`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `propertyType` | Type de bien immobilier | Identifier le type de bien commercial (restaurant, commerce, local, bureau, etc.) pour SEO et description | **Saisie** : √âtape 1, champ "Type de bien" (ligne 190, `EnsembleFormulairesEtape1Form.tsx`) **Validation** : Obligatoire, non vide (ligne 266-269) **Formatage** : Capitalisation automatique | - Mot-cl√© principal SEO- Utilis√© dans TOUS les prompts OpenAI | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 190, 362)- `TextFieldForm.tsx`- `openai.ts` : remplacement `[type de bien]` ‚Üí `propertyType` | Aucun champ d√©pendant | **Hook actuel** :- `useState("")` (ligne 190)- `localStorage.setItem('propertyData')` **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ propertyType })` | Aucun trigger n√©cessaire | `TEXT NOT NULL CHECK (length(propertyType) > 0)` | - `"Restaurant"`- `"Commerce"`- `"Local Commercial"`- `"Bureau"` | ‚ùå NULL‚ùå `""` (cha√Æne vide) |

---

## 1Ô∏è‚É£9Ô∏è‚É£ Champ : `saleType`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `saleType` | Type de transaction (√† vendre / √† louer) | D√©terminer si le bien est √† vendre ou √† louer pour conditionner l'affichage des champs Prix ou Loyer | **Saisie** : √âtape 1, boutons radio "Type de transaction" (ligne 191, `EnsembleFormulairesEtape1Form.tsx`) **Valeur par d√©faut** : `"√† vendre"` (ligne 191) **R√¥le conditionnel** : Conditionne l'affichage de `price` (si vente) ou `rentAmount`/`rentPeriodicity` (si location) | - D√©termine la logique d'affichage des champs mon√©taires- Utilis√© dans TOUS les prompts OpenAI | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 191, 293)- `SelectionButtonRond.tsx` (options ligne 43-46)- `openai.ts` : logique conditionnelle prix/loyer | - `price` (requis uniquement si `saleType === '√† vendre'`)- `rentAmount` (requis uniquement si `saleType === '√† louer'`)- `rentPeriodicity` (affich√© uniquement si `saleType === '√† louer'`) | **Hook actuel** :- `useState("√† vendre")` (ligne 191)- `localStorage.setItem('propertyData')` **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ saleType })` | Aucun trigger n√©cessaire | `TEXT NOT NULL DEFAULT '√† vendre' CHECK (saleType IN ('√† vendre', '√† louer'))` | - `'√† vendre'` (d√©faut)- `'√† louer'` | ‚ùå NULL‚ùå `'vente'` (valeur hors liste)‚ùå `'location'` (valeur hors liste) |

---

## 2Ô∏è‚É£0Ô∏è‚É£ Champ : `price`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `price` | Prix FAI (Frais d'Agence Inclus) en euros | Indiquer le prix de vente du bien (obligatoire si vente) | **Saisie** : √âtape 1, champ "Prix FAI" (ligne 192, `EnsembleFormulairesEtape1Form.tsx`) **Formatage** : Formatage automatique avec espaces s√©parateurs milliers + symbole `‚Ç¨` (ligne 384-405, `MonetaryFieldForm.tsx`) **Validation** : Obligatoire uniquement si `saleType === '√† vendre'` (ligne 271-278) | - Prix de vente affich√© dans les annonces- Utilis√© dans TOUS les prompts OpenAI si `saleType === '√† vendre'` | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 192)- `MonetaryFieldForm.tsx` (formatage ligne 384-405)- `openai.ts` : remplacement `[prix FAI]` ‚Üí `price` (format texte direct : `"450 000‚Ç¨"`) | - `saleType` (d√©termine si `price` est requis ou NULL)- `rentAmount` (exclusif : si `price` rempli alors `rentAmount` NULL) | **Hook actuel** :- `useState("")` (ligne 192)- `localStorage.setItem('propertyData')` (format: `"450 000‚Ç¨"`) **Migration requise** :- R√©cup√©ration directe de `propertyData.price` (format texte : `"450 000‚Ç¨"`)- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ price: propertyData.price })` | Aucun trigger n√©cessaire | `TEXT NULL CHECK ((saleType = '√† vendre' AND price IS NOT NULL AND length(trim(price)) > 0) OR (saleType = '√† louer' AND price IS NULL))` | - `"450 000‚Ç¨"`- `"1 200 000‚Ç¨"`- `NULL` (si location) | ‚ùå `price` rempli si `saleType = '√† louer'`‚ùå `price` NULL ou vide si `saleType = '√† vendre'` |




---

## 2Ô∏è‚É£1Ô∏è‚É£ Champ : `rentAmount`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `rentAmount` | Montant du loyer HT/HC en euros | Indiquer le montant du loyer (obligatoire si location) | **Saisie** : √âtape 1, champ "Loyer HT/HC" (ligne 193, `EnsembleFormulairesEtape1Form.tsx`) **Formatage** : Formatage automatique avec espaces + symbole `‚Ç¨` (ligne 384-405, `MonetaryFieldForm.tsx`) **Validation** : Obligatoire uniquement si `saleType === '√† louer'` (ligne 280-285) | - Montant du loyer affich√© dans les annonces- Utilis√© dans TOUS les prompts OpenAI si `saleType === '√† louer'` | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 193)- `MonetaryFieldForm.tsx` (formatage ligne 384-405)- `openai.ts` : remplacement `[loyer]` ‚Üí `rentAmount` (format texte direct : `"1 200‚Ç¨"`) | - `saleType` (d√©termine si `rentAmount` est requis ou NULL)- `price` (exclusif : si `rentAmount` rempli alors `price` NULL)- `rentPeriodicity` (affich√© uniquement si `rentAmount` rempli) | **Hook actuel** :- `useState("")` (ligne 193)- `localStorage.setItem('propertyData')` (format: `"1 200‚Ç¨"`) **Migration requise** :- R√©cup√©ration directe de `propertyData.rentAmount` (format texte : `"1 200‚Ç¨"`)- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ rentAmount: propertyData.rentAmount })` | Aucun trigger n√©cessaire | `TEXT NULL CHECK ((saleType = '√† louer' AND rentAmount IS NOT NULL AND length(trim(rentAmount)) > 0) OR (saleType = '√† vendre' AND rentAmount IS NULL))` | - `"1 200‚Ç¨"`- `"3 500‚Ç¨"`- `NULL` (si vente) | ‚ùå `rentAmount` rempli si `saleType = '√† vendre'`‚ùå `rentAmount` NULL ou vide si `saleType = '√† louer'` |




---

## 2Ô∏è‚É£2Ô∏è‚É£ Champ : `rentPeriodicity`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `rentPeriodicity` | P√©riodicit√© du loyer (Mensuel / Trimestriel / Annuel) | Pr√©ciser la p√©riodicit√© du loyer (obligatoire si location) | **Saisie** : √âtape 1, boutons radio "P√©riodicit√© du loyer" (ligne 194, `EnsembleFormulairesEtape1Form.tsx`) **Valeur par d√©faut** : `"Mensuel"` (ligne 194) **Affichage conditionnel** : Affich√© uniquement si `saleType === '√† louer'` (ligne 443) | - P√©riodicit√© du loyer affich√©e dans les annonces- Utilis√© dans les prompts OpenAI si `saleType === '√† louer'` | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 194)- `SelectionButtonRond.tsx` (options ligne 49-53)- `openai.ts` : remplacement `[p√©riodicit√©]` ‚Üí `rentPeriodicity` | - `saleType` (d√©termine si `rentPeriodicity` est affich√© ou NULL)- `rentAmount` (affich√© conjointement) | **Hook actuel** :- `useState("Mensuel")` (ligne 194)- `localStorage.setItem('propertyData')` **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ rentPeriodicity })` | Aucun trigger n√©cessaire | `TEXT NULL DEFAULT NULL CHECK ((saleType = '√† louer' AND rentPeriodicity IS NOT NULL) OR (saleType = '√† vendre' AND rentPeriodicity IS NULL)) CHECK (rentPeriodicity IN ('Mensuel', 'Trimestriel', 'Annuel'))` | - `'Mensuel'` (d√©faut)- `'Trimestriel'`- `'Annuel'`- `NULL` (si vente) | ‚ùå `rentPeriodicity` rempli si `saleType = '√† vendre'`‚ùå `rentPeriodicity` NULL si `saleType = '√† louer'`‚ùå `'mensuel'` (casse incorrecte) |

---

## 2Ô∏è‚É£3Ô∏è‚É£ Champ : `keyElements`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `keyElements` | Arguments commerciaux (points forts du bien) | Lister les points forts du bien pour alimenter les annonces IA (emplacement, conditions, raret√©, etc.) | **Saisie** : √âtape 1, textarea "Arguments commerciaux" (ligne 195, `EnsembleFormulairesEtape1Form.tsx`) **Formatage** : Puces automatiques `‚Ä¢` + capitalisation apr√®s puce + auto-expand (ligne 447-533, `FormulaireSaisie.tsx`) **Validation** : Obligatoire, non vide (ligne 287-290) | - Arguments commerciaux pour titres, accroches, CTA dans les annonces IA- Utilis√© dans TOUS les prompts OpenAI | **Fichiers** :- `EnsembleFormulairesEtape1Form.tsx` (ligne 195)- `FormulaireSaisie.tsx` (formatage ligne 447-533)- `openai.ts` : remplacement `[arguments commerciaux]` ‚Üí `keyElements` | Aucun champ d√©pendant | **Hook actuel** :- `useState("")` (ligne 195)- `localStorage.setItem('propertyData')` (format: texte avec puces `‚Ä¢`) **Migration requise** :- `useFormEtape1()` avec `supabase.from('etapes_1to5').upsert({ keyElements })` | Aucun trigger n√©cessaire | `TEXT NOT NULL CHECK (length(keyElements) > 0)` | - `"‚Ä¢ Emplacement strat√©gique\n‚Ä¢ Terrasse 50 places\n‚Ä¢ Cuisine √©quip√©e"` | ‚ùå NULL‚ùå `""` (cha√Æne vide)‚ùå Cha√Æne uniquement compos√©e d'espaces |

---

## 2Ô∏è‚É£4Ô∏è‚É£ Champ : `propertyDescription`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `propertyDescription` | Description d√©taill√©e du bien | D√©crire le bien de mani√®re exhaustive (emplacement, superficie, activit√©, client√®le, √©quipements, etc.) | **Saisie** : √âtape 2, textarea "Description d√©taill√©e" (ligne 175, `SaisieDescriptionForm.tsx`, voir `02.Etape2.md`) **Formatage** : Puces automatiques `‚Ä¢` + capitalisation + auto-expand **Validation** : Obligatoire, non vide (ligne 206-216, `SaisieDescriptionForm.tsx`) | - Description compl√®te pour alimenter les 4 prompts OpenAI (Site Internet, Fiche de Synth√®se, Newsletter, Outils SEO)- Utilis√© dans TOUS les prompts OpenAI | **Fichiers** :- `SaisieDescriptionForm.tsx` (ligne 175)- `FormulaireSaisie.tsx` (formatage)- `openai.ts` : remplacement `[description du bien]` ‚Üí `propertyDescription` | Aucun champ d√©pendant | **Hook actuel** :- `useState("")` (ligne 175, `SaisieDescriptionForm.tsx`)- `localStorage.setItem('propertyData')` (ligne 219) **Migration requise** :- `useFormEtape2()` avec `supabase.from('etapes_1to5').upsert({ propertyDescription })` | Aucun trigger n√©cessaire | `TEXT NOT NULL CHECK (length(propertyDescription) > 0)` | - `"‚Ä¢ Restaurant situ√© dans un quartier vivant\n‚Ä¢ Surface totale de 120 m¬≤\n‚Ä¢ Terrasse ext√©rieure de 50 places"` | ‚ùå NULL‚ùå `""` (cha√Æne vide) |

---

## 2Ô∏è‚É£5Ô∏è‚É£ Champ : `financials`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `financials` | Informations financi√®res du bien | Lister les informations financi√®res (conditions locatives, performances, potentiel) | **Saisie** : √âtape 3, textarea "Informations financi√®res" (ligne 172, `SaisieFinancialForm.tsx`, voir `03.Etape3.md`) **Formatage** : Puces automatiques `‚Ä¢` + capitalisation + auto-expand **Validation** : Obligatoire, non vide (ligne 175-183) | - Informations financi√®res pour les annonces IA- Utilis√© dans TOUS les prompts OpenAI | **Fichiers** :- `SaisieFinancialForm.tsx` (ligne 172)- `FormulaireSaisie.tsx` (formatage)- `openai.ts` : remplacement `[d√©tails financiers du bien]` ‚Üí `financials` | Aucun champ d√©pendant | **Hook actuel** :- `useState("")` (ligne 172)- `localStorage.setItem('propertyData')` (ligne 179) **Migration requise** :- `useFormEtape3()` avec `supabase.from('etapes_1to5').upsert({ financials })` | Aucun trigger n√©cessaire | `TEXT NOT NULL CHECK (length(financials) > 0)` | - `"‚Ä¢ Loyer mensuel : 3500‚Ç¨ HT/HC\n‚Ä¢ Bail 3-6-9 renouvelable\n‚Ä¢ CA annuel : 450 000‚Ç¨\n‚Ä¢ EBE : 120 000‚Ç¨"` | ‚ùå NULL‚ùå `""` (cha√Æne vide) |

---

## 2Ô∏è‚É£6Ô∏è‚É£ Champ : `details`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `details` | Informations compl√©mentaires optionnelles | Lister des informations compl√©mentaires (horaires, fermeture, conditions exploitation) | **Saisie** : √âtape 4, textarea "Autres D√©tails" (ligne 152, `SaisieDetailsForm.tsx`, voir `04.Etape4.md`) **Formatage** : Puces automatiques `‚Ä¢` + capitalisation + auto-expand **Validation** : Optionnel MAIS choix obligatoire (soit rempli, soit checkbox `hasNoDetails` coch√©e) (ligne 181-189) | - Informations compl√©mentaires **UNIQUEMENT pour la Fiche de Synth√®se** (pas dans les autres annonces)- Utilis√© dans 1 seul prompt OpenAI : `generateSummarySheetAd()` | **Fichiers** :- `SaisieDetailsForm.tsx` (ligne 152)- `FormulaireSaisie.tsx` (formatage)- `openai.ts` : remplacement `[informations compl√©mentaires]` ‚Üí `details` (ligne 393, voir `03.Etape3.md`) **Prompt OpenAI** :Utilis√© **UNIQUEMENT** dans `generateSummarySheetAd()` (Fiche de Synth√®se) | - `hasNoDetails` (exclusif : si `details` rempli alors `hasNoDetails = false`, si `hasNoDetails = true` alors `details` vide/NULL) | **Hook actuel** :- `useState("")` (ligne 152)- `localStorage.setItem('propertyData')` (ligne 189) **Migration requise** :- `useFormEtape4()` avec `supabase.from('etapes_1to5').upsert({ details, hasNoDetails })` | Aucun trigger n√©cessaire | `TEXT NULL CHECK ((hasNoDetails = false AND length(details) > 0) OR (hasNoDetails = true AND (details IS NULL OR details = '')))` | - `"‚Ä¢ Ouvert du lundi au samedi\n‚Ä¢ Fermeture annuelle en ao√ªt"` (si `hasNoDetails = false`)- `NULL` ou `""` (si `hasNoDetails = true`) | ‚ùå `details` rempli ET `hasNoDetails = true`‚ùå `details` vide ET `hasNoDetails = false` |

---

## 2Ô∏è‚É£7Ô∏è‚É£ Champ : `hasNoDetails`

| **Champ** | **Titre** | **Objectifs** | **Fonctionnement** | **R√¥le** | **Utilisation** | **Utilis√©e par (champs)** | **Hook localStorage devant √™tre remplac√©** | **Trigger SQL** | **Type SQL & Contraintes** | **Valeurs possibles** | **Interdictions (CHECK)** |
|-----------|-----------|---------------|-------------------|----------|-----------------|---------------------------|---------------------------------------------|----------------|----------------------------|----------------------|---------------------------|
| `hasNoDetails` | Indicateur bool√©en : l'utilisateur a coch√© "Je n'ai pas d'informations compl√©mentaires" | Indiquer que l'utilisateur n'a pas d'informations compl√©mentaires √† fournir | **Saisie** : √âtape 4, checkbox "Je n'ai pas d'informations compl√©mentaires √† fournir" (ligne 153, `SaisieDetailsForm.tsx`) **Valeur par d√©faut** : `false` (ligne 153) **Comportement** : Si coch√© ‚Üí `hasNoDetails = true` + `details` vid√© + textarea en `readOnly` (ligne 169-175) | - Choix obligatoire √† l'√©tape 4 (soit saisir `details`, soit cocher `hasNoDetails`)- Emp√™che la textarea d'√™tre modifiable si coch√©e | **Fichiers** :- `SaisieDetailsForm.tsx` (ligne 153, 169-175)- `openai.ts` : logique conditionnelle pour ignorer `details` si `hasNoDetails = true` | - `details` (exclusif : si `hasNoDetails = true` alors `details` vide/NULL) | **Hook actuel** :- `useState(false)` (ligne 153)- `localStorage.setItem('propertyData')` (ligne 189) **Migration requise** :- `useFormEtape4()` avec `supabase.from('etapes_1to5').upsert({ details, hasNoDetails })` | Aucun trigger n√©cessaire | `BOOLEAN NOT NULL DEFAULT false CHECK ((hasNoDetails = false AND length(details) > 0) OR (hasNoDetails = true AND (details IS NULL OR details = '')))` | - `false` (utilisateur a saisi des d√©tails)- `true` (utilisateur n'a pas de d√©tails) | ‚ùå NULL‚ùå `hasNoDetails = true` ET `details` rempli‚ùå `hasNoDetails = false` ET `details` vide |

---

---

# üéØ SYNTH√àSE GLOBALE

## Champs Syst√®me (13)
- **Identifiants techniques** : `project_id`, `organisation_id`, `user_id`
- **Hi√©rarchie multi-tenant** : `utilisateur_type_compte`, `reseau_id`, `reseau_agence_id`, `agence_indep_id`
- **Progression** : `step_progress`, `statut`, `validated_at`
- **Audit** : `logs`, `created_at`, `updated_at`

## Champs M√©tier (14)
- **√âtape 1 (10 champs)** : `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`
- **√âtape 2 (1 champ)** : `propertyDescription`
- **√âtape 3 (1 champ)** : `financials`
- **√âtape 4 (2 champs)** : `details`, `hasNoDetails`

## Points Critiques Identifi√©s
1. **Contraintes conditionnelles** : `price`/`rentAmount`/`rentPeriodicity` d√©pendent de `saleType`, `details` d√©pend de `hasNoDetails`
2. **Triggers SQL n√©cessaires** : 
   - `set_updated_at_etapes1to5` (auto-update `updated_at`)
   - `set_statut_archive_on_validation` (transition statut)
   - `set_validated_at_on_generation` (optionnel)
4. **Fonctions SQL √† cr√©er** :
   - `get_user_type_compte(user_uuid UUID)`
   - `get_user_reseau_agence_id(user_uuid UUID)`
5. **RLS Policies complexes** : Visibilit√© hi√©rarchique selon `utilisateur_type_compte` (voir `01.1.GestionStrategieMultiTenant.md`)

---

---

# üìä TABLEAU COMPARATIF : STOCKAGE ACTUEL vs PR√âVU
## Analyse des 27 champs de la table `etapes_1to5`

---

## üéØ OBJECTIF

Comparer **comment chaque champ est stock√© actuellement** (localStorage) vs **comment il sera stock√© dans Supabase** (table `etapes_1to5`).

---

## üìã STRUCTURE DU TABLEAU

| **Champ** | **Stockage localStorage (actuel)** | **Stockage pr√©vu table etapes_1to5** |

---

# SECTION 1 : CHAMPS SYST√àME (13 champs)

| **Champ** | **Stockage localStorage (actuel)** | **Stockage pr√©vu table etapes_1to5** |
|-----------|-----------------------------------|--------------------------------------|
| `project_id` | ‚ùå **N'existe pas** (localStorage n'a pas d'identifiant unique persistant pour un projet) | ‚úÖ `uuid NOT NULL DEFAULT gen_random_uuid()` **PRIMARY KEY** Auto-g√©n√©r√© par Supabase lors de l'INSERT |
| `organisation_id` | ‚ùå **N'existe pas** (localStorage est local au navigateur, pas de notion d'organisation) | ‚úÖ `uuid NOT NULL` **FK ‚Üí organisations(organisation_id)** Auto-inject√© via `get_user_organisation_id(auth.uid())` lors de l'INSERT |
| `user_id` | ‚ùå **N'existe pas** (localStorage est anonyme, pas de tra√ßabilit√© utilisateur) | ‚úÖ `uuid NOT NULL` **FK ‚Üí users(users_id)** Auto-inject√© via r√©solution `auth.uid() ‚Üí users.users_id` lors de l'INSERT |
| `utilisateur_type_compte` | ‚ùå **N'existe pas** (pas de hi√©rarchie multi-tenant dans localStorage) | ‚úÖ `text NOT NULL` **CHECK constraint sur 8 valeurs** Auto-inject√© via `get_user_type_compte(auth.uid())` lors de l'INSERT |
| `reseau_id` | ‚ùå **N'existe pas** (pas de tra√ßabilit√© r√©seau) | ‚úÖ `uuid NULL` **FK ‚Üí reseau(reseau_id)** Renseign√© automatiquement si type r√©seau, sinon NULL |
| `reseau_agence_id` | ‚ùå **N'existe pas** (pas de tra√ßabilit√© agence r√©seau) | ‚úÖ `uuid NULL` **FK ‚Üí reseau_agence(reseau_agence_id)** Renseign√© automatiquement si type agence r√©seau, sinon NULL |
| `agence_indep_id` | ‚ùå **N'existe pas** (pas de tra√ßabilit√© agence ind√©pendante) | ‚úÖ `uuid NULL` **FK ‚Üí agence_independante(agence_indep_id)** Renseign√© automatiquement si type agence ind√©pendante, sinon NULL |
| `step_progress` | ‚úÖ **`localStorage.getItem('stepProgress')`** Format : `"[1, 2, 3]"` (JSON stringifi√©) Type : `Array` Exemple : `[1, 2, 3, 4, 5]` (√©tapes d√©verrouill√©es) | ‚úÖ `integer[] NOT NULL DEFAULT '{1}'::integer[]` **CHECK constraints** : doit contenir 1, longueur >= 1, valeurs entre 1 et 5 Migration : Parser JSON ‚Üí Array PostgreSQL |
| `statut` | ‚ùå **N'existe pas** (pas de notion de statut projet) | ‚úÖ `text NOT NULL DEFAULT 'en_cours'` **CHECK (statut IN ('en_cours', 'archive'))** Transition automatique via trigger `statut_du_projet` quand `validated_at IS NOT NULL` ET `5 IN step_progress` |
| `validated_at` | ‚ùå **N'existe pas** (pas de tra√ßabilit√© validation) | ‚úÖ `timestamptz NULL DEFAULT NULL` Auto-renseign√© via trigger `set_validated_at` lors de la validation √©tape 5 |
| `logs` | ‚ùå **N'existe pas** (pas de logs de modifications) | ‚úÖ `jsonb NULL DEFAULT '{}'::jsonb` Aliment√© automatiquement pour tracer les modifications (optionnel) |
| `created_at` | ‚ùå **N'existe pas** (pas de tra√ßabilit√© cr√©ation) | ‚úÖ `timestamptz NOT NULL DEFAULT now()` Auto-g√©n√©r√© par Supabase lors de l'INSERT |
| `updated_at` | ‚ùå **N'existe pas** (pas de tra√ßabilit√© modification) | ‚úÖ `timestamptz NOT NULL` **Trigger `set_updated_at_etapes1to5`** Auto-mis √† jour √† chaque UPDATE |

---

# SECTION 2 : CHAMPS M√âTIER PropertyData (14 champs)

| **Champ** | **Stockage localStorage (actuel)** | **Stockage pr√©vu table etapes_1to5** |
|-----------|-----------------------------------|--------------------------------------|
| `agencyName` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.agencyName` Type : `string` Exemple : `"Cabinet Presenca"` Source : `EnsembleFormulairesEtape1Form.tsx` ligne 186 | ‚úÖ **`TEXT NOT NULL`** Migration : R√©cup√©ration directe depuis `propertyData.agencyName` (aucun parsing n√©cessaire) |
| `reference` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.reference` Type : `string` Exemple : `"REF-2025-001"` Source : `EnsembleFormulairesEtape1Form.tsx` ligne 187 | ‚úÖ **`TEXT NOT NULL`** Migration : R√©cup√©ration directe depuis `propertyData.reference` |
| `exclusivite` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.exclusivite` Type : `string` Valeurs : `"Oui"` ou `"Non"` D√©faut : `"Non"` Source : `EnsembleFormulairesEtape1Form.tsx` ligne 188 | ‚úÖ **`TEXT NOT NULL CHECK (exclusivite IN ('Oui', 'Non'))`** Migration : R√©cup√©ration directe |
| `location` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.location` Type : `string` Exemple : `"Paris 16√®me"` Source : `EnsembleFormulairesEtape1Form.tsx` ligne 189 | ‚úÖ **`TEXT NOT NULL`** Migration : R√©cup√©ration directe |
| `propertyType` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.propertyType` Type : `string` Exemple : `"Restaurant"` Source : `EnsembleFormulairesEtape1Form.tsx` ligne 190 | ‚úÖ **`TEXT NOT NULL`** Migration : R√©cup√©ration directe |
| `saleType` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.saleType` Type : `string` Valeurs : `"√† vendre"` ou `"√† louer"` D√©faut : `"√† vendre"` Source : `EnsembleFormulairesEtape1Form.tsx` ligne 191 | ‚úÖ **`TEXT NOT NULL CHECK (saleType IN ('√† vendre', '√† louer'))`** Migration : R√©cup√©ration directe |
| `price` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.price` **Type : `string` (TEXTE format√©)** Format : `"450 000‚Ç¨"` (espaces + symbole ‚Ç¨) Source : `MonetaryFieldForm.tsx` ligne 400 (formatage automatique) OpenAI re√ßoit : `"450 000‚Ç¨"` (texte brut) | Type : TEXT NULL<br>Contrainte : CHECK ((saleType = '√† vendre' AND price IS NOT NULL AND length(trim(price)) > 0) OR (saleType = '√† louer' AND price IS NULL))<br>Format stock√© : "450 000‚Ç¨" (texte format√© avec espaces et symbole ‚Ç¨) (texte format√© identique √† localStorage)<br>Migration : R√©cup√©ration directe depuis propertyData.price sans transformation ni parsing interdit |
| `rentAmount` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.rentAmount` **Type : `string` (TEXTE format√©)** Format : `"1 200‚Ç¨"` Source : `MonetaryFieldForm.tsx` OpenAI re√ßoit : `"1 200‚Ç¨"` (texte brut) | Type : TEXT NULL <br> Contrainte : CHECK ((saleType = '√† louer' AND rentAmount IS NOT NULL AND length(trim(rentAmount)) > 0) OR (saleType = '√† vendre' AND rentAmount IS NULL)) <br> Format stock√© : "1 200‚Ç¨" (texte format√© avec espaces et symbole ‚Ç¨)(texte format√© identique √† localStorage) <br> Migration : R√©cup√©ration directe propertyData.rentAmount sans parsing ni transformation interdit |
| `rentPeriodicity` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.rentPeriodicity` Type : `string` Valeurs : `"Mensuel"`, `"Trimestriel"`, `"Annuel"` D√©faut : `"Mensuel"` Source : `EnsembleFormulairesEtape1Form.tsx` ligne 194 | ‚úÖ **`TEXT NULL CHECK (rentPeriodicity IN ('Mensuel', 'Trimestriel', 'Annuel'))`** Migration : R√©cup√©ration directe |
| `keyElements` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.keyElements` **Type : `string` (TEXTE format√© avec puces)** Format : `"‚Ä¢ Terrasse 50 places\n‚Ä¢ Cuisine √©quip√©e"` Source : `FormulaireSaisie.tsx` (formatage automatique `‚Ä¢ ` + capitalisation) OpenAI re√ßoit : Texte avec puces | ‚úÖ **`TEXT NOT NULL`** Migration : R√©cup√©ration directe (conserver le formatage avec puces) |
| `propertyDescription` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.propertyDescription` **Type : `string` (TEXTE format√© avec puces)** Format : `"‚Ä¢ Restaurant situ√©...\n‚Ä¢ Surface totale 120m¬≤"` Source : `SaisieDescriptionForm.tsx` + `FormulaireSaisie.tsx` OpenAI re√ßoit : Texte avec puces | ‚úÖ **`TEXT NOT NULL`** Migration : R√©cup√©ration directe (conserver le formatage avec puces) |
| `financials` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.financials` **Type : `string` (TEXTE format√© avec puces)** Format : `"‚Ä¢ Loyer mensuel : 3500‚Ç¨\n‚Ä¢ Bail 3-6-9"` Source : `SaisieFinancialForm.tsx` + `FormulaireSaisie.tsx` OpenAI re√ßoit : Texte avec puces | ‚úÖ **`TEXT NOT NULL`** Migration : R√©cup√©ration directe (conserver le formatage avec puces) |
| `details` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.details` **Type : `string` (TEXTE format√© avec puces)** Format : `"‚Ä¢ Ouvert du mardi au dimanche\n‚Ä¢ Fermeture ao√ªt"` Source : `SaisieDetailsForm.tsx` + `FormulaireSaisie.tsx` Conditionnel : Vide si `hasNoDetails === true` OpenAI re√ßoit : Texte avec puces (uniquement dans Fiche de Synth√®se) | ‚úÖ **`TEXT NULL`** **CHECK conditionnel** : Si `hasNoDetails = false` ‚Üí `length(details) > 0` Si `hasNoDetails = true` ‚Üí `details IS NULL OR details = ''` Migration : R√©cup√©ration directe |
| `hasNoDetails` | ‚úÖ **`localStorage.getItem('propertyData')`** Cl√© JSON : `propertyData.hasNoDetails` Type : `boolean` Valeurs : `true` (checkbox coch√©e) ou `false` D√©faut : `false` Source : `SaisieDetailsForm.tsx` lignes 7, 38-41 | ‚úÖ **`BOOLEAN NOT NULL DEFAULT false`** **CHECK mutual exclusivity avec `details`** Migration : R√©cup√©ration directe du bool√©en |

---



---

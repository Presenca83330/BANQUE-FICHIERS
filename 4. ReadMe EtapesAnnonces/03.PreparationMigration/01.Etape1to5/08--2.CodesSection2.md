# CODES SECTION 2 

---

# N1 : Utilitaire : validateEtape1.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape1.ts

 ```typescript
export interface Etape1Input {
  agencyName?: string | null;
  reference?: string | null;
  exclusivite?: string | null;
  location?: string | null;
  propertyType?: string | null;
  saleType?: string | null; // "à vendre" | "à louer"
  price?: string | null;
  rentAmount?: string | null;
  rentPeriodicity?: string | null;
  keyElements?: string | null;
}

export interface ValidationResult {
  ok: boolean;
  message?: string;
}

function isNonEmpty(v?: string | null): boolean {
  return typeof v === "string" && v.trim().length > 0;
}

export function validateEtape1(input: Etape1Input): ValidationResult {
  const missing: string[] = [];

  if (!isNonEmpty(input.agencyName)) missing.push("agencyName");
  if (!isNonEmpty(input.reference)) missing.push("reference");
  if (!isNonEmpty(input.location)) missing.push("location");
  if (!isNonEmpty(input.propertyType)) missing.push("propertyType");
  if (!isNonEmpty(input.keyElements)) missing.push("keyElements");

  if (!isNonEmpty(input.saleType)) {
    missing.push("saleType");
  } else {
    const st = String(input.saleType).trim().toLowerCase();
    if (st !== "à vendre" && st !== "à louer") {
      return {
        ok: false,
        message:
          "Valeur invalide pour saleType (attendu : 'à vendre' ou 'à louer').",
      };
    }
    if (st === "à vendre" && !isNonEmpty(input.price)) {
      missing.push("price");
    }
    if (st === "à louer" && !isNonEmpty(input.rentAmount)) {
      missing.push("rentAmount");
    }
  }

  if (missing.length > 0) {
    return { ok: false, message: `Champs manquants : ${missing.join(", ")}.` };
  }

  return { ok: true };
}
```

---

# N2 : Utilitaire : validateEtape2.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape2.ts

 ```typescript
export interface Etape2Input {
  propertyDescription?: string | null;
  minLength?: number;
}

export interface ValidationResult {
  ok: boolean;
  message?: string;
}

export function validateEtape2(input: Etape2Input): ValidationResult {
  const min = typeof input.minLength === "number" ? input.minLength : 30;
  const desc = (input.propertyDescription || "").trim();

  if (desc.length < min) {
    return {
      ok: false,
      message: `La description du bien est trop courte (minimum ${min} caractères).`,
    };
  }

  return { ok: true };
}
```

---

# N3 : Utilitaire : validateEtape3.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape3.ts

 ```typescript
export interface Etape3Input {
  financials?: string | null;
}

export interface ValidationResult {
  ok: boolean;
  message?: string;
}

export function validateEtape3(input: Etape3Input): ValidationResult {
  const text = (input.financials || "").trim();

  if (text.length < 10) {
    return {
      ok: false,
      message:
        "Les informations financières sont insuffisantes (minimum 10 caractères).",
    };
  }

  return { ok: true };
}
```

---

# N4 : Utilitaire : validateEtape4.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/validateEtape4.ts

 ```typescript
export interface Etape4Input {
  details?: string | null;
  hasNoDetails?: boolean | null;
  minLength?: number;
}

export interface ValidationResult {
  ok: boolean;
  message?: string;
}

export function validateEtape4(input: Etape4Input): ValidationResult {
  const min = typeof input.minLength === "number" ? input.minLength : 15;

  if (input?.hasNoDetails) {
    return { ok: true };
  }

  const text = (input.details || "").trim();
  if (text.length < min) {
    return {
      ok: false,
      message: `Les détails sont insuffisants (minimum ${min} caractères) ou cochez "Aucun détail".`,
    };
  }

  return { ok: true };
}
```

---

# N5 : Utilitaire : mapSupabaseToPrompt.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/mapSupabaseToPrompt.ts

 ```typescript
import { sanitizeText } from "./sanitizeText";

export interface Etapes1to5Row {
  project_id: string;
  organisation_id?: string | null;
  user_id?: string | null;
  utilisateur_type_compte?: string | null;

  agencyName?: string | null;
  reference?: string | null;
  exclusivite?: string | null;
  location?: string | null;
  propertyType?: string | null;
  saleType?: string | null;
  price?: string | null;
  rentAmount?: string | null;
  rentPeriodicity?: string | null;
  keyElements?: string | null;
  propertyDescription?: string | null;
  financials?: string | null;
  details?: string | null;

  created_at?: string | null;
  updated_at?: string | null;
  [key: string]: unknown;
}

export function mapSupabaseToPrompt(row: Etapes1to5Row) {
  return {
    agencyName: sanitizeText(row.agencyName ?? ""),
    reference: sanitizeText(row.reference ?? ""),
    exclusivite: sanitizeText(row.exclusivite ?? ""),
    location: sanitizeText(row.location ?? ""),
    propertyType: sanitizeText(row.propertyType ?? ""),
    saleType: sanitizeText(row.saleType ?? ""),
    price: sanitizeText(row.price ?? ""),
    rentAmount: sanitizeText(row.rentAmount ?? ""),
    rentPeriodicity: sanitizeText(row.rentPeriodicity ?? ""),
    keyElements: sanitizeText(row.keyElements ?? ""),
    propertyDescription: sanitizeText(row.propertyDescription ?? ""),
    financials: sanitizeText(row.financials ?? ""),
    details: sanitizeText(row.details ?? ""),
    project_id: row.project_id,
  };
}
```

---

# N6 : Utilitaire : mapPromptOutput.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/mapPromptOutput.ts

 ```typescript
export interface MapPromptOutputResult<T = unknown> {
  ok: boolean;
  data?: T;
  message?: string;
}

export function mapPromptOutput<T = unknown>(
  raw: string
): MapPromptOutputResult<T> {
  if (typeof raw !== "string" || raw.trim().length === 0) {
    return { ok: false, message: "Réponse vide ou invalide." };
  }

  let s = raw.trim();

  if (s.startsWith("```")) {
    const firstFence = s.indexOf("\n");
    const lastFence = s.lastIndexOf("```");
    if (firstFence !== -1 && lastFence > firstFence) {
      s = s.substring(firstFence + 1, lastFence).trim();
    }
  }

  const start = s.indexOf("{");
  const end = s.lastIndexOf("}");
  if (start === -1 || end === -1 || end <= start) {
    return { ok: false, message: "Aucun objet JSON détecté dans la réponse." };
  }

  const jsonSlice = s.substring(start, end + 1);

  try {
    const parsed = JSON.parse(jsonSlice) as T;
    return { ok: true, data: parsed };
  } catch {
    return { ok: false, message: "JSON invalide renvoyé par le modèle." };
  }
}
```

---

# N7 : Utilitaire : formatCurrency.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/formatCurrency.ts

 ```typescript
export function formatCurrency(value: string | number | null | undefined): string {
  if (value === null || value === undefined) return "";

  if (typeof value === "string" && value.includes("€")) {
    return value.replace(/\s+/g, " ").trim();
  }

  const num = typeof value === "number"
    ? value
    : Number(String(value).replace(/[^\d.,-]/g, "").replace(",", "."));
  if (!isFinite(num)) return String(value).trim();

  try {
    return new Intl.NumberFormat("fr-FR", {
      style: "currency",
      currency: "EUR",
      maximumFractionDigits: 2,
    }).format(num);
  } catch {
    return String(value).trim();
  }
}
```

---

# N8 : Utilitaire : sanitizeText.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/sanitizeText.ts

 ```typescript
export function sanitizeText(input: string | null | undefined): string {
  if (input === null || input === undefined) return "";
  let s = String(input);

  s = s.replace(/\uFEFF/g, "");
  s = s.replace(/[\u200B-\u200D\u2060]/g, "");
  s = s.replace(/[\u00A0\u202F]/g, " ");
  s = s.replace(/\r\n?/g, " ");
  s = s.replace(/\s{2,}/g, " ");

  return s.trim();
}
```

---

# N9 : Utilitaire : formatAddress.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/formatAddress.ts

 ```typescript
import { sanitizeText } from "./sanitizeText";

export interface AddressParts {
  addressLine?: string | null;
  postalCode?: string | null;
  city?: string | null;
}

export function formatAddress(parts: AddressParts): string {
  const line = sanitizeText(parts.addressLine ?? "");
  const cp = sanitizeText(parts.postalCode ?? "");
  const city = sanitizeText(parts.city ?? "");

  const left = line ? line : "";
  const right = [cp, city].filter(Boolean).join(" ").trim();

  if (left && right) return `${left}, ${right}`;
  return left || right;
}
```

---

# N10 : Utilitaire : convertLocalToSupabase.ts
## src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/convertLocalToSupabase.ts

 ```typescript
import { sanitizeText } from "./sanitizeText";

export interface LocalProjectData {
  agencyName?: string | null;
  reference?: string | null;
  exclusivite?: string | null;
  location?: string | null;
  propertyType?: string | null;
  saleType?: string | null;
  price?: string | number | null;
  rentAmount?: string | number | null;
  rentPeriodicity?: string | null;
  keyElements?: string | null;
  propertyDescription?: string | null;
  financials?: string | null;
  details?: string | null;
}

export interface Etapes1to5Insert {
  agencyName?: string;
  reference?: string;
  exclusivite?: string;
  location?: string;
  propertyType?: string;
  saleType?: string;
  price?: string;
  rentAmount?: string;
  rentPeriodicity?: string;
  keyElements?: string;
  propertyDescription?: string;
  financials?: string;
  details?: string;
}

export function convertLocalToSupabase(local: LocalProjectData): Etapes1to5Insert {
  const toText = (v: unknown) =>
    v === null || v === undefined ? "" : String(v);

  return {
    agencyName: sanitizeText(local.agencyName ?? ""),
    reference: sanitizeText(local.reference ?? ""),
    exclusivite: sanitizeText(local.exclusivite ?? ""),
    location: sanitizeText(local.location ?? ""),
    propertyType: sanitizeText(local.propertyType ?? ""),
    saleType: sanitizeText(local.saleType ?? ""),
    price: sanitizeText(toText(local.price)),
    rentAmount: sanitizeText(toText(local.rentAmount)),
    rentPeriodicity: sanitizeText(local.rentPeriodicity ?? ""),
    keyElements: sanitizeText(local.keyElements ?? ""),
    propertyDescription: sanitizeText(local.propertyDescription ?? ""),
    financials: sanitizeText(local.financials ?? ""),
    details: sanitizeText(local.details ?? ""),
  };
}
```

---


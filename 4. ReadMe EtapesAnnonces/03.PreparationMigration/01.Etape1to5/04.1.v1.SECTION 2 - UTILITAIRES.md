# üì¶ SECTION 2 - UTILITAIRES (12 √©l√©ments)

## üìã SOMMAIRE SECTION 2

1. [Utilitaires Formatage (4 √©l√©ments)](#1-utilitaires-formatage-4-√©l√©ments)
2. [Utilitaires Validation (5 √©l√©ments)](#2-utilitaires-validation-5-√©l√©ments)
3. [Utilitaires Conversion/Mapping (3 √©l√©ments)](#3-utilitaires-conversionmapping-3-√©l√©ments)

---

## 1. UTILITAIRES FORMATAGE (4 √©l√©ments)

### üìå **√âl√©ment 1 : `formatEuros()`**

**Nom de fichier** : `formatEuros.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/01-utilitaires-formatage/formatEuros.ts`

**Description** :  
Formate une valeur num√©rique en cha√Æne de caract√®res avec s√©parateurs d'espaces et symbole `‚Ç¨`.

**Fonction expos√©e** :  
```typescript
export const formatEuros = (value?: string | number): string
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (fonction m√©tier) |
| **Param√®tres** | `value`: `string \| number \| undefined` |
| **Retour** | `string` (ex: `"450 000‚Ç¨"`) |
| **Gestion nullish** | Si `value` vide/null ‚Üí retourne `""` |
| **Gestion NaN** | Si valeur invalide ‚Üí retourne `""` |
| **Nettoyage input** | Supprime tous caract√®res non num√©riques sauf `.` et `,` |
| **Conversion** | Remplace `,` par `.` avant parsing |
| **Formatage** | Ajoute espaces tous les 3 chiffres : `450000` ‚Üí `"450 000"` |
| **Symbole** | Ajoute `‚Ç¨` √† la fin |

**Cas d'usage** :
- Affichage `price` dans formulaires (√âtape 1)
- Affichage `rentAmount` dans formulaires (√âtape 1)
- G√©n√©ration prompts OpenAI (formats lisibles)

---

### üìå **√âl√©ment 2 : `parseEuroAmount()`**

**Nom de fichier** : `parseEuroAmount.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/01-utilitaires-formatage/parseEuroAmount.ts`

**Description** :  
Analyse une cha√Æne format√©e (ex: `"450 000‚Ç¨"`) et retourne un nombre pur pour stockage Supabase.

**Fonction expos√©e** :  
```typescript
export const parseEuroAmount = (value?: string): number | undefined
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (fonction m√©tier) |
| **Param√®tres** | `value`: `string \| undefined` |
| **Retour** | `number \| undefined` |
| **Nettoyage** | Supprime espaces, `‚Ç¨`, et tous caract√®res non num√©riques |
| **Conversion d√©cimales** | Remplace `,` par `.` |
| **Gestion invalide** | Si `isNaN()` ‚Üí retourne `undefined` |
| **Type SQL cible** | `NUMERIC(12,2)` dans table `etapes_1to5` |

**Exemples** :
| Input | Output |
|---|---|
| `"450 000‚Ç¨"` | `450000` |
| `"1 200,50‚Ç¨"` | `1200.5` |
| `""` | `undefined` |
| `"invalide"` | `undefined` |

**Cas d'usage** :
- Sauvegarde `price` dans Supabase (INSERT/UPDATE)
- Sauvegarde `rentAmount` dans Supabase

---

### üìå **√âl√©ment 3 : `applyBulletFormatting()`**

**Nom de fichier** : `applyBulletFormatting.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/01-utilitaires-formatage/applyBulletFormatting.ts`

**Description** :  
Applique automatiquement les puces `‚Ä¢` en d√©but de ligne et capitalise la premi√®re lettre apr√®s chaque puce.

**Fonction expos√©e** :  
```typescript
export const applyBulletFormatting = (text: string): string
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (fonction m√©tier) |
| **Param√®tres** | `text`: `string` |
| **Retour** | `string` format√© avec puces |
| **D√©tection ligne vide** | Ignore lignes compos√©es uniquement d'espaces/sauts de ligne |
| **Ajout puce** | Si ligne ne commence PAS par `‚Ä¢` ‚Üí ajoute `‚Ä¢ ` |
| **Capitalisation** | Capitalise 1√®re lettre apr√®s `‚Ä¢ ` (`.charAt(0).toUpperCase()`) |
| **Pr√©servation** | Si ligne d√©j√† format√©e `‚Ä¢ Emplacement` ‚Üí pas de doublon |

**Exemples** :
| Input | Output |
|---|---|
| `"emplacement premium\nclient√®le fid√®le"` | `"‚Ä¢ Emplacement premium\n‚Ä¢ Client√®le fid√®le"` |
| `"‚Ä¢ Emplacement premium"` | `"‚Ä¢ Emplacement premium"` (inchang√©) |

**Cas d'usage** :
- Formatage `keyElements` (√âtape 1)
- Formatage `propertyDescription` (√âtape 2)
- Formatage `financials` (√âtape 3)
- Formatage `details` (√âtape 4)

---

### üìå **√âl√©ment 4 : `cleanUserInput()`**

**Nom de fichier** : `cleanUserInput.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/01-utilitaires-formatage/cleanUserInput.ts`

**Description** :  
Nettoie une saisie utilisateur (trim, suppression espaces multiples, normalisation).

**Fonction expos√©e** :  
```typescript
export const cleanUserInput = (text: string): string
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (fonction m√©tier) |
| **Param√®tres** | `text`: `string` |
| **Retour** | `string` nettoy√© |
| **Trim** | `.trim()` (supprime espaces d√©but/fin) |
| **Espaces multiples** | `.replace(/\s+/g, ' ')` (remplace par 1 espace) |
| **Retours ligne** | Normalise `\r\n` ‚Üí `\n` |

**Exemples** :
| Input | Output |
|---|---|
| `"  test   multiple  "` | `"test multiple"` |
| `"\n\n  text  \n"` | `"text"` |

**Cas d'usage** :
- Nettoyage avant validation de TOUS les champs texte
- Pr√©traitement avant `applyBulletFormatting()`

---

## 2. UTILITAIRES VALIDATION (5 √©l√©ments)

### üìå **√âl√©ment 5 : `validateSaleTypeConsistency()`**

**Nom de fichier** : `validateSaleTypeConsistency.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/02-utilitaires-validation/validateSaleTypeConsistency.ts`

**Description** :  
Valide la coh√©rence entre `saleType` et les champs `price` / `rentAmount`.

**Fonction expos√©e** :  
```typescript
export const validateSaleTypeConsistency = (
  saleType: string,
  price?: number | null,
  rentAmount?: number | null
): { valid: boolean; error?: string }
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (champs m√©tier) |
| **Param√®tres** | `saleType`: `string`, `price`: `number \| null \| undefined`, `rentAmount`: `number \| null \| undefined` |
| **Retour** | Objet `{ valid: boolean, error?: string }` |
| **R√®gle 1** | Si `saleType === '√† vendre'` ‚Üí `price` DOIT √™tre renseign√© ET `rentAmount` DOIT √™tre `null` |
| **R√®gle 2** | Si `saleType === '√† louer'` ‚Üí `rentAmount` DOIT √™tre renseign√© ET `price` DOIT √™tre `null` |
| **Message erreur 1** | `"Prix requis pour une vente"` |
| **Message erreur 2** | `"Loyer requis pour une location"` |

**Cas d'usage** :
- Validation √âtape 1 avant sauvegarde Supabase
- V√©rification avant appel Services OpenAI

---

### üìå **√âl√©ment 6 : `validateDetailsConsistency()`**

**Nom de fichier** : `validateDetailsConsistency.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/02-utilitaires-validation/validateDetailsConsistency.ts`

**Description** :  
Valide la coh√©rence entre `hasNoDetails` et le champ `details`.

**Fonction expos√©e** :  
```typescript
export const validateDetailsConsistency = (
  hasNoDetails: boolean,
  details?: string | null
): { valid: boolean; error?: string }
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (champs m√©tier) |
| **Param√®tres** | `hasNoDetails`: `boolean`, `details`: `string \| null \| undefined` |
| **Retour** | Objet `{ valid: boolean, error?: string }` |
| **R√®gle 1** | Si `hasNoDetails === true` ‚Üí `details` DOIT √™tre vide/null |
| **R√®gle 2** | Si `hasNoDetails === false` ‚Üí `details` DOIT avoir longueur > 0 |
| **Message erreur 1** | `"D√©tails non autoris√©s si 'Pas d'informations' coch√©"` |
| **Message erreur 2** | `"D√©tails requis si 'Pas d'informations' non coch√©"` |

**Cas d'usage** :
- Validation √âtape 4 avant sauvegarde Supabase

---

### üìå **√âl√©ment 7 : `validateMinLength()`**

**Nom de fichier** : `validateMinLength.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/02-utilitaires-validation/validateMinLength.ts`

**Description** :  
Valide qu'un texte respecte une longueur minimale.

**Fonction expos√©e** :  
```typescript
export const validateMinLength = (
  text: string,
  minLength: number,
  fieldName: string
): { valid: boolean; error?: string }
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` |
| **Param√®tres** | `text`: `string`, `minLength`: `number`, `fieldName`: `string` (nom champ pour message) |
| **Retour** | Objet `{ valid: boolean, error?: string }` |
| **R√®gle** | `text.trim().length >= minLength` |
| **Message erreur** | `"${fieldName} : minimum ${minLength} caract√®res requis"` |

**Exemples** :
| Input | minLength | fieldName | Output |
|---|---|---|---|
| `"Test"` | `10` | `"Description"` | `{ valid: false, error: "Description : minimum 10 caract√®res requis" }` |
| `"Emplacement premium"` | `5` | `"√âl√©ments cl√©s"` | `{ valid: true }` |

**Cas d'usage** :
- Validation `keyElements` (√âtape 1)
- Validation `propertyDescription` (√âtape 2)
- Validation `financials` (√âtape 3)

---

### üìå **√âl√©ment 8 : `validateRequiredField()`**

**Nom de fichier** : `validateRequiredField.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/02-utilitaires-validation/validateRequiredField.ts`

**Description** :  
Valide qu'un champ obligatoire est renseign√©.

**Fonction expos√©e** :  
```typescript
export const validateRequiredField = (
  value: any,
  fieldName: string
): { valid: boolean; error?: string }
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` |
| **Param√®tres** | `value`: `any`, `fieldName`: `string` |
| **Retour** | Objet `{ valid: boolean, error?: string }` |
| **R√®gle** | `value !== null && value !== undefined && value !== "" && value !== 0` |
| **Message erreur** | `"${fieldName} est requis"` |

**Cas d'usage** :
- Validation g√©n√©rique de TOUS les champs obligatoires
- Validation √âtapes 1 √† 4

---

### üìå **√âl√©ment 9 : `validateAllEtape()`**

**Nom de fichier** : `validateAllEtape.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/02-utilitaires-validation/validateAllEtape.ts`

**Description** :  
Fonction helper orchestrant la validation compl√®te d'une √©tape sp√©cifique.

**Fonction expos√©e** :  
```typescript
export const validateAllEtape = (
  etapeNumber: number,
  data: Partial
): { valid: boolean; errors: string[] }
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` |
| **Param√®tres** | `etapeNumber`: `1 \| 2 \| 3 \| 4 \| 5`, `data`: `Partial` |
| **Retour** | Objet `{ valid: boolean, errors: string[] }` |
| **Logique** | Switch sur `etapeNumber` ‚Üí appelle validations sp√©cifiques |
| **√âtape 1** | Valide : `agencyName`, `reference`, `location`, `propertyType`, `saleType`, coh√©rence `price`/`rentAmount`, `keyElements` |
| **√âtape 2** | Valide : `propertyDescription` (longueur minimale) |
| **√âtape 3** | Valide : `financials` (longueur minimale) |
| **√âtape 4** | Valide : coh√©rence `hasNoDetails`/`details` |
| **√âtape 5** | Valide : TOUS les champs (√©tapes 1-4 compl√®tes) |

**Cas d'usage** :
- Appel dans chaque Hook √âtape (`useEtape1()`, `useEtape2()`, etc.)
- Validation avant navigation vers √©tape suivante

---

## 3. UTILITAIRES CONVERSION/MAPPING (3 √©l√©ments)

### üìå **√âl√©ment 10 : `mapLocalStorageToSupabase()`**

**Nom de fichier** : `mapLocalStorageToSupabase.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/03-utilitaires-mapping/mapLocalStorageToSupabase.ts`

**Description** :  
Mappe les donn√©es `localStorage` existantes vers le sch√©ma Supabase `etapes_1to5`.

**Fonction expos√©e** :  
```typescript
export const mapLocalStorageToSupabase = (
  localData: PropertyDataLocalStorage
): Partial
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` pour champs m√©tier, `snake_case` pour champs syst√®me |
| **Param√®tres** | `localData`: Objet brut depuis `localStorage.getItem('propertyData')` |
| **Retour** | `Partial` (sch√©ma table `etapes_1to5`) |
| **Champs m√©tier** | Mapp√©s **sans transformation** : `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `keyElements`, `propertyDescription`, `financials`, `details`, `hasNoDetails` |
| **Champs prix** | `price` : appel `parseEuroAmount(localData.price)` ‚Üí `number \| undefined` |
| **Champs loyer** | `rentAmount` : appel `parseEuroAmount(localData.rentAmount)` ‚Üí `number \| undefined` |
| **Champs syst√®me** | `step_progress` : mapp√© depuis `localStorage.getItem('stepProgress')` ou `{1}` par d√©faut |
| **Champs ignor√©s** | `generation_status`, `session_start_time`, toutes g√©n√©rations OpenAI (restent en localStorage Phase 1) |

**Tableau mapping complet** :

| LocalStorage | Type | Supabase `etapes_1to5` | Transformation |
|---|---|---|---|
| `propertyData.agencyName` | `string` | `"agencyName"` | Aucune |
| `propertyData.reference` | `string` | `"reference"` | Aucune |
| `propertyData.exclusivite` | `string` | `"exclusivite"` | Aucune |
| `propertyData.location` | `string` | `"location"` | Aucune |
| `propertyData.propertyType` | `string` | `"propertyType"` | Aucune |
| `propertyData.saleType` | `string` | `"saleType"` | Aucune |
| `propertyData.price` | `string` | `"price"` | `parseEuroAmount()` |
| `propertyData.rentAmount` | `string` | `"rentAmount"` | `parseEuroAmount()` |
| `propertyData.rentPeriodicity` | `string` | `"rentPeriodicity"` | Aucune |
| `propertyData.keyElements` | `string` | `"keyElements"` | Aucune |
| `propertyData.propertyDescription` | `string` | `"propertyDescription"` | Aucune |
| `propertyData.financials` | `string` | `"financials"` | Aucune |
| `propertyData.details` | `string` | `"details"` | Aucune |
| `propertyData.hasNoDetails` | `boolean` | `"hasNoDetails"` | Aucune |
| `stepProgress` | `JSON` | `step_progress` | Parse JSON ‚Üí `integer[]` |

**Cas d'usage** :
- Script de migration ponctuel
- Import projets existants (si donn√©es r√©cup√©r√©es depuis backup)

---

### üìå **√âl√©ment 11 : `mapSupabaseToForm()`**

**Nom de fichier** : `mapSupabaseToForm.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/03-utilitaires-mapping/mapSupabaseToForm.ts`

**Description** :  
Mappe les donn√©es Supabase vers le format attendu par les composants React formulaires.

**Fonction expos√©e** :  
```typescript
export const mapSupabaseToForm = (
  supabaseData: PropertyDataSupabase
): PropertyDataForm
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (champs m√©tier inchang√©s) |
| **Param√®tres** | `supabaseData`: Ligne compl√®te depuis table `etapes_1to5` |
| **Retour** | `PropertyDataForm` (objet pour hydratation formulaires) |
| **Champs m√©tier** | Mapp√©s **sans transformation** (d√©j√† en `camelCase`) |
| **Champs prix** | `price` : appel `formatEuros(supabaseData.price)` ‚Üí `string` (ex: `"450 000‚Ç¨"`) |
| **Champs loyer** | `rentAmount` : appel `formatEuros(supabaseData.rentAmount)` ‚Üí `string` |
| **Champs syst√®me** | `step_progress` : ignor√© (g√©r√© s√©par√©ment par `useStepProgress`) |

**Tableau mapping complet** :

| Supabase `etapes_1to5` | Type SQL | PropertyDataForm | Transformation |
|---|---|---|---|
| `"agencyName"` | `TEXT` | `agencyName` | Aucune |
| `"reference"` | `TEXT` | `reference` | Aucune |
| `"exclusivite"` | `TEXT` | `exclusivite` | Aucune |
| `"location"` | `TEXT` | `location` | Aucune |
| `"propertyType"` | `TEXT` | `propertyType` | Aucune |
| `"saleType"` | `TEXT` | `saleType` | Aucune |
| `"price"` | `NUMERIC(12,2)` | `price` | `formatEuros()` ‚Üí `"450 000‚Ç¨"` |
| `"rentAmount"` | `NUMERIC(12,2)` | `rentAmount` | `formatEuros()` ‚Üí `"1 200‚Ç¨"` |
| `"rentPeriodicity"` | `TEXT` | `rentPeriodicity` | Aucune |
| `"keyElements"` | `TEXT` | `keyElements` | Aucune |
| `"propertyDescription"` | `TEXT` | `propertyDescription` | Aucune |
| `"financials"` | `TEXT` | `financials` | Aucune |
| `"details"` | `TEXT` | `details` | Aucune |
| `"hasNoDetails"` | `BOOLEAN` | `hasNoDetails` | Aucune |

**Cas d'usage** :
- Chargement donn√©es dans Hook √âtape 1
- Chargement donn√©es dans Hook √âtape 2, 3, 4
- Pr√©-remplissage formulaires lors retour arri√®re

---

### üìå **√âl√©ment 12 : `mapSupabaseToPrompt()`**

**Nom de fichier** : `mapSupabaseToPrompt.ts`  
**Emplacement** : `src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/02.COMPONENTS/03-utilitaires-mapping/mapSupabaseToPrompt.ts`

**Description** :  
Mappe les donn√©es Supabase vers le format attendu par les Services OpenAI (remplacement placeholders prompts).

**Fonction expos√©e** :  
```typescript
export const mapSupabaseToPrompt = (
  supabaseData: PropertyDataSupabase
): PropertyDataPrompt
```

| Contrainte | Description |
|---|---|
| **Convention nommage** | `camelCase` (champs m√©tier inchang√©s) |
| **Param√®tres** | `supabaseData`: Ligne compl√®te depuis table `etapes_1to5` |
| **Retour** | `PropertyDataPrompt` (objet pour injection dans prompts OpenAI) |
| **Champs m√©tier** | Mapp√©s **sans transformation** (d√©j√† en `camelCase`) |
| **Champs prix** | `price` : appel `formatEuros(supabaseData.price)` ‚Üí `string` (ex: `"450 000‚Ç¨"`) |
| **Champs loyer** | `rentAmount` : appel `formatEuros(supabaseData.rentAmount)` + ` / ${rentPeriodicity}` |
| **Champ exclusivit√©** | Si `exclusivite === 'Oui'` ‚Üí ajouter mention dans prompts |
| **Champ d√©tails** | `details` : **UNIQUEMENT** pour `generateSummarySheetAd()` (Fiche Synth√®se) |

**Particularit√©s mapping** :

| Champ Supabase | Prompts utilisant | Transformation |
|---|---|---|
| `"price"` | Tous (sauf si location) | `formatEuros(price)` ‚Üí `"450 000‚Ç¨"` |
| `"rentAmount"` + `"rentPeriodicity"` | Tous (si location) | `formatEuros(rentAmount)` + ` / ${rentPeriodicity}` ‚Üí `"1 200‚Ç¨ / Mensuel"` |
| `"exclusivite"` | Tous | Si `"Oui"` ‚Üí `"En exclusivit√©"` |
| `"details"` | **Fiche Synth√®se uniquement** | Ajout√© tel quel |

**Cas d'usage** :
- Appel dans chaque Service OpenAI (7 fonctions)
- Pr√©paration payload avant `fetch('/chat/completions')`

---

## ‚úÖ CHECKLIST DE VALIDATION SECTION 2

### Utilitaires Formatage
- [ ] `formatEuros()` cr√©√©e et test√©e avec valeurs positives/n√©gatives/nulles
- [ ] `parseEuroAmount()` cr√©√©e et test√©e avec formats vari√©s (`"450 000‚Ç¨"`, `"1,200.50‚Ç¨"`, etc.)
- [ ] `applyBulletFormatting()` cr√©√©e et test√©e avec/sans puces existantes
- [ ] `cleanUserInput()` cr√©√©e et test√©e avec espaces multiples/retours ligne

### Utilitaires Validation
- [ ] `validateSaleTypeConsistency()` cr√©√©e et test√©e (vente/location)
- [ ] `validateDetailsConsistency()` cr√©√©e et test√©e (hasNoDetails true/false)
- [ ] `validateMinLength()` cr√©√©e et test√©e (textes courts/longs)
- [ ] `validateRequiredField()` cr√©√©e et test√©e (valeurs null/undefined/0)
- [ ] `validateAllEtape()` cr√©√©e et test√©e pour chaque √©tape (1-5)

### Utilitaires Conversion/Mapping
- [ ] `mapLocalStorageToSupabase()` cr√©√©e et test√©e avec donn√©es localStorage r√©elles
- [ ] `mapSupabaseToForm()` cr√©√©e et test√©e (types SQL ‚Üí types JS)
- [ ] `mapSupabaseToPrompt()` cr√©√©e et test√©e (injection prompts OpenAI)

### Tests d'Int√©gration
- [ ] Pipeline complet : Form ‚Üí `parseEuroAmount()` ‚Üí Supabase ‚Üí `formatEuros()` ‚Üí Form (aller-retour)
- [ ] Validation multi-√©tapes avec `validateAllEtape()`
- [ ] Mapping localStorage ‚Üí Supabase ‚Üí Prompts OpenAI sans perte de donn√©es

---

**Date pr√©paration** : 2025-01-XX  
**Section** : 2/5 (UTILITAIRES)  

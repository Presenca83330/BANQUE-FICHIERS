# üìã **SECTION 4 - SERVICES OPENAI (7 √©l√©ments)**

## **üìã SOMMAIRE SECTION 4**

1. [Vue d'ensemble - Services OpenAI](#1-vue-densemble---services-openai)
2. [Service 1 - Annonce Site Internet](#2-service-1---annonce-site-internet)
3. [Service 2 - Fiche de Synth√®se](#3-service-2---fiche-de-synth√®se)
4. [Service 3 - Annonce Newsletter](#4-service-3---annonce-newsletter)
5. [Service 4 - Outils SEO](#5-service-4---outils-seo)
6. [Service 5 - Annonce SMS](#6-service-5---annonce-sms)
7. [Service 6 - Annonce Google Business Profile](#7-service-6---annonce-google-business-profile)
8. [Service 7 - Annonce R√©seaux Sociaux](#8-service-7---annonce-r√©seaux-sociaux)
9. [Fonction Utilitaire - R√©cup√©ration Donn√©es Supabase](#9-fonction-utilitaire---r√©cup√©ration-donn√©es-supabase)
10. [Notes Strat√©giques Globales](#10-notes-strat√©giques-globales)
11. [Checklist Section 4](#11-checklist-section-4)

---

## **1. VUE D'ENSEMBLE - SERVICES OPENAI**

### **üìå Mission Globale**
Orchestrer **7 appels s√©quentiels** √† l'API OpenAI Chat Completions pour g√©n√©rer l'ensemble du contenu marketing n√©cessaire √† la commercialisation d'un bien immobilier commercial.

### **üìä Tableau R√©capitulatif des 7 Services**

| # | Service | Fichier prompt | M√©thode | Champ `details` utilis√© | Cl√© localStorage sortie | R√¥le √âtape 6 |
|---|---------|---------------|---------|------------------------|------------------------|--------------|
| **1** | Annonce Site Internet | `1.PromptAnnonceSiteInternet.ts` | `generateWebsiteAd()` | ‚ùå Non | `generation_website_ad` | Canal Site Internet |
| **2** | Fiche de Synth√®se | `2.PromptAnnonceFichedeSynthese.ts` | `generateSummarySheetAd()` | ‚úÖ **OUI** | `generation_summary_sheet` | Canal Site Internet |
| **3** | Annonce Newsletter | `3.PromptAnnonceNewsletter.ts` | `generateNewsletterAd()` | ‚ùå Non | `generation_newsletter` | Canal Emailing |
| **4** | Outils SEO | `4.PromptOutilsSEO.ts` | `generateSEOTools()` | ‚ùå Non | `generation_seo_tools` | Canal Outils SEO |
| **5** | Annonce SMS | `5.PromptSMSAnnonce.ts` | `generateSMSAd()` | ‚ùå Non | `generation_sms_ad` | Canal SMS |
| **6** | Google Business Profile | `6.PromptGoogleBusinessProfileAnnonce.ts` | `generateGoogleBusinessProfileAd()` | ‚ùå Non | `generation_googleprofile_ad` | Canal Google Business |
| **7** | R√©seaux Sociaux | `7.PromptReseauxSociauxAnnonce.ts` | `generateReseauxSociauxAd()` | ‚ùå Non | `generation_reseauxsociaux_ad` | Canal R√©seaux Sociaux |

### **üîí POINTS CRITIQUES - INTERDICTIONS FORMELLES**

| Interdiction | Raison |
|--------------|--------|
| ‚ùå Modifier les fichiers prompts OpenAI | Logique m√©tier valid√©e, risque de r√©gression |
| ‚ùå Ajouter des transformations `snake_case` ‚Üî `camelCase` | Convention d√©finie dans `00.StrategiePhase1.md` |
| ‚ùå Changer la structure `PropertyData` | Compatibilit√© avec prompts existants |
| ‚ùå Modifier les appels API OpenAI | Risque de r√©gression |
| ‚ùå Migrer les prompts vers Supabase | Ce sont des constantes de l'application |

### **üéØ CE QUI CHANGE DANS LA MIGRATION**

| Aspect | Avant (localStorage) | Apr√®s (Supabase) |
|--------|---------------------|------------------|
| **R√©cup√©ration donn√©es** | `getPropertyDataFromStorage()` (synchrone) | `getPropertyDataFromSupabase()` (asynchrone) |
| **Format champs m√©tier** | `camelCase` | `camelCase` (**IDENTIQUE**) |
| **Filtres multi-tenant** | ‚ùå Aucun | ‚úÖ `.eq('organisation_id', ...)`, `.eq('project_id', ...)` |
| **Gestion erreurs** | ‚ùå Basique | ‚úÖ R√©seau, RLS, timeout |
| **Prompts OpenAI** | ‚úÖ Inchang√©s | ‚úÖ **STRICTEMENT INCHANG√âS** |
| **Logique `.replace()`** | ‚úÖ Inchang√©e | ‚úÖ **STRICTEMENT INCHANG√âE** |
| **Appels API OpenAI** | ‚úÖ Inchang√©s | ‚úÖ **STRICTEMENT INCHANG√âS** |
| **Stockage r√©sultats** | `localStorage` (7 cl√©s `generation_*`) | `localStorage` (**Phase 1 uniquement**) |

---

## **2. SERVICE 1 - ANNONCE SITE INTERNET**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom du service** | Annonce Site Internet |
| **Fichier actuel** | `src/services/openai.ts` |
| **Emplacement pr√©vu** | **INCHANG√â** (reste dans `src/services/openai.ts`) |
| **M√©thode** | `generateWebsiteAd()` |
| **Fichier prompt** | `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/1.PromptAnnonceSiteInternet.ts` |
| **Cl√© localStorage sortie** | `generation_website_ad` |

### **üéØ Responsabilit√©**
G√©n√®re une annonce compl√®te pour publication sur un site internet immobilier, structur√©e en 4 sections : Titre H2, Accroche, Descriptif (3 paragraphes), Call-to-Action.

### **üìä Contraintes Techniques**

| Contrainte | Description |
|-----------|-------------|
| **Convention nommage** | `camelCase` pour champs m√©tier, `snake_case` pour champs syst√®me Supabase |
| **Param√®tres d'entr√©e** | `data: PropertyData` (14 champs), `model: string` (d√©faut `"gpt-4o"`) |
| **Retour** | `Promise<{ titre: string, accroche: string, descriptif: string, cta: string }>` |
| **Mod√®le OpenAI** | `gpt-4o` ou `gpt-4o-mini` |
| **Temp√©rature** | `0.7` |
| **Max tokens** | `2000` |
| **Endpoint API** | `https://api.openai.com/v1/chat/completions` |

### **üì• Param√®tres d'entr√©e (PropertyData)**

| Champ m√©tier | Type | Source Supabase | Utilisation | Obligatoire |
|--------------|------|----------------|-------------|-------------|
| `agencyName` | `string` | `"agencyName"` | Nom agence | ‚úÖ Oui |
| `propertyType` | `string` | `"propertyType"` | Type de bien | ‚úÖ Oui |
| `saleType` | `string` | `"saleType"` | "√† vendre" ou "√† louer" | ‚úÖ Oui |
| `location` | `string` | `"location"` | Localisation | ‚úÖ Oui |
| `keyElements` | `string` | `"keyElements"` | Arguments commerciaux | ‚úÖ Oui |
| `price` | `number` | `"price"` | Prix FAI (si vente) | ‚ö†Ô∏è Conditionnel |
| `rentAmount` | `number` | `"rentAmount"` | Loyer (si location) | ‚ö†Ô∏è Conditionnel |
| `rentPeriodicity` | `string` | `"rentPeriodicity"` | Mensuel/Trimestriel/Annuel | ‚ö†Ô∏è Conditionnel |
| `exclusivite` | `string` | `"exclusivite"` | "Oui" ou "Non" | ‚úÖ Oui |
| `reference` | `string` | `"reference"` | R√©f√©rence du bien | ‚úÖ Oui |
| `propertyDescription` | `string` | `"propertyDescription"` | Description d√©taill√©e | ‚úÖ Oui |
| `financials` | `string` | `"financials"` | Informations financi√®res | ‚úÖ Oui |
| `details` | `string` | `"details"` | **‚ùå NON UTILIS√â PAR CE SERVICE** | ‚ö†Ô∏è Ignor√© |

### **üì§ Param√®tres de sortie**

| Champ JSON | Type | Description | Contraintes |
|-----------|------|-------------|-------------|
| `titre` | `string` | Titre H2 optimis√© SEO | 50-60 caract√®res |
| `accroche` | `string` | Phrase d'accroche engageante | 1-2 phrases |
| `descriptif` | `string` | Descriptif d√©taill√© en 3 paragraphes | Emplacement, Description, Finances |
| `cta` | `string` | Appel √† l'action final | - |

### **üìù Notes Strat√©giques**

| Point cl√© | Description |
|-----------|-------------|
| **Champ `details` ignor√©** | Ce service **NE DOIT PAS** utiliser le champ `details` (√âtape 4) |
| **Prompts inchang√©s** | Le fichier `1.PromptAnnonceSiteInternet.ts` reste **STRICTEMENT inchang√©** |
| **Logique `.replace()` inchang√©e** | Les remplacements de placeholders restent **STRICTEMENT identiques** |
| **Stockage Phase 1** | R√©sultats stock√©s dans `localStorage('generation_website_ad')` |
| **Migration Phase 2** | √âtape 6 Communication r√©cup√©rera depuis `localStorage` |

### **‚öôÔ∏è D√©pendances**

| D√©pendance | Type | R√¥le |
|-----------|------|------|
| `getPropertyDataFromSupabase()` | Fonction utilitaire (Section 4.9) | R√©cup√®re donn√©es depuis table `etapes_1to5` |
| `promptAnnonceSiteInternet` | Constante TypeScript | Prompt OpenAI (inchang√©) |
| OpenAI API Key | Secret Supabase | Cl√© d'authentification OpenAI |

---

## **3. SERVICE 2 - FICHE DE SYNTH√àSE**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom du service** | Fiche de Synth√®se |
| **Fichier actuel** | `src/services/openai.ts` |
| **Emplacement pr√©vu** | **INCHANG√â** |
| **M√©thode** | `generateSummarySheetAd()` |
| **Fichier prompt** | `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/2.PromptAnnonceFichedeSynthese.ts` |
| **Cl√© localStorage sortie** | `generation_summary_sheet` |

### **üéØ Responsabilit√©**
G√©n√®re une fiche de synth√®se structur√©e en 5 sections : Titre H2, R√©f√©rence et Prix, D√©tails Cl√©s, Donn√©es Financi√®res, Informations Compl√©mentaires.

### **üìä Contraintes Techniques**

| Contrainte | Description |
|-----------|-------------|
| **Convention nommage** | `camelCase` pour champs m√©tier |
| **Param√®tres d'entr√©e** | `data: PropertyData` (14 champs), `model: string` |
| **Retour** | `Promise<{ titre: string, referenceEtPrix: string, detailsCles: string, donneesFinancieres: string, informationsComplementaires: string }>` |
| **Mod√®le OpenAI** | `gpt-4o` |

### **üì• Param√®tres d'entr√©e (PropertyData)**

**‚ö†Ô∏è PARTICULARIT√â UNIQUE** : C'est le **SEUL service** qui utilise le champ `details`.

| Champ m√©tier | Utilisation | Source Supabase |
|--------------|-------------|----------------|
| **TOUS les 13 autres champs** | Identique Service 1 | `"agencyName"`, `"propertyType"`, etc. |
| `details` | ‚úÖ **UTILIS√â** | `"details"` ‚Üí Informations compl√©mentaires |

### **üì§ Param√®tres de sortie**

| Champ JSON | Type | Description |
|-----------|------|-------------|
| `titre` | `string` | Titre H2 optimis√© SEO |
| `referenceEtPrix` | `string` | R√©f√©rence + Prix/Loyer + P√©riodicit√© |
| `detailsCles` | `string` | Paragraphes : Emplacement, Description, √âquipements |
| `donneesFinancieres` | `string` | Paragraphes : Conditions locatives, Indicateurs financiers |
| `informationsComplementaires` | `string` | Paragraphes : Horaires, Fermetures (SI DISPONIBLES dans `details`) |

### **üìù Notes Strat√©giques**

| Point cl√© | Description |
|-----------|-------------|
| **Champ `details` requis** | **SEUL service** utilisant `details` (√âtape 4) |
| **Gestion conditionnelle** | Si `details` vide ‚Üí `informationsComplementaires` = cha√Æne vide |
| **Prompts inchang√©s** | Fichier prompt **STRICTEMENT inchang√©** |

---

## **4. SERVICE 3 - ANNONCE NEWSLETTER**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom du service** | Annonce Newsletter |
| **M√©thode** | `generateNewsletterAd()` |
| **Fichier prompt** | `3.PromptAnnonceNewsletter.ts` |
| **Cl√© localStorage sortie** | `generation_newsletter` |

### **üì§ Param√®tres de sortie**

| Champ JSON | Type | Description |
|-----------|------|-------------|
| `titre` | `string` | Titre accrocheur |
| `accroche` | `string` | Introduction engageante |
| `pointsForts` | `string` | Liste HTML `` des points forts |
| `callToAction` | `string` | CTA avec lien |
| `prixEtReference` | `string` | Prix/Loyer + R√©f√©rence |

### **üìù Notes Strat√©giques**

| Point cl√© | Description |
|-----------|-------------|
| **Champ `details` ignor√©** | **NE PAS** utiliser `details` |
| **Format HTML** | R√©sultat compatible email (balises ``, ``, ``, ``) |

---

## **5. SERVICE 4 - OUTILS SEO**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom du service** | Outils SEO |
| **M√©thode** | `generateSEOTools()` |
| **Fichier prompt** | `4.PromptOutilsSEO.ts` |
| **Cl√© localStorage sortie** | `generation_seo_tools` |

### **üì§ Param√®tres de sortie**

| Champ JSON | Type | Description | Contraintes |
|-----------|------|-------------|-------------|
| `baliseTitre` | `string` | Balise Title SEO | 50-60 caract√®res (max 65) |
| `baliseMetaDescription` | `string` | Balise Meta Description | 150-160 caract√®res (max 160) |
| `urlLongueTraine` | `string` | URL longue tra√Æne | 60-70 caract√®res (max 75) |

### **üìù Notes Strat√©giques**

| Point cl√© | Description |
|-----------|-------------|
| **Pas de prix dans balises** | Prix et r√©f√©rence **exclus** des balises Title, Meta, URL |
| **Format URL** | Minuscules, sans accents, tirets `-` s√©parateurs |

---

## **6. SERVICE 5 - ANNONCE SMS**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom du service** | Annonce SMS |
| **Fichier service** | `src/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/1.API-AnnonceSMS.ts` |
| **Emplacement pr√©vu** | **INCHANG√â** |
| **M√©thode** | `generateSMSAd()` |
| **Fichier prompt** | `5.PromptSMSAnnonce.ts` |
| **Cl√© localStorage sortie** | `generation_sms_ad` |

### **üì§ Param√®tres de sortie**

| Champ JSON | Type | Description | Contraintes |
|-----------|------|-------------|-------------|
| `"restitution-annonce-sms"` | `string` | SMS complet | **122 caract√®res maximum** |

### **üìù Notes Strat√©giques**

| Point cl√© | Description |
|-----------|-------------|
| **Contrainte stricte** | **122 caract√®res MAX** (limite technique SMS) |
| **Format sp√©cifique** | Type de bien + Localisation + Prix/Loyer + CTA + Contact |

---

## **7. SERVICE 6 - ANNONCE GOOGLE BUSINESS PROFILE**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom du service** | Google Business Profile |
| **Fichier service** | `src/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/2.API-AnnonceGoogleBusinessProfile.ts` |
| **M√©thode** | `generateGoogleBusinessProfileAd()` |
| **Fichier prompt** | `6.PromptGoogleBusinessProfileAnnonce.ts` |
| **Cl√© localStorage sortie** | `generation_googleprofile_ad` |

### **üì§ Param√®tres de sortie**

| Champ JSON | Type | Description |
|-----------|------|-------------|
| `TitreAnnonceGoogle` | `string` | Titre accrocheur |
| `AccrocheDescriptiveAnnonceGoogle` | `string` | Description engageante |
| `PointsFortsAnnonceGoogle` | `string` | Points forts structur√©s |
| `CtaAnnonceGoogle` | `string` | Call-to-Action |

---

## **8. SERVICE 7 - ANNONCE R√âSEAUX SOCIAUX**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom du service** | R√©seaux Sociaux |
| **Fichier service** | `src/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/3.API-AnnonceReseauxSociaux.ts` |
| **M√©thode** | `generateReseauxSociauxAd()` |
| **Fichier prompt** | `7.PromptReseauxSociauxAnnonce.ts` |
| **Cl√© localStorage sortie** | `generation_reseauxsociaux_ad` |

### **üì§ Param√®tres de sortie**

| Champ JSON | Type | Description |
|-----------|------|-------------|
| `TitreAnnonceReseaux` | `string` | Titre impactant |
| `AccrocheImpactanteAnnonceReseaux` | `string` | Accroche virale |
| `AtoutsAnnonceReseaux` | `string` | Atouts diff√©renciants |
| `CtaAnnonceReseaux` | `string` | Appel √† l'action |

---

## **9. FONCTION UTILITAIRE - R√âCUP√âRATION DONN√âES SUPABASE**

### **üìå Informations g√©n√©rales**

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom de la fonction** | `getPropertyDataFromSupabase()` |
| **Emplacement pr√©vu** | `src/services/openai.ts` (m√™me fichier que services OpenAI) |
| **Type** | Fonction utilitaire asynchrone |

### **üéØ Responsabilit√©**
Remplace `getPropertyDataFromStorage()` pour r√©cup√©rer les donn√©es du projet depuis la table Supabase `etapes_1to5` au lieu de `localStorage`.

### **üìä Contraintes Techniques**

| Contrainte | Description |
|-----------|-------------|
| **Convention nommage** | `camelCase` (fonction utilitaire) |
| **Param√®tres d'entr√©e** | `projectId: string` |
| **Retour** | `Promise` |
| **Gestion erreurs** | Try/catch avec retour objet vide `{}` si erreur |
| **Filtres multi-tenant** | `.eq('organisation_id', currentUser.organisationId)` + `.eq('id', projectId)` |
| **D√©pendances** | `useSupabaseOperations`, `useCurrentUser` |

### **‚öôÔ∏è Signature de fonction**

```typescript
export const getPropertyDataFromSupabase = async (
  projectId: string
): Promise => {
  try {
    const { select } = useSupabaseOperations();
    const { user } = useCurrentUser();

    const result = await select('etapes_1to5', {
      id: projectId,
      organisation_id: user.organisationId
    });

    if (!result.ok || !result.data || result.data.length === 0) {
      console.error("Projet introuvable:", projectId);
      return {};
    }

    const projectData = result.data[0];

    // Mapping direct (pas de transformation camelCase/snake_case)
    return {
      agencyName: projectData.agencyName,
      reference: projectData.reference,
      exclusivite: projectData.exclusivite,
      location: projectData.location,
      propertyType: projectData.propertyType,
      saleType: projectData.saleType,
      price: projectData.price ? formatEuros(projectData.price) : undefined,
      rentAmount: projectData.rentAmount ? formatEuros(projectData.rentAmount) : undefined,
      rentPeriodicity: projectData.rentPeriodicity,
      keyElements: projectData.keyElements,
      propertyDescription: projectData.propertyDescription,
      financials: projectData.financials,
      details: projectData.details,
      hasNoDetails: projectData.hasNoDetails
    };
  } catch (error) {
    console.error("Erreur lors de la r√©cup√©ration des donn√©es Supabase:", error);
    return {};
  }
};
```

### **üìù Notes Strat√©giques**

| Point cl√© | Description |
|-----------|-------------|
| **Aucune transformation** | Les champs `camelCase` restent **STRICTEMENT inchang√©s** |
| **Formatage prix** | Appel `formatEuros()` pour convertir `NUMERIC(12,2)` ‚Üí `"450 000‚Ç¨"` |
| **Isolation multi-tenant** | Filtre automatique par `organisation_id` |
| **Gestion erreurs** | Retourne `{}` en cas d'erreur (compatibilit√© avec code existant) |

---

## **10. NOTES STRAT√âGIQUES GLOBALES**

### **üìã Tableau des Interdictions Formelles**

| Interdiction | Raison | Impact si non-respect |
|--------------|--------|----------------------|
| ‚ùå Modifier les prompts OpenAI | Logique m√©tier valid√©e, prompts test√©s | R√©gression qualit√© g√©n√©rations, rupture avec √âtape 6 |
| ‚ùå Ajouter transformations `snake_case` ‚Üî `camelCase` | Convention d√©finie `00.StrategiePhase1.md` | Bugs mapping, dette technique |
| ‚ùå Changer structure `PropertyData` | Compatibilit√© prompts existants | Crash appels OpenAI, erreurs `.replace()` |
| ‚ùå Modifier appels API OpenAI | Risque r√©gression | √âchec g√©n√©rations, erreurs parsing JSON |
| ‚ùå Migrer prompts vers Supabase | Constantes applicatives | Complexit√© inutile, perte performance |

### **üìã Tableau Comparatif `details` par Service**

| Service | Utilise `details` | Raison |
|---------|-------------------|--------|
| Annonce Site Internet | ‚ùå Non | Informations compl√©mentaires non requises pour site |
| **Fiche de Synth√®se** | ‚úÖ **OUI** | Seul service n√©cessitant infos compl√©mentaires (horaires, fermetures) |
| Annonce Newsletter | ‚ùå Non | Format court, focus points forts |
| Outils SEO | ‚ùå Non | SEO n√©cessite donn√©es essentielles uniquement |
| Annonce SMS | ‚ùå Non | Limite 122 caract√®res |
| Google Business Profile | ‚ùå Non | Format standardis√© |
| R√©seaux Sociaux | ‚ùå Non | Format viral, focus accroche |

---

## **11. CHECKLIST SECTION 4**

- [ ] **Service 1 - Annonce Site Internet** : Aucune modification du code (prompts inchang√©s)
- [ ] **Service 2 - Fiche de Synth√®se** : V√©rifier utilisation champ `details`
- [ ] **Service 3 - Annonce Newsletter** : V√©rifier format HTML
- [ ] **Service 4 - Outils SEO** : V√©rifier contraintes longueur (Title, Meta, URL)
- [ ] **Service 5 - Annonce SMS** : V√©rifier contrainte 122 caract√®res
- [ ] **Service 6 - Google Business Profile** : Aucune modification
- [ ] **Service 7 - R√©seaux Sociaux** : Aucune modification
- [ ] **Fonction `getPropertyDataFromSupabase()`** : Cr√©er dans `openai.ts`
- [ ] **Tests unitaires** : Valider chaque service isol√©ment
- [ ] **Tests int√©gration** : Orchestration 7 services s√©quentiels
- [ ] **V√©rification multi-tenant** : Filtres `organisation_id` + `project_id`
- [ ] **V√©rification stockage Phase 1** : 7 cl√©s `localStorage` (`generation_*`)

---

# CODES SECTION 1
---
# 1 — annonce-phase1-get-project-data/index.ts

```ts
// supabase/functions/annonce-phase1-get-project-data/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import type { GetProjectDataQuery, GetProjectDataResponse } from "./types.ts";
import {
  createSupabaseClient,
  ok,
  badRequest,
  notFound,
  methodNotAllowed,
  getQueryParam,
} from "../annonce-phase1-shared/helpers.ts";

serve(async (req: Request): Promise<Response> => {
  if (req.method !== "GET") {
    return methodNotAllowed();
  }

  const projectId = getQueryParam(req.url, "project_id");
  if (!projectId) {
    return badRequest({ error: "Missing required query param: project_id" });
  }

  const supabase = createSupabaseClient(req);

  const { data, error } = await supabase
    .from("etapes_1to5")
    .select("*")
    .eq("project_id", projectId)
    .maybeSingle();

  if (error) {
    return badRequest({ error: error.message });
  }

  if (!data) {
    return notFound({ error: "Project not found or not accessible" });
  }

  const payload: GetProjectDataResponse = { data };
  return ok(payload);
});
```

### Bloc 1 — annonce-phase1-get-project-data/types.ts

```ts
// supabase/functions/annonce-phase1-get-project-data/types.ts
export interface GetProjectDataQuery {
  project_id: string;
}

export interface Etapes1to5Row {
  project_id: string;
  organisation_id: string;
  user_id: string;
  utilisateur_type_compte?: string;
  agencyName?: string;
  propertyType?: string;
  saleType?: string;
  location?: string;
  keyElements?: string;
  propertyDescription?: string;
  financials?: string;
  details?: string;
  exclusivite?: string;
  price?: string;
  rentAmount?: string;
  rentPeriodicity?: string;
  reference?: string;
  step_progress?: number[];
  created_at?: string;
  updated_at?: string;
  [key: string]: unknown;
}

export interface GetProjectDataResponse {
  data: Etapes1to5Row | null;
  error?: string;
}
```

---

### Bloc 2 — annonce-phase1-get-active-key/index.ts

```ts
// supabase/functions/annonce-phase1-get-active-key/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import type { GetActiveOpenAIKeyResponse } from "./types.ts";
import {
  createSupabaseClient,
  ok,
  badRequest,
  notFound,
  methodNotAllowed,
} from "../annonce-phase1-shared/helpers.ts";

serve(async (req: Request): Promise<Response> => {
  if (req.method !== "GET") {
    return methodNotAllowed();
  }

  const supabase = createSupabaseClient(req);

  // RLS restreint automatiquement la visibilité à l'organisation du demandeur
  const { data, error } = await supabase
    .from("openai_api_keys")
    .select("key_value")
    .eq("key_active", true)
    .maybeSingle();

  if (error) {
    return badRequest({ error: error.message });
  }

  if (!data?.key_value) {
    return notFound({ error: "No active OpenAI key found for current organisation" });
  }

  const payload: GetActiveOpenAIKeyResponse = { key_value: data.key_value };
  return ok(payload);
});
```

### Bloc 2 — annonce-phase1-get-active-key/types.ts

```ts
// supabase/functions/annonce-phase1-get-active-key/types.ts
export interface GetActiveOpenAIKeyResponse {
  key_value: string;
}
```

---

### Bloc 3 — annonce-phase1-update-token-counters/index.ts

```ts
// supabase/functions/annonce-phase1-update-token-counters/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import type {
  UpdateTokenCountersPayload,
  UpdateTokenCountersResponse,
} from "./types.ts";
import {
  parseJson,
  ok,
  badRequest,
  methodNotAllowed,
} from "../annonce-phase1-shared/helpers.ts";
import { MODEL_OPENAI } from "../annonce-phase1-shared/constants.ts";

// Phase 1 : fonction livrée en mode neutralisé (préparation Phase 2).
// Aucun write en base n'est effectué ici.

serve(async (req: Request): Promise<Response> => {
  if (req.method !== "POST") {
    return methodNotAllowed();
  }

  const body = (await parseJson<UpdateTokenCountersPayload>(req)) || {};

  if (
    typeof body.service_name !== "string" ||
    body.service_name.trim() === "" ||
    typeof body.tokens_used !== "number" ||
    body.tokens_used < 0
  ) {
    return badRequest({
      error:
        "Invalid payload: service_name (non-empty string) and tokens_used (>= 0) are required.",
    });
  }

  const response: UpdateTokenCountersResponse = {
    ok: true,
    phase: 1,
    persisted: false, // Phase 1: aucun insert dans openai_usage_logs
    effective_model: body.model_used || MODEL_OPENAI,
  };

  return ok(response);
});
```

### Bloc 3 — annonce-phase1-update-token-counters/types.ts

```ts
// supabase/functions/annonce-phase1-update-token-counters/types.ts
export type UsageStatus = "success" | "error" | "timeout";

export interface UpdateTokenCountersPayload {
  project_id?: string | null;
  service_name: string;
  model_used?: string | null;
  prompt_tokens?: number | null;
  completion_tokens?: number | null;
  tokens_used: number;
  response_time_ms?: number | null;
  status?: UsageStatus | null;
  error_message?: string | null;
}

export interface UpdateTokenCountersResponse {
  ok: true;
  phase: 1;
  persisted: false;
  effective_model: string;
}
```

---

### Bloc 4 — Modules partagés/helpers.ts

```ts
// supabase/functions/annonce-phase1-shared/helpers.ts
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

export function json(body: unknown, status = 200): Response {
  return new Response(JSON.stringify(body), {
    status,
    headers: { "Content-Type": "application/json" },
  });
}

export function ok(body: unknown): Response {
  return json(body, 200);
}

export function badRequest(body: unknown): Response {
  return json(body, 400);
}

export function unauthorized(body: unknown): Response {
  return json(body, 401);
}

export function notFound(body: unknown): Response {
  return json(body, 404);
}

export function methodNotAllowed(): Response {
  return json({ error: "Method Not Allowed" }, 405);
}

export function getQueryParam(url: string, key: string): string | null {
  try {
    const u = new URL(url);
    return u.searchParams.get(key);
  } catch {
    return null;
  }
}

export async function parseJson<T = unknown>(req: Request): Promise<T | null> {
  try {
    const txt = await req.text();
    if (!txt) return {} as T;
    return JSON.parse(txt) as T;
  } catch {
    return null;
  }
}

export function createSupabaseClient(req: Request) {
  const supabaseUrl = Deno.env.get("SUPABASE_URL");
  const supabaseAnonKey = Deno.env.get("SUPABASE_ANON_KEY");

  if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error("Missing SUPABASE_URL or SUPABASE_ANON_KEY");
  }

  return createClient(supabaseUrl, supabaseAnonKey, {
    global: {
      headers: {
        Authorization: req.headers.get("Authorization") ?? "",
      },
    },
  });
}
```

### Bloc 4 — Modules partagés/constants.ts

```ts
// supabase/functions/annonce-phase1-shared/constants.ts
export const MODEL_OPENAI = "gpt-5-mini-2025-08-07";
export const MAX_COMPLETION_TOKENS = 3000;
```


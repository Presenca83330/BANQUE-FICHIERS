# üìã SECTION 5 - COMPOSANTS & CONTEXTES (12 √©l√©ments √† adapter)

## üìë SOMMAIRE CLIQUABLE

1. [Vue d'Ensemble de la Section 5](#1-vue-densemble-de-la-section-5)
2. [Tableau R√©capitulatif des √âl√©ments](#2-tableau-r√©capitulatif-des-√©l√©ments)
3. [Points d'Attention Critiques](#3-points-dattention-critiques)
4. [Composants React - √âtapes 1-5 (5 √©l√©ments)](#4-composants-react---√©tapes-1-5-5-√©l√©ments)
   - [4.1. Composant √âtape 1](#41-composant-√©tape-1)
   - [4.2. Composant √âtape 2](#42-composant-√©tape-2)
   - [4.3. Composant √âtape 3](#43-composant-√©tape-3)
   - [4.4. Composant √âtape 4](#44-composant-√©tape-4)
   - [4.5. Composant √âtape 5](#45-composant-√©tape-5)
5. [Composants React - Restitution (3 √©l√©ments)](#5-composants-react---restitution-3-√©l√©ments)
   - [5.1. Annonce Site Internet](#51-annonce-site-internet)
   - [5.2. Fiche de Synth√®se](#52-fiche-de-synth√®se)
   - [5.3. Annonce Newsletter](#53-annonce-newsletter)
6. [Hook Technique - useStepProgress](#6-hook-technique---usestepprogress)
7. [Utilitaires de Stockage](#7-utilitaires-de-stockage)
8. [Script de Migration](#8-script-de-migration)
9. [Notes Strat√©giques Globales](#9-notes-strat√©giques-globales)
10. [Checklist de Validation](#10-checklist-de-validation)

---

## 1. VUE D'ENSEMBLE DE LA SECTION 5

### Mission

La **Section 5** regroupe tous les **composants React**, le **hook de progression**, et le **script de migration** qui n√©cessitent des **adaptations** (et NON des cr√©ations compl√®tes) pour passer du mode `localStorage` au mode Supabase.

### Principe d'Adaptation

- **AUCUN composant n'est cr√©√© from scratch**
- Tous les composants **existent d√©j√†** et fonctionnent avec `localStorage`
- L'adaptation consiste √† :
  - Remplacer les appels `getPropertyDataFromStorage()` par `getPropertyDataFromSupabase()`
  - Remplacer les appels `updatePropertyData()` par `updateEtapeXSupabase()`
  - Int√©grer les hooks m√©tier (`useEtape1`, `useEtape2`, etc.)
  - G√©rer les √©tats `loading` et `error`
  - Conserver **STRICTEMENT** l'UI, les validations, et les comportements existants

---

## 2. TABLEAU R√âCAPITULATIF DES √âL√âMENTS

| # | Nom | Fichier Actuel | Type | Action | Hooks Int√©gr√©s | D√©pendances |
|---|-----|---------------|------|--------|---------------|-------------|
| 1 | Composant √âtape 1 | `src/components/1-Sources-Generation-Annonces/form-etape1/EnsembleFormulairesEtape1Form.tsx` | Composant Formulaire | üîÑ Adapter | `useEtape1()`, `useStepProgress()` | `validationEtape1()` |
| 2 | Composant √âtape 2 | `src/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm.tsx` | Composant Formulaire | üîÑ Adapter | `useEtape2()`, `useStepProgress()` | `validationEtape2()` |
| 3 | Composant √âtape 3 | `src/components/1-Sources-Generation-Annonces/form-etape3/SaisieFinancialForm.tsx` | Composant Formulaire | üîÑ Adapter | `useEtape3()`, `useStepProgress()` | `validationEtape3()` |
| 4 | Composant √âtape 4 | `src/components/1-Sources-Generation-Annonces/form-etape4/SaisieDetailsForm.tsx` | Composant Formulaire | üîÑ Adapter | `useEtape4()`, `useStepProgress()` | `validationEtape4()` |
| 5 | Composant √âtape 5 | `src/1.etapes-generation-annonces/etape5/Etape5.tsx` | Composant Page | üîÑ Adapter | `useEtape5()`, `useStepProgress()` | Services OpenAI |
| 6 | Annonce Site Internet | `src/components/1-Sources-Generation-Annonces/restitution-annonce/1.AnnonceSiteInternet.tsx` | Composant Restitution | üîÑ Adapter | - | `localStorage` (Phase 1) |
| 7 | Fiche de Synth√®se | `src/components/1-Sources-Generation-Annonces/restitution-annonce/2.AnnonceFichedeSynthese.tsx` | Composant Restitution | üîÑ Adapter | - | `localStorage` (Phase 1) |
| 8 | Annonce Newsletter | `src/components/1-Sources-Generation-Annonces/restitution-annonce/3.AnnonceNewsletter.tsx` | Composant Restitution | üîÑ Adapter | - | `localStorage` (Phase 1) |
| 9 | `useStepProgress` | `src/components/1-Sources-Generation-Annonces/utils/useStepProgress.ts` | Hook Technique | üîÑ Adapter | - | Table `etapes_1to5`, champs `step_X_completed` |
| 10 | `getPropertyDataFromStorage` | `src/services/openai.ts` | Utilitaire | ‚ùå **DEPRECATED** | - | Remplac√© par `getPropertyDataFromSupabase()` |
| 11 | `updatePropertyData` | `src/services/openai.ts` | Utilitaire | ‚ùå **DEPRECATED** | - | Remplac√© par hooks m√©tier |
| 12 | Script Migration | `src/utils/migration/migrateLocalStorageToSupabase.ts` | Script | üÜï √Ä cr√©er | - | `mapLocalStorageToSupabase()` |

---

## 3. POINTS D'ATTENTION CRITIQUES

### üîí Interdictions Formelles

| Interdit | Raison |
|----------|--------|
| ‚ùå Modifier la structure HTML/JSX des composants | Risque de r√©gression UI, tests utilisateur valid√©s |
| ‚ùå Modifier les validations m√©tier existantes | Logique valid√©e, risque d'incoh√©rences |
| ‚ùå Supprimer le support `localStorage` (Phase 1) | Compatibilit√© temporaire avec √âtape 6 Communication |
| ‚ùå Modifier les placeholders, labels, textes d'aide | UX valid√©e, risque confusion utilisateur |
| ‚ùå Changer les noms des champs de formulaire | Coh√©rence avec `camelCase` d√©fini dans Section 4 |

### üéØ Strat√©gie d'Adaptation

| Aspect | Avant (localStorage) | Apr√®s (Supabase) |
|--------|---------------------|------------------|
| **Chargement donn√©es** | `getPropertyDataFromStorage()` (synchrone) | `getPropertyDataFromSupabase(projectId)` (asynchrone) |
| **Sauvegarde donn√©es** | `updatePropertyData(data)` (synchrone) | `updateEtapeXSupabase(projectId, data)` (asynchrone) |
| **√âtats de chargement** | ‚ùå Aucun | ‚úÖ `loading`, `error` states |
| **Validation m√©tier** | ‚úÖ Inchang√©e | ‚úÖ **STRICTEMENT INCHANG√âE** |
| **UI/UX** | ‚úÖ Inchang√©e | ‚úÖ **STRICTEMENT INCHANG√âE** |
| **Multi-tenant** | ‚ùå Aucun | ‚úÖ Filtres `organisation_id`, `client_id`, `project_id` |

---

## 4. COMPOSANTS REACT - √âTAPES 1-5 (5 √©l√©ments)

### 4.1. Composant √âtape 1

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Ensemble Formulaires √âtape 1 |
| **Nom pr√©vu** | `EnsembleFormulairesEtape1Form.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/form-etape1/EnsembleFormulairesEtape1Form.tsx` |
| **Type** | Composant Formulaire React (`forwardRef`) |
| **Responsabilit√©** | Saisie des **√©l√©ments cl√©s** : agence, type de bien, prix/loyer, arguments commerciaux |

#### Fonctions Expos√©es

| Fonction | Signature | Responsabilit√© |
|----------|-----------|---------------|
| `handleValidation()` | `() => boolean` | Valide les 10 champs de l'√©tape 1, sauvegarde dans Supabase si succ√®s |

#### Contraintes Techniques

| Contrainte | Valeur | Justification |
|------------|--------|---------------|
| **Convention nommage** | `camelCase` pour champs m√©tier (`agencyName`, `propertyType`, `price`, `rentAmount`, `keyElements`), `snake_case` pour champs syst√®me | Coh√©rence avec Section 4 - Services OpenAI |
| **Hook m√©tier** | `useEtape1()` | Fourni par Section 3 - Hooks React |
| **Hook progression** | `useStepProgress()` | Gestion `step_1_completed`, d√©blocage √©tape 2 |
| **Validation** | `validationEtape1(formData)` | Utilitaire Section 2 - Utilitaires |
| **√âtats UI** | `loading`, `error` states | Gestion asynchrone Supabase |
| **Format mon√©taire** | `price`: `"450 000‚Ç¨"`, `rentAmount`: `"1 200‚Ç¨"` | **Formatage conserv√©** (espaces s√©parateurs milliers) |

#### Param√®tres d'Entr√©e

| Champ Formulaire | Type | Source Avant | Source Apr√®s | Validation | Contrainte M√©tier |
|-----------------|------|--------------|--------------|------------|------------------|
| `agencyName` | `string` | `localStorage.propertyData` | `etapes_1to5."agencyName"` | Obligatoire, non vide | Nom agence immobili√®re |
| `reference` | `string` | `localStorage.propertyData` | `etapes_1to5."reference"` | Obligatoire, non vide | R√©f√©rence unique du bien |
| `exclusivite` | `string` | `localStorage.propertyData` | `etapes_1to5."exclusivite"` | - | "Oui" ou "Non" (d√©faut: "Non") |
| `location` | `string` | `localStorage.propertyData` | `etapes_1to5."location"` | Obligatoire, non vide | Ville, arrondissement, d√©partement |
| `propertyType` | `string` | `localStorage.propertyData` | `etapes_1to5."propertyType"` | Obligatoire, non vide | Restaurant, Commerce, Bureau... |
| `saleType` | `string` | `localStorage.propertyData` | `etapes_1to5."saleType"` | - | "√† vendre" ou "√† louer" (d√©faut: "√† vendre") |
| `price` | `string` | `localStorage.propertyData` | `etapes_1to5."price"` | Obligatoire si `saleType="√† vendre"` | Prix FAI avec format `450 000‚Ç¨` |
| `rentAmount` | `string` | `localStorage.propertyData` | `etapes_1to5."rentAmount"` | Obligatoire si `saleType="√† louer"` | Loyer HT/HC avec format `1 200‚Ç¨` |
| `rentPeriodicity` | `string` | `localStorage.propertyData` | `etapes_1to5."rentPeriodicity"` | - | "Mensuel", "Trimestriel", "Annuel" (d√©faut: "Mensuel") |
| `keyElements` | `string` | `localStorage.propertyData` | `etapes_1to5."keyElements"` | Obligatoire, non vide | Arguments commerciaux (textarea avec puces `‚Ä¢`) |

#### Param√®tres de Sortie

| Action | M√©thode Hook | Payload | R√©sultat Supabase |
|--------|-------------|---------|------------------|
| **Sauvegarde** | `useEtape1().saveEtape1(data)` | `{ agencyName, reference, exclusivite, location, propertyType, saleType, price, rentAmount, rentPeriodicity, keyElements }` | INSERT ou UPDATE `etapes_1to5` avec `step_1_completed=true` |
| **Chargement** | `useEtape1().loadEtape1(projectId)` | `projectId` (UUID) | SELECT `etapes_1to5` WHERE `project_id = projectId` |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Affichage conditionnel** | Si `saleType="√† vendre"` ‚Üí afficher champ `price`Si `saleType="√† louer"` ‚Üí afficher champs `rentAmount` + `rentPeriodicity` |
| **Formatage automatique** | `TextFieldForm` : capitalisation 1√®re lettre`MonetaryFieldForm` : formatage `450 000‚Ç¨` (espaces milliers)`FormulaireSaisie` : puces `‚Ä¢` automatiques, capitalisation apr√®s puce |
| **Validation m√©tier** | 7 validations obligatoires (voir tableau "Param√®tres d'Entr√©e")Toast d'erreur sp√©cifique par champ manquant |
| **Navigation** | Si validation OK ‚Üí `completeStep(1)` ‚Üí `navigate("/etape2")` |
| **Compatibilit√©** | Conserver `forwardRef` + `useImperativeHandle` pour exposer `handleValidation()` au composant parent |

---

### 4.2. Composant √âtape 2

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Formulaire Saisie Description |
| **Nom pr√©vu** | `SaisieDescriptionForm.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm.tsx` |
| **Type** | Composant Formulaire React (`forwardRef`) |
| **Responsabilit√©** | Saisie de la **description d√©taill√©e** du bien immobilier |

#### Fonctions Expos√©es

| Fonction | Signature | Responsabilit√© |
|----------|-----------|---------------|
| `handleValidation()` | `() => boolean` | Valide le champ `propertyDescription`, sauvegarde dans Supabase |
| `handleBackToEtape5()` | `() => void` | Retour vers √©tape 5 depuis carte "Infos de Description" |

#### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Convention nommage** | `camelCase` pour `propertyDescription` |
| **Hook m√©tier** | `useEtape2()` |
| **Hook progression** | `useStepProgress()` |
| **Validation** | `validationEtape2(formData)` |
| **√âtats UI** | `loading`, `error` |

#### Param√®tres d'Entr√©e

| Champ | Type | Source Avant | Source Apr√®s | Validation | Contrainte M√©tier |
|-------|------|--------------|--------------|------------|------------------|
| `propertyDescription` | `string` | `localStorage.propertyData` | `etapes_1to5."propertyDescription"` | Obligatoire, non vide | Description d√©taill√©e : emplacement, superficie, activit√©, client√®le, int√©rieur, capacit√©, √©quipements, infrastructures |

#### Param√®tres de Sortie

| Action | M√©thode Hook | Payload | R√©sultat |
|--------|-------------|---------|----------|
| **Sauvegarde** | `useEtape2().saveEtape2(data)` | `{ propertyDescription }` | UPDATE `etapes_1to5` avec `step_2_completed=true` |
| **Chargement** | `useEtape2().loadEtape2(projectId)` | `projectId` | SELECT `propertyDescription` |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Composant champ** | `FormulaireSaisie` avec `minRows=10`, puces `‚Ä¢` automatiques, auto-expand |
| **Aide contextuelle** | `SgaHelpBox` : conseils description du bien`EtapeFAQ` : liste informations √† int√©grer (emplacement, surface, activit√©...) |
| **Navigation** | Si validation OK ‚Üí `completeStep(2)` ‚Üí `navigate("/etape3")`Si retour depuis √©tape 5 ‚Üí sauvegarde + `navigate("/etape5")` |

---

### 4.3. Composant √âtape 3

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Formulaire Saisie Informations Financi√®res |
| **Nom pr√©vu** | `SaisieFinancialForm.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/form-etape3/SaisieFinancialForm.tsx` |
| **Type** | Composant Formulaire React (`forwardRef`) |
| **Responsabilit√©** | Saisie des **donn√©es financi√®res** et **potentiel de d√©veloppement** |

#### Fonctions Expos√©es

| Fonction | Signature | Responsabilit√© |
|----------|-----------|---------------|
| `handleValidation()` | `() => boolean` | Valide le champ `financials`, sauvegarde dans Supabase |
| `handleBackToEtape5()` | `() => void` | Retour vers √©tape 5 |

#### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Convention nommage** | `camelCase` pour `financials` |
| **Hook m√©tier** | `useEtape3()` |
| **Hook progression** | `useStepProgress()` |
| **Validation** | `validationEtape3(formData)` |
| **√âtats UI** | `loading`, `error` |

#### Param√®tres d'Entr√©e

| Champ | Type | Source Avant | Source Apr√®s | Validation | Contrainte M√©tier |
|-------|------|--------------|--------------|------------|------------------|
| `financials` | `string` | `localStorage.propertyData` | `etapes_1to5."financials"` | Obligatoire, non vide | Conditions locatives (bail, loyer, √©ch√©ance), CA, b√©n√©fice, potentiel, donn√©es personnel |

#### Param√®tres de Sortie

| Action | M√©thode Hook | Payload | R√©sultat |
|--------|-------------|---------|----------|
| **Sauvegarde** | `useEtape3().saveEtape3(data)` | `{ financials }` | UPDATE `etapes_1to5` avec `step_3_completed=true` |
| **Chargement** | `useEtape3().loadEtape3(projectId)` | `projectId` | SELECT `financials` |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Composant champ** | `FormulaireSaisie` avec `minRows=8`, puces `‚Ä¢` |
| **Aide** | `SgaHelpBox` : conseils donn√©es financi√®res`EtapeFAQ` : liste informations (bail, CA, b√©n√©fice...) |
| **Navigation** | OK ‚Üí `completeStep(3)` ‚Üí `navigate("/etape4")` |

---

### 4.4. Composant √âtape 4

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Formulaire Saisie Autres D√©tails |
| **Nom pr√©vu** | `SaisieDetailsForm.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/form-etape4/SaisieDetailsForm.tsx` |
| **Type** | Composant Formulaire React (`forwardRef`) |
| **Responsabilit√©** | Saisie de **d√©tails compl√©mentaires optionnels** |

#### Fonctions Expos√©es

| Fonction | Signature | Responsabilit√© |
|----------|-----------|---------------|
| `handleValidation()` | `() => boolean` | Valide le champ `details`, sauvegarde dans Supabase |
| `handleBackToEtape5()` | `() => void` | Retour vers √©tape 5 |

#### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Convention nommage** | `camelCase` pour `details` |
| **Hook m√©tier** | `useEtape4()` |
| **Hook progression** | `useStepProgress()` |
| **Validation** | `validationEtape4(formData)` (PEUT √äTRE VIDE) |
| **√âtats UI** | `loading`, `error` |

#### Param√®tres d'Entr√©e

| Champ | Type | Source Avant | Source Apr√®s | Validation | Contrainte M√©tier |
|-------|------|--------------|--------------|------------|------------------|
| `details` | `string` | `localStorage.propertyData` | `etapes_1to5."details"` | **OPTIONNEL** (peut √™tre vide) | D√©tails additionnels non cat√©goris√©s |

#### Param√®tres de Sortie

| Action | M√©thode Hook | Payload | R√©sultat |
|--------|-------------|---------|----------|
| **Sauvegarde** | `useEtape4().saveEtape4(data)` | `{ details }` | UPDATE `etapes_1to5` avec `step_4_completed=true` |
| **Chargement** | `useEtape4().loadEtape4(projectId)` | `projectId` | SELECT `details` |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Champ optionnel** | ‚ö†Ô∏è **Seul champ optionnel** des √©tapes 1-4Validation OK m√™me si vide |
| **Utilisation OpenAI** | Uniquement par `generateSummarySheetAd()` (voir Section 4) |
| **Composant champ** | `FormulaireSaisie` avec `minRows=6` |
| **Navigation** | OK ‚Üí `completeStep(4)` ‚Üí `navigate("/etape5")` |

---

### 4.5. Composant √âtape 5

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Page √âtape 5 - Validation et G√©n√©ration |
| **Nom pr√©vu** | `Etape5.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/1.etapes-generation-annonces/etape5/Etape5.tsx` |
| **Type** | Composant Page React |
| **Responsabilit√©** | Affichage **r√©capitulatif des 4 √©tapes**, lancement **g√©n√©ration OpenAI** des 7 annonces |

#### Fonctions Expos√©es

| Fonction | Signature | Responsabilit√© |
|----------|-----------|---------------|
| `handleGenerateAds()` | `async () => void` | Lance les 7 g√©n√©rations OpenAI en s√©quence, redirige vers animation |

#### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Hook m√©tier** | `useEtape5()` |
| **Hook progression** | `useStepProgress()` |
| **Services OpenAI** | 7 services (Section 4) |
| **√âtats UI** | `loading`, `error`, `generationStatus` |
| **Navigation** | `/etape5/animation` pendant g√©n√©ration |

#### Param√®tres d'Entr√©e

| Donn√©e | Source | Utilisation |
|--------|--------|-------------|
| Donn√©es √©tapes 1-4 | `etapes_1to5` (champs `camelCase`) | Affichage r√©capitulatif dans 4 cartes (√âl√©ments Cl√©s, Description, Financiers, D√©tails) |

#### Param√®tres de Sortie

| Action | M√©thode Hook | R√©sultat |
|--------|-------------|----------|
| **G√©n√©ration** | `useEtape5().generateAllAds(projectId)` | Appel s√©quentiel 7 services OpenAI ‚Üí Sauvegarde `localStorage` (Phase 1) |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **R√©capitulatif** | 4 cartes cliquables : 1. √âl√©ments Cl√©s ‚Üí `/etape1` 2. Infos de Description ‚Üí `/etape2` 3. Infos Financi√®res ‚Üí `/etape3` 4. Autres D√©tails ‚Üí `/etape4` |
| **G√©n√©ration OpenAI** | Bouton "G√©n√©rer mes annonces" ‚Üí `handleGenerateAds()`Appel s√©quentiel : `generateWebsiteAd()` ‚Üí `generateSummarySheetAd()` ‚Üí ... ‚Üí `generateSocialMediaAd()`Affichage animation `/etape5/animation` |
| **localStorage Phase 1** | Les 7 r√©sultats OpenAI restent en `localStorage` cl√©s : `generation_website_ad`, `generation_summary_sheet`, `generation_newsletter`, `generation_seo_tools`, `generation_sms`, `generation_google_business`, `generation_social_media` |
| **Statut g√©n√©ration** | Cl√© `localStorage`: `generation_status`Valeurs : `"pending"`, `"in_progress"`, `"completed"`, `"error"` |

---

## 5. COMPOSANTS REACT - RESTITUTION (3 √©l√©ments)

### 5.1. Annonce Site Internet

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Composant Annonce Site Internet |
| **Nom pr√©vu** | `1.AnnonceSiteInternet.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/restitution-annonce/1.AnnonceSiteInternet.tsx` |
| **Type** | Composant Restitution React |
| **Responsabilit√©** | Affichage de l'**annonce site web** g√©n√©r√©e par OpenAI |

#### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Source donn√©es** | `localStorage.generation_website_ad` (Phase 1 - **INCHANG√â**) |
| **Format attendu** | `{ titreAnnonce, accroche, prixReference, contenu }` |
| **Actions utilisateur** | Copier texte, T√©l√©charger PDF, Nouveau projet |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Pas de modification Phase 1** | Ce composant reste **100% identique**Source : `localStorage` uniquement |
| **Migration Phase 2** | Lors de la Phase 2 (√âtape 6 Communication), migration vers `table annonces_generees` |

---

### 5.2. Fiche de Synth√®se

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Composant Fiche de Synth√®se |
| **Nom pr√©vu** | `2.AnnonceFichedeSynthese.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/restitution-annonce/2.AnnonceFichedeSynthese.tsx` |
| **Type** | Composant Restitution React |
| **Responsabilit√©** | Affichage de la **fiche de synth√®se** g√©n√©r√©e par OpenAI (utilise `details`) |

#### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Source donn√©es** | `localStorage.generation_summary_sheet` (Phase 1 - **INCHANG√â**) |
| **Format attendu** | `{ titre, introduction, detailsBien, contactAgence }` |
| **Actions utilisateur** | Copier texte, T√©l√©charger PDF, Nouveau projet |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Seule utilisation `details`** | ‚ö†Ô∏è Seul service OpenAI utilisant le champ `details` (√âtape 4) |
| **Pas de modification Phase 1** | Reste **100% identique**, source `localStorage` |

---

### 5.3. Annonce Newsletter

#### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Composant Annonce Newsletter |
| **Nom pr√©vu** | `3.AnnonceNewsletter.tsx` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/restitution-annonce/3.AnnonceNewsletter.tsx` |
| **Type** | Composant Restitution React |
| **Responsabilit√©** | Affichage de l'**annonce newsletter** + **sauvegarde pour Newsletter Builder** |

#### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Source donn√©es** | `localStorage.generation_newsletter` (Phase 1 - **INCHANG√â**) |
| **Format attendu** | `{ titre, accroche, pointsForts, callToAction, prixEtReference }` |
| **Actions utilisateur** | Copier texte, Copier HTML, T√©l√©charger PDF, **Sauvegarder pour Newsletter**, Nouveau projet |

#### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Sauvegarde Newsletter** | Bouton "Sauvegarder pour ma Newsletter" ‚Üí ajout √† `localStorage.saved_newsletter_annonces`Utilis√© par `NEWSLETTER-BUILDER` (autre module) |
| **Pas de modification Phase 1** | Reste **100% identique** |

---

## 6. HOOK TECHNIQUE - useStepProgress

### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Hook Progression √âtapes |
| **Nom pr√©vu** | `useStepProgress.ts` (EXISTANT - √Ä ADAPTER) |
| **Emplacement** | `src/components/1-Sources-Generation-Annonces/utils/useStepProgress.ts` |
| **Type** | Hook React Custom |
| **Responsabilit√©** | Gestion de la **progression des √©tapes**, d√©blocage √©tapes suivantes, validation acc√®s |

### Fonctions Expos√©es

| Fonction | Signature | Responsabilit√© |
|----------|-----------|----------------|
| `completeStep(stepNumber)` | `(stepNumber: number) => void` | Marque l'√©tape comme compl√©t√©e, d√©bloque √©tape suivante |
| `isStepAvailable(stepNumber)` | `(stepNumber: number) => boolean` | V√©rifie si l'√©tape est accessible |
| `getCompletedSteps()` | `() => number[]` | Retourne la liste des √©tapes compl√©t√©es |
| `resetProgress()` | `() => void` | R√©initialise toute la progression |

### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Source Avant** | `localStorage.stepProgress` = `{ availableSteps: number[], hasCompletedStep4: boolean }` |
| **Source Apr√®s** | Table `etapes_1to5`, champs `step_1_completed`, `step_2_completed`, `step_3_completed`, `step_4_completed`, `step_5_completed` |
| **Logique d√©blocage** | √âtape N compl√©t√©e ‚Üí √âtape N+1 accessible |
| **Hook utilis√©** | `useSupabaseOperations()` pour UPDATE/SELECT |

### Mapping Avant/Apr√®s

| Aspect | localStorage | Supabase |
|--------|-------------|----------|
| **√âtape 1 compl√®te** | `stepProgress.availableSteps.includes(2)` | `etapes_1to5.step_1_completed = true` |
| **√âtape 2 compl√®te** | `stepProgress.availableSteps.includes(3)` | `etapes_1to5.step_2_completed = true` |
| **√âtape 3 compl√®te** | `stepProgress.availableSteps.includes(4)` | `etapes_1to5.step_3_completed = true` |
| **√âtape 4 compl√®te** | `stepProgress.hasCompletedStep4 = true` | `etapes_1to5.step_4_completed = true` |
| **√âtape 5 compl√®te** | `stepProgress.availableSteps.includes(6)` | `etapes_1to5.step_5_completed = true` |

### Signature TypeScript

```typescript
export const useStepProgress = (currentStep: number) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const { updateRecord, fetchRecord } = useSupabaseOperations();

  const completeStep = async (stepNumber: number) => {
    // UPDATE etapes_1to5 SET step_X_completed = true WHERE project_id = ...
  };

  const isStepAvailable = (stepNumber: number): boolean => {
    // V√©rifie step_X-1_completed = true
  };

  const getCompletedSteps = (): number[] => {
    // Retourne [1, 2, 3...] selon step_X_completed
  };

  const resetProgress = async () => {
    // UPDATE etapes_1to5 SET step_1_completed = false, step_2_completed = false...
  };

  return { completeStep, isStepAvailable, getCompletedSteps, resetProgress, loading, error };
};
```

### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Compatibilit√© temporaire** | Conserver support `localStorage` en fallback (Phase 1)Si √©chec Supabase ‚Üí fallback `localStorage` |
| **Validation acc√®s** | Emp√™cher navigation `/etape3` si `step_2_completed = false` |
| **R√©initialisation** | `resetProgress()` appel√© par bouton "Nouveau projet" |

---

## 7. UTILITAIRES DE STOCKAGE

### 7.1. getPropertyDataFromStorage (DEPRECATED)

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Get Property Data From Storage |
| **Fichier** | `src/services/openai.ts` |
| **Statut** | ‚ùå **DEPRECATED** (Phase 1) ‚Üí Remplac√© par `getPropertyDataFromSupabase()` (Section 2) |

### 7.2. updatePropertyData (DEPRECATED)

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Update Property Data |
| **Fichier** | `src/services/openai.ts` |
| **Statut** | ‚ùå **DEPRECATED** (Phase 1) ‚Üí Remplac√© par hooks m√©tier `useEtape1().saveEtape1()`, `useEtape2().saveEtape2()`, etc. |

---

## 8. SCRIPT DE MIGRATION

### Informations G√©n√©rales

| Propri√©t√© | Valeur |
|-----------|--------|
| **Nom** | Script Migration localStorage ‚Üí Supabase |
| **Nom pr√©vu** | `migrateLocalStorageToSupabase.ts` |
| **Emplacement pr√©vu** | `src/utils/migration/migrateLocalStorageToSupabase.ts` |
| **Type** | Script utilitaire (ex√©cut√© UNE FOIS par projet utilisateur) |
| **Responsabilit√©** | Migrer les projets existants de `localStorage` vers la table `etapes_1to5` |

### Fonctions Principales

| Fonction | Signature | Responsabilit√© |
|----------|-----------|---------------|
| `migrateExistingProjects()` | `async () => Promise<{ success: boolean, migratedCount: number }>` | Migre TOUS les projets `localStorage` ‚Üí Supabase |
| `migrateSingleProject(propertyData)` | `async (data: PropertyData) => Promise` | Migre UN projet vers Supabase |

### Contraintes Techniques

| Contrainte | Valeur |
|------------|--------|
| **Source** | `localStorage.propertyData` (14 champs `camelCase`) |
| **Destination** | Table `etapes_1to5` (30 colonnes) |
| **Mapping** | Utilise `mapLocalStorageToSupabase()` (Section 2 - Utilitaires) |
| **Champs syst√®me** | Auto-remplissage : `organisation_id`, `client_id`, `user_id`, `created_at`, `project_id` (UUID g√©n√©r√©) |
| **Gestion erreurs** | Rollback si √©chec, log d√©taill√© |

### Processus de Migration

| √âtape | Action | R√©sultat |
|-------|--------|----------|
| 1 | R√©cup√©rer `localStorage.propertyData` | Objet `PropertyData` (14 champs) |
| 2 | Appeler `mapLocalStorageToSupabase(propertyData)` | Objet `Etapes1to5InsertData` (30 champs) |
| 3 | G√©n√©rer `project_id` (UUID v4) | Ex: `"550e8400-e29b-41d4-a716-446655440000"` |
| 4 | R√©cup√©rer `organisation_id`, `client_id`, `user_id` depuis contexte utilisateur | Via hooks strat√©giques |
| 5 | INSERT INTO `etapes_1to5` | Nouveau record cr√©√© |
| 6 | Supprimer `localStorage.propertyData` (optionnel) | Nettoyage apr√®s migration |
| 7 | Toast succ√®s "Projet migr√© avec succ√®s" | Confirmation utilisateur |

### Signature TypeScript

```typescript
export const migrateExistingProjects = async (): Promise<{
  success: boolean;
  migratedCount: number;
  errors: string[];
}> => {
  const propertyData = getPropertyDataFromStorage();
  if (Object.keys(propertyData).length === 0) {
    return { success: true, migratedCount: 0, errors: [] };
  }

  try {
    const mappedData = mapLocalStorageToSupabase(propertyData);
    const projectId = crypto.randomUUID();

    const { data, error } = await supabase
      .from('etapes_1to5')
      .insert({
        project_id: projectId,
        organisation_id: currentUser.organisation_id,
        client_id: currentUser.client_id,
        user_id: currentUser.id,
        ...mappedData
      });

    if (error) throw error;

    // Optionnel : supprimer localStorage
    localStorage.removeItem('propertyData');

    return { success: true, migratedCount: 1, errors: [] };
  } catch (error) {
    return { success: false, migratedCount: 0, errors: [error.message] };
  }
};
```

### Notes Strat√©giques

| Point Cl√© | Description |
|-----------|-------------|
| **Ex√©cution unique** | Script ex√©cut√© automatiquement au **1er chargement apr√®s d√©ploiement**D√©tection : v√©rifier si `localStorage.propertyData` existe ET `etapes_1to5` est vide |
| **Gestion multi-projets** | ‚ö†Ô∏è `localStorage` ne stocke qu'**1 projet √† la fois**Migration = cr√©ation d'**1 seul record** `etapes_1to5` |
| **Confirmation utilisateur** | Afficher modal "Migration de vos donn√©es en cours..." |
| **Rollback** | Si √©chec INSERT ‚Üí conserver `localStorage` intactNe PAS supprimer `localStorage.propertyData` |

---

## 9. NOTES STRAT√âGIQUES GLOBALES

### 9.1. Priorit√© des Adaptations

| Composant | Priorit√© | Raison |
|-----------|----------|--------|
| `useStepProgress` | **CRITIQUE** | Bloquant pour toute navigation |
| Composants √âtapes 1-4 | **HAUTE** | Bloquant pour saisie donn√©es |
| Composant √âtape 5 | **HAUTE** | Bloquant pour g√©n√©ration OpenAI |
| Script Migration | **HAUTE** | Migration projets existants |
| Composants Restitution | **BASSE** | Fonctionnent d√©j√† avec `localStorage` (Phase 1) |

### 9.2. Strat√©gie de Tests

| Test | Description |
|------|-------------|
| **Test unitaire** | Valider chaque hook m√©tier (`useEtape1`, `useEtape2`...) |
| **Test int√©gration** | Valider flux complet √âtape 1 ‚Üí √âtape 2 ‚Üí ... ‚Üí √âtape 5 |
| **Test migration** | Valider script migration avec donn√©es r√©elles `localStorage` |
| **Test multi-tenant** | Valider isolation par `organisation_id` |
| **Test performance** | Temps de r√©ponse CRUD < 200ms |

### 9.3. Compatibilit√© Temporaire localStorage

| Aspect | Phase 1 | Phase 2 (Futur) |
|--------|---------|----------------|
| **√âtapes 1-5 (INPUT)** | ‚úÖ Supabase | ‚úÖ Supabase |
| **G√©n√©ration OpenAI (OUTPUT)** | ‚ùå `localStorage` (temporaire) | ‚úÖ Supabase (table `annonces_generees`) |
| **√âtape 6 Communication** | ‚ùå `localStorage` (inchang√©) | ‚úÖ Supabase |
| **Newsletter Builder** | ‚ùå `localStorage` (inchang√©) | ‚úÖ Supabase |

---

## 10. CHECKLIST DE VALIDATION

### ‚úÖ Composants √âtapes 1-4

- [ ] Composant √âtape 1 adapt√© : hook `useEtape1()` int√©gr√©, validation inchang√©e, UI identique
- [ ] Composant √âtape 2 adapt√© : hook `useEtape2()` int√©gr√©, `propertyDescription` sauvegard√©
- [ ] Composant √âtape 3 adapt√© : hook `useEtape3()` int√©gr√©, `financials` sauvegard√©
- [ ] Composant √âtape 4 adapt√© : hook `useEtape4()` int√©gr√©, `details` optionnel g√©r√©
- [ ] √âtats `loading` et `error` affich√©s pour chaque composant
- [ ] Toasts d'erreur Supabase personnalis√©s (r√©seau, RLS, timeout)

### ‚úÖ Composant √âtape 5

- [ ] Composant √âtape 5 adapt√© : r√©capitulatif 4 cartes charg√© depuis Supabase
- [ ] Bouton "G√©n√©rer mes annonces" appelle 7 services OpenAI en s√©quence
- [ ] R√©sultats OpenAI sauvegard√©s dans `localStorage` (Phase 1)
- [ ] Navigation vers `/etape5/animation` fonctionnelle
- [ ] Gestion statut g√©n√©ration (`pending`, `in_progress`, `completed`, `error`)

### ‚úÖ Composants Restitution

- [ ] Composants restitution inchang√©s (Phase 1)
- [ ] Lecture depuis `localStorage` fonctionnelle
- [ ] Actions utilisateur (copier, t√©l√©charger PDF, nouveau projet) op√©rationnelles

### ‚úÖ Hook useStepProgress

- [ ] Hook `useStepProgress` adapt√© : lecture/√©criture champs `step_X_completed`
- [ ] Fonction `completeStep(stepNumber)` met √† jour Supabase
- [ ] Fonction `isStepAvailable(stepNumber)` v√©rifie √©tapes pr√©c√©dentes compl√©t√©es
- [ ] Fonction `resetProgress()` r√©initialise progression
- [ ] Fallback `localStorage` fonctionnel si √©chec Supabase

### ‚úÖ Script de Migration

- [ ] Script `migrateExistingProjects()` cr√©√©
- [ ] D√©tection automatique projets `localStorage` au 1er chargement
- [ ] Mapping `mapLocalStorageToSupabase()` appliqu√© correctement
- [ ] G√©n√©ration `project_id` (UUID v4) fonctionnelle
- [ ] Injection `organisation_id`, `client_id`, `user_id` via contexte utilisateur
- [ ] Rollback si √©chec INSERT (conservation `localStorage`)
- [ ] Toast confirmation "Projet migr√© avec succ√®s"

### ‚úÖ Validation Globale

- [ ] Workflow complet √âtape 1 ‚Üí √âtape 5 test√© avec succ√®s
- [ ] Isolation multi-tenant valid√©e (utilisateur A ne voit pas projets utilisateur B)
- [ ] Performance CRUD < 200ms pour toutes les √©tapes
- [ ] Gestion erreurs robuste (toasts personnalis√©s)
- [ ] Compatibilit√© `localStorage` (Phase 1) pour r√©sultats OpenAI valid√©e

---



# üìò SECTION 2 ‚Äì UTILITAIRES  
## Phase 1 : Migration LocalStorage ‚Üí Supabase (√âtapes 1 √† 5)

**Version :** v1.1  
**Date :** 2025-10-31  
**Statut :** Document pr√©paratoire   

---

## üìã CONTEXTE & OBJECTIFS

Cette section d√©crit **tous les utilitaires** (types, validateurs, helpers, mappers) n√©cessaires √† la migration **du flux LocalStorage vers Supabase** pour les **√âtapes 1 √† 5**.

### Principes directeurs
- ‚úÖ **R√©utilisabilit√©** : fonctions g√©n√©riques partag√©es entre les hooks d‚Äô√©tapes  
- ‚úÖ **Respect int√©gral des conventions** : `camelCase` (champs m√©tier), `snake_case` (champs syst√®me)  
- ‚úÖ **TypeScript strict** : coh√©rence front / base  
- ‚úÖ **Multi-tenant s√©curis√©** : isolation par `organisation_id` / `user_id` / `utilisateur_type_compte`  
- ‚úÖ **Z√©ro rupture fonctionnelle** : reproduit √† l‚Äôidentique le comportement localStorage  

---

## üß± 2.1 ‚Äì TYPES & INTERFACES

### **2.1.1 ‚Äì Interface PropertyData (m√©tier)**

| √âl√©ment | Sp√©cification |
|----------|---------------|
| **Fichier** | `src/types/propertyData.ts` |
| **Objectif** | Typage des 14 champs m√©tier `camelCase` de la table `etapes_1to5` |
| **Origine** | Bible des r√©f√©rences + process LocalStorage |

```ts
export interface PropertyData {
  // √âtape 1
  agencyName: string;
  reference: string;
  exclusivite: 'Oui' | 'Non';
  location: string;
  propertyType: string;
  saleType: '√† vendre' | '√† louer';
  price?: string | null;          // format texte
  rentAmount?: string | null;     // format texte
  rentPeriodicity?: 'Mensuel' | 'Trimestriel' | 'Annuel' | null;
  keyElements: string;
  propertyDescription: string;
  financials: string;
  details?: string | null;
  hasNoDetails: boolean;
}
```

‚úÖ Conforme √† la table `etapes_1to5` (14 champs TEXT, aucun champ num√©rique).  

---

### **2.1.2 ‚Äì Interface Etapes1to5Row (Supabase)**

| √âl√©ment | Sp√©cification |
|----------|---------------|
| **Fichier** | `src/types/etapes1to5.ts` |
| **Objectif** | Repr√©sentation compl√®te d‚Äôune ligne Supabase `etapes_1to5` |
| **Origine** | Sch√©ma SQL valid√© nnn4.1 ‚Äì Section 1 |

```ts
import { PropertyData } from './propertyData';

export interface Etapes1to5Row extends PropertyData {
  // Champs syst√®me
  id: string;
  organisation_id: string;
  user_id: string | null;
  utilisateur_type_compte: string;
  step_progress: number[];
  statut: 'en_cours' | 'archive';
  validated_at: string | null;
  created_at: string;
  updated_at: string;

  // Champs analytiques
  reseau_id?: string | null;
  reseau_agence_id?: string | null;
  agence_indep_id?: string | null;
  reseau_direction_id?: string | null;
  reseau_agence_responsable_id?: string | null;
  agence_indep_responsable_id?: string | null;
  logs?: any;
}
```

---

## üß© 2.2 ‚Äì VALIDATORS

Les validateurs reproduisent **exactement** la logique du localStorage actuel :  
v√©rification de pr√©sence, de coh√©rence et de longueur minimale.  
Aucune logique num√©rique : tout est g√©r√© en TEXT avec `trim()`.

---

### **2.2.1 ‚Äì validateEtape1()**

```ts
export function validateEtape1(data: Partial<PropertyData>) {
  const errors: Record<string, string> = {};

  if (!data.agencyName?.trim()) errors.agencyName = "Nom d'agence requis";
  if (!data.reference?.trim()) errors.reference = "R√©f√©rence obligatoire";
  if (!data.location?.trim()) errors.location = "Localisation obligatoire";
  if (!data.propertyType?.trim()) errors.propertyType = "Type de bien requis";
  if (!data.saleType || !['√† vendre', '√† louer'].includes(data.saleType))
    errors.saleType = "Type de transaction invalide";

  if (data.saleType === '√† vendre' && !data.price?.trim())
    errors.price = "Prix requis pour une vente";

  if (data.saleType === '√† louer') {
    if (!data.rentAmount?.trim()) errors.rentAmount = "Loyer requis";
    if (!data.rentPeriodicity)
      errors.rentPeriodicity = "P√©riodicit√© requise pour la location";
  }

  if (!data.keyElements?.trim())
    errors.keyElements = "Les √©l√©ments cl√©s sont obligatoires";

  return { isValid: Object.keys(errors).length === 0, errors };
}
```

---

### **2.2.2 ‚Äì validateEtape2()**

```ts
export function validateEtape2(data: Partial<PropertyData>) {
  const errors: Record<string, string> = {};
  if (!data.propertyDescription?.trim())
    errors.propertyDescription = "Description du bien obligatoire";
  return { isValid: Object.keys(errors).length === 0, errors };
}
```

---

### **2.2.3 ‚Äì validateEtape3()**

```ts
export function validateEtape3(data: Partial<PropertyData>) {
  const errors: Record<string, string> = {};
  if (!data.financials?.trim())
    errors.financials = "Informations financi√®res requises";
  return { isValid: Object.keys(errors).length === 0, errors };
}
```

---

### **2.2.4 ‚Äì validateEtape4()**

```ts
export function validateEtape4(data: Partial<PropertyData>) {
  const errors: Record<string, string> = {};

  if (data.hasNoDetails === false && !data.details?.trim()) {
    errors.details = "Veuillez renseigner les d√©tails ou cocher 'Aucun d√©tail'";
  }
  if (data.hasNoDetails === true && data.details?.trim()) {
    errors.hasNoDetails = "Ne pas remplir de d√©tails si 'Aucun d√©tail' est coch√©";
  }

  return { isValid: Object.keys(errors).length === 0, errors };
}
```

---

### **2.2.5 ‚Äì validateAllEtape()**

```ts
export function validateAllEtape(data: PropertyData) {
  const v1 = validateEtape1(data);
  const v2 = validateEtape2(data);
  const v3 = validateEtape3(data);
  const v4 = validateEtape4(data);
  return {
    isValid: v1.isValid && v2.isValid && v3.isValid && v4.isValid,
    errors: { ...v1.errors, ...v2.errors, ...v3.errors, ...v4.errors },
  };
}
```

---

## üîÑ 2.3 ‚Äì MAPPINGS (LocalStorage ‚Üî Supabase)

### **2.3.1 ‚Äì mapLocalStorageToSupabase()**

```ts
export function mapLocalStorageToSupabase(localData: PropertyData, user: any) {
  return {
    organisation_id: user.organisation_id,
    user_id: user.id,
    utilisateur_type_compte: user.utilisateur_type_compte,
    step_progress: [1],
    statut: 'en_cours',
    ...localData,
  };
}
```

---

### **2.3.2 ‚Äì mapSupabaseToForm()**

```ts
export function mapSupabaseToForm(supabaseData: any): PropertyData {
  const data = { ...supabaseData };
  return {
    agencyName: data.agencyName || '',
    reference: data.reference || '',
    exclusivite: data.exclusivite || 'Non',
    location: data.location || '',
    propertyType: data.propertyType || '',
    saleType: data.saleType || '',
    price: data.price || '',
    rentAmount: data.rentAmount || '',
    rentPeriodicity: data.rentPeriodicity || null,
    keyElements: data.keyElements || '',
    propertyDescription: data.propertyDescription || '',
    financials: data.financials || '',
    details: data.details || '',
    hasNoDetails: !!data.hasNoDetails,
  };
}
```

---

### **2.3.3 ‚Äì mapSupabaseToPrompt()**

```ts
export function mapSupabaseToPrompt(supabaseData: any): Record<string, any> {
  // Filtrage RLS d√©j√† g√©r√© par Supabase
  const {
    agencyName,
    propertyType,
    saleType,
    exclusivite,
    price,
    rentAmount,
    rentPeriodicity,
    keyElements,
    propertyDescription,
    financials,
    details,
    location,
    reference,
  } = supabaseData;

  return {
    agencyName,
    propertyType,
    saleType,
    exclusivite,
    price,
    rentAmount,
    rentPeriodicity,
    keyElements,
    propertyDescription,
    financials,
    details,
    location,
    reference,
  };
}
```

---

## üß† 2.4 ‚Äì NOTES TECHNIQUES

- **Aucune conversion num√©rique** sur `price` / `rentAmount` : format TEXT conserv√©.  
- **Aucune cr√©ation de champs analytiques** non d√©finis dans la table actuelle.  
- **Respect absolu des conventions camelCase/snake_case**.  
- **Compatibilit√© compl√®te** avec la table `etapes_1to5` et la strat√©gie multi-tenant Supabase.  

---


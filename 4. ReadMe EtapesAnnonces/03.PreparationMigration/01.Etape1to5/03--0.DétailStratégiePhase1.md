
# üéØ D√âTAIL DE LA STRAT√âGIE - PHASE 1 : MIGRATION √âTAPES 1 √Ä 5

## **Principe G√©n√©ral de la Migration Phase 1 -> Etape 1 √† Etape 5**

- **Objectif** : **Migrer le process Localstorage -Supabase**
    - Migrer les **14 champs propertyData** des √©tapes 1-4 vers Supabase
    - G√©rer la migration de **Etapes 1** √† **Etape 5**
    - **Pr√©parer** et **envoyer** les donn√©es √† OpenAI
    - Utiliser les **7 prompts sp√©cifiques** (d√©finis dans `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/`)
    - **Ne pas aller plus loin**

- **Ce qui reste en localStorage dans cette phase 1** :
    - Les **7 g√©n√©rations renvoy√©es par OpenAI** restent en l'√©tat, on les laisse temporairement dans `localStorage`
    - Le **statut de g√©n√©ration** (`generation_status`) reste √©galement dans `localStorage`
    - Afin de laisser la compatibilit√© temporaire avec **√âtape 6 Communication** qui reste en `localStorage`
    - Afin de **limiter les risques** et identifier plus facilement de potentiels bugs

---
## **Imp√©ratif d'Architecture : Convention du nommage `camelCase`**
### **Interdiction formelle de transformer les champs actuels  `camelCase` en `snake_case`**

### **Imp√©ratif absolu pour la migration**
- **Tous les hooks, fonctions, et interactions Supabase cr√©√©s lors de la migration DOIVENT imp√©rativement :**
    - **Conserver la structure `camelCase` existante** pour **les champs m√©tier**
        - (`agencyName`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`, `propertyDescription`, `financials`, `details`, `exclusivite`, `location`, `reference`).
    - **Utiliser `snake_case` uniquement** pour **les champs syst√®me Supabase**
        - (`organisation_id`, `user_id`, `created_at`, `updated_at`,  etc.).

### **REGLES CONCERNANT LE NOMMAGE DES `camelCase`**
- **R√®gle SQL- Cr√©ation de table**
    - Champs m√©tier : " camelCase " (avec guillemets doubles)
    - Champs syst√®me : snake_case (sans guillemets)
- **R√®gle TypeScript - Hooks & Services**
    - Utilisation directe du camelCase pour champs m√©tier
    - Utilisation directe du snake_case pour champs syst√®me
    - AUCUNE fonction de conversion n'est n√©cessaire
- **R√®gle Triggers**
    - Utiliser : NEW."camelCase" ou NEW.snake_case
    - Pr√©f√©rer les fonctions g√©n√©riques r√©utilisables
---


## üìã OBJECTIF DU DOCUMENT

- Ce document constitue la **strat√©gie d'impl√©mentation d√©taill√©e** de la migration Phase 1 (√âtapes 1-5) de `localStorage` vers Supabase,
- **sans code**, sous forme de plan strat√©gique pr√™t pour l'impl√©mentation.

**Mission** :
- D√©crire l'architecture modulaire compl√®te
- D√©finir les responsabilit√©s de chaque couche
- √âtablir les flux de donn√©es et les d√©pendances
- Fournir une roadmap claire pour l'impl√©mentation

---

## üìë SOMMAIRE

1. [Rappel du Contexte](#1-rappel-du-contexte)
2. [Architecture Modulaire en 5 Couches](#2-architecture-modulaire-en-5-couches)
3. [Couche 1 - Hooks M√©tier (5 hooks - un par √©tape)](#3-couche-1---hooks-m√©tier)
4. [Couche 2 - Gestion Progression (1 hook central)](#4-couche-2---gestion-progression)
5. [Couche 3 - Services OpenAI (7 fonctions)](#5-couche-3---services-openai)
6. [Couche 4 - Op√©rations Supabase (1 hook technique)](#6-couche-4---op√©rations-supabase)
7. [Couche 5 - Utilitaires (fonctions helpers)](#7-couche-5---utilitaires)
8. [Flux Global d'Utilisation](#8-flux-global-dutilisation)
9. [Strat√©gie Multi-Tenant](#9-strat√©gie-multi-tenant)
10. [Triggers et Fonctions SQL](#10-triggers-et-fonctions-sql)
11. [Gestion du champ step_progress](#11-gestion-du-champ-step_progress)
12. [Gestion des champs conditionnels](#12-gestion-des-champs-conditionnels)
13. [Avantages de cette Architecture](#13-avantages-de-cette-architecture)

---

## 1. RAPPEL DU CONTEXTE

### üìä R√©capitulatif Table SQL

**Table : `etapes_1to5`**
- **Total : 30 champs SQL**
  - **9 champs syst√®me** (snake_case) : `id`, `organisation_id`, `user_id`, `utilisateur_type_compte`, `step_progress`, `statut`, `validated_at`, `created_at`, `updated_at`
  - **7 champs analytiques** (snake_case) : `reseau_id`, `reseau_agence_id`, `agence_indep_id`, `logs`, `reseau_direction_id`, `reseau_agence_responsable_id`, `agence_indep_responsable_id`
  - **14 champs m√©tier** (camelCase) : `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`, `propertyDescription`, `financials`, `details`, `hasNoDetails`

### üö® Convention de Nommage CRITIQUE

**R√àGLE D'OR IMP√âRATIVE** :
- ‚úÖ **Champs syst√®me Supabase** ‚Üí `snake_case` (`organisation_id`, `user_id`, `created_at`, `updated_at`, `step_progress`, etc.)
- ‚úÖ **Champs m√©tier business** ‚Üí `camelCase` (`agencyName`, `propertyType`, `saleType`, `price`, `keyElements`, etc.)

**Raison** :
- √âvite la rupture avec les 7 prompts OpenAI existants
- √âvite la rupture avec l'√âtape 6 Communication (Phase 2)
- Garantit une migration sans transformation de donn√©es

---

## 2. ARCHITECTURE MODULAIRE EN 5 COUCHES

### Principe de S√©paration des Responsabilit√©s

L'architecture repose sur **5 couches modulaires ind√©pendantes** :

| Couche | Nom | Responsabilit√© Principale | Nombre de modules |
|--------|-----|---------------------------|-------------------|
| **1Ô∏è‚É£** | Hooks M√©tier | Gestion √©tat et logique m√©tier par √©tape | 5 hooks (1 par √©tape) |
| **2Ô∏è‚É£** | Gestion Progression | Navigation et d√©verrouillage des √©tapes | 1 hook central |
| **3Ô∏è‚É£** | Services OpenAI | Orchestration appels OpenAI avec Supabase | 7 fonctions d'envoi |
| **4Ô∏è‚É£** | Op√©rations Supabase | Interface unique CRUD avec Supabase | 1 hook technique |
| **5Ô∏è‚É£** | Utilitaires | Fonctions helpers r√©utilisables | Fonctions multiples |

---

## 3. COUCHE 1 - HOOKS M√âTIER

### Responsabilit√©s Globales

- Gestion de l'√©tat local des champs de chaque √©tape
- Chargement des donn√©es existantes depuis Supabase
- Validation m√©tier selon r√®gles sp√©cifiques
- Sauvegarde progressive dans Supabase
- D√©clenchement de `completeStep(X)` apr√®s validation

### Tableau D√©taill√© des 5 Hooks

| Hook | √âtape | Champs g√©r√©s | R√®gles de validation | Actions validation | D√©pendances |
|------|-------|--------------|---------------------|-------------------|-------------|
| **Hook √âtape 1** | 1 | `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements` | - Tous obligatoires sauf `price`/`rentAmount` (conditionnel selon `saleType`)- Coh√©rence `saleType` ‚Üî `price`/`rentAmount` | 1. Validation champs2. Sauvegarde Supabase3. `completeStep(1)`4. Navigation `/etape2` | Hook Op√©rations Supabase |
| **Hook √âtape 2** | 2 | `propertyDescription` | - Obligatoire- Longueur minimale | 1. Validation2. Sauvegarde Supabase3. `completeStep(2)`4. Navigation `/etape3` | Hook Op√©rations SupabaseUtilitaires Formatage |
| **Hook √âtape 3** | 3 | `financials` | - Obligatoire- Longueur minimale | 1. Validation2. Sauvegarde Supabase3. `completeStep(3)`4. Navigation `/etape4` | Hook Op√©rations SupabaseUtilitaires Formatage |
| **Hook √âtape 4** | 4 | `details`, `hasNoDetails` | - Choix exclusif : `details` OU `hasNoDetails`- Coh√©rence logique | 1. Validation2. Sauvegarde Supabase3. `completeStep(4)`4. Navigation `/etape5` | Hook Op√©rations SupabaseUtilitaires Validation |
| **Hook √âtape 5** | 5 | Aucun (lecture seule) | - Projet complet valid√© | 1. Chargement projet complet2. Affichage r√©capitulatif3. Validation finale (`validated_at`, `statut ‚Üí 'archive'`)4. Orchestration 7 envois OpenAI5. Navigation `/etape5/animation` | Hook Op√©rations SupabaseServices OpenAI |

---

## 4. COUCHE 2 - GESTION PROGRESSION

### Responsabilit√©s

Gestion centralis√©e de la navigation et du d√©verrouillage progressif des √©tapes, bas√©e sur la table `etapes_1to5` dans Supabase.  
Toutes les op√©rations d‚Äô√©criture passent d√©sormais par le hook sp√©cialis√© **`useSupabaseEtapesOperations`**, qui encapsule le client Supabase du hook strat√©gique `useSupabaseOperations`.

---

### Tableau des Fonctionnalit√©s

| Fonction | Responsabilit√© | Param√®tres | Retour | Impact sur Supabase |
|----------|----------------|-------------|---------|----------------------|
| `completeStep(X)` | Ajoute l'√©tape suivante au tableau `step_progress` via RPC | `stepNumber: number` | `Promise<{ data, error }>` | `CALL update_step_progress(p_new_step := X+1)` (via `useSupabaseEtapesOperations.completeStep()`) |
| `isStepAvailable(X)` | V√©rifie si une √©tape est accessible selon `step_progress` | `stepNumber: number` | `boolean` | Lecture via `useSupabaseEtapesOperations.getEtapeData()` |
| `getDisabledSteps()` | Calcule les √©tapes non accessibles √† l‚Äôutilisateur | Aucun | `number[]` | Aucun (calcul local) |
| `goToNextStep()` | Navigation vers l‚Äô√©tape suivante | Aucun | `void` | Aucun (navigation React Router) |
| `handleNewProject()` | R√©initialise le projet et cr√©e une nouvelle entr√©e dans Supabase | Aucun | `Promise<{ data, error }>` | `INSERT etapes_1to5` (via `useSupabaseEtapesOperations.saveEtapeData()`) |
| `handleBackToEtape5()` | Retour sp√©cial vers l‚Äô√©tape 5 (r√©capitulatif avant g√©n√©ration) | Aucun | `void` | Sauvegarde modifications + Navigation `/etape5` |

---

**‚öôÔ∏è Int√©gration technique :**
- Le hook `useStepProgress` importe `completeStep` et `getEtapeData` depuis `useSupabaseEtapesOperations`.  
- Aucun acc√®s direct √† `supabase` ni √† `useSupabaseOperations`.  
- Les v√©rifications locales (`isStepAvailable`, `getDisabledSteps`) utilisent les donn√©es du state React, non Supabase.  
- L‚Äô√©tat de progression (`currentStep`, `completedSteps`) est synchronis√© √† chaque sauvegarde.

## 5. COUCHE 3 - SERVICES OPENAI

### Responsabilit√©s

Orchestration des 7 appels s√©quentiels √† OpenAI Chat Completions API avec donn√©es Supabase.

### Tableau des 7 Fonctions d'Envoi

| Appel | Service | Prompt | Champs `propertyData` utilis√©s | R√©sultat stock√© | Stockage Phase 1 | Utilisation Phase 2 |
|-------|---------|--------|-------------------------------|-----------------|-----------------|---------------------|
| **1** | `generateWebsiteAd()` | `promptAnnonceSiteInternet` | ‚úÖ **TOUS** sauf `details` | `{ titre, accroche, descriptif, cta }` | `localStorage('generation_website_ad')` | √âtape 6 Communication |
| **2** | `generateSummarySheetAd()` | `promptAnnonceFichedeSynthese` | ‚úÖ **TOUS** (y compris `details`) | `{ titre, referenceEtPrix, detailsCles, donneesFinancieres, informationsComplementaires }` | `localStorage('generation_summary_sheet')` | √âtape 6 Communication |
| **3** | `generateNewsletterAd()` | `promptAnnonceNewsletter` | ‚úÖ **TOUS** sauf `details` | `{ titre, accroche, pointsForts, callToAction, prixEtReference }` | `localStorage('generation_newsletter')` | √âtape 6 Communication |
| **4** | `generateSEOTools()` | `promptOutilsSEO` | ‚úÖ **TOUS** sauf `details` | `{ baliseTitre, baliseMetaDescription, urlLongueTraine }` | `localStorage('generation_seo_tools')` | √âtape 6 Communication |
| **5** | `generateSMSAd()` | `promptAnnonceSMS` | ‚úÖ **TOUS** sauf `details` | `{ "restitution-annonce-sms" }` | `localStorage('generation_sms_ad')` | √âtape 6 Communication |
| **6** | `generateGoogleProfileAd()` | `promptAnnonceGoogleBusinessProfile` | ‚úÖ **TOUS** sauf `details` | `{ TitreAnnonceGoogle, AccrocheDescriptiveAnnonceGoogle, PointsFortsAnnonceGoogle, CtaAnnonceGoogle }` | `localStorage('generation_googleprofile_ad')` | √âtape 6 Communication |
| **7** | `generateReseauxSociauxAd()` | `promptAnnonceReseauxSociaux` | ‚úÖ **TOUS** sauf `details` | `{ TitreAnnonceReseaux, AccrocheImpactanteAnnonceReseaux, AtoutsAnnonceReseaux, CtaAnnonceReseaux }` | `localStorage('generation_reseauxsociaux_ad')` | √âtape 6 Communication |

**‚ö†Ô∏è Particularit√© champ `details`** :
- ‚úÖ Utilis√© **UNIQUEMENT** dans `generateSummarySheetAd()` (Fiche de Synth√®se)
- ‚ùå **Ignor√©** par les 6 autres g√©n√©rations

---
## 6. COUCHE 4 - OP√âRATIONS SUPABASE

### Responsabilit√©s

- Interface unique et s√©curis√©e entre l'application et Supabase, bas√©e sur le **nouveau hook sp√©cialis√© `useSupabaseEtapesOperations`**, qui s‚Äôappuie en interne sur le client du **hook strat√©gique `useSupabaseOperations`** (non modifi√©).
- Ce hook m√©tier d√©di√© encapsule toutes les op√©rations de lecture et d‚Äô√©criture sur la table `etapes_1to5`, sans impacter la logique globale des autres modules Supabase.

---

### Tableau des Op√©rations CRUD

| Op√©ration                     | Fonction                                                   | Param√®tres                              | Injection automatique                                                          | Retour                  | RLS appliqu√©e                   |
| ----------------------------- | ---------------------------------------------------------- | --------------------------------------- | ------------------------------------------------------------------------------ | ----------------------- | ------------------------------- |
| **Cr√©er projet**              | `insert('etapes_1to5', payload)`                           | `payload: PropertyData`                 | `organisation_id`, `user_id`, `utilisateur_type_compte`, `step_progress = {1}` | `{ ok, data, message }` | ‚úÖ Oui (via RLS INSERT policy)   |
| **Lire projet**               | `select('etapes_1to5', { id })`                            | `{ id: string }`                        | `organisation_id` (filtre automatique)                                         | `{ ok, data, message }` | ‚úÖ Oui (via RLS SELECT policy)   |
| **Mettre √† jour champs**      | `update('etapes_1to5', 'id', id, payload)`                 | `id: string`, `payload: Partial`        | `organisation_id` (filtre)                                                     | `{ ok, data, message }` | ‚úÖ Oui (via RLS UPDATE policy)   |
| **Mettre √† jour progression** | `update('etapes_1to5', 'id', id, { step_progress })`       | `id: string`, `step_progress: number[]` | Aucun (champ sp√©cifique)                                                       | `{ ok, data, message }` | ‚úÖ Oui                           |
| **Valider projet final**      | `update('etapes_1to5', 'id', id, { validated_at: NOW() })` | `id: string`                            | Trigger `set_validated_at` + `statut_du_projet`                                | `{ ok, data, message }` | ‚úÖ Oui                           |
| **Lister projets**            | `select('etapes_1to5', { statut: 'en_cours' })`            | `{ statut: string }`                    | `organisation_id`, `user_id` (selon RLS hi√©rarchique)                          | `{ ok, data, message }` | ‚úÖ Oui (visibilit√© hi√©rarchique) |
| **G√©rer logs audit**          | `update('etapes_1to5', 'id', id, { logs: jsonb })`         | `id: string`, `logs: jsonb`             | Aucun (champ `logs` optionnel)                                                 | `{ ok, data, message }` | ‚úÖ Oui                           |

---

**‚ö†Ô∏è Important :** Le hook `useSupabaseEtapesOperations` g√®re d√©sormais les op√©rations CRUD pour la table `etapes_1to5`.
Il s‚Äôappuie sur le client Supabase du hook strat√©gique `useSupabaseOperations` et **injecte automatiquement** :

* `organisation_id` (depuis `useCurrentUser().user.organisationId`)
* `user_id` (r√©solu via `auth.uid()` ‚Üí `users.users_id`)
* `utilisateur_type_compte` (via `useCurrentUser().utilisateurTypeCompte`)

---

## 7. COUCHE 5 - UTILITAIRES

### Responsabilit√©s

Fonctions r√©utilisables de transformation, validation et conversion.

### Tableau des Utilitaires par Cat√©gorie

#### 7.1. Utilitaires Formatage

| Fonction | Responsabilit√© | Param√®tres | Retour | Exemple |
|----------|---------------|------------|--------|---------|
| `applyBulletFormatting(text)` | Applique puces + capitalisation | `text: string` | `string` | `"emplacement"` ‚Üí `"‚Ä¢ Emplacement"` |
| `cleanUserInput(text)` | Nettoie saisie | `text: string` | `string` | `" test  "` ‚Üí `"test"` |

#### 7.2. Utilitaires Validation

| Fonction | Responsabilit√© | Param√®tres | Retour | R√®gle |
|----------|---------------|------------|--------|-------|
| `validateSaleTypeConsistency(saleType, price, rentAmount)` | Valide coh√©rence vente/location | `saleType`, `price`, `rentAmount` | `{ valid: boolean, error?: string }` | Si `saleType="√† vendre"` ‚Üí `price` requis (TEXT non vide), `rentAmount` null |
| `validateDetailsConsistency(hasNoDetails, details)` | Valide coh√©rence d√©tails | `hasNoDetails`, `details` | `{ valid: boolean, error?: string }` | Si `hasNoDetails=true` ‚Üí `details` vide |
| `validateMinLength(text, min)` | Valide longueur minimale | `text`, `min: number` | `boolean` | `text.length >= min` |

#### 7.3. Utilitaires Conversion

| Fonction | Responsabilit√© | Param√®tres | Retour | Usage |
|----------|---------------|------------|--------|-------|
| `mapLocalStorageToSupabase(localData)` | Mappe localStorage ‚Üí Supabase | `localData: PropertyData` | `SupabasePayload` | Migration initiale |
| `mapSupabaseToForm(supabaseData)` | Mappe Supabase ‚Üí Formulaires | `supabaseData: any` | `PropertyData` | Chargement √©tapes |
| `mapSupabaseToPrompt(supabaseData)` | Mappe Supabase ‚Üí Prompts OpenAI | `supabaseData: any` | `PropertyData` | G√©n√©ration OpenAI |

---

## 8. FLUX GLOBAL D'UTILISATION

### Diagramme S√©quentiel

```mermaid
sequenceDiagram
    participant User
    participant HookEtapeX
    participant HookProgression
    participant HookOperations
    participant Supabase
    participant ServicesOpenAI
    participant OpenAI

    User->>HookEtapeX: Arrive sur √âtape X
    HookEtapeX->>HookOperations: select('etapes_1to5', {id})
    HookOperations->>Supabase: SELECT avec RLS (organisation_id)
    Supabase-->>HookOperations: Donn√©es projet
    HookOperations-->>HookEtapeX: { ok: true, data }
    HookEtapeX-->>User: Affichage formulaire pr√©-rempli

    User->>HookEtapeX: Modifie champ
    HookEtapeX->>HookOperations: update('etapes_1to5', 'id', id, {champ})
    HookOperations->>Supabase: UPDATE (debounced, auto organisation_id)
    Supabase-->>HookOperations: { ok: true }

    User->>HookEtapeX: Valide √©tape
    HookEtapeX->>HookEtapeX: Validation m√©tier (Utilitaires)
    HookEtapeX->>HookProgression: completeStep(X)
    HookProgression->>HookOperations: update('etapes_1to5', 'id', id, {step_progress})
    HookOperations->>Supabase: UPDATE step_progress = array_append(...)
    Supabase-->>HookOperations: { ok: true }
    HookProgression-->>HookEtapeX: Navigation /etapeX+1

    Note over User,OpenAI: [R√©p√©ter jusqu'√† √âtape 5]

    User->>HookEtape5: Validation finale
    HookEtape5->>HookOperations: update('etapes_1to5', 'id', id, {validated_at: NOW()})
    HookOperations->>Supabase: UPDATE validated_at (trigger statut)
    Supabase->>Supabase: Trigger statut_du_projet ‚Üí 'archive'
    Supabase-->>HookOperations: { ok: true }

    HookEtape5->>ServicesOpenAI: Orchestration 7 envois
    loop 7 g√©n√©rations
        ServicesOpenAI->>OpenAI: POST /chat/completions
        OpenAI-->>ServicesOpenAI: JSON g√©n√©ration
        ServicesOpenAI->>ServicesOpenAI: localStorage.setItem('generation_X')
    end

    ServicesOpenAI-->>User: Redirection /etape5/animation
```

---

## 9. STRAT√âGIE MULTI-TENANT

### 9.1. Injection Automatique des Champs

**Source** : `02.1.GestionStrategieMultiTenant.md`

| Champ | Source | Moment d'injection | Fonction SQL helper |
|-------|--------|-------------------|---------------------|
| `organisation_id` | `useCurrentUser().user.organisationId` | INSERT/UPDATE | `get_user_organisation_id(auth.uid())` |
| `user_id` | `users.users_id` (li√© √† `auth.uid()`) | INSERT | Mapping automatique |
| `utilisateur_type_compte` | `utilisateurs.utilisateur_type_compte` | INSERT | `get_user_type_compte(auth.uid())` |
| `reseau_id` | `reseau.reseau_id` (si applicable) | INSERT (optionnel) | `get_user_reseau_id(auth.uid())` |
| `reseau_agence_id` | `reseau_agence.reseau_agence_id` (si applicable) | INSERT (optionnel) | `get_user_reseau_agence_id(auth.uid())` |
| `agence_indep_id` | `agence_independante.agence_indep_id` (si applicable) | INSERT (optionnel) | `get_user_agence_indep_id(auth.uid())` |

### 9.2. R√®gles de Visibilit√© Hi√©rarchique

**Source** : `02.1.GestionStrategieMultiTenant.md`

#### Pour les structures R√©seaux

| Type utilisateur | Voit les projets de |
|------------------|---------------------|
| `reseau` | `reseau` + `reseau_direction` |
| `reseau_direction` | `reseau` + `reseau_direction` |
| `reseau_agence` | `reseau_agence` + `reseau_agence_responsable` + `reseau_agence_collaborateur` |
| `reseau_agence_responsable` | `reseau_agence` + `reseau_agence_responsable` + `reseau_agence_collaborateur` |
| `reseau_agence_collaborateur` | **Uniquement ses propres projets** |

#### Pour les structures Agences Ind√©pendantes

| Type utilisateur | Voit les projets de |
|------------------|---------------------|
| `agence_independante` | `agence_independante` + `agence_independante_responsable` + `agence_independante_collaborateur` |
| `agence_independante_responsable` | `agence_independante` + `agence_independante_responsable` + `agence_independante_collaborateur` |
| `agence_independante_collaborateur` | **Uniquement ses propres projets** |

### 9.3. RLS Policies Requises

**Source** : `02.1.GestionStrategieMultiTenant.md`

| Policy | Op√©ration | Logique |
|--------|-----------|---------|
| `etapes_1to5_select_hierarchical` | SELECT | Admin PRESENCA OU (m√™me `organisation_id` ET logique hi√©rarchique selon `utilisateur_type_compte`) |
| `etapes_1to5_insert_own_organisation` | INSERT | `organisation_id` = user's organisation ET `user_id` = current user ET `utilisateur_type_compte` = user's type |
| `etapes_1to5_update_hierarchical` | UPDATE | M√™me logique que SELECT + emp√™cher modification `organisation_id`/`user_id` |
| `etapes_1to5_delete_own_or_admin` | DELETE | Admin PRESENCA OU (m√™me `organisation_id` ET `user_id` = current user) |

---

## 10. TRIGGERS ET FONCTIONS SQL

### 10.1. Triggers Supabase

**Source** : `01.Table_etapes1to5.md`

| Trigger | Table | √âv√©nement | Condition | Action | Fonction appel√©e |
|---------|-------|-----------|-----------|--------|------------------|
| `set_updated_at_etapes1to5` | `etapes_1to5` | `BEFORE UPDATE` | Toujours | `NEW.updated_at := NOW()` | Fonction autonome |
| `set_validated_at` | `etapes_1to5` | `BEFORE UPDATE` | `NEW.validated_at IS NOT NULL` AND `OLD.validated_at IS NULL` | `NEW.validated_at := NOW()` | Fonction autonome |
| `statut_du_projet` | `etapes_1to5` | `BEFORE UPDATE` | `NEW.validated_at IS NOT NULL` AND `5 = ANY(NEW.step_progress)` | `NEW.statut := 'archive'` | Fonction autonome |

### 10.2. Fonctions SQL Helper Multi-Tenant

**Source** : `02.1.GestionStrategieMultiTenant.md`

| Fonction | Param√®tres | Retour | Utilisation |
|----------|------------|--------|-------------|
| `get_user_organisation_id(user_uuid UUID)` | `user_uuid` | `UUID` | ‚úÖ **D√©j√† existante** - Injection `organisation_id` |
| `is_admin_presenca(user_uuid UUID)` | `user_uuid` | `BOOLEAN` | ‚úÖ **D√©j√† existante** - V√©rification admin |
| `get_user_agence_indep_id(user_uuid UUID)` | `user_uuid` | `UUID` | ‚úÖ **D√©j√† existante** - R√©cup agence ind√©p |
| `get_user_type_compte(user_uuid UUID)` | `user_uuid` | `TEXT` | üÜï **√Ä cr√©er** - R√©cup type compte |
| `get_user_reseau_agence_id(user_uuid UUID)` | `user_uuid` | `UUID` | üÜï **√Ä cr√©er** - R√©cup agence r√©seau |
| `user_belongs_to_reseau_agence(p_user_id UUID, p_reseau_agence_id UUID)` | `p_user_id`, `p_reseau_agence_id` | `BOOLEAN` | üÜï **√Ä cr√©er** - V√©rif appartenance |
| `user_belongs_to_agence_indep(p_user_id UUID, p_agence_indep_id UUID)` | `p_user_id`, `p_agence_indep_id` | `BOOLEAN` | üÜï **√Ä cr√©er** - V√©rif appartenance |

---

## 11. GESTION DU CHAMP `step_progress`

### 11.1. Logique du Champ

**Source** : `01.Table_etapes1to5.md` (lignes 116-141)

| Aspect | Description |
|--------|-------------|
| **Type SQL** | `integer[]` (tableau d'entiers) |
| **Initialisation** | `{1}` (seule l'√©tape 1 accessible) |
| **Progression** | √Ä chaque validation d'√©tape X ‚Üí ajoute X+1 au tableau |
| **Navigation libre** | Utilisateur peut naviguer entre toutes les √©tapes pr√©sentes |
| **Non r√©gressif** | Une fois ajout√©e, l'√©tape reste accessible |
| **Contrainte CHECK** | `array_length(step_progress, 1) >= 1 AND 1 = ANY(step_progress) AND step_progress <@ ARRAY[1,2,3,4,5]` |

### 11.2. Exemples de Valeurs

| Progression | Valeur `step_progress` | √âtapes accessibles | Explication |
|-------------|------------------------|-------------------|-------------|
| √âtape 1 valid√©e | `{1, 2}` | 1, 2 | Peut faire √âtape 2 |
| √âtape 2 valid√©e | `{1, 2, 3}` | 1, 2, 3 | Peut faire √âtape 3 |
| √âtape 3 valid√©e | `{1, 2, 3, 4}` | 1, 2, 3, 4 | Peut faire √âtape 4 |
| √âtape 4 valid√©e | `{1, 2, 3, 4, 5}` | 1, 2, 3, 4, 5 | Peut g√©n√©rer OpenAI |
| Retour √âtape 2 (modification) | `{1, 2, 3, 4, 5}` | **Toutes** | Navigation libre, pas de r√©gression |

---

## 12. GESTION DES CHAMPS CONDITIONNELS

### 12.1. Logique `saleType` ‚Üî `price`/`rentAmount`

**Source** : `01.Table_etapes1to5.md`

| Sc√©nario | `saleType` | `price` | `rentAmount` | `rentPeriodicity` | Contrainte CHECK SQL |
|----------|------------|---------|--------------|-------------------|---------------------|
| **Vente** | `'√† vendre'` | **Requis** (TEXT non vide) | **NULL** | **NULL** | `CHECK ((saleType = '√† vendre' AND price IS NOT NULL AND length(trim(price)) > 0 AND rentAmount IS NULL) OR ...)` |
| **Location** | `'√† louer'` | **NULL** | **Requis** (TEXT non vide) | **Requis** (Mensuel/Trimestriel/Annuel) | `CHECK ((saleType = '√† louer' AND rentAmount IS NOT NULL AND length(trim(rentAmount)) > 0 AND price IS NULL) OR ...)` |




### 12.2. Logique `hasNoDetails` ‚Üî `details`

**Source** : `01.Table_etapes1to5.md`

| Sc√©nario | `hasNoDetails` | `details` | Contrainte CHECK SQL |
|----------|---------------|----------|---------------------|
| **Aucune info** | `true` | **NULL ou vide** | `CHECK ((hasNoDetails = true AND (details IS NULL OR details = '')) OR ...)` |
| **Infos saisies** | `false` | **Requis** (length > 0) | `CHECK ((hasNoDetails = false AND length(details) > 0) OR ...)` |

---

## 13. AVANTAGES DE CETTE ARCHITECTURE

### Tableau des B√©n√©fices

| Avantage | Description | Impact |
|----------|-------------|--------|
| **Modularit√©** | Chaque hook a une responsabilit√© unique | Facilite maintenance et √©volutions |
| **R√©utilisabilit√©** | Couche Op√©rations Supabase + Utilitaires partag√©s | √âvite duplication code |
| **Testabilit√©** | Chaque module peut √™tre test√© isol√©ment | Augmente fiabilit√© |
| **Maintenabilit√©** | Modifications localis√©es (ex: changer validation √©tape 2 sans toucher autres) | R√©duit risque r√©gression |
| **Tra√ßabilit√©** | Logs audit centralis√©s via Hook Op√©rations | Facilite debugging |
| **√âvolutivit√©** | Facile d'ajouter nouvelles √©tapes ou nouvelles fonctions OpenAI | Scalabilit√© assur√©e |
| **Compatibilit√©** | Pr√©serve `localStorage` temporairement pour Phase 2 | Migration progressive s√©curis√©e |
| **S√©curit√©** | RLS Supabase + validation double (client + serveur) | Protection donn√©es multi-tenant |
| **Performance** | Index sur `organisation_id`, `user_id`, `step_progress` | Requ√™tes rapides |
| **Conformit√©** | Respect strict naming convention (camelCase m√©tier + snake_case syst√®me) | Compatibilit√© OpenAI garantie |

---

## üéØ SYNTH√àSE

Cette strat√©gie garantit :
- ‚úÖ Migration **sans rupture** avec OpenAI et √âtape 6 Communication
- ‚úÖ Architecture **multi-tenant s√©curis√©e** (RLS + injection automatique)
- ‚úÖ **Modularit√© maximale** (5 couches ind√©pendantes)
- ‚úÖ **Tra√ßabilit√© compl√®te** (logs, triggers, audit)
- ‚úÖ **Navigation libre** entre √©tapes (via `step_progress`)
- ‚úÖ **Validation robuste** (client + serveur + CHECK constraints)
- ‚úÖ **R√©utilisabilit√©** (hooks strat√©giques existants)

**Cette strat√©gie est maintenant pr√™te pour l'impl√©mentation technique.** üöÄ

---
---

# üìä TABLEAU R√âCAPITULATIF - √âl√©ments √† Cr√©er pour la Migration Phase 1

## üìà BILAN QUANTITATIF GLOBAL

| Cat√©gorie | Total | √Ä Cr√©er | Existant (OK) | Existant (Adapter) |
|-----------|-------|---------|---------------|-------------------|
| **SQL (Fonctions + Triggers)** | 11 | 8 | 3 | - |
| **RLS Policies** | 2 | 2 | - | - |
| **Tables Supabase** | 1 | 1 | - | - |
| **Hooks React Business** | 5 | 5 | - | - |
| **Hooks React Progression** | 1 | 1 | - | - |
| **Hooks React Techniques** | 1 | - | - | 1 |
| **Services OpenAI** | 7 | 7 | - | - |
| **Utilitaires** | 12 | 12 | - | - |
| **Composants React** | ~8 | - | - | ~8 |
| **Contextes React** | 1 | - | - | 1 |
| **TOTAL G√âN√âRAL** | **49** | **36 (73%)** | **3 (6%)** | **10 (21%)** |
---

## 1Ô∏è‚É£ FONCTIONS SQL & TRIGGERS
**Total Fonctions SQL** : 11 (7 fonctions + 4 triggers)  
**√Ä cr√©er** : **8** (4 fonctions + 4 triggers) | **Existantes** : 3

| # | Nom | Type | Statut | Priorit√© | D√©pendances |
|---|-----|------|--------|----------|-------------|
| 1 | `get_user_organisation_id()` | Fonction SQL | ‚úÖ Existe | - | - |
| 2 | `is_admin_presenca()` | Fonction SQL | ‚úÖ Existe | - | - |
| 3 | `get_user_agence_indep_id()` | Fonction SQL | ‚úÖ Existe | - | - |
| 4 | `get_user_type_compte()` | Fonction SQL | üî¥ √Ä cr√©er | Haute | `users`, `utilisateurs` |
| 5 | `get_user_reseau_agence_id()` | Fonction SQL | üî¥ √Ä cr√©er | Haute | `users`, `utilisateurs` |
| 6 | `user_belongs_to_reseau_agence()` | Fonction SQL | üî¥ √Ä cr√©er | Haute | `utilisateurs` |
| 7 | `user_belongs_to_agence_indep()` | Fonction SQL | üî¥ √Ä cr√©er | Haute | `utilisateurs` |
| 8 | `set_updated_at_etapes1to5` | Trigger | üî¥ √Ä cr√©er | Haute | Table `etapes_1to5` |
| 9 | `set_validated_at` | Trigger | üî¥ √Ä cr√©er | Moyenne | Table `etapes_1to5` |
| 10 | `statut_du_projet` | Trigger | üî¥ √Ä cr√©er | Moyenne | Table `etapes_1to5` |
| 11 | `populate_analytical_fields_etapes1to5` | Trigger | üî¥ √Ä cr√©er | Haute | Fonctions SQL #4, #5 |
---

## 2Ô∏è‚É£ POLITIQUES RLS
**Total RLS** : 2  
**√Ä cr√©er** : **2**

| # | Nom | Table | Statut | Priorit√© |
|---|-----|-------|--------|----------|
| 1 | `admin_presenca_full_access_etapes1to5` | `etapes_1to5` | üî¥ √Ä cr√©er | Haute |
| 2 | `organisation_hierarchical_access_etapes1to5` | `etapes_1to5` | üî¥ √Ä cr√©er | Haute |
---

## 3Ô∏è‚É£ TABLE SUPABASE
**Total Tables** : 1  
**√Ä cr√©er** : **1**
| # | Nom | Colonnes | Statut | Priorit√© |
|---|-----|----------|--------|----------|
| 1 | `etapes_1to5` | 30 champs + contraintes CHECK | üî¥ √Ä cr√©er | Critique |
---

## 4Ô∏è‚É£ HOOKS REACT - BUSINESS

**Total Hooks Business : 5**
**√Ä cr√©er : 5**

| # | Nom           | Responsabilit√©                           | Statut     | Priorit√© | D√©pendances                   |
| - | ------------- | ---------------------------------------- | ---------- | -------- | ----------------------------- |
| 1 | `useEtape1()` | Gestion √âtape 1 (Informations G√©n√©rales) | üî¥ √Ä cr√©er | Haute    | `useSupabaseEtapesOperations` |
| 2 | `useEtape2()` | Gestion √âtape 2 (Type/Prix/Localisation) | üî¥ √Ä cr√©er | Haute    | `useSupabaseEtapesOperations` |
| 3 | `useEtape3()` | Gestion √âtape 3 (√âl√©ments Cl√©s)          | üî¥ √Ä cr√©er | Haute    | `useSupabaseEtapesOperations` |
| 4 | `useEtape4()` | Gestion √âtape 4 (Description)            | üî¥ √Ä cr√©er | Haute    | `useSupabaseEtapesOperations` |
| 5 | `useEtape5()` | Gestion √âtape 5 (D√©tails Financiers)     | üî¥ √Ä cr√©er | Haute    | `useSupabaseEtapesOperations` |

---

## 5Ô∏è‚É£ HOOKS REACT - PROGRESSION

**Total Hooks Progression :** 1 hook (+ 6 fonctions internes)
**√Ä cr√©er :** 1

| # | Nom                 | Responsabilit√©                         | Statut     | Priorit√© | D√©pendances                   |
| - | ------------------- | -------------------------------------- | ---------- | -------- | ----------------------------- |
| 1 | `useStepProgress()` | Hook central de gestion de progression | üî¥ √Ä cr√©er | Critique | `useSupabaseEtapesOperations` |

**Fonctions incluses dans `useStepProgress()` :**

* `markStepComplete(stepNumber)`
* `canAccessStep(stepNumber)`
* `goToNextStep()`
* `goToPreviousStep()`
* `resetProgress()`
* `getCurrentStepData()`

---

## 6Ô∏è‚É£ HOOKS REACT - TECHNIQUES

**Total Hooks Techniques : 2**
**Existants : 1 (inchang√©)**
**Nouveau : 1 (sp√©cifique √† `etapes_1to5`)**

| # | Nom                           | Responsabilit√©                         | Statut     | Priorit√© |
| - | ----------------------------- | -------------------------------------- | ---------- | -------- |
| 1 | `useSupabaseOperations`       | CRUD multi-tenant g√©n√©rique (inchang√©) | ‚úÖ Existe   | Haute    |
| 2 | `useSupabaseEtapesOperations` | CRUD d√©di√© √† la table `etapes_1to5`    | üü¢ Nouveau | Critique |

---

### 7Ô∏è‚É£ SERVICES OPENAI
**Total Services OpenAI** : 7  
**√Ä cr√©er** : **7**

| # | Nom | Responsabilit√© | Statut | Priorit√© | D√©pendances |
|---|-----|----------------|--------|----------|-------------|
| 1 | `generateWebsiteAd()` | G√©n√©ration annonce site web | üî¥ √Ä cr√©er | Haute | `mapSupabaseToPrompt()` |
| 2 | `generateFacebookAd()` | G√©n√©ration post Facebook | üî¥ √Ä cr√©er | Haute | `mapSupabaseToPrompt()` |
| 3 | `generateInstagramAd()` | G√©n√©ration post Instagram | üî¥ √Ä cr√©er | Haute | `mapSupabaseToPrompt()` |
| 4 | `generateLinkedInAd()` | G√©n√©ration post LinkedIn | üî¥ √Ä cr√©er | Haute | `mapSupabaseToPrompt()` |
| 5 | `generateEmailAd()` | G√©n√©ration email marketing | üî¥ √Ä cr√©er | Haute | `mapSupabaseToPrompt()` |
| 6 | `generateSMSAd()` | G√©n√©ration SMS | üî¥ √Ä cr√©er | Haute | `mapSupabaseToPrompt()` |
| 7 | `generatePrintAd()` | G√©n√©ration annonce presse | üî¥ √Ä cr√©er | Haute | `mapSupabaseToPrompt()` |

---

## 8Ô∏è‚É£ UTILITAIRES (HELPERS)
**Total Utilitaires** : 10  
**√Ä cr√©er** : **10**

#### 8.1 Formatage
| # | Nom | Responsabilit√© | Statut | Priorit√© |
|---|-----|----------------|--------|----------|
| 1 | `formatAddress()` | Formatage adresse compl√®te | üî¥ √Ä cr√©er | Moyenne |
| 2 | `formatDate()` | Formatage dates (ISO ‚Üí FR) | üî¥ √Ä cr√©er | Basse |


#### 8.2 Validation
| # | Nom | Responsabilit√© | Statut | Priorit√© |
|---|-----|----------------|--------|----------|
| 5 | `validateEtape1()` | Validation √âtape 1 | üî¥ √Ä cr√©er | Haute |
| 6 | `validateEtape2()` | Validation √âtape 2 | üî¥ √Ä cr√©er | Haute |
| 7 | `validateEtape3()` | Validation √âtape 3 | üî¥ √Ä cr√©er | Haute |
| 8 | `validateEtape4()` | Validation √âtape 4 | üî¥ √Ä cr√©er | Haute |
| 9 | `validateEtape5()` | Validation √âtape 5 | üî¥ √Ä cr√©er | Haute |

#### 8.3 Conversion / Mapping
| # | Nom | Responsabilit√© | Statut | Priorit√© |
|---|-----|----------------|--------|----------|
| 10 | `mapLocalStorageToSupabase()` | Migration localStorage ‚Üí Supabase | üî¥ √Ä cr√©er | Critique |
| 11 | `mapSupabaseToForm()` | Hydratation formulaires | üî¥ √Ä cr√©er | Haute |
| 12 | `mapSupabaseToPrompt()` | Pr√©paration prompts OpenAI | üî¥ √Ä cr√©er | Haute |
---

## 9Ô∏è‚É£ COMPOSANTS REACT
**Total Composants** : Existants  
**Action** : **0** ***Adaptation uniquement (pas de cr√©ation)***


| # | Nom | Type | Statut | Action |
|---|-----|------|--------|--------|
| 1 | Composants √âtapes 1-5 | Composants UI | ‚úÖ Existent | üîÑ √Ä adapter (Supabase) |


---

## üîü CONTEXTES REACT
**Total Contextes** : 1  
**Action** : **0** ***Adaptation uniquement***

| # | Nom | Responsabilit√© | Statut | Action |
|---|-----|----------------|--------|--------|
| 1 | `AnnonceContext` | √âtat global annonces | ‚úÖ Existe | üîÑ √Ä adapter (Supabase) |
---
---


## üó∫Ô∏è ROADMAP DE CR√âATION RECOMMAND√âE

### **Phase A - Fondations SQL** (Priorit√© Critique)

**Dur√©e estim√©e :** 2-3h
**Objectif :** Cr√©er l'infrastructure base de donn√©es

1. ‚úÖ Cr√©er 4 fonctions SQL helper (`get_user_type_compte`, `get_user_reseau_agence_id`, `user_belongs_to_reseau_agence`, `user_belongs_to_agence_indep`)
2. ‚úÖ Cr√©er table `etapes_1to5` avec contraintes CHECK
3. ‚úÖ Cr√©er 4 triggers (`set_updated_at`, `set_validated_at`, `statut_du_projet`, `populate_analytical_fields`)
4. ‚úÖ Cr√©er 2 politiques RLS
5. ‚úÖ Tester isolation multi-tenant

**D√©pendances :** Aucune
**Bloquant pour :** Phases B, C, D

---

### **Phase B - Hooks & Utilitaires** (Priorit√© Haute)

**Dur√©e estim√©e :** 4-5h  
**Objectif :** Cr√©er la couche logique React (li√©e aux √©tapes 1‚Üí5)

---

| √âtape | Action | D√©tail | Statut |
|--------|---------|---------|---------|
| 1 | Cr√©er 10 utilitaires | Formatage, validation, mapping (`src/components/HOOKS-ANNONCES/01.HOOKS-ETAPE1TO5/03.Utilitaires/`) | ‚úÖ Fait |
| 2 | Cr√©er hook central `useStepProgress()` | Gestion locale de la progression (6 fonctions internes) | ‚úÖ Fait |
| 3 | Cr√©er 5 hooks m√©tier (`useEtape1` √† `useEtape5`) | Un par √©tape fonctionnelle, int√©grant validateurs et mappers | ‚úÖ Fait |
| 4 | Cr√©er **`useSupabaseEtapesOperations`** | Sp√©cifique √† `etapes_1to5`, bas√© sur `useSupabaseOperations` sans le modifier | ‚úÖ Fait |

---

**D√©pendances :** Phase A termin√©e  
**Bloquant pour :** Phase C (Services OpenAI)

---

### **Phase C - Services OpenAI** (Priorit√© Haute)

**Dur√©e estim√©e :** 3-4h
**Objectif :** Cr√©er la g√©n√©ration de contenus

1. ‚úÖ Cr√©er 7 services OpenAI (site web, Facebook, Instagram, LinkedIn, Email, SMS, Print)
2. ‚úÖ Tester g√©n√©ration avec donn√©es r√©elles
3. ‚úÖ Valider qualit√© des prompts

**D√©pendances :** Phase B termin√©e (`mapSupabaseToPrompt()`)
**Bloquant pour :** Phase D

---

### **Phase D - Migration & Adaptation UI** (Priorit√© Moyenne)

**Dur√©e estim√©e :** 2-3h
**Objectif :** Finaliser l'int√©gration

1. ‚úÖ Adapter composants √âtapes 1-5 (Supabase au lieu de localStorage)
2. ‚úÖ Adapter `AnnonceContext` (Supabase)
3. ‚úÖ Cr√©er script migration `migrateExistingProjects()`
4. ‚úÖ Tester workflow complet utilisateur

**D√©pendances :** Phases A, B, C termin√©es
**Bloquant pour :** Mise en production

---

## ‚úÖ CHECKLIST DE VALIDATION FINALE

### SQL & Base de Donn√©es

* [ ] 4 fonctions SQL helper cr√©√©es et test√©es
* [ ] Table `etapes_1to5` cr√©√©e avec 30 champs
* [ ] 4 triggers fonctionnels (`updated_at`, `validated_at`, `statut_du_projet`, `populate_analytical_fields`)
* [ ] 2 politiques RLS actives et test√©es
* [ ] Contraintes CHECK valid√©es (`saleType` ‚Üí `price`/`rentAmount`)
* [ ] Indexes cr√©√©s sur `organisation_id`, `client_id`, `created_at`

### Hooks React

* [ ] `useStepProgress()` + 6 fonctions cr√©√©es
* [ ] 5 hooks m√©tier (`useEtape1` √† `useEtape5`) cr√©√©s
* [ ] **`useSupabaseEtapesOperations`** cr√©√© pour `etapes_1to5`
* [ ] Gestion erreurs robuste dans tous les hooks

### Services & Utilitaires

* [ ] 7 services OpenAI cr√©√©s et test√©s
* [ ] 10 utilitaires cr√©√©s (formatage, validation, mapping)
* [ ] `mapLocalStorageToSupabase()` test√© avec donn√©es r√©elles
* [ ] Validation m√©tier compl√®te (√âtapes 1-5)

### Migration & UI

* [ ] Composants √âtapes 1-5 adapt√©s (Supabase)
* [ ] `AnnonceContext` migr√© vers Supabase
* [ ] Script migration localStorage ex√©cut√©
* [ ] Tests utilisateur complets (cr√©ation ‚Üí validation ‚Üí OpenAI)

### Multi-Tenant & S√©curit√©

* [ ] Isolation stricte par `organisation_id` valid√©e
* [ ] Hi√©rarchie R√©seau/Agence/Ind√©pendant test√©e
* [ ] RLS emp√™che acc√®s inter-organisations
* [ ] Admins PRESENCA ont acc√®s global

### Performance & Monitoring

* [ ] Temps de r√©ponse CRUD < 200ms
* [ ] G√©n√©ration OpenAI < 5s
* [ ] Logs d'erreurs configur√©s
* [ ] Rollback localStorage pr√©vu en cas d'√©chec

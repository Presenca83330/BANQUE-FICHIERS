# Table : openai_usage_logs

## Objectif
Table dynamique de suivi des **utilisations OpenAI** (logs par requête).  
Elle permet d’auditer la consommation des tokens, par modèle, service, utilisateur et organisation.

Elle servira également de **source de mise à jour automatique** pour :
- le compteur `total_tokens_used` et la date `last_usage_at` de la table `openai_api_keys`,
- ainsi que pour le futur **contrôle du seuil `token_limit`** (Phase 2).

---

## Structure technique

| Table       | Code champ          | Description                            | Obligatoire | Facultatif | Condition de remplissage | Droits de modification tables | Droits de modification presenca | Type SQL | Clé primaire (PK) | Clé étrangère (FK) | Référence vers table | Contraintes Supabase | Type d'identifiant | Actions à prévoir |
|:------------|:--------------------|:---------------------------------------|:------------|:-----------|:-------------------------|:------------------------------|:--------------------------------|:---------|:------------------|:-------------------|:---------------------|:---------------------|:-------------------|:------------------|
| `openai_usage_logs` | `id` | Identifiant unique du log | ✅ | ❌ | Auto généré | ❌ | ✅ | `uuid` | ✅ | ❌ | - | DEFAULT uuid_generate_v4() | `uuid` | - |
|  | `organisation_id` | Organisation du user | ✅ | ❌ | Liée à user connecté | ✅ | ✅ | `uuid` | ❌ | ✅ | `organisations.id` | FK | `uuid` | Index |
|  | `user_id` | Utilisateur à l’origine de l’appel | ✅ | ❌ | Depuis auth.user() | ✅ | ✅ | `uuid` | ❌ | ✅ | `users.id` | FK | `uuid` | Index |
|  | `service_name` | Nom du service appelé | ✅ | ❌ | Nom de la fonction (`generateWebsiteAd`, etc.) | ✅ | ✅ | `text` | ❌ | ❌ | - | - | `text` | - |
|  | `model` | Modèle utilisé | ✅ | ❌ | “gpt-5-mini-2025-08-07” | ✅ | ✅ | `text` | ❌ | ❌ | - | CHECK != '' | `text` | - |
|  | `tokens_used` | Total de tokens utilisés | ✅ | ❌ | Renvoyé par API OpenAI | ✅ | ✅ | `integer` | ❌ | ❌ | - | CHECK >= 0 | `integer` | **Trigger MAJ table clés** |
|  | `prompt_tokens` | Tokens d’entrée | ❌ | ✅ | Renvoyé par usage.prompt_tokens | ✅ | ✅ | `integer` | ❌ | ❌ | - | CHECK >= 0 | `integer` | - |
|  | `completion_tokens` | Tokens de sortie | ❌ | ✅ | Renvoyé par usage.completion_tokens | ✅ | ✅ | `integer` | ❌ | ❌ | - | CHECK >= 0 | `integer` | - |
|  | `created_at` | Date de l’appel | ✅ | ❌ | Auto généré | ✅ | ✅ | `timestamp` | ❌ | ❌ | - | DEFAULT now() | `timestamp` | - |

---

## Fonctionnement
- Chaque appel OpenAI insère un enregistrement dans `openai_usage_logs`.
- Un **trigger** met à jour les champs `total_tokens_used` et `last_usage_at` de `openai_api_keys`.
- Cette table constitue la **source de référence** pour :
  - le suivi de la consommation des tokens par clé,
  - la vérification du respect du quota `token_limit` (Phase 2),
  - et le reporting analytique.

---

## Règles RLS
- Les utilisateurs ne voient que les logs de leur propre organisation.  
- `admin_presenca` a un accès complet (lecture + suppression).  
- Aucun utilisateur ne peut modifier un log existant.

---

## Actions à prévoir
1. Création du trigger `update_token_counters` entre `openai_usage_logs` et `openai_api_keys`.  
2. Mise à jour automatique de `total_tokens_used` et `last_usage_at`.  
3. Vérification périodique du dépassement du `token_limit` (inactif Phase 1, actif Phase 2).  
4. Validation des RLS organisationnelles.  
5. Préparation du dashboard d’audit d’utilisation IA (Phase 2).

---

# **Explication des champs – Tables `openai_usage_logs`**

## Objectif global
Enregistrer chaque **appel OpenAI** effectué depuis l’application :  
modèle, service, utilisateur, organisation, et nombre de tokens utilisés.  
Cette table est essentielle pour le **suivi de la consommation IA** et la **traçabilité des coûts**.

Elle permet aussi de **mettre à jour automatiquement** :
- la consommation cumulée (`total_tokens_used`) dans `openai_api_keys`,  
- la date de dernier usage (`last_usage_at`),  
- et à terme, d’activer le **contrôle de quotas (`token_limit`, `alert_threshold`)**.

---

### Détail des champs

| Champ | Titre | Objectif | Fonctionnement | Rôle | Utilisation | Utilisée par | Trigger SQL | Type SQL & Contraintes | Valeurs possibles | Interdictions |
|--------|--------|-----------|----------------|------|--------------|---------------|--------------|------------------------|------------------|----------------|
| `id` | Identifiant log | Identifier chaque requête | Généré automatiquement | Clé primaire | Audit | Tous | DEFAULT uuid | `uuid` | Unique | Null interdit |
| `organisation_id` | Organisation | Lier le log à l’organisation | `user.organisation_id` | Hiérarchie | Reporting multi-tenant | Dashboard IA | FK vers organisations | `uuid` | UUID valide | - |
| `user_id` | Utilisateur | Identifier l’auteur de la requête | `auth.user().id` | Audit IA | Audit, suivi utilisateur | Admin Presenca | FK users | `uuid` | UUID valide | - |
| `service_name` | Service appelé | Identifier la fonction IA | Renseigné par le service OpenAI | Audit et reporting | `generateWebsiteAd`, `generateNewsletterAd`, etc. | Tous services IA | - | `text` | - | Null interdit |
| `model` | Modèle utilisé | Identifier le modèle OpenAI | `"gpt-5-mini-2025-08-07"` | Audit IA | Reporting | Tous services IA | - | `text` | Non vide | Null interdit |
| `tokens_used` | Total tokens utilisés | Mesurer la consommation | Renvoyé par OpenAI (`usage.total_tokens`) | Analyse IA | `openai_api_keys.total_tokens_used` | Trigger MAJ clé | CHECK >= 0 | `integer` | >= 0 | Null interdit |
| `prompt_tokens` | Tokens prompt | Compter l’entrée utilisateur | Renvoyé par OpenAI (`usage.prompt_tokens`) | Audit IA | - | - | CHECK >= 0 | `integer` | >= 0 | - |
| `completion_tokens` | Tokens complétion | Compter la sortie IA | Renvoyé par OpenAI (`usage.completion_tokens`) | Audit IA | - | - | CHECK >= 0 | `integer` | >= 0 | - |
| `created_at` | Date de création | Audit | Auto-généré | Historique | Admin | - | DEFAULT now() | `timestamp` | - | - |

---

### Triggers et automatisations
- **Trigger 1 :** incrémente `total_tokens_used` et met à jour `last_usage_at` dans `openai_api_keys`.  
- **Trigger 2 :** interdit la modification ou suppression d’un log existant.  
- **Trigger 3 (prévu Phase 2) :** vérifie le dépassement du `token_limit` et désactive la clé si nécessaire (`is_active = false`).  

---

### Règles RLS
| Rôle | Accès |
|------|--------|
| Utilisateur standard | Lecture seule sur ses propres logs (organisation_id) |
| `admin_presenca` | Lecture et écriture complètes |
| Autres organisations | Accès interdit |

---

### Interdictions
- Insertion d’un log sans `organisation_id` ou `user_id`.  
- Suppression manuelle d’un log interdite.  
- Modification d’un champ `tokens_used` après insertion interdite.  
- Écriture directe dans `openai_api_keys` hors trigger interdite.

---

### Intégration et utilisation
- Appelé par les services OpenAI (`generateWebsiteAd`, `generateNewsletterAd`, etc.) à chaque réponse de l’API.  
- Permet d’alimenter un futur **dashboard d’utilisation IA**.  
- Sert de base au calcul de coûts ou quotas personnalisés par client.  
- Interconnecté à la table `openai_api_keys` pour la mise à jour des compteurs et du suivi de quota.

---

## Synthèse
| Table | Type | Rôle |
|--------|------|------|
| `openai_usage_logs` | Dynamique | Suivi de consommation des tokens, mise à jour des compteurs et contrôle futur des quotas (`token_limit`) |

---

# üìÑ Documentation compl√®te - √âtape 4 : Informations Compl√©mentaires


## MISSION DU DOCUMENT

Ce document d√©crit le fonctionnement complet de l'**√âtape 4** du processus de g√©n√©ration d'annonces immobili√®res dans LeadGenAI AdBuilder.

**Objectif de l'√âtape 4** : Permettre aux utilisateurs de saisir des **informations compl√©mentaires optionnelles** sur le bien (horaires d'ouverture, p√©riodes de fermeture, autres d√©tails d'exploitation) qui seront **uniquement utilis√©es dans l'Annonce Fiche de Synth√®se**.

Cette √©tape est **optionnelle** mais l'utilisateur doit **obligatoirement faire un choix** :
- Soit cocher "Je n'ai pas d'informations compl√©mentaires √† fournir"
- Soit saisir des informations dans le champ texte

---

## SOMMAIRE CLIQUABLE

- [I. ARCHITECTURE GLOBALE - √âTAPE 4](#i-architecture-globale---√©tape-4)
- [II. FICHIERS UTILIS√âS (Liste exhaustive)](#ii-fichiers-utilis√©s-liste-exhaustive)
- [III. STRUCTURE DES DONN√âES DANS localStorage](#iii-structure-des-donn√©es-dans-localstorage)
- [IV. LOGIQUE DE VALIDATION DES CHAMPS](#iv-logique-de-validation-des-champs)
- [V. CONTRAINTES ET R√àGLES M√âTIER](#v-contraintes-et-r√®gles-m√©tier)
- [VI. NAVIGATION ET RETOUR EN ARRI√àRE](#vi-navigation-et-retour-en-arri√®re)
- [VII. UTILISATION DES DONN√âES PAR OPENAI](#vii-utilisation-des-donn√©es-par-openai)
- [VIII. PROCESSUS COMPLET √âTAPE PAR √âTAPE](#viii-processus-complet-√©tape-par-√©tape)
- [IX. √âL√âMENTS CACH√âS / CONDITIONNELS](#ix-√©l√©ments-cach√©s--conditionnels)
- [X. TIMER DE SESSION (D√âSACTIV√â MAIS PR√âSENT)](#x-timer-de-session-d√©sactiv√©-mais-pr√©sent)
- [XI. R√âCAPITULATIF DES CL√âS localStorage](#xi-r√©capitulatif-des-cl√©s-localstorage)
- [XII. DONN√âES DE L'√âTAPE 4 √Ä PRENDRE EN CONSID√âRATION](#xii-donn√©es-de-l√©tape-4-√†-prendre-en-consid√©ration)

---

## I. ARCHITECTURE GLOBALE - √âTAPE 4

### Vue d'ensemble

L'√âtape 4 permet de collecter des **informations compl√©mentaires optionnelles** sur le bien commercial :
- Horaires d'ouverture
- P√©riodes de fermeture
- Autres d√©tails d'exploitation

**Particularit√©s de l'√âtape 4** :
- √âtape **optionnelle** mais choix **obligatoire**
- Checkbox "Je n'ai pas d'informations compl√©mentaires" disponible
- Les donn√©es sont **uniquement utilis√©es dans la Fiche de Synth√®se** (pas dans les autres annonces)
- Utilisation du composant `FormulaireSaisie` avec formatage automatique (puces, capitalisation, hauteur dynamique)

### Flux de donn√©es simplifi√©es

```
√âtape 3 (valid√©e) 
    ‚Üì
Arriv√©e sur √âtape 4 
    ‚Üì
Chargement des donn√©es depuis localStorage.propertyData
    ‚Üì
Affichage du formulaire (pr√©-rempli ou vide)
    ‚Üì
Utilisateur coche checkbox OU saisit informations
    ‚Üì
Validation (choix obligatoire)
    ‚Üì
Sauvegarde dans localStorage.propertyData.details (ou hasNoDetails)
    ‚Üì
completeStep(4) ‚Üí ajout √©tape 5 √† stepProgress
    ‚Üì
Navigation vers /etape5
```

### Sch√©ma complet mermaid

```mermaid
graph TD
    A[Chargement Etape4.tsx] --> B[useStepProgress v√©rifie acc√®s]
    B -->|√âtape 4 non disponible| C[Redirection /etape1]
    B -->|√âtape 4 disponible| D[Affichage SaisieDetailsForm]
    D --> E[useEffect: R√©cup√©ration propertyData]
    E --> F{Donn√©es existantes?}
    F -->|details existe| G1[Pre-remplir details + hasNoDetails=false]
    F -->|hasNoDetails=true| G2[Checkbox coch√©e + details vide]
    F -->|Aucune donn√©e| G3[√âtat initial vide]
    G1 --> H[Affichage FormulaireSaisie]
    G2 --> H
    G3 --> H
    H --> I{Utilisateur fait un choix}
    I -->|Coche checkbox| J1[hasNoDetails=true + details vide]
    I -->|Saisit informations| J2[handleDetailsChange: mise √† jour state details]
    J1 --> K[Clic sur BoutonValiderInformations]
    J2 --> K
    K --> L{Validation}
    L -->|hasNoDetails=false ET details vide| M[Toast erreur: choix obligatoire]
    L -->|hasNoDetails=true OU details non vide| N[updatePropertyData avec details + hasNoDetails]
    N --> O[Sauvegarde dans localStorage.propertyData]
    O --> P[completeStep 4: ajout √©tape 5 √† stepProgress]
    P --> Q[Toast succ√®s adapt√©]
    Q --> R[Navigation vers /etape5]

    style C fill:#ff6b6b
    style M fill:#ff6b6b
    style R fill:#51cf66
```

### D√©tail du flux

1. **Chargement initial** : `Etape4.tsx` charge, `useStepProgress(4)` v√©rifie l'acc√®s
2. **V√©rification acc√®s** : Si √©tape 4 non disponible ‚Üí redirection `/etape1`
3. **Affichage formulaire** : `SaisieDetailsForm` s'affiche avec :
   - Checkbox "Je n'ai pas d'informations compl√©mentaires"
   - `FormulaireSaisie` pour saisie libre
   - `BoutonValiderInformations` pour validation
4. **Chargement donn√©es** : `useEffect` r√©cup√®re `propertyData` depuis `localStorage` et pr√©-remplit si disponible
5. **Interaction utilisateur** :
   - Option A : Coche checkbox ‚Üí `hasNoDetails=true` + `details` vid√©
   - Option B : Saisit informations ‚Üí `details` mis √† jour + `hasNoDetails=false` (auto)
6. **Validation** :
   - Si `!hasNoDetails` ET `details` vide ‚Üí **Erreur** : choix obligatoire
   - Sinon ‚Üí Sauvegarde via `updatePropertyData({ details, hasNoDetails })`
7. **Progression** : `completeStep(4)` ajoute l'√©tape 5 √† `stepProgress` dans `localStorage`
8. **Navigation** : Redirection vers `/etape5`

---

## II. FICHIERS UTILIS√âS (Liste exhaustive)

### 1. `src/1.etapes-generation-annonces/etape4/Etape4.tsx`
**R√¥le** : Page principale de l'√âtape 4

**Responsabilit√©s** :
- Structure de la page avec layout `LayoutV2GenAnn`
- Hero section avec titre et description
- Int√©gration du formulaire `SaisieDetailsForm`
- Menu lat√©ral avec `DirectivesMenuOnglet` et `EtapeFAQ`

**Code cl√©** :
```tsx
const { disabledSteps, completeStep, isStepAvailable } = useStepProgress(4);

React.useEffect(() => {
  if (!isStepAvailable(4)) {
    navigate("/etape1");
  }
}, [isStepAvailable, navigate]);
```

---

### 2. `src/components/1-Sources-Generation-Annonces/form-etape4/SaisieDetailsForm.tsx`
**R√¥le** : Composant principal du formulaire de l'√âtape 4

**√âtats g√©r√©s** :
```tsx
const [details, setDetails] = useState("");
const [hasNoDetails, setHasNoDetails] = useState(false);
```

**Fonctions cl√©s** :

**a) `handleDetailsChange`** : Mise √† jour du champ `details`
```tsx
const handleDetailsChange = (e: React.ChangeEvent) => {
  setDetails(e.target.value);
  if (e.target.value.trim() !== "") {
    setHasNoDetails(false);
  }
};
```

**b) `handleHasNoDetailsChange`** : Gestion de la checkbox
```tsx
const handleHasNoDetailsChange = (value: boolean) => {
  setHasNoDetails(value);
  if (value === true) {
    setDetails("");
  }
};
```

**c) `handleValidation`** : Validation du formulaire
```tsx
const handleValidation = () => {
  if (!hasNoDetails && details.trim() === "") {
    toast({
      title: "Attention",
      description: "Cette √©tape est optionnelle, mais vous devez indiquer votre choix. Soit cocher la case 'Je n'ai pas d'informations compl√©mentaires √† fournir', soit saisir des informations.",
      duration: 5000,
    });
    return;
  }

  updatePropertyData({ 
    details: details,
    hasNoDetails: hasNoDetails
  });

  toast({
    title: "Informations valid√©es",
    description: hasNoDetails 
      ? "Vous avez indiqu√© ne pas avoir d'informations compl√©mentaires." 
      : "Vos informations compl√©mentaires ont √©t√© enregistr√©es avec succ√®s.",
    duration: 3000,
  });

  completeStep(4);
  navigate('/etape5');
};
```

**d) `handleBackToEtape5`** : Retour vers √âtape 5 (modification)
```tsx
const handleBackToEtape5 = () => {
  if (!hasNoDetails && details.trim()) {
    updatePropertyData({ details });
    toast({
      title: "Modifications sauvegard√©es",
      description: "Vos modifications ont √©t√© enregistr√©es avant de retourner √† l'√©tape finale.",
      duration: 3000,
    });
  } else if (hasNoDetails) {
    updatePropertyData({ 
      details: "",
      hasNoDetails: true
    });
  }
  goToEtape5();
};
```

**e) `useEffect` - Chargement des donn√©es** :
```tsx
useEffect(() => {
  const propertyData = getPropertyDataFromStorage();

  if (propertyData.details) {
    setDetails(propertyData.details);
    setHasNoDetails(false);
  } else if (propertyData.hasNoDetails) {
    setHasNoDetails(true);
    setDetails("");
  } else {
    setHasNoDetails(false);
    setDetails("");
  }
}, []);
```

---

### 3. `src/components/1-Sources-Generation-Annonces/form-components/FormulaireSaisie.tsx`
**R√¥le** : Textarea avanc√© avec formatage automatique

**Fonctionnalit√©s** :
- Ajout automatique de puces (`‚Ä¢`) en d√©but de ligne
- Capitalisation automatique apr√®s la puce
- Hauteur dynamique selon le contenu
- Support `readOnly` quand checkbox coch√©e

**Code cl√©** :
```tsx
const handleInputChange = (e: React.ChangeEvent) => {
  const formattedText = newText.split('\n').map(line => {
    // Ajout automatique de '‚Ä¢ ' si ligne non vide et sans pr√©fixe
    if (!line.trimStart().startsWith('‚Ä¢') && 
        !line.trimStart().startsWith('‚ñ†') && 
        !line.trimStart().startsWith('.') && 
        line.trim() !== '') {
      formattedLine = spacesPrefix + '‚Ä¢ ' + line.trimStart();
    }
    // Capitalisation de la premi√®re lettre apr√®s '‚Ä¢ '
    if (trimmedLine.startsWith('‚Ä¢ ')) {
      formattedLine = spacesPrefix + '‚Ä¢ ' + afterPrefix.charAt(0).toUpperCase() + afterPrefix.slice(1);
    }
    return formattedLine;
  }).join('\n');

  onChange(newEvent);
};
```

---

### 4. `src/components/1-Sources-Generation-Annonces/form-components/BoutonValiderInformations.tsx`
**R√¥le** : Bouton de validation stylis√©

**Props** :
```tsx
interface BoutonValiderInformationsProps {
  onClick?: () => void;
  disabled?: boolean;
  width?: string;
  height?: string;
  className?: string;
}
```

---

### 5. `src/components/1-Sources-Generation-Annonces/help/SgaHelpBox.tsx`
**R√¥le** : Bo√Æte d'aide contextuelle

**Props** :
```tsx
interface SgaHelpBoxProps {
  title: string;
  content: React.ReactNode;
  icon?: React.ReactNode;
  className?: string;
}
```

**Contenu d'aide √âtape 4** (dans `SaisieDetailsForm.tsx`) :
```tsx
const helpContent = (
  <>
    Cette √©tape est optionnelle.
Vous pouvez n√©anmoins l'utiliser pour lister toutes les informations compl√©mentaires en votre possession sur le bien.
Les donn√©es saisies ici seront uniquement utilis√©es dans la Fiche de Synth√®se, pour apporter des pr√©cisions utiles sur les conditions d'exploitation du bien.
Propositions d'informations √† inclure : 
. List√©es et organis√©es dans votre Fiche de Synth√®se.

      Horaires d'ouverture
      P√©riodes de fermeture
      Autres donn√©es utiles d'exploitation

    Plus vous fournissez d'informations pr√©cises, plus l'IA pourra g√©n√©rer une annonce originale, sur-mesure et percutante..

);
```

---

### 6. `src/components/1-Sources-Generation-Annonces/help/EtapeFAQ.tsx`
**R√¥le** : FAQ contextuelle selon l'√©tape

**Contenu FAQ √âtape 4** :
```tsx
case "etape4":
  titre = "Quelles informations int√©grer ?";
  icon = ;
  contenu = (
    <>
      . Horaires d'ouverture : jours et heures d'exploitation
      . P√©riodes de fermeture : cong√©s annuels, jours de fermeture r√©guliers
      . Autres informations utiles : conditions particuli√®res d'exploitation, mentions r√©glementaires, remarques diverses...

        Plus vous fournissez d'informations pr√©cises, plus l'IA pourra g√©n√©rer une annonce originale, sur-mesure et percutante.

  );
```

---

### 7. `src/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet.tsx`
**R√¥le** : Menu de navigation entre √©tapes

**Props re√ßues depuis √âtape 4** :
```tsx

```

---

### 8. `src/components/1-Sources-Generation-Annonces/utils/useStepProgress.ts`
**R√¥le** : Hook de gestion de la progression

**Fonctions utilis√©es dans √âtape 4** :
- `completeStep(4)` : Marque l'√©tape 4 comme compl√©t√©e et d√©bloque l'√©tape 5
- `isStepAvailable(4)` : V√©rifie si l'√©tape 4 est accessible
- `goToEtape5()` : Navigation vers l'√©tape 5 (utilis√© pour retour arri√®re)
- `disabledSteps` : Liste des √©tapes d√©sactiv√©es pour le menu

---

### 9. `src/services/openai.ts`
**R√¥le** : Service de g√©n√©ration d'annonces via OpenAI

**Interface PropertyData** (extrait) :
```tsx
export interface PropertyData {
  // ... (autres champs des √©tapes 1, 2, 3)

  // √âtape 4 - Autres d√©tails
  details?: string;
  hasNoDetails?: boolean;
}
```

**Utilisation de `details` dans les prompts OpenAI** :

**a) `generateSummarySheetAd`** (Fiche de Synth√®se) :
```tsx
const userPrompt = promptAnnonceFichedeSynthese
  // ... (autres remplacements)
  .replace(/\[informations compl√©mentaires\]/g, data.details || "");
```

**Important** : Le champ `details` est **UNIQUEMENT** utilis√© dans la **Fiche de Synth√®se**, pas dans les autres annonces (Site Internet, Newsletter, Outils SEO, SMS, Google Business Profile, R√©seaux Sociaux).

---

### 10. `src/services/openai/1.GenerateurAnnoncesOutilsSeo/7.PromptsOpenAi/2.PromptAnnonceFichedeSynthese.ts`
**R√¥le** : Prompt OpenAI pour la Fiche de Synth√®se

**Utilisation de `[informations compl√©mentaires]`** :
```
Prise en compte des informations
...
. Autres d√©tails: [informations compl√©mentaires]

STRUCTURE DE L'ANNONCE FICHE DE SYNTHESE
...
Troisi√®me sous-partie
Autres D√©tails 
. Pr√©sente les informations compl√©mentaires uniquement si le champ "Autres d√©tails" est renseign√©. 
. Si une information est absente, n'invente rien, passe √† la suivante.
Si aucune donn√©e "Autres D√©tails" n'est transmise, supprime cette section dans son int√©gralit√©, y compris le titre. 
. Ne r√©dige jamais la rubrique "Autres D√©tails" si les informations sont absentes.
```

---

### 11. `src/components/navigation-site-leadgenaiadbuilder/NavLinks.tsx`
**R√¥le** : Configuration de la navigation globale

**Lien vers √âtape 4** :
```tsx
export const navLinks: NavigationLink[] = [
  // ...
  {
    label: "4. Infos Compl√©mentaires",
    path: "/etape4",
  },
  // ...
];
```

---

### 12. `src/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn.tsx`
**R√¥le** : Layout global des pages de g√©n√©ration d'annonces

**Utilis√© par** : `Etape4.tsx`

---

## III. STRUCTURE DES DONN√âES DANS localStorage

### Cl√©s principales utilis√©es par l'√âtape 4

#### 1. `propertyData` (Objet JSON)

**Champs ajout√©s/modifi√©s par l'√âtape 4** :

| Champ | Type | Description | Valeur par d√©faut |
|-------|------|-------------|-------------------|
| `details` | `string` | Informations compl√©mentaires sur le bien (horaires, fermeture, etc.) | `""` |
| `hasNoDetails` | `boolean` | Indique si l'utilisateur n'a pas d'informations compl√©mentaires | `false` |

**Exemple de `propertyData` apr√®s √âtape 4** :
```json
{
  "agencyName": "Cabinet Presenca",
  "reference": "REF-2025-001",
  "exclusivite": "Oui",
  "location": "Paris 16√®me",
  "propertyType": "Restaurant",
  "saleType": "√† vendre",
  "price": "350000",
  "keyElements": "Terrasse, Emplacement premium, Client√®le √©tablie",
  "propertyDescription": "‚Ä¢ Restaurant situ√© dans un quartier anim√©\n‚Ä¢ Terrasse de 40m¬≤\n‚Ä¢ Cuisine enti√®rement √©quip√©e",
  "financials": "‚Ä¢ CA annuel: 450 000 ‚Ç¨\n‚Ä¢ EBE: 18%\n‚Ä¢ Bail 3/6/9 renouvelable",
  "details": "‚Ä¢ Ouvert du mardi au dimanche\n‚Ä¢ Fermeture annuelle en ao√ªt\n‚Ä¢ Licence IV",
  "hasNoDetails": false
}
```

**Exemple si checkbox coch√©e** :
```json
{
  // ... (autres champs)
  "details": "",
  "hasNoDetails": true
}
```

---

#### 2. `stepProgress` (Array JSON)

**R√¥le** : Suivi de la progression de l'utilisateur

**Modification par l'√âtape 4** :
- Avant validation : `[1, 2, 3, 4]`
- Apr√®s validation (`completeStep(4)`) : `[1, 2, 3, 4, 5]`

**Code** :
```tsx
const completeStep = (step: number) => {
  const nextStep = step + 1;
  const newAvailableSteps = [...new Set([...availableSteps, nextStep])];
  setAvailableSteps(newAvailableSteps);
  localStorage.setItem('stepProgress', JSON.stringify(newAvailableSteps));
};
```

---

#### 3. `generation_*` (Cl√©s de g√©n√©ration)

**Non modifi√©es par l'√âtape 4** - G√©n√©r√©es ult√©rieurement √† l'√âtape 5 :
- `generation_website_ad`
- `generation_summary_sheet` (utilise `details`)
- `generation_newsletter`
- `generation_seo_tools`
- `generation_sms_ad`
- `generation_google_business_ad`
- `generation_social_media_ad`

---

## IV. LOGIQUE DE VALIDATION DES CHAMPS

### R√®gle de validation unique

**Validation obligatoire de choix** :

| Condition | R√©sultat |
|-----------|----------|
| `hasNoDetails === false` ET `details.trim() === ""` | ‚ùå **Erreur** : "Cette √©tape est optionnelle, mais vous devez indiquer votre choix. Soit cocher la case 'Je n'ai pas d'informations compl√©mentaires √† fournir', soit saisir des informations." |
| `hasNoDetails === true` | ‚úÖ **Valide** : Sauvegarde avec `details=""` et `hasNoDetails=true` |
| `details.trim() !== ""` | ‚úÖ **Valide** : Sauvegarde avec `details` et `hasNoDetails=false` |

**Code de validation** :
```tsx
const handleValidation = () => {
  if (!hasNoDetails && details.trim() === "") {
    toast({
      title: "Attention",
      description: "Cette √©tape est optionnelle, mais vous devez indiquer votre choix. Soit cocher la case 'Je n'ai pas d'informations compl√©mentaires √† fournir', soit saisir des informations.",
      duration: 5000,
    });
    return;
  }

  // Validation r√©ussie
  updatePropertyData({ 
    details: details,
    hasNoDetails: hasNoDetails
  });

  // Toast adapt√© selon le choix
  toast({
    title: "Informations valid√©es",
    description: hasNoDetails 
      ? "Vous avez indiqu√© ne pas avoir d'informations compl√©mentaires." 
      : "Vos informations compl√©mentaires ont √©t√© enregistr√©es avec succ√®s.",
    duration: 3000,
  });

  completeStep(4);
  navigate('/etape5');
};
```

---

## V. CONTRAINTES ET R√àGLES M√âTIER

### 1. R√®gles d'acc√®s

| R√®gle | Description |
|-------|-------------|
| **Progression s√©quentielle** | L'utilisateur doit avoir valid√© l'√âtape 3 pour acc√©der √† l'√âtape 4 |
| **V√©rification au chargement** | `useStepProgress(4)` v√©rifie si `stepProgress` contient `4` |
| **Redirection automatique** | Si √©tape 4 non disponible ‚Üí redirection `/etape1` |

**Code** :
```tsx
React.useEffect(() => {
  if (!isStepAvailable(4)) {
    navigate("/etape1");
  }
}, [isStepAvailable, navigate]);
```

---

### 2. R√®gles de saisie

| R√®gle | Description |
|-------|-------------|
| **Formatage automatique** | `FormulaireSaisie` ajoute automatiquement des puces (`‚Ä¢`) en d√©but de ligne |
| **Capitalisation** | Premi√®re lettre apr√®s la puce automatiquement en majuscule |
| **Hauteur dynamique** | Le textarea s'ajuste automatiquement √† la hauteur du contenu |
| **ReadOnly conditionnel** | Si `hasNoDetails=true`, le textarea devient `readOnly` |

---

### 3. R√®gles de navigation

| Sc√©nario | Comportement |
|----------|--------------|
| **Validation r√©ussie** | Navigation vers `/etape5` + ajout de l'√©tape 5 √† `stepProgress` |
| **Retour arri√®re depuis √âtape 5** | Fonction `handleBackToEtape5()` sauvegarde les modifications avant retour |
| **Menu lat√©ral** | Seules les √©tapes d√©bloqu√©es sont cliquables (`disabledSteps`) |

---

### 4. R√®gles de persistance des donn√©es

| Action | Effet sur `localStorage` |
|--------|--------------------------|
| **Validation** | Sauvegarde `details` et `hasNoDetails` dans `propertyData` |
| **Modification depuis √âtape 5** | Sauvegarde automatique avant retour via `handleBackToEtape5()` |
| **Nouveau projet** | `clearPropertyData()` efface toutes les donn√©es, y compris `details` |

---

## VI. NAVIGATION ET RETOUR EN ARRI√àRE

### 1. Arriv√©e sur l'√âtape 4

**Depuis √âtape 3** :
- Validation de l'√âtape 3 ‚Üí `completeStep(3)` ajoute `4` √† `stepProgress`
- Navigation vers `/etape4`
- `useStepProgress(4)` autorise l'acc√®s
- `useEffect` charge les donn√©es existantes (si modification)

**Code de chargement** :
```tsx
useEffect(() => {
  const propertyData = getPropertyDataFromStorage();

  if (propertyData.details) {
    setDetails(propertyData.details);
    setHasNoDetails(false);
  } else if (propertyData.hasNoDetails) {
    setHasNoDetails(true);
    setDetails("");
  } else {
    setHasNoDetails(false);
    setDetails("");
  }
}, []);
```

---

### 2. Navigation vers √âtape 5

**Apr√®s validation** :
```tsx
completeStep(4);  // Ajoute 5 √† stepProgress
navigate('/etape5');
```

---

### 3. Retour arri√®re depuis √âtape 5

**Sc√©nario** : L'utilisateur clique sur "Modifier" pour l'√âtape 4 depuis l'√âtape 5

**Comportement** :
- Fonction `handleBackToEtape5()` appel√©e
- Si `details` contient des donn√©es ‚Üí Sauvegarde via `updatePropertyData({ details })`
- Si `hasNoDetails=true` ‚Üí Sauvegarde via `updatePropertyData({ details: "", hasNoDetails: true })`
- Navigation vers `/etape5` via `goToEtape5()`

**Code** :
```tsx
const handleBackToEtape5 = () => {
  if (!hasNoDetails && details.trim()) {
    updatePropertyData({ details });
    toast({
      title: "Modifications sauvegard√©es",
      description: "Vos modifications ont √©t√© enregistr√©es avant de retourner √† l'√©tape finale.",
      duration: 3000,
    });
  } else if (hasNoDetails) {
    updatePropertyData({ 
      details: "",
      hasNoDetails: true
    });
  }
  goToEtape5();
};
```

---

### 4. Modification du menu lat√©ral

**Comportement** :
- `DirectivesMenuOnglet` re√ßoit `activeStep={4}` et `disabledSteps`
- Les √©tapes non d√©bloqu√©es sont gris√©es et non cliquables
- L'utilisateur peut revenir aux √©tapes pr√©c√©dentes (1, 2, 3) si d√©j√† valid√©es

---

## VII. UTILISATION DES DONN√âES PAR OPENAI

### üö® IMPORTANT : Usage limit√© √† la Fiche de Synth√®se

Le champ `details` (informations compl√©mentaires) est **UNIQUEMENT** utilis√© dans la g√©n√©ration de l'**Annonce Fiche de Synth√®se**.

**Il n'est PAS utilis√© dans** :
- ‚ùå Annonce Site Internet
- ‚ùå Annonce Newsletter
- ‚ùå Outils SEO
- ‚ùå Annonce SMS
- ‚ùå Annonce Google Business Profile
- ‚ùå Annonce R√©seaux Sociaux

---

### 1. G√©n√©ration Fiche de Synth√®se (`generateSummarySheetAd`)

**Fichier** : `src/services/openai.ts` (lignes 209-248)

**Remplacement du placeholder** :
```tsx
const userPrompt = promptAnnonceFichedeSynthese
  // ... (autres remplacements)
  .replace(/\[informations compl√©mentaires\]/g, data.details || "");
```

**Prompt** : `2.PromptAnnonceFichedeSynthese.ts`

**Section concern√©e dans le prompt** :
```
Prise en compte des informations
...
. Autres d√©tails: [informations compl√©mentaires]

STRUCTURE DE L'ANNONCE FICHE DE SYNTHESE
...
Troisi√®me sous-partie
Autres D√©tails 
. Pr√©sente les informations compl√©mentaires uniquement si le champ "Autres d√©tails" est renseign√©. 
. Si une information est absente, n'invente rien, passe √† la suivante.
Si aucune donn√©e "Autres D√©tails" n'est transmise, supprime cette section dans son int√©gralit√©, y compris le titre. 
. Ne r√©dige jamais la rubrique "Autres D√©tails" si les informations sont absentes.
```

**R√©ponse JSON attendue** :
```json
{
  "titre": "...",
  "referenceEtPrix": "...",
  "detailsCles": "...",
  "donneesFinancieres": "...",
  "informationsComplementaires": "..."  // ‚Üê Contient les donn√©es de 'details'
}
```

---

### 2. Comportement si `hasNoDetails=true`

**Cas** : L'utilisateur a coch√© "Je n'ai pas d'informations compl√©mentaires"

**Donn√©es envoy√©es √† OpenAI** :
```tsx
data.details = ""  // Cha√Æne vide
```

**Comportement du prompt** :
- Le placeholder `[informations compl√©mentaires]` est remplac√© par `""`
- Le prompt indique : "Si aucune donn√©e 'Autres D√©tails' n'est transmise, supprime cette section dans son int√©gralit√©"
- La section `Autres D√©tails` n'appara√Æt pas dans l'annonce g√©n√©r√©e
- Le champ `informationsComplementaires` du JSON retourn√© sera vide ou absent

---

## VIII. PROCESSUS COMPLET √âTAPE PAR √âTAPE

### üìç Phase 1 : Arriv√©e sur l'√âtape 4

**√âtape 3.1** : L'utilisateur valide l'√âtape 3  
‚Üí `completeStep(3)` ajoute `4` √† `stepProgress`  
‚Üí Navigation vers `/etape4`

**√âtape 3.2** : Chargement de `Etape4.tsx`  
‚Üí `useStepProgress(4)` v√©rifie l'acc√®s  
‚Üí Si `stepProgress` ne contient pas `4` ‚Üí Redirection `/etape1`

**√âtape 3.3** : Affichage du formulaire  
‚Üí Composant `SaisieDetailsForm` s'affiche  
‚Üí Menu lat√©ral avec `DirectivesMenuOnglet` et `EtapeFAQ`

---

### üìç Phase 2 : Chargement des donn√©es

**√âtape 2.1** : Ex√©cution du `useEffect`  
‚Üí Appel `getPropertyDataFromStorage()`  
‚Üí R√©cup√©ration de `propertyData` depuis `localStorage`

**√âtape 2.2** : Pr√©-remplissage selon les donn√©es

**Cas A** : `propertyData.details` existe  
‚Üí `setDetails(propertyData.details)`  
‚Üí `setHasNoDetails(false)`  
‚Üí Affichage du texte dans `FormulaireSaisie`

**Cas B** : `propertyData.hasNoDetails === true`  
‚Üí `setHasNoDetails(true)`  
‚Üí `setDetails("")`  
‚Üí Checkbox coch√©e + textarea vide et `readOnly`

**Cas C** : Aucune donn√©e  
‚Üí `setHasNoDetails(false)`  
‚Üí `setDetails("")`  
‚Üí √âtat initial vide

---

### üìç Phase 3 : Saisie des informations

**Option A : Utilisateur coche la checkbox**

**√âtape A.1** : Clic sur checkbox  
‚Üí `handleHasNoDetailsChange(true)` appel√©

**√âtape A.2** : Mise √† jour des √©tats  
‚Üí `setHasNoDetails(true)`  
‚Üí `setDetails("")` (vidage du champ)

**√âtape A.3** : UI mis √† jour  
‚Üí Checkbox coch√©e  
‚Üí Textarea vid√© et devient `readOnly`

---

**Option B : Utilisateur saisit des informations**

**√âtape B.1** : Saisie dans le textarea  
‚Üí `handleDetailsChange()` appel√© √† chaque modification

**√âtape B.2** : Mise √† jour de l'√©tat  
‚Üí `setDetails(e.target.value)`  
‚Üí Si `value.trim() !== ""` ‚Üí `setHasNoDetails(false)` (auto)

**√âtape B.3** : Formatage automatique  
‚Üí `FormulaireSaisie` ajoute des puces (`‚Ä¢`)  
‚Üí Capitalisation de la premi√®re lettre  
‚Üí Ajustement dynamique de la hauteur du textarea

**Exemple** :
```
Utilisateur tape : "ouvert du lundi au vendredi"
R√©sultat affich√© : "‚Ä¢ Ouvert du lundi au vendredi"
```

---

### üìç Phase 4 : Validation

**√âtape 4.1** : Clic sur "Valider mes informations"  
‚Üí `handleValidation()` appel√©

**√âtape 4.2** : V√©rification du choix obligatoire

**Cas invalide** : `!hasNoDetails` ET `details.trim() === ""`  
‚Üí Toast d'erreur affich√© :
```
Titre: "Attention"
Description: "Cette √©tape est optionnelle, mais vous devez indiquer votre choix. 
              Soit cocher la case 'Je n'ai pas d'informations compl√©mentaires √† fournir', 
              soit saisir des informations."
```
‚Üí Arr√™t du processus (`return`)

**Cas valide** : `hasNoDetails=true` OU `details.trim() !== ""`  
‚Üí Passage √† l'√©tape suivante

---

**√âtape 4.3** : Sauvegarde des donn√©es  
‚Üí Appel `updatePropertyData({ details, hasNoDetails })`  
‚Üí Fusion avec `propertyData` existant  
‚Üí Sauvegarde dans `localStorage.propertyData`

**Exemple de donn√©es sauvegard√©es** :
```json
{
  "details": "‚Ä¢ Ouvert du mardi au dimanche\n‚Ä¢ Fermeture annuelle en ao√ªt\n‚Ä¢ Licence IV",
  "hasNoDetails": false
}
```

**Ou si checkbox coch√©e** :
```json
{
  "details": "",
  "hasNoDetails": true
}
```

---

**√âtape 4.4** : Toast de succ√®s adapt√©

**Si `hasNoDetails=true`** :
```
Titre: "Informations valid√©es"
Description: "Vous avez indiqu√© ne pas avoir d'informations compl√©mentaires."
```

**Si `details` renseign√©** :
```
Titre: "Informations valid√©es"
Description: "Vos informations compl√©mentaires ont √©t√© enregistr√©es avec succ√®s."
```

---

**√âtape 4.5** : Progression  
‚Üí `completeStep(4)` appel√©  
‚Üí Ajout de `5` √† `stepProgress` dans `localStorage`  
‚Üí `stepProgress` devient : `[1, 2, 3, 4, 5]`

---

**√âtape 4.6** : Navigation  
‚Üí `navigate('/etape5')`  
‚Üí Redirection vers l'√âtape 5 (page finale de g√©n√©ration)

---

### üìç Phase 5 : Modification depuis l'√âtape 5

**Sc√©nario** : L'utilisateur veut modifier les informations compl√©mentaires apr√®s avoir atteint l'√âtape 5

**√âtape 5.1** : Clic sur "Modifier" pour l'√âtape 4  
‚Üí Navigation vers `/etape4`  
‚Üí `useStepProgress(4)` autorise l'acc√®s (√©tape d√©j√† d√©bloqu√©e)

**√âtape 5.2** : Chargement des donn√©es  
‚Üí `useEffect` charge `propertyData.details` et `propertyData.hasNoDetails`  
‚Üí Pr√©-remplissage du formulaire avec les donn√©es existantes

**√âtape 5.3** : Modification par l'utilisateur  
‚Üí L'utilisateur modifie le texte ou change le statut de la checkbox

**√âtape 5.4** : Retour vers l'√âtape 5  
‚Üí L'utilisateur clique sur un bouton "Retour" (si impl√©ment√©)  
‚Üí `handleBackToEtape5()` appel√©

**√âtape 5.5** : Sauvegarde conditionnelle  
‚Üí Si `details.trim()` non vide ‚Üí `updatePropertyData({ details })`  
‚Üí Si `hasNoDetails=true` ‚Üí `updatePropertyData({ details: "", hasNoDetails: true })`  
‚Üí Toast : "Modifications sauvegard√©es"

**√âtape 5.6** : Navigation  
‚Üí `goToEtape5()` appel√©  
‚Üí Redirection vers `/etape5`

---

## IX. √âL√âMENTS CACH√âS / CONDITIONNELS

### 1. Textarea `readOnly`

**Condition** : `hasNoDetails === true`

**Comportement** :
- Le composant `FormulaireSaisie` re√ßoit la prop `readOnly={hasNoDetails}`
- Si `hasNoDetails=true` ‚Üí textarea devient non √©ditable
- L'utilisateur doit d√©cocher la checkbox pour pouvoir saisir du texte

**Code** :
```tsx

```

---

### 2. Section "Autres D√©tails" dans l'Annonce Fiche de Synth√®se

**Condition** : `details` non vide

**Comportement dans le prompt OpenAI** :
```
Si aucune donn√©e "Autres D√©tails" n'est transmise, 
supprime cette section dans son int√©gralit√©, y compris le titre.
```

**R√©sultat** :
- Si `details=""` (ou `hasNoDetails=true`) ‚Üí Pas de section "Autres D√©tails" dans l'annonce g√©n√©r√©e
- Si `details` renseign√© ‚Üí Section "Autres D√©tails" avec les informations format√©es en puces

---

### 3. Bouton "Valider mes informations"

**Toujours visible** - Aucune condition de masquage

**Comportement** :
- D√©clenche `handleValidation()` qui v√©rifie le choix obligatoire
- Affiche un toast d'erreur si aucun choix n'est fait

---

### 4. Menu lat√©ral (`DirectivesMenuOnglet`)

**√âtapes d√©sactiv√©es** : D√©termin√©es par `disabledSteps` (provenant de `useStepProgress`)

**Comportement** :
- Les √©tapes non d√©bloqu√©es sont gris√©es et non cliquables
- L'utilisateur peut naviguer librement vers les √©tapes d√©j√† valid√©es (1, 2, 3)
- L'√©tape 5 n'est accessible qu'apr√®s validation de l'√©tape 4

---

### 5. Toast de succ√®s adapt√©

**Condition** : Message diff√©rent selon `hasNoDetails`

**Si `hasNoDetails=true`** :
```tsx
toast({
  title: "Informations valid√©es",
  description: "Vous avez indiqu√© ne pas avoir d'informations compl√©mentaires.",
  duration: 3000,
});
```

**Si `details` renseign√©** :
```tsx
toast({
  title: "Informations valid√©es",
  description: "Vos informations compl√©mentaires ont √©t√© enregistr√©es avec succ√®s.",
  duration: 3000,
});
```

---

## X. TIMER DE SESSION (D√âSACTIV√â MAIS PR√âSENT)

### √âtat actuel

**Comportement observ√©** :
- Une cl√© `session_start_time` peut exister dans `localStorage` (cr√©√©e dans d'anciennes versions)
- **Aucune logique active** dans l'√âtape 4 pour g√©rer ce timer
- **Non utilis√©** dans les composants actuels de l'√âtape 4

---

### Incoh√©rence potentielle dans `clearPropertyData()`

**Fichier** : `src/services/openai.ts` (ligne 360-362)

**Code actuel** :
```tsx
export const clearPropertyData = (): void => {
  localStorage.removeItem("propertyData");
};
```

**Comportement** :
- Supprime **uniquement** `propertyData`
- **Ne supprime pas** `session_start_time`, `stepProgress`, ni les cl√©s `generation_*`

**Risque** :
- Incoh√©rence : `propertyData` effac√© mais `details` pourrait rester dans une ancienne version du cache
- Recommandation : Utiliser `localStorage.clear()` pour un reset complet (d√©j√† impl√©ment√© dans `useStepProgress.handleConfirmNewProject()`)

---

### Cl√© `session_start_time`

**Valeur** : Timestamp de d√©but de session (si impl√©ment√©)

**Exemple** : `1736928000000` (timestamp en millisecondes)

**Usage pr√©vu** : Timer de session pour limiter la dur√©e d'un projet (non actif dans le code actuel)

---

## XI. R√âCAPITULATIF DES CL√âS localStorage

### Cl√©s utilis√©es par l'√âtape 4

| Cl√© | Type | Lecture | √âcriture | Description |
|-----|------|---------|----------|-------------|
| `propertyData` | Objet JSON | ‚úÖ | ‚úÖ | Donn√©es du bien (ajout de `details` et `hasNoDetails`) |
| `stepProgress` | Array JSON | ‚úÖ | ‚úÖ | Progression des √©tapes (ajout de `5` apr√®s validation) |

---

### Cl√©s cr√©√©es/modifi√©es par l'√âtape 4

| Cl√© | Action | Valeur | Moment |
|-----|--------|--------|--------|
| `propertyData.details` | Cr√©ation/Modification | Texte saisi par l'utilisateur | Validation |
| `propertyData.hasNoDetails` | Cr√©ation/Modification | `true` ou `false` | Validation |
| `stepProgress` | Modification | Ajout de `5` | `completeStep(4)` |

---

### Cl√©s non modifi√©es par l'√âtape 4

**Cl√©s `generation_*`** : Cr√©√©es ult√©rieurement √† l'√âtape 5
- `generation_website_ad`
- `generation_summary_sheet`
- `generation_newsletter`
- `generation_seo_tools`
- `generation_sms_ad`
- `generation_google_business_ad`
- `generation_social_media_ad`

**Autres cl√©s** :
- `session_start_time` (si pr√©sente, non utilis√©e par l'√âtape 4)

---

## XII. DONN√âES DE L'√âTAPE 4 √Ä PRENDRE EN CONSID√âRATION

### 1. Champs `propertyData`

| Champs `localStorage.propertyData` | Type | Obligatoire | Validation | Usage OpenAI |
|------------------------------------|------|-------------|------------|--------------|
| `details` | `string` | ‚ùå | Choix obligatoire (checkbox OU texte) | Fiche de Synth√®se uniquement |
| `hasNoDetails` | `boolean` | ‚ùå | Automatique selon choix | Non envoy√© √† OpenAI (info m√©tier) |

**D√©tail des champs** :

**`details`** :
- **Description** : Informations compl√©mentaires sur le bien (horaires d'ouverture, p√©riodes de fermeture, autres d√©tails d'exploitation)
- **Format** : Texte libre avec formatage automatique (puces `‚Ä¢` et capitalisation)
- **Exemple** :
  ```
  ‚Ä¢ Ouvert du mardi au dimanche de 12h √† 14h30 et de 19h √† 23h
  ‚Ä¢ Fermeture annuelle en ao√ªt
  ‚Ä¢ Licence IV
  ‚Ä¢ Terrasse autoris√©e jusqu'√† 22h
  ```
- **Usage OpenAI** : Remplace `[informations compl√©mentaires]` dans le prompt `2.PromptAnnonceFichedeSynthese.ts`

**`hasNoDetails`** :
- **Description** : Bool√©en indiquant si l'utilisateur a coch√© "Je n'ai pas d'informations compl√©mentaires"
- **Valeurs possibles** :
  - `true` : Pas d'informations compl√©mentaires ‚Üí `details=""` (section "Autres D√©tails" absente de l'annonce)
  - `false` : Informations compl√©mentaires fournies ‚Üí `details` contient du texte
- **Usage m√©tier** : Contr√¥le le `readOnly` du textarea et la logique de validation

---

### 2. Cl√©s `generation_*` (cr√©√©es √† l'√âtape 5)

| Cl√©s `localStorage` | Utilise `details` ? | Utilise `hasNoDetails` ? | Description |
|---------------------|---------------------|--------------------------|-------------|
| `generation_website_ad` | ‚ùå | ‚ùå | Annonce Site Internet (n'utilise pas `details`) |
| `generation_summary_sheet` | ‚úÖ | ‚ùå | **Fiche de Synth√®se** (utilise `details` dans section "Autres D√©tails") |
| `generation_newsletter` | ‚ùå | ‚ùå | Annonce Newsletter (n'utilise pas `details`) |
| `generation_seo_tools` | ‚ùå | ‚ùå | Outils SEO (n'utilise pas `details`) |
| `generation_sms_ad` | ‚ùå | ‚ùå | Annonce SMS (n'utilise pas `details`) |
| `generation_google_business_ad` | ‚ùå | ‚ùå | Annonce Google Business Profile (n'utilise pas `details`) |
| `generation_social_media_ad` | ‚ùå | ‚ùå | Annonce R√©seaux Sociaux (n'utilise pas `details`) |

**üö® IMPORTANT** : Le champ `details` est **UNIQUEMENT** utilis√© dans la **Fiche de Synth√®se** (`generation_summary_sheet`).

---

### 3. Fonctions

| Fonction | Fichier | Description | Param√®tres | Retour |
|----------|---------|-------------|------------|--------|
| `getPropertyDataFromStorage()` | `openai.ts` | R√©cup√®re `propertyData` depuis `localStorage` | Aucun | `PropertyData` |
| `updatePropertyData()` | `openai.ts` | Met √† jour `propertyData` dans `localStorage` | `newData: Partial` | `PropertyData` |
| `completeStep()` | `useStepProgress.ts` | Marque une √©tape comme compl√©t√©e et d√©bloque la suivante | `step: number` | `void` |
| `handleValidation()` | `SaisieDetailsForm.tsx` | Valide le formulaire et navigue vers l'√âtape 5 | Aucun | `void` |
| `handleDetailsChange()` | `SaisieDetailsForm.tsx` | Met √† jour l'√©tat `details` | `e: React.ChangeEvent` | `void` |
| `handleHasNoDetailsChange()` | `SaisieDetailsForm.tsx` | Met √† jour l'√©tat `hasNoDetails` et vide `details` si coch√©e | `value: boolean` | `void` |
| `handleBackToEtape5()` | `SaisieDetailsForm.tsx` | Sauvegarde les modifications et retourne √† l'√âtape 5 | Aucun | `void` |
| `handleInputChange()` | `FormulaireSaisie.tsx` | Formate automatiquement le texte (puces + capitalisation) | `e: React.ChangeEvent` | `void` |
| `adjustHeight()` | `FormulaireSaisie.tsx` | Ajuste dynamiquement la hauteur du textarea | Aucun | `void` |

---

### 4. Rappel des d√©pendances entre les √©tapes

| √âtape source | √âtape cible | D√©pendance | Description |
|--------------|-------------|------------|-------------|
| **√âtape 3** | **√âtape 4** | ‚úÖ Obligatoire | L'√âtape 4 n√©cessite la validation de l'√âtape 3 (`stepProgress` doit contenir `4`) |
| **√âtape 4** | **√âtape 5** | ‚úÖ Obligatoire | L'√âtape 5 n√©cessite la validation de l'√âtape 4 (`completeStep(4)` ajoute `5` √† `stepProgress`) |
| **√âtape 4** | **OpenAI Fiche de Synth√®se** | ‚ö†Ô∏è Optionnel | `details` utilis√© dans `generateSummarySheetAd()` (section "Autres D√©tails") |
| **√âtape 4** | **Autres annonces OpenAI** | ‚ùå Non utilis√© | `details` **n'est pas** utilis√© dans les autres annonces (Site Internet, Newsletter, SEO, SMS, Google, R√©seaux Sociaux) |

**Sch√©ma de d√©pendances** :
```
√âtape 1 (agencyName, reference, location, propertyType, price/rent, keyElements)
    ‚Üì
√âtape 2 (propertyDescription)
    ‚Üì
√âtape 3 (financials)
    ‚Üì
√âtape 4 (details, hasNoDetails)  ‚Üê **Vous √™tes ici**
    ‚Üì
√âtape 5 (G√©n√©ration des 7 annonces OpenAI)
    ‚Üì
    ‚Üí Fiche de Synth√®se (utilise details)
    ‚Üí Annonce Site Internet (n'utilise pas details)
    ‚Üí Newsletter (n'utilise pas details)
    ‚Üí Outils SEO (n'utilise pas details)
    ‚Üí SMS (n'utilise pas details)
    ‚Üí Google Business Profile (n'utilise pas details)
    ‚Üí R√©seaux Sociaux (n'utilise pas details)
```

---

## üìå POINTS CL√âS √Ä RETENIR

1. **√âtape optionnelle mais choix obligatoire** : L'utilisateur doit soit cocher la checkbox, soit saisir des informations.

2. **Usage limit√©** : Le champ `details` est **UNIQUEMENT** utilis√© dans la **Fiche de Synth√®se**, pas dans les autres annonces.

3. **Formatage automatique** : `FormulaireSaisie` ajoute des puces (`‚Ä¢`) et capitalise automatiquement.

4. **Double √©tat** : `details` (texte) ET `hasNoDetails` (bool√©en) sont sauvegard√©s ensemble.

5. **Navigation conditionnelle** : L'√âtape 5 n'est d√©bloqu√©e qu'apr√®s validation de l'√âtape 4.

6. **Modification possible** : L'utilisateur peut revenir sur l'√âtape 4 depuis l'√âtape 5 pour modifier les informations.

7. **Reset complet** : `handleConfirmNewProject()` (dans `useStepProgress`) utilise `localStorage.clear()` pour effacer toutes les donn√©es.

---

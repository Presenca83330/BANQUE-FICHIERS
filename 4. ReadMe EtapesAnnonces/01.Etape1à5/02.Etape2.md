# üìã **DOCUMENTATION EXHAUSTIVE - √âTAPE 2 : DESCRIPTION DU BIEN**

## **üéØ MISSION DU DOCUMENT**
- Cette documentation constitue la Bible compl√®te de l'**√âtape 2** du processus de g√©n√©ration d'annonces en mode **localStorage**.
- Elle recense **TOUS** les fichiers, fonctions, composants, champs de formulaire, validations, contraintes, interactions, et flux de donn√©es utilis√©s dans cette √©tape.
- Objectif : fournir une base d'audit exhaustive avant la migration vers Supabase.

---
## **üìë SOMMAIRE CLIQUABLE - √âTAPE 2**

### **Structure du document**
- [üéØ MISSION DU DOCUMENT](#-mission-du-document)
- [üìÇ I. ARCHITECTURE GLOBALE DE L'√âTAPE 2](#-i-architecture-globale-de-ltape-2)
- [üìÅ II. FICHIERS UTILIS√âS (Liste exhaustive)](#-ii-fichiers-utilis√©s-liste-exhaustive)
- [III. STRUCTURE DES DONN√âES DANS `localStorage`](#iii-structure-des-donn√©es-dans-localstorage)
- [IV. LOGIQUE DE VALIDATION DES CHAMPS](#iv-logique-de-validation-des-champs)
- [V. CONTRAINTES ET R√àGLES M√âTIER](#v-contraintes-et-r√®gles-m√©tier)
- [VI. NAVIGATION ET RETOUR EN ARRI√àRE](#vi-navigation-et-retour-en-arri√®re)
- [VII. UTILISATION DES DONN√âES PAR OPENAI](#vii-utilisation-des-donn√©es-par-openai)
- [VIII. PROCESSUS COMPLET √âTAPE PAR √âTAPE](#viii-processus-complet-√©tape-par-√©tape)
- [IX. √âL√âMENTS CACH√âS / CONDITIONNELS](#ix-√©l√©ments-cach√©s--conditionnels)
- [X. TIMER DE SESSION (D√âSACTIV√â MAIS PR√âSENT)](#x-timer-de-session-d√©sactiv√©-mais-pr√©sent)
- [XI. R√âCAPITULATIF DES CL√âS `localStorage`](#xi-r√©capitulatif-des-cl√©s-localstorage)
- [XII. DONNEES DE L'ETAPE 2 √Ä PRENDRE EN CONSID√âRATION](#xii-donnees-de-letape-2-√†-prendre-en-consid√©ration)

---

---
## **üìÇ I. ARCHITECTURE GLOBALE DE L'√âTAPE 2**

### **Vue d'ensemble**
- L'√âtape 2 (route `/etape2`) permet √† l'utilisateur de saisir une **description d√©taill√©e** du bien immobilier commercial.
- Cette description est **essentielle** car elle alimente les 4 prompts OpenAI de g√©n√©ration d'annonces (Site Internet, Fiche de Synth√®se, Newsletter, Outils SEO).
- Les donn√©es sont **stock√©es dans le localStorage** sous la cl√© `"propertyData"` au format JSON, dans le champ `propertyDescription`.
- Cette √©tape suit l'√âtape 1 (√©l√©ments cl√©s) et pr√©c√®de l'√âtape 3 (informations financi√®res).

### **Flux de donn√©es simplifi√©**
```
Utilisateur saisit la description d√©taill√©e
         ‚Üì
SaisieDescriptionForm (gestion state local)
         ‚Üì
handleValidation() - Validation du champ
         ‚Üì
updatePropertyData() - Stockage dans localStorage cl√© "propertyData"
         ‚Üì
completeStep(2) - D√©verrouillage √âtape 3 dans localStorage cl√© "stepProgress"
         ‚Üì
navigate("/etape3") - Navigation vers √âtape 3
```
---
```mermaid
graph TD
    A[Chargement Etape2.tsx] --> B[useStepProgress v√©rifie acc√®s]
    B -->|√âtape 2 non disponible| C[Redirection /etape1]
    B -->|√âtape 2 disponible| D[Affichage SaisieDescriptionForm]
    D --> E[useEffect: R√©cup√©ration propertyData]
    E --> F[getPropertyDataFromStorage depuis localStorage]
    F --> G{propertyData.propertyDescription existe?}
    G -->|Oui| H[Pr√©-remplissage du champ description]
    G -->|Non| I[Affichage champ vide]
    H --> J[Affichage FormulaireSaisie]
    I --> J
    J --> K[Utilisateur saisit la description]
    K --> L[handleDescriptionChange: mise √† jour state]
    L --> M[Formatage automatique: ajout '‚Ä¢ ' + capitalisation]
    M --> N[Clic sur BoutonValiderInformations]
    N --> O{Validation: propertyDescription non vide?}
    O -->|Non| P[Toast erreur: Description requise]
    P --> Q[Retour au formulaire]
    O -->|Oui| R[updatePropertyData avec propertyDescription]
    R --> S[Sauvegarde dans localStorage.propertyData]
    S --> T[completeStep: ajout √©tape 3 √† stepProgress]
    T --> U[Toast succ√®s: Description valid√©e]
    U --> V[Navigation vers /etape3]
```
---

## üìù D√©tails du flux

### üîÑ Phases principales

1. **Initialisation et v√©rification d'acc√®s** (A‚ÜíD)
   - Chargement de `Etape2.tsx`
   - `useStepProgress(2)` v√©rifie si l'√©tape 2 est accessible
   - Si √©tape 1 non compl√©t√©e ‚Üí redirection vers `/etape1`
   - Si √©tape 2 accessible ‚Üí affichage du formulaire

2. **Chargement des donn√©es** (E‚ÜíJ)
   - `useEffect` r√©cup√®re `propertyData` via `getPropertyDataFromStorage()`
   - Si `propertyData.propertyDescription` existe ‚Üí pr√©-remplissage du champ
   - Si aucune donn√©e ‚Üí champ vide
   - Affichage du composant `FormulaireSaisie`

3. **Saisie utilisateur avec formatage** (K‚ÜíM)
   - L'utilisateur saisit sa description
   - `handleDescriptionChange` met √† jour le state
   - `FormulaireSaisie` formate automatiquement :
     - Ajout de `‚Ä¢ ` en d√©but de chaque ligne
     - Capitalisation de la premi√®re lettre apr√®s la puce
     - Ajustement dynamique de la hauteur du textarea

4. **Validation** (N‚ÜíQ)
   - Clic sur `BoutonValiderInformations`
   - **1 validation** obligatoire : `propertyDescription` non vide
   - Si vide ‚Üí toast d'erreur et retour au formulaire

5. **Sauvegarde et navigation** (R‚ÜíV)
   - `updatePropertyData({ propertyDescription })` ‚Üí sauvegarde dans `localStorage.propertyData`
   - `completeStep(2)` ‚Üí ajout √©tape 3 dans `stepProgress`
   - Toast de succ√®s
   - Navigation vers `/etape3`

---

## **üìÅ II. FICHIERS UTILIS√âS (Liste exhaustive)**

### **1. Fichiers de page principale**

#### **`src/1.etapes-generation-annonces/etape2/Etape2.tsx`**
**R√¥le** : Composant page principale de l'√âtape 2.
- **Responsabilit√©s** :
  - Affiche le layout global avec `LayoutV2GenAnn`
  - Affiche le hero header avec `StructureHeroPetit`
  - Int√®gre le formulaire via `SaisieDescriptionForm`
  - Affiche la colonne lat√©rale avec `DirectivesMenuOnglet` et `EtapeFAQ`
  - V√©rifie l'acc√®s √† l'√©tape via `useStepProgress(2)`

- **Imports cl√©s** :
  ```typescript
  import LayoutV2GenAnn from "@/components/atemplate.v2.generation-annonces/Layout.V2.GenAnn";
  import StructureHeroPetit from "@/0.structure-type-page/structure5HeroPetit/StructureHeroPetit";
  import DirectivesMenuOnglet from "@/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet";
  import { EtapeFAQ } from "@/components/1-Sources-Generation-Annonces/help/EtapeFAQ";
  import { useStepProgress } from "@/components/1-Sources-Generation-Annonces/utils/useStepProgress";
  import SaisieDescriptionForm from "@/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm";
  import ImageRobotHeaderMauve from "@/components/widgets/quote/1.ImageRobotHeaderMauve";
  import Structure5ContainerVide from "@/0.structure-type-page/structure5HeroPetit/Structure5ContainerVide";
  ```

- **Hooks utilis√©s** :
  - `useStepProgress(2)` : G√®re la progression et le d√©blocage des √©tapes
  - `useNavigate()` : Navigation entre les √©tapes

- **V√©rification d'acc√®s** :
  ```typescript
  React.useEffect(() => {
    if (!isStepAvailable(2)) {
      navigate("/etape1");
    }
  }, [isStepAvailable, navigate]);
  ```

- **Donn√©es configur√©es** :
  - `headerTitle` : "Informations de description"
  - `headerSubtitle` : "Cette √©tape va permettre √† l'IA de structurer une annonce parfaite en d√©taillant avec pr√©cision les caract√©ristiques de votre bien."
  - `headerText` : "Il n'est pas n√©cessaire de r√©diger des phrases. Il suffit de lister les √©l√©ments √† votre disposition, sans se soucier de la mise en forme. L'IA se charge de les organiser, les hi√©rarchiser et de r√©diger une description fluide, coh√©rente et percutante."
  - `card1CentreTitre` : "Informations de description"

---

### **2. Composant formulaire principal**

#### **`src/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm.tsx`**
**R√¥le** : Composant formulaire contenant le champ de saisie de la description du bien.

- **Structure** :
  - Composant fonctionnel React
  - G√®re **1 state local** : `propertyDescription`
  - Charge les donn√©es depuis `localStorage` au montage (`useEffect`)
  - Valide et sauvegarde les donn√©es via `updatePropertyData()`

- **√âtats locaux (States)** :
  ```typescript
  const [propertyDescription, setPropertyDescription] = useState(""); // Description d√©taill√©e
  ```

- **Hooks utilis√©s** :
  ```typescript
  const { toast } = useToast();
  const navigate = useNavigate();
  const { completeStep, hasCompletedStep4, goToEtape5 } = useStepProgress(2);
  ```

- **Chargement des donn√©es (`useEffect`)** :
  ```typescript
  useEffect(() => {
    const propertyData = getPropertyDataFromStorage(); // Lecture localStorage

    if (propertyData.propertyDescription) {
      console.log("Description r√©cup√©r√©e de propertyData:", propertyData.propertyDescription);
      setPropertyDescription(propertyData.propertyDescription);
    }
  }, []);
  ```

- **Gestion du changement** :
  ```typescript
  const handleDescriptionChange = (e: React.ChangeEvent) => {
    setPropertyDescription(e.target.value);
  };
  ```

- **Validation des champs (`handleValidation`)** :
  ```typescript
  const handleValidation = () => {
    // V√©rification champ obligatoire "propertyDescription"
    if (!propertyDescription.trim()) {
      toast({
        title: "Erreur de validation",
        description: "Veuillez saisir une description du bien avant de continuer.",
        duration: 3000,
        variant: "destructive"
      });
      return;
    }

    // Sauvegarde dans localStorage
    updatePropertyData({ propertyDescription });

    toast({
      title: "Informations valid√©es",
      description: "Votre description du bien a √©t√© enregistr√©e avec succ√®s.",
      duration: 3000,
    });

    console.log("Description du bien valid√©e et centralis√©e");

    // D√©blocage √©tape 3 et navigation
    completeStep(2);
    navigate("/etape3");
  };
  ```

- **Retour √† l'√âtape 5 (si compl√©t√©e)** :
  ```typescript
  const handleBackToEtape5 = () => {
    if (propertyDescription.trim()) {
      updatePropertyData({ propertyDescription });

      toast({
        title: "Modifications sauvegard√©es",
        description: "Vos modifications ont √©t√© enregistr√©es avant de retourner √† l'√©tape finale.",
        duration: 3000,
      });
    }

    goToEtape5();
  };
  ```

- **Contenu d'aide (SgaHelpBox)** :
  - **Titre** : "Description du bien"
  - **Ic√¥ne** : `Lightbulb` (ampoule jaune)
  - **Contenu** : 
    - Rappel que ces donn√©es alimentent l'IA pour r√©diger l'annonce
    - Liste des informations essentielles :
      - Emplacement, zone de chalandise
      - Superficie, r√©partition des espaces
      - Activit√© actuelle, client√®le, fr√©quentation
      - Int√©rieur (d√©cor, ambiance, √©quipements)
    - Avertissement : "L'IA ne peut pas inventer ce qu'elle ne conna√Æt pas"
    - Encouragement : "Plus votre description est compl√®te, plus elle sera mise en valeur avec efficacit√©"

---

### **3. Composants de champs de formulaire**

#### **`src/components/1-Sources-Generation-Annonces/form-components/FormulaireSaisie.tsx`**
**R√¥le** : Zone de texte multiligne (textarea) avec formatage automatique :
- Ajout automatique de puces (`‚Ä¢ `) en d√©but de ligne
- Capitalisation de la premi√®re lettre apr√®s la puce
- Ajustement dynamique de la hauteur

- **Props** :
  ```typescript
  interface FormulaireSaisieProps {
    id: string;                    // "propertyDescription"
    title: string;                 // "Description d√©taill√©e"
    value: string;                 // Valeur du champ
    onChange: (e: React.ChangeEvent) => void;
    placeholder?: string;          // "Listez le maximum d'informations..."
    className?: string;
    minRows?: number;              // Nombre min de lignes (d√©faut: 10, utilis√©: 8)
    readOnly?: boolean;
    required?: boolean;
  }
  ```

- **Logique de formatage (`handleInputChange`)** :
  ```typescript
  const handleInputChange = (e: React.ChangeEvent) => {
    const newText = e.target.value;

    const formattedText = newText.split('\n').map(line => {
      // Ligne vide ‚Üí pas de modification
      if (line === '') return '';

      let formattedLine = line;

      // Si la ligne ne commence pas par un caract√®re sp√©cial (‚Ä¢, ‚ñ†, ., -, etc.)
      if (!formattedLine.trimStart().startsWith('‚Ä¢') && 
          !formattedLine.trimStart().startsWith('‚ñ†') && 
          !formattedLine.trimStart().startsWith('‚ñ™') && 
          !formattedLine.trimStart().startsWith('‚ñ´') && 
          !formattedLine.trimStart().startsWith('.') && 
          !formattedLine.trimStart().startsWith('-')) {

        // Ajouter '‚Ä¢ ' en pr√©servant les espaces de d√©but
        const leadingSpaces = formattedLine.length - formattedLine.trimStart().length;
        const spacesPrefix = formattedLine.substring(0, leadingSpaces);
        formattedLine = spacesPrefix + '‚Ä¢ ' + formattedLine.trimStart();
      }

      // Si la ligne commence par '‚Ä¢ ', capitaliser la premi√®re lettre apr√®s
      const trimmedLine = formattedLine.trimStart();
      if (trimmedLine.startsWith('‚Ä¢ ')) {
        const leadingSpaces = formattedLine.length - trimmedLine.length;
        const spacesPrefix = formattedLine.substring(0, leadingSpaces);

        const afterPrefix = trimmedLine.substring(2);
        if (afterPrefix.length > 0) {
          formattedLine = spacesPrefix + '‚Ä¢ ' + afterPrefix.charAt(0).toUpperCase() + afterPrefix.slice(1);
        }
      }

      return formattedLine;
    }).join('\n');

    // D√©clencher onChange avec le texte format√©
    onChange({ ...e, target: { ...e.target, value: formattedText } });
  };
  ```

- **Ajustement automatique de la hauteur** :
  ```typescript
  const adjustHeight = () => {
    const textarea = textareaRef.current;
    if (textarea) {
      textarea.style.height = "auto";

      const lineHeight = parseInt(getComputedStyle(textarea).lineHeight) || 20;
      const minHeight = lineHeight * minRows;

      const newHeight = Math.max(textarea.scrollHeight, minHeight);
      textarea.style.height = `${newHeight}px`;
    }
  };

  useEffect(() => {
    adjustHeight();
  }, [value]);
  ```

- **Styles** :
  - Label : `text-[14px] text-black font-bold`
  - Textarea : `rounded-md bg-[#ffffff] border border-[#B8C8DC] text-[14px] text-[#515151]`
  - Focus : `focus:ring-2 focus:ring-[#5E50A6]`
  - Hauteur min : `min-h-[200px]` + dynamique selon `minRows`

- **Champ utilisant FormulaireSaisie** :
  - `propertyDescription` (id: "propertyDescription", titre: "Description d√©taill√©e", placeholder: "Listez le maximum d'informations de description en votre possession...", minRows: 8, required: true)

---

#### **`src/components/1-Sources-Generation-Annonces/form-components/BoutonValiderInformations.tsx`**
**R√¥le** : Bouton de validation "Valider mes informations" avec ic√¥ne.

- **Props** :
  ```typescript
  interface BoutonValiderInformationsProps {
    onClick: () => void;
    className?: string;
  }
  ```

- **Styles** :
  - Couleur : `bg-[#5E50A6]` (violet) + `hover:bg-[#6B5DB8]`
  - Texte : `text-white text-[14px] font-bold`
  - Ic√¥ne : `Check` (Lucide React) en blanc

- **Utilisation dans l'√âtape 2** :
  ```typescript

  ```

---

### **4. Composants d'aide et layout**

#### **`src/components/1-Sources-Generation-Annonces/help/SgaHelpBox.tsx`**
**R√¥le** : Carte d'aide avec ic√¥ne, titre et contenu d√©taill√©.

- **Props** :
  ```typescript
  interface SgaHelpBoxProps {
    title: string;           // "Description du bien"
    content: React.ReactNode; // Contenu HTML avec instructions
    icon?: React.ReactNode;   // Ic√¥ne Lightbulb
    className?: string;
  }
  ```

- **Styles** :
  - Fond : `bg-[#F7F5FA]` (gris-mauve tr√®s clair)
  - Bordure : `border border-[#E5E7EB]`
  - Titre : `text-[14px] font-bold text-black`
  - Texte : `text-[12px] text-black`

---

#### **`src/components/1-Sources-Generation-Annonces/help/EtapeFAQ.tsx`**
**R√¥le** : Accord√©on FAQ avec questions/r√©ponses sp√©cifiques √† l'√©tape.

- **Props** :
  ```typescript
  interface EtapeFAQProps {
    etape: "etape1" | "etape2" | "etape3" | "etape4" | "etape5";
  }
  ```

- **Questions pour l'√âtape 2** (`etape="etape2"`) :
  1. "Quelles informations int√©grer ?"
  2. "Puis-je modifier mes informations plus tard ?"
  3. "Comment optimiser ma description ?"

---

#### **`src/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet.tsx`**
**R√¥le** : Menu de navigation entre les √©tapes avec indicateur de progression.

- **Props** :
  ```typescript
  interface DirectivesMenuOngletProps {
    activeStep: number;      // 2 pour l'√âtape 2
    disabledSteps: number[]; // √âtapes non encore d√©bloqu√©es
  }
  ```

- **Fonctionnalit√©s** :
  - Affiche les 5 √©tapes avec ic√¥nes
  - Indique l'√©tape active (fond violet)
  - D√©sactive les √©tapes non accessibles
  - Permet navigation vers √©tapes d√©bloqu√©es

---

### **5. Utilitaires et services**

#### **`src/components/1-Sources-Generation-Annonces/utils/useStepProgress.ts`**
**R√¥le** : Hook personnalis√© pour g√©rer la progression des √©tapes.

- **Retour du hook** :
  ```typescript
  {
    availableSteps: number[],        // [1, 2, 3] si √©tapes 1-3 compl√©t√©es
    disabledSteps: number[],         // [4, 5] si √©tapes 4-5 non compl√©t√©es
    completeStep: (step: number) => void, // D√©bloque l'√©tape suivante
    hasCompletedStep4: boolean,      // true si √©tape 4 compl√©t√©e
    goToEtape5: () => void,          // Navigation vers √©tape 5
    handleConfirmNewProject: () => void, // Reset complet
    isStepAvailable: (step: number) => boolean // V√©rifie acc√®s √† une √©tape
  }
  ```

- **Stockage localStorage** :
  ```typescript
  // Cl√©: "stepProgress"
  // Valeur: { availableSteps: [1, 2, 3] }
  ```

- **Logique `completeStep(2)` pour l'√âtape 2** :
  ```typescript
  const completeStep = (step: number) => {
    const nextStep = step + 1;
    if (!availableSteps.includes(nextStep) && nextStep <= 5) {
      const newAvailableSteps = [...availableSteps, nextStep];
      setAvailableSteps(newAvailableSteps);
      localStorage.setItem("stepProgress", JSON.stringify({
        availableSteps: newAvailableSteps
      }));

      if (step === 4) {
        setHasCompletedStep4(true);
      }
    }
  };
  ```

- **Logique `isStepAvailable(2)` pour v√©rifier l'acc√®s** :
  ```typescript
  const isStepAvailable = (step: number) => {
    return availableSteps.includes(step) || step <= currentStep;
  };
  ```

---

#### **`src/services/openai.ts`**
**R√¥le** : Service de g√©n√©ration d'annonces avec OpenAI.

- **Interface `PropertyData`** :
  ```typescript
  export interface PropertyData {
    // √âtape 1
    agencyName?: string;
    reference?: string;
    exclusivite?: string;
    location?: string;
    propertyType?: string;
    saleType?: string;
    price?: string;
    rentAmount?: string;
    rentPeriodicity?: string;
    keyElements?: string;

    // √âtape 2 - Description
    propertyDescription?: string; // ‚Üê CHAMP DE L'√âTAPE 2

    // √âtape 3 - Financials
    financials?: string;

    // √âtape 4 - Details
    details?: string;
    hasNoDetails?: boolean;
  }
  ```

- **Fonction `updatePropertyData`** :
  ```typescript
  export const updatePropertyData = (data: Partial) => {
    const existingData = getPropertyDataFromStorage();
    const updatedData = { ...existingData, ...data };
    localStorage.setItem("propertyData", JSON.stringify(updatedData));
  };
  ```

- **Fonction `getPropertyDataFromStorage`** :
  ```typescript
  export const getPropertyDataFromStorage = (): PropertyData => {
    const data = localStorage.getItem("propertyData");
    return data ? JSON.parse(data) : {};
  };
  ```

- **Fonction `clearPropertyData`** :
  ```typescript
  export const clearPropertyData = () => {
    localStorage.removeItem("propertyData");
  };
  ```

- **Utilisation de `propertyDescription` dans les prompts OpenAI** :
  - **Annonce Site Internet** (ligne 181) :
    ```typescript
    .replace(/\[description d√©taill√©e du bien\]/g, data.propertyDescription || "")
    ```
  - **Fiche de Synth√®se** (ligne 230) :
    ```typescript
    .replace(/\[description d√©taill√©e du bien\]/g, data.propertyDescription || "")
    ```
  - **Newsletter** (ligne 275) :
    ```typescript
    .replace(/\[description d√©taill√©e du bien\]/g, data.propertyDescription || "")
    ```
  - **Outils SEO** (ligne 317) :
    ```typescript
    .replace(/\[description d√©taill√©e du bien\]/g, data.propertyDescription || "")
    ```

---

#### **`src/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/`**
**R√¥le** : Services OpenAI pour les autres fonctions (SMS, Google Business, R√©seaux Sociaux).

- **Fichiers concern√©s** :
  1. `1.API-AnnonceSMS.ts` (ligne 155)
  2. `2.API-AnnonceGoogleBusinessProfile.ts` (ligne 157)
  3. `3.API-AnnonceReseauxSociaux.ts` (ligne 158)

- **Utilisation de `propertyDescription`** :
  - Tous ces fichiers int√®grent `propertyDescription` dans leurs prompts OpenAI
  - Format identique : `.replace(/\[description d√©taill√©e du bien\]/g, data.propertyDescription || "")`

---

### **6. Fichiers de navigation**

#### **`src/components/navigation-site-leadgenaiadbuilder/NavLinks.tsx`**
**R√¥le** : D√©finit les liens de navigation du g√©n√©rateur d'annonces.

- **Lien √âtape 2** :
  ```typescript
  {
    to: "/etape2",
    label: "√âtape 2",
    icon: FileText
  }
  ```

---

## **III. STRUCTURE DES DONN√âES DANS `localStorage`**

### **1. Cl√© principale : `"propertyData"`**

**Format** : JSON stringifi√©
**Structure compl√®te** (apr√®s √âtape 2) :
```json
{
  "agencyName": "Mon Agence Immobili√®re",
  "reference": "LOC-2024-001",
  "exclusivite": "Oui",
  "location": "Lyon 6√®me",
  "propertyType": "Restaurant",
  "saleType": "√† louer",
  "price": "",
  "rentAmount": "3 500‚Ç¨",
  "rentPeriodicity": "Mensuel",
  "keyElements": "‚Ä¢ Emplacement strat√©gique\n‚Ä¢ Forte affluence\n‚Ä¢ Licence IV",
  "propertyDescription": "‚Ä¢ Restaurant de 120m¬≤ enti√®rement √©quip√©\n‚Ä¢ Situ√© dans le quartier des Brotteaux\n‚Ä¢ Terrasse de 40 couverts\n‚Ä¢ Cuisine professionnelle aux normes\n‚Ä¢ Client√®le d'affaires √©tablie"
}
```

**Champ sp√©cifique √† l'√âtape 2** :
- `propertyDescription` (string) : Description d√©taill√©e du bien, format√©e avec puces `‚Ä¢ `

---

### **2. Cl√© de progression : `"stepProgress"`**

**Format** : JSON stringifi√©
**Structure** :
```json
{
  "availableSteps": [1, 2, 3]
}
```

**√âvolution apr√®s validation de l'√âtape 2** :
```json
{
  "availableSteps": [1, 2, 3]  // √âtape 3 ajout√©e par completeStep(2)
}
```

---

### **3. Cl√©s de g√©n√©ration OpenAI : `"generation_*"`**

**Cr√©√©es √† l'√âtape 5** (apr√®s validation de toutes les √©tapes) :
- `"generation_website_ad"` : Annonce Site Internet
- `"generation_summary_sheet"` : Fiche de Synth√®se
- `"generation_newsletter"` : Annonce Newsletter
- `"generation_seo_tools"` : Outils SEO

**Format** : JSON stringifi√© avec structure sp√©cifique √† chaque type d'annonce.

**Contenu de `propertyDescription` dans ces cl√©s** :
- Int√©gr√© dans les prompts OpenAI pour g√©n√©rer les contenus
- Utilis√© pour r√©diger les descriptions, lister les points forts, etc.

---

## **IV. LOGIQUE DE VALIDATION DES CHAMPS**

### **1. Validation unique de l'√âtape 2**

**Champ obligatoire** : `propertyDescription`

**R√®gle de validation** :
```typescript
if (!propertyDescription.trim()) {
  toast({
    title: "Erreur de validation",
    description: "Veuillez saisir une description du bien avant de continuer.",
    duration: 3000,
    variant: "destructive"
  });
  return;
}
```

**Type de validation** :
- V√©rification que le champ n'est pas vide (apr√®s suppression des espaces)
- Pas de validation de longueur minimale ou maximale
- Pas de validation de format sp√©cifique

---

### **2. Comportement de validation**

**D√©clenchement** :
- Clic sur le bouton "Valider mes informations"
- Appel √† `handleValidation()`

**En cas d'√©chec** :
- Affichage d'un toast d'erreur (variant: "destructive", couleur rouge)
- Pas de navigation
- Focus reste sur le formulaire

**En cas de succ√®s** :
- Sauvegarde dans `localStorage.propertyData`
- Affichage d'un toast de succ√®s (couleur verte)
- D√©blocage de l'√âtape 3 via `completeStep(2)`
- Navigation automatique vers `/etape3`

---

### **3. Pas de validation en temps r√©el**

- **Aucune validation pendant la saisie**
- **Aucun message d'erreur inline**
- Validation uniquement au moment de la soumission

---

## **V. CONTRAINTES ET R√àGLES M√âTIER**

### **1. Contraintes d'acc√®s**

**Pr√©requis pour acc√©der √† l'√âtape 2** :
- L'√âtape 1 doit √™tre compl√©t√©e
- `stepProgress.availableSteps` doit contenir `2`
- V√©rification via `useStepProgress(2)` et `isStepAvailable(2)`

**Redirection automatique** :
```typescript
React.useEffect(() => {
  if (!isStepAvailable(2)) {
    navigate("/etape1"); // Redirection vers √âtape 1 si non accessible
  }
}, [isStepAvailable, navigate]);
```

---

### **2. Contraintes de saisie**

**Formatage automatique** :
- Chaque nouvelle ligne re√ßoit automatiquement une puce `‚Ä¢ `
- La premi√®re lettre apr√®s la puce est capitalis√©e
- Pr√©servation des espaces en d√©but de ligne

**Caract√®res sp√©ciaux d√©tect√©s** (pas de puce ajout√©e) :
- `‚Ä¢` (puce ronde)
- `‚ñ†` (carr√© plein)
- `‚ñ™` (petit carr√©)
- `‚ñ´` (petit carr√© vide)
- `.` (point)
- `-` (tiret)

**Hauteur du textarea** :
- Minimum : 8 lignes (configur√© via `minRows={8}`)
- Ajustement automatique selon le contenu
- Pas de limite maximale de hauteur

---

### **3. Contraintes de navigation**

**Navigation autoris√©e** :
- Retour √† l'√âtape 1 : toujours possible (via menu de navigation)
- Avance vers l'√âtape 3 : uniquement apr√®s validation de l'√âtape 2

**Sauvegarde automatique** :
- Aucune sauvegarde automatique pendant la saisie
- Sauvegarde uniquement sur clic "Valider mes informations"
- Si l'utilisateur quitte sans valider, les donn√©es sont perdues

---

### **4. Contraintes de donn√©es**

**Champ unique** :
- 1 seul champ de formulaire : `propertyDescription`
- Type : textarea multiligne
- Valeur : string avec formatage pr√©serv√© (retours √† la ligne, puces)

**Persistance** :
- Stockage dans `localStorage.propertyData.propertyDescription`
- Rechargement automatique au retour sur l'√âtape 2
- Pas de limite de taille (limitation du localStorage navigateur : ~5-10 MB)

---

## **VI. NAVIGATION ET RETOUR EN ARRI√àRE**

### **1. Navigation vers l'√âtape 2**

**Depuis l'√âtape 1** :
- Apr√®s validation de l'√âtape 1
- Clic sur "Valider mes informations" ‚Üí `completeStep(1)` ‚Üí `navigate("/etape2")`

**Depuis le menu de navigation** :
- Clic sur "√âtape 2" dans `DirectivesMenuOnglet`
- Possible uniquement si `isStepAvailable(2)` retourne `true`

**Depuis l'√âtape 3, 4 ou 5** :
- Retour possible via menu de navigation
- Pas de perte de donn√©es (rechargement depuis `localStorage`)

---

### **2. Navigation depuis l'√âtape 2**

**Vers l'√âtape 3** :
- Apr√®s validation de l'√âtape 2
- Clic sur "Valider mes informations" ‚Üí `completeStep(2)` ‚Üí `navigate("/etape3")`

**Vers l'√âtape 1** :
- Clic sur "√âtape 1" dans le menu de navigation
- Toujours possible (pas de restriction)

**Vers l'√âtape 5** (si d√©j√† compl√©t√©e) :
- Fonction `handleBackToEtape5()` disponible (mais non utilis√©e dans l'UI actuelle)
- Sauvegarde automatique avant navigation

---

### **3. Retour en arri√®re et modification**

**Modification de la description** :
- Retour √† l'√âtape 2 via menu de navigation
- Rechargement automatique de `propertyDescription` depuis `localStorage`
- Modification possible
- Re-validation via "Valider mes informations"

**Impact sur les √©tapes suivantes** :
- Modification de l'√âtape 2 n'invalide pas les √©tapes 3, 4, 5
- Les √©tapes suivantes restent accessibles
- **Attention** : Si l'√âtape 5 est d√©j√† compl√©t√©e, les annonces g√©n√©r√©es ne sont PAS r√©g√©n√©r√©es automatiquement

**R√©g√©n√©ration des annonces** :
- Pour prendre en compte les modifications de l'√âtape 2
- L'utilisateur doit retourner √† l'√âtape 5
- Cliquer sur "G√©n√©rer mes annonces" √† nouveau

---

### **4. Cas particulier : Nouveau projet**

**Reset complet** :
- Fonction `handleConfirmNewProject()` disponible dans `useStepProgress`
- Supprime toutes les cl√©s `localStorage` :
  - `propertyData`
  - `stepProgress`
  - `generation_*`
  - `session_start_time`
- Redirection vers `/etape1`
- Rechargement de la page (`window.location.reload()`)

---

## **VII. UTILISATION DES DONN√âES PAR OPENAI**

### **1. Champ utilis√© dans les prompts**

**Champ de l'√âtape 2** : `propertyDescription`

**Utilisation dans 7 prompts OpenAI** :
1. Annonce Site Internet (`src/services/openai.ts`, ligne 181)
2. Fiche de Synth√®se (`src/services/openai.ts`, ligne 230)
3. Newsletter (`src/services/openai.ts`, ligne 275)
4. Outils SEO (`src/services/openai.ts`, ligne 317)
5. Annonce SMS (`src/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/1.API-AnnonceSMS.ts`, ligne 155)
6. Annonce Google Business Profile (`src/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/2.API-AnnonceGoogleBusinessProfile.ts`, ligne 157)
7. Annonce R√©seaux Sociaux (`src/services/openai/1.GenerateurAnnoncesOutilsSeo/0.APIAutresFonctionsLeadGenAI/3.API-AnnonceReseauxSociaux.ts`, ligne 158)

---

### **2. Format d'int√©gration dans les prompts**

**Remplacement de placeholder** :
```typescript
.replace(/\[description d√©taill√©e du bien\]/g, data.propertyDescription || "")
```

**Valeur par d√©faut** :
- Si `propertyDescription` est vide ou `undefined` ‚Üí cha√Æne vide `""`
- L'IA OpenAI g√©n√®re alors l'annonce sans description d√©taill√©e

---

### **3. Exemple de prompt pour Annonce Site Internet**

**Template de prompt** :
```
Vous √™tes un expert en r√©daction d'annonces immobili√®res commerciales.

R√©digez une annonce pour un bien avec les caract√©ristiques suivantes :
- Type de bien : [type de bien]
- Emplacement : [emplacement]
- Prix/Loyer : [prix ou loyer]
- Arguments commerciaux : [arguments commerciaux]
- Description d√©taill√©e : [description d√©taill√©e du bien]

L'annonce doit √™tre fluide, percutante et valorisante.
```

**Apr√®s remplacement** (exemple) :
```
Vous √™tes un expert en r√©daction d'annonces immobili√®res commerciales.

R√©digez une annonce pour un bien avec les caract√©ristiques suivantes :
- Type de bien : Restaurant
- Emplacement : Lyon 6√®me
- Prix/Loyer : 3 500‚Ç¨ Mensuel
- Arguments commerciaux : ‚Ä¢ Emplacement strat√©gique
‚Ä¢ Forte affluence
‚Ä¢ Licence IV
- Description d√©taill√©e : ‚Ä¢ Restaurant de 120m¬≤ enti√®rement √©quip√©
‚Ä¢ Situ√© dans le quartier des Brotteaux
‚Ä¢ Terrasse de 40 couverts
‚Ä¢ Cuisine professionnelle aux normes
‚Ä¢ Client√®le d'affaires √©tablie

L'annonce doit √™tre fluide, percutante et valorisante.
```

---

### **4. Impact de `propertyDescription` sur la qualit√© des annonces**

**Description vide ou minimale** :
- Annonce g√©n√©r√©e tr√®s g√©n√©rique
- Manque de d√©tails concrets
- Moins percutante et valorisante

**Description d√©taill√©e** :
- Annonce riche en informations
- Mise en valeur des sp√©cificit√©s du bien
- Plus convaincante pour les prospects

**Recommandation** :
- Encourager les utilisateurs √† remplir le maximum d'informations
- Utiliser les puces pour structurer
- Inclure : emplacement, superficie, √©quipements, client√®le, ambiance, etc.

---

## **VIII. PROCESSUS COMPLET √âTAPE PAR √âTAPE**

### **√âtape par √©tape : Parcours utilisateur complet**

#### **1. Arriv√©e sur l'√âtape 2**

**Conditions** :
- L'utilisateur a valid√© l'√âtape 1
- `stepProgress.availableSteps` contient `[1, 2]`
- Navigation vers `/etape2`

**Chargement de la page** :
```typescript
// 1. V√©rification d'acc√®s
useEffect(() => {
  if (!isStepAvailable(2)) {
    navigate("/etape1"); // Redirection si pas accessible
  }
}, [isStepAvailable, navigate]);

// 2. R√©cup√©ration des donn√©es
useEffect(() => {
  const propertyData = getPropertyDataFromStorage();
  if (propertyData.propertyDescription) {
    setPropertyDescription(propertyData.propertyDescription);
  }
}, []);
```

**Affichage** :
- Hero header avec titre, sous-titre et image robot mauve
- Formulaire avec champ `propertyDescription` (vide ou pr√©-rempli)
- Bouton "Valider mes informations"
- Carte d'aide "Description du bien"
- Menu de navigation lat√©ral (√âtape 2 active)
- FAQ √âtape 2

---

#### **2. Saisie de la description**

**Action utilisateur** :
- Clic dans le textarea `propertyDescription`
- Saisie de texte libre

**Formatage automatique** :
- Chaque nouvelle ligne re√ßoit `‚Ä¢ ` en pr√©fixe
- Premi√®re lettre apr√®s `‚Ä¢ ` capitalis√©e
- Hauteur du textarea ajust√©e dynamiquement

**Exemple de saisie** :
```
‚Ä¢ Restaurant de 120m¬≤ enti√®rement √©quip√©
‚Ä¢ Situ√© dans le quartier des Brotteaux
‚Ä¢ Terrasse de 40 couverts
‚Ä¢ Cuisine professionnelle aux normes
‚Ä¢ Client√®le d'affaires √©tablie
```

---

#### **3. Validation de la description**

**Action utilisateur** :
- Clic sur "Valider mes informations"

**Processus de validation** :
```typescript
const handleValidation = () => {
  // 1. V√©rification champ non vide
  if (!propertyDescription.trim()) {
    toast({ description: "Veuillez saisir une description du bien avant de continuer." });
    return;
  }

  // 2. Sauvegarde dans localStorage
  updatePropertyData({ propertyDescription });

  // 3. Toast succ√®s
  toast({ description: "Votre description du bien a √©t√© enregistr√©e avec succ√®s." });

  // 4. D√©blocage √âtape 3
  completeStep(2);

  // 5. Navigation
  navigate("/etape3");
};
```

---

#### **4. Apr√®s validation**

**Stockage localStorage** :
```json
// Cl√©: "propertyData"
{
  "agencyName": "Mon Agence",
  "reference": "LOC-001",
  "propertyDescription": "‚Ä¢ Restaurant de 120m¬≤...\n‚Ä¢ Situ√© dans...",
  // ... autres champs
}

// Cl√©: "stepProgress"
{
  "availableSteps": [1, 2, 3] // √âtape 3 d√©bloqu√©e
}
```

**Navigation automatique** :
- Redirection vers `/etape3`
- Chargement de l'√âtape 3 (Informations financi√®res)

---

#### **5. Retour en arri√®re (modification)**

**Action utilisateur** :
- Clic sur "√âtape 2" dans le menu de navigation

**Processus** :
```typescript
// 1. Navigation vers /etape2
navigate("/etape2");

// 2. Rechargement des donn√©es
useEffect(() => {
  const propertyData = getPropertyDataFromStorage();
  if (propertyData.propertyDescription) {
    setPropertyDescription(propertyData.propertyDescription);
  }
}, []);
```

**Affichage** :
- Champ `propertyDescription` pr√©-rempli avec les donn√©es sauvegard√©es
- Modification possible
- Re-validation possible

---

## **IX. √âL√âMENTS CACH√âS / CONDITIONNELS**

### **1. Aucun √©l√©ment conditionnel dans l'√âtape 2**

**Contrairement √† l'√âtape 1** :
- L'√âtape 1 affiche conditionnellement `price` (si vente) ou `rentAmount` + `rentPeriodicity` (si location)
- **L'√âtape 2 n'a aucun champ conditionnel**
- Le champ `propertyDescription` est toujours affich√©, quel que soit le type de transaction

---

### **2. Affichage conditionnel du menu de navigation**

**√âtapes d√©sactiv√©es** :
- `DirectivesMenuOnglet` re√ßoit `disabledSteps` depuis `useStepProgress`
- Les √©tapes non encore d√©bloqu√©es sont gris√©es et non cliquables

**Pour l'√âtape 2** :
- Si `stepProgress.availableSteps = [1, 2]` ‚Üí √âtapes 3, 4, 5 d√©sactiv√©es
- Si `stepProgress.availableSteps = [1, 2, 3, 4, 5]` ‚Üí Toutes les √©tapes activ√©es

---

### **3. Affichage conditionnel de la carte "Retour √âtape 5"**

**Fonction `handleBackToEtape5()`** :
- Pr√©sente dans le code de `SaisieDescriptionForm`
- **Non utilis√©e dans l'interface actuelle**
- Pourrait √™tre utilis√©e pour afficher un bouton "Retour √† l'√âtape 5" si `hasCompletedStep4 === true`

---

## **X. TIMER DE SESSION (D√âSACTIV√â MAIS PR√âSENT)**

### **1. Cl√© localStorage : `"session_start_time"`**

**Cr√©√©e dans** : `src/components/1-Sources-Generation-Annonces/utils/useSgaForm.ts`

**Valeur** : Timestamp de d√©but de session (format ISO)

**Utilisation actuelle** : Aucune dans l'√âtape 2

---

### **2. Fonction de reset**

**Dans `useSgaForm.ts`** :
```typescript
localStorage.removeItem("session_start_time");
localStorage.removeItem("propertyDescription");
localStorage.removeItem("financials");
```

**Suppression de `propertyDescription` lors du reset** :
- Cette cl√© individuelle n'est plus utilis√©e
- La description est stock√©e dans `propertyData.propertyDescription`
- **Incoh√©rence potentielle dans le code**

---

## **XI. R√âCAPITULATIF DES CL√âS `localStorage`**

### **1. Cl√©s utilis√©es par l'√âtape 2**

| Cl√© | Type | Contenu | Cr√©√©e par | Modifi√©e par | Supprim√©e par |
|-----|------|---------|-----------|--------------|---------------|
| `propertyData` | JSON | Objet contenant tous les champs des √©tapes 1-4, dont `propertyDescription` | √âtape 1 | √âtapes 1-4 | Reset projet |
| `stepProgress` | JSON | `{ availableSteps: [1, 2, 3] }` | √âtape 1 | Toutes les √©tapes | Reset projet |

---

### **2. Cl√©s cr√©√©es par d'autres √©tapes (contexte)**

| Cl√© | Type | Contenu | Cr√©√©e par | Utilis√©e par |
|-----|------|---------|-----------|--------------|
| `generation_website_ad` | JSON | Annonce Site Internet g√©n√©r√©e | √âtape 5 | Page de restitution |
| `generation_summary_sheet` | JSON | Fiche de Synth√®se g√©n√©r√©e | √âtape 5 | Page de restitution |
| `generation_newsletter` | JSON | Annonce Newsletter g√©n√©r√©e | √âtape 5 | Page de restitution |
| `generation_seo_tools` | JSON | Outils SEO g√©n√©r√©s | √âtape 5 | Page de restitution |
| `generation_sms_ad` | JSON | Annonce SMS g√©n√©r√©e | Fonction SMS | Page de restitution |
| `generation_google_business_ad` | JSON | Annonce Google Business g√©n√©r√©e | Fonction GBP | Page de restitution |
| `generation_social_media_ad` | JSON | Annonce R√©seaux Sociaux g√©n√©r√©e | Fonction RS | Page de restitution |
| `session_start_time` | String | Timestamp ISO | `useSgaForm` | Aucune (d√©sactiv√©) |

---

### **3. Structure d√©taill√©e de `propertyData` apr√®s √âtape 2**

```json
{
  "agencyName": "Mon Agence Immobili√®re",
  "reference": "LOC-2024-001",
  "exclusivite": "Oui",
  "location": "Lyon 6√®me",
  "propertyType": "Restaurant",
  "saleType": "√† louer",
  "price": "",
  "rentAmount": "3 500‚Ç¨",
  "rentPeriodicity": "Mensuel",
  "keyElements": "‚Ä¢ Emplacement strat√©gique\n‚Ä¢ Forte affluence\n‚Ä¢ Licence IV",
  "propertyDescription": "‚Ä¢ Restaurant de 120m¬≤ enti√®rement √©quip√©\n‚Ä¢ Situ√© dans le quartier des Brotteaux\n‚Ä¢ Terrasse de 40 couverts\n‚Ä¢ Cuisine professionnelle aux normes\n‚Ä¢ Client√®le d'affaires √©tablie"
}
```

---

## **XII. DONNEES DE L'ETAPE 2 √Ä PRENDRE EN CONSID√âRATION**

### **1. Champs `propertyData`**

| Champs localStorage | Type | Obligatoire | Valeur par d√©faut | Commentaire |
|---------------------|------|-------------|-------------------|-------------|
| `propertyDescription` | string | Oui | `""` | Description d√©taill√©e du bien, format√©e avec puces `‚Ä¢ ` |

---

### **2. Cl√©s `generation_*`**

| Cl√©s localStorage | Type | Cr√©√©e par | Utilise `propertyDescription` |
|-------------------|------|-----------|-------------------------------|
| `generation_website_ad` | JSON | √âtape 5 | Oui |
| `generation_summary_sheet` | JSON | √âtape 5 | Oui |
| `generation_newsletter` | JSON | √âtape 5 | Oui |
| `generation_seo_tools` | JSON | √âtape 5 | Oui |
| `generation_sms_ad` | JSON | Fonction SMS | Oui |
| `generation_google_business_ad` | JSON | Fonction GBP | Oui |
| `generation_social_media_ad` | JSON | Fonction RS | Oui |

---

### **3. Fonctions**

| Fonctions | Fichier | R√¥le |
|-----------|---------|------|
| `getPropertyDataFromStorage()` | `src/services/openai.ts` | R√©cup√®re `propertyData` depuis `localStorage` |
| `updatePropertyData()` | `src/services/openai.ts` | Met √† jour `propertyData` dans `localStorage` |
| `completeStep(2)` | `src/components/1-Sources-Generation-Annonces/utils/useStepProgress.ts` | D√©bloque l'√âtape 3 en ajoutant `3` √† `stepProgress.availableSteps` |
| `handleValidation()` | `src/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm.tsx` | Valide `propertyDescription`, sauvegarde, et navigue vers √âtape 3 |
| `handleDescriptionChange()` | `src/components/1-Sources-Generation-Annonces/form-etape2/SaisieDescriptionForm.tsx` | Met √† jour le state `propertyDescription` |
| `handleInputChange()` | `src/components/1-Sources-Generation-Annonces/form-components/FormulaireSaisie.tsx` | Formate le texte avec puces `‚Ä¢ ` et capitalisation |
| `adjustHeight()` | `src/components/1-Sources-Generation-Annonces/form-components/FormulaireSaisie.tsx` | Ajuste dynamiquement la hauteur du textarea |

---

### **4. Rappel des d√©pendances entre les √©tapes**

| √âtape | Pr√©requis | Donn√©es cr√©√©es | Donn√©es utilis√©es | √âtape suivante d√©bloqu√©e |
|-------|-----------|----------------|-------------------|--------------------------|
| √âtape 1 | Aucun | `agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements` | - | √âtape 2 |
| **√âtape 2** | **√âtape 1 compl√©t√©e** | **`propertyDescription`** | **Toutes les donn√©es de l'√âtape 1** | **√âtape 3** |
| √âtape 3 | √âtape 2 compl√©t√©e | `financials` | Toutes les donn√©es des √âtapes 1-2 | √âtape 4 |
| √âtape 4 | √âtape 3 compl√©t√©e | `details`, `hasNoDetails` | Toutes les donn√©es des √âtapes 1-3 | √âtape 5 |
| √âtape 5 | √âtape 4 compl√©t√©e | Cl√©s `generation_*` (annonces g√©n√©r√©es) | **Toutes les donn√©es des √âtapes 1-4, dont `propertyDescription`** | - |

---


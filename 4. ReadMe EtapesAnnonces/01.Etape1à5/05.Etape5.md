# üìã DOCUMENTATION COMPL√àTE - √âTAPE 5

## üéØ MISSION DU DOCUMENT

Cette documentation d√©crit **l'√âtape 5** du processus de g√©n√©ration d'annonces immobili√®res commerciales. Contrairement aux √©tapes pr√©c√©dentes, **l'√âtape 5 ne collecte AUCUNE nouvelle donn√©e utilisateur**. Son r√¥le est d'**orchestrer la g√©n√©ration automatique** de toutes les annonces et outils SEO via OpenAI en utilisant les donn√©es collect√©es lors des √©tapes 1 √† 4.

---

## üìë SOMMAIRE CLIQUABLE

1. [ARCHITECTURE GLOBALE - √âTAPE 5](#i-architecture-globale---√©tape-5)
2. [FICHIERS UTILIS√âS (Liste exhaustive)](#ii-fichiers-utilis√©s-liste-exhaustive)
3. [STRUCTURE DES DONN√âES DANS localStorage](#iii-structure-des-donn√©es-dans-localstorage)
4. [LOGIQUE DE VALIDATION DES CHAMPS](#iv-logique-de-validation-des-champs)
5. [CONTRAINTES ET R√àGLES M√âTIER](#v-contraintes-et-r√®gles-m√©tier)
6. [NAVIGATION ET RETOUR EN ARRI√àRE](#vi-navigation-et-retour-en-arri√®re)
7. [UTILISATION DES DONN√âES PAR OPENAI](#vii-utilisation-des-donn√©es-par-openai)
8. [PROCESSUS COMPLET √âTAPE PAR √âTAPE](#viii-processus-complet-√©tape-par-√©tape)
9. [√âL√âMENTS CACH√âS / CONDITIONNELS](#ix-√©l√©ments-cach√©s--conditionnels)
10. [TIMER DE SESSION (D√âSACTIV√â MAIS PR√âSENT)](#x-timer-de-session-d√©sactiv√©-mais-pr√©sent)
11. [R√âCAPITULATIF DES CL√âS localStorage](#xi-r√©capitulatif-des-cl√©s-localstorage)
12. [DONN√âES DE L'√âTAPE 5 √Ä PRENDRE EN CONSID√âRATION](#xii-donn√©es-de-l√©tape-5-√†-prendre-en-consid√©ration)

---

## I. ARCHITECTURE GLOBALE - √âTAPE 5

### Vue d'ensemble

L'**√âtape 5** est le **point culminant** du processus de g√©n√©ration. Elle :
- ‚úÖ **R√©cup√®re** toutes les donn√©es des √©tapes 1-4 depuis `localStorage.propertyData`
- ‚úÖ **Lance** 7 appels s√©quentiels √† l'API OpenAI pour g√©n√©rer les annonces
- ‚úÖ **Stocke** les r√©sultats dans `localStorage` (cl√©s `generation_*`)
- ‚úÖ **Affiche** une page d'animation pendant la g√©n√©ration
- ‚úÖ **Redirige** vers l'√©tape 6 (Communication) une fois termin√©

### Flux de donn√©es simplifi√©es

```
localStorage.propertyData (√âtapes 1-4)
         ‚Üì
    √âtape 5
         ‚Üì
   OpenAI API (7 appels)
         ‚Üì
localStorage.generation_* (7 cl√©s)
         ‚Üì
  Page Animation
         ‚Üì
√âtape 6 Communication
```

### Sch√©ma complet Mermaid
```mermaid
graph TD
    A[Chargement Etape5.tsx] --> B[useStepProgress v√©rifie acc√®s]
    B -->|√âtape 5 non disponible| C[Redirection /etape1]
    B -->|√âtape 5 disponible| D[Affichage page √âtape 5]
    D --> E[useEffect: V√©rification timer session]
    E --> F{Cl√© OpenAI disponible?}
    F -->|Non| G[useOpenAI Context - Cl√© par d√©faut]
    F -->|Oui| H[Cl√© r√©cup√©r√©e depuis OpenAIContext]
    H --> I[Affichage Interface √âtape 5]
    I --> J[Utilisateur clique 'G√©n√©rer mes Annonces']
    J --> K{isGenerating?}
    K -->|Oui| L[Fonction bloqu√©e]
    K -->|Non| M[setIsGenerating true]
    M --> N[resetSessionTimer]
    N --> O[getPropertyDataFromStorage]
    O --> P{OpenAI API Key valide?}
    P -->|Non| Q[Toast erreur + Return]
    P -->|Oui| R[Initialisation generation_status dans localStorage]
    R --> S[completeStep 5]
    S --> T[Navigation vers /etape5/animation]
    T --> U[Cr√©ation services OpenAI]
    U --> V[Appel 1: generateWebsiteAd]
    V --> W[Sauvegarde generation_website_ad + updateGenerationStatus 14%]
    W --> X[Appel 2: generateSummarySheetAd]
    X --> Y[Sauvegarde generation_summary_sheet + updateGenerationStatus 28%]
    Y --> Z[Appel 3: generateNewsletterAd]
    Z --> AA[Sauvegarde generation_newsletter + updateGenerationStatus 42%]
    AA --> AB[Appel 4: generateSEOTools]
    AB --> AC[Sauvegarde generation_seo_tools + updateGenerationStatus 56%]
    AC --> AD[Appel 5: generateSMSAd]
    AD --> AE[Sauvegarde generation_sms_ad + updateGenerationStatus 70%]
    AE --> AF[Appel 6: generateGoogleBusinessProfileAd]
    AF --> AG[Sauvegarde generation_googleprofile_ad + updateGenerationStatus 85%]
    AG --> AH[Appel 7: generateReseauxSociauxAd]
    AH --> AI[Sauvegarde generation_reseauxsociaux_ad + updateGenerationStatus 100%]
    AI --> AJ[updateGenerationStatus completed: true]
    AJ --> AK[setTimeout 1 seconde]
    AK --> AL[Navigation vers /etape6communication]

    style A fill:#E5DEFF
    style D fill:#9b87f5
    style I fill:#D6BCFA
    style J fill:#F1940F
    style T fill:#4A2B87,color:#fff
    style AL fill:#0EA5E9,color:#fff
```
### D√©tail du flux

1. **Chargement initial** : `Etape5.tsx` s'affiche
2. **V√©rification d'acc√®s** : `useStepProgress(5)` v√©rifie que l'√©tape 5 est disponible
3. **R√©cup√©ration cl√© OpenAI** : Via le contexte `OpenAIContext`
4. **Clic utilisateur** : Sur le bouton "G√©n√©rer mes Annonces"
5. **Validation cl√©** : Si pas de cl√© ‚Üí erreur
6. **Initialisation status** : Cr√©ation de `generation_status` dans `localStorage`
7. **Navigation animation** : Redirection vers `/etape5/animation`
8. **7 appels OpenAI s√©quentiels** : Chaque appel met √† jour le statut de progression
9. **Sauvegarde r√©sultats** : Dans les cl√©s `generation_*`
10. **Redirection finale** : Vers `/etape6communication`

---

## II. FICHIERS UTILIS√âS (Liste exhaustive)

### üìÑ 1. **src/1.etapes-generation-annonces/etape5/Etape5.tsx**
**R√¥le** : Page principale de l'√âtape 5 - Orchestrateur de la g√©n√©ration OpenAI  
**Fonctions cl√©s** :
- `handleValidateAndFinish()` : Lance la g√©n√©ration OpenAI
- `updateGenerationStatus()` : Met √† jour la progression dans `localStorage`

**Code cl√©** :
```typescript
const handleValidateAndFinish = async () => {
  setIsGenerating(true);
  resetSessionTimer();
  const propertyData = getPropertyDataFromStorage();

  // Initialisation du statut
  localStorage.setItem('generation_status', JSON.stringify({
    startTime: new Date().getTime(),
    websiteAd: false,
    summarySheet: false,
    newsletter: false,
    seoTools: false,
    smsAd: false,
    googleBusinessProfile: false,
    reseauxSociaux: false,
    completed: false,
    progress: 0
  }));

  completeStep(5);
  navigate("/etape5/animation");

  // 7 appels s√©quentiels OpenAI...
};
```

---

### üìÑ 2. **src/1.etapes-generation-annonces/etape5/SafeEtape5.tsx**
**R√¥le** : Version alternative (d√©sactiv√©e) de l'√âtape 5  
**Diff√©rence** : Gestion du timer de session plus visible dans l'UI

---

### üìÑ 3. **src/1.etapes-generation-annonces/etape5/Animation.tsx**
**R√¥le** : Page d'animation affich√©e pendant la g√©n√©ration OpenAI  
**Fonctions cl√©s** :
- `checkGenerationStatus()` : Surveille `generation_status` toutes les 500ms
- Redirection automatique vers `/etape6communication` quand `completed: true`

**Code cl√©** :
```typescript
useEffect(() => {
  const checkGenerationStatus = () => {
    const status: GenerationStatus = JSON.parse(localStorage.getItem('generation_status'));
    setProgressValue(status.progress);

    if (status.completed) {
      setTimeout(() => navigate("/etape6communication"), 1500);
    }
  };

  const intervalId = setInterval(checkGenerationStatus, 500);
  return () => clearInterval(intervalId);
}, [navigate]);
```

---

### üìÑ 4. **src/components/1-Sources-Generation-Annonces/form-components/BoutonEtape5LancerOpenAI.tsx**
**R√¥le** : Bouton principal de lancement de la g√©n√©ration  
**Props** :
- `onClick` : Fonction `handleValidateAndFinish`
- `disabled` : √âtat `isGenerating`
- `isGenerating` : Affiche animation de pulse

**Code cl√©** :
```typescript

  {isGenerating ? "G√©n√©ration en cours..." : "G√©n√©rer mes Annonces"}

```

---

### üìÑ 5. **src/services/openai.ts**
**R√¥le** : Service principal OpenAI - Contient les 4 m√©thodes de g√©n√©ration principales  
**Fonctions** :
- `generateWebsiteAd()` : Annonce Site Internet
- `generateSummarySheetAd()` : Fiche de Synth√®se
- `generateNewsletterAd()` : Annonce Newsletter
- `generateSEOTools()` : Outils SEO

**Utilisation des donn√©es** : TOUTES les donn√©es de `propertyData` (√©tapes 1-4)

---

### üìÑ 6. **src/services/openai/.../1.API-AnnonceSMS.ts**
**R√¥le** : Service pour g√©n√©rer l'annonce SMS  
**Fonction** : `generateSMSAd()`  
**Retour** : `{ "restitution-annonce-sms": string }`

---

### üìÑ 7. **src/services/openai/.../2.API-AnnonceGoogleBusinessProfile.ts**
**R√¥le** : Service pour g√©n√©rer l'annonce Google Business Profile  
**Fonction** : `generateGoogleBusinessProfileAd()`  
**Retour** :
```typescript
{
  TitreAnnonceGoogle: string;
  AccrocheDescriptiveAnnonceGoogle: string;
  PointsFortsAnnonceGoogle: string;
  CtaAnnonceGoogle: string;
}
```

---

### üìÑ 8. **src/services/openai/.../3.API-AnnonceReseauxSociaux.ts**
**R√¥le** : Service pour g√©n√©rer l'annonce R√©seaux Sociaux  
**Fonction** : `generateReseauxSociauxAd()`  
**Retour** :
```typescript
{
  TitreAnnonceReseaux: string;
  AccrocheImpactanteAnnonceReseaux: string;
  AtoutsAnnonceReseaux: string;
  CtaAnnonceReseaux: string;
}
```

---

### üìÑ 9. **src/contexts/OpenAIContext.tsx**
**R√¥le** : Contexte React pour g√©rer les cl√©s API OpenAI  
**√âtat** :
- `apiKey` : Cl√© OpenAI principale (valeur par d√©faut hard-cod√©e)
- `assistantId` : ID de l'assistant OpenAI

**Code cl√©** :
```typescript
const DEFAULT_API_KEY = "sk-proj-...";
const { apiKey } = useOpenAI(); // Utilis√© dans Etape5.tsx
```

---

### üìÑ 10. **src/components/1-Sources-Generation-Annonces/utils/useStepProgress.ts**
**R√¥le** : Hook pour g√©rer la progression entre √©tapes  
**Fonctions utilis√©es dans √âtape 5** :
- `isStepAvailable(5)` : V√©rifie l'acc√®s √† l'√©tape 5
- `completeStep(5)` : Marque l'√©tape 5 comme termin√©e
- `handleConfirmNewProject()` : R√©initialise tout le projet

---

### üìÑ 11. **src/components/atemplate.v2.generation-annonces/DirectivesMenuOnglet.tsx**
**R√¥le** : Menu de navigation lat√©ral avec onglets des √©tapes 1-4  
**Props** :
- `activeStep={5}` : Indique l'√©tape actuelle
- `disabledSteps` : √âtapes non accessibles

---

### üìÑ 12. **src/0.structure-type-page/structure5HeroPetit/StructureHeroPetit.tsx**
**R√¥le** : Composant header avec titre, sous-titre et image robot  
**Props** :
- `title` : "F√©licitations ! Vos Annonces et Outils sont pr√™ts..."
- `subtitle` : "Tous les √©l√©ments n√©cessaires..."
- `imageSrc` : Image du robot IA

---

## III. STRUCTURE DES DONN√âES DANS localStorage

### 1. **localStorage.propertyData** (Lecture seule √† l'√âtape 5)

**Source** : Donn√©es collect√©es lors des √âtapes 1 √† 4  
**Utilisation** : R√©cup√©r√©es via `getPropertyDataFromStorage()` puis envoy√©es √† OpenAI

| Champ | √âtape d'origine | Utilisation OpenAI |
|-------|-----------------|-------------------|
| `agencyName` | √âtape 1 | ‚úÖ Toutes les annonces |
| `reference` | √âtape 1 | ‚úÖ Toutes les annonces |
| `exclusivite` | √âtape 1 | ‚úÖ Toutes les annonces |
| `location` | √âtape 1 | ‚úÖ Toutes les annonces |
| `propertyType` | √âtape 1 | ‚úÖ Toutes les annonces |
| `saleType` | √âtape 1 | ‚úÖ Toutes les annonces |
| `price` | √âtape 1 | ‚úÖ Toutes les annonces |
| `rentAmount` | √âtape 1 | ‚úÖ Toutes les annonces |
| `rentPeriodicity` | √âtape 1 | ‚úÖ Toutes les annonces |
| `keyElements` | √âtape 1 | ‚úÖ Toutes les annonces |
| `propertyDescription` | √âtape 2 | ‚úÖ Toutes les annonces |
| `financials` | √âtape 3 | ‚úÖ Toutes les annonces |
| `details` | √âtape 4 | ‚úÖ Fiche de Synth√®se uniquement |
| `hasNoDetails` | √âtape 4 | ‚úÖ Logique conditionnelle |

---

### 2. **localStorage.stepProgress** (Mise √† jour)

**Avant √âtape 5** : `[1, 2, 3, 4, 5]`  
**Apr√®s `completeStep(5)`** : `[1, 2, 3, 4, 5, 6]` ‚Üí D√©bloque l'acc√®s √† l'√©tape 6

---

### 3. **localStorage.generation_status** (Cr√©√© par l'√âtape 5)

**Structure** :
```typescript
interface GenerationStatus {
  startTime: number;           // Timestamp de d√©but
  websiteAd: boolean;          // √âtape 1/7 termin√©e
  summarySheet: boolean;       // √âtape 2/7 termin√©e
  newsletter: boolean;         // √âtape 3/7 termin√©e
  seoTools: boolean;           // √âtape 4/7 termin√©e
  smsAd: boolean;              // √âtape 5/7 termin√©e
  googleBusinessProfile: boolean; // √âtape 6/7 termin√©e
  reseauxSociaux: boolean;     // √âtape 7/7 termin√©e
  completed: boolean;          // Toutes les √©tapes termin√©es
  progress: number;            // % de progression (0-100)
}
```

**Utilisation** : Surveill√© par `Animation.tsx` pour afficher la progression

---

### 4. **localStorage.generation_website_ad** (Cr√©√© par l'√âtape 5)

**Contenu** : R√©sultat JSON de `generateWebsiteAd()`
```json
{
  "titre": "...",
  "accroche": "...",
  "descriptif": "...",
  "cta": "..."
}
```

---

### 5. **localStorage.generation_summary_sheet** (Cr√©√© par l'√âtape 5)

**Contenu** : R√©sultat JSON de `generateSummarySheetAd()`
```json
{
  "titre": "...",
  "referenceEtPrix": "...",
  "detailsCles": "...",
  "donneesFinancieres": "...",
  "informationsComplementaires": "..."
}
```

---

### 6. **localStorage.generation_newsletter** (Cr√©√© par l'√âtape 5)

**Contenu** : R√©sultat JSON de `generateNewsletterAd()`
```json
{
  "titre": "...",
  "accroche": "...",
  "pointsForts": "...",
  "callToAction": "...",
  "prixEtReference": "..."
}
```

---

### 7. **localStorage.generation_seo_tools** (Cr√©√© par l'√âtape 5)

**Contenu** : R√©sultat JSON de `generateSEOTools()`
```json
{
  "baliseTitre": "...",
  "baliseMetaDescription": "...",
  "urlLongueTraine": "..."
}
```

---

### 8. **localStorage.generation_sms_ad** (Cr√©√© par l'√âtape 5)

**Contenu** : R√©sultat JSON de `generateSMSAd()`
```json
{
  "restitution-annonce-sms": "..."
}
```

---

### 9. **localStorage.generation_googleprofile_ad** (Cr√©√© par l'√âtape 5)

**Contenu** : R√©sultat JSON de `generateGoogleBusinessProfileAd()`
```json
{
  "TitreAnnonceGoogle": "...",
  "AccrocheDescriptiveAnnonceGoogle": "...",
  "PointsFortsAnnonceGoogle": "...",
  "CtaAnnonceGoogle": "..."
}
```

---

### 10. **localStorage.generation_reseauxsociaux_ad** (Cr√©√© par l'√âtape 5)

**Contenu** : R√©sultat JSON de `generateReseauxSociauxAd()`
```json
{
  "TitreAnnonceReseaux": "...",
  "AccrocheImpactanteAnnonceReseaux": "...",
  "AtoutsAnnonceReseaux": "...",
  "CtaAnnonceReseaux": "..."
}
```

---

### 11. **localStorage.session_start_time** (Lecture seule)

**R√¥le** : Timer de session (d√©sactiv√© mais pr√©sent dans `SafeEtape5.tsx`)  
**Utilisation** : Calcule le temps restant avant expiration de la session

---

## IV. LOGIQUE DE VALIDATION DES CHAMPS

### ‚ö†Ô∏è **AUCUNE VALIDATION DE CHAMPS √Ä L'√âTAPE 5**

L'√âtape 5 **ne collecte AUCUNE donn√©e utilisateur**. Elle se contente de :
1. ‚úÖ V√©rifier la pr√©sence d'une cl√© OpenAI (`openAIApiKey`)
2. ‚úÖ V√©rifier que `propertyData` existe dans le `localStorage`

### Validation unique : Cl√© OpenAI

```typescript
if (!openAIApiKey) {
  toast({
    title: "Erreur de configuration",
    description: "Cl√© API OpenAI manquante...",
    duration: 5000
  });
  setIsGenerating(false);
  return;
}
```

**Si la cl√© est absente** : Toast d'erreur + arr√™t du processus  
**Si la cl√© est pr√©sente** : Lancement de la g√©n√©ration

---

## V. CONTRAINTES ET R√àGLES M√âTIER

### 1. **Contrainte d'acc√®s**
- L'utilisateur **DOIT** avoir compl√©t√© les √©tapes 1 √† 4
- V√©rification via `isStepAvailable(5)` :
  ```typescript
  if (!isStepAvailable(5)) {
    navigate("/etape1"); // Redirection si acc√®s non autoris√©
  }
  ```

---

### 2. **Contrainte de cl√© OpenAI**
- Une cl√© OpenAI **DOIT** √™tre configur√©e
- Par d√©faut : cl√© hard-cod√©e dans `OpenAIContext.tsx`
- Possibilit√© de personnalisation via stockage dans `localStorage`

---

### 3. **Contrainte de s√©quentialit√©**
- Les 7 appels OpenAI sont **s√©quentiels** (un apr√®s l'autre)
- Chaque appel attend le r√©sultat du pr√©c√©dent avant de continuer
- **Raison** : Mise √† jour progressive du statut de g√©n√©ration

---

### 4. **Contrainte de navigation**
- Redirection **automatique** vers `/etape5/animation` d√®s le clic sur "G√©n√©rer"
- Redirection **automatique** vers `/etape6communication` une fois la g√©n√©ration termin√©e
- **Aucune intervention manuelle** requise

---

### 5. **Contrainte de gestion d'erreur**
- Chaque appel OpenAI est entour√© d'un `try-catch`
- En cas d'erreur : Log dans la console + **poursuite** du processus
- **Pas d'interruption** si un appel √©choue

```typescript
try {
  const websiteAdResult = await openAIService.generateWebsiteAd(propertyData);
  localStorage.setItem('generation_website_ad', JSON.stringify(websiteAdResult));
  updateGenerationStatus('websiteAd', true, 14);
} catch (error) {
  console.error("Erreur lors de la g√©n√©ration de l'annonce site internet:", error);
  // Continue vers l'appel suivant
}
```

---

### 6. **Contrainte de progression**
- Le statut de progression est mis √† jour √† **7 paliers** :
  - 14% ‚Üí Annonce Site Internet
  - 28% ‚Üí Fiche de Synth√®se
  - 42% ‚Üí Annonce Newsletter
  - 56% ‚Üí Outils SEO
  - 70% ‚Üí Annonce SMS
  - 85% ‚Üí Annonce Google Business Profile
  - 100% ‚Üí Annonce R√©seaux Sociaux

---

## VI. NAVIGATION ET RETOUR EN ARRI√àRE

### 1. **Arriv√©e sur l'√âtape 5**

**Depuis l'√âtape 4** :
- Clic sur "Valider et passer √† l'√©tape suivante" dans √âtape 4
- `navigate("/etape5")` ‚Üí Affichage de `Etape5.tsx`

**Depuis l'√âtape 6 (retour arri√®re)** :
- Clic sur l'onglet "√âtape 5" dans `DirectivesMenuOnglet`
- `navigate("/etape5")` ‚Üí Affichage de `Etape5.tsx`

---

### 2. **Navigation au sein de l'√âtape 5**

**Clic sur "G√©n√©rer mes Annonces"** :
1. Lancement de `handleValidateAndFinish()`
2. Redirection imm√©diate vers `/etape5/animation`
3. Page d'animation affich√©e **pendant** les appels OpenAI
4. Redirection automatique vers `/etape6communication` une fois termin√©

---

### 3. **Modification des donn√©es (retour arri√®re)**

**Depuis l'√âtape 5** :
- Clic sur un onglet du `DirectivesMenuOnglet` (√âtapes 1-4)
- Modification des donn√©es dans l'√©tape concern√©e
- Retour sur l'√âtape 5 via le menu
- **Relance de la g√©n√©ration** n√©cessaire pour mettre √† jour les annonces

**Comportement** :
- Les anciennes annonces (`generation_*`) restent dans le `localStorage`
- **√âcrasement** lors de la prochaine g√©n√©ration

---

### 4. **Cr√©ation d'un nouveau projet**

**Depuis l'√âtape 5** :
- Clic sur "G√©n√©rer un nouveau projet" (bouton poubelle dans `SafeEtape5.tsx`)
- Appel de `handleConfirmNewProject()`
- **Suppression totale** : `localStorage.clear()`
- Redirection vers `/etape1` + `window.location.reload()`

---

## VII. UTILISATION DES DONN√âES PAR OPENAI

### üöÄ **7 Appels OpenAI s√©quentiels**

L'√âtape 5 orchestre **7 g√©n√©rations** distinctes en utilisant les donn√©es de `propertyData` :

---

### 1. **generateWebsiteAd** ‚Üí Annonce Site Internet

**Service** : `openai.ts` ‚Üí `OpenAIService.generateWebsiteAd()`  
**Donn√©es utilis√©es** :
- ‚úÖ Toutes les donn√©es de l'√©tape 1 (`agencyName`, `reference`, `exclusivite`, `location`, `propertyType`, `saleType`, `price`, `rentAmount`, `rentPeriodicity`, `keyElements`)
- ‚úÖ `propertyDescription` (√âtape 2)
- ‚úÖ `financials` (√âtape 3)
- ‚úÖ `details` (√âtape 4)

**Retour** :
```json
{
  "titre": "...",
  "accroche": "...",
  "descriptif": "...",
  "cta": "..."
}
```

**Stockage** : `localStorage.generation_website_ad`

---

### 2. **generateSummarySheetAd** ‚Üí Fiche de Synth√®se

**Service** : `openai.ts` ‚Üí `OpenAIService.generateSummarySheetAd()`  
**Donn√©es utilis√©es** :
- ‚úÖ Toutes les donn√©es de l'√©tape 1
- ‚úÖ `propertyDescription` (√âtape 2)
- ‚úÖ `financials` (√âtape 3)
- ‚úÖ **`details` (√âtape 4)** ‚Üê SEULE UTILISATION DU CHAMP `details`

**Retour** :
```json
{
  "titre": "...",
  "referenceEtPrix": "...",
  "detailsCles": "...",
  "donneesFinancieres": "...",
  "informationsComplementaires": "..."
}
```

**Stockage** : `localStorage.generation_summary_sheet`

---

### 3. **generateNewsletterAd** ‚Üí Annonce Newsletter

**Service** : `openai.ts` ‚Üí `OpenAIService.generateNewsletterAd()`  
**Donn√©es utilis√©es** :
- ‚úÖ Toutes les donn√©es de l'√©tape 1
- ‚úÖ `propertyDescription` (√âtape 2)
- ‚úÖ `financials` (√âtape 3)

**Retour** :
```json
{
  "titre": "...",
  "accroche": "...",
  "pointsForts": "...",
  "callToAction": "...",
  "prixEtReference": "..."
}
```

**Stockage** : `localStorage.generation_newsletter`

---

### 4. **generateSEOTools** ‚Üí Outils SEO

**Service** : `openai.ts` ‚Üí `OpenAIService.generateSEOTools()`  
**Donn√©es utilis√©es** :
- ‚úÖ Toutes les donn√©es de l'√©tape 1
- ‚úÖ `propertyDescription` (√âtape 2)
- ‚úÖ `financials` (√âtape 3)

**Retour** :
```json
{
  "baliseTitre": "...",
  "baliseMetaDescription": "...",
  "urlLongueTraine": "..."
}
```

**Stockage** : `localStorage.generation_seo_tools`

---

### 5. **generateSMSAd** ‚Üí Annonce SMS

**Service** : `1.API-AnnonceSMS.ts` ‚Üí `OpenAISMSService.generateSMSAd()`  
**Donn√©es utilis√©es** :
- ‚úÖ Toutes les donn√©es de l'√©tape 1
- ‚úÖ `propertyDescription` (√âtape 2)
- ‚úÖ `financials` (√âtape 3)

**Retour** :
```json
{
  "restitution-annonce-sms": "..."
}
```

**Stockage** : `localStorage.generation_sms_ad`

---

### 6. **generateGoogleBusinessProfileAd** ‚Üí Annonce Google Business Profile

**Service** : `2.API-AnnonceGoogleBusinessProfile.ts` ‚Üí `OpenAIGoogleBusinessProfileService.generateGoogleBusinessProfileAd()`  
**Donn√©es utilis√©es** :
- ‚úÖ Toutes les donn√©es de l'√©tape 1
- ‚úÖ `propertyDescription` (√âtape 2)
- ‚úÖ `financials` (√âtape 3)

**Retour** :
```json
{
  "TitreAnnonceGoogle": "...",
  "AccrocheDescriptiveAnnonceGoogle": "...",
  "PointsFortsAnnonceGoogle": "...",
  "CtaAnnonceGoogle": "..."
}
```

**Stockage** : `localStorage.generation_googleprofile_ad`

---

### 7. **generateReseauxSociauxAd** ‚Üí Annonce R√©seaux Sociaux

**Service** : `3.API-AnnonceReseauxSociaux.ts` ‚Üí `OpenAIReseauxSociauxService.generateReseauxSociauxAd()`  
**Donn√©es utilis√©es** :
- ‚úÖ Toutes les donn√©es de l'√©tape 1
- ‚úÖ `propertyDescription` (√âtape 2)
- ‚úÖ `financials` (√âtape 3)

**Retour** :
```json
{
  "TitreAnnonceReseaux": "...",
  "AccrocheImpactanteAnnonceReseaux": "...",
  "AtoutsAnnonceReseaux": "...",
  "CtaAnnonceReseaux": "..."
}
```

**Stockage** : `localStorage.generation_reseauxsociaux_ad`

---

## VIII. PROCESSUS COMPLET √âTAPE PAR √âTAPE

### üé¨ **Sc√©nario utilisateur standard**

#### **1. Arriv√©e sur l'√âtape 5**
- L'utilisateur a compl√©t√© les √©tapes 1 √† 4
- Navigation via clic "Valider et passer √† l'√©tape suivante" dans √âtape 4
- Affichage de `Etape5.tsx`

---

#### **2. V√©rification d'acc√®s**
- `useStepProgress(5)` v√©rifie que `stepProgress` contient `[1, 2, 3, 4, 5]`
- Si l'√©tape 5 n'est pas disponible ‚Üí Redirection `/etape1`
- Si OK ‚Üí Affichage de la page

---

#### **3. Affichage de l'interface**
- **Header** : "F√©licitations ! Vos Annonces et Outils sont pr√™ts √† √™tre g√©n√©r√©s"
- **Image** : Robot IA mauve
- **Texte** : "Si tout est en ordre, lancez notre IA..."
- **Bouton** : "G√©n√©rer mes Annonces" (`BoutonEtape5LancerOpenAI`)
- **Menu lat√©ral** : `DirectivesMenuOnglet` avec onglets des √©tapes 1-4

---

#### **4. Modification optionnelle**
- L'utilisateur peut cliquer sur un onglet du menu (√âtapes 1-4)
- Modification des donn√©es
- Retour sur l'√âtape 5 via le menu
- **Les donn√©es modifi√©es seront prises en compte** lors de la prochaine g√©n√©ration

---

#### **5. Lancement de la g√©n√©ration**
- Clic sur "G√©n√©rer mes Annonces"
- Appel de `handleValidateAndFinish()`
- `setIsGenerating(true)` ‚Üí D√©sactive le bouton
- `resetSessionTimer()` ‚Üí R√©initialise le timer de session
- `getPropertyDataFromStorage()` ‚Üí R√©cup√®re toutes les donn√©es

---

#### **6. Validation de la cl√© OpenAI**
- V√©rification de `openAIApiKey` depuis `OpenAIContext`
- Si absente ‚Üí Toast d'erreur + `return`
- Si pr√©sente ‚Üí Suite du processus

---

#### **7. Initialisation du statut de g√©n√©ration**
```typescript
localStorage.setItem('generation_status', JSON.stringify({
  startTime: new Date().getTime(),
  websiteAd: false,
  summarySheet: false,
  newsletter: false,
  seoTools: false,
  smsAd: false,
  googleBusinessProfile: false,
  reseauxSociaux: false,
  completed: false,
  progress: 0
}));
```

---

#### **8. Marquage de l'√©tape 5 comme compl√©t√©e**
- `completeStep(5)` ‚Üí Ajoute `6` √† `stepProgress`
- `stepProgress` devient `[1, 2, 3, 4, 5, 6]`

---

#### **9. Redirection vers la page d'animation**
- `navigate("/etape5/animation")`
- Affichage de `Animation.tsx` avec robot anim√©
- Barre de progression circulaire affich√©e

---

#### **10. Cr√©ation des services OpenAI**
```typescript
const openAIService = createOpenAIService(openAIApiKey);
const openAISMSService = createOpenAISMSService(openAIApiKey);
const openAIGoogleBusinessProfileService = createOpenAIGoogleBusinessProfileService(openAIApiKey);
const openAIReseauxSociauxService = createOpenAIReseauxSociauxService(openAIApiKey);
```

---

#### **11. Appel 1/7 : Annonce Site Internet**
```typescript
const websiteAdResult = await openAIService.generateWebsiteAd(propertyData);
localStorage.setItem('generation_website_ad', JSON.stringify(websiteAdResult));
updateGenerationStatus('websiteAd', true, 14);
```
**Progression** : 14%

---

#### **12. Appel 2/7 : Fiche de Synth√®se**
```typescript
const summarySheetResult = await openAIService.generateSummarySheetAd(propertyData);
localStorage.setItem('generation_summary_sheet', JSON.stringify(summarySheetResult));
updateGenerationStatus('summarySheet', true, 28);
```
**Progression** : 28%

---

#### **13. Appel 3/7 : Annonce Newsletter**
```typescript
const newsletterResult = await openAIService.generateNewsletterAd(propertyData);
localStorage.setItem('generation_newsletter', JSON.stringify(newsletterResult));
updateGenerationStatus('newsletter', true, 42);
```
**Progression** : 42%

---

#### **14. Appel 4/7 : Outils SEO**
```typescript
const seoToolsResult = await openAIService.generateSEOTools(propertyData);
localStorage.setItem('generation_seo_tools', JSON.stringify(seoToolsResult));
updateGenerationStatus('seoTools', true, 56);
```
**Progression** : 56%

---

#### **15. Appel 5/7 : Annonce SMS**
```typescript
const smsAdResult = await openAISMSService.generateSMSAd(propertyData);
localStorage.setItem('generation_sms_ad', JSON.stringify(smsAdResult));
updateGenerationStatus('smsAd', true, 70);
```
**Progression** : 70%

---

#### **16. Appel 6/7 : Annonce Google Business Profile**
```typescript
const googleBusinessProfileResult = await openAIGoogleBusinessProfileService.generateGoogleBusinessProfileAd(propertyData);
localStorage.setItem('generation_googleprofile_ad', JSON.stringify(googleBusinessProfileResult));
updateGenerationStatus('googleBusinessProfile', true, 85);
```
**Progression** : 85%

---

#### **17. Appel 7/7 : Annonce R√©seaux Sociaux**
```typescript
const reseauxSociauxResult = await openAIReseauxSociauxService.generateReseauxSociauxAd(propertyData);
localStorage.setItem('generation_reseauxsociaux_ad', JSON.stringify(reseauxSociauxResult));
updateGenerationStatus('reseauxSociaux', true, 100);
```
**Progression** : 100%

---

#### **18. Finalisation du statut**
```typescript
updateGenerationStatus('completed', true, 100);
```
**`generation_status.completed`** passe √† `true`

---

#### **19. Redirection automatique vers √âtape 6**
```typescript
setTimeout(() => {
  navigate("/etape6communication");
}, 1000);
```
**D√©lai de 1 seconde** pour laisser l'utilisateur voir la progression √† 100%

---

#### **20. Page Animation d√©tecte la fin**
- `Animation.tsx` surveille `generation_status` toutes les 500ms
- D√©tecte `completed: true`
- Lance une redirection vers `/etape6communication` apr√®s 1,5 seconde
- **R√©sultat** : Transition fluide vers l'√âtape 6

---

## IX. √âL√âMENTS CACH√âS / CONDITIONNELS

### 1. **Bouton d√©sactiv√© pendant la g√©n√©ration**

**Condition** : `isGenerating === true`  
**Comportement** :
```typescript

  {isGenerating ? "G√©n√©ration en cours..." : "G√©n√©rer mes Annonces"}

```

- **Texte du bouton** change : "G√©n√©rer mes Annonces" ‚Üí "G√©n√©ration en cours..."
- **Animation pulse** sur l'ic√¥ne `Sparkles`
- **Bouton gris√©** et non cliquable

---

### 2. **Timer de session (SafeEtape5.tsx uniquement)**

**Condition** : `session_start_time` existe dans `localStorage`  
**Affichage** :
```typescript
{timeLeft !== null && (

    {showWarning ? (
      Attention ! Session expire bient√¥t
    ) : (
      Session active : {Math.floor(timeLeft)} min restantes
    )}

)}
```

**Note** : Pr√©sent dans `SafeEtape5.tsx` mais **d√©sactiv√©** dans `Etape5.tsx` principal

---

### 3. **Alerte de session expirante (SafeEtape5.tsx uniquement)**

**Condition** : `showWarning === true` (temps restant < 1 minute)  
**Affichage** :
```typescript
{showWarning && (

      Attention ! Votre session expirera dans moins d'une minute.

      Lancez la g√©n√©ration maintenant pour conserver vos donn√©es.

)}
```

---

### 4. **Toast d'erreur si cl√© OpenAI manquante**

**Condition** : `!openAIApiKey`  
**Affichage** :
```typescript
toast({
  title: "Erreur de configuration",
  description: "Cl√© API OpenAI manquante. Veuillez configurer votre cl√© API dans les param√®tres.",
  duration: 5000
});
```

---

### 5. **Page d'animation conditionnelle**

**Condition** : `generation_status` existe dans `localStorage`  
**Comportement** :
- Si absent ‚Üí Redirection vers `/etape5`
- Si pr√©sent ‚Üí Affichage de `Animation.tsx` avec progression

---

## X. TIMER DE SESSION (D√âSACTIV√â MAIS PR√âSENT)

### 1. **Cl√© localStorage concern√©e**
- **Cl√©** : `session_start_time`
- **Type** : `number` (timestamp en millisecondes)
- **Valeur** : `new Date().getTime()` au d√©marrage de l'√âtape 1

---

### 2. **Logique dans SafeEtape5.tsx**

```typescript
useEffect(() => {
  const checkTimeRemaining = () => {
    const startTimeStr = localStorage.getItem("session_start_time");
    if (!startTimeStr) return;

    const startTime = parseInt(startTimeStr);
    const currentTime = new Date().getTime();
    const elapsedMilliseconds = currentTime - startTime;
    const remainingMilliseconds = Math.max(0, 10 * 60 * 1000 - elapsedMilliseconds);
    const remainingMinutes = Math.floor(remainingMilliseconds / (1000 * 60));
    const remainingSeconds = Math.floor((remainingMilliseconds % (1000 * 60)) / 1000);

    setTimeLeft(remainingMinutes + remainingSeconds / 60);

    // √Ä 9 minutes, affiche l'avertissement
    if (elapsedMilliseconds >= 9 * 60 * 1000 && elapsedMilliseconds < 10 * 60 * 1000) {
      setShowWarning(true);
    }
  };

  const intervalId = setInterval(checkTimeRemaining, 1000);
  checkTimeRemaining();

  return () => clearInterval(intervalId);
}, []);
```

---

### 3. **R√©initialisation du timer**

**Quand** : Au clic sur "G√©n√©rer mes Annonces"  
**Comment** :
```typescript
resetSessionTimer(); // Fonction de useSgaForm()
```

**Effet** : `session_start_time` est mis √† jour avec le timestamp actuel

---

### 4. **Incoh√©rence avec clearPropertyData()**

**Probl√®me identifi√©** :
- `clearPropertyData()` supprime **uniquement** `propertyData`
- **Ne supprime PAS** `session_start_time`
- **R√©sultat** : En cas de r√©initialisation, le timer peut afficher une valeur incorrecte

**Solution recommand√©e** :
```typescript
export const clearPropertyData = (): void => {
  localStorage.removeItem("propertyData");
  localStorage.removeItem("session_start_time"); // Ajouter cette ligne
};
```

---

## XI. R√âCAPITULATIF DES CL√âS localStorage

### **Cl√©s utilis√©es (Lecture seule) :**

| Cl√© | Type | Cr√©√©e par | Utilis√©e pour |
|-----|------|-----------|--------------|
| `propertyData` | `PropertyData` | √âtapes 1-4 | Source de donn√©es pour OpenAI |
| `stepProgress` | `number[]` | `useStepProgress` | V√©rification d'acc√®s √† l'√©tape 5 |
| `session_start_time` | `number` | √âtape 1 | Timer de session (d√©sactiv√©) |

---

### **Cl√©s modifi√©es :**

| Cl√© | Type | Modification | Effet |
|-----|------|--------------|-------|
| `stepProgress` | `number[]` | `completeStep(5)` ‚Üí Ajout de `6` | D√©bloque l'acc√®s √† l'√©tape 6 |

---

### **Cl√©s cr√©√©es par l'√âtape 5 :**

| Cl√© | Type | Contenu | Progression |
|-----|------|---------|-------------|
| `generation_status` | `GenerationStatus` | Statut de g√©n√©ration | Toutes les √©tapes |
| `generation_website_ad` | `JSON` | Annonce Site Internet | 14% |
| `generation_summary_sheet` | `JSON` | Fiche de Synth√®se | 28% |
| `generation_newsletter` | `JSON` | Annonce Newsletter | 42% |
| `generation_seo_tools` | `JSON` | Outils SEO | 56% |
| `generation_sms_ad` | `JSON` | Annonce SMS | 70% |
| `generation_googleprofile_ad` | `JSON` | Annonce Google Business Profile | 85% |
| `generation_reseauxsociaux_ad` | `JSON` | Annonce R√©seaux Sociaux | 100% |

---

## XII. DONN√âES DE L'√âTAPE 5 √Ä PRENDRE EN CONSID√âRATION

### 1. **Champs `propertyData` (LECTURE SEULE)**

| Champ localStorage | √âtape d'origine | Utilis√© par OpenAI | Commentaire |
|-------------------|-----------------|-------------------|-------------|
| `agencyName` | √âtape 1 | ‚úÖ Toutes les annonces | Nom de l'agence |
| `reference` | √âtape 1 | ‚úÖ Toutes les annonces | R√©f√©rence du bien |
| `exclusivite` | √âtape 1 | ‚úÖ Toutes les annonces | "Oui" ou "Non" |
| `location` | √âtape 1 | ‚úÖ Toutes les annonces | Localisation du bien |
| `propertyType` | √âtape 1 | ‚úÖ Toutes les annonces | Type de bien (restaurant, bar...) |
| `saleType` | √âtape 1 | ‚úÖ Toutes les annonces | "√† vendre" ou "√† louer" |
| `price` | √âtape 1 | ‚úÖ Toutes les annonces | Prix FAI (si vente) |
| `rentAmount` | √âtape 1 | ‚úÖ Toutes les annonces | Loyer (si location) |
| `rentPeriodicity` | √âtape 1 | ‚úÖ Toutes les annonces | mensuel, trimestriel, annuel |
| `keyElements` | √âtape 1 | ‚úÖ Toutes les annonces | Points forts commerciaux |
| `propertyDescription` | √âtape 2 | ‚úÖ Toutes les annonces | Description d√©taill√©e |
| `financials` | √âtape 3 | ‚úÖ Toutes les annonces | D√©tails financiers |
| `details` | √âtape 4 | ‚úÖ **Fiche de Synth√®se uniquement** | Informations compl√©mentaires |
| `hasNoDetails` | √âtape 4 | ‚úÖ Logique conditionnelle | Bool√©en (true/false) |

---

### 2. **Cl√©s `generation_*` (CR√â√âES PAR L'√âTAPE 5)**

| Cl√© localStorage | Donn√©es utilis√©es | Service OpenAI | Progression |
|-----------------|-------------------|----------------|-------------|
| `generation_website_ad` | **Toutes** (√âtapes 1-4) | `generateWebsiteAd()` | 14% |
| `generation_summary_sheet` | **Toutes** (√âtapes 1-4) | `generateSummarySheetAd()` | 28% |
| `generation_newsletter` | √âtapes 1-3 | `generateNewsletterAd()` | 42% |
| `generation_seo_tools` | √âtapes 1-3 | `generateSEOTools()` | 56% |
| `generation_sms_ad` | √âtapes 1-3 | `generateSMSAd()` | 70% |
| `generation_googleprofile_ad` | √âtapes 1-3 | `generateGoogleBusinessProfileAd()` | 85% |
| `generation_reseauxsociaux_ad` | √âtapes 1-3 | `generateReseauxSociauxAd()` | 100% |

---

### 3. **Fonctions (√âTAPE 5)**

| Fonction | Fichier | R√¥le | Param√®tres |
|----------|---------|------|------------|
| `handleValidateAndFinish()` | `Etape5.tsx` | Orchestre la g√©n√©ration OpenAI | Aucun |
| `updateGenerationStatus()` | `Etape5.tsx` | Met √† jour `generation_status` | `key`, `value`, `progress` |
| `getPropertyDataFromStorage()` | `openai.ts` | R√©cup√®re `propertyData` | Aucun |
| `createOpenAIService()` | `openai.ts` | Cr√©e instance `OpenAIService` | `apiKey` |
| `createOpenAISMSService()` | `1.API-AnnonceSMS.ts` | Cr√©e instance `OpenAISMSService` | `apiKey` |
| `createOpenAIGoogleBusinessProfileService()` | `2.API-AnnonceGoogleBusinessProfile.ts` | Cr√©e instance `OpenAIGoogleBusinessProfileService` | `apiKey` |
| `createOpenAIReseauxSociauxService()` | `3.API-AnnonceReseauxSociaux.ts` | Cr√©e instance `OpenAIReseauxSociauxService` | `apiKey` |
| `generateWebsiteAd()` | `openai.ts` | G√©n√®re annonce Site Internet | `propertyData`, `model` |
| `generateSummarySheetAd()` | `openai.ts` | G√©n√®re Fiche de Synth√®se | `propertyData`, `model` |
| `generateNewsletterAd()` | `openai.ts` | G√©n√®re annonce Newsletter | `propertyData`, `model` |
| `generateSEOTools()` | `openai.ts` | G√©n√®re Outils SEO | `propertyData`, `model` |
| `generateSMSAd()` | `1.API-AnnonceSMS.ts` | G√©n√®re annonce SMS | `propertyData`, `model` |
| `generateGoogleBusinessProfileAd()` | `2.API-AnnonceGoogleBusinessProfile.ts` | G√©n√®re annonce Google Business Profile | `propertyData`, `model` |
| `generateReseauxSociauxAd()` | `3.API-AnnonceReseauxSociaux.ts` | G√©n√®re annonce R√©seaux Sociaux | `propertyData`, `model` |
| `completeStep()` | `useStepProgress.ts` | Marque l'√©tape 5 comme termin√©e | `5` |
| `resetSessionTimer()` | `useSgaForm.ts` | R√©initialise le timer de session | Aucun |
| `checkGenerationStatus()` | `Animation.tsx` | Surveille la progression | Aucun |

---

### 4. **D√©pendances entre les √âtapes**

| √âtape | D√©pend de | D√©bloque | Donn√©es transmises |
|-------|-----------|----------|-------------------|
| **√âtape 5** | √âtapes 1-4 compl√®tes | √âtape 6 | **Toutes les donn√©es** de `propertyData` |
| **√âtape 5** | Cl√© OpenAI configur√©e | - | `openAIApiKey` depuis `OpenAIContext` |
| **Page Animation** | `generation_status` existe | - | Surveillance du statut |
| **√âtape 6** | `generation_*` cl√©s cr√©√©es | - | R√©sultats OpenAI |

---

## üéØ **POINTS CL√âS √Ä RETENIR**

1. ‚úÖ **L'√âtape 5 ne collecte AUCUNE donn√©e** ‚Üí Elle orchestre uniquement la g√©n√©ration
2. ‚úÖ **7 appels OpenAI s√©quentiels** ‚Üí Chaque appel met √† jour la progression
3. ‚úÖ **Navigation automatique** ‚Üí `/etape5` ‚Üí `/etape5/animation` ‚Üí `/etape6communication`
4. ‚úÖ **Gestion d'erreurs robuste** ‚Üí Les √©checs n'interrompent pas le processus
5. ‚úÖ **Toutes les donn√©es sont utilis√©es** ‚Üí Sauf `details` (Fiche de Synth√®se uniquement)
6. ‚úÖ **Timer de session d√©sactiv√©** ‚Üí Pr√©sent dans `SafeEtape5.tsx` uniquement
7. ‚úÖ **Modification possible** ‚Üí Retour arri√®re vers √©tapes 1-4 via le menu

---

